[{"content":"ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS) åœ¨ MySQL 8.0.27 ä¹‹å‰ï¼ŒReplica é è¨­åªæœ‰ä¸€å€‹ IO_THREAD å’Œä¸€å€‹ SQL_THREADï¼š\nIO_THREAD è² è²¬å¾ Source æ¥æ”¶ binlog ä¸¦å¯«å…¥ Replica çš„ relaylog SQL_THREAD è² è²¬è§£æå’Œé‡æ”¾ relaylog ä¸­çš„ event ç•¶ Source æœ‰ä½µç™¼å¤§é‡å¯«å…¥æ™‚ï¼ŒReplica çš„ IO_THREAD å› ç‚ºæ˜¯é †åºå¯«å…¥ä¸€èˆ¬ä¸æœƒå°è‡´ replication delayï¼Œä½†æ˜¯åªæœ‰å–®ç·šç¨‹ SQL_THREAD å›æ”¾é€Ÿåº¦æ˜¯è·Ÿä¸ä¸Šæœ‰å¤šç·šç¨‹å¯«å…¥çš„ Sourceï¼Œå› æ­¤æœƒé€ æˆ replication delay ä¸æ–·è®Šå¤§ï¼Œç›¸æ‡‰ä¹Ÿå°è‡´ Replica çš„ relaylog å¤§é‡å †ç©å æ»¿ disk ç©ºé–“ã€‚\nå› æ­¤å¾ MySQL 5.6 é–‹å§‹æä¾›äº† Multi-Tread Slave (MTS)ï¼Œé€éå¤šç·šç¨‹çš„ SQL_THREAD ä¾†ç·©è§£é€™ç¨®å•é¡Œï¼Œä¸¦ä¸”åœ¨å¾ŒçºŒçš„å¤§ç‰ˆæœ¬ä¸­ä¸æ–·é€²è¡Œå„ªåŒ–ã€‚\nå„å€‹ç‰ˆæœ¬çš„ MTS åŸºæ–¼ database ç´šåˆ¥çš„ MTS (5.6) åœ¨ MySQL 5.6 åªæœ‰åŸºæ–¼ Database ç´šåˆ¥çš„ MTSï¼Œåªæœ‰åœ¨ä¸åŒ Database çš„èªå¥æ‰å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œï¼Œå› æ­¤é€™ç„¡æ³•è§£æ±ºå–®è¡¨é«˜å¯«å…¥æ‰€é€ æˆçš„åŒæ­¥å»¶é²ã€‚\nåŸºæ–¼ Group Commit çš„ MTS (5.7) Group Commit ç°¡è¿° Group Commit æ˜¯ MySQL 5.6 ç‰ˆæœ¬å¼•å…¥ç”¨ä¾†å„ªåŒ– BinLogã€RedoLog åœ¨ 2PC æ™‚å¯«å…¥çš„ç“¶é ¸ï¼Œç°¡å–®ä¾†èªªåŸæœ¬æ¯å€‹ Transaction éƒ½éœ€è¦ç¨è‡ª fsync æ“ä½œä¾†å¯«å…¥ Disk æŒä¹…åŒ–ï¼Œç¶“é Group Commit çš„å„ªåŒ–å¾Œæœƒå°‡å¤šå€‹ Transaction çµ„æˆä¸€å€‹å°åˆ—ä¸€èµ·é€²è¡Œ fsync æ“ä½œï¼Œå¤§å¹…æ¸›å°‘ fsync æ“ä½œè§£æ±ºåœ¨é›™ 1 æ™‚é€ æˆçš„æ€§èƒ½æ€¥é€Ÿä¸‹é™çš„å•é¡Œã€‚\né—œæ–¼ Group Commit çš„å…·é«”æè¿°ï¼Œå¯åƒè€ƒ MySQL Group Commit æ¼”é€²ã€‚\nslave_parallel_type åœ¨ MySQL 5.7 å¼•å…¥äº† slave_parallel_type é€™å€‹æ–°åƒæ•¸ï¼Œå¯ä½¿ç”¨çš„å€¼æœ‰ä»¥ä¸‹ 2 å€‹ï¼š\nDATABASEï¼šä¹Ÿå°±æ˜¯ 5.6 ç‰ˆæœ¬ï¼Œä¸åŒ DATABASE çš„æ‰èƒ½ä¸¦è¡Œå›æ”¾ã€‚ LOGICAL_CLOCKï¼š5.7 ç‰ˆæœ¬åŸºæ–¼ Group Commit çš„ä¸¦è¡Œå›æ”¾ã€‚ LOGICAL_CLOCK - Commit Parent Based æ¨¡å¼ åœ¨ Source ä¸­èƒ½å¤ åœ¨åŒä¸€å€‹å°åˆ—ä¸€èµ·é€²è¡Œ Group commitï¼Œè¡¨ç¤ºé€™å€‹å°åˆ—ä¸­çš„æ‰€æœ‰ Transaction éƒ½æ²’æœ‰é–è¡çªï¼Œå› æ­¤ä¹Ÿå¯åœ¨ Replica å…§ä¸¦è¡Œå›æ”¾ã€‚\nç‚ºäº†è®“ Replica èƒ½åŸºæ–¼ Group Commit å¯¦ç¾ MTSï¼Œåœ¨ Binlog ä¸­ç‚ºæ¯å€‹ Transaction æ·»åŠ äº† LOGICAL CLOCK ä¹Ÿå°±æ˜¯ä»¥ä¸‹ 2 å€‹å€¼ï¼š\nsequence_numberï¼šæ¯å€‹ Transaction çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œå…·é«”åœ¨ Transaction é€²å…¥ flush éšæ®µçš„å°åˆ—ä¹‹å‰åˆ†é…ã€‚ last_commitedï¼šç´€éŒ„ä¸Šæ¬¡ Group commit æ™‚æœ€å¤§çš„ sequence_numberï¼Œä¹Ÿå°±æ˜¯èªª last_committed ç›¸åŒè¡¨ç¤ºåŒå±¬ä¸€å€‹ Groupã€‚ é€é mysqlbinlog å¯ä»¥çœ‹åˆ° binlog ä¸­æ¯å€‹ Transaction éƒ½æœ‰é€™ 2 å€‹è®Šé‡\nå‚™è¨»ï¼šsequence_numberã€last_commited åªåœ¨åŒä¸€å€‹ BinLog æ–‡ä»¶ä¸é‡è¤‡ï¼Œæ¯ç•¶æ›åˆ°æ–°çš„ BinLog æ–‡ä»¶æ™‚æœƒé‡æ–°å¾ 0 é–‹å§‹è¨ˆæ•¸ã€‚\nä¸é Commit Parent Based æœ‰ä¸€å€‹ç¼ºé™·ï¼Œè®“æˆ‘å€‘çœ‹ä¸€ä¸‹ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 Trx1 ------------P----------C--------------------------------\u0026gt; | Trx2 ----------------P------+---C----------------------------\u0026gt; | | Trx3 -------------------P---+---+-----C----------------------\u0026gt; | | | Trx4 -----------------------+-P-+-----+----C-----------------\u0026gt; | | | | Trx5 -----------------------+---+-P---+----+---C-------------\u0026gt; | | | | | Trx6 -----------------------+---+---P-+----+---+---C----------\u0026gt; æ¯ä¸€å€‹æ°´å¹³ç·šä»£è¡¨ä¸€å€‹ Transaction ç”±å·¦åˆ°å³çš„æ™‚é–“é»ï¼Œå…¶ä¸­ P è¡¨ç¤º prepare éšæ®µå–å¾—ä¸Šä¸€å€‹ Group æ›´æ–° last_committed çš„æ™‚é–“é»ï¼ŒC è¡¨ç¤º commit å‰æ›´æ–° last_committed çš„æ™‚é–“é»ã€‚\nå…¶ä¸­å¯ä»¥è§€å¯Ÿåˆ°ï¼š\nTrx4 çš„ P æ™‚é–“é»å–å¾—çš„æ˜¯ Trx1 commit ç”¢ç”Ÿçš„ last_committed Trx5 å’Œ Trx6 çš„ P æ™‚é–“é»å–å¾—çš„æ˜¯ Trx2 commit ç”¢ç”Ÿçš„ last_committed ä¾ç…§ Commit Parent æ¨¡å¼ä¸‹ Trx5ã€Trx6 å¯ä»¥ä¸€èµ·åœ¨ Replica å›æ”¾ï¼Œä½†æ˜¯ Trx4 ä¸å¯ä»¥å’Œ Trx5ã€Trx6 ä¸€èµ·åœ¨ Replica å›æ”¾ã€‚\nç„¶è€Œï¼Œå¯¦éš›ä¸Šä¾ç…§æ™‚é–“ç·šæˆ‘å€‘å¯ä»¥çœ‹åˆ° Trx4 åœ¨ prepare åˆ° commit çš„éç¨‹ä¸­ï¼ŒTrx5ã€Trx6 æœ‰åœ¨é€™å€‹éç¨‹ä¸­ prepareï¼Œä¹Ÿå°±æ˜¯èªªå¯¦éš›ä¸Šä»–å€‘ä¸¦æ²’æœ‰é–è¡çª (å¦‚æœè¡çª Trx5ã€Trx6 æœƒå¡åœ¨ lock wait)ï¼Œæ‰€ä»¥ç†è«–ä¸Šä»–å€‘åœ¨ Replica æ˜¯å¯ä»¥ä¸¦è¡Œå›æ”¾åˆ°ã€‚\nLOGICAL_CLOCK - Lock Based æ¨¡å¼ ç‚ºäº†é€²ä¸€æ­¥å„ªåŒ– Commit Parent Based çš„ç¼ºé™·ï¼ŒMySQL 5.7 é¦¬ä¸Šå¯¦ç¾äº† MySQL :: WL#7165: MTS: Optimizing MTS scheduling by increasing the parallelization window on master çš„å„ªåŒ–ï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ Lock Based æ¨¡å¼çš„ LOGICAL_CLOCKï¼Œåªè¦ Transaction åœ¨å„è‡ªæŒæœ‰çš„é–æ²’æœ‰è¡çªæ™‚å°±å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œã€‚\nåœ¨æ­¤æ¨¡å¼ä¸‹ binlog ä¸­çš„ sequence_numberã€last_commited æ¶µç¾©å¦‚ä¸‹ï¼š\nsequence_numberï¼šæ¯å€‹ Transaction çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œå…·é«”åœ¨ Transaction é€²å…¥ flush éšæ®µçš„å°åˆ—ä¹‹å‰åˆ†é…ï¼Œ last_commitedï¼šç•¶ Transaction é–‹å§‹åŠ é–æ™‚ï¼Œå°‡å…¨å±€è®Šé‡ max_committed_transaction ç•¶ä¸‹çš„å€¼ä½œç‚º last_commitedã€‚ å…¨å±€è®Šé‡ max_committed_transactionï¼šå·²ç¶“çµæŸ Lock interval çš„æœ€å¤§ sequence_numberï¼Œæ¯å€‹ Transaction åœ¨ InnoDB commit éšæ®µæ™‚ï¼Œå¦‚æœè‡ªå·±çš„ sequence_number \u0026gt; max_committed_transaction æ™‚æœƒå°‡å…¶æ›´æ–°ç‚ºè‡ªå·±çš„ sequence_number ã€‚ å› ç‚ºç„¡æ³•é å…ˆçŸ¥é“å“ªä¸€å€‹é–æ˜¯æœ€å¾Œä¸€å€‹ï¼Œå› æ­¤ Transaction å…§æ¯ä¸€å€‹ DML éƒ½æœƒä¸æ–·æ›´æ–°è©² Transaction çš„ last_commitedã€‚ åœ¨ Source å¯«å…¥ sequence_numberã€last_commited ä¹‹å¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯çœ‹ Replica å¦‚ä½•ä¾æ“šé€™ 2 å€‹ç›´ä¾†å¯¦ç¾ Lock Based çš„ MTSã€‚\né¦–å…ˆè¤‡ç¿’ä¸€ä¸‹ï¼Œåªæœ‰ç•¶ Transaction å’Œ Transaction åœ¨ Lock ~ Commit (ä¹Ÿå°±æ˜¯é‡‹æ”¾é–) ä¹‹é–“æœ‰äº¤é›†æ‰èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼š\n1 2 3 4 5 6 7 - Can execute in parallel: Trx1 -----L---------C------------\u0026gt; Trx2 ----------L---------C-------\u0026gt; - Can not execute in parallel: Trx1 -----L----C-----------------\u0026gt; Trx2 ---------------L----C-------\u0026gt; è®“æˆ‘å€‘é¦–å…ˆç‚ºä¸Šåœ–ä¸­çš„ L~C çš„æœŸé–“å®šç¾©ä¸€å€‹æ–°çš„åè© Lock intervalï¼š\nLock interval çš„èµ·å§‹é»(ä¸Šåœ–L)ï¼šåœ¨ Binlog Prepare éšæ®µå–å¾—æœ€å¾Œä¸€æŠŠé–çš„æ™‚é–“é»ã€‚ Lock interval çš„çµæŸé»(ä¸Šåœ–C)ï¼šåœ¨ InnoDB Commit éšæ®µé‡‹æ”¾ç¬¬ä¸€æŠŠé–çš„æ™‚é–“é»ã€‚ ä¹Ÿå°±æ˜¯èªªå°æ–¼ Replica åœ¨è®€å– BinLog æ™‚ï¼š\nlast_commited ä½œç‚º Lock interval çš„èµ·å§‹é»ï¼šå› ç‚º Transaction é–‹å§‹åŠ é–çš„é‚è¼¯æ™‚é–“æ˜¯ç›®å‰æœ€å¾Œä¸€å€‹å·²çµæŸ lock interval çš„æœ€å¾Œä¸€å€‹ sequence_numberï¼Œå°±æ˜¯å…¨å±€è®Šé‡ max_committed_transactionã€‚ sequence_number ä½œç‚º Lock interval çš„çµæŸé»ï¼šå› ç‚ºç•¶è©² Transaction çµæŸ lock interval æ™‚æœƒå°‡è‡ªå·±çš„ sequence_number æ›´æ–°åˆ° max_committed_transactionï¼Œä¹Ÿå°±æ˜¯èªªå°æ–¼ä¸‹å€‹ Transaction è€Œè¨€çš„ last_commitedã€‚ åœ¨ Replica å›æ”¾æ™‚åªæœ‰ Transaction ä¹‹é–“å¦‚æœ last_commited~sequence_number ä¹‹é–“æœ‰é‡ç–Šå°±å¯ä»¥ä¸¦è¡Œå›æ”¾ã€‚\nå¯¦ç¾æ–¹å¼å¦‚ä¸‹ï¼š\nå®šç¾©ä¸€å€‹è®Šé‡ last_lwm_timestampï¼šç‚ºä¸€å€‹å·²ç¶“å®Œæˆå›æ”¾ Transaction çš„ sequence_number ï¼Œè©² Transaction å…¶ sequence_number ä¹‹å‰çš„æ‰€æœ‰ Transaction éƒ½å·²ç¶“ commitã€‚ ç•¶ coordinator ç·šç¨‹è®€å–ä¸€å€‹ Transaction çš„ last_committedï¼š ç•¶ last_committed \u0026lt; last_lwm_timestamp è¡¨ç¤º Lock interval æœ‰äº¤é›†ï¼Œå› æ­¤å¯ä»¥ä¸Ÿçµ¦ work ç·šç¨‹ä¸¦è¡Œå›æ”¾ã€‚\n1 2 Trx1 -----L---------C------------\u0026gt; Trx2 ----------L---------C-------\u0026gt; ç•¶ last_committed = last_lwm_timestamp é›–ç„¶ Lock interval æ²’æœ‰äº¤é›†ï¼Œä½†æ˜¯è©²æƒ…æ³è¡¨ç¤ºå‰ä¸€å€‹ Transaction å®Œæˆï¼Œæ‰€ä»¥ç•¶å‰ Transaction æ‰æœƒæ‹¿åˆ°å‰ä¸€å€‹çš„ sequence_number ä½œç‚ºè‡ªå·±çš„ last_commitedï¼Œè€Œ last_lwm_timestamp æ˜¯å·²ç¶“ commit çš„ Transactionï¼Œå› æ­¤å¯ä»¥ä¸Ÿçµ¦ work ç·šç¨‹å›æ”¾äº†ã€‚\n1 2 Trx1 -----L----C-----------------\u0026gt; Trx2 ----------L---------C-------\u0026gt; ç•¶ last_committed \u0026gt; last_lwm_timestamp è¡¨ç¤º Lock interval æ²’æœ‰äº¤é›†ï¼Œå› æ­¤ä¸èƒ½ä¸Ÿçµ¦ work ç·šç¨‹ä¸¦è¡Œå›æ”¾ã€‚\n1 2 Trx1 -----L----C-----------------\u0026gt; Trx2 ---------------L----C-------\u0026gt; Commit Parent Based VS Lock Based èˆ‰ä¾‹ å‡è¨­æœ‰ä»¥ä¸‹ binlogï¼š\nåœ¨ Commit Parent Based ä¸‹ï¼š\nsequence_number 1~7 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚ sequence_number 8 çš„ Transaction å…¶ last_committed æ˜¯ 1ï¼Œæ‰€ä»¥ä¸èƒ½å’Œ sequence_number 1~7ä¸€èµ·åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚ *å‚™è¨»ï¼šåœ¨ Commit Parent Based ä¸‹ï¼Œæ­£ç¢ºçš„ last_committed æ‡‰è©²è¦æ˜¯ 7ï¼Œæ­¤è™•åƒ…æ–¹ä¾¿èˆ‰ä¾‹ä½¿ç”¨ Lock Based èˆ‰ä¾‹ã€‚ sequence_number 914 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 7ï¼Œä¸èƒ½å’Œ sequence_number 18 ä¸€èµ·åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚ åœ¨ Lock Based ä¸‹ï¼š\nsequence_number 17 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 0 è¡¨ç¤ºç‚ºåŒä¸€å€‹ Groupï¼Œæ‰€ä»¥ 17 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚ sequence_number 8 çš„ last_committed = 1ï¼Œè¡¨ç¤º 8 å’Œ 17 çš„é–ä¸è¡çªï¼Œå› æ­¤ 18 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚ sequence_number 914 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 7 è¡¨ç¤ºç‚ºåŒä¸€å€‹ Groupï¼ŒåŒæ™‚ 814 çš„é–ä¸è¡çªï¼Œå› æ¬¡ 8~14 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ ç¼ºé™· åŸºæ–¼ Group Commit çš„ MTS ä¸è«–æ˜¯ Commit Parent Based é‚„æ˜¯ Lock Based éƒ½ä¸€æ¨£ï¼Œéƒ½æ˜¯åªæœ‰åœ¨ Source ä¸Šæ¯å€‹ Group çš„ Transaction è¶³å¤ å¤šï¼Œä¹Ÿå°±æ˜¯ä½µç™¼åº¦å¤ é«˜çš„æƒ…æ³ä¸‹æ‰èƒ½åœ¨ Replica ä¸Šæœ‰è¼ƒå¥½çš„ä¸¦è¡Œå›æ”¾æ•ˆç‡ã€‚\né›–ç„¶åœ¨ 5.7 æ–°å¢ binlog_group_commit_sync_delayã€binlog_group_commit_sync_no_delay_counté€™ 2 å€‹è¨­å®šï¼Œå¯ä»¥è®“ä¸€å€‹ Group æœ‰æ›´å¤šçš„ Transactionï¼Œç„¶è€Œæ•ˆæœä»ç„¶ååˆ†æœ‰é™ã€‚\nåŸºæ–¼ WriteSet çš„ MTS (5.7.22ã€8.0) MySQL 5.7 é›–ç„¶é€é Group Commit å„ªåŒ–äº† MTSï¼Œä½†é€™ä¸»è¦æ˜¯å„ªåŒ–åœ¨ Master ä¸Šæœ‰é«˜ä¸¦è¡Œåº¦çš„æƒ…æ³ä¸‹ï¼Œå¦‚æœ Master ä¸¦è¡Œåº¦ä¸é«˜å‰‡åŒä¸€å€‹ Group çš„ Event ç›¸å°å°‘ï¼Œå› æ­¤ Slave å›æ”¾é€Ÿåº¦ç„¡æ³•æœ‰æ•ˆåŠ å¿«ã€‚\nåœ¨ 8.0 ç‚ºäº†è§£æ±ºä¸Šè¿°å•é¡Œï¼Œå³ä½¿åœ¨ Source ä¸Šæ˜¯ä¸²è¡Œ commit çš„ Transactionï¼Œåªè¦äº’ç›¸ä¸è¡çªé‚£éº¼åœ¨ Replica ä¸Šå°±èƒ½ä¸¦è¡Œå›æ”¾ã€‚\nåœ¨ 8.0 æ–°å¢äº† binlog_transaction_dependency_tracking é€™å€‹åƒæ•¸ä¾†æ§åˆ¶ binlog å¯«å…¥ç›¸é—œè³‡è¨Šï¼Œè®“ Replica æ“šæ­¤é€²è¡Œä¸¦è¡Œå›æ”¾ï¼Œæœ‰ä»¥ä¸‹ä¸‰å€‹å€¼ï¼š\nCOMMIT_ORDERï¼šä½¿ç”¨ 5.7 Group commit çš„æ–¹å¼åˆ¤æ–·ã€‚ WRITESETï¼šä½¿ç”¨ WriteSet çš„æ–¹å¼åˆ¤æ–· Transaction æ˜¯å¦æœ‰è¡çªã€‚ WRITESET_SESSIONï¼šWRITESET çš„åŸºç¤ä¸Šä¿è­‰åŒä¸€å€‹ session å…§çš„ Transaction ä¸å¯ä¸¦è¡Œã€‚ WriteSet ç°¡è¿° WriteSet åœ¨ MySQL Group Replication(MGR) ä¸­å°±å·²ç¶“å¯¦ç¾äº†ï¼š\nMySQL Group Replication Protocol\nä½¿ç”¨çš„åœ°æ–¹æ˜¯ certify éšæ®µç”¨ä¾†åˆ¤æ–· Transaction æ˜¯å¦å…è¨± commitï¼Œé€™å€‹æ™‚å€™å°±æœƒé€é WriteSet ä¾†åˆ¤æ–·æ˜¯å¦å’Œå…¶ä»– member ä¸Šçš„ Transaction æœ‰è¡çªã€‚\nğŸ’¡ å› ç‚º MGR å¯ä»¥åœ¨å¤šå€‹ member ä¸Šå¯«å…¥ï¼Œå› æ­¤ä¸åƒå–®æ©Ÿæ¨¡å¼å¯ä»¥é€é Lock è¡çªä¾†é¿å… Transaction ä¹‹é–“çš„è¡çªï¼ŒåŒæ™‚ç‚ºäº†æé«˜æ•ˆèƒ½ MGR æ¡ç”¨æ¨‚è§€çš„æ–¹å¼ä¸é€éå…¶ä»–æ–¹å¼é¡å¤–åŠ é–ï¼Œåªæœ‰æº–å‚™ commit çš„æ™‚å€™é€é WriteSet åˆ¤æ–· member ä¹‹é–“çš„ Transaction æ˜¯å¦è¡çªã€‚\nWriteSet æ‡‰ç”¨åˆ° MTS ç°¡è¿° å‡è¨­åœ¨ Source ä¸Š Transaction commit æ™‚é–“è»¸å¦‚ä¸‹ï¼ŒåŒä¸€å€‹æ™‚é–“åªæœ‰ 1~2 å€‹ Transactionï¼š\nä¸Šé€”ä¸­æ–¹å¡Šå°æ‡‰ Transaction ä¿®æ”¹çš„è³‡æ–™ç¯„åœï¼Œå¦‚æœæ²’æœ‰é‡ç–Šè¡¨ç¤º Transaction ä¹‹é–“ä¿®æ”¹çš„æ•¸æ“šä¸è¡çªï¼Œé‚£éº¼é€é WriteSet åˆ¤æ–· Transaction ä¹‹é–“æ˜¯å¦è¡çªå¾Œï¼Œå°±å¯ä»¥åœ¨ Replicaä¸Šå¦‚ä¸‹ä¸¦è¡Œï¼š\nä¸éä¸Šåœ–æœ‰å€‹å°å•é¡Œæ˜¯å¯èƒ½ç™¼ç”Ÿ T3 æ¯” T2 æ—©åŸ·è¡Œçš„ç‹€æ³ï¼Œå°è‡´ Source å’Œ Replica ä¸­åŒä¸€å€‹ session ç”¢ç”Ÿæœ‰ä¸åŒçš„åŸ·è¡Œç´€éŒ„ï¼Œå¦‚æœè©•ä¼°å¾Œè¦ºå¾—ä¸å¯æ¥å—æœ‰ä»¥ä¸‹ 2 å€‹æ–¹å¼å¯ä»¥è§£æ±ºï¼š\nslave_preserve_commit_order = ON binlog_transaction_dependency_tracking = WRITESET_SESSION å¦‚ä¸Šåœ–èª¿æ•´å¾Œå¯ä»¥ç™¼ç¾åŒä¸€å€‹ session çš„éƒ½ä¸èƒ½ä¸¦è¡Œå›æ”¾ã€‚\nå¯¦ç¾æ–¹å¼ WriteSet æ˜¯ä»€éº¼ï¼Ÿ WriteSet æ˜¯ä¸€å€‹ hash æ•¸çµ„ï¼Œå¤§å°ç”± binlog_transaction_dependency_history_size ä¾†æ±ºå®šã€‚\nåœ¨ InooDB ä¿®æ”¹æ•¸æ“šå¾Œï¼Œæœƒå°‡ä¿®æ”¹çš„ row æ•¸æ“šä»¥ä¸‹å…§å®¹é€²è¡Œ hash å¾Œå¯«å…¥ WriteSetï¼š\nWriteSet ç”¢å‡ºç´°ç¯€\nğŸ’¡ ç”¢ç”Ÿçš„ Hash å€¼çš„æ–¹å¼å¯ä»¥åƒè€ƒ sql/rpl_write_set_handler.cc ä¸­çš„ add_pke function mysql-server/rpl_write_set_handler.cc at 8.0 Â· mysql/mysql-server Â· GitHub\nç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 mysql\u0026gt; use db_name Database changed mysql\u0026gt; show create table table_name \\G *************************** 1. row *************************** Table: table_name Create Table: CREATE TABLE `table_name` ( `pk_column` int(11) NOT NULL, `uk_column` int(11) NOT NULL, `idx_column` int(11) NOT NULL, PRIMARY KEY (`pk_column`), UNIQUE KEY `uk_column` (`uk_column`), KEY `idx_column` (`idx_column`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 mysql\u0026gt; INSERT INTO db_name.table_name VALUES(6, 7, 8) 1 2 3 4 5 6 7 8 9 10 11 12 # é€éç·¨è­¯ mysqld debug åŸ·è¡ŒæŸ¥çœ‹ ~ -\u0026gt; tail -f /tmp/mysqld.trace T@6: | | | | | | | | \u0026lt;generate_hash_pke 441 T@6: | | | | | | | | \u0026gt;generate_hash_pke T@6: | | | | | | | | | \u0026gt;Rpl_transaction_write_set_ctx::add_write_set T@6: | | | | | | | | | \u0026lt;Rpl_transaction_write_set_ctx::add_write_set 51 T@6: | | | | | | | | | info: pke: PRIMARYÂ½db_nameÂ½7table_nameÂ½106Â½1; hash: 10113078337023140702 T@6: | | | | | | | | \u0026lt;generate_hash_pke 441 T@6: | | | | | | | | \u0026gt;generate_hash_pke T@6: | | | | | | | | | \u0026gt;Rpl_transaction_write_set_ctx::add_write_set T@6: | | | | | | | | | \u0026lt;Rpl_transaction_write_set_ctx::add_write_set 51 T@6: | | | | | | | | | info: pke: uk_columnÂ½db_nameÂ½7table_nameÂ½107Â½1; hash: 406567197175550244 å½ä»£ç¢¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 å¦‚æœè¡¨ä¸­å­˜åœ¨ç´¢å¼•ï¼š å°†æ•°æ®åº“åï¼Œè¡¨åä¿¡æ¯å†™å…¥ä¸´æ—¶å˜é‡ å¾ªç¯æ‰«æè¡¨ä¸­æ¯ä¸ªç´¢å¼•ï¼š å¦‚æœä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼š é€€å‡ºæœ¬æ¬¡å¾ªç¯ç»§ç»­å¾ªç¯ã€‚ å¾ªç¯ä¸¤ç§ç”Ÿæˆæ•°æ®çš„æ–¹å¼(äºŒè¿›åˆ¶æ ¼å¼å’Œå­—ç¬¦ä¸²æ ¼å¼)ï¼š å°†ç´¢å¼•åå­—å†™å…¥åˆ°pkeä¸­ã€‚ å°†ä¸´æ—¶å˜é‡ä¿¡æ¯å†™å…¥åˆ°pkeä¸­ã€‚ å¾ªç¯æ‰«æç´¢å¼•ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µï¼š å°†æ¯ä¸€ä¸ªå­—æ®µçš„ä¿¡æ¯å†™å…¥åˆ°pkeä¸­ã€‚ å¦‚æœå­—æ®µæ‰«æå®Œæˆï¼š å°†pkeç”Ÿæˆhashå€¼å¹¶ä¸”å†™å…¥åˆ°å†™é›†åˆä¸­ã€‚ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸»é”®æˆ–è€…å”¯ä¸€é”®è®°å½•ä¸€ä¸ªæ ‡è®°ï¼Œåé¢é€šè¿‡è¿™ä¸ªæ ‡è®°æ¥ åˆ¤å®šæ˜¯å¦ä½¿ç”¨Writesetçš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ åŸºæ–¼ WriteSet çš„ MTS æ€éº¼å¯¦ç¾ï¼Ÿ è©²æ¨¡å¼ä¸‹ Replica åŒæ¨£æ˜¯åŸºæ–¼ Source ç”¢ç”Ÿçš„ binlog ä¸­çš„ last_commited å’Œ sequenct_number ä¾†æ±ºå®šæ˜¯å¦å¯ä»¥ä¸¦è¡Œå›æ”¾ï¼Œä¹Ÿå°±æ˜¯èªªå¦‚æœè¦é€²ä¸€æ­¥å¢åŠ ä¸¦è¡Œå›æ”¾çš„æ•ˆç‡ï¼Œå°±éœ€è¦ç›¡å¯èƒ½ç‚ºæ¯å€‹ Transaction æ‰¾å‡ºæ›´å°çš„ last_commitedã€‚\nåŸºæ–¼ WriteSet çš„ MTS èƒ½æ‰¾å‡ºæ›´å°çš„ last_commited çš„æ–¹å¼å°±æ˜¯ç¶­è­·ä¸€å€‹å…ˆå‰ Transaction æ‰€çµ„æˆçš„ WriteSet çš„æ­·å²ç´€éŒ„ï¼Œä¹‹å¾Œæ–°é€²ä¾†çš„ Transaction è¨ˆç®— WriteSet å¾Œå’Œé€™å€‹æ­·å²ç´€éŒ„é€²è¡Œè¡çªæ¯”å°ï¼Œä»¥æ­¤ä¾†å˜—è©¦æ‰¾å‡ºæ›´å°çš„ last_commitedã€‚\nbinlog_transaction_dependency_tracking ä¸åŒå° last_commit çš„è™•ç† åŸºæ–¼ WriteSet çš„ MTS å¯¦éš›ä¸Šæ˜¯åŸºæ–¼ ORDER_COMMIT (Group Commit) é€²ä¸€æ­¥è™•ç†è€Œå·²ã€‚\næ ¹æ“š binlog_transaction_dependency_tracking çš„è¨­å®šä¸åŒï¼Œåœ¨ Source code æœ‰å¦‚ä¸‹å…§å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 case DEPENDENCY_TRACKING_COMMIT_ORDER: m_commit_order.get_dependency(thd, sequence_number, commit_parent); break; case DEPENDENCY_TRACKING_WRITESET: m_commit_order.get_dependency(thd, sequence_number, commit_parent); m_writeset.get_dependency(thd, sequence_number, commit_parent); break; case DEPENDENCY_TRACKING_WRITESET_SESSION: m_commit_order.get_dependency(thd, sequence_number, commit_parent); m_writeset.get_dependency(thd, sequence_number, commit_parent); m_writeset_session.get_dependency(thd, sequence_number, commit_parent); break; å¯ä»¥çœ‹åˆ°å¾ COMMIT_ORDER åˆ° WRITESET å†åˆ° WRITESET_SESSION å…¶å¯¦éƒ½æ˜¯ä»¥ä¸Šä¸€å€‹è¨­å®šçš„ç‚ºåŸºç¤é€²ä¸€æ­¥é€éä¸€å€‹æ–°çš„ function é€²è¡Œä¿®æ”¹è€Œå·²ï¼Œé€™äº› function ä¿®æ”¹çš„æ˜¯ last_commited å€¼ã€‚\nWriteSet æ­·å²ç´€éŒ„è©³è§£ WriteSet çš„æ­·å²ç´€éŒ„åŒ…å«äº† 2 å€‹å…ƒç´ ï¼š\nWriteSet çš„ Hash å€¼ æœ€å¾Œä¸€æ¬¡ä¿®æ”¹è©²è¡Œçš„ Transaction å…¶ sequence_number 1 2 3 4 5 6 /* Track the last transaction sequence number that changed each row in the database, using row hashes from the writeset as the index. */ typedef std::map\u0026lt;uint64,int64\u0026gt; Writeset_history; //mapå®ç° Writeset_history m_writeset_history; å¦å¤– binlog_transaction_dependency_history_size æ±ºå®šäº†å¯ä»¥å„²å­˜å¹¾çµ„ç´€éŒ„ï¼Œå…§éƒ¨æœƒä¾ç…§ WriteSet Hash å€¼é€²è¡Œæ’åºã€‚\nå¦‚æœ WriteSet çš„æ­·å²ç´€éŒ„é”åˆ° binlog_transaction_dependency_history_size è¨­å®šçš„å€¼å°±æœƒå°‡æ­·å²ç´€éŒ„æ¸…ç©ºï¼Œä¸¦ä¸”æœ¬æ¬¡çš„ Transaction æœƒæˆç‚ºæ¸…ç©ºå¾Œæ­·å²ç´€éŒ„çš„ç¬¬ä¸€ç­†ç´€éŒ„ã€‚\nå¦å¤–é™¤äº†æ­·å²ç´€éŒ„é‚„æœ‰æœ‰ä¸€å€‹ m_writeset_history_start çš„å€¼ï¼Œç”¨ä¾†å„²å­˜é€™å€‹æ­·å²ç´€éŒ„ä¸­çš„æœ€å° sequence_numberã€‚\n1 2 3 4 5 6 7 8 if (exceeds_capacity || !can_use_writesets) //Writesetçš„å†å²MAPå·²æ»¡ { m_writeset_history_start= sequence_number; //å¦‚æœè¶…è¿‡æœ€å¤§è®¾ç½®ï¼Œæ¸…ç©ºwriteset historyã€‚ä»å½“å‰seq number é‡æ–°è®°å½•ï¼Œ ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªäº‹åŠ¡seq number m_writeset_history.clear(); //æ¸…ç©ºå†å²MAP } WriteSet MTS å° last_commit çš„è™•ç†æµç¨‹ é€™è£¡é€éä¸€å€‹ä¾‹å­è§£é‡‹ï¼Œå‡è¨­å¦‚ä¸‹ï¼š\nç•¶å‰çš„ Transaction åŸºæ–¼ ORDER_COMMIT (Group Commit) çš„æ–¹å¼ç”¢ç”Ÿäº†çµæœï¼š last_commit = 125 sequence_number = 130 è©² Transaction ä¿®æ”¹çš„è¡¨åªæœ‰ PK æ²’æœ‰ UKã€‚ è©² Transaction ä¿®æ”¹äº† 4 è¡Œè³‡æ–™ï¼Œåˆ†åˆ¥ç‚º ROW1ã€ROW7ã€ROW6ã€ROW10ã€‚ ä¸‹åœ–å±•ç¤ºäº†è©² Transaction å’Œ WriteSet æ­·å²ç´€éŒ„ï¼š\næ¥ä¸‹ä¾†å°±æœƒé€é WriteSet æ–¹å¼æ‰¾åˆ°æ›´å°çš„ last_commitï¼š\nå°‡ last_commit ç”± 125 èª¿æ•´ç‚º 100 (æ­·å²ç´€éŒ„ä¸­æœ€å°çš„ sequence_number m_writeset_history_start)ã€‚\nå‚™è¨»ï¼šå› ç‚ºè©² Transaction æ¯”æ­·å²ç´€éŒ„ä¸­çš„ Transaction æ™šåŸ·è¡Œï¼Œå› æ­¤ last_commit ä¸€å®šéƒ½æ¯”ä»–å€‘çš„ sequence_number å¤§ã€‚\nå°‡ ROW1 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š\nå°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 120 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚ å°‡è©² Transaction çš„ last_commit ç”± 100 èª¿æ•´ç‚º 120ã€‚ å°‡ ROW7 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š\nå°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 114 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚ ç•¶å‰ Transaction ç•¶å‰ last_commit ç‚º 120 æ¯”æ­·å²ç´€éŒ„ä¸­çš„ 114 å¤§ï¼Œå› ç‚ºåœ¨ 120 å°±è¡çªäº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹æˆæ›´å°çš„ 114ï¼Œå› æ­¤ last_commit ä¸è®Šä¾èˆŠæ˜¯ 120ã€‚ å°‡ ROW6 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š\nå°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 105 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚ ç•¶å‰ Transaction ç•¶å‰ last_commit ç‚º 120 æ¯”æ­·å²ç´€éŒ„ä¸­çš„ 105 å¤§ï¼Œå› ç‚ºåœ¨ 120 å°±è¡çªäº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹æˆæ›´å°çš„ 105ï¼Œå› æ­¤ last_commit ä¸è®Šä¾èˆŠæ˜¯ 120ã€‚ å°‡ ROW10 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾ä¸¦æ²’æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š\nå› ç‚ºæ²’æœ‰æ‰¾åˆ°ç›¸åŒçš„ WriteSetï¼Œå› æ­¤éœ€è¦æŠŠè©² Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number å¯«å…¥ WriteSet æ­·å²ç´€éŒ„ã€‚ å¦‚æœæ­·å²ç´€éŒ„å¤§å°è¶…é binlog_transaction_dependency_history_sizeï¼Œå‰‡æ¸…ç©ºç•¶å‰æ­·å²ç´€éŒ„ï¼Œéš¨å¾Œå°‡ Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number(130) å¯«å…¥ WriteSet æ–°çš„æ­·å²ç´€éŒ„ï¼Œä¸¦å°‡ m_writeset_history_start æ”¹ç‚º 130ã€‚ å¦‚æœæ­·å²ç´€éŒ„å¤§å°æ²’æœ‰è¶…é binlog_transaction_dependency_history_sizeï¼Œå°‡ Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number(130) å¯«å…¥ WriteSet ç•¶å‰æ­·å²ç´€éŒ„ã€‚ æ•´å€‹éç¨‹çµæŸï¼Œè©² Transaction çš„ last_commit ç”±åŸæœ¬çš„ 125 é™ä½ç‚º 120ï¼Œæœ€å¾Œçµæœå¦‚ä¸‹åœ–ï¼š\nè©²éç¨‹åœ¨ Function Writeset_trx_dependency_tracker::get_dependency ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 if (can_use_writesets) //å¦‚æœèƒ½å¤Ÿä½¿ç”¨writeset æ–¹å¼ { /* Check if adding this transaction exceeds the capacity of the writeset history. If that happens, m_writeset_history will be cleared only after è€Œ add_pke using its information for current transaction. */ exceeds_capacity= m_writeset_history.size() + writeset-\u0026gt;size() \u0026gt; m_opt_max_history_size; //å¦‚æœå¤§äºå‚æ•°binlog_transaction_dependency_history_sizeè®¾ç½®æ¸…ç†æ ‡è®° /* Compute the greatest sequence_number among all conflicts and add the transaction\u0026#39;s row hashes to the history. */ int64 last_parent= m_writeset_history_start; //ä¸´æ—¶å˜é‡ï¼Œé¦–å…ˆè®¾ç½®ä¸ºæœ€å°çš„ä¸€ä¸ªseq number for (std::set\u0026lt;uint64\u0026gt;::iterator it= writeset-\u0026gt;begin(); it != writeset-\u0026gt;end(); ++it) //å¾ªç¯æ¯ä¸€ä¸ªWritesetä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  { Writeset_history::iterator hst= m_writeset_history.find(*it); //æ˜¯å¦åœ¨writeset historyä¸­ å·²ç»å­˜åœ¨äº†ã€‚ mapä¸­çš„å…ƒç´ æ˜¯ keyæ˜¯writeset å€¼æ˜¯sequence number if (hst != m_writeset_history.end()) //å¦‚æœå­˜åœ¨ { if (hst-\u0026gt;second \u0026gt; last_parent \u0026amp;\u0026amp; hst-\u0026gt;second \u0026lt; sequence_number) last_parent= hst-\u0026gt;second; //å¦‚æœå·²ç»å¤§äºäº†ä¸éœ€è¦è®¾ç½® hst-\u0026gt;second= sequence_number; //æ›´æ”¹è¿™è¡Œè®°å½•çš„sequence_number } else { if (!exceeds_capacity) m_writeset_history.insert(std::pair\u0026lt;uint64, int64\u0026gt;(*it, sequence_number)); //æ²¡æœ‰å†²çªåˆ™æ’å…¥ã€‚ } } ...... if (!write_set_ctx-\u0026gt;get_has_missing_keys()) //å¦‚æœæ²¡æœ‰ä¸»é”®å’Œå”¯ä¸€é”®é‚£ä¹ˆä¸æ›´æ”¹last commit { /* The WRITESET commit_parent then becomes the minimum of largest parent found using the hashes of the row touched by the transaction and the commit parent calculated with COMMIT_ORDER. */ï¼› commit_parent= std::min(last_parent, commit_parent); //è¿™é‡Œå¯¹last commitåšæ›´æ”¹äº†ã€‚é™ä½ä»–çš„last commit } } } } if (exceeds_capacity || !can_use_writesets) { m_writeset_history_start= sequence_number; //å¦‚æœè¶…è¿‡æœ€å¤§è®¾ç½® æ¸…ç©ºwriteset historyã€‚ä»å½“å‰sequence é‡æ–°è®°å½• ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªäº‹åŠ¡seqnuce number m_writeset_history.clear();//æ¸…ç©ºçœŸä¸ªMAP } WRITESET_SESSION æ€éº¼åš? å‰é¢æœ‰æåˆ°é WRITESET_SESSION æ˜¯åŸºæ–¼ WRITESET çš„åŸºç¤ä¸Šç¹¼çºŒè™•ç†çš„ï¼ŒWRITESET_SESSION è¦åšåˆ°çš„æ˜¯åŒä¸€å€‹ session çš„ Transaction ä¸èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼Œè¦å¯¦ç¾éå¸¸ç°¡å–®ï¼š\n1 2 3 4 5 6 7 8 9 10 int64 session_parent= thd-\u0026gt;rpl_thd_ctx.dependency_tracker_ctx(). get_last_session_sequence_number(); //å–æœ¬sessionçš„ä¸Šä¸€æ¬¡äº‹åŠ¡çš„seq number if (session_parent != 0 \u0026amp;\u0026amp; session_parent \u0026lt; sequence_number) //å¦‚æœæœ¬sessionå·²ç»åšè¿‡äº‹åŠ¡å¹¶ä¸”æœ¬æ¬¡å½“å‰çš„seq numberå¤§äºä¸Šä¸€æ¬¡çš„seq number commit_parent= std::max(commit_parent, session_parent); //è¯´æ˜è¿™ä¸ªsessionåšè¿‡å¤šæ¬¡äº‹åŠ¡ä¸å…è®¸å¹¶å‘ï¼Œä¿®æ”¹ä¸ºorder_commitç”Ÿæˆçš„last commit thd-\u0026gt;rpl_thd_ctx.dependency_tracker_ctx(). set_last_session_sequence_number(sequence_number); //è®¾ç½®session_parentçš„å€¼ä¸ºæœ¬æ¬¡seq numberçš„å€¼ é—œæ–¼ binlog_transaction_dependency_history_size åƒæ•¸èªªæ˜ è©²åƒæ•¸é»˜èªå€¼ç‚º 25000ï¼Œä»£è¡¨çš„æ˜¯ WriteSet è£¡å…ƒç´ çš„æ•¸é‡ã€‚\nå¾å‰é¢ WriteSet å¯¦ç¾ç´°ç¯€èªªæ˜ä¸­æˆ‘å€‘å¯ä»¥çŸ¥é“ä¿®æ”¹ä¸€è¡Œæ•¸æ“šå¯èƒ½æœƒç”¢ç”Ÿå¤šå€‹ Hashï¼Œæ‰€ä»¥é€™å€‹å€¼ä¸æœƒç­‰æ–¼ä¿®æ”¹çš„è¡Œæ•¸ï¼Œå¯ä»¥ç†è§£ç‚ºå¦‚ä¸‹ï¼š\n5.7 ç‰ˆæœ¬ï¼šbinlog_transaction_dependency_history_size = ä¿®æ”¹çš„è¡Œæ•¸ * ( 1 + UK æ•¸é‡ ) * 2 8.0 ç‰ˆæœ¬ï¼šbinlog_transaction_dependency_history_size = ä¿®æ”¹çš„è¡Œæ•¸ * ( 1 + UK æ•¸é‡ ) å‚™è¨»ï¼šä¸åŒåŸå› åœ¨æ–¼ 5.7 æœƒç”ŸæˆåŒ…å« collation å’Œä¸åŒ…å« collationï¼Œåœ¨ 8.0 ä¸­å‰‡æ²’æœ‰ã€‚\nå¦‚æœå°‡é€™å€‹åƒæ•¸åŠ å¤§ï¼Œé‚£éº¼ Source ä¸Šçš„ WriteSet å°±èƒ½æ”¾è¶Šå¤šçš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯èªª Transaction å¯ä»¥ç”Ÿæˆæ›´å°çš„ last_commitedï¼Œé€™åœ¨ Replica ä¸Šå°±èƒ½æé«˜ä¸¦è¡Œå›æ”¾çš„æ•ˆç‡ï¼Œç•¶ç„¶ç¼ºé»å°±æ˜¯åœ¨ Source æœƒæ¶ˆè€—æ›´å¤šçš„è³‡æºã€‚\nWriteSet ä¸é©ç”¨æƒ…å¢ƒ ä»¥ä¸‹æƒ…å¢ƒä¸é©ç”¨ WriteSetï¼ŒMySQL æœƒè‡ªå‹•é€€å›ä½¿ç”¨ commit_order (åŸºæ–¼ group commit) æ¨¡å¼\næ²’æœ‰ PK ä¹Ÿæ²’æœ‰ UK DDL session çš„ hash ç®—æ³•æ› history ä¸åŒ Transaction æ›´æ–°äº†æœ‰ Forign key é—œè¯çš„æ¬„ä½ slave_preserve_commit_order ä»‹ç´¹ ç•¶é–‹å•Ÿ MTS ä¸” slave_parallel_type = LOGICAL_CLOCK (ä¸è«–å…·é«”æ˜¯åŸºæ–¼ commit_order é‚„æ˜¯ writeset) çš„æ™‚å€™ï¼Œæœ‰å¯èƒ½æœƒç™¼ç”Ÿ Source å’Œ Replica åŸ·è¡Œé †åºä¸åŒçš„æƒ…æ³ï¼Œé›–ç„¶é€™ä¸¦ä¸æœƒå°è‡´è³‡æ–™ä¸ä¸€è‡´çš„ç‹€æ³ï¼Œä½†æ˜¯å¯èƒ½æœƒç™¼ç”Ÿåœ¨ Source ä¸Šå…ˆçœ‹åˆ° T1 æ‰çœ‹åˆ° T2 å»åœ¨ Replica ä¸Šå»æ˜¯å…ˆçœ‹åˆ° T2 æ‰çœ‹åˆ° T1 åŸ·è¡Œï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ Source å’Œ Replica å„è‡ªçš„ binlog æ­·å²ç´€éŒ„é †åºä¹Ÿæœƒä¸ä¸€è‡´ï¼Œæ²’æœ‰ä¿è­‰ Causal Consistencyã€‚\nğŸ’¡ Causal Consistency (å› æœä¸€è‡´æ€§) æ„æ€æ˜¯å¦‚æœå…©å€‹äº‹ä»¶æœ‰å› æœé—œä¿‚ï¼Œé‚£éº¼åœ¨æ‰€æœ‰ç¯€é»éƒ½å¿…é ˆèƒ½è§€æ¸¬åˆ°é€™ç¨®å› æœé—œä¿‚ã€‚\nå¦‚æœè©•ä¼°æ¥­å‹™éœ€è¦ä¿è­‰Causal Consistencyï¼Œé™¤äº†ä¸ä½¿ç”¨ MTS ä½¿ç”¨å–®ç·šç¨‹ replication ä¹Ÿå¯ä»¥é€éè¨­ç½® slave_preserve_commit_order=ON ä¾†é¿å…ï¼Œé€™æœƒè®“ Replica ä¸Šå›æ”¾çš„ Transaction åœ¨é€²å…¥ flush éšæ®µä¹‹å‰æœƒå…ˆç­‰å¾… sequence_number ä¹‹å‰çš„ Transaction å…ˆé€²å…¥ flush éšæ®µã€‚\nGAP å¦‚æœ slave_preserve_commit_order = OFF é™¤äº†ä¸Šé¢æåˆ° Causal Consistency é‚„æœ‰ä¸€å€‹å•é¡Œåœ¨å®˜æ–¹æ–‡æª”ä¸­ç¨±ç‚º GAPã€‚\né–‹å•Ÿ MTS æ™‚é€é show slave status æŸ¥çœ‹ Exec_Source_Log_Pos æŒ‡çš„æ˜¯ low-watermark ä¹Ÿå°±æ˜¯ä¿è­‰é€™å€‹ postition ä¹‹å‰çš„ Transaction éƒ½å·²ç¶“ commitï¼Œä½†æ˜¯è©² postition ä¹‹å¾Œçš„ Transaction æœ‰å¯èƒ½ commit ä¹Ÿå¯èƒ½æ²’æœ‰ commitï¼Œ\nç›¸é—œåƒæ•¸ slave_parallel_workers (5.6 ~ 8.0.25)ã€replica_parallel_workers (8.0.26 ~)\nè¨­å®šè¦åœ¨ replica ä¸¦è¡Œçš„ thread æ•¸é‡ã€‚\nå¦‚æœ slave æœ‰å¤šå€‹ channelï¼Œå‰‡æ¯å€‹ channel éƒ½æœƒæœ‰æ­¤æ•¸é‡çš„ threadã€‚\nè¨­ç½®æ­¤åƒæ•¸å¾Œå¿…é ˆé‡æ–° START REPLICA æ‰æœƒç”Ÿæ•ˆã€‚\nslave_parallel_type (5.7 ~ 8.0.25)ã€replica_parallel_type (8.0.26 ~ 8.0.29)\nè¨­å®šåœ¨ replica ä¸Šå…è¨±å“ªäº› Transaction ä¸¦è¡Œå›æ”¾\nDATABASEï¼šTransaction å¿…é ˆä½œç”¨æ–¼ä¸åŒ Database æ‰èƒ½ä¸¦è¡Œã€‚ LOGICAL_CLOCKï¼šåŸºæ–¼ Source å¯«å…¥ binlog çš„ timestamp ä¾†æ±ºå®š Transaction çš„ä¸¦è¡Œï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ Group Commitã€‚ å»ºè­°å°‡ binlog_transaction_dependency_tracking è¨­ç½®ç‚º WRITESET æˆ– WRITESET_SESSION ï¼Œé€™æ¨£åœ¨åˆé©çš„æƒ…æ³ä¸‹æœƒèµ° WriteSet ä¾†æé«˜ä¸¦è¡Œåº¦ã€‚\né è¨ˆ 8.0.29 ä¹‹å¾Œæ£„ç”¨æ­¤åƒæ•¸ï¼Œç¸½æ˜¯ä»¥ LOGICAL_CLOCK çš„æ–¹å¼é‹è¡Œã€‚\nbinlog_group_commit_sync_delay\næ§åˆ¶ binlog commit ä¹‹å¾Œç­‰å¾… N å¾®ç§’å¾Œæ‰ fsync åˆ° Diskï¼Œè¨­ç½®è¶Šå¤§å–®å€‹ Group å¯ä»¥æœ‰æ›´å¤šæ™‚é–“ç­‰åˆ°æ›´å¤šçš„ Transaction ä¸€èµ· fsync Diskï¼Œæ¸›å°‘ fsync çš„æ¬¡æ•¸åŠæ¸›å°‘æ¯å€‹ Transaction commit çš„å–®ä½æ™‚é–“ã€‚\næ­¤å¤–é©åº¦çš„å¢åŠ å°æ–¼ä»¥ä¸‹è¨­ç½®çš„ MTS ä¹Ÿèƒ½å¢åŠ åœ¨ Slave çš„ä¸¦è¡Œåº¦ï¼š\n1 2 3 4 5 # Master binlog_transaction_dependency_tracking = COMMIT_ORDER # Slave slave_parallel_type = LOGICAL_CLOCK æ³¨æ„ï¼šæœƒå¢åŠ  server ä¸Š transaction çš„å»¶é²ï¼Œä¹Ÿå°±æ˜¯ client ç«¯æ”¶åˆ° transaction commit çš„æ™‚é–“æœƒè®Šæ™šï¼Œå¦å¤–ç›¸æ‡‰çš„æœƒå¢åŠ è³‡æºçš„ç«¶çˆ­ï¼Œå› æ­¤éœ€è©•ä¼°æœ€å¥½çš„è¨­ç½®ã€‚\nè£œå……ï¼šåœ¨æœ‰ Group Commit ä¹‹å¾Œï¼Œsync_binlog çš„å–®ä½æŒ‡çš„æ˜¯ Group è€Œä¸æ˜¯ Transactionï¼Œä¾‹å¦‚ï¼šsync_binlog = 1000ï¼Œè¡¨ç¤ºçš„ä¸æ˜¯æ¯ 1000 å€‹ Transaction å°± sync binlogï¼Œè€Œæ˜¯æ¯ 1000 å€‹ Group æ‰ sync binlogã€‚\nbinlog_group_commit_sync_no_delay_count\nåœ¨ Group commit ä¸­ç­‰å¾…çš„ N å€‹ Transaction å¾Œå°±ä¸ç­‰å¾… binlog_group_commit_sync_delay è¨­ç½®çš„æ™‚é–“ç›´æ¥é–‹å§‹ sync binlogã€‚\nç•¶ binlog_group_commit_sync_delay = 0 ï¼Œæ­¤åƒæ•¸ç„¡æ•ˆã€‚\nslave_preserve_commit_order (5.7 ~ 8.0.25)ã€replica_preserve_commit_order (8.0.26 ~)\nåªæœ‰ç•¶ slave_parallel_type = LOGICAL_CLOCK ä¸” log-slave-updates é–‹å•Ÿæ™‚æ‰èƒ½è¨­ç½®ã€‚\nç•¶è¨­ç½®ç‚º 0 æˆ– OFF æ™‚ï¼Œåœ¨ Replica ä¸Šçš„è®€å–æ“ä½œç„¡æ³•æ»¿è¶³ Causal Consistency ï¼Œåœ¨ Source å’Œ Replica ä¸Š Transaction åœ¨ binlog ä¸­å¯èƒ½æœ‰ä¸åŒçš„å¯«å…¥é †åºï¼Œå¦å¤–åœ¨æª¢æŸ¥ Replica ä¸Šæœ€è¿‘åŸ·è¡Œçš„ Transaction ç„¡æ³•ä¿è­‰å°æ‡‰åˆ° Source ä¸Šè©² Transaction ä½ç½®ä¹‹å‰çš„ Transaction éƒ½å·²ç¶“åŸ·è¡Œå®Œç•¢ã€‚\nè¨­ç½®ç‚º 1 æˆ– ON ç¢ºä¿ Transaction åœ¨åŸ·è¡Œæ™‚æŒ‰ç…§åœ¨ relay log ä¸­çš„é †åºï¼Œé€™å¯ä»¥è®“ Master å’Œ Replica æœ‰ç›¸åŒçš„ Transaction history logï¼Œä¹Ÿå°±æ˜¯ç¬¦åˆ Causal Consistencyã€‚\nbinlog_transaction_dependency_tracking (5.7.22 ~)\næŒ‡å®š Source ä¾æ“šä»€éº¼æ–¹å¼ä¾†ç”Ÿæˆ Transaction ä¹‹é–“çš„ä¾è³´é—œä¿‚å¯«å…¥ binlogï¼Œå”åŠ© Replica ç¢ºå®šé‚£äº› Transaction èƒ½å¤ ä¸¦è¡ŒåŸ·è¡Œã€‚\nå¿…é ˆè¨­ç½® replica_parallel_type ç‚º LOGICAL_CLOCKã€‚\næœ‰ä»¥ä¸‹ä¸‰ç¨®å€¼ï¼š\nCOMMIT_ORDERï¼šä½¿ç”¨ 5.7 Group commit çš„æ–¹å¼åˆ¤æ–·ã€‚ WRITESETï¼šä½¿ç”¨ WriteSet çš„æ–¹å¼åˆ¤æ–· Transaction æ˜¯å¦æœ‰è¡çªã€‚ WRITESET_SESSIONï¼šWRITESET çš„åŸºç¤ä¸Šä¿è­‰åŒä¸€å€‹ session å…§çš„ Transaction ä¸å¯ä¸¦è¡Œã€‚ binlog_transaction_dependency_history_size (8.0 ~)\nWriteSet æœƒåˆ¤æ–· Transaction ä¹‹é–“æ˜¯å¦è¡çªï¼Œå› æ­¤éœ€è¦å°‡ commit çš„ Transaction ä¿®æ”¹çš„è¡Œ hash å¾Œæš«æ™‚ä¿å­˜åœ¨å…§å­˜ã€‚\næ­¤åƒæ•¸ç”¨ä¾†è¨­å®šå„²å­˜çš„ hash ä¸Šé™ï¼Œè¶…éæ­¤ä¸Šé™æœƒæ¸…é™¤å…ˆå‰çš„æ­·å²ç´€éŒ„ã€‚\nè‹¥ Source æ€§èƒ½æœ‰é¤˜è£•å¯ä»¥è€ƒæ…®æå‡æ­¤åƒæ•¸ï¼Œé€²ä¸€æ­¥æé«˜ Replica çš„ä¸¦è¡Œåº¦ã€‚\ntransaction_write_set_extraction\nè¨­å®š WriteSet ä½¿ç”¨çš„ Hash æ¼”ç®—æ³•ã€‚\nMySQL 5.7 é è¨­ç‚º OFFï¼ŒMySQL 8.0.26 å¾Œæ£„ç”¨ï¼Œä¸€èˆ¬ä¸ç”¨ç‰¹åˆ¥èª¿æ•´ã€‚\nå®˜æ–¹æ¸¬è©¦æ•¸æ“š ä»¥ä¸‹ç‚ºå®˜æ–¹ä½¿ç”¨SYSBENCHé€²è¡Œå£“æ¸¬çš„åœ–è¡¨ï¼Œå¯ä»¥è§€å¯Ÿåˆ°ï¼š\nåœ¨ Source ä½ä¸¦è¡Œç‡çš„æƒ…æ³ï¼ŒWRITESET çš„æ©Ÿåˆ¶ä¸‹ Replica ä»èˆŠèƒ½å¤ æœ‰è‰¯å¥½çš„ä¸¦è¡Œç‡ã€‚ ç•¶ Source ä¸¦è¡Œç‡è¶Šé«˜ï¼ŒCOMMIT_ORDER å’Œ WriteSet å·®è·æœƒç¸®å°ã€‚ è¦ªè‡ªæ¸¬è©¦ ç’°å¢ƒï¼šMysql 8.0.12ï¼Œæ¸¬è©¦å‰stop slaveï¼Œå¾…sysbenchè·‘å®Œå¾Œåœ¨start slave\nç¢ºèªåœ¨performance_schemaä¸­ï¼ŒMTSç›¸é—œçš„çµ±è¨ˆENABLEDçš†æœ‰é–‹å•Ÿ(YES)\n(*å•Ÿç”¨æˆ–ç¦ç”¨transaction eventçš„æ”¶é›†)\n(åˆ†åˆ¥ç‚ºç•¶å‰çš„transaction eventï¼Œæ¯å€‹ç·šç¨‹æœ€è¿‘çš„transaction eventï¼Œglobal(è·¨ç·šç¨‹)æœ€è¿‘çš„transaction event)\næŸ¥è©¢MTSä¸¦è¡Œåº¦çš„èªæ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 select thread_id,count_star from events_transactions_summary_by_thread_by_event_name where thread_id in ( select thread_id from replication_applier_status_by_worker ); OR USE test; CREATE VIEW rep_thread_count AS SELECT a.THREAD_ID AS THREAD_ID,a.COUNT_STAR AS COUNT_STAR FROM performance_schema.events_transactions_summary_by_thread_by_event_name a WHERE a.THREAD_ID in (SELECT b.THREAD_ID FROM performance_schema.replication_applier_status_by_worker b); SELECT SUM(COUNT_STAR) FROM rep_thread_count INTO @total; SELECT 100*(COUNT_STAR/@total) AS thread_usage FROM rep_thread_count; #replication_applier_status_by_workerå¯ä»¥æŸ¥çœ‹replicationå„å€‹ç·šç¨‹çš„é‹ä½œç‹€æ³ #events_transactions_summary_by_thread_by_event_nameå½™ç¸½çš„æ¯å€‹ç·šç¨‹çš„äº‹ä»¶åç¨±ï¼ŒåŒ…å«å·²é—œé–‰ç·šç¨‹ #é€éreplication...tableæ‰¾å‡ºæ­£åœ¨é‹ä½œçš„ç·šç¨‹å†åˆ°event...tableæ‰¾åˆ°ä»–å€‘çš„count_star(åŸ·è¡Œçš„transactionæ•¸é‡) é¦–æ¬¡å£“æ¸¬ä»¥Threads 1 é€²è¡Œ10åˆ†é˜å£“æ¸¬\nåœ¨commit_orderä¸‹æ¸¬è©¦(å³MySQL 5.7ä½¿ç”¨)\nåœ¨WriteSetä¸‹æ¸¬è©¦(MySQL 8.0æ–°æ–¹æ¡ˆ)\næ¥è‘—è©¦è©¦çœ‹Threads 128é€²è¡Œ10åˆ†é˜å£“æ¸¬\nåœ¨commit_orderä¸‹æ¸¬è©¦(å³MySQL 5.7ä½¿ç”¨)\nåœ¨WriteSetä¸‹æ¸¬è©¦(MySQL 8.0æ–°æ–¹æ¡ˆ)\næ¸¬è©¦çµæœåŸºæœ¬ä¸Šå’Œå®˜æ–¹æä¾›çš„å·®ä¸å¤šï¼Œä¸»è¦æ˜¯è§£æ±ºåœ¨Masterä½ä¸¦è¡Œåº¦çš„æƒ…æ³ä¸‹ï¼Œæé«˜MTSçš„æ•ˆç‡ã€‚\nLOG ç•¶é–‹å•Ÿ MTS ä¸” log_error_verbosity = 3 (NOTE) æ™‚ï¼Œæœƒåœ¨\n1 2023-01-30T03:08:36.440821Z 6 [Note] [MY-010559] [Repl] Multi-threaded slave statistics for channel \u0026#39;\u0026#39;: seconds elapsed = 277; events assigned = 20795393; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 0; waited at clock conflicts = 12923330700 waited (count) when Workers occupied = 0 waited when Workers occupied = 0 æ‡¶äººåŒ… MySQL 5.7~5.7.21 åƒæ•¸è¨­å®š Source (Master)\n1 2 3 # ä»¥ä¸‹éå¿…é ˆï¼Œä¾æ“šå¯¦éš›æƒ…æ³è©•ä¼°èª¿æ•´ binlog_group_commit_sync_delay = ? binlog_group_commit_sync_no_delay_count = ? Replica (Slave)\n1 2 3 4 # æ¨è–¦èª¿æ•´ slave_parallel_workers = ? slave_parallel_type = LOGICAL_CLOCK slave_preserve_commit_order = ON MySQL 5.7.22~8.0.XX åƒæ•¸è¨­å®š Source (Master)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # æ¨è–¦èª¿æ•´ binlog_transaction_dependency_tracking = WRITESET_SESSION transaction_write_set_extraction = XXHASH64 # ä»¥ä¸‹ä¾æ“šå¯¦éš›æƒ…æ³è©•ä¼°èª¿æ•´ # å„ªå…ˆèª¿æ•´ binlog_transaction_dependency_history_size = ? # èª¿æ•´å„ªå…ˆåº¦ä½ï¼Œå› ç‚ºé€€åŒ–å› commit order æ™‚æ‰æœ‰æ•ˆï¼Œæƒ…å¢ƒç‚ºï¼š # 1. æ²’æœ‰ pk æˆ– uk # 2. DDL èªå¥ # 3. Transaction çš„æ›´æ–°åŒ…å« FK # 4. history å‰›è¢«æ¸…ç©º # 5. åŒä¸€å€‹ session çš„ Transaction (WRITESET_SESSION) binlog_group_commit_sync_delay = ? binlog_group_commit_sync_no_delay_count = ? Replica (Slave)\n1 2 3 4 # æ¨è–¦èª¿æ•´ slave_parallel_workers = ? slave_parallel_type = LOGICAL_CLOCK slave_preserve_commit_order = ON MTS æ•ˆç‡ç¢ºèª èª¿æ•´å¾Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹èªæ³•æŸ¥çœ‹èª¿æ•´å¾Œ MTS ä¸¦è¡Œçš„æ•ˆç‡ï¼Œç†æƒ³çš„æƒ…æ³ä¸‹åŒä¸€å€‹ channel çš„æ¯å€‹ sql thread çš„ count_star æ‡‰è©²å·®ä¸å¤šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 -- mysql 5.7 éœ€å…ˆé–‹å•Ÿä»¥ä¸‹è¨­å®š update performance_schema.setup_consumers set enabled= \u0026#39;yes\u0026#39; where name like \u0026#39;events_transactions%\u0026#39; update performance_schema.setup_instruments set enabled= \u0026#39;yes\u0026#39; where name like \u0026#39;transaction\u0026#39; -- mysql 5.7 éœ€å…ˆé–‹å•Ÿä»¥ä¸Šè¨­å®š SELECT replication_status.CHANNEL_NAME, replication_status.thread_id, enent_summary.count_star FROM performance_schema.events_transactions_summary_by_thread_by_event_name AS enent_summary INNER JOIN performance_schema.replication_applier_status_by_worker AS replication_status USING(thread_id) BUG MySQL Bugs: #103636: Slave hangs with slave_preserve_commit_order On\nèªªæ˜ï¼šç•¶ replica è¨­ç½®äº† replica_preserve_commit_order = 1 åœ¨é«˜è² è¼‰ä¸‹é•·æ™‚é–“ä½¿ç”¨æ™‚ï¼Œå¯èƒ½æœƒç”¨å®Œ commit order sequence tickets å°è‡´ applier æ›èµ· (hang) ä¸¦ä¸”ç„¡æœŸé™çš„æŒçºŒç­‰å¾… commit order queueã€‚\nå½±éŸ¿ç‰ˆæœ¬ï¼šMySQL 8.0.28 ä¹‹å‰\nä¿®å¾©ç‰ˆæœ¬ï¼š MySQL 8.0.28\ngithub è³‡è¨Šï¼šBUG#32891221 REPLICA HANGS WITH REPLICA_PRESERVE_COMMIT_ORDER ON Â· mysql/mysql-server@f6bb5e7 Â· GitHub\nåƒè€ƒ MySQL Â· ç‰¹æ€§åˆ†æ Â· 8.0 WriteSet å¹¶è¡Œå¤åˆ¶\né€Ÿåº¦æå‡5~10å€ï¼ŒåŸºäºWRITESETçš„MySQLå¹¶è¡Œå¤åˆ¶ #M1013# - VicLW - åšå®¢å›­ (cnblogs.com)\nMySQL 5.7å¹¶è¡Œå¤åˆ¶ä¸­å¹¶è¡Œçš„çœŸæ­£å«ä¹‰_ä»²åŸ¹è‰ºçš„åšå®¢-CSDNåšå®¢\nMySQL Â· ç‰¹æ€§åˆ†æ Â· LOGICAL_CLOCK å¹¶è¡Œå¤åˆ¶åŸç†åŠå®ç°åˆ†æ (taobao.org)\nMySQL :: WL#6314: MTS: Prepared transactions slave parallel applier\nMySQL :: WL#7165: MTS: Optimizing MTS scheduling by increasing the parallelization window on master\nMySQL-ç»„æäº¤ä¸å¹¶è¡Œå¤åˆ¶ - æ˜é‡‘ (juejin.cn)\nMySQL :: WL#9556: Writeset-based MTS dependency tracking on master\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· Group Replicationå†…æ ¸è§£æ (taobao.org)\nç¤¾åŒºæŠ•ç¨¿ | åŸºäº WRITESET çš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ (actionsky.com)\nMySQL :: Improving the Parallel Applier with Writeset-based Dependency Tracking\nMySQL Group Replicationå†²çªæ£€æµ‹æœºåˆ¶å†å‰–æ - çŸ¥ä¹ (zhihu.com)\næ·±å…¥æµ…æä¸€è‡´æ€§æ¨¡å‹ä¹‹Causal Consistency - çŸ¥ä¹ (zhihu.com)\nMySQL :: MySQL 8.0 Reference Manual :: 17.5.1.34 Replication and Transaction Inconsistencies\nMySQL :: MySQL 8.0 Reference Manual :: 13.4.2.8 START REPLICA Statement\nMySQL :: MySQL 8.0 Reference Manual :: 13.7.7.35 SHOW REPLICA STATUS Statement\n","date":"2025-04-07T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-mts/","title":"ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)"},{"content":"æ›¾ç¶“åœ¨æ­£å¼ç’°å¢ƒé‡éä¸€å€‹ç‰¹æ®Šçš„æƒ…å¢ƒï¼Œæˆ‘å€‘éƒ½çŸ¥é“ DEADLOCK çš„æˆå› åœ¨æ–¼ä¸åŒçš„åŠ é–é †åºï¼ŒåŠ ä¸Šé€™å…©å¥ WHEREæ¢ä»¶æ˜¯ç›¸ä¼¼çš„èªæ³•ï¼Œå»é‚„æ˜¯é‡åˆ°äº† DEADLOCKï¼Œå› æ­¤æˆ‘çš„ç¬¬ä¸€å€‹åæ‡‰æ˜¯å…©å€‹ TRANSACTION ä¸­å·²åŸ·è¡Œèªå¥çš„ LOCK æœªé‡‹æ”¾ï¼Œå°è‡´äº’ç›¸é˜»å¡å°æ–¹å¼•èµ·çš„ã€‚ä¸éäº‹å¾ŒæŸ¥çœ‹ LOG åŠ ä¸Šè©¢å•é–‹ç™¼ç¢ºèªäº†è©²èªå¥çš†æ˜¯å–®ç¨åŸ·è¡Œï¼Œåªå¥½å›é ­é€é EXPLAIN ç¢ºèªåŸ·è¡Œè¨ˆç•«ï¼Œç™¼ç¾å…©å¥èªæ³•èµ°äº†ä¸åŒçš„ INDEXä»¥æ­¤æ‰¾åˆ°æ€è·¯ï¼Œæœ€å¾Œäº†è§£ç™¼ç”Ÿæˆå› ä¸¦æ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆï¼Œæ›´é‡è¦çš„æ˜¯çŸ¥é“äº† **éš±å¼é–(implicit lock)**çš„å­˜åœ¨ã€‚\né‡ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 -- æº–å‚™è³‡æ–™ CREATE DATABASE test_g_order; USE test_g_order; CREATE TABLE `g_order` ( `id` bigint(20) unsigned NOT NULL COMMENT \u0026#39;æ³¨å–®ID\u0026#39;, `round_id` bigint(20) unsigned NOT NULL COMMENT \u0026#39;æœŸæ•¸ID\u0026#39;, `site` char(10) NOT NULL COMMENT \u0026#39;ç«™å°ä»£è™Ÿ\u0026#39;, `user` varchar(10) NOT NULL COMMENT \u0026#39;ä½¿ç”¨è€…ID\u0026#39;, `status` tinyint(1) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;æ³¨å–®ç‹€æ…‹\u0026#39;, `game_id` varchar(20) NOT NULL COMMENT \u0026#39;éŠæˆ²ID\u0026#39;, `wager` varchar(50) NOT NULL COMMENT \u0026#39;ç©æ³•\u0026#39;, `bet_info` json NOT NULL COMMENT \u0026#39;ä¸‹æ³¨è³‡è¨Š\u0026#39;, `bet` decimal(25,4) NOT NULL COMMENT \u0026#39;ä¸‹æ³¨é¡åº¦(ç„¡è² å€¼)\u0026#39;, `pay` decimal(25,4) NOT NULL COMMENT \u0026#39;æ´¾å½©é‡‘é¡(ç„¡è² å€¼)\u0026#39;, `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;æ³¨å–®å‰µå»ºæ™‚é–“\u0026#39;, `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ³¨å–®æ›´æ–°æ™‚é–“\u0026#39;, `round_closed_at` timestamp NOT NULL DEFAULT \u0026#39;0000-00-00 00:00:00\u0026#39; COMMENT \u0026#39;é—œç›¤æ™‚é–“\u0026#39;, `odds_key` varchar(50) GENERATED ALWAYS AS (json_unquote(json_extract(`bet_info`,\u0026#39;$.odds.key\u0026#39;))) VIRTUAL, PRIMARY KEY (`id`,`round_closed_at`), KEY `ID_report` (`status`,`site`,`user`,`created_at`), KEY `ID_settle` (`round_id`,`status`,`game_id`,`wager`,`odds_key`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;è¨ªå®¢æ³¨å–®\u0026#39;; INSERT INTO `g_order` (`id`, `round_id`, `site`, `user`, `status`, `game_id`, `wager`, `bet_info`, `bet`, `pay`, `created_at`, `updated_at`, `round_closed_at`) VALUES (1,1,\u0026#39;site_1\u0026#39;,\u0026#39;user_1\u0026#39;,1,\u0026#39;game_1\u0026#39;,\u0026#39;any\u0026#39;,\u0026#39;{\\\u0026#34;odds\\\u0026#34;: {\\\u0026#34;key\\\u0026#34;: \\\u0026#34;2\\\u0026#34;}}\u0026#39;,10000.0000,0.0000,\u0026#39;2019-07-02 10:33:28\u0026#39;,\u0026#39;2019-07-04 07:00:32\u0026#39;,\u0026#39;2019-07-02 10:30:00\u0026#39;), (2,1,\u0026#39;site_1\u0026#39;,\u0026#39;user_1\u0026#39;,1,\u0026#39;game_1\u0026#39;,\u0026#39;any\u0026#39;,\u0026#39;{\\\u0026#34;odds\\\u0026#34;: {\\\u0026#34;key\\\u0026#34;: \\\u0026#34;3\\\u0026#34;}}\u0026#39;,10000.0000,0.0000,\u0026#39;2019-07-02 10:33:35\u0026#39;,\u0026#39;2019-07-04 07:00:32\u0026#39;,\u0026#39;2019-07-02 10:30:00\u0026#39;), (3,1,\u0026#39;site_1\u0026#39;,\u0026#39;user_1\u0026#39;,1,\u0026#39;game_1\u0026#39;,\u0026#39;sum\u0026#39;,\u0026#39;{\\\u0026#34;odds\\\u0026#34;: {\\\u0026#34;key\\\u0026#34;: \\\u0026#34;ALL\\\u0026#34;}}\u0026#39;,20000.0000,0.0000,\u0026#39;2019-07-02 10:33:42\u0026#39;,\u0026#39;2019-07-04 07:00:32\u0026#39;,\u0026#39;2019-07-02 10:30:00\u0026#39;); -- åŒæ™‚åŸ·è¡Œå…©å¥èªæ³•ï¼Œç‚ºäº†é‚„åŸç•¶æ™‚æƒ…å¢ƒéœ€ä½¿ç”¨ force index æŒ‡å®šç´¢å¼• UPDATE test_g_order.g_order force index(ID_report) SET status = 3, pay = bet * 10 WHERE round_closed_at = \u0026#39;2019-07-02 10:30:00\u0026#39; AND round_id = 1 AND game_id = \u0026#39;game_1\u0026#39; AND wager = \u0026#39;compare\u0026#39; AND status = 1 AND odds_key IN (\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;); UPDATE test_g_order.g_order force index(ID_settle) SET status = 3, pay = 0 WHERE round_closed_at = \u0026#39;2019-07-02 10:30:00\u0026#39; AND round_id = 1 AND game_id = \u0026#39;game_1\u0026#39; AND wager = \u0026#39;any\u0026#39; AND status = 1; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 ------------------------ LATEST DETECTED DEADLOCK ------------------------ 2020-09-29 03:38:46 0x7f22347f8700 *** (1) TRANSACTION: TRANSACTION 12800, ACTIVE 0 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s) MySQL thread id 11343, OS thread handle 139784886118144, query id 803 10.17.117.203 sysbench Searching rows for update UPDATE g_order force index(ID_report) SET status = 3, winlose = 1, updated_at = CURTIME(), paid_amount = bet_amount * bet_info-\u0026gt;\u0026#39;$.odds.value\u0026#39; WHERE round_closed_at = \u0026#39;2019-07-02 10:34:00\u0026#39; AND round_id = 4781292 AND game_id = \u0026#39;652B75-SSC5\u0026#39; AND wager = \u0026#39;compare\u0026#39; AND status = 1 AND odds_key IN (\u0026#39;1:OVER\u0026#39;,\u0026#39;2:UNDER\u0026#39;,\u0026#39;3:OVER\u0026#39;,\u0026#39;4:UNDER\u0026#39;,\u0026#39;5:OVER\u0026#39;) *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 139 page no 3 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 12800 lock_mode X locks rec but not gap waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 22; compact format; info bits 0 0: len 8; hex 0000a40000001cdb; asc ;; 1: len 4; hex 5d1b3318; asc ] 3 ;; 2: len 6; hex 0000000031ff; asc 1 ;; 3: len 7; hex 78000001700110; asc x p ;; 4: len 8; hex 000000000048f4ea; asc H ;; 5: len 6; hex 323238373335; asc 228735;; 6: len 5; hex 3530306370; asc 500cp;; 7: len 30; hex 35656137636538392d373365332d343565372d393932342d636631383836; asc 5ea7ce89-73e3-45e7-9924-cf1886; (total 36 bytes); 8: len 1; hex 00; asc ;; 9: len 1; hex 03; asc ;; 10: len 11; hex 3036303232452d46415433; asc 06022E-FAT3;; 11: len 3; hex 616e74; asc ant;; 12: len 3; hex 434e59; asc CNY;; 13: len 18; hex 616e792d657175616c2d6e6f742d73616d65; asc any-equal-not-same;; 14: len 30; hex 0002004d001200040016000500001b000249006f6464736974656d730200; asc M I oddsitems ; (total 78 bytes); 15: len 1; hex 02; asc ;; 16: len 12; hex 800000000000000027100000; asc \u0026#39; ;; 17: len 12; hex 800000000000000026480000; asc \u0026amp;H ;; 18: len 12; hex 800000000000000000000000; asc ;; 19: len 4; hex 5d1b32f8; asc ] 2 ;; 20: len 4; hex 5f72ac46; asc _r F;; 21: len 0; hex ; asc ;; *** (2) TRANSACTION: TRANSACTION 12799, ACTIVE 0 sec updating or deleting mysql tables in use 1, locked 1 5 lock struct(s), heap size 1136, 6 row lock(s), undo log entries 1 MySQL thread id 11342, OS thread handle 139784886388480, query id 802 10.17.117.203 sysbench updating UPDATE g_order force index(ID_settle) SET status = 3, winlose = 2, updated_at = CURTIME(), paid_amount = 0 WHERE round_closed_at = \u0026#39;2019-07-02 10:34:00\u0026#39; AND round_id = 4781290 AND game_id = \u0026#39;06022E-FAT3\u0026#39; AND wager = \u0026#39;any-equal-not-same\u0026#39; AND status = 1 *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 139 page no 3 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 12799 lock_mode X locks rec but not gap Record lock, heap no 2 PHYSICAL RECORD: n_fields 22; compact format; info bits 0 0: len 8; hex 0000a40000001cdb; asc ;; 1: len 4; hex 5d1b3318; asc ] 3 ;; 2: len 6; hex 0000000031ff; asc 1 ;; 3: len 7; hex 78000001700110; asc x p ;; 4: len 8; hex 000000000048f4ea; asc H ;; 5: len 6; hex 323238373335; asc 228735;; 6: len 5; hex 3530306370; asc 500cp;; 7: len 30; hex 35656137636538392d373365332d343565372d393932342d636631383836; asc 5ea7ce89-73e3-45e7-9924-cf1886; (total 36 bytes); 8: len 1; hex 00; asc ;; 9: len 1; hex 03; asc ;; 10: len 11; hex 3036303232452d46415433; asc 06022E-FAT3;; 11: len 3; hex 616e74; asc ant;; 12: len 3; hex 434e59; asc CNY;; 13: len 18; hex 616e792d657175616c2d6e6f742d73616d65; asc any-equal-not-same;; 14: len 30; hex 0002004d001200040016000500001b000249006f6464736974656d730200; asc M I oddsitems ; (total 78 bytes); 15: len 1; hex 02; asc ;; 16: len 12; hex 800000000000000027100000; asc \u0026#39; ;; 17: len 12; hex 800000000000000026480000; asc \u0026amp;H ;; 18: len 12; hex 800000000000000000000000; asc ;; 19: len 4; hex 5d1b32f8; asc ] 2 ;; 20: len 4; hex 5f72ac46; asc _r F;; 21: len 0; hex ; asc ;; Record lock, heap no 3 PHYSICAL RECORD: n_fields 22; compact format; info bits 0 0: len 8; hex 0000a40000001cdc; asc ;; 1: len 4; hex 5d1b3318; asc ] 3 ;; 2: len 6; hex 0000000031fc; asc 1 ;; 3: len 7; hex 760000016f01c6; asc v o ;; 4: len 8; hex 000000000048f4ea; asc H ;; 5: len 6; hex 323238373335; asc 228735;; 6: len 5; hex 3530306370; asc 500cp;; 7: len 30; hex 35656137636538392d373365332d343565372d393932342d636631383836; asc 5ea7ce89-73e3-45e7-9924-cf1886; (total 36 bytes); 8: len 1; hex 00; asc ;; 9: len 1; hex 01; asc ;; 10: len 11; hex 3036303232452d46415433; asc 06022E-FAT3;; 11: len 3; hex 616e74; asc ant;; 12: len 3; hex 434e59; asc CNY;; 13: len 18; hex 616e792d657175616c2d6e6f742d73616d65; asc any-equal-not-same;; 14: len 30; hex 0002004d001200040016000500001b000249006f6464736974656d730200; asc M I oddsitems ; (total 78 bytes); 15: len 1; hex 02; asc ;; 16: len 12; hex 800000000000000027100000; asc \u0026#39; ;; 17: len 12; hex 800000000000000026480000; asc \u0026amp;H ;; 18: len 12; hex 800000000000000000000000; asc ;; 19: len 4; hex 5d1b32ff; asc ] 2 ;; 20: len 4; hex 5f72ac45; asc _r E;; 21: len 0; hex ; asc ;; *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 139 page no 4 n bits 72 index ID_report of table `test_g_order`.`g_order` trx id 12799 lock_mode X locks rec but not gap waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 6; compact format; info bits 0 0: len 1; hex 01; asc ;; 1: len 5; hex 3530306370; asc 500cp;; 2: len 30; hex 35656137636538392d373365332d343565372d393932342d636631383836; asc 5ea7ce89-73e3-45e7-9924-cf1886; (total 36 bytes); 3: len 4; hex 5d1b32f8; asc ] 2 ;; 4: len 8; hex 0000a40000001cdb; asc ;; 5: len 4; hex 5d1b3318; asc ] 3 ;; *** WE ROLL BACK TRANSACTION (1) å–®ç¨æ¸¬è©¦ æŸ¥çœ‹å…©å¥èªæ³•å–®ç¨åŸ·è¡Œçš„ LOCK ç‹€æ³\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 -- Transaction 1 SET GLOBAL innodb_status_output_locks=ON; begin; UPDATE test_g_order.g_order force index(ID_report) SET status = 3, pay = bet * 10 WHERE round_closed_at = \u0026#39;2019-07-02 10:30:00\u0026#39; AND round_id = 1 AND game_id = \u0026#39;game_1\u0026#39; AND wager = \u0026#39;compare\u0026#39; AND status = 1 AND odds_key IN (\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;); show engine innodb status\\G ------------ TRANSACTIONS ------------ Trx id counter 5901 Purge done for trx\u0026#39;s n:o \u0026lt; 5900 undo n:o \u0026lt; 0 state: running but idle History list length 0 LIST OF TRANSACTIONS FOR EACH SESSION: ---TRANSACTION 421338064415296, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 421338064414440, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 5900, ACTIVE 6 sec 3 lock struct(s), heap size 1136, 7 row lock(s) MySQL thread id 20189, OS thread handle 139863067211520, query id 44318 localhost root starting show engine innodb status **# ç¬¬ä¸€æ­¥é©Ÿæ˜¯åœ¨æ•´å€‹TABLEä¸ŠåŠ ä¸Š IXé– (æ„å‘æ’ä»–é–)ï¼Œä¾†é é˜²å…¶ä»–thirdå°æ•´å€‹TABLEåŠ Sé–æˆ–Xé–** TABLE LOCK table `test_g_order`.`g_order` trx id 5900 lock mode IX **# ç¬¬äºŒæ­¥å› ç‚ºé€éindex ID_report ä¾†æ‰¾ç¬¦åˆçš„rowï¼Œå› æ­¤åœ¨ç¬¦åˆçš„INDEXåŠ ä¸Š Xé–(next-key lock)** RECORD LOCKS space id 4 page no 5 n bits 72 index ID_report of table `test_g_order`.`g_order` trx id 5900 lock_mode **# å› ç‚ºç›®å‰ ID_report æ‰€æœ‰çš„å€¼éƒ½ç¬¦åˆæ¢ä»¶ï¼Œæ‰€ä»¥ä¹Ÿåœ¨æ­£ç„¡çª®ä¸ŠåŠ  nexk-key lock** Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc supremum;; ... **# ç¬¬ä¸‰æ­¥ä¾¿æ˜¯é€éINDEXæ‰¾åˆ°Primay keyä¸¦åœ¨å…¶ä¸ŠåŠ ä¸ŠXé– (Record lock)** RECORD LOCKS space id 4 page no 4 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 5900 lock_mode X locks rec but not gap ... **# å› ç‚ºç¬¬ä¸€æ­¥é©Ÿå·²ç¶“åœ¨æ­£ç„¡çª®åŠ ä¸Š next-key lockï¼Œæ‰€ä»¥ä¸éœ€è¦è£œä¸Š gap lock** SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+---------------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+---------------+-------------+ | 5950 | g_order | NULL | TABLE | IX | GRANTED | | 5950 | g_order | ID_report | RECORD | X | GRANTED | | 5950 | g_order | PRIMARY | RECORD | X,REC_NOT_GAP | GRANTED | +------+-------------+------------+-----------+---------------+-------------+ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 -- Transaction 2 -- é–‹å•Ÿmoniterï¼Œè§€å¯Ÿlockæƒ…å½¢ SET GLOBAL innodb_status_output_locks=ON; begin; UPDATE test_g_order.g_order force index(ID_settle) SET status = 3, pay = 0 WHERE round_closed_at = \u0026#39;2019-07-02 10:30:00\u0026#39; AND round_id = 1 AND game_id = \u0026#39;game_1\u0026#39; AND wager = \u0026#39;any\u0026#39; AND status = 1; show engine innodb status\\G ------------ TRANSACTIONS ------------ Trx id counter 5899 Purge done for trx\u0026#39;s n:o \u0026lt; 5899 undo n:o \u0026lt; 0 state: running but idle History list length 2 LIST OF TRANSACTIONS FOR EACH SESSION: ---TRANSACTION 421338064415296, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 421338064414440, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 5894, ACTIVE 10 sec 4 lock struct(s), heap size 1136, 5 row lock(s), undo log entries 2 MySQL thread id 20189, OS thread handle 139863067211520, query id 44245 localhost root starting show engine innodb status **# ç¬¬ä¸€æ­¥é©Ÿæ˜¯åœ¨æ•´å€‹TABLEä¸ŠåŠ ä¸Š IXé– (æ„å‘æ’ä»–é–)ï¼Œä¾†é é˜²å…¶ä»–thirdå°æ•´å€‹TABLEåŠ Sé–æˆ–Xé–** TABLE LOCK table `test_g_order`.`g_order` trx id 5894 lock mode IX **# ç¬¬äºŒæ­¥å› ç‚ºé€éindex ID_settle ä¾†æ‰¾ç¬¦åˆçš„rowï¼Œå› æ­¤åœ¨ç¬¦åˆçš„INDEXåŠ ä¸Š Xé–(next-key lock)** RECORD LOCKS space id 4 page no 6 n bits 72 index ID_settle of table `test_g_order`.`g_order` trx id 5894 lock_mode X **# ç¬¬ä¸‰æ­¥ä¾¿æ˜¯é€éINDEXæ‰¾åˆ°Primay keyä¸¦åœ¨å…¶ä¸ŠåŠ ä¸ŠXé– (Record lock)** RECORD LOCKS space id 4 page no 4 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 5894 lock_mode X locks rec but not gap **# ç¬¬å››æ­¥ï¼šéœ€è¦åœ¨ç¬¬ä¸€å€‹ä¸ç¬¦åˆæ¢ä»¶çš„Index ID_settle åŠ ä¸ŠXé– (gap lock)ï¼Œé¿å…INSERTæ–°çš„è³‡æ–™** RECORD LOCKS space id 4 page no 6 n bits 72 index ID_settle of table `test_g_order`.`g_order` trx id 5894 lock_mode X locks gap before re SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+---------------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+---------------+-------------+ | 5943 | g_order | NULL | TABLE | IX | GRANTED | | 5943 | g_order | ID_settle | RECORD | X | GRANTED | | 5943 | g_order | PRIMARY | RECORD | X,REC_NOT_GAP | GRANTED | | 5943 | g_order | ID_settle | RECORD | X,GAP | GRANTED | +------+-------------+------------+-----------+---------------+-------------+ å…ˆåŸ·è¡Œ Transaction 1 å†åŸ·è¡Œ Transaction 2\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 ------------ TRANSACTIONS ------------ Trx id counter 11644 Purge done for trx\u0026#39;s n:o \u0026lt; 11642 undo n:o \u0026lt; 0 state: running but idle History list length 3 LIST OF TRANSACTIONS FOR EACH SESSION: ---TRANSACTION 421338064415296, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 421338064414440, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 11643, ACTIVE 6 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s) MySQL thread id 141084, OS thread handle 139863066326784, query id 287362 10.17.117.203 root Searching rows for update UPDATE test_g_order.g_order force index(ID_settle) SET status = 3, pay = 0 WHERE round_closed_at = \u0026#39;2019-07-02 10:30:00\u0026#39; AND round_id = 1 AND game_id = \u0026#39;game_1\u0026#39; AND wager = \u0026#39;any\u0026#39; AND status = 1 ------- TRX HAS BEEN WAITING 6 SEC FOR THIS LOCK TO BE GRANTED: **# Transaction 2 ç­‰å¾… Transaction 1 é‡‹æ”¾ PRIMARY KEY ä¸Šçš„ LOCK** RECORD LOCKS space id 216 page no 4 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 11643 lock_mode X locks rec but not gap waiting **# Transaction 2** ------------------ **# ç¬¬ä¸€æ­¥é©Ÿæ˜¯åœ¨æ•´å€‹TABLEä¸ŠåŠ ä¸Š IXé– (æ„å‘æ’ä»–é–)ï¼Œä¾†é é˜²å…¶ä»–thirdå°æ•´å€‹TABLEåŠ Sé–æˆ–Xé–** TABLE LOCK table `test_g_order`.`g_order` trx id 11643 lock mode IX **# ç¬¬äºŒæ­¥å› ç‚ºé€éindex ID_settle ä¾†æ‰¾ç¬¦åˆçš„rowï¼Œå› æ­¤åœ¨ç¬¦åˆçš„INDEXåŠ ä¸Š Xé–(next-key åŒ…å«äº†gap)** RECORD LOCKS space id 216 page no 6 n bits 72 index ID_settle of table `test_g_order`.`g_order` trx id 11643 lock_mode X **# ç¬¬ä¸‰æ­¥ä¾¿æ˜¯é€éINDEXæ‰¾åˆ°Primay keyä¸¦åœ¨å…¶ä¸ŠåŠ ä¸ŠXé– (Record lockä¸å«gap)** RECORD LOCKS space id 216 page no 4 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 11643 lock_mode X locks rec but not gap waiting **# Transaction 1** ---TRANSACTION 11642, ACTIVE 7 sec 3 lock struct(s), heap size 1136, 7 row lock(s) MySQL thread id 141082, OS thread handle 139863067801344, query id 287365 10.17.117.203 root starting show engine innodb status **# ç¬¬ä¸€æ­¥é©Ÿæ˜¯åœ¨æ•´å€‹TABLEä¸ŠåŠ ä¸Š IXé– (æ„å‘æ’ä»–é–)ï¼Œä¾†é é˜²å…¶ä»–thirdå°æ•´å€‹TABLEåŠ Sé–æˆ–Xé–** TABLE LOCK table `test_g_order`.`g_order` trx id 11642 lock mode IX **# ç¬¬äºŒæ­¥å› ç‚ºé€éindex ID_report ä¾†æ‰¾ç¬¦åˆçš„rowï¼Œå› æ­¤åœ¨ç¬¦åˆçš„INDEXåŠ ä¸Š Xé–(next-key åŒ…å«äº†gap)** RECORD LOCKS space id 216 page no 5 n bits 72 index ID_report of table `test_g_order`.`g_order` trx id 11642 lock_mode X **# å› ç‚ºç›®å‰ ID_report æ‰€æœ‰çš„å€¼éƒ½ç¬¦åˆæ¢ä»¶ï¼Œæ‰€ä»¥ä¹Ÿåœ¨æ­£ç„¡çª®ä¸ŠåŠ  nexk-key lock** Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc supremum;; **# ç¬¬ä¸‰æ­¥ä¾¿æ˜¯é€éINDEXæ‰¾åˆ°Primay keyä¸¦åœ¨å…¶ä¸ŠåŠ ä¸ŠXé– (Record lockä¸å«gap)** RECORD LOCKS space id 216 page no 4 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 11642 lock_mode X locks rec but not gap SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +-------+-------------+------------+-----------+---------------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +-------+-------------+------------+-----------+---------------+-------------+ | 11642 | g_order | NULL | TABLE | IX | GRANTED | | 11642 | g_order | ID_report | RECORD | X | GRANTED | | 11642 | g_order | PRIMARY | RECORD | X,REC_NOT_GAP | GRANTED | | 11643 | g_order | NULL | TABLE | IX | GRANTED | | 11643 | g_order | ID_settle | RECORD | X | GRANTED | | 11643 | g_order | PRIMARY | RECORD | X,REC_NOT_GAP | WAITING | +-------+-------------+------------+-----------+---------------+-------------+ å…ˆåŸ·è¡Œ Transaction 2 å†åŸ·è¡Œ Transaction 1ï¼Œå¯ä»¥ç™¼ç¾ Transaction 2 å¤šäº†ä¸€å€‹ LOCK\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 ------------ TRANSACTIONS ------------ Trx id counter 5957 Purge done for trx\u0026#39;s n:o \u0026lt; 5956 undo n:o \u0026lt; 0 state: running but idle History list length 2 LIST OF TRANSACTIONS FOR EACH SESSION: ---TRANSACTION 421338064415296, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 421338064414440, not started 0 lock struct(s), heap size 1136, 0 row lock(s) ---TRANSACTION 5956, ACTIVE 12 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s) MySQL thread id 25903, OS thread handle 139863067506432, query id 56073 localhost root Searching rows for update UPDATE test_g_order.g_order force index(ID_settle) SET status = 3, pay = bet * 10 WHERE round_closed_at = \u0026#39;2019-07-02 10:30:00\u0026#39; AND round_id = 1 AND game_id = \u0026#39;game_1\u0026#39; AND wager = \u0026#39;compare\u0026#39; AND status = 1 AND odds_key IN (\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;) ------- TRX HAS BEEN WAITING 12 SEC FOR THIS LOCK TO BE GRANTED: **# Transaction 1 ç­‰å¾… Transaction 2 é‡‹æ”¾ ID_report Index ä¸Šçš„ LOCK** RECORD LOCKS space id 4 page no 5 n bits 72 index ID_report of table `test_g_order`.`g_order` trx id 5956 lock_mode X waiting **# Transaction 1** ------------------ **# ç¬¬ä¸€æ­¥é©Ÿæ˜¯åœ¨æ•´å€‹TABLEä¸ŠåŠ ä¸Š IXé– (æ„å‘æ’ä»–é–)ï¼Œä¾†é é˜²å…¶ä»–thirdå°æ•´å€‹TABLEåŠ Sé–æˆ–Xé–** TABLE LOCK table `test_g_order`.`g_order` trx id 5956 lock mode IX **# ç¬¬äºŒæ­¥å› ç‚ºé€éindex ID_report ä¾†æ‰¾ç¬¦åˆçš„rowï¼Œå› æ­¤åœ¨ç¬¦åˆçš„INDEXåŠ ä¸Š Xé–(next-key åŒ…å«äº†gap)** RECORD LOCKS space id 4 page no 5 n bits 72 index ID_report of table `test_g_order`.`g_order` trx id 5956 lock_mode X waiting **# Transaction 2** ---TRANSACTION 5951, ACTIVE 18 sec 5 lock struct(s), heap size 1136, 6 row lock(s), undo log entries 2 MySQL thread id 25899, OS thread handle 139863067211520, query id 56077 localhost root starting show engine innodb status **# ç¬¬ä¸€æ­¥é©Ÿæ˜¯åœ¨æ•´å€‹TABLEä¸ŠåŠ ä¸Š IXé– (æ„å‘æ’ä»–é–)ï¼Œä¾†é é˜²å…¶ä»–thirdå°æ•´å€‹TABLEåŠ Sé–æˆ–Xé–** TABLE LOCK table `test_g_order`.`g_order` trx id 5951 lock mode IX **# ç¬¬äºŒæ­¥å› ç‚ºé€éindex ID_settle ä¾†æ‰¾ç¬¦åˆçš„rowï¼Œå› æ­¤åœ¨ç¬¦åˆçš„INDEXåŠ ä¸Š Xé–(next-key åŒ…å«äº†gap)** RECORD LOCKS space id 4 page no 6 n bits 72 index ID_settle of table `test_g_order`.`g_order` trx id 5951 lock_mode X **# ç¬¬ä¸‰æ­¥ä¾¿æ˜¯é€éINDEXæ‰¾åˆ°Primay keyä¸¦åœ¨å…¶ä¸ŠåŠ ä¸ŠXé– (Record lockä¸å«gap)** RECORD LOCKS space id 4 page no 4 n bits 72 index PRIMARY of table `test_g_order`.`g_order` trx id 5951 lock_mode X locks rec but not gap **# ç¬¬å››æ­¥Index ID_settle åŠ ä¸ŠXé– (Gap Lock)** RECORD LOCKS space id 4 page no 6 n bits 72 index ID_settle of table `test_g_order`.`g_order` trx id 5951 lock_mode X locks gap before rec **# ç¬¬äº”æ­¥Index ID_report åŠ ä¸ŠXé– (Record lockä¸å«gap)** RECORD LOCKS space id 4 page no 5 n bits 72 index ID_report of table `test_g_order`.`g_order` trx id 5951 lock_mode X locks rec but not gap SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+---------------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+---------------+-------------+ | 5956 | g_order | NULL | TABLE | IX | GRANTED | | 5956 | g_order | ID_report | RECORD | X | WAITING | | 5951 | g_order | NULL | TABLE | IX | GRANTED | | 5951 | g_order | ID_settle | RECORD | X | GRANTED | | 5951 | g_order | PRIMARY | RECORD | X,REC_NOT_GAP | GRANTED | | 5951 | g_order | ID_settle | RECORD | X,GAP | GRANTED | | 5951 | g_order | ID_report | RECORD | X,REC_NOT_GAP | GRANTED | +------+-------------+------------+-----------+---------------+-------------+ ç¶“ç”±ä»¥ä¸Šæ¸¬è©¦ï¼Œæˆ‘å€‘ç¢ºèªäº†æ­¤ä¾‹çš„ Lock çš„æˆå› å¦‚ä¸‹è¡¨æ ¼ï¼\nTransaction 1 Transaction 2 Lock IX(TABLE) Lock IX(TABLE) Lock ID_report(Next-Key) Lock ID_settle(Next-Key) Lock primary key(Record) Lock ID_settle(Gap) Waiting Lock PK(Record) Waiting Lock convert impli to expli ID_report(Record) DEADLOCK DEADLOCK åœ¨åˆ†æå€‹éç¨‹ä¸­ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°ç•¶å„ªå…ˆåŸ·è¡Œ Transaction 2æ™‚ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°æœ€å¾Œä¸€å€‹ wating Lock ID_report (no gap) æ˜¯ä¸å­˜åœ¨çš„ï¼Œç›´åˆ°æˆ‘å€‘åŸ·è¡Œ Transaction 1æ™‚ï¼Œé€™ä¸€å€‹ LOCKæ‰æœƒå‡ºç¾ï¼Œé€™å°±æ˜¯ éš±å¼é–(implicit lock) ã€‚\nä»€éº¼æ˜¯éš±å¼é–? åœ¨ MySQLå®˜æ–¹æ–‡æª” ä¸­é—œæ–¼éš±å¼é–å°±åªæœ‰é€™éº¼ä¸€æ¢èªªæ˜ï¼\nWhen UPDATE modifies a clustered index record, implicit locks are taken on affected secondary index records.\nè³‡è¨Šé‡å¯¦åœ¨ä¸æ˜¯å¾ˆè¶³å¤ ï¼Œå†åŠ ä¸Šè¨è«–åˆ°çš„æ–‡ç« å…¶å¯¦ä¸æ˜¯å¾ˆå¤šï¼Œå› æ­¤åªå¥½æ­é…å°‘é‡çš„æ–‡ç« æ­é…æºç¢¼ä¾†äº†è§£ï¼Œä¸‹æ–¹å‡ºç¾çš„æºç¢¼å–è‡ª 8.0 ç‰ˆæœ¬ï¼Œä¸¦åŠ ä¸Šä¸€äº›å€‹äººåŠ ä¸Šçš„è¨»è§£æ–¹ä¾¿ç†è§£ã€‚\nå»¶é²åŠ é–æ©Ÿåˆ¶ è®“æˆ‘å€‘è©¦æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸€å¼µè¡¨ä¸Šé¢æœ‰å¤šå€‹ç´¢å¼•ï¼Œé€™æ¨£åœ¨ç•°å‹•å…¶ä¸­ä¸€ç­†è³‡æ–™çš„æ™‚å€™ï¼Œè±ˆä¸æ˜¯è¦åœ¨å¥½å¹¾å€‹ B+Tree ä¸ŠåŒæ™‚åŠ é–å— ?\nåŠ é–ä¹Ÿæ˜¯ä¸€ç­†é–‹éŠ·ï¼Œå¦‚æœè¡çªçš„å¯èƒ½æ€§å¾ˆå°çš„æ™‚å€™ï¼Œå¤šæ•¸çš„é–æ‡‰è©²éƒ½æ˜¯ä¸å¿…è¦çš„ã€‚\nInnodb å¯¦ç¾äº†ä¸€å€‹å»¶é²åŠ é–æ©Ÿåˆ¶ï¼Œä»¥æ­¤ä¾†æ¸›å°‘åŠ é–çš„æ•¸é‡ï¼Œæ¸›å°‘æ•ˆèƒ½æè€—çš„åŒæ™‚ä¹Ÿæå‡ä½µç™¼æ€§èƒ½ã€‚\néš±å¼é–çš„ç°¡ä»‹ Innodb å¯¦ç¾çš„å»¶é²åŠ é–çš„æ©Ÿåˆ¶ï¼Œåœ¨æºç¢¼ä¸­è¢«ç¨±ç‚º**éš±å¼é–(implicit lock)**\néš±å¼é–æ²’æœ‰å¯¦éš›åŠ é–ï¼Œè€Œæ˜¯ä¸€ç¨® logical entityï¼Œtransaction æ˜¯å¦æŒæœ‰æ˜¯é€éä¸€äº›éç¨‹ä¾†è¨ˆç®—çš„ã€‚\néš±å¼é–ä¸­æœ‰ä¸€å€‹é‡è¦çš„å…ƒç´ ï¼š db_trx_idï¼ç”¨ä¾†å„²å­˜ç”¢ç”Ÿè©²ç­†ç´€éŒ„çš„ transaction IDï¼Œé€™æ˜¯åœ¨ MVCC ä¸­å¯¦ç¾ å¿«ç…§è®€ ä¹Ÿæœ‰ä½¿ç”¨åˆ°çš„å…ƒç´ ã€‚\néš±å¼é–çš„ç‰¹é» åªæœ‰åœ¨å¾ˆå¯èƒ½ç™¼ç”Ÿè¡çªæ™‚æ‰åŠ é–ï¼Œæ¸›å°‘é–çš„æ•¸é‡ éš±å¼é–å¼é‡å° B+Tree ä¸Šè¢«ä¿®æ”¹çš„ç´€éŒ„ï¼Œå› æ­¤éƒ½æ˜¯ record lockï¼Œä¸å¯èƒ½æ˜¯ gap lock æˆ– next-key lock å’Œé¡¯å¼é–çš„å€åˆ¥ï¼š é¡¯å¼é– (explicit lock) éš±å¼é– (implicit lock) å¯¦éš›åŠ é– é‚è¼¯åŠ é– ä½”ç”¨å…§å­˜ ä¸ä½”ç”¨å…§å­˜ éš±å¼é–çš„ä½¿ç”¨ INSERT æ“ä½œä¸€èˆ¬åªæœƒåŠ éš±å¼é–ï¼Œä¸åŠ é¡¯ç¤ºé–ã€‚é™¤äº†ä»¥ä¸‹æƒ…æ³ï¼š\nè‹¥ INSERT çš„ä½ç½®æœ‰ gap lock æ™‚ï¼Œå‰‡æœƒåŠ ä¸Š insert intention lockã€‚ è‹¥ INSERT çš„ä½ç½®ç™¼ç”Ÿå”¯ä¸€éµè¡çªæ™‚ï¼Œå‰‡æœƒå°‡å°æ–¹çš„éš±å¼é–å‡ç´šç‚ºé¡¯ç¤ºé–ï¼Œè‡ªå·±å‰‡åŠ ä¸Š shared lock ç­‰å¾…ã€‚ UPDATE å’Œ DELETE æ“ä½œåœ¨æŸ¥è©¢æ™‚ï¼Œæœƒç›´æ¥å°æŸ¥è©¢èµ°çš„ index å’Œ primary key ä½¿ç”¨é¡¯ç¤ºé–ï¼Œå…¶ä»–çš„ index ä½¿ç”¨éš±å¼é–ã€‚\néš±å¼é–çš„å…·é«”éç¨‹ å¦‚æœ transaction è¦ç²å–è¡Œé– (ä¸è«–æ˜¯é¡¯å¼æˆ–éš±å¼)ï¼Œå‰‡éœ€è¦å…ˆåˆ¤æ–·æ˜¯å¦å­˜åœ¨æ´»èºçš„éš±å¼é– cluster indexï¼šé¦–å…ˆå–å¾—åœ¨è©²ç´€éŒ„ä¸ŠæŒæœ‰éš±å¼é–çš„ transaction idï¼Œéš¨å¾Œé€é cluster index ä¸­çš„éš±è—æ¬„ä½ db_trx_id åˆ¤æ–·å‰è€…æ˜¯å¦ç‚ºæ´»èºäº‹å‹™ã€‚\nsecondary indexï¼š å¾ secondary index page ä¸­å–å¾— PAGE_MAX_TRX_ID (T1)\nPAGE_MAX_TRX_IDï¼šè©²å­—æ®µå­˜åœ¨æ–¼ secondary index page ä¸­ï¼Œç”¨æ–¼ä¿å­˜ä¿®æ”¹è©² page çš„æœ€å¤§ Transaction IDï¼Œç•¶è©² page çš„ä»»ä½•ç´€éŒ„è¢«æ›´æ–°å¾Œï¼Œéƒ½æœƒæ›´æ–°æ­¤å€¼ã€‚\nå–å¾— InnoDB æ´»èºä¸­äº‹å‹™ä¸­ æœ€å°çš„ Transaction ID (T2)\nå‡å¦‚ T1 \u0026lt; T2 å‰‡èªªæ˜ä¿®æ”¹é€™å€‹ page çš„ T1 å·²ç¶“ commit ï¼Œå› æ­¤ä¸å­˜åœ¨éš±å¼é–ã€‚\nåä¹‹ï¼Œå‰‡å¿…é ˆå†é€é cluster index æ­é… undo log å›æº¯èˆŠç‰ˆæœ¬æ•¸æ“šé€²è¡Œåˆ¤æ–·ï¼Œæ­¤æ­¥é©Ÿè¼ƒç‚ºè¤‡é›œæš«ä¸è©³è§£ (å¯é€é storage\\innobase\\row\\row0vers.cc ä¸­ row_vers_impl_x_locked å’Œ row_vers_impl_x_locked_low äº†è§£è©³ç´°éç¨‹)\nè‹¥ç‚ºæ´»èºäº‹å‹™ï¼Œå‰‡ç‚ºè©²æ´»èºäº‹å‹™å°‡ implicit lock è½‰æ›ç‚º explicit lock\nå¦å¤–å¯å·²æ³¨æ„åˆ° implicit lock è½‰æ›å¾Œçš„ explicit lock ä¸æœƒæœ‰ gap lock\nç­‰å¾…åŠ é–æˆåŠŸå¾Œä¿®æ”¹æ•¸æ“šï¼Œä¸¦ä¸”å°‡è‡ªå·±çš„ Transaction id å¯«å…¥ db_trx_idï¼›æˆ–è€…æ˜¯ timeoutã€‚\nåƒè€ƒ Introduction to Transaction Locks in InnoDB Storage Engine (from oracle blog) - plant MySQL å‚™ä»½\nIntroduction to Transaction Locks in InnoDB Storage Engine (from oracle blog) - CSDN å‚™ä»½\npercona live - mysql conference 2015 - Understanding InnoDB locks and deadlocks (page 44)\nUnderstanding-InnoDB-locks-and-deadlocks.pdf\nM18 Deep Dive InnoDB Transactions and Write Paths\nDeep-Dive_-InnoDB-Transactions-and-Write-Paths.pdf\nMySQLæ•°æ®åº“InnoDBå­˜å‚¨å¼•æ“ä¸­çš„é”æœºåˆ¶\nMySQLåŠ é”åˆ†æ\nInnoDB Transaction Lock and MVCC - ä½•ç™»æˆ (page 31)\nInnoDB Transaction Lock and MVCC.pdf\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB äº‹åŠ¡å­ç³»ç»Ÿä»‹ç» (æ•¸æ“šåº«å…§æ ¸æœˆå ± - 2015/12)\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB äº‹åŠ¡é”ç³»ç»Ÿç®€ä»‹ (æ•¸æ“šåº«å…§æ ¸æœˆå ± - 2016/01)\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDBéšå¼é”åŠŸèƒ½è§£æ (æ•¸æ“šåº«å…§æ ¸æœˆå ± - 2020/09)\nMySQLé”ç³»åˆ—ï¼ˆä¸€ï¼‰ä¹‹é”çš„ç§ç±»å’Œ\ninnodBçš„éšå¼é”\n","date":"2025-04-01T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-implicit-lock/","title":"éš±å¼é–"},{"content":"åœ¨ç ”ç©¶ MySQL MTS æ™‚äº†è§£åˆ° MySQL æœ‰ Group Commit æ©Ÿåˆ¶ï¼Œå› æ­¤é€²è¡Œæ·±å…¥äº†è§£ã€‚\næœ¬æ–‡ä»¥ä¸‹å…§å®¹éƒ½åŸºæ–¼ sync_binlog = 1 \u0026amp; innodb_flush_log_at_trx_commit = 1 çš„æƒ…å¢ƒã€‚\nå‰ç½®çŸ¥è­˜ InnoDB Group Commit InnoDB å‡ºæ–¼æ€§èƒ½è€ƒé‡ä½¿ç”¨äº† WAL (write-ahead logging) æŠ€è¡“ï¼šå°‡æ›´æ–°æ“ä½œä¿®æ”¹å…§å­˜ä¸­çš„æ•¸æ“šä¿®æ”¹å¾Œï¼Œå…ˆå¯« log (InnoDB redo log) å°±å¯ä»¥è¿”å›å‘Šè¨´ client ç«¯ transaction å·²ç¶“å®Œæˆ commitï¼Œ å¾ŒçºŒå†æ…¢æ…¢å°‡ dirty page å¯«å…¥ Disk æŒä¹…åŒ–æ•¸æ“šä¿®æ”¹å¾Œçš„çµæœã€‚\né€™æ¨£é™¤äº†å¯ä»¥é€é redo log é”åˆ°åŸå­æ€§ (atomicity) å’ŒæŒä¹…æ€§ (durability) çš„åŒæ™‚ä¹Ÿèƒ½å¢åŠ æ•ˆç‡ï¼Œå› ç‚ºå¯« Log æ˜¯é †åºå¯«å…¥ç›¸è¼ƒæ–¼ä¿®æ”¹æ•¸æ“šçš„éš¨æ©Ÿå¯«å…¥å¿«ä¸Šè¨±å¤šã€‚\né›–ç„¶ WAL æŠ€è¡“ä¸‹é †åºå¯«å…¥çš„ redo log æ¯”éš¨æ©Ÿå¯«å…¥å¿«ï¼Œä½†æ˜¯æ¯æ¬¡ Transaction commit ä¹‹å‰æˆ‘å€‘é‚„æ˜¯å¿…é ˆèª¿ç”¨ fsync() å°‡ redo log æŒä¹…åŒ–åˆ° Diskï¼Œç„¶è€Œ fsync() æ˜¯æ˜‚è²´çš„æ“ä½œ (æ¶ˆè€—è¼ƒå¤š IO è³‡æºï¼Œä¸¦ä¸”éŸ¿æ‡‰è¼ƒæ…¢)ï¼Œå› æ­¤æ—©åœ¨ MySQL 5.0 ä¹‹å‰ï¼Œå°±åœ¨ InnoDB redo log ä¸Šå¯¦ç¾äº† Group Commit å„ªåŒ–ï¼šå°‡å¤šå€‹ Transaction æ”¾å…¥å°åˆ—å¾Œä¸€èµ· commitï¼Œæ¸›å°‘ fsync() çš„æ¬¡æ•¸ã€‚\nBinlog/Engine 2PC åœ¨å¤§éƒ¨åˆ†çš„æƒ…å¢ƒä¸‹ï¼Œç‚ºäº†å¯¦ç¾ replication å’ŒåŸºæ–¼æ™‚é–“é»çš„æ¢å¾©ï¼Œä¸€èˆ¬ MySQL å¯¦ä¾‹éƒ½æœƒé–‹å•Ÿ binlog ä¾†é”æˆç›¸æ‡‰çš„ç›®çš„ï¼Œé€™å€‹æ™‚å€™ç‚ºäº†ä¿è­‰ Transaction åœ¨ server å±¤ Log (Binlog) å’Œ engine å±¤ Log (ä¾‹å¦‚ï¼šInnoDB çš„ Redolog) ä¹‹é–“çš„åŸå­æ€§ (Atomicity)ï¼Œå› æ­¤éœ€è¦é€éå…©éšæ®µæäº¤ (Two-Phase-Commit, 2PC) ä¾†ç¢ºä¿ï¼ŒMySQL é€éå…§éƒ¨ XA Transaction ä¾†å¯¦ç¾ 2PCï¼š\nåœ¨ä¸Šè¿°éç¨‹ä¸‹ MySQL ç¢ºä¿äº† transaction åœ¨ redo log å’Œ binlog ä¹‹é–“çš„åŸå­æ€§ (Atomicity)ã€‚\nç‚ºä»€éº¼é€™æ¨£èƒ½ç¢ºä¿ redo log å’Œ binlog ä¹‹é–“çš„åŸå­æ€§ (Atomicity) å‘¢ï¼Ÿ\nMySQL crash recovery çš„æµç¨‹ï¼š\næƒææœ€å¾Œä¸€å€‹ binlog æ–‡ä»¶ï¼Œæå–å…¶ä¸­çš„ XID\nå‚™è¨»ï¼šåªéœ€è¦æƒææœ€å¾Œä¸€å€‹ binlog æ˜¯å› ç‚º MySQL åœ¨ rotate åˆ°æ–°çš„ binlog æ–‡ä»¶æ™‚ï¼Œç¸½æ˜¯ä¿è­‰æ²’æœ‰æ­£åœ¨ commit çš„ Transaction ä¹‹å¾Œï¼Œæœƒèª¿ç”¨ fsync() æŒä¹…åŒ– redo logï¼Œä¾†ä¿è­‰èˆŠçš„ binlog è£¡çš„æ‰€æœ‰ Transaction éƒ½åœ¨ redo log ä¸­ commitã€‚\nå°‡ redo log ä¸­é‚„åœ¨ prepare çš„ Transaction çš„ XID å’Œ binlog æ¯”å°ï¼š\nå¦‚æœå·²ç¶“åœ¨ binlogï¼Œå‰‡ commit trnsactionã€‚ å¦‚æœä¸åœ¨ binlogï¼Œå‰‡ rollback transactionã€‚ ç”±ä¸Šè¿°æ­¥é©Ÿæˆ‘å€‘å¯ä»¥çŸ¥é“ç•¶ MySQL Crash å¾Œï¼Œé€é Crash Recovery å¯ä»¥ä¿è­‰ Transaction åœ¨ redo log å’Œ binlog çš„ commit ç‹€æ…‹æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±é”åˆ° redo log å’Œ binlog ä¹‹é–“çš„åŸå­æ€§ (Atomicity)ã€‚\nMySQL 5.5(å«)ä¹‹å‰ InnoDB Group Commit Bug åœ¨ MySQL 5.5 (å«)ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œç•¶ Binlog é–‹å•Ÿæ™‚æœƒå°è‡´ InnoDB Group Commit å¤±æ•ˆï¼Œé€™å°è‡´äº†æ•ˆèƒ½çš„æ€¥é½ä¸‹é™ï¼Œå°¤å…¶æ˜¯ç•¶ sync_binlog = 1 \u0026amp; innodb_flush_log_at_trx_commit = 1 çš„æ™‚å€™ç°¡ç›´æ˜¯ç½é›£ã€‚\nåœ¨ MySQL 5.5 çš„æ™‚å€™ 2PC çš„å…·é«”éç¨‹å¦‚ä¸‹ï¼š\nåœ¨ä¸Šè¿°éç¨‹ä¸­ InnoDB Prepare éšæ®µçš„æœ€å¾Œæœƒä¸Šä¸€å€‹ prepare_commit_mutex çš„é–ï¼Œä¸¦åœ¨ InnoDB Commit éšæ®µé‡‹æ”¾ï¼Œç”¨ä¾†ç¢ºä¿åŒä¸€å€‹æ™‚åˆ»åªæœ‰ä¸€å€‹ç·šç¨‹åœ¨è™•ç† Binlog å¯«å…¥å’Œ InnoDB Commitï¼Œä¿è­‰ Transaction åœ¨ Binlog å’Œ Redo Log ä¸­ Commit é †åºæ˜¯ä¸€è‡´çš„ã€‚\nå¯ä»¥ç™¼ç¾æœ‰ä»¥ä¸‹å•é¡Œï¼š\nå› ç‚ºä¸€æ¬¡åªèƒ½æœ‰ä¸€å€‹ Transaction å–å¾— prepare_commit_mutex é€™å€‹é–ï¼Œå°è‡´ç„¡æ³•æ‡‰ç”¨ InnoDB Group Commitï¼Œæ¯ä¸€å€‹ Transaction éƒ½å¿…é ˆå–®ç¨ fsync()ã€‚ ä¸€å€‹ Transaction å°±èª¿ç”¨äº† 3æ¬¡ fsync()ï¼š InnoDB Prepare (å¯« redolog) Binlog Commit (å¯« binlog) InnoDB Commit (å¯« commit) ä¹Ÿå°±æ˜¯èªªåœ¨é–‹å•Ÿé›™ 1 æ™‚ï¼Œæ¯å€‹ Transaction éƒ½å¿…é ˆå–®ç¨ fsync() 3 æ¬¡å°è‡´äº†æ€§èƒ½çš„æ€¥é½ä¸‹é™ï¼Œé€™å°±æ˜¯å¾ˆçŸ¥åçš„ **MySQL Bugs: #13669: Group commit is broken in 5.0** åŒæ™‚ä¹Ÿæœ‰äººæè­°è®“ Binlog ä¹Ÿæ”¯æ´ Group Commitï¼š MySQL Bugs: #49326: Support group commit for the binlogã€‚\nMySQL 5.6 BinLog Group Commit åœ¨ MySQL 5.6 æ™‚ binlog å¯¦ç¾äº† Group Commit æ¸›å°‘äº† binlog çš„ fsync() æ¬¡æ•¸ï¼ŒåŒæ™‚é€éå°‡ commit æ“ä½œæ‹†åˆ†æˆ 3 å€‹éšæ®µ (åŒæ™‚ prepare_commit_mutex å¤§é–ä¹Ÿè¢«æ‹†åˆ†ç‚º 3 å€‹å°é–) ä»¥æ­¤ä¾†ä¸¦è¡ŒåŸ·è¡Œå¢åŠ æ•ˆç‡ã€‚\nMySQL 5.6 çš„æ™‚å€™ 2PC çš„å…·é«”éç¨‹å¦‚ä¸‹ï¼š\nå’Œ MySQL 5.5 ç›¸æ¯”ï¼Œå¯ä»¥çœ‹åˆ° prepare éšæ®µä¿æŒä¸è®Šï¼Œä½†ç§»é™¤äº† prepare_commit_mutex é€™æŠŠå¤§é–ï¼Œä¸¦å°‡ commit éšæ®µæ‹†åˆ†ç‚ºä»¥ä¸‹ä¸‰å€‹éç¨‹ï¼š\nflush éšæ®µï¼šå¯«å…¥ binlog æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯«å…¥ OS Page Cache ä¸å¼·åˆ¶åŸ·è¡Œ fsync() å¯«å…¥ Diskã€‚ sync éšæ®µï¼šå° binlog æ–‡ä»¶åš fsync() æ“ä½œ (ä¹Ÿå°±æ˜¯ binlog group commit)ã€‚ commit éšæ®µï¼šåŸ·è¡Œ InnoDB commit æ“ä½œã€‚ åœ¨æ¯å€‹éšæ®µéƒ½æœ‰ä¸€å€‹å°åˆ—ï¼ŒåŒä¸€å€‹å°åˆ—ä¸­ç¬¬ä¸€å€‹é€²å…¥çš„ Transaction (ç¨±ç‚º Leader) æœƒå¸¶é ˜å¾ŒçºŒé€²å…¥çš„ Transaction (ç¨±ç‚º Follower) åŸ·è¡Œè©²éšæ®µçš„ä»»å‹™ã€‚\nåœ¨åŸ·è¡Œè©²éšæ®µçš„ä»»å‹™æ™‚æœƒæŒæœ‰è©²éšæ®µçš„é–ï¼Œä¿è­‰ä¸€å€‹éšæ®µåªæœ‰ä¸€å€‹å°åˆ—åœ¨å·¥ä½œï¼ŒåŒæ™‚æ¯å€‹å°åˆ—ä¸­çš„ Transaction ä¾æ¬¡åŸ·è¡Œï¼Œé€™ç¢ºä¿äº† Transaction å¯«å…¥çš„é †åºã€‚\nMySQL 5.7 RedoLog Group Commit åœ¨ 5.6 çš„æ™‚å€™é›–ç„¶å¯¦ç¾äº† binlog group commit çš„å„ªåŒ–ï¼Œä½†æ˜¯ InnoDB redo log ä»æ²’æœ‰ã€‚\nåœ¨ MySQL 5.7 çš„æ™‚å€™ 2PC çš„å…·é«”éç¨‹å¦‚ä¸‹ï¼š\nå’Œ MySQL 5.6 ç›¸æ¯”ï¼Œåœ¨ InnoDB Prepare çš„æ™‚å€™ä¸é€²è¡Œ redolog çš„ fsync()ï¼Œè€Œæ˜¯åœ¨ flush éšæ®µå¯« binlog æ–‡ä»¶å‰é€²è¡Œ redolog çš„ write/fsyncï¼Œåœ¨ flush éšæ®µå·²ç¶“æœ‰å°åˆ—äº†ç­‰æ–¼å¯¦ç¾äº† InnoDB Group Commit çš„å‹•ä½œï¼Œå¤§å¹…æ¸›å°‘äº† redolog åŸ·è¡Œçš„ fsync() æ“ä½œã€‚\nå…·é«”å¯ä»¥é€™æ¨£å„ªåŒ–çš„åŸå› éœ€è¦å¾ Crash Recovery çš„é‚è¼¯ä¾†çœ‹ï¼\nå¾ä¸Šè¿° crash recovery çš„æ¢å¾©é‚è¼¯ä¸­æˆ‘å€‘å¯ä»¥çŸ¥é“ï¼Œåªè¦ä¿è­‰ InnoDB Prepare çš„ RedoLog åªè¦åœ¨å¯«å…¥ binlog ä¹‹å‰å®Œæˆ write/fsync å³å¯ï¼Œå› æ­¤ RedoLog çš„ write/fsync å¯ä»¥ç§»åˆ° flush éšæ®µå…§ binlog å¯«å…¥ä¹‹å‰ã€‚\nğŸ’¡ é€™æ˜¯ç”±é˜¿é‡Œå·´å·´è²¢ç»çš„å„ªåŒ–ï¼š[MySQL Bugs: #73202: write/sync redo log before flush thread cache to binlog](https://bugs.mysql.com/bug.php?id=73202) åœ–è§£ Group Commit åƒæ•¸èª¿å„ª æ­¤å¤–é‚„æ–°å¢äº†ä»¥ä¸‹ 2 å€‹åƒæ•¸ç”¨ä¾†æ§åˆ¶ sync éšæ®µç­‰å¾…çš„æ™‚é–“é»ï¼š\nbinlog_group_commit_sync_delay = Nï¼šå°åˆ—ç­‰å¾… N å¾®ç§’å¾Œï¼Œé–‹å§‹ sync binlogã€‚ binlog_group_commit_sync_no_delay_count = Nï¼šç•¶å°åˆ—ä¸­çš„ Transaction é”åˆ° N å€‹å¾Œå°±å¿½ç•¥ binlog_group_commit_sync_delay çš„è¨­å®šé–‹å§‹ sync binlogã€‚ ç•¶ä»¥ä¸Šè¨­å®šè¶Šå¤§æ™‚ï¼Œå°±èƒ½ä¸€æ¬¡ commit æ›´å¤šçš„ transaction ä¹Ÿå°±æ˜¯èª¿ç”¨æ›´å°‘çš„ fsync()ï¼Œä½†åŒæ™‚ client ç«¯ä¹Ÿéœ€å…ˆç­‰å¾…æ‰èƒ½æ”¶åˆ° commit çš„å›è¦†ï¼Œå› æ­¤éœ€è¦è¬¹æ…è©•ä¼°é©åˆçš„å€¼ã€‚\n5.7 åŸºæ–¼ Group Commit çš„ MTS å„ªåŒ– 5.7 é€™å€‹ç‰ˆæœ¬ä¹Ÿå„ªåŒ–äº† MTS çš„å›æ”¾æ•ˆç‡ï¼Œåœ¨ 5.6 æ™‚åªæœ‰ä¸åŒ Database çš„ Transaction æ‰èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼Œåœ¨ 5.7 æ™‚åªè¦åœ¨ Source æ˜¯åŒä¸€å€‹ Group ä¸€èµ· Commit çš„ Transaction å°±èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼Œå¯¦ç¾æ–¹å¼æ˜¯åœ¨ Binlog ä¸­æ·»åŠ ä»¥ä¸‹ 2 å€‹å€¼ï¼š\nsequence_numberï¼šæ¯å€‹ Transaction çš„åºåˆ—è™Ÿï¼Œåœ¨åŒä¸€å€‹ Binlog æ–‡ä»¶ä¸­ä¸æœƒé‡è¤‡ã€‚ last_commitedï¼šç´€éŒ„ binlog group commit æ™‚ leader çš„ sequence_number é€é mysqlbinlog å¯ä»¥çœ‹åˆ° binlog ä¸­æ¯å€‹ Transaction éƒ½æœ‰é€™ 2 å€‹è®Šé‡\nä¹Ÿå°±æ˜¯åªè¦ Transaction åœ¨ Binlog ä¸­çš„ last_committed ç›¸åŒï¼Œé‚£éº¼å°±å¯ä»¥åœ¨ Replica ä¸¦è¡Œå›æ”¾ã€‚\nåƒè€ƒ MySQL Â· æºç åˆ†æ Â· å†…éƒ¨ XA å’Œç»„æäº¤ (taobao.org)\nMySQL Â· æ€§èƒ½ä¼˜åŒ–Â· Group Commitä¼˜åŒ– (taobao.org)\nMySQL Â· ç‰¹æ€§åˆ†æ Â· 8.0 WriteSet å¹¶è¡Œå¤åˆ¶ (taobao.org)\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· ä¸»åº“ binlog æ¦‚è§ˆ (taobao.org)\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB äº‹åŠ¡å­ç³»ç»Ÿä»‹ç» (taobao.org)\nMySQL Â· å¼•æ“ç‰¹æ€§Â· InnoDB undo log æ¼«æ¸¸\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB redo logæ¼«æ¸¸ (taobao.org)\nMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB å´©æºƒæ¢å¤è¿‡ç¨‹ (taobao.org)\né‡‘èçº§è§’åº¦ä¸“ä¸šç†è§£MySQLä¸¤é˜¶æ®µæäº¤\nMySQL/InnoDBå’ŒGroup Commit(1) - Life, Database and Cloud Computing (orczhou.com)\nMySQL5.7 æ ¸å¿ƒæŠ€æœ¯æ­ç§˜ï¼šMySQL Group commit | Focus on MySQL,Focus on Life (keithlan.github.io)\nå›¾è§£MySQL | MySQLç»„æäº¤(group commit) (actionsky.com)\nMySQL Musings: Binary Log Group Commit in MySQL 5.6\nMySQL çš„ crash-safe åŸç†è§£æ - çŸ¥ä¹ (zhihu.com)\nMysql+Innodbæºä»£ç è°ƒè¯•è·Ÿè¸ªåˆ†æ+ä½•ç™»æˆ_IT168æ–‡åº“ - ç™¾åº¦æ–‡åº“ (baidu.com)\nmysql äº‹åŠ¡æäº¤è¿‡ç¨‹ - yuyue2014 - åšå®¢å›­ (cnblogs.com)\nMySQL 5.7ç‰ˆæœ¬XAäº‹åŠ¡è‹¥å¹²bugåˆ†æ - çŸ¥ä¹ (zhihu.com)\næ·±å…¥å‰–æMySQL group commitå®ç° ï¼ˆä¸Šï¼‰-ç¤¾åŒºåšå®¢-ç½‘æ˜“æ•°å¸† (163.com)\næ·±å…¥å‰–æMySQL group commitå®ç°ï¼ˆä¸‹ï¼‰-ç¤¾åŒºåšå®¢-ç½‘æ˜“æ•°å¸† (163.com)\n","date":"2025-03-27T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-group-commit/","title":"Group Commit"},{"content":"GTID çš„å…¨åæ˜¯ Global Transaction identifier, MySQL æœƒç‚ºæ¯ä¸€å€‹ DML/DDL æ“ä½œéƒ½åˆ†é…ä¸€å€‹åœ¨æ•´å€‹ replicaion topology éƒ½å”¯ä¸€çš„ GTIDã€‚\nåœ¨ replication ç’°å¢ƒä¸­ï¼Œmaster å¯ä»¥ç›´æ¥é€é GTID å®šä½ç™¼é€ binlog çµ¦ slave ä¸å†éœ€è¦æŒ‡å®š binlog åç¨±å’Œ postition åœ¨åŒæ­¥ä¸Šæ›´ç‚ºæ–¹ä¾¿ã€‚æ­¤å¤– Slave é‚„æœƒä¿ç•™å¾ Master åŒæ­¥éä¾†çš„ Transaction ç›¸åŒçš„ GTIDï¼Œä¸¦æŒä¹…åŒ–åˆ° mysql.gtid_executedï¼Œæ­é…ä¸Š GTID çš„è‡ªå‹•è·³éåŠŸèƒ½ï¼Œä¿è­‰äº†ç›¸åŒ GTID çš„ Transaction åœ¨åŒä¸€å€‹ instance ä¸­åªæœƒåŸ·è¡Œä¸€æ¬¡ï¼Œæ›´åŠ æœ‰åŠ©æ–¼ Replication çš„ä¸€è‡´æ€§ã€‚\nGTID çµ„æˆ GTID çš„çµ„æˆç‚º source_id:transaction_idï¼Œç¯„ä¾‹ 3E11FA47-71CA-11E1-9E33-C80AA9429562:23\nsource_idï¼šè©² DML/DDL æœ€åŸå§‹åŸ·è¡Œçš„ server å…¶ UUIDã€‚\nåœ¨æºç¢¼ä¸­ç¨±ç‚º sidï¼Œæœƒåœ¨ MySQL å•Ÿå‹•æ™‚å¾ auto.cnf å–å¾—ï¼Œå¦‚æœæ²’æœ‰å‰‡æ ¹æ“šå•Ÿå‹•æ™‚é–“ã€ç·šç¨‹çš„ LWP ID åŠéš¨æ©Ÿå…§å­˜åœ°å€ç”Ÿæˆå¾Œä¸¦è¨˜éŒ„åœ¨ auto.cnf ä¸­ã€‚\næ³¨æ„ï¼šä¹Ÿå°±æ˜¯èªªå¦‚æœåˆªé™¤ç¾æœ‰çš„ auto.cnf æœƒåœ¨ä¸‹æ¬¡å•Ÿå‹•æ™‚ç”¢ç”Ÿä¸€å€‹ä¸åŒçš„ server uuidã€‚\ntransaction_idï¼šåŸå§‹ server ç‚ºè©² DML/DDL æ“ä½œåˆ†é…çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œè©²åºåˆ—è™Ÿæ˜¯é †åºéå¢çš„ã€‚\nåœ¨æºç¢¼ä¸­ç¨±ç‚º gno æœƒåœ¨ Transaction é€²å…¥ Flush éšæ®µä¸­ç”Ÿæˆï¼ŒMySQL å…§éƒ¨ç¶­è­·äº†ä¸€å€‹å…¨å±€è®Šé‡ next_free_gno çš„è¨ˆæ•¸ä¾†ç”Ÿæˆ gnoã€‚\nGTID Life cycle ä»¥ä¸‹ä»¥ MySQL 8.0.17 ä»¥ä¸Šä¾†èªªæ˜\nç•¶ Transaction åœ¨ Master ä¸ŠåŸ·è¡Œæ™‚ï¼Œæœƒåœ¨ commit éç¨‹ä¸­çš„ Flush éšæ®µç”Ÿæˆ GTID ã€‚\nç•¶åˆ†é… GTID ä¹‹å¾Œæœƒå°‡ Transaction å’Œå…¶å°æ‡‰çš„ GTID ä¸€èµ·å¯«å…¥ binlog (å°šæœªé€²å…¥ sync éšæ®µé€²è¡Œ fsync å› æ­¤åªæ˜¯å¯«å…¥ OS cache) åŒæ™‚æ›´æ–° mysql.gtid_executed è¡¨åŠ @@GLOBAL.gtid_executed è®Šé‡ã€‚\nç•¶ sync_binlog â‰  1 æ™‚ï¼Œå°±åœ¨ Flush éšæ®µå°‡ binlog å¯«å…¥ OS cache å¾Œç™¼é€ binlog event çµ¦ slaveã€‚\nç•¶ sync_binlog = 1 æ™‚ï¼Œåœ¨ sync éšæ®µ fsycn åˆ° disk å¾Œæ‰ç™¼é€ binlog event çµ¦ slaveã€‚\nå› æ­¤ç•¶ sync_binlog â‰  1 æ™‚ï¼Œç•¶ Master crash æ™‚å¯èƒ½å°è‡´ Slave é€²åº¦å¤§æ–¼ Masterã€‚\nMaster çš„ dump ç·šç¨‹å°‡ binlog event å‚³é€çµ¦ Slave ä¿å­˜è‡³ relay logã€‚\nè©³ç´°éç¨‹ åœ¨ Slave çš„ IO_Thread å»ºç«‹é€£ç·šæ™‚ï¼Œæœƒå°‡ Retrieved_Gtid_Set å’Œ Executed_Gtid_Setçš„ä¸¦é›† (UNION) åŠè‡ªå·±çš„ server_id ç™¼é€çµ¦ Masterã€‚ Master ç¢ºèªè‡ªå·±çš„ gtid_purged æ˜¯å¦ç‚º Slave ç™¼é€çš„å­é›†ï¼Œä»¥æ­¤ä¾†æª¢æŸ¥ master çš„ binlog å°šæœª purgeã€‚ Master åˆ¤æ–· Slave æœ‰å“ªäº› GTID é‚„æ²’åŸ·è¡Œï¼Œä¸¦ç™¼é€å°æ‡‰çš„ binlog çµ¦ Slaveã€‚ Slave å¾ relay log è®€å– GTIDï¼Œä¸¦å°‡ gtid_next è¨­ç‚ºè©² GTIDï¼Œä¸¦åˆ¤æ–·ä»¥ä¸‹ï¼š\nå¾ @@GLOBAL.gtid_owned ä¸­ç¢ºèªæ²’æœ‰å…¶ä»–ç·šç¨‹æ­£åœ¨ä½¿ç”¨è©² GTIDï¼Œä¿è­‰ä¸€æ¬¡åªæœ‰ä¸€å€‹ç·šç¨‹åœ¨è™•ç†è©² GTIDã€‚ å¾ @@GLOBAL.gtid_executed ä¸­ç¢ºèªè©² GTID æ˜¯å¦å·²ç¶“æ‡‰ç”¨éã€‚ å¦‚æœè©² GTID å°šæœªè¢«è¢«æ‡‰ç”¨ï¼Œå‰‡åœ¨ Slave æ‡‰ç”¨è©² Event ä¸¦ç¶­æŒè©² Event åœ¨ Master ä¸Šçš„ GTIDï¼ŒåŒæ™‚æ›´æ–° mysql.gtid_executed è¡¨åŠ @@GLOBAL.gtid_executed è®Šé‡ã€‚è‹¥æœ‰é–‹å•Ÿ log_slave_update å‰‡ä¹Ÿå¯«å…¥ binlogã€‚\nåœ¨ 8.0.17 (å« 5.7 æ‰€æœ‰ç‰ˆæœ¬) ä¹‹å‰ mysql.gtid_executed ä¸¦ä¸ç¸½æ˜¯åŠæ™‚æ›´æ–°ï¼š\nç•¶ log_bin = OFF æˆ–è€… log_slave_update = OFF æ™‚ï¼Œå‰‡ transaction å’Œ mysql.gtid_executed æœƒä¸€èµ· commit æˆ– rollbackã€‚\nç•¶ slave log_bin = ON ä¸” log_slave_update = ON æ™‚ (æ³¨æ„ï¼šå¦‚æœæ˜¯ master log_bin = ON ä¹Ÿé©ç”¨)ï¼Œ æ¯ç•¶ binlog rotate æˆ–è€… server é—œé–‰æ™‚ï¼Œæ‰æœƒå°‡å…ˆå‰ binlog çš„æ‰€æœ‰ transaction gtid å¯«å…¥ mysql.gtid_executed è¡¨ã€‚\nç•¶ server crash æ™‚ï¼Œæœƒåœ¨ crash recovery æ™‚å°‡ binlog ä¸­çš„ GTID æ·»åŠ åˆ° mysql.gtid_executed è¡¨ã€‚\næ³¨æ„ï¼šç•¶é–‹å•Ÿæ™‚ log_bin = OFF æ™‚ï¼Œæœƒç„¡æ³•æ¢å¾© GTID å°è‡´ç„¡æ³•å•Ÿå‹• replicationã€‚\næœƒä½¿ç”¨æ¯æ¬¡ Transaction commit æ™‚æ›´æ–°çš„ @@GLOBAL.gtid_executed ä¾†è¡¨ç¤º server çš„ GTID ç‹€æ…‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ mysql.gtid_executed è¡¨(å› ç‚ºä¸æœƒå³æ™‚æ›´æ–°)ã€‚\nå› ç‚ºä»¥ä¸Šè¡Œç‚ºç•¶é–‹å•Ÿ gtid æ¨¡å¼ä¸” log_slave_update = ON æ™‚ï¼Œå¿…é ˆè¦åŒæ™‚è¨­ç½® sync_binlog = 1 \u0026amp; innodb_flush_log_at_trx_commit = 1ï¼Œå¦å‰‡æœƒå°è‡´ relication åœ¨ OS crash æ™‚ç™¼ç”Ÿå•é¡Œã€‚\nå¾ 8.0.17 é–‹å§‹ç‚ºäº†å¯¦ç¾ clone åŠŸèƒ½ (WL#9211) æ›´æ”¹äº†æ­¤è¡Œç‚ºï¼Œä¸è«–å¦‚ä½•è¨­ç½® mysql.gtid_executed è¡¨ç¸½æ˜¯å’Œå°æ‡‰çš„ Event ä¸€èµ· commit (rollback) ã€‚\nmysql.gtid_execute è¡¨ è¨­è¨ˆçš„åˆè¡·æ˜¯ç”¨æ–¼ç•¶ slave æœªé–‹å•Ÿ binlog æˆ–è€…æ˜¯ log_slave_update = OFF æ™‚ï¼Œæˆ–è€…æ˜¯ç•¶ binlog ä¸Ÿå¤±æ™‚èƒ½å¤ ä¿ç•™ GTID çš„ç‹€æ…‹ï¼Œå› æ­¤æœƒåœ¨é€™å¼µè¡¨ä¸­æŒä¹…åŒ–å·²ç¶“åŸ·è¡Œçš„ GTID SETã€‚\nğŸ’¡ RESET MASTER æœƒæ¸…ç©ºæ­¤è¡¨ å£“ç¸® éš¨è‘—æ™‚é–“æ¨ç§» mysql.gtid_executed è¡¨æœƒæœ‰è¨±å¤šç­†è³‡æ–™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 +--------------------------------------+----------------+--------------+ | source_uuid | interval_start | interval_end | |--------------------------------------+----------------+--------------| | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 37 | 37 | | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 38 | 38 | | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 39 | 39 | | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 40 | 40 | | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 41 | 41 | | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 42 | 42 | | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 43 | 43 | +--------------------------------------+----------------+--------------+ ç‚ºäº†ç¯€çœç©ºé–“ï¼ŒMySQL æœƒå®šæœŸå£“ç¸® mysql.gtid_executed è¡¨ï¼Œå£“ç¸®çš„æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 +--------------------------------------+----------------+--------------+ | source_uuid | interval_start | interval_end | |--------------------------------------+----------------+--------------| | 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 37 | 43 | +--------------------------------------+----------------+--------------+ å•Ÿç”¨ binlog æ™‚ï¼Œç•¶ç™¼ç”Ÿ binlog rotation æ™‚æœƒå£“ç¸® mysql.gtid_executed è¡¨ã€‚\nç•¶ç¦ç”¨ binlog æ™‚æœƒä¾æ“š gtid_executed_compression_period çš„å€¼æ±ºå®šå£“ç¸®çš„æ™‚æ©Ÿé»ï¼Œæ¯ç•¶è™•ç† N å€‹ Transaction å¾Œæœƒå–šé†’å£“ç¸®ç·šç¨‹ (thread/sql/compress_gtid_table) å£“ç¸® mysql.gtid_executed è¡¨ã€‚\nåœ¨ 8.0.17 ä¹‹å‰é è¨­å€¼ç‚º 1000ï¼Œè¡¨ç¤ºæ¯ 1000 å€‹ Transaction é€²è¡Œå£“ç¸®ï¼Œåœ¨è©²ç‰ˆæœ¬ä¹‹å‰ä¸å»ºè­°åœ¨é—œé–‰ binlog æ™‚è¨­å®šç‚º 0ï¼Œé€™å°‡æœƒå¢åŠ æ‰€éœ€çš„ disk ç©ºé–“ã€‚\nå¾ 8.0.17 é–‹å§‹å»ºè­°è¨­ç½®ç‚º 0 (8.0.23 é è¨­å€¼)ï¼Œé€™æ˜¯å› ç‚ºå¾è©²ç‰ˆæœ¬é–‹å§‹ InnoDB çš„ Transaction å¯«å…¥æœƒç”±å¦ä¸€å€‹ innodb/clone_gtid_thread ç·šç¨‹ä¾†æ§åˆ¶å¯«å…¥å’Œå£“ç¸®ï¼Œ compress_gtid_table ç·šç¨‹æœƒå¹²æ“¾å…¶ä½œæ¥­ä¸¦é™ä½é€Ÿåº¦ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 mysql\u0026gt; SELECT * FROM performance_schema.threads WHERE NAME LIKE \u0026#39;%gtid%\u0026#39;\\G *************************** 1. row *************************** THREAD_ID: 26 NAME: thread/sql/compress_gtid_table TYPE: FOREGROUND PROCESSLIST_ID: 1 PROCESSLIST_USER: NULL PROCESSLIST_HOST: NULL PROCESSLIST_DB: NULL PROCESSLIST_COMMAND: Daemon PROCESSLIST_TIME: 1509 PROCESSLIST_STATE: Suspending PROCESSLIST_INFO: NULL PARENT_THREAD_ID: 1 ROLE: NULL INSTRUMENTED: YES HISTORY: YES CONNECTION_TYPE: NULL THREAD_OS_ID: 18677 ç³»çµ±è®Šé‡ gtid_executed å’Œ gtid_purged çš„åˆå§‹åŒ–èˆ‡æ›´æ–° åˆå§‹åŒ– æ¯å€‹ binlog çš„é–‹é ­éƒ½æœ‰ Previous-GTIDsï¼šé€™æ˜¯ç”±ä¸Šä¸€å€‹ binlog æ–‡ä»¶çš„ Previous-GTIDs å’Œä¸Šä¸€å€‹ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTID çµ„æˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ~ -\u0026gt; mysqlbinlog --no-defaults --base64-output=DECODE-ROWS -vvv mysql-bin.000004 ... #230217 8:17:55 server id 1 end_log_pos 125 CRC32 0xa9000aca Start: binlog v 4, server v 8.0.21 created 230217 8:17:55 at startup ROLLBACK/*!*/; # at 125 #230217 8:17:55 server id 1 end_log_pos 196 CRC32 0xf3d86d46 Previous-GTIDs # 6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:1-3 ... SET @@SESSION.GTID_NEXT= \u0026#39;6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:4\u0026#39;/*!*/; ... SET @@SESSION.GTID_NEXT= \u0026#39;6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:5\u0026#39;/*!*/; ... # End of log file ~ -\u0026gt; mysql-docker $ mysqlbinlog --no-defaults --base64-output=DECODE-ROWS -vvv mysql-bin.000005 ... #230217 8:19:12 server id 1 end_log_pos 125 CRC32 0xd5587e96 Start: binlog v 4, server v 8.0.21 created 230217 8:19:12 at startup # Warning: this binlog is either in use or was not closed properly. ROLLBACK/*!*/; # at 125 #230217 8:19:12 server id 1 end_log_pos 196 CRC32 0x2416aa2b Previous-GTIDs # 6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:1-5 ... gtid_executed å’Œ gtid_purged é€™ 2 å€‹ç³»çµ±è®Šé‡åœ¨ MySQL å•Ÿå‹•æ™‚æœƒé€é binlog è¨ˆç®—é€²è¡Œåˆå§‹åŒ–ï¼š\ngtid_executedï¼šç”±æœ€æ–°çš„ binlog æ–‡ä»¶çš„ Previous-GTIDsã€æœ€æ–°çš„ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTIDã€mysql.gtid_excuted ä¸¦é›† (UNION) è¨ˆç®—å¾—å‡ºã€‚ gtid_purgedï¼š å°‡æœ€æ–°çš„ binlog æ–‡ä»¶çš„ Previous-GTIDsã€æœ€æ–°çš„ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTID ç›¸åŠ ï¼Œè¨ˆç®—å‡º gtids_in_binlog (è¡¨ç¤ºæ›¾å‡ºç¾åœ¨ binlog çš„æ‰€æœ‰ gtid)ã€‚\nå°‡ gtids_in_binlog æ¸›å»æœ€èˆŠçš„ binlog æ–‡ä»¶çš„ Previous-GTIDsï¼Œè¨ˆç®—å‡º gtids_in_binlog_not_purged (è¡¨ç¤ºæ‰€åœ¨çš„ binlog å°šæœªè¢«æ¸…é™¤çš„ gtid)ã€‚\nå°‡ gtid_executed æ¸›å» gtids_in_binlog_not_purgedï¼Œå¾—å‡ºåœ¨ server ä¸ŠåŸ·è¡Œéä½† binlog å·²è¢«æ¸…æ¥šçš„ GTID SETã€‚\nç”±ä¸Šè¨ˆç®—å¾—çŸ¥å¦‚æœ binlog æœªé–‹å•Ÿæ™‚ï¼Œgtid_purged = gtid_executed ã€‚\næ›´æ–° gtid_executedï¼š æœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚ set global gtid_purgedï¼Œè¨­ç‚ºåŸå…ˆ gtid_execute å’Œæ–°è¨­ç½® gtid_purged çš„ä¸¦é›† (UNION)ã€‚ gtid_purgedï¼š ç•¶ log_slave_updates = OFF æ™‚ï¼Œæœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚ ç•¶ Master é–‹å•Ÿ binlog æ™‚ï¼Œç•¶åŸ·è¡Œ purge binary logs æˆ– binlog è¶…é expire_logs_days (binlog_expire_logs_seconds) çš„è¨­ç½®æ™‚ï¼Œè§¸ç™¼æ¸…é™¤ binlog çš„å‹•ä½œæ›´æ–°ã€‚ ç•¶ Slave é–‹å•Ÿ log_slave_updatesï¼Œç•¶åŸ·è¡Œ purge binary logs æˆ– binlog è¶…é expire_logs_days (binlog_expire_logs_seconds) çš„è¨­ç½®æ™‚ï¼Œè§¸ç™¼æ¸…é™¤ binlog çš„å‹•ä½œæ›´æ–°ã€‚ ç•¶ Slave é—œé–‰ log_slave_updates ï¼Œæœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚ set global gtid_purgedï¼Œè¢«è¨­å®šæˆ–å¢åŠ æŒ‡å®š gtid setã€‚ å…±åŒï¼š RESET MASTER æ™‚è¨­ç‚ºç©ºå€¼ã€‚ åœ¨ MySQL å•Ÿå‹•æ™‚åˆå§‹åŒ–ã€‚ Master æœªé–‹å•Ÿ binlog æ™‚ï¼Œå› ç‚ºä¸æœƒç”¢ç”Ÿ GTIDï¼Œå› æ­¤ä¸æœƒæœ‰ä»»ä½•æ›´æ–°ã€‚ GTID ç›¸é—œè®Šé‡ gtid_mode æ§åˆ¶æ˜¯å¦é–‹å•Ÿ GTID åŠŸèƒ½ã€‚\nå¯ä»¥è¨­ç½®ç‚ºä»¥ä¸‹å€¼ï¼š\nOFFï¼šæ‰€æœ‰æ–°çš„æˆ–å›æ”¾çš„ Transaction éƒ½æ˜¯ anonymousã€‚ OFF_PERMISSIVEï¼šæ‰€æœ‰æ–°çš„ Transaction éƒ½æ˜¯ anonymousï¼Œä½†å›æ”¾çš„ Transaction å¯ä»¥æ˜¯ anonymous ä¹Ÿå¯ä»¥åŒ…å« GTIDã€‚ ON_PERMISSIVEï¼šæ‰€æœ‰æ–°çš„ Transaction éƒ½åŒ…å« GTIDï¼Œä½†å›æ”¾çš„ Transaction å¯ä»¥æ˜¯ anonymous ä¹Ÿå¯ä»¥åŒ…å« GTIDã€‚ ONï¼šå¿…é ˆåŒæ™‚è¨­ç½® enforce_gtid_consistency = ONã€‚ åœ¨ä¿®æ”¹ gtid_mode æ™‚ä¸€æ¬¡åªèƒ½è®Šæ›´ç‚ºä¸Šä¸€å€‹æˆ–ä¸‹ä¸€å€‹å€¼ï¼Œä¾‹å¦‚ï¼šåŸå…ˆè¨­ç½®ç‚º OFF_PERMISSIVE å‰‡åªèƒ½è¨­ç½®ç‚º OFF æˆ– ON_PERMISSIVEã€‚\nenforce_gtid_consistency æ§åˆ¶æ˜¯å¦å…è¨±é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œï¼Œå¿…é ˆè¨­ç½®ç‚º ON æ‰èƒ½è¨­ç½® gtid_mode = ONã€‚\nå¯ä»¥è¨­ç½®ç‚ºä»¥ä¸‹å€¼ï¼š\nOFF (0)ï¼šå…è¨±æ‰€æœ‰é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œã€‚ ON (1)ï¼šä¸å…è¨±ä»»ä½•é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œã€‚ WARN (2)ï¼šå…è¨±æ‰€æœ‰é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œï¼Œä½†æœƒç”¢ç”Ÿ warningã€‚ åªæœ‰åœ¨èªå¥å¯«å…¥ binlog æ™‚æ‰æœƒæª¢æŸ¥ï¼Œä¹Ÿå°±æ˜¯æœªé–‹å•Ÿ binlog æˆ–ç•¶èªå¥è¢« filter éæ¿¾æ™‚ä¸æœƒæª¢æŸ¥ã€‚\né•å GTID ä¸€è‡´æ€§çš„èªå¥å¯ä»¥åƒè€ƒ GTID é™åˆ¶ ç« ç¯€ã€‚\ngtid_next gtid_next ç”¨æ–¼æŒ‡å®šå¦‚ä½•ç²å–ä¸‹ä¸€å€‹ GTIDã€‚\ngtid_next å¯ä»¥è¨­ç‚ºä»¥ä¸‹å€¼ï¼š\nAUTOMATICï¼šä½¿ç”¨ä¸‹ä¸€å€‹è‡ªå‹•ç”Ÿæˆçš„ GTIDã€‚ ANONYMOUSï¼šTransaction æ²’æœ‰ GTIDï¼Œåªæœ‰ gtid_mode = OFF æ™‚æ‰èƒ½è¨­ç½®çš„å€¼ã€‚ æŒ‡å®š GTID å°‡ gtid_next è¨­ç½®ç‚ºæŒ‡å®š GTID å¾Œï¼Œéœ€è¦åœ¨ Transaction commit æˆ– rollback å¾Œï¼Œå¿…é ˆåœ¨åŸ·è¡Œå…¶ä»–èªå¥ä¹‹å‰å†æ¬¡é¡¯å¼çš„ SET GTID_NEXTï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mysql\u0026gt; set gtid_next = \u0026#39;08d3c091-addb-11ed-8959-0242ac1c0002:5\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; begin; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; insert into test values(2,20); Query OK, 1 row affected (0.00 sec) mysql\u0026gt; rollback; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; insert into test values(2,20); ERROR 1837 (HY000): When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is \u0026#39;08d3c091-addb-11ed-8959-0242ac1c0002:5\u0026#39;. gtid_owned æ­¤ç‚º read-only çš„è®Šé‡ï¼Œæ ¹æ“š Scope çš„ä¸åŒæœ‰ä¸åŒæ„æ€ï¼š\nGlobalï¼šåˆ—å‡º server æ­£åœ¨ä½¿ç”¨çš„æ‰€æœ‰ GTID ä»¥åŠæ“æœ‰è©² GTID çš„ç·šç¨‹ IDã€‚\nä¸»è¦ç”¨æ–¼é–‹å•Ÿ MTS æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»– applier å·²ç¶“åœ¨æ‡‰ç”¨è©² GTIDï¼Œé¿å…åŒä¸€å€‹ GTID åœ¨åŒæ™‚è¢«å¤šå€‹ç·šç¨‹åŒæ™‚è™•ç†ã€‚\nSessionï¼šåˆ—å‡ºè©² session ä½¿ç”¨ä¸­çš„ GTIDã€‚\nç•¶æ‰‹å‹•è¨­ç½® gtid_next ç‚ºæŒ‡å®š GTID æ™‚ï¼Œå¯ä»¥åœ¨ Transaction åœ¨ commit (rollback) ä¹‹å‰é€é gtid_owned è§€å¯Ÿåˆ°æ­¤è¨­ç½®ã€‚\nç•¶ gtid_next = AUTOMATIC æ™‚ï¼Œåªæœ‰åœ¨ Trasnsaction commit æ™‚èƒ½å¾ gtid_next ä¸­çŸ­æš«è§€å¯Ÿåˆ°ï¼Œå…¶é¤˜æ™‚å€™æœƒæ˜¯ç©ºå€¼ã€‚\ngtid_executed æ­¤ç‚º read-only çš„è®Šé‡ï¼ŒæŒ‡çš„æ˜¯æ‰€æœ‰è©² server å·²ç¶“åŸ·è¡Œçš„ GTIDï¼Œä¹Ÿæœƒç­‰åŒæ–¼ SHOW MASTER ( | SLAVE ) STATUS ä¸­çš„ Executed_Gtid_Set å€¼ã€‚\nç•¶åŸ·è¡Œ RESET MASTER æ™‚æœƒå°‡ gtid_executed è¨­ç½®ç‚ºç©ºå€¼ã€‚\ngtid_executed çš„ Gtid_Set æœƒåŒ…å« gtid_purged çš„ Gtid_Set ï¼Œå› æ­¤åœ¨ä»»ä½•æ™‚å€™åŸ·è¡Œ GTID_SUBTRACT(@@GLOBAL.gtid_executed, @@GLOBAL.gtid_purged) å¯ä»¥å¾—åˆ°æœªæ¸…é™¤çš„ binlog ä¸­æ‰€æœ‰çš„ GTIDã€‚\ngtid_purged æ­¤è®Šé‡è¡¨ç¤ºåœ¨ server ä¸Šå·²ç¶“åŸ·è¡Œï¼Œä½†æ˜¯å°æ‡‰çš„ binlog å·²ç¶“è¢«æ¸…é™¤çš„ GTID SETï¼Œå› æ­¤ gtid_purged ç‚º gtid_executed çš„å­é›†ã€‚\nä»¥ä¸‹æƒ…æ³çš„ GTID æœƒåŒ…å«åœ¨ gtid_purgedï¼š\nç•¶ slave æœªé–‹å•Ÿ log_slave_updates æ™‚ï¼Œå·²ç¶“å›æ”¾çš„ Transaction çš„ GTIDã€‚ åŒ…å«è©² GTID çš„ binlog å·²ç¶“è¢«æ¸…é™¤ã€‚ é€é SET @@GLOBAL.gtid_purged ä¾†é¡¯ç¤ºè¨­ç½®ã€‚ ç•¶åŸ·è¡Œ RESET MASTER æ™‚æœƒå°‡ gtid_purged è¨­ç½®ç‚ºç©ºå€¼ã€‚\nå¯ä»¥é€é SET @@GLOBAL.gtid_purged ä¾†é¡¯ç¤ºè¨­å®šï¼Œæœ‰ä»¥ä¸‹å…©ç¨®æ–¹å¼ï¼š\nå°‡ gtid_purged è®Šæ›´ç‚ºæŒ‡å®šçš„ GTID SETï¼š\n1 SET @@GLOBAL.gtid_purged = \u0026#39;gtid_set\u0026#39; ç¶“éæ­¤è¨­ç½®å¾Œ gtid_purged ç­‰æ–¼ gtid_setï¼Œä¸” gtid_executed å€¼ (mysql.gtid_executed) ç­‰æ–¼ gtid_executed åŸæœ¬çš„å€¼å’Œ gtid_set çš„ä¸¦é›† (UNION)ã€‚\ngtid_set é™åˆ¶ï¼š\næŒ‡å®šçš„ gtid_set å¿…é ˆæ˜¯ gtid_purged ç•¶å‰å€¼çš„è¶…é›† (superset)ï¼Œä¹Ÿå°±æ˜¯æ–°è¨­ç½®çš„ GTID SET å¿…é ˆåŒ…å«åŸæœ¬çš„ gtid_purgedã€‚ æŒ‡å®šçš„ gtid_setä¸å¾—å’Œ gtid_subtract(gtid_executed,gtid_purged) ç›¸äº¤ï¼Œä¹Ÿå°±æ˜¯æ–°è¨­ç½®çš„ GTID SET ä¸èƒ½åŒ…å«åœ¨ gtid_executed ä¸­å°šæœªè¢«æ¸…é™¤çš„å€¼ã€‚ æŒ‡å®šçš„ gtid_set ä¸èƒ½åŒ…å« @@global.gtid_owned ä¸­çš„ä»»ä½• GTIDï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åŒ…å«ç•¶å‰ server æ­£åœ¨åŸ·è¡Œçš„ gtidã€‚ ç”¨é€”ç¯„ä¾‹ï¼šä½¿ç”¨ mysqldump é‚„åŸ slave ä¸Šæå£çš„è¡¨ï¼Œå› ç‚ºå‚™ä»½æª”å’ŒåŸå…ˆ slave çš„ gtid æœ‰é‡ç–Šï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä½¿æ–¹å¼é€²è¡Œ gtid_purged çš„è¨­ç½®ã€‚\nç‚º gtid_purged append (æ–°å¢) æŒ‡å®šçš„ GTID SET\n1 SET @@GLOBAL.gtid_purged = \u0026#39;+gtid_set\u0026#39; ç¶“éæ­¤è¨­ç½®å¾Œ gtid_executed (åŒ…å« mysql.gtid_executed)ã€gtid_purged æœƒæ–°å¢ gtid_setã€‚\ngtid_set é™åˆ¶ï¼š\ngtid_set ä¸å¾—èˆ‡ gtid_executed çš„ç•¶å‰å€¼ç›¸äº¤ï¼Œä¹Ÿå°±æ˜¯æ–°é™„åŠ ä¸Šå»çš„ GTID SET ä¸èƒ½åŒ…å«åœ¨ gtid_executed å’Œ gtid_purged ä¸­çš„ GTIDã€‚ æŒ‡å®šçš„ gtid_set ä¸èƒ½åŒ…å« @@global.gtid_owned ä¸­çš„ä»»ä½• GTIDï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åŒ…å«ç•¶å‰ server æ­£åœ¨åŸ·è¡Œçš„ gtidã€‚ ç”¨é€”ç¯„ä¾‹ï¼šç‚ºäº†é…ç½®å¤šå€‹ channel çš„ salveï¼Œå°‡ä¾†è‡ªä¸åŒ master çš„å‚™ä»½é‚„åŸåˆ°åŒä¸€å€‹ serverï¼Œå› ç‚ºå…©è€…çš„ Transaction ä¸ç›¸äº¤ï¼Œå› æ­¤ä½¿ç”¨ append çš„æ–¹å¼æ›´æ–° gtid_purgedã€‚\næ³¨æ„ï¼šåœ¨ MySQL 5.7 ä¸­åªèƒ½ç›´æ¥è®Šæ›´æˆæŒ‡å®šçš„ GTID SETï¼Œç„¡æ³•ä½¿ç”¨ append çš„æ–¹å¼ï¼Œä¸”åªæœ‰ç•¶ gtid_executed ç‚ºç©º (ä¹Ÿå°±æ˜¯ gtid_purged å€¼ä¹Ÿç‚ºç©º) æ™‚æ‰å¯ä»¥æ›´æ–° gtid_purged çš„å€¼\ngtid_executed_compression_period æ­¤è¨­ç½®åªæœ‰ç¦ç”¨ binlog æ‰æœ‰æ•ˆï¼Œæ¯ç•¶è™•ç† N å€‹ Transaction å¾Œæœƒå–šé†’ç·šç¨‹å£“ç¸® mysql.gtid_executed è¡¨ï¼Œç•¶è¨­ç½®ç‚º 0 æ™‚è¡¨ç¤ºå£“ç¸®ä¸å›ºå®šåŸ·è¡Œï¼Œè€Œæ˜¯æ ¹æ“šéœ€è¦é€²è¡Œå£“ç¸®ã€‚\nç•¶å•Ÿç”¨ binlog æ™‚ï¼Œä¸æœƒä½¿ç”¨æ­¤è¨­ç½®ï¼Œè€Œæ˜¯ç•¶ binlog rotation æ™‚æ‰æœƒå£“ç¸® mysql.gtid_executed è¡¨ã€‚\nbinlog_gtid_simple_recovery æ§åˆ¶ MySQL å•Ÿå‹•æ™‚å¾ binlog å°‹æ‰¾ GTID çš„è¡Œç‚ºã€‚\nGTID é™åˆ¶ ä¸èƒ½åœ¨ä¸€å€‹ Transaction ä¸­åŒæ™‚æ¶‰åŠ nontransactional å„²å­˜å¼•æ“ (ä¾‹å¦‚ï¼šMyISAM) å’Œ transactionalå„²å­˜å¼•æ“ (ä¾‹å¦‚ï¼šInnoDB) çš„è¡¨é€²è¡Œæ›´æ–°ã€‚\nä¸æ”¯æŒ sql_slave_skip_counterï¼Œé™¤é slave åœ¨ CHANGE MASTER æ™‚åŒ…å«äº† ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS æ‰èƒ½ä½¿ç”¨ sql_slave_skip_counterã€‚\nå‚™è¨»ï¼šASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS è©²åŠŸèƒ½ç”¨ä¾†åœ¨æœªé–‹å•Ÿ GTID çš„ Master å’Œé–‹å•Ÿ GTID çš„ Slave é€²è¡Œ Replicationï¼Œä¸”æœƒç‚º Slave åŸ·è¡Œçš„ Transaction ç”Ÿæˆ GTIDã€‚\nä¸æ”¯æŒ CHANGE MASTER æ™‚ä½¿ç”¨ IGNORE_SERVER_IDS é¸é …ã€‚\nåœ¨ MySQL 8.0.21 ä¹‹å‰ï¼Œä¸æ”¯æ´ CREATE TABLE \u0026hellip; SELECT èªå¥ï¼Œå› ç‚ºè©²èªå¥åŸºæ–¼ STATEMENT æœƒç”¢ç”Ÿä¸€å€‹ GTIDï¼Œä½†ROW æ ¼å¼ç´€éŒ„æœƒç”¢ç”Ÿ 2 å€‹ GTIDï¼Œé€™æœƒå°è‡´ç„¡æ³•æ­£ç¢ºè™•ç† Transactionã€‚\nåœ¨ MySQL 8.0.21 ä¹‹å¾Œï¼Œå› ç‚ºæ”¯æŒ atomic (åŸå­) DDL æ“ä½œï¼Œå› æ­¤ä¸å†æœ‰è©²é™åˆ¶ã€‚\nåœ¨ MySQL 8.0.13 ä¹‹å‰ä¸èƒ½åœ¨ Transactionã€Proceduresã€Functions å’Œ Triggers å…§éƒ½ä¸èƒ½ä½¿ç”¨ CREATE/DROP TEMPORARY TABLEï¼Œåªèƒ½åœ¨é Transaction å…§ä¸” autocommit = 1 æ™‚æ‰èƒ½ä½¿ç”¨ã€‚\nå¾ MySQL 8.0.13 é–‹å§‹ï¼Œç•¶ binlog_format è¨­ç½®ç‚º ROW æˆ– MIXED æ™‚ï¼Œåœ¨ä½¿ç”¨ GTID æ™‚å…è¨±ä½¿ç”¨ CREATE/DROP TEMPORARY TABLEï¼Œå› ç‚ºé€™äº›èªå¥å°‡ä¸æœƒå¯«å…¥ binlogã€‚\nåœ¨ MySQL 8.0.16 ä¹‹å‰ï¼Œä¸èƒ½åœ¨ mysql_upgrade ä¸­åŠ ä¸Š --write-binlog é¸é …ã€‚\nå¾ MySQL 8.0.16 é–‹å§‹ï¼ŒåŸ·è¡Œ mysql_upgrade æœŸé–“ç¸½æ˜¯æœƒè‡ªå‹•ç¦ç”¨ binlogï¼Œå› æ­¤æ²’æœ‰å•é¡Œã€‚\nåœ¨ç·šé–‹å•Ÿ GTID åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š\n1 SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN; è¨­ç½®å¾Œè®“ MySQL æ¥å—æ­£å¸¸çš„æ“ä½œï¼Œä¸¦åœ¨æœŸé–“å¾ Error Log ç¢ºèªæ˜¯å¦æœ‰å‡ºç¾ GTID ä¸æ”¯æŒçš„ Queryï¼Œä¸¦å°å…¶é€²è¡Œä¿®æ­£ã€‚\nåœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š\n1 SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON; è¨­ç½®å¾Œæ‰€æœ‰ GTID ä¸æ”¯æŒçš„æ“ä½œéƒ½å°‡è¢«æ‹’çµ•ã€‚\nåœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š\n1 SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE; è¡¨ç¤º Master ç”Ÿæˆçš„æ˜¯ ANONYMOUS Transactionï¼ŒSlave å¯ä»¥æ‡‰ç”¨ ANONYMOUS ã€GTID Transactionã€‚\næ³¨æ„å‹™å¿…åœ¨æ‰€æœ‰ server éƒ½è¨­ç½®æ­¤æ­¥é©Ÿå¾Œï¼Œæ‰åŸ·è¡Œä¸‹ä¸€æ­¥é©Ÿã€‚\nåœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š\n1 SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE; è¡¨ç¤º Master ç”Ÿæˆçš„æ˜¯ GTID Transactionï¼ŒSlave å¯ä»¥æ‡‰ç”¨ ANONYMOUS ã€GTID Transactionã€‚\nåœ¨æ‰€æœ‰çš„ MySQL server ä¸­ç¢ºå®šä»¥ä¸‹è®Šé‡ç‚º 0ï¼š\n1 SHOW STATUS LIKE \u0026#39;ONGOING_ANONYMOUS_TRANSACTION_COUNT\u0026#39;; è©²å€¼å°±æ˜¯å°šæœª commit ANONYMOUS Transaction æ•¸é‡ï¼Œå› æ­¤å¿…é ˆç¢ºèªè©²å€¼ç‚º 0 è¡¨ç¤ºæ²’æœ‰ ANONYMOUS Transaction éƒ½æ˜¯ GTID Transaction ã€‚\nONGOING_ANONYMOUS_TRANSACTION_COUNT å¢æ¸›çš„æ™‚æ©Ÿ åœ¨ Master ä¸Š å¢åŠ ï¼šç•¶ FLUSH éšæ®µåˆ†é… GTID æ™‚ï¼Œå¦‚æœç‚º ANONYMOUS Transaction å‰‡å¢åŠ è©²è¨ˆæ•¸ã€‚ æ¸›å°‘ï¼šåœ¨ COMMIT éšæ®µ InnoDB COMMIT ä¹‹å¾Œæœƒæ¸›å°‘è©²è¨ˆæ•¸ã€‚ åœ¨ Slave ä¸Š å¢åŠ ï¼šç•¶ SQL Tread æ‡‰ç”¨åˆ° ANONYMOUS Transaction å‰‡å¢åŠ è©²è¨ˆæ•¸ã€‚ æ¸›å°‘ï¼šç•¶ SQL Tread åŸ·è¡Œ InnoDB COMMIT ä¹‹å¾Œæœƒæ¸›å°‘è©²è¨ˆæ•¸ã€‚ ç•¶ ONGOING_ANONYMOUS_TRANSACTION_COUNT éƒ½ç‚º 0 çš„æ™‚å€™ï¼Œç¢ºèªæ‰€æœ‰ slave éƒ½æœ‰åŸ·è¡Œéå°æ‡‰ master binlog çš„ positionï¼Œä¸¦éæŒ‡ä¸èƒ½æœ‰å»¶é²åªæ˜¯è¦ç¢ºä¿æ‰€æœ‰çš„ ANONYMOUS Transaction éƒ½å·²ç¶“è¢«åŸ·è¡Œã€‚\nåœ¨ Master ä»¥ä¸‹æŒ‡ä»¤ï¼Œ ç²å– Master binlogã€Master position\n1 2 # ç²å– Master binlogã€Master position SHOW MASTER STATUS\\G åœ¨ Slave åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œç¢ºèª slave æ˜¯å¦å·²åŸ·è¡Œ master å°æ‡‰çš„ binlog åŠ position\n1 2 # ç¢ºèª slave æ˜¯å¦å·²åŸ·è¡Œ master å°æ‡‰çš„ binlog åŠ position SELECT MASTER_POS_WAIT(file, position); å¦‚æœ binlog æœ‰ç”¨æ–¼ replication ä»¥å¤–çš„ç”¨é€” (ä¾‹å¦‚ï¼šåŸºæ–¼æ™‚é–“é»çš„å‚™ä»½å’Œæ¢å¾©)ï¼Œè«‹åœ¨æ­¤æ™‚ç¢ºä¿åŒ…å« ANONYMOUS Transaction çš„ Binlog å·²ä¸å†éœ€è¦ã€‚\nä¾‹å¦‚ï¼šåœ¨ç¬¬ 6 æ­¥å®Œæˆå¾Œï¼Œåœ¨å‚™ä»½æ©Ÿä¸ŠåŸ·è¡Œ flush logs å¾Œé€²è¡Œå‚™ä»½ã€‚\nåœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š\n1 SET @@GLOBAL.GTID_MODE = ON; åœ¨æ‰€æœ‰çš„ MySQL server çš„ my.cnf ä¸­æ·»åŠ \n1 2 gtid_mode=ON enforce_gtid_consistency=ON åœ¨ slave åŸ·è¡Œ change master\n1 2 3 STOP SLAVE [FOR CHANNEL \u0026#39;channel\u0026#39;]; CHANGE MASTER TO MASTER_AUTO_POSITION = 1 [FOR CHANNEL \u0026#39;channel\u0026#39;]; START SLAVE [FOR CHANNEL \u0026#39;channel\u0026#39;]; GTID ä¸­çš„ç¶­é‹ SHOW SLAVE STATUS åœ¨é–‹å•Ÿ GTID å¾Œï¼Œé€é SHOW SLAVE STATUS æœƒå¢åŠ ä»¥ä¸‹è³‡è¨Šï¼š\nRetrieved_Gtid_Setï¼šSlave å¾ Master æ”¶åˆ°çš„ GTID SETï¼Œä¹Ÿå°±æ˜¯ IO_Thread å·²ç¶“æ¥æ”¶åˆ°çš„ GTIDã€‚\nç•¶ relay-log-recovery = 1 æˆ– RESET SLAVE æˆ– CHANGE MASTER æ™‚æœƒè¢«æ¸…ç©ºã€‚\nç•¶ relay-log-recovery = 0 æ™‚ï¼Œåœ¨ MySQL é‡å•Ÿæ™‚æœƒå¾ relay log ä¸­æƒæç¢ºèªã€‚\nExecuted_Gtid_Setï¼šSlave å·²ç¶“åŸ·è¡Œçš„ GTID SET (åŒ…å«ç›´æ¥åœ¨ slave ä¸ŠåŸ·è¡Œçš„èªå¥)ï¼Œç­‰åŒæ–¼ gtid_executedã€‚\næ¸…é™¤ GTID æ­·å²ç´€éŒ„ å¦‚æœè¦å®Œå…¨æ¸…æ¥š GTID æ­·å²ç´€éŒ„å¯ä»¥ä½¿ç”¨ RESET MASTER æŒ‡ä»¤ã€‚\nåŸ·è¡Œå‰å‹™å¿…å‚™ä»½ binlogã€binlog index æ–‡ä»¶ï¼Œç²å–ä¸¦ä¸”ä¿å­˜ gtid_executed è®Šé‡ã€‚\nRESET MASTER åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š\ngtid_purged è¢«è¨­ç‚ºç©ºå­—ä¸²ã€‚ gtid_executed è¢«è¨­ç‚ºç©ºå­—ä¸²ã€‚ mysql.gtid_executed è¡¨è¢«æ¸…ç©ºã€‚ åˆªé™¤ç¾æœ‰ binlogï¼Œä¸¦æ¸…é™¤ binlog index æ–‡ä»¶ã€‚ æ³¨æ„åªæœ‰ RESET MSTER æœƒé‡ç½® GTID çš„æ­·å²ç´€éŒ„ï¼ŒRESET SLAVE æ²’æœ‰ä»»ä½•å½±éŸ¿ã€‚\nè·³éä¸€å€‹ Transaction ç•¶æœ‰ Transaction åœ¨ SQL_Thread ä¸­ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå¯ä»¥é€é performance_schema ä¸­çš„replication_applier_status_by_worker è©²è¡¨ä¸­çš„ APPLYING_TRANSACTION æ¬„ä½ç²å–è©² Transaction çš„ GTIDã€‚\nç•¶ç¢ºèªè¦è·³éè©²å¤±æ•—çš„ Transaction æ™‚ï¼Œåœ¨ GTID æ¨¡å¼ä¸‹å‚³çµ±çš„ sql_slave_skip_counter ä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 STOP SLAVE; # å°‡ GTID_NEXT è¨­ç‚ºè¦è·³éçš„ Transaction GTID SET GTID_NEXT=\u0026#39;aaa-bbb-ccc-ddd:N\u0026#39;; # å°‡è©² Transaction GTID è¨­ç‚ºä¸€å€‹ç©º Transaction BEGIN; COMMIT; SET GTID_NEXT=\u0026#39;AUTOMATIC\u0026#39;; START SLAVE; åœ¨ä¸Šè¿°æ­¥é©Ÿå¾Œæœƒå°‡è¦è·³éçš„ GTID è¨­ç‚ºä¸€å€‹ç©ºçš„ Transaction ä¸¦å°‡å…¶æ‡‰ç”¨ï¼Œæ­¤æ™‚ slave æœƒèªç‚ºè‡ªå·±å·²åŸ·è¡Œå®Œç•¢è©² GTIDï¼Œå› æ­¤å¯ä»¥å°‡ GTID_NEXT è¨­å› AUTOMATIC è®“ slave è‡ªè¡Œæ‰¾åˆ°ä¸‹ä¸€å€‹è¦åŸ·è¡Œçš„ GTIDã€‚\nå¦‚æœæ˜¯æœ‰å¤šå€‹ channel çš„ slaveï¼Œcommit ä¸€å€‹ç©ºçš„ Transaction æ™‚ä¸éœ€è¦æŒ‡å®š channelï¼Œåªæœ‰åœ¨ START SLAVE æ‰éœ€è¦æŒ‡å®š channel åç¨±ã€‚\næ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸é©ç”¨ ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS\nåƒè€ƒ\nMySQL :: MySQL 8.0 Reference Manual :: 17.1.7.3 Skipping Transactions\nmysqldump è¡Œç‚ºçš„è®ŠåŒ– mysqldump åœ¨é–‹å•Ÿ gtid å¾Œé è¨­çš„ dump è¡Œç‚ºæœƒæœ‰æ‰€æ”¹è®Šï¼Œé€™æ˜¯å› ç‚º --set-gtid-purged è©²é¸é …é è¨­å€¼çš„å½±éŸ¿ï¼š\nAUTO (é è¨­å€¼)ï¼šåœ¨é–‹å•Ÿ GTID (gtid_mode = ON) æ™‚è‡ªå‹•è¨­ç‚º ONï¼Œåœ¨æœªé–‹å•Ÿ GTID (gtid_mode = OFF) æ™‚è‡ªå‹•è¨­ç‚º OFFã€‚\nONï¼šå‚™ä»½æª”ä¸­æœƒåŒ…å« gtid_purgrd ä¸”æœƒæ·»åŠ  sql_log_bin = 0ï¼š\n1 2 3 4 5 6 7 8 SET @MYSQLDUMP_TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN; SET @@SESSION.SQL_LOG_BIN= 0; -- -- GTID state at the beginning of the backup -- SET @@GLOBAL.GTID_PURGED=\u0026#39;42fe5059-32a7-11e6-9d29-000c29fcecda:1\u0026#39;; é€™æ¨£çš„è¨­ç½®ä¸‹æœƒæœ‰ä»¥ä¸‹çµæœï¼š\nè¨­ç½® sql_log_bin = 0ï¼šé—œé–‰äº† binlog ç´€éŒ„ï¼Œå› æ­¤é‚„åŸçš„æ©Ÿå™¨ä¸æœƒç”Ÿæˆæ–°çš„ GTIDã€‚ è¨­ç½® gtid_purgrd ï¼šåŒæ™‚ä¹ŸæœƒåŒæ™‚ä¿®æ”¹ gtid_executed å€¼åŠ mysql.gtid_executed è¡¨ã€‚ æ­¤è¨­ç½®é©åˆç”¨æ–¼é‚„åŸä¸€å€‹ slave æ¥ä¸Šå‚™ä»½æª”ä¾†æºçš„ replication topologyã€‚\nOFFï¼šå‚™ä»½æª”ä¸­ä¸æœƒåŒ…å« gtid_purgrd ä¸”ä¸æœƒæ·»åŠ  sql_log_bin = 0ï¼Œæ­¤è¨­ç½®ç”¨æ–¼æœªé–‹å•Ÿ GTID çš„ MySQL æˆ–æ˜¯é©åˆæ–¼é‚„åŸä¸€å€‹å’ŒåŸæœ¬ replication topology ç„¡é—œçš„æ–° masterã€‚\nCOMMENTEDï¼šå¾ 8.0.17 é–‹å§‹å¯ç”¨ï¼Œå‚™ä»½æª”ä¸­æœƒæ·»åŠ  sql_log_bin = 0ï¼Œä¸¦åœ¨å‚™ä»½ä¸­ç”¨è¨»è§£çš„æ–¹å¼è¨˜éŒ„ gtid_purgrdã€‚æ­¤æ–¹å¼è¼ƒç‚ºå½ˆæ€§é©åˆï¼Œç”¨æ–¼ä¸éœ€ç”Ÿæˆæ–°çš„ gtid (åŸºæœ¬ä¸Šè¡¨ç¤ºæœƒåœ¨åŒä¸€å€‹ replication topology) ä½†æƒ…å¢ƒè¼ƒç‚ºè¤‡é›œçš„éœ€è¦è‡ªè¡Œèª¿æ•´ gtid_purgrd æ™‚ï¼Œä¾‹å¦‚ï¼šé‚„åŸå¾Œçš„æ©Ÿå™¨æœƒæœ‰å¤šå€‹ channelã€‚\nå› æ­¤ç•¶é–‹å•Ÿ gtid å¾Œåœ¨ä½¿ç”¨ mysqldump æ™‚éœ€è¦æ³¨æ„ --set-gtid-purged çš„è¨­ç½®ï¼š\nç•¶ gtid_mode = OFF æœªé–‹å•Ÿ GTID æ™‚ï¼Œå¯ä»¥ä¸éœ€è¦èª¿æ•´è©²åƒæ•¸æˆ–é¡¯å¼æŒ‡å®šç‚º OFFã€‚\nç•¶ gtid_mode = ON é–‹å•Ÿ GTID æ™‚ï¼Œè‹¥ç”¨æ–¼é‚„åŸåˆ°åŒä¸€å€‹ replication topology çš„æ©Ÿå™¨ï¼Œä¾‹å¦‚ï¼šæ–°å¢ä¸€å€‹ slaveã€ç‚º slave è£œä¸Šåœ¨ master binlog ä¸Šå·²ç¶“ purge çš„è³‡æ–™â€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥ä¿ç•™é è¨­å€¼æˆ–é¡¯å¼æŒ‡å®šç‚º ONã€‚\nç•¶ gtid_mode = ON é–‹å•Ÿ GTID æ™‚ï¼Œä½†é‚„åŸåˆ°ä¸åŒ replication topology çš„æ©Ÿå™¨æˆ–éœ€è¦ç”Ÿæˆæ–°çš„ GTIDï¼Œä¾‹å¦‚ï¼šé‚„åŸæˆä¸€å€‹æ–°çš„ masterâ€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥è¨­ç½®ç‚º OFFã€‚\næ³¨æ„ï¼šå¦‚æœåœ¨åŒä¸€å€‹ replication topology ä¸­è¨­ç½® OFFï¼Œé™¤äº†å¯èƒ½ MS ç„¡æ³•é †åˆ©å»ºç½®ï¼Œä¹Ÿå¯èƒ½å°è‡´åœ¨ MS åˆ‡æ›æ™‚ æ–° Slave (åŸæœ¬çš„ Master) æœƒæ”¶åˆ° æ–° Master (åŸæœ¬çš„ Slave) é€éå‚™ä»½æª”é‚„åŸçš„è³‡æ–™å°è‡´é‡è¤‡åŸ·è¡Œçš„å•é¡Œã€‚\nç•¶ gtid_mode = ON é–‹å•Ÿ GTID æ™‚ï¼Œé›–ç„¶ä¸éœ€è¦ç”Ÿæˆæ–°çš„ GTID ä½†æƒ…æ³ç‰¹æ®Šéœ€è¦æ‰‹å‹•è¨­ç½® gtid_purged æ™‚ï¼Œä¾‹å¦‚ï¼šé‚„åŸçš„ Slave ä¸Šæœ‰å¤šå€‹ channel â€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥è¨­ç½®ç‚º COMMENTED å¾Œï¼Œæ ¹æ“šå¯¦éš›éœ€è¦æ‰‹å‹•èª¿æ•´è©²æ©Ÿå™¨çš„ gtid_purgrdã€‚\nReplication filter æ›¾ç¶“ç·šä¸Šç’°å¢ƒå¾å‚³çµ± Position é»ä½çš„ Replication åˆ‡æ›åˆ° GTID æ™‚ç™¼ç”Ÿäº†å•é¡Œ\nReplication æ‹“æ¨¸çµæ§‹å¦‚ä¸‹ï¼š\nA Instance çš„ test database åŒæ™‚åŒæ­¥ B, C Instance B Instance Replication çµ¦ Cï¼ŒåŒæ™‚è¨­ç½® Replicat_Do_DB ä¸åŒ…å« test database ç•¶åˆ‡æ›åˆ° GTID æ™‚ï¼Œæœƒå› ç‚ºä»¥ä¸‹æƒ…æ³ä¸Ÿå¤±è³‡æ–™ï¼š\nA åŸ·è¡Œå° test database çš„ç•°å‹• Query åŒæ­¥çµ¦ B, C\nB æ”¶åˆ°ä¸¦åŸ·è¡Œ A å° test database çš„ç•°å‹• Query çµ¦ C\nC æ”¶åˆ° B åŒæ­¥éä¾†çš„ Queryï¼Œä½†å› ç‚º Replicat_Do_DB çš„è¨­ç½®ï¼ŒC ä¸¦ä¸æœƒåŸ·è¡Œ B åŒæ­¥éä¾† test database ç•°å‹•èªæ³•ã€‚\næ³¨æ„ï¼š å„˜ç®¡æ²’æœ‰çœŸçš„åŸ·è¡Œï¼Œä½†æ­¤æ™‚è©² GTID æœƒè¢«åŠ å…¥åˆ° C çš„ gtid_executed ä¸­\nC éš¨å¾Œæ”¶åˆ° A åŒæ­¥éä¾†çš„ test database ç•°å‹• Queryï¼Œä½†å› ç‚ºè©² GTID åœ¨æ­¥é©Ÿ 3 å·²ç¶“åŸ·è¡Œéï¼Œæ‰€ä»¥ç›´æ¥è·³éã€‚\nè§£æ±ºæ–¹æ¡ˆä¹Ÿå¾ˆç°¡å–®ï¼šç›´æ¥ç§»é™¤ B, C ä¹‹é–“çš„ replication filterï¼Œå› ç‚º GTID ä¸æœƒé‡è¤‡åŸ·è¡Œä¸ç”¨åƒå‚³çµ± Position ä¸€æ¨£éœ€è¦ filter é¿å…é‡è¤‡åŸ·è¡Œã€‚\næˆªè‡ªå®˜æ–¹æ–‡æª”èªªæ˜ï¼š\nImportant: For a multi-source replica in a diamond topology (where the replica replicates from two or more sources, which in turn replicate from a common source), when GTID-based replication is in use, ensure that any replication filters or other channel configuration are identical on all channels on the multi-source replica. With GTID-based replication, filters are applied only to the transaction data, and GTIDs are not filtered out. This happens so that a replicaâ€™s GTID set stays consistent with the sourceâ€™s, meaning GTID auto-positioning can be used without re-acquiring filtered out transactions each time. In the case where the downstream replica is multi-source and receives the same transaction from multiple sources in a diamond topology, the downstream replica now has multiple versions of the transaction, and the result depends on which channel applies the transaction first. The second channel to attempt it skips the transaction using GTID auto-skip, because the transactionâ€™s GTID was added to theÂ gtid_executedÂ set by the first channel. With identical filtering on the channels, there is no problem because all versions of the transaction contain the same data, so the results are the same. However, with different filtering on the channels, the database can become inconsistent and replication can hang.\nMySQL :: MySQL 8.0 Reference Manual :: 17.2.5.4 Replication Channel Based Filters\n","date":"2025-03-27T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-gtid/","title":"GTID"},{"content":"FullText Index(å…¨æ–‡æª¢ç´¢) ngrame å…¨æ–‡è§£æå™¨\nMySQL å¾ 5.7.6 é–‹å§‹å…§å»º ngrame å…¨æ–‡è§£æå™¨ï¼Œç”¨ä¾†æ”¯æ´ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ“æ–‡åˆ†è©\nInnoDB Full-Text Index inverted index(å€’æ’ç´¢å¼•) inverted index ç¶“å¸¸è¢«ç”¨æ–¼å…¨æ–‡æª¢ç´¢ï¼ŒMySQL çš„ Full-Text Index ä¹Ÿæ˜¯åŸºæ–¼ inverted index ä¾†å¯¦ç¾çš„ã€‚\ninverted index å°‡æ–‡æª”ä¸­çš„ä¸é‡è¤‡å–®è©æ§‹æˆä¸€å€‹åˆ—è¡¨ï¼Œæ¯ä¸€å€‹å–®è©éƒ½æœƒè¨˜éŒ„åŒ…å«æ­¤å–®è©çš„æ–‡æª”åˆ—è¡¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 CREATE TABLE small_test( `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT \u0026#39;æµæ°´è™Ÿ\u0026#39;, `content` varchar(300) NOT NULL COMMENT \u0026#39;å…§æ–‡\u0026#39;, PRIMARY KEY (`id`), FULLTEXT KEY `content_index` (`content`) /*!50100 WITH PARSER `ngram` */ ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci; INSERT INTO small_test(content) VALUES (\u0026#39;æˆ‘æ˜¯å¼·æ£®\u0026#39;),(\u0026#39;é€™æ˜¯æ¸¬è©¦\u0026#39;),(\u0026#39;å¼·æ£®æ˜¯æˆ‘\u0026#39;); SET GLOBAL innodb_ft_aux_table = \u0026#39;johnson/small_test\u0026#39;; SELECT * FROM information_schema.INNODB_FT_INDEX_CACHE; +--------+--------------+-------------+-----------+--------+----------+ | WORD | FIRST_DOC_ID | LAST_DOC_ID | DOC_COUNT | DOC_ID | POSITION | +--------+--------------+-------------+-----------+--------+----------+ | å¼·æ£® | 2 | 4 | 2 | 2 | 6 | | å¼·æ£® | 2 | 4 | 2 | 4 | 0 | | æˆ‘æ˜¯ | 2 | 2 | 1 | 2 | 0 | | æ˜¯å¼· | 2 | 2 | 1 | 2 | 3 | | æ˜¯æˆ‘ | 4 | 4 | 1 | 4 | 6 | | æ˜¯æ¸¬ | 3 | 3 | 1 | 3 | 3 | | æ£®æ˜¯ | 4 | 4 | 1 | 4 | 3 | | æ¸¬è©¦ | 3 | 3 | 1 | 3 | 6 | | é€™æ˜¯ | 3 | 3 | 1 | 3 | 0 | +--------+--------------+-------------+-----------+--------+----------+ InnoDB Full-Text Index Tables åœ¨å»ºç«‹ Full-Text Index ä¹‹å¾Œï¼Œé‚„æœƒå‡ºç¾ä»¥ä¸‹ tableï¼š\n1 2 3 4 5 6 7 8 9 10 11 -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_0000000000000129_index_1.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_0000000000000129_index_2.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_0000000000000129_index_3.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_0000000000000129_index_4.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_0000000000000129_index_5.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_0000000000000129_index_6.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_being_deleted_cache.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_being_deleted.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_config.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_deleted_cache.ibd -rw-r-----. 1 mysql mysql 114688 Jun 30 09:05 fts_00000000000004a6_deleted.ibd å¯ä»¥åˆ†ç‚º 4 é¡ï¼\nindex_1~6ï¼šæ•¸é‡å›ºå®šæœƒæœ‰ 6 å€‹æ–‡ä»¶ç”¨æ–¼å„²å­˜å€’æ’ç´¢å¼•ï¼Œå„²å­˜çš„æ˜¯ wordsã€position å’Œ DOC_IDï¼Œæœƒæ ¹æ“š word é€²è¡Œæ’åºä¸¦åˆ†å€æ˜ å°„åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ã€‚ å€’æ’ç´¢å¼•åˆ†ç‚º 6 å€‹è¡¨ç”¨ä¾†æ”¯æŒ parallel index creationï¼Œé è¨­ç‚º 2 å€‹ç·šç¨‹ï¼Œç•¶åœ¨å¤§è¡¨å‰µå»º Full-Text Index æ™‚ï¼Œå¯ä»¥é€é innodb_ft_sort_pll_degree ä¾†èª¿å¤§ä½µè¡Œç·šç¨‹æ•¸ã€‚ deletedï¼šåŒ…å«è³‡æ–™å·²ç¶“åˆªé™¤çš„ DOC_IDï¼Œä½†é‚„æ²’å¾ Full-Text index ä¸­åˆªé™¤ã€‚ deleted_cacheï¼šç‚ºå‰è€…çš„å…§å­˜ç·©å­˜ã€‚ being_deletedï¼šåŒ…å«è³‡æ–™å·²ç¶“åˆªé™¤çš„ DOC_IDï¼Œä¸”ç•¶å‰æ­£åœ¨å¾ Full-Text index ä¸­åˆªé™¤ã€‚ being_deleted_cacheï¼šç‚ºå‰è€…çš„å…§å­˜ç·©å­˜ã€‚ configï¼šåŒ…å« Full-Text index çš„å…§éƒ¨ç‹€æ…‹è³‡è¨Šï¼Œæœ€é‡è¦çš„æ˜¯å…¶ä¸­æœ‰å„²å­˜ FTS_SYNCED_DOC_IDï¼Œè©²å€¼ç”¨ä¾†è¨˜éŒ„è§£æè¢«å¯«åˆ° disk çš„ DOC_IDï¼Œåœ¨å´©æ½°å›è¦†æ™‚æœƒæ ¹æ“šé€™å€‹å€¼åˆ¤æ–·å“ªäº› DOC éœ€è¦é‡æ–°è§£æä¸¦å°‡å…¶æ·»åŠ åˆ° Full-text index cacheï¼ŒæŸ¥è©¢ INFORMATION_SCHEMA.INNODB_FT_CONFIG å¯ä»¥æŸ¥çœ‹å…¶ä¸­çš„è³‡æ–™ã€‚ InnoDB Full-Text Index Cache InnoDB Full-Text Index DOC_ID and FTS_DOC_ID Column InnoDB éœ€è¦é€é DOC_ID ä¾†å°æ‡‰ Word æ‰€åœ¨çš„ç´€éŒ„ï¼Œå› æ­¤å»ºç«‹ Full-Text Index çš„æ™‚å€™ï¼Œä¹Ÿæœƒåœ¨è¡¨ä¸Šéš±å¼å»ºç«‹ä¸€å€‹ FTS_DOC_ID çš„æ¬„ä½ï¼Œè«‹åƒè€ƒä»¥ä¸‹äº‹ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 mysql\u0026gt; CREATE TABLE small_test_2( -\u0026gt; `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT \u0026#39;æµæ°´è™Ÿ\u0026#39;, -\u0026gt; `content` varchar(300) NOT NULL COMMENT \u0026#39;å…§æ–‡\u0026#39;, -\u0026gt; PRIMARY KEY (`id`) -\u0026gt; ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci; Query OK, 0 rows affected (0.03 sec) mysql\u0026gt; ALTER TABLE small_test_2 ADD FULLTEXT KEY `content_index` (`content`) /*!50100 WITH PARSER `ngram` */; Query OK, 0 rows affected, 1 warning (0.11 sec) Records: 0 Duplicates: 0 Warnings: 1 mysql\u0026gt; show warnings\\G *************************** 1. row *************************** Level: Warning Code: 124 Message: InnoDB rebuilding table to add column FTS_DOC_ID mysql\u0026gt; show extended columns from small_test_2; +-------------+--------------+------+-----+---------+----------------+ | Field | Type | Null | Key | Default | Extra | +-------------+--------------+------+-----+---------+----------------+ | id | int unsigned | NO | PRI | NULL | auto_increment | | content | varchar(300) | NO | MUL | NULL | | | FTS_DOC_ID | | NO | | NULL | | | DB_TRX_ID | | NO | | NULL | | | DB_ROLL_PTR | | NO | | NULL | | +-------------+--------------+------+-----+---------+----------------+ 5 rows in set (0.00 sec) å› æ­¤åœ¨è©²è¡¨ä¸Šå»ºç«‹ç¬¬ä¸€å€‹ Full-Text Index éœ€è¦é‡å»ºè¡¨ï¼Œå¦‚æœæƒ³è¦é¿å…é‡å»ºè¡¨å¯ä»¥åœ¨ CREATE TABLE æ™‚é å…ˆå»ºç«‹æ­¤æ¬„ä½ï¼Œå¦‚ä¸‹äº‹ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 mysql\u0026gt; CREATE TABLE small_test_3( -\u0026gt; `FTS_DOC_ID` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT, -\u0026gt; `content` varchar(300) NOT NULL COMMENT \u0026#39;å…§æ–‡\u0026#39;, -\u0026gt; PRIMARY KEY (`FTS_DOC_ID`) -\u0026gt; ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci; Query OK, 0 rows affected (0.12 sec) mysql\u0026gt; alter table small_test_3 add FULLTEXT KEY `content_index` (`content`) /*!50100 WITH PARSER `ngram` */; Query OK, 0 rows affected (0.36 sec) Records: 0 Duplicates: 0 Warnings: 0 åˆªé™¤ Full-Text Index æ™‚ï¼Œç‚ºäº†é¿å…ä¸‹æ¬¡å»ºç«‹æ™‚éœ€é‡å»ºè¡¨ï¼Œå› æ­¤ä¸æœƒç§»é™¤ FTS_DOC_ID æ¬„ä½ã€‚\nInnoDB Full-Text Index delete handling ç‚ºäº†é¿å… delete åŸè¡¨è³‡æ–™æ™‚ï¼Œåœ¨ç´¢å¼•è¡¨ä¸­å‡ºç¾å¤§é‡çš„ delete å¼•ç™¼è³‡æºçˆ­ç”¨çš„å•é¡Œï¼Œå·²åˆªé™¤çš„ DOC_ID æœƒè¢«è¨˜éŒ„åœ¨ deleted è¡¨ä¸­ä¸”ä¸æœƒåœ¨ç´¢å¼•è¡¨ä¸­ç§»å‡ºï¼Œè€Œæ˜¯æœƒåœ¨è¿”å›æŸ¥è©¢çµæœä¹‹å‰ï¼Œé€é deleted è¡¨ä¾†éæ¿¾å·²åˆªé™¤çš„ DOC_IDã€‚å¯ä»¥é€éè¨­ç½® innodb_optimize_fulltext_only = ON å¾ŒåŸ·è¡Œ OPTIMIZE TABLE ä¾†é‡å»º Full-Text Index ä¾†ç§»é™¤å·²åˆªé™¤ DOC_ID çš„ç´¢å¼•ï¼Œé€™äº›æœƒè¢«è½‰å­˜åˆ° being_deleted æª”æ¡ˆä¸­ã€‚\nInnoDB Full-Text Index Transaction Handling InnoDB Full-Text Indexes ç›¸é—œ TABLE information_schema ä¸‹æœ‰æä¾›è§€å¯Ÿ Full-Text Index çš„è¡¨ï¼Œåœ¨ä½¿ç”¨å‰é ˆè¦å…ˆè¨­å®š innodb_ft_aux_table èª¿æ•´ç‚ºæƒ³è¦è§€å¯Ÿçš„è¡¨ï¼Œå¦å‰‡é™¤äº† INNODB_FT_DEFAULT_STOPWORD ä»¥å¤–éƒ½æœƒæ˜¯ emptyã€‚\n1 SET GLOBAL innodb_ft_aux_table = \u0026#39;database_name/table_name\u0026#39;; å…±æœ‰ä»¥ä¸‹ 6 å¼µè¡¨ï¼\nINNODB_FT_CONFIGï¼š INNODB_FT_INDEX_TABLE INNODB_FT_INDEX_CACHE INNODB_FT_DEFAULT_STOPWORD INNODB_FT_DELETED INNODB_FT_BEING_DELETED å…¨æ–‡æª¢ç´¢æ¨¡å¼ IN NATURAL LANGUAGE MODE (è‡ªç„¶èªè¨€æ¨¡å¼) æ­¤ç‚ºé»˜èªçš„æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 mysql\u0026gt; select * from small_test; +----+-----------------------------+ | id | content | +----+-----------------------------+ | 1 | MySQL çš„å…¨æ–‡æª¢ç´¢æ¸¬è©¦ | | 2 | MySQL vs Solr | | 3 | Solr çš„å…¨æ–‡æª¢ç´¢ | | 4 | ES çš„å…¨æ–‡æª¢ç´¢ | +----+-----------------------------+ 4 rows in set (0.00 sec) mysql\u0026gt; SELECT * FROM small_test -\u0026gt; WHERE MATCH(`content`) -\u0026gt; AGAINST (\u0026#39;MySQL\u0026#39;); +----+-----------------------------+ | id | content | +----+-----------------------------+ | 1 | MySQL çš„å…¨æ–‡æª¢ç´¢æ¸¬è©¦ | | 2 | MySQL vs Solr | +----+-----------------------------+ 2 rows in set (0.01 sec) IN Boolean 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 mysql\u0026gt; select * from small_test; +----+-----------------------------+ | id | content | +----+-----------------------------+ | 1 | MySQL çš„å…¨æ–‡æª¢ç´¢æ¸¬è©¦ | | 2 | MySQL vs Solr | | 3 | Solr çš„å…¨æ–‡æª¢ç´¢ | | 4 | ES çš„å…¨æ–‡æª¢ç´¢ | +----+-----------------------------+ 4 rows in set (0.00 sec) mysql\u0026gt; SELECT * FROM small_test -\u0026gt; WHERE MATCH(`content`) -\u0026gt; AGAINST (\u0026#39;+Mysql -Solr\u0026#39; IN BOOLEAN MODE); +----+-----------------------------+ | id | content | +----+-----------------------------+ | 1 | MySQL çš„å…¨æ–‡æª¢ç´¢æ¸¬è©¦ | +----+-----------------------------+ 1 row in set (0.00 sec) With Query Expansion (æŸ¥è©¢æ“´å±•) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 mysql\u0026gt; SELECT * FROM small_test; +----+-----------------------------+ | id | content | +----+-----------------------------+ | 1 | MySQL çš„å…¨æ–‡æª¢ç´¢æ¸¬è©¦ | | 2 | MySQL vs Solr | | 3 | Solr çš„å…¨æ–‡æª¢ç´¢ | | 4 | ES çš„å…¨æ–‡æª¢ç´¢ | | 5 | æˆ‘æ˜¯ç„¡è¾œçš„ | +----+-----------------------------+ 5 rows in set (0.00 sec) mysql\u0026gt; SELECT * -\u0026gt; FROM small_test -\u0026gt; WHERE MATCH(`content`) -\u0026gt; AGAINST (\u0026#39;MySQL\u0026#39; WITH QUERY EXPANSION); +----+-----------------------------+ | id | content | +----+-----------------------------+ | 1 | MySQL çš„å…¨æ–‡æª¢ç´¢æ¸¬è©¦ | | 2 | MySQL vs Solr | | 3 | Solr çš„å…¨æ–‡æª¢ç´¢ | | 4 | ES çš„å…¨æ–‡æª¢ç´¢ | +----+-----------------------------+ 4 rows in set (0.00 sec) é™åˆ¶ æœ‰åˆ‡ partition çš„è¡¨ä¸æ”¯æ´ FullText index\nåƒè€ƒ MySQL :: MySQL 8.0 Reference Manual :: 15.6.2.4 InnoDB Full-Text Indexes\nMySQL :: MySQL 8.0 Reference Manual :: 12.10 Full-Text Search Functions\nhttp://mysql.taobao.org/monthly/2015/10/01/\nhttps://iter01.com/523515.html\nhttps://database.51cto.com/art/202010/630055.htm\nmysqlä¸­æ–‡å…¨æ–‡æ£€ç´¢ä»å…¥é—¨åˆ°æ”¾å¼ƒ_å¼¹æŒ‡å¤©ä¸‹-CSDNåšå®¢\n","date":"2024-12-01T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-fulltext-index/","title":"MySQL FullText Index(å…¨æ–‡æª¢ç´¢)"},{"content":"analyzer åˆ†è©å™¨ ä»€éº¼æ˜¯åˆ†è©ï¼Ÿç‚ºä»€éº¼éœ€è¦åˆ†è©å™¨ï¼Ÿ æœå°‹å¼•æ“çš„ç›®çš„æ˜¯ç”¨ä¾†æ–‡æœ¬æœå°‹ï¼Œç‚ºäº†æ›´é«˜æ•ˆç‡çš„æœå°‹éœ€è¦å»ºç«‹å€’æ’ç´¢å¼•ï¼Œè€Œå»ºç«‹å€’æ’ç´¢å¼•å°±éœ€è¦åˆ†è©é€™å€‹å‹•ä½œï¼Œå°‡æ–‡æœ¬åˆ‡åˆ†æˆä¸€å€‹ä¸€å€‹çš„å–®è©ä¸¦é€²è¡Œä¸€äº›é¡å¤–åŠ å·¥ä¾†å»ºç«‹é«˜æ•ˆçš„ç´¢å¼•ã€‚\nAnalyzer åˆ†è©å™¨ ä¸€å€‹ analyzer ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†çµ„æˆï¼š\n0\u0026hellip;N å€‹ Character Filtersï¼šå°è¼¸å…¥çš„ text é€²è¡Œé è™•ç†ã€‚ 1 å€‹ Tokenizerï¼šé€²è¡Œåˆ†è©ã€‚ 0\u0026hellip;N å€‹ Token Filtersï¼šå°åˆ†è©å¾Œçš„çµæœåŠ å·¥ã€‚ ä¸‹åœ–å±•ç¤ºäº† analyzer ç‚ºä¸€å€‹æ–‡æœ¬å»ºç«‹ç´¢å¼•çš„éç¨‹ï¼š\nCharacter Filters åœ¨å°‡ text å‚³éçµ¦ Tokenizer ä¹‹å‰ï¼Œæœƒå…ˆäº¤ç”± Character Filter é€²è¡Œé è™•ç†ã€‚ä¾‹å¦‚ï¼šå»é™¤ HTML æ¨™ç±¤ã€å­—ä¸²æ›¿æ›\u0026hellip;\u0026hellip;ç­‰ã€‚\nElasticsearch æä¾›ä»¥ä¸‹å…§å»ºçš„ Character Filterï¼š\nHTML Strip Character Filterï¼šå»é™¤ text ä¸­çš„ HTML æ¨™ç±¤ï¼Œä¸¦ä½¿ç”¨è§£ç¢¼å€¼å–ä»£ HTML å¯¦é«”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 GET /_analyze { \u0026#34;tokenizer\u0026#34;: \u0026#34;keyword\u0026#34;, \u0026#34;char_filter\u0026#34;: [ \u0026#34;html_strip\u0026#34; ], \u0026#34;text\u0026#34;: \u0026#34;\u0026lt;p\u0026gt;I\u0026amp;apos;m so \u0026lt;b\u0026gt;happy\u0026lt;/b\u0026gt;!\u0026lt;/p\u0026gt;\u0026#34; } resultï¼š [ \\nI\u0026#39;m so happy!\\n ] Mapping Character Filterï¼šå°‡ç¬¦åˆè¨­å®šçš„å­—ä¸²æ›¿æ›æˆåˆ¥çš„å­—ä¸²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 GET /_analyze { \u0026#34;tokenizer\u0026#34;: \u0026#34;keyword\u0026#34;, \u0026#34;char_filter\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;mapping\u0026#34;, \u0026#34;mappings\u0026#34;: [ \u0026#34;:) =\u0026gt; _happy_\u0026#34;, \u0026#34;:( =\u0026gt; _sad_\u0026#34; ] } ], \u0026#34;text\u0026#34;: \u0026#34;I\u0026#39;m delighted about it :(\u0026#34; } resultï¼š [ I\u0026#39;m delighted about it _sad_ ] Pattern Replace Character Filterï¼šé€éæ­£å‰‡è¡¨é”å¼é€²è¡Œæ›¿æ›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 GET /_analyze { \u0026#34;tokenizer\u0026#34;: \u0026#34;keyword\u0026#34;, \u0026#34;char_filter\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;pattern_replace\u0026#34;, \u0026#34;pattern\u0026#34;: \u0026#34;(\\\\d+)-(?=\\\\d)\u0026#34;, \u0026#34;replacement\u0026#34;: \u0026#34;$1_\u0026#34; } , \u0026#34;text\u0026#34;: \u0026#34;My credit card is 123-456-789\u0026#34; } resultï¼š [ My credit card is 123_456_789 ] Tokenizer æ¥æ”¶ä¾†è‡ª Character Filter è™•ç†å¾Œçš„çµæœï¼Œä¸¦å°‡å…¶åˆ‡åˆ†ç‚ºä¸€å€‹ä¸€å€‹ terms/tokens (é€šå¸¸æ˜¯ä¸€å€‹å–®è©)ã€‚ä¾‹å¦‚ï¼šTime is money æœƒè¢«åˆ‡åˆ†ç‚º [ Time, is, money ]ã€‚\nTokenizer é™¤äº†é€²è¡Œåˆ‡åˆ†ï¼ŒåŒæ™‚é‚„æœƒè¨˜éŒ„ä»¥ä¸‹è³‡è¨Šï¼š\npositionï¼šç´€éŒ„ terms/tokens æ‰€åœ¨çš„ä½ç½®é †åºï¼Œç”¨æ–¼ phrase å’Œ word proximity Queryã€‚ start_offsetã€end_offsetï¼šç´€éŒ„ terms/tokens çš„é–‹å§‹å’ŒçµæŸä½ç½®ï¼Œç”¨æ–¼ highlight æœå°‹çµæœã€‚ typeï¼šç´€éŒ„ token type ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;é‡‘é’±åªæ˜¯ä¸€å †æ•°å­—ã€‚\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;ik_smart\u0026#34; } resultï¼š { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;é‡‘é’±\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 2, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;åªæ˜¯\u0026#34;, \u0026#34;start_offset\u0026#34; : 2, \u0026#34;end_offset\u0026#34; : 4, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€å †\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;æ•°å­—\u0026#34;, \u0026#34;start_offset\u0026#34; : 6, \u0026#34;end_offset\u0026#34; : 8, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 3 } ] } Token Filters æ¥æ”¶ä¾†è‡ª Tokenizer çš„ç”¢å‡ºçš„ terms/tokens ä¸¦é€²è¡Œèª¿æ•´ï¼Œä¾‹å¦‚ï¼šè½‰å°å¯«ã€åˆªé™¤ stopwords (åœç”¨è©)ã€æ·»åŠ  synonyms (åŒç¾©è©)ã€‚\nä»¥ä¸‹ç¯„ä¾‹ç‚ºè½‰å°å¯«çš„ Token filterï¼š\n1 2 3 4 5 6 7 8 9 GET _analyze { \u0026#34;tokenizer\u0026#34; : \u0026#34;standard\u0026#34;, \u0026#34;filter\u0026#34; : [\u0026#34;lowercase\u0026#34;], \u0026#34;text\u0026#34; : \u0026#34;THE Quick FoX JUMPs\u0026#34; } resultï¼š [ the, quick, fox, jumps ] ä¸­æ–‡åˆ†è© é›£é» è‹±æ–‡æœ¬èº«ä»¥å–®è©ç‚ºå–®ä½ï¼Œå–®è©èˆ‡å–®è©ä¹‹é–“é€šå¸¸æ˜¯ç©ºæ ¼ã€é€—è™Ÿå’Œå¥è™Ÿåˆ†éš”ï¼Œå› æ­¤å°èˆ‡è‹±æ–‡ä¾†èªªå¯ä»¥å¾ˆç°¡å–®çš„é€²è¡Œåˆ†è©ï¼Œä¾‹å¦‚ä»¥ä¸‹ä¾‹å­ï¼š\nå¯ä»¥çœ‹åˆ°åˆ†å‡ºäº† timeã€isã€money é€™ä¸‰å€‹åˆ†è©ä¾†å»ºç«‹å¯¦ç”¨çš„ç´¢å¼•ã€‚\nä½†ä¸åŒçš„æ˜¯ä¸­æ–‡æ˜¯ä»¥å­—ç‚ºå–®ä½ï¼Œå†ç”±å¤šå€‹å­—çµ„æˆä¸€å€‹å–®è©ï¼Œå–®è©å‰‡æœƒé€£è²«åœ¨ä¸€èµ·çµ„æˆå¥å­ï¼Œå› æ­¤ä¸¦ä¸é©ç”¨æ–¼è‹±æ–‡çš„åˆ†è©æ–¹å¼ï¼Œä¹Ÿå› ç‚ºé€™æ¨£å¦‚æœä¸ä½¿ç”¨ç‚ºä¸­æ–‡è¨­è¨ˆçš„åˆ†è©å™¨ï¼Œå‰‡æœƒä½¿ç”¨ ä¸€å…ƒåˆ‡åˆ†æ³• ä¹Ÿå°±æ˜¯ä¸€å€‹å­—å–®ç¨åšç‚ºä¸€å€‹ç´¢å¼•ï¼Œä¾‹å¦‚ä»¥ä¸‹ä¾‹å­ï¼š\nä¸Šè¿°ä¾‹å­ä¸­ä¸€å€‹å­—åšç‚ºä¸€å€‹å–®ç¨çš„ç´¢å¼•ï¼Œä½†ä½¿ç”¨è€…å¾ˆå¯èƒ½æ˜¯ç”¨ æ™‚é–“ é€™å€‹å–®è©å»æœå°‹ï¼Œå› æ­¤ä¸Šè¿°çš„ä¾‹å­æŸ¥è©¢æ•ˆç‡ä¸¦ä¸æ˜¯å¾ˆå¥½ï¼ˆä½†é©ç”¨æ–¼å„ç¨®èªè¨€ï¼‰ï¼Œå› æ­¤é‚„æœ‰ä¸€ç¨®æ˜¯å›ºå®šå°‡å¤šå€‹å­—è¦–ç‚ºä¸€å€‹å–®è©ï¼\nLucene æä¾›çš„ CJKAnalyzerï¼šé€™æ˜¯ä¸€å€‹ äºŒå…ƒåˆ‡åˆ†æ³• çš„åˆ†è©å™¨ï¼Œä¾‹å¦‚ï¼šæ™‚é–“å°±æ˜¯é‡‘éŒ¢ï¼Œé€™å€‹ä¾‹å­æœƒè¢«åˆ‡åˆ†ç‚º æ™‚é–“ã€é–“å°±ã€å°±æ˜¯ã€æ˜¯é‡‘ã€é‡‘éŒ¢ã€‚\nMySQL å…¨æ–‡æª¢ç´¢ä¸­çš„ N-gramï¼šé€é ngram_token_size åƒæ•¸ä¾†æ±ºå®šå°‡å¹¾å€‹å­—è¦–ç‚ºä¸€å€‹å–®è©ï¼Œå› æ­¤é è¨­å€¼ 2 å°±ç­‰åŒæ–¼ä¸Šæ–¹ä»‹ç´¹çš„ äºŒå…ƒåˆ‡åˆ†æ³•ï¼Œå‡è¨­å°‡å…¶è¨­ç‚º 3 å‰‡æ™‚é–“å°±æ˜¯é‡‘éŒ¢ï¼Œé€™å€‹ä¾‹å­æœƒè¢«åˆ‡åˆ†ç‚º æ™‚é–“å°±ã€é–“å°±æ˜¯ã€å°±æ˜¯é‡‘ã€æ˜¯é‡‘éŒ¢ã€‚\né›–ç„¶ç›¸è¼ƒæ–¼ ä¸€å…ƒåˆ‡åˆ†æ³• å¥½äº†é»ï¼Œä½†é‚„æ˜¯æœƒæœ‰è¨±å¤šä¸é©ç”¨çš„ç´¢å¼•ï¼Œå› æ­¤å°±æœ‰äº†å…¶ä»–å°ˆé–€é‡å°ä¸­æ–‡è™•ç†çš„åˆ†è©å™¨è¢«è¨­è¨ˆå‡ºä¾†ï¼Œè€Œæˆ‘å€‘ä½¿ç”¨æœå°‹å¼•æ“çš„æ™‚å€™å°±æœƒéœ€è¦é€™äº›ä¸­æ–‡åˆ†è©å™¨çš„å¹«åŠ©ã€‚\nLucene æ ¸å¿ƒ analyzer æ’ä»¶ SmartCN ä¸­è‹±æ··åˆçš„åˆ†è©å™¨ï¼Œè©²åˆ†è©å™¨é‡å°ç°¡é«”ä¸­æ–‡æœ‰è¼ƒå¥½çš„åˆ†è©çµæœï¼Œå°ç¹é«”ä¸­æ–‡æ”¯æ´ä¸å¥½ã€‚\n1 2 âœ ~ bin/elasticsearch-plugin install analysis-smartcn âœ ~ systemctl restart elasticsearch æ¸¬è©¦(å±•é–‹æŸ¥çœ‹)\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°\u0026#34;, \u0026#34;tokenizer\u0026#34;: \u0026#34;smartcn_tokenizer\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¨Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 3, \u0026#34;end_offset\u0026#34; : 4, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 6, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 8, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 8, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;è˜‡\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 10, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 10, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸ\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 13, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 13, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 14, \u0026#34;end_offset\u0026#34; : 15, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 17, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆ\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 20, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 20, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 22, \u0026#34;end_offset\u0026#34; : 23, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 26, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 26, \u0026#34;end_offset\u0026#34; : 27, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 27, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 28, \u0026#34;end_offset\u0026#34; : 29, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 30, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 30, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;å”\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 33, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¼¯\u0026#34;, \u0026#34;start_offset\u0026#34; : 33, \u0026#34;end_offset\u0026#34; : 34, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 34, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 35, \u0026#34;end_offset\u0026#34; : 36, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;è »\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 38, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;æ©«\u0026#34;, \u0026#34;start_offset\u0026#34; : 38, \u0026#34;end_offset\u0026#34; : 39, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 34 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 40, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 35 }, { \u0026#34;token\u0026#34; : \u0026#34;ç•™\u0026#34;, \u0026#34;start_offset\u0026#34; : 40, \u0026#34;end_offset\u0026#34; : 41, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 36 }, { \u0026#34;token\u0026#34; : \u0026#34;æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 41, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 37 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 42, \u0026#34;end_offset\u0026#34; : 43, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 38 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 44, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 39 }, { \u0026#34;token\u0026#34; : \u0026#34;çµ\u0026#34;, \u0026#34;start_offset\u0026#34; : 44, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 40 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 41 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®\u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 48, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 42 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 48, \u0026#34;end_offset\u0026#34; : 49, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 43 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 49, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 44 }, { \u0026#34;token\u0026#34; : \u0026#34;,\u0026#34;, \u0026#34;start_offset\u0026#34; : 50, \u0026#34;end_offset\u0026#34; : 51, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 45 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 46 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 47 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 54, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 48 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 54, \u0026#34;end_offset\u0026#34; : 55, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 49 }, { \u0026#34;token\u0026#34; : \u0026#34;å¥ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 55, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 50 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 51 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 52 } ] } ICU æ·»åŠ  ICU libraries æ“´å±•å° unicode æ”¯æŒï¼Œä¸¦èƒ½æ›´å¥½çš„åˆ†æäºæ´²èªè¨€ï¼Œå°æ–¼ç¹é«”ä¸­æ–‡åˆ†è©ä¾†èªªæ•ˆæœæ¯” SmartCN å¥½å¾ˆå¤šã€‚\n1 2 âœ ~ bin/elasticsearch-plugin install analysis-icu âœ ~ systemctl restart elasticsearch æ¸¬è©¦\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°\u0026#34;, \u0026#34;tokenizer\u0026#34;: \u0026#34;icu_tokenizer\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¨Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 6, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;è˜‡å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸ\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 13, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 13, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 17, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆæœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 26, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 26, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 30, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 30, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;è »æ©«\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 39, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾çµ\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®\u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 48, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 48, \u0026#34;end_offset\u0026#34; : 49, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 49, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 55, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;å¥ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 55, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 34 } ] } ç¤¾ç¾¤è²¢ç» analyzer æ’ä»¶ ik https://github.com/medcl/elasticsearch-analysis-ik\nIK æ˜¯ç¤¾ç¾¤éå¸¸æ´»èºçš„ä¸­æ–‡åˆ†è©ï¼ŒåŸºæœ¬ä¸Šæœå°‹ä¸­æ–‡åˆ†è©å¤§éƒ¨åˆ†éƒ½æœƒæ¨è–¦ IKã€‚\nä¸éæ¸¬è©¦ç™¼ç¾ ik ä¸»è¦ä¹Ÿæ˜¯é‡å°ç°¡é«”ä¸­æ–‡çš„ï¼Œä¾‹å¦‚ï¼šç¹é«” é‡‘éŒ¢ ä½¿ç”¨ IK æœƒè¢«æ‹†åˆ†ç‚º é‡‘ã€éŒ¢ï¼Œåªæœ‰ç°¡é«”çš„ é‡‘é’± æœƒè¢«è¦–ç‚ºä¸€å€‹ tokenã€‚\nä¸éé€™æ–¹é¢ ik-analyzer-solr å› ç‚ºé‚„æ“´å……äº†å…¶ä»–è©åº«ï¼Œæ‰€ä»¥æ•ˆæœæ˜¯å„ªæ–¼ elasticsearch-analysis-ikã€‚\n1 2 3 4 5 6 7 8 9 10 11 âœ ~ cd /usr/share/elasticsearch/plugins âœ ~ mkdir analysis-ik âœ ~ cd analysis-ik # å®‰è£ unzip ç”¨ä¾†è§£å£“ç¸® zip âœ ~ yum install -y unzip # ä¸‹è¼‰ä¸¦è§£å£“ç¸® âœ ~ wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.15.2/elasticsearch-analysis-ik-7.15.2.zip âœ ~ unzip elasticsearch-analysis-ik-7.15.2.zip âœ ~ rm elasticsearch-analysis-ik-7.15.2.zip # é‡å•Ÿ elastic âœ ~ systemctl restart elasticsearch æ¸¬è©¦\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°\u0026#34;, \u0026#34;tokenizer\u0026#34;: \u0026#34;ik_max_word\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¨Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;äººæœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 5, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;è˜‡\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 10, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 10, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸ\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 13, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 13, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸­æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 16, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆæœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 26, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 26, \u0026#34;end_offset\u0026#34; : 27, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 27, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 30, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 30, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;è »\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 38, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;æ©«\u0026#34;, \u0026#34;start_offset\u0026#34; : 38, \u0026#34;end_offset\u0026#34; : 39, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸ç•™\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 41, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 40, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 44, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;çµ\u0026#34;, \u0026#34;start_offset\u0026#34; : 44, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®\u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 48, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 48, \u0026#34;end_offset\u0026#34; : 49, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 49, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 34 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 35 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 36 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 55, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 37 }, { \u0026#34;token\u0026#34; : \u0026#34;å¥ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 55, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 38 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 39 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 40 } ] } stconvert https://github.com/medcl/elasticsearch-analysis-stconvert\nåš´æ ¼ä¾†èªªé€™åªæ˜¯ä¸€å€‹ filterï¼Œå› ç‚º stconvert ä¸æœƒé€²è¡Œåˆ†è©çš„å‹•ä½œï¼Œä»–åªæœƒå°‡å­—é€²è¡Œç¹ç°¡è½‰æ›ã€‚\n1 2 3 4 5 6 âœ ~ cd /usr/share/elasticsearch/plugins âœ ~ mkdir analysis-stconvert âœ ~ cd analysis-stconvert âœ ~ wget https://github.com/medcl/elasticsearch-analysis-stconvert/releases/download/v7.15.2/elasticsearch-analysis-stconvert-7.15.2.zip âœ ~ unzip elasticsearch-analysis-stconvert-7.15.2.zip âœ ~ systemctl restart elasticsearch æ¸¬è©¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 PUT /stconvert/ { \u0026#34;settings\u0026#34; : { \u0026#34;analysis\u0026#34; : { \u0026#34;analyzer\u0026#34; : { \u0026#34;tsconvert\u0026#34; : { \u0026#34;tokenizer\u0026#34; : \u0026#34;tsconvert\u0026#34; } }, \u0026#34;tokenizer\u0026#34; : { \u0026#34;tsconvert\u0026#34; : { \u0026#34;type\u0026#34; : \u0026#34;stconvert\u0026#34;, \u0026#34;delimiter\u0026#34; : \u0026#34;#\u0026#34;, \u0026#34;keep_both\u0026#34; : false, \u0026#34;convert_type\u0026#34; : \u0026#34;t2s\u0026#34; } }, \u0026#34;filter\u0026#34;: { \u0026#34;tsconvert\u0026#34; : { \u0026#34;type\u0026#34; : \u0026#34;stconvert\u0026#34;, \u0026#34;delimiter\u0026#34; : \u0026#34;#\u0026#34;, \u0026#34;keep_both\u0026#34; : false, \u0026#34;convert_type\u0026#34; : \u0026#34;t2s\u0026#34; } }, \u0026#34;char_filter\u0026#34; : { \u0026#34;tsconvert\u0026#34; : { \u0026#34;type\u0026#34; : \u0026#34;stconvert\u0026#34;, \u0026#34;convert_type\u0026#34; : \u0026#34;t2s\u0026#34; } } } } } GET /stconvert/_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œ å®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;tsconvert\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¦€å¤«äººï¼Œå°äººæœ¬ä½åœ¨è‹å·çš„åŸè¾¹ï¼Œ å®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»ä¹æ— è¾¹ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 30, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 0 } ] } jieba https://github.com/sing1ee/elasticsearch-jieba-plugin\næ”¯æ´ç¹é«”ä¸­æ–‡ï¼Œä½†æ–‡æª”ä¸å‹å–„ã€‚\nåœ¨ github https://github.com/fxsjy/jieba ä¸Šä¹Ÿæœ‰æä¾›å°ç¹é«”åˆ†è©æ›´å¥½çš„å­—å…¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # å®‰è£ gradle wget https://services.gradle.org/distributions/gradle-7.3.1-bin.zip mkdir /opt/gradle unzip ./gradle-7.3.1-bin.zip -d /opt/gradle export PATH=$PATH:/opt/gradle/gradle-7.3.1/bin # clone æ­¤æ­¥é©Ÿéœ€è¦é…ç½® github sshkey âœ ~ git clone https://github.com/sing1ee/elasticsearch-jieba-plugin.git --recursive âœ ~ cd elasticsearch-jieba-plugin âœ ~ git submodule foreach --recursive git checkout master # æ ¹æ“š elasticsearch ç‰ˆæœ¬èª¿æ•´è¨­å®šæª”å…§çš„ç‰ˆæœ¬è™Ÿ âœ ~ vim build.gradle version = \u0026#39;7.15.2\u0026#39; // é€‚é…ä¸é€šç‰ˆæœ¬çš„ESï¼Œå¯ä»¥ä¿®æ”¹è¿™é‡Œã€‚ implementation \u0026#39;org.elasticsearch:elasticsearch:7.15.2\u0026#39; // é€‚é…ä¸é€šç‰ˆæœ¬çš„ESï¼Œå¯ä»¥ä¿®æ”¹è¿™é‡Œã€‚ âœ ~ vim ./src/main/resources/plugin-descriptor.properties # \u0026#39;version\u0026#39;: plugin\u0026#39;s version version=7.15.2 # \u0026#39;elasticsearch.version\u0026#39; version of elasticsearch compiled against elasticsearch.version=7.15.2 # ä½¿ç”¨ gradle æ‰“åŒ… âœ ~ gradle wrapper BUILD SUCCESSFUL in 1s 1 actionable task: 1 executed âœ ~ ./gradlew pz BUILD SUCCESSFUL in 32s 7 actionable tasks: 7 executed # è§£å£“ç¸®æ‰“åŒ…æª” âœ ~ ls ./build/distributions/ elasticsearch-jieba-plugin-7.15.2.zip âœ ~ unzip ./build/distributions/elasticsearch-jieba-plugin-7.15.2.zip -d /usr/share/elasticsearch/plugins/ # é‡å•Ÿ elasticserach âœ ~ systemctl restart elasticsearch æ¸¬è©¦\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;æ™‚é–“å°±æ˜¯é‡‘éŒ¢ï¼Œé‡‘éŒ¢åªæ˜¯ä¸€å †æ•¸å­—\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;jieba_index\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;æ™‚é–“\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 2, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å°±æ˜¯\u0026#34;, \u0026#34;start_offset\u0026#34; : 2, \u0026#34;end_offset\u0026#34; : 4, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;é‡‘éŒ¢\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 6, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;é‡‘éŒ¢\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;åªæ˜¯\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€å †\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 13, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;æ•¸å­—\u0026#34;, \u0026#34;start_offset\u0026#34; : 13, \u0026#34;end_offset\u0026#34; : 15, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 7 } ] } THULAC https://github.com/microbun/elasticsearch-thulac-plugin\nç”±æ¸…è¯å¤§å­¸è‡ªç„¶èªè¨€è™•ç†èˆ‡ç¤¾æœƒäººæ–‡è¨ˆç®—å¯¦é©—å®¤ç ”è£½çš„ä¸€å¥—ä¸­æ–‡è©æ³•åˆ†æå·¥å…·åŒ…ã€‚\nåˆ°å®˜æ–¹ demo è©¦ç”¨äº†ä¸€ä¸‹ï¼Œå¯ä»¥ç™¼ç¾å°±ç®—æ˜¯ç¹é«”ä¸­æ–‡æ•ˆæœä¹Ÿéå¸¸å¥½ï¼š\nä¸éçœ‹äº†ä¸€ä¸‹ PRO ç‰ˆæœ¬æ˜¯éœ€è¦æäº¤ç”³è«‹æ›¸çš„ï¼Œæ‰€ä»¥åªèƒ½ç”¨ Lite ç‰ˆæœ¬å°‡å°±ä¸€ä¸‹äº†\nElasticsearch Lite ç‰ˆæœ¬æ¸¬è©¦çµæœï¼Œé›–ç„¶æ²’æœ‰ PRO é‚£éº¼å²å®³ï¼Œä½†æ˜¯æ•ˆæœé‚„å¯ä»¥ã€‚(å±•é–‹æŸ¥çœ‹)\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œ å®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°ã€‚æˆ‘çˆºçˆºè·Ÿä»–ä¾†ç¿»è‡‰ï¼Œæ…˜è¢«ä»–ä¸€æ£ä¾†æ‰“æ‰ï¼Œ æˆ‘å¥¶å¥¶ç½µä»–æ¬ºé¨™å–„æ°‘ï¼Œåè¢«ä»–æ‰é€²äº†å”åºœï¼Œ å¼·å§¦äº†ä¸€ç™¾éï¼Œä¸€ç™¾éï¼Œæœ€å¾Œå¥¹æ‡¸æ¨‘è‡ªç›¡éºæ¨äººé–“ã€‚ ä»–é‚„å°‡æˆ‘çˆ¶å­ï¼Œé€å‡ºäº†å®¶åœ’ï¼Œæµè½åˆ°æ±Ÿé‚Šã€‚æˆ‘ç‚ºæ±‚é¤Šè€çˆ¹ï¼Œåªæœ‰ç¨è‡ªè¡Œä¹åœ¨å»Ÿå‰ã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–å¯¦åœ¨å¤ªé™°éšª çŸ¥é“æ­¤æƒ…å½¢ï¼Œç«Ÿæ´¾äººä¾†æš—ç®—ï¼ŒæŠŠæˆ‘çˆ¶å­ç‹‚æ¯†åœ¨å¸‚å‰ï¼Œå°äººèº«å£¯å¥ï¼Œæ®˜å‘½å¾—ç•™å­˜ï¼Œå¯æ†è€çˆ¶ä»–é­‚æ­¸å¤©!æ­¤æ¨æ›´é›£å¡«ã€‚ç‚ºæ±‚è‘¬è€çˆ¹ï¼Œå”¯æœ‰è³£èº«ç‚ºå¥´è‡ªä½œè³¤ï¼Œ ä¸€é¢å‹¤è³ºéŒ¢ï¼Œä¸€é¢è®€æ›¸ç¯‡ï¼Œ ç™¼èª“æŠŠåŠŸåé¡¯ï¼Œæ‰‹åˆƒä»‡äººæ„å¿—å …! å¾æ­¤å”å¯…è©©é›†ä¼´èº«é‚Šï¼Œæˆ‘éŠ˜è¨˜æ­¤ä»‡ä¸å…±æˆ´å¤©!!!\u0026#34;, \u0026#34;tokenizer\u0026#34;: \u0026#34;thulac\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 1126 1127 1128 1129 1130 1131 1132 1133 1134 1135 1136 1137 1138 1139 1140 1141 1142 1143 1144 1145 1146 1147 1148 1149 1150 1151 1152 1153 1154 1155 1156 1157 1158 1159 1160 1161 1162 1163 1164 1165 1166 1167 1168 1169 1170 1171 1172 1173 1174 1175 1176 1177 1178 1179 1180 1181 1182 1183 1184 1185 1186 1187 1188 1189 1190 1191 1192 1193 1194 1195 1196 1197 1198 1199 1200 1201 1202 1203 1204 1205 1206 1207 1208 1209 1210 1211 1212 1213 1214 1215 1216 1217 1218 1219 1220 1221 1222 1223 1224 1225 1226 1227 1228 1229 1230 1231 1232 1233 1234 1235 1236 1237 1238 1239 1240 1241 1242 1243 1244 1245 1246 1247 1248 1249 1250 1251 1252 1253 1254 1255 1256 1257 1258 1259 1260 1261 1262 1263 1264 1265 1266 1267 1268 1269 1270 1271 1272 1273 1274 1275 1276 1277 1278 1279 1280 1281 1282 1283 1284 1285 1286 1287 1288 1289 1290 1291 1292 1293 1294 1295 1296 1297 1298 1299 1300 1301 1302 1303 1304 1305 1306 1307 1308 1309 1310 1311 1312 1313 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¨Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 3, \u0026#34;end_offset\u0026#34; : 4, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äººæœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 8, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 8, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;è˜‡å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸé‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 14, \u0026#34;end_offset\u0026#34; : 15, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 17, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆ\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 20, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 20, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 22, \u0026#34;end_offset\u0026#34; : 23, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨‚ç„¡é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 28, \u0026#34;end_offset\u0026#34; : 29, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 35, \u0026#34;end_offset\u0026#34; : 36, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;è »æ©«ä¸ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 42, \u0026#34;end_offset\u0026#34; : 43, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾çµ\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®ç„¡å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 50, \u0026#34;end_offset\u0026#34; : 51, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 54, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹å¥ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 54, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 34 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 35 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 36 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 58, \u0026#34;end_offset\u0026#34; : 59, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 37 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 59, \u0026#34;end_offset\u0026#34; : 60, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 38 }, { \u0026#34;token\u0026#34; : \u0026#34;çˆºçˆº\u0026#34;, \u0026#34;start_offset\u0026#34; : 60, \u0026#34;end_offset\u0026#34; : 62, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 39 }, { \u0026#34;token\u0026#34; : \u0026#34;è·Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 62, \u0026#34;end_offset\u0026#34; : 63, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 40 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 63, \u0026#34;end_offset\u0026#34; : 64, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 41 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¾†\u0026#34;, \u0026#34;start_offset\u0026#34; : 64, \u0026#34;end_offset\u0026#34; : 65, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 42 }, { \u0026#34;token\u0026#34; : \u0026#34;ç¿»è‡‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 65, \u0026#34;end_offset\u0026#34; : 67, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 43 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 67, \u0026#34;end_offset\u0026#34; : 68, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 44 }, { \u0026#34;token\u0026#34; : \u0026#34;æ…˜\u0026#34;, \u0026#34;start_offset\u0026#34; : 68, \u0026#34;end_offset\u0026#34; : 69, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 45 }, { \u0026#34;token\u0026#34; : \u0026#34;è¢«\u0026#34;, \u0026#34;start_offset\u0026#34; : 69, \u0026#34;end_offset\u0026#34; : 70, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 46 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 70, \u0026#34;end_offset\u0026#34; : 71, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 47 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€æ£ä¾†\u0026#34;, \u0026#34;start_offset\u0026#34; : 71, \u0026#34;end_offset\u0026#34; : 74, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 48 }, { \u0026#34;token\u0026#34; : \u0026#34;æ‰“æ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 74, \u0026#34;end_offset\u0026#34; : 76, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 49 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 76, \u0026#34;end_offset\u0026#34; : 77, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 50 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 77, \u0026#34;end_offset\u0026#34; : 78, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 51 }, { \u0026#34;token\u0026#34; : \u0026#34;å¥¶å¥¶\u0026#34;, \u0026#34;start_offset\u0026#34; : 78, \u0026#34;end_offset\u0026#34; : 80, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 52 }, { \u0026#34;token\u0026#34; : \u0026#34;ç½µ\u0026#34;, \u0026#34;start_offset\u0026#34; : 80, \u0026#34;end_offset\u0026#34; : 81, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 53 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 81, \u0026#34;end_offset\u0026#34; : 82, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 54 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¬ºé¨™å–„æ°‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 82, \u0026#34;end_offset\u0026#34; : 86, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 55 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 86, \u0026#34;end_offset\u0026#34; : 87, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 56 }, { \u0026#34;token\u0026#34; : \u0026#34;å\u0026#34;, \u0026#34;start_offset\u0026#34; : 87, \u0026#34;end_offset\u0026#34; : 88, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 57 }, { \u0026#34;token\u0026#34; : \u0026#34;è¢«\u0026#34;, \u0026#34;start_offset\u0026#34; : 88, \u0026#34;end_offset\u0026#34; : 89, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 58 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 89, \u0026#34;end_offset\u0026#34; : 90, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 59 }, { \u0026#34;token\u0026#34; : \u0026#34;æ‰é€²\u0026#34;, \u0026#34;start_offset\u0026#34; : 90, \u0026#34;end_offset\u0026#34; : 92, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 60 }, { \u0026#34;token\u0026#34; : \u0026#34;äº†\u0026#34;, \u0026#34;start_offset\u0026#34; : 92, \u0026#34;end_offset\u0026#34; : 93, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 61 }, { \u0026#34;token\u0026#34; : \u0026#34;å”åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 93, \u0026#34;end_offset\u0026#34; : 95, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 62 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 95, \u0026#34;end_offset\u0026#34; : 96, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 63 }, { \u0026#34;token\u0026#34; : \u0026#34;å¼·å§¦\u0026#34;, \u0026#34;start_offset\u0026#34; : 96, \u0026#34;end_offset\u0026#34; : 98, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 64 }, { \u0026#34;token\u0026#34; : \u0026#34;äº†\u0026#34;, \u0026#34;start_offset\u0026#34; : 98, \u0026#34;end_offset\u0026#34; : 99, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 65 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€ç™¾\u0026#34;, \u0026#34;start_offset\u0026#34; : 99, \u0026#34;end_offset\u0026#34; : 101, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 66 }, { \u0026#34;token\u0026#34; : \u0026#34;é\u0026#34;, \u0026#34;start_offset\u0026#34; : 101, \u0026#34;end_offset\u0026#34; : 102, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 67 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 102, \u0026#34;end_offset\u0026#34; : 103, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 68 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€ç™¾\u0026#34;, \u0026#34;start_offset\u0026#34; : 103, \u0026#34;end_offset\u0026#34; : 105, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 69 }, { \u0026#34;token\u0026#34; : \u0026#34;é\u0026#34;, \u0026#34;start_offset\u0026#34; : 105, \u0026#34;end_offset\u0026#34; : 106, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 70 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 106, \u0026#34;end_offset\u0026#34; : 107, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 71 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ€\u0026#34;, \u0026#34;start_offset\u0026#34; : 107, \u0026#34;end_offset\u0026#34; : 108, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 72 }, { \u0026#34;token\u0026#34; : \u0026#34;å¾Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 108, \u0026#34;end_offset\u0026#34; : 109, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 73 }, { \u0026#34;token\u0026#34; : \u0026#34;å¥¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 109, \u0026#34;end_offset\u0026#34; : 110, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 74 }, { \u0026#34;token\u0026#34; : \u0026#34;æ‡¸æ¨‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 110, \u0026#34;end_offset\u0026#34; : 112, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 75 }, { \u0026#34;token\u0026#34; : \u0026#34;è‡ªç›¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 112, \u0026#34;end_offset\u0026#34; : 114, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 76 }, { \u0026#34;token\u0026#34; : \u0026#34;éºæ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 114, \u0026#34;end_offset\u0026#34; : 116, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 77 }, { \u0026#34;token\u0026#34; : \u0026#34;äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 116, \u0026#34;end_offset\u0026#34; : 117, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 78 }, { \u0026#34;token\u0026#34; : \u0026#34;é–“\u0026#34;, \u0026#34;start_offset\u0026#34; : 117, \u0026#34;end_offset\u0026#34; : 118, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 79 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 118, \u0026#34;end_offset\u0026#34; : 119, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 80 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 119, \u0026#34;end_offset\u0026#34; : 120, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 81 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚„å°‡\u0026#34;, \u0026#34;start_offset\u0026#34; : 120, \u0026#34;end_offset\u0026#34; : 122, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 82 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 122, \u0026#34;end_offset\u0026#34; : 123, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 83 }, { \u0026#34;token\u0026#34; : \u0026#34;çˆ¶å­\u0026#34;, \u0026#34;start_offset\u0026#34; : 123, \u0026#34;end_offset\u0026#34; : 125, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 84 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 125, \u0026#34;end_offset\u0026#34; : 126, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 85 }, { \u0026#34;token\u0026#34; : \u0026#34;é€å‡º\u0026#34;, \u0026#34;start_offset\u0026#34; : 126, \u0026#34;end_offset\u0026#34; : 128, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 86 }, { \u0026#34;token\u0026#34; : \u0026#34;äº†\u0026#34;, \u0026#34;start_offset\u0026#34; : 128, \u0026#34;end_offset\u0026#34; : 129, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 87 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶åœ’\u0026#34;, \u0026#34;start_offset\u0026#34; : 129, \u0026#34;end_offset\u0026#34; : 131, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 88 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 131, \u0026#34;end_offset\u0026#34; : 132, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 89 }, { \u0026#34;token\u0026#34; : \u0026#34;æµè½\u0026#34;, \u0026#34;start_offset\u0026#34; : 132, \u0026#34;end_offset\u0026#34; : 134, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 90 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆ°\u0026#34;, \u0026#34;start_offset\u0026#34; : 134, \u0026#34;end_offset\u0026#34; : 135, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 91 }, { \u0026#34;token\u0026#34; : \u0026#34;æ±Ÿé‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 135, \u0026#34;end_offset\u0026#34; : 137, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 92 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 137, \u0026#34;end_offset\u0026#34; : 138, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 93 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 138, \u0026#34;end_offset\u0026#34; : 139, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 94 }, { \u0026#34;token\u0026#34; : \u0026#34;ç‚ºæ±‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 139, \u0026#34;end_offset\u0026#34; : 141, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 95 }, { \u0026#34;token\u0026#34; : \u0026#34;é¤Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 141, \u0026#34;end_offset\u0026#34; : 142, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 96 }, { \u0026#34;token\u0026#34; : \u0026#34;è€çˆ¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 142, \u0026#34;end_offset\u0026#34; : 144, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 97 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 144, \u0026#34;end_offset\u0026#34; : 145, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 98 }, { \u0026#34;token\u0026#34; : \u0026#34;åªæœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 145, \u0026#34;end_offset\u0026#34; : 147, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 99 }, { \u0026#34;token\u0026#34; : \u0026#34;ç¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 147, \u0026#34;end_offset\u0026#34; : 148, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 100 }, { \u0026#34;token\u0026#34; : \u0026#34;è‡ªè¡Œä¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 148, \u0026#34;end_offset\u0026#34; : 151, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 101 }, { \u0026#34;token\u0026#34; : \u0026#34;åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 151, \u0026#34;end_offset\u0026#34; : 152, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 102 }, { \u0026#34;token\u0026#34; : \u0026#34;å»Ÿå‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 152, \u0026#34;end_offset\u0026#34; : 154, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 103 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 154, \u0026#34;end_offset\u0026#34; : 155, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 104 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 155, \u0026#34;end_offset\u0026#34; : 157, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 105 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 157, \u0026#34;end_offset\u0026#34; : 158, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 106 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 158, \u0026#34;end_offset\u0026#34; : 161, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 107 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 161, \u0026#34;end_offset\u0026#34; : 162, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 108 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 162, \u0026#34;end_offset\u0026#34; : 163, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 109 }, { \u0026#34;token\u0026#34; : \u0026#34;å¯¦\u0026#34;, \u0026#34;start_offset\u0026#34; : 163, \u0026#34;end_offset\u0026#34; : 164, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 110 }, { \u0026#34;token\u0026#34; : \u0026#34;åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 164, \u0026#34;end_offset\u0026#34; : 165, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 111 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 165, \u0026#34;end_offset\u0026#34; : 166, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 112 }, { \u0026#34;token\u0026#34; : \u0026#34;é™°éšª\u0026#34;, \u0026#34;start_offset\u0026#34; : 166, \u0026#34;end_offset\u0026#34; : 168, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 113 }, { \u0026#34;token\u0026#34; : \u0026#34;çŸ¥é“\u0026#34;, \u0026#34;start_offset\u0026#34; : 168, \u0026#34;end_offset\u0026#34; : 170, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 114 }, { \u0026#34;token\u0026#34; : \u0026#34;æ­¤æƒ…å½¢\u0026#34;, \u0026#34;start_offset\u0026#34; : 170, \u0026#34;end_offset\u0026#34; : 173, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 115 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 173, \u0026#34;end_offset\u0026#34; : 174, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 116 }, { \u0026#34;token\u0026#34; : \u0026#34;ç«Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 174, \u0026#34;end_offset\u0026#34; : 175, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 117 }, { \u0026#34;token\u0026#34; : \u0026#34;æ´¾\u0026#34;, \u0026#34;start_offset\u0026#34; : 175, \u0026#34;end_offset\u0026#34; : 176, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 118 }, { \u0026#34;token\u0026#34; : \u0026#34;äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 176, \u0026#34;end_offset\u0026#34; : 177, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 119 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¾†\u0026#34;, \u0026#34;start_offset\u0026#34; : 177, \u0026#34;end_offset\u0026#34; : 178, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 120 }, { \u0026#34;token\u0026#34; : \u0026#34;æš—ç®—\u0026#34;, \u0026#34;start_offset\u0026#34; : 178, \u0026#34;end_offset\u0026#34; : 180, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 121 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 180, \u0026#34;end_offset\u0026#34; : 181, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 122 }, { \u0026#34;token\u0026#34; : \u0026#34;æŠŠ\u0026#34;, \u0026#34;start_offset\u0026#34; : 181, \u0026#34;end_offset\u0026#34; : 182, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 123 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 182, \u0026#34;end_offset\u0026#34; : 183, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 124 }, { \u0026#34;token\u0026#34; : \u0026#34;çˆ¶å­\u0026#34;, \u0026#34;start_offset\u0026#34; : 183, \u0026#34;end_offset\u0026#34; : 185, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 125 }, { \u0026#34;token\u0026#34; : \u0026#34;ç‹‚æ¯†\u0026#34;, \u0026#34;start_offset\u0026#34; : 185, \u0026#34;end_offset\u0026#34; : 187, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 126 }, { \u0026#34;token\u0026#34; : \u0026#34;åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 187, \u0026#34;end_offset\u0026#34; : 188, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 127 }, { \u0026#34;token\u0026#34; : \u0026#34;å¸‚å‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 188, \u0026#34;end_offset\u0026#34; : 190, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 128 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 190, \u0026#34;end_offset\u0026#34; : 191, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 129 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äººèº«\u0026#34;, \u0026#34;start_offset\u0026#34; : 191, \u0026#34;end_offset\u0026#34; : 194, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 130 }, { \u0026#34;token\u0026#34; : \u0026#34;å£¯å¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 194, \u0026#34;end_offset\u0026#34; : 196, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 131 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 196, \u0026#34;end_offset\u0026#34; : 197, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 132 }, { \u0026#34;token\u0026#34; : \u0026#34;æ®˜å‘½\u0026#34;, \u0026#34;start_offset\u0026#34; : 197, \u0026#34;end_offset\u0026#34; : 199, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 133 }, { \u0026#34;token\u0026#34; : \u0026#34;å¾—\u0026#34;, \u0026#34;start_offset\u0026#34; : 199, \u0026#34;end_offset\u0026#34; : 200, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 134 }, { \u0026#34;token\u0026#34; : \u0026#34;ç•™å­˜\u0026#34;, \u0026#34;start_offset\u0026#34; : 200, \u0026#34;end_offset\u0026#34; : 202, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 135 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 202, \u0026#34;end_offset\u0026#34; : 203, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 136 }, { \u0026#34;token\u0026#34; : \u0026#34;å¯\u0026#34;, \u0026#34;start_offset\u0026#34; : 203, \u0026#34;end_offset\u0026#34; : 204, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 137 }, { \u0026#34;token\u0026#34; : \u0026#34;æ†\u0026#34;, \u0026#34;start_offset\u0026#34; : 204, \u0026#34;end_offset\u0026#34; : 205, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 138 }, { \u0026#34;token\u0026#34; : \u0026#34;è€çˆ¶\u0026#34;, \u0026#34;start_offset\u0026#34; : 205, \u0026#34;end_offset\u0026#34; : 207, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 139 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 207, \u0026#34;end_offset\u0026#34; : 208, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 140 }, { \u0026#34;token\u0026#34; : \u0026#34;é­‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 208, \u0026#34;end_offset\u0026#34; : 209, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 141 }, { \u0026#34;token\u0026#34; : \u0026#34;æ­¸å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 209, \u0026#34;end_offset\u0026#34; : 211, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 142 }, { \u0026#34;token\u0026#34; : \u0026#34;!\u0026#34;, \u0026#34;start_offset\u0026#34; : 211, \u0026#34;end_offset\u0026#34; : 212, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 143 }, { \u0026#34;token\u0026#34; : \u0026#34;æ­¤\u0026#34;, \u0026#34;start_offset\u0026#34; : 212, \u0026#34;end_offset\u0026#34; : 213, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 144 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 213, \u0026#34;end_offset\u0026#34; : 214, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 145 }, { \u0026#34;token\u0026#34; : \u0026#34;æ›´\u0026#34;, \u0026#34;start_offset\u0026#34; : 214, \u0026#34;end_offset\u0026#34; : 215, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 146 }, { \u0026#34;token\u0026#34; : \u0026#34;é›£\u0026#34;, \u0026#34;start_offset\u0026#34; : 215, \u0026#34;end_offset\u0026#34; : 216, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 147 }, { \u0026#34;token\u0026#34; : \u0026#34;å¡«\u0026#34;, \u0026#34;start_offset\u0026#34; : 216, \u0026#34;end_offset\u0026#34; : 217, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 148 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 217, \u0026#34;end_offset\u0026#34; : 218, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 149 }, { \u0026#34;token\u0026#34; : \u0026#34;ç‚º\u0026#34;, \u0026#34;start_offset\u0026#34; : 218, \u0026#34;end_offset\u0026#34; : 219, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 150 }, { \u0026#34;token\u0026#34; : \u0026#34;æ±‚è‘¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 219, \u0026#34;end_offset\u0026#34; : 221, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 151 }, { \u0026#34;token\u0026#34; : \u0026#34;è€çˆ¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 221, \u0026#34;end_offset\u0026#34; : 223, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 152 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 223, \u0026#34;end_offset\u0026#34; : 224, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 153 }, { \u0026#34;token\u0026#34; : \u0026#34;å”¯æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 224, \u0026#34;end_offset\u0026#34; : 226, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 154 }, { \u0026#34;token\u0026#34; : \u0026#34;è³£èº«\u0026#34;, \u0026#34;start_offset\u0026#34; : 226, \u0026#34;end_offset\u0026#34; : 228, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 155 }, { \u0026#34;token\u0026#34; : \u0026#34;ç‚ºå¥´\u0026#34;, \u0026#34;start_offset\u0026#34; : 228, \u0026#34;end_offset\u0026#34; : 230, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 156 }, { \u0026#34;token\u0026#34; : \u0026#34;è‡ªä½œè³¤\u0026#34;, \u0026#34;start_offset\u0026#34; : 230, \u0026#34;end_offset\u0026#34; : 233, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 157 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 233, \u0026#34;end_offset\u0026#34; : 234, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 158 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€é¢å‹¤\u0026#34;, \u0026#34;start_offset\u0026#34; : 234, \u0026#34;end_offset\u0026#34; : 237, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 159 }, { \u0026#34;token\u0026#34; : \u0026#34;è³ºéŒ¢\u0026#34;, \u0026#34;start_offset\u0026#34; : 237, \u0026#34;end_offset\u0026#34; : 239, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 160 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 239, \u0026#34;end_offset\u0026#34; : 240, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 161 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸€é¢\u0026#34;, \u0026#34;start_offset\u0026#34; : 240, \u0026#34;end_offset\u0026#34; : 242, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 162 }, { \u0026#34;token\u0026#34; : \u0026#34;è®€æ›¸ç¯‡\u0026#34;, \u0026#34;start_offset\u0026#34; : 242, \u0026#34;end_offset\u0026#34; : 245, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 163 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 245, \u0026#34;end_offset\u0026#34; : 246, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 164 }, { \u0026#34;token\u0026#34; : \u0026#34;ç™¼èª“\u0026#34;, \u0026#34;start_offset\u0026#34; : 246, \u0026#34;end_offset\u0026#34; : 248, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 165 }, { \u0026#34;token\u0026#34; : \u0026#34;æŠŠ\u0026#34;, \u0026#34;start_offset\u0026#34; : 248, \u0026#34;end_offset\u0026#34; : 249, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 166 }, { \u0026#34;token\u0026#34; : \u0026#34;åŠŸåé¡¯\u0026#34;, \u0026#34;start_offset\u0026#34; : 249, \u0026#34;end_offset\u0026#34; : 252, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 167 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 252, \u0026#34;end_offset\u0026#34; : 253, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 168 }, { \u0026#34;token\u0026#34; : \u0026#34;æ‰‹åˆƒä»‡äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 253, \u0026#34;end_offset\u0026#34; : 257, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 169 }, { \u0026#34;token\u0026#34; : \u0026#34;æ„å¿—\u0026#34;, \u0026#34;start_offset\u0026#34; : 257, \u0026#34;end_offset\u0026#34; : 259, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 170 }, { \u0026#34;token\u0026#34; : \u0026#34;å …\u0026#34;, \u0026#34;start_offset\u0026#34; : 259, \u0026#34;end_offset\u0026#34; : 260, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 171 }, { \u0026#34;token\u0026#34; : \u0026#34;!\u0026#34;, \u0026#34;start_offset\u0026#34; : 260, \u0026#34;end_offset\u0026#34; : 261, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 172 }, { \u0026#34;token\u0026#34; : \u0026#34;å¾\u0026#34;, \u0026#34;start_offset\u0026#34; : 261, \u0026#34;end_offset\u0026#34; : 262, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 173 }, { \u0026#34;token\u0026#34; : \u0026#34;æ­¤\u0026#34;, \u0026#34;start_offset\u0026#34; : 262, \u0026#34;end_offset\u0026#34; : 263, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 174 }, { \u0026#34;token\u0026#34; : \u0026#34;å”å¯…è©©\u0026#34;, \u0026#34;start_offset\u0026#34; : 263, \u0026#34;end_offset\u0026#34; : 266, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 175 }, { \u0026#34;token\u0026#34; : \u0026#34;é›†ä¼´\u0026#34;, \u0026#34;start_offset\u0026#34; : 266, \u0026#34;end_offset\u0026#34; : 268, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 176 }, { \u0026#34;token\u0026#34; : \u0026#34;èº«é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 268, \u0026#34;end_offset\u0026#34; : 270, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 177 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 270, \u0026#34;end_offset\u0026#34; : 271, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 178 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 271, \u0026#34;end_offset\u0026#34; : 272, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 179 }, { \u0026#34;token\u0026#34; : \u0026#34;éŠ˜è¨˜\u0026#34;, \u0026#34;start_offset\u0026#34; : 272, \u0026#34;end_offset\u0026#34; : 274, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 180 }, { \u0026#34;token\u0026#34; : \u0026#34;æ­¤\u0026#34;, \u0026#34;start_offset\u0026#34; : 274, \u0026#34;end_offset\u0026#34; : 275, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 181 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»‡\u0026#34;, \u0026#34;start_offset\u0026#34; : 275, \u0026#34;end_offset\u0026#34; : 276, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 182 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸å…±æˆ´å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 276, \u0026#34;end_offset\u0026#34; : 280, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 183 }, { \u0026#34;token\u0026#34; : \u0026#34;!\u0026#34;, \u0026#34;start_offset\u0026#34; : 280, \u0026#34;end_offset\u0026#34; : 281, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 184 }, { \u0026#34;token\u0026#34; : \u0026#34;!\u0026#34;, \u0026#34;start_offset\u0026#34; : 281, \u0026#34;end_offset\u0026#34; : 282, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 185 }, { \u0026#34;token\u0026#34; : \u0026#34;!\u0026#34;, \u0026#34;start_offset\u0026#34; : 282, \u0026#34;end_offset\u0026#34; : 283, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 186 } ] } å®‰è£æ­¥é©Ÿå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # ä¸‹è¼‰ä¸¦è§£å£“ç¸® âœ ~ cd /usr/share/elasticsearch/plugins âœ ~ wget https://github.com/microbun/elasticsearch-thulac-plugin/releases/download/7.9.1/elasticsearch-thulac-plugin-7.9.1.zip âœ ~ unzip elasticsearch-thulac-plugin-7.9.1.zip âœ ~ rm ./elasticsearch-thulac-plugin-7.9.1.zip # æ ¹æ“š ES ç‰ˆæœ¬èª¿æ•´è¨­å®šæª” âœ ~ cd analysis-thulac âœ ~ mv elasticsearch-thulac-plugin-7.9.1.jar elasticsearch-thulac-plugin-7.15.2.jar âœ ~ vim plugin-descriptor.properties version=7.15.2 elasticsearch.version=7.15.2 # ä¸‹è¼‰æ¨¡å‹ âœ ~ cd /usr/share/elasticsearch/plugins/analysis-thulac/models âœ ~ wget http://thulac.thunlp.org/source/Models_v1_v2.zip âœ ~ unzip Models_v1_v2.zip âœ ~ mv ./models/* ./ âœ ~ rm -r models __MACOSX Models_v1_v2.zip # é‡å•Ÿ elastic âœ ~ systemctl restart elasticsearch ä¸­æ–‡æ–¹æ¡ˆæ¨è–¦ ç°¡é«”ä¸­æ–‡ åŸºæœ¬ä¸Šæ¨è–¦ç›´æ¥ä½¿ç”¨ IK å°±å¯ä»¥äº†ï¼Œæ–¹ä¾¿ä½¿ç”¨ç¤¾ç¾¤æ´»èºã€‚\nç¹é«”ä¸­æ–‡ å› ç‚º IK å°æ–¼ç¹é«”ä¸­æ–‡æ”¯æŒä¸å¤ ï¼Œå› æ­¤éœ€è¦å¦å°‹æ–¹æ¡ˆï¼š\njiebaï¼šé›–ç„¶ä¸€æ¨£æ˜¯ä¸­åœ‹é–‹ç™¼çš„ï¼Œä½†æ˜¯æ˜¯æœ‰æ”¯æŒç¹é«”åˆ†è©çš„ã€‚\nSTConvert + IKï¼šå…ˆåœ¨ char_filter é€é STConvert å°‡ç¹é«”è½‰ç‚ºç°¡é«”ï¼Œå†äº¤çµ¦ tokenizer IK ä¾†é€²è¡Œåˆ†è©ï¼Œé€éé€™ç¨®æ–¹å¼è§£æ±º IK åœ¨ç¹é«”åˆ†è©çš„ä¸è¶³ã€‚\nç¯„ä¾‹(å±•é–‹æŸ¥çœ‹)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 PUT /my-index-000002 { \u0026#34;settings\u0026#34;: { \u0026#34;analysis\u0026#34;: { \u0026#34;analyzer\u0026#34;: { \u0026#34;my_custom_analyzer\u0026#34;: { \u0026#34;char_filter\u0026#34;: [ \u0026#34;tsconvert\u0026#34; ], \u0026#34;tokenizer\u0026#34;: \u0026#34;ik_max_word\u0026#34; } }, \u0026#34;char_filter\u0026#34;: { \u0026#34;tsconvert\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;stconvert\u0026#34;, \u0026#34;convert_type\u0026#34; : \u0026#34;t2s\u0026#34; } }, \u0026#34;filter\u0026#34;: { \u0026#34;stconvert\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;stconvert\u0026#34;, \u0026#34;convert_type\u0026#34; : \u0026#34;s2t\u0026#34; } } } }, \u0026#34;mappings\u0026#34;:{ \u0026#34;properties\u0026#34;:{ \u0026#34;id\u0026#34;:{ \u0026#34;type\u0026#34;:\u0026#34;integer\u0026#34; }, \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:\u0026#34;text\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;my_custom_analyzer\u0026#34;, \u0026#34;search_analyzer\u0026#34;: \u0026#34;my_custom_analyzer\u0026#34; }, \u0026#34;create_time\u0026#34;:{ \u0026#34;type\u0026#34;:\u0026#34;date\u0026#34; } } } } PUT /my-index-000002/_doc/1 { \u0026#34;id\u0026#34;:1, \u0026#34;content\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°ã€‚\u0026#34;, \u0026#34;create_time\u0026#34;:\u0026#34;2021-12-09\u0026#34; } GET /my-index-000002/_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°ã€‚\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;my_custom_analyzer\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¦€\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;äººæœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 5, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;è‹å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸ\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 13, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;è¾¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 13, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸­æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 16, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆæœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 26, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;æ— è¾¹\u0026#34;, \u0026#34;start_offset\u0026#34; : 26, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;è°çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;è›®æ¨ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 39, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸ç•™\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 41, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 40, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾ç»“\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®æ— \u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 49, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 49, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 55, \u0026#34;type\u0026#34; : \u0026#34;CN_WORD\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤º\u0026#34;, \u0026#34;start_offset\u0026#34; : 55, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;CN_CHAR\u0026#34;, \u0026#34;position\u0026#34; : 34 } ] } THULACï¼šé›–ç„¶ä¸èƒ½ä½¿ç”¨ PRO ç‰ˆæœ¬ï¼Œä½† Lite ç‰ˆæœ¬ä¹Ÿéå¸¸ä¸éŒ¯äº†ï¼Œè€Œä¸”åŒæ¨£æœ‰è‡ªè¨‚è¾­å…¸çš„åŠŸèƒ½ã€‚\nç¯„ä¾‹(å±•é–‹æŸ¥çœ‹)\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°\u0026#34;, \u0026#34;tokenizer\u0026#34;: \u0026#34;thulac\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¨Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 3, \u0026#34;end_offset\u0026#34; : 4, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äººæœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 8, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 8, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;è˜‡å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸé‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 14, \u0026#34;end_offset\u0026#34; : 15, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 17, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆ\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 20, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 20, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 22, \u0026#34;end_offset\u0026#34; : 23, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨‚ç„¡é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;ã€‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 28, \u0026#34;end_offset\u0026#34; : 29, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 35, \u0026#34;end_offset\u0026#34; : 36, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;è »æ©«ä¸ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 42, \u0026#34;end_offset\u0026#34; : 43, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾çµ\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®ç„¡å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;ï¼Œ\u0026#34;, \u0026#34;start_offset\u0026#34; : 50, \u0026#34;end_offset\u0026#34; : 51, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 54, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹å¥ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 54, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 34 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 35 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;word\u0026#34;, \u0026#34;position\u0026#34; : 36 } ] } IK + è‡ªè¨‚ç¹é«”è¾­å…¸ï¼šé€é IK çš„è‡ªè¨‚è¾­å…¸å°å…¥ç¹é«”ä¸­æ–‡è©åº«ä¾†æ”¹å–„ã€‚\nICUï¼šLucene è‡ªå¸¶çš„ï¼Œå°æ–¼ç¹é«”å­—ä¾†èªªæ•ˆæœé‚„ä¸éŒ¯ã€‚\nç¯„ä¾‹(å±•é–‹æŸ¥çœ‹)\n1 2 3 4 5 GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°\u0026#34;, \u0026#34;tokenizer\u0026#34;: \u0026#34;icu_tokenizer\u0026#34; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 { \u0026#34;tokens\u0026#34; : [ { \u0026#34;token\u0026#34; : \u0026#34;ç¨Ÿ\u0026#34;, \u0026#34;start_offset\u0026#34; : 0, \u0026#34;end_offset\u0026#34; : 1, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 0 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤«äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 1, \u0026#34;end_offset\u0026#34; : 3, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 1 }, { \u0026#34;token\u0026#34; : \u0026#34;å°äºº\u0026#34;, \u0026#34;start_offset\u0026#34; : 4, \u0026#34;end_offset\u0026#34; : 6, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 2 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ¬\u0026#34;, \u0026#34;start_offset\u0026#34; : 6, \u0026#34;end_offset\u0026#34; : 7, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 3 }, { \u0026#34;token\u0026#34; : \u0026#34;ä½åœ¨\u0026#34;, \u0026#34;start_offset\u0026#34; : 7, \u0026#34;end_offset\u0026#34; : 9, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 4 }, { \u0026#34;token\u0026#34; : \u0026#34;è˜‡å·\u0026#34;, \u0026#34;start_offset\u0026#34; : 9, \u0026#34;end_offset\u0026#34; : 11, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 5 }, { \u0026#34;token\u0026#34; : \u0026#34;çš„\u0026#34;, \u0026#34;start_offset\u0026#34; : 11, \u0026#34;end_offset\u0026#34; : 12, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 6 }, { \u0026#34;token\u0026#34; : \u0026#34;åŸ\u0026#34;, \u0026#34;start_offset\u0026#34; : 12, \u0026#34;end_offset\u0026#34; : 13, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 7 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 13, \u0026#34;end_offset\u0026#34; : 14, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 8 }, { \u0026#34;token\u0026#34; : \u0026#34;å®¶ä¸­\u0026#34;, \u0026#34;start_offset\u0026#34; : 15, \u0026#34;end_offset\u0026#34; : 17, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 9 }, { \u0026#34;token\u0026#34; : \u0026#34;æœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 17, \u0026#34;end_offset\u0026#34; : 18, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 10 }, { \u0026#34;token\u0026#34; : \u0026#34;å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 18, \u0026#34;end_offset\u0026#34; : 19, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 11 }, { \u0026#34;token\u0026#34; : \u0026#34;åˆæœ‰\u0026#34;, \u0026#34;start_offset\u0026#34; : 19, \u0026#34;end_offset\u0026#34; : 21, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 12 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 21, \u0026#34;end_offset\u0026#34; : 22, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 13 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”Ÿæ´»\u0026#34;, \u0026#34;start_offset\u0026#34; : 23, \u0026#34;end_offset\u0026#34; : 25, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 14 }, { \u0026#34;token\u0026#34; : \u0026#34;æ¨‚\u0026#34;, \u0026#34;start_offset\u0026#34; : 25, \u0026#34;end_offset\u0026#34; : 26, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 15 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡é‚Š\u0026#34;, \u0026#34;start_offset\u0026#34; : 26, \u0026#34;end_offset\u0026#34; : 28, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 16 }, { \u0026#34;token\u0026#34; : \u0026#34;èª°\u0026#34;, \u0026#34;start_offset\u0026#34; : 29, \u0026#34;end_offset\u0026#34; : 30, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 17 }, { \u0026#34;token\u0026#34; : \u0026#34;çŸ¥\u0026#34;, \u0026#34;start_offset\u0026#34; : 30, \u0026#34;end_offset\u0026#34; : 31, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 18 }, { \u0026#34;token\u0026#34; : \u0026#34;é‚£\u0026#34;, \u0026#34;start_offset\u0026#34; : 31, \u0026#34;end_offset\u0026#34; : 32, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 19 }, { \u0026#34;token\u0026#34; : \u0026#34;å”ä¼¯è™\u0026#34;, \u0026#34;start_offset\u0026#34; : 32, \u0026#34;end_offset\u0026#34; : 35, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 20 }, { \u0026#34;token\u0026#34; : \u0026#34;ä»–\u0026#34;, \u0026#34;start_offset\u0026#34; : 36, \u0026#34;end_offset\u0026#34; : 37, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 21 }, { \u0026#34;token\u0026#34; : \u0026#34;è »æ©«\u0026#34;, \u0026#34;start_offset\u0026#34; : 37, \u0026#34;end_offset\u0026#34; : 39, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 22 }, { \u0026#34;token\u0026#34; : \u0026#34;ä¸ç•™æƒ…\u0026#34;, \u0026#34;start_offset\u0026#34; : 39, \u0026#34;end_offset\u0026#34; : 42, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 23 }, { \u0026#34;token\u0026#34; : \u0026#34;å‹¾çµ\u0026#34;, \u0026#34;start_offset\u0026#34; : 43, \u0026#34;end_offset\u0026#34; : 45, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 24 }, { \u0026#34;token\u0026#34; : \u0026#34;å®˜åºœ\u0026#34;, \u0026#34;start_offset\u0026#34; : 45, \u0026#34;end_offset\u0026#34; : 47, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 25 }, { \u0026#34;token\u0026#34; : \u0026#34;ç›®\u0026#34;, \u0026#34;start_offset\u0026#34; : 47, \u0026#34;end_offset\u0026#34; : 48, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 26 }, { \u0026#34;token\u0026#34; : \u0026#34;ç„¡\u0026#34;, \u0026#34;start_offset\u0026#34; : 48, \u0026#34;end_offset\u0026#34; : 49, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 27 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤©\u0026#34;, \u0026#34;start_offset\u0026#34; : 49, \u0026#34;end_offset\u0026#34; : 50, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 28 }, { \u0026#34;token\u0026#34; : \u0026#34;å \u0026#34;, \u0026#34;start_offset\u0026#34; : 51, \u0026#34;end_offset\u0026#34; : 52, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 29 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 52, \u0026#34;end_offset\u0026#34; : 53, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 30 }, { \u0026#34;token\u0026#34; : \u0026#34;å¤§å±‹\u0026#34;, \u0026#34;start_offset\u0026#34; : 53, \u0026#34;end_offset\u0026#34; : 55, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 31 }, { \u0026#34;token\u0026#34; : \u0026#34;å¥ª\u0026#34;, \u0026#34;start_offset\u0026#34; : 55, \u0026#34;end_offset\u0026#34; : 56, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 32 }, { \u0026#34;token\u0026#34; : \u0026#34;æˆ‘\u0026#34;, \u0026#34;start_offset\u0026#34; : 56, \u0026#34;end_offset\u0026#34; : 57, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 33 }, { \u0026#34;token\u0026#34; : \u0026#34;ç”°\u0026#34;, \u0026#34;start_offset\u0026#34; : 57, \u0026#34;end_offset\u0026#34; : 58, \u0026#34;type\u0026#34; : \u0026#34;\u0026lt;IDEOGRAPHIC\u0026gt;\u0026#34;, \u0026#34;position\u0026#34; : 34 } ] } CJKAnalyzerï¼šç›´æ¥ä½¿ç”¨äºŒå…ƒåˆ‡åˆ†æ³•ï¼Œä¹Ÿæ¯”ä½¿ç”¨é è¨­ã€smartCN æœ‰æ›´å¥½çš„æ•ˆæœï¼Œä½†æœƒæœ‰å¾ˆå¤šç„¡æ„ç¾©ä½”ç”¨ç©ºé–“çš„ tokenã€‚\nèª²å¤–çŸ¥è­˜ ä¸­ç ”é™¢ CKIP Lab ä¸­æ–‡è©çŸ¥è­˜åº«å°çµ„åœ¨ 2019/09 çš„æ™‚å€™é–‹æºäº†å°ˆå±¬æ–¼å°ç£çš„ç¹é«”ä¸­æ–‡æ–·è© ckiptagger ï¼Œå°æ–¼ç¹é«”ä¸­æ–‡æ–·è©æ˜¯æˆ‘ç›®å‰çœ‹åˆ°æ•ˆæœæœ€å¥½çš„ï¼Œåœ¨å®˜æ–¹æä¾›çš„æ¸¬è©¦æ•¸æ“šä¸­æº–ç¢ºç‡ä¹Ÿæ¯” jieba-zh_TW æ•ˆæœæ›´å¥½ï¼Œå¯æƒœçš„æ˜¯ç›®å‰æ²’æœ‰å…¶ä»–äººå°‡å…¶è®Šæˆæœå°‹å¼•æ“çš„ pluginã€‚\nhttps://github.com/ckiplab/ckiptagger\nCKIP Lab ä¸­æ–‡è©çŸ¥è­˜åº«å°çµ„ | ä¸­æ–‡æ–·è© (sinica.edu.tw)\nåƒè€ƒ ES+Solr æ–‡æª”ï¼š\nAnalyzers | Apache Solr Reference Guide 6.6\nText analysis overview | Elasticsearch Guide [7.15] | Elastic\nCreate a custom analyzer | Elasticsearch Guide [7.15] | Elastic\nCharacter filters reference | Elasticsearch Guide [7.15] | Elastic\nTokenizer reference | Elasticsearch Guide [7.15] | Elastic\nToken filter reference | Elasticsearch Guide [7.15] | Elastic\nAnalysis Plugins | Elasticsearch Plugins and Integrations [7.15] | Elastic\nåˆ†è©å™¨ï¼š\nElasticsearchä¸­æ–‡åˆ†è¯ä¹‹Thulacå’ŒIK_zDREAM_UTOPIAçš„ä¸“æ -CSDNåšå®¢\nElasticsearch (äº”) - Analyzer åˆ†æå™¨ | Tienyu Note (tienyulin.com)\nElasticSearch åˆ†è¯å™¨ï¼Œäº†è§£ä¸€ä¸‹ - çŸ¥ä¹ (zhihu.com)\nä½¿ç”¨Elasticsearchè¿›è¡Œé«˜æ•ˆçš„ä¸­æ–‡æœç´¢_culh2177çš„åšå®¢-CSDNåšå®¢\nstconvert ç›¸é—œï¼š\nç®€ç¹å¤„ç† :: Elastic æœç´¢å¼€å‘å®æˆ˜ (medcl.com)\nTHULAC ç›¸é—œï¼š\nTHULACï¼šä¸€ä¸ªé«˜æ•ˆçš„ä¸­æ–‡è¯æ³•åˆ†æå·¥å…·åŒ… (thunlp.org)\næ¸¬è©¦æ–‡æœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 # http://10.17.117.203:5601/app/dev_tools#/console GET /_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°ã€‚æˆ‘çˆºçˆºè·Ÿä»–ä¾†ç¿»è‡‰ï¼Œæ…˜è¢«ä»–ä¸€æ£ä¾†æ‰“æ‰ï¼Œæˆ‘å¥¶å¥¶ç½µä»–æ¬ºé¨™å–„æ°‘ï¼Œåè¢«ä»–æ‰é€²äº†å”åºœï¼Œ å¼·å§¦äº†ä¸€ç™¾éï¼Œä¸€ç™¾éï¼Œæœ€å¾Œå¥¹æ‡¸æ¨‘è‡ªç›¡éºæ¨äººé–“ã€‚ ä»–é‚„å°‡æˆ‘çˆ¶å­ï¼Œé€å‡ºäº†å®¶åœ’ï¼Œæµè½åˆ°æ±Ÿé‚Šã€‚æˆ‘ç‚ºæ±‚é¤Šè€çˆ¹ï¼Œåªæœ‰ç¨è‡ªè¡Œä¹åœ¨å»Ÿå‰ã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–å¯¦åœ¨å¤ªé™°éšª çŸ¥é“æ­¤æƒ…å½¢ï¼Œç«Ÿæ´¾äººä¾†æš—ç®—ï¼ŒæŠŠæˆ‘çˆ¶å­ç‹‚æ¯†åœ¨å¸‚å‰ï¼Œå°äººèº«å£¯å¥ï¼Œæ®˜å‘½å¾—ç•™å­˜ï¼Œå¯æ†è€çˆ¶ä»–é­‚æ­¸å¤©!æ­¤æ¨æ›´é›£å¡«ã€‚ç‚ºæ±‚è‘¬è€çˆ¹ï¼Œå”¯æœ‰è³£èº«ç‚ºå¥´è‡ªä½œè³¤ï¼Œ ä¸€é¢å‹¤è³ºéŒ¢ï¼Œä¸€é¢è®€æ›¸ç¯‡ï¼Œ ç™¼èª“æŠŠåŠŸåé¡¯ï¼Œæ‰‹åˆƒä»‡äººæ„å¿—å …! å¾æ­¤å”å¯…è©©é›†ä¼´èº«é‚Šï¼Œæˆ‘éŠ˜è¨˜æ­¤ä»‡ä¸å…±æˆ´å¤©!!!\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;standard\u0026#34; } #\u0026#34;analyzer\u0026#34;: \u0026#34;cjk\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;thulac\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;smartcn_tokenizer\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;icu_tokenizer\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;ik_smart\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;ik_max_word\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;thulac\u0026#34; #\u0026#34;analyzer\u0026#34;: \u0026#34;jieba_index\u0026#34; # stconvert + ik PUT /stconvert-ik { \u0026#34;settings\u0026#34;: { \u0026#34;analysis\u0026#34;: { \u0026#34;analyzer\u0026#34;: { \u0026#34;my_custom_analyzer\u0026#34;: { \u0026#34;char_filter\u0026#34;: [ \u0026#34;tsconvert\u0026#34; ], \u0026#34;tokenizer\u0026#34;: \u0026#34;ik_max_word\u0026#34; } }, \u0026#34;char_filter\u0026#34;: { \u0026#34;tsconvert\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;stconvert\u0026#34;, \u0026#34;convert_type\u0026#34; : \u0026#34;t2s\u0026#34; } }, \u0026#34;filter\u0026#34;: { \u0026#34;stconvert\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;stconvert\u0026#34;, \u0026#34;convert_type\u0026#34; : \u0026#34;s2t\u0026#34; } } } }, \u0026#34;mappings\u0026#34;:{ \u0026#34;properties\u0026#34;:{ \u0026#34;id\u0026#34;:{ \u0026#34;type\u0026#34;:\u0026#34;integer\u0026#34; }, \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:\u0026#34;text\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;my_custom_analyzer\u0026#34;, \u0026#34;search_analyzer\u0026#34;: \u0026#34;my_custom_analyzer\u0026#34; }, \u0026#34;create_time\u0026#34;:{ \u0026#34;type\u0026#34;:\u0026#34;date\u0026#34; } } } } GET /stconvert-ik/_analyze { \u0026#34;text\u0026#34;: \u0026#34;ç¨Ÿå¤«äººï¼Œå°äººæœ¬ä½åœ¨è˜‡å·çš„åŸé‚Šï¼Œå®¶ä¸­æœ‰å±‹åˆæœ‰ç”°ï¼Œç”Ÿæ´»æ¨‚ç„¡é‚Šã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–è »æ©«ä¸ç•™æƒ…ï¼Œå‹¾çµå®˜åºœç›®ç„¡å¤©ï¼Œå æˆ‘å¤§å±‹å¥ªæˆ‘ç”°ã€‚æˆ‘çˆºçˆºè·Ÿä»–ä¾†ç¿»è‡‰ï¼Œæ…˜è¢«ä»–ä¸€æ£ä¾†æ‰“æ‰ï¼Œæˆ‘å¥¶å¥¶ç½µä»–æ¬ºé¨™å–„æ°‘ï¼Œåè¢«ä»–æ‰é€²äº†å”åºœï¼Œ å¼·å§¦äº†ä¸€ç™¾éï¼Œä¸€ç™¾éï¼Œæœ€å¾Œå¥¹æ‡¸æ¨‘è‡ªç›¡éºæ¨äººé–“ã€‚ ä»–é‚„å°‡æˆ‘çˆ¶å­ï¼Œé€å‡ºäº†å®¶åœ’ï¼Œæµè½åˆ°æ±Ÿé‚Šã€‚æˆ‘ç‚ºæ±‚é¤Šè€çˆ¹ï¼Œåªæœ‰ç¨è‡ªè¡Œä¹åœ¨å»Ÿå‰ã€‚èª°çŸ¥é‚£å”ä¼¯è™ï¼Œä»–å¯¦åœ¨å¤ªé™°éšª çŸ¥é“æ­¤æƒ…å½¢ï¼Œç«Ÿæ´¾äººä¾†æš—ç®—ï¼ŒæŠŠæˆ‘çˆ¶å­ç‹‚æ¯†åœ¨å¸‚å‰ï¼Œå°äººèº«å£¯å¥ï¼Œæ®˜å‘½å¾—ç•™å­˜ï¼Œå¯æ†è€çˆ¶ä»–é­‚æ­¸å¤©!æ­¤æ¨æ›´é›£å¡«ã€‚ç‚ºæ±‚è‘¬è€çˆ¹ï¼Œå”¯æœ‰è³£èº«ç‚ºå¥´è‡ªä½œè³¤ï¼Œ ä¸€é¢å‹¤è³ºéŒ¢ï¼Œä¸€é¢è®€æ›¸ç¯‡ï¼Œ ç™¼èª“æŠŠåŠŸåé¡¯ï¼Œæ‰‹åˆƒä»‡äººæ„å¿—å …! å¾æ­¤å”å¯…è©©é›†ä¼´èº«é‚Šï¼Œæˆ‘éŠ˜è¨˜æ­¤ä»‡ä¸å…±æˆ´å¤©!!!\u0026#34;, \u0026#34;analyzer\u0026#34;: \u0026#34;my_custom_analyzer\u0026#34; } # æ¸…é™¤ index DELETE /stconvert-ik ","date":"2024-11-25T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/elasticsearch-analyzer/","title":"analyzer åˆ†è©å™¨"},{"content":"Inverted index åå‘ç´¢å¼• å‰è¨€ ç´¢å¼•çš„ç›®çš„æ˜¯ç‚ºäº†å¿«é€Ÿæª¢ç´¢æ•¸æ“šã€‚\næ¯ä¸€ç¨® DB éƒ½æœ‰å…¶é©ç”¨çš„æƒ…å¢ƒï¼Œæ‰€ä»¥æœƒéœ€è¦ä¸åŒçš„æ•¸æ“šçµæ§‹å’Œç´¢å¼•ä¾†è§£æ±ºå•é¡Œã€‚\nå° MySQL ä¾†èªªæ˜¯ B+tree çµæ§‹çš„ç´¢å¼•ï¼Œè€Œåœ¨ Lucene ä¾†èªªæ˜¯ inverted indexã€‚\nInverted index æ˜¯ä»€éº¼? æœ‰åå‘ç´¢å¼•(inverted index) é‚£ç•¶ç„¶å°±æœ‰æ­£å‘ç´¢å¼•(forward index)ã€‚\næ­£å‘ç´¢å¼•(forward index) å°±åƒä¸€æœ¬æ›¸é–‹é ­çš„ç›®éŒ„ä¸€æ¨£ï¼Œæˆ‘å€‘å¯ä»¥ä¾ç…§ç« ç¯€åç¨±ç›´æ¥æ‰¾åˆ°é æ•¸ã€‚\né€™å€‹æ™‚å€™å¦‚æœä½ æƒ³æ‰¾åˆ°åŒ…å«æŸå€‹é—œéµå­—çš„é æ•¸è¦æ€éº¼è¾¦å‘¢ï¼Ÿæœ‰äº›æ›¸çš„å¾Œé¢å°±æœƒåˆ—å‡ºæŸäº›é—œéµå­—å‡ºç¾çš„é æ•¸ï¼Œé€™å°±æ˜¯åå‘ç´¢å¼•(inverted index)çš„ä¸€ç¨®ã€‚\nè®“æˆ‘å€‘çœ‹ä¸€ä¸‹ä¾‹å­ï¼Œå‡è¨­åœ¨æœå°‹å¼•æ“ä¸­å­˜æœ‰ä»¥ä¸‹ç´€éŒ„ï¼š\ndoc_id content 1 æ™‚é–“å°±æ˜¯é‡‘éŒ¢ 2 é‡‘éŒ¢åªæ˜¯ä¸€å †æ•¸å­— 3 é€™æ˜¯æ•¸å­— ä»¥ä¸Šç¯„ä¾‹ doc_id æ˜¯å”¯ä¸€å€¼ï¼Œé€éå”¯ä¸€å€¼å»å°‹æ‰¾æ•´å€‹æ–‡æª”çš„å€¼å°±æ˜¯é‹ç”¨äº†æ­£å‘ç´¢å¼•(forward index)ã€‚\nå¦‚æœæˆ‘æƒ³æ‰¾åˆ° content ä¸­åŒ…å« é‡‘éŒ¢ å…©å€‹å­—çš„æ–‡æª”æ™‚ï¼Œ å°±éœ€è¦ä¸€å€‹ä¸€å€‹æŸ¥çœ‹æ–‡æª”çš„ contentã€‚\né€™æ™‚å€™æˆ‘å€‘å° content åšåå‘ç´¢å¼•(inverted index)ï¼š\nå–®è©(Token) doc_id count doc_id + position æ™‚é–“ [1] 1 [1:0] é‡‘éŒ¢ [1,2] 2 [1:3,2:0] æ•¸å­— [2,3] 2 [2:3,3:0] å¦‚ä¸Šè¡¨ï¼Œå¯ä»¥çœ‹åˆ°é€™æ¨£å°±èƒ½å¿«é€Ÿæ‰¾åˆ°æˆ‘å€‘æƒ³è¦çš„æ–‡æª”ï¼Œé€™ä¹Ÿæ˜¯æœå°‹å¼•æ“çš„è§£æ±ºæ–¹æ¡ˆã€‚\nåƒè€ƒ æœç´¢å¼•æ“ä¹‹å€’æ’ç´¢å¼•æµ…æã€é™„æºç ã€‘_æ­¦åŸ¹è½©_51CTOåšå®¢\nèŠèŠ Elasticsearch çš„å€’æ’ç´¢å¼• - çŸ¥ä¹ (zhihu.com)\nElasticsearch å€’æ’ç´¢å¼•åŸç† - Silverming (xiaoming.net.cn)\nElasticSearch ç´¢å¼• VS MySQL ç´¢å¼• | crossoverJie\u0026rsquo;s Blog\n","date":"2024-11-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/inverted-index/","title":"inverted-index åå‘ç´¢å¼•"},{"content":"å…¨æ–‡æª¢ç´¢ å‡è¨­ä»Šå¤©åœ¨ MySQL ä¸‹æœ‰ä¸€å¼µå« article çš„è¡¨ï¼Œæˆ‘å€‘æƒ³è¦æ‰¾å‡º content(å…§æ–‡) ä¸­åŒ…å« é‡‘éŒ¢ å…©å€‹å­—çš„æ‰€æœ‰æ–‡ç« ï¼Œå°±éœ€è¦ä½¿ç”¨ä»¥ä¸‹æ¨¡ç³ŠæŸ¥è©¢ï¼š\n1 SELECT * FROM article WHERE content LIKE \u0026#39;%èå£«æ¯”äº%\u0026#39;; åœ¨é€™ç¨®æƒ…æ³ä¸‹ MySQL éœ€è¦å…¨è¡¨æƒææ•´å¼µè¡¨çš„ content æ‰èƒ½æ‰¾å‡ºçµæœï¼Œå› æ­¤æœå°‹æ•ˆç‡éå¸¸çš„ä¸å¥½ã€‚\né€™å€‹æ™‚å€™æˆ‘å€‘å°±å»è¦é€éå»ºç«‹ FullText Index æˆ–è€…æ˜¯ä½¿ç”¨æœå°‹å¼•æ“(solrã€elasticsearch\u0026hellip;)ä¾†å„ªåŒ–æŸ¥è©¢ã€‚\nç²¾ç¢ºåŒ¹é…å’Œç›¸é—œæ€§åŒ¹é… é‚„æœ‰ä»€éº¼åŸå› éœ€è¦æœå°‹å¼•æ“å‘¢ï¼Ÿ\nå‡è¨­æˆ‘å€‘æœ‰ä¸€ä¸‹è³‡æ–™ï¼š\nid content 1 èå£«æ¯”äºçš„æ•…äº‹ 2 å“ˆå§†é›·ç‰¹ä½œè€…çš„æ•…äº‹ 3 ç¾…å¯†æ­èˆ‡èŒ±éº—è‘‰ä½œè€…çš„æ•…äº‹ ç•¶ä½¿ç”¨è€…è¼¸å…¥ æ²™å£«æ¯”å£“ï¼Œå¦‚æœæˆ‘å€‘ä½¿ç”¨ MySQL é€²è¡Œä¸€èˆ¬çš„æ¨¡ç³ŠæŸ¥è©¢ï¼š\n1 SELECT * FROM article WHERE content LIKE \u0026#39;%æ²™å£«æ¯”å£“%\u0026#39;; å¾ˆé¡¯ç„¶é€™æ¨£æˆ‘å€‘ä¸æœƒå¾—åˆ°ä»»ä½•çµæœï¼Œå› ç‚ºé€™æ˜¯ä¸€å€‹è¦æ±‚ã€Œç²¾ç¢ºåŒ¹é…ã€çš„ã€Œæ¨¡ç³ŠæŸ¥è©¢ã€ã€‚\n1 GET /article/_doc/_search?q=content:æ²™å£«æ¯”å£“ åœ¨ä½¿ç”¨è³‡æ–™åº«æœç´¢æ™‚ï¼Œæˆ‘å€‘æ›´å¤šçš„æ˜¯åŸºæ–¼ã€Œç²¾ç¢ºåŒ¹é…ã€çš„æœç´¢ã€‚\nä»€éº¼æ˜¯ã€Œç²¾ç¢ºåŒ¹é…ã€ï¼Ÿ\næ¯”å¦‚æœè¨‚å–®ï¼Œæ ¹æ“šè¨‚å–®ç‹€æ…‹ï¼Œæº–ç¢ºæœç´¢ã€‚ æœã€Œå·²å®Œæˆã€ï¼Œå°±è¦ã€Œç²¾ç¢ºåŒ¹é…ã€ã€Œå·²å®Œæˆã€çš„è¨‚å–®ï¼Œæœã€Œå¾…æ”¯ä»˜ã€ï¼Œå°±è¦ã€Œç²¾ç¢ºåŒ¹é…ã€ã€Œå¾…æ”¯ä»˜ã€çš„è¨‚å–®ã€‚\né€™ç¨®ã€Œç²¾ç¢ºåŒ¹é…ã€çš„æœç´¢èƒ½åŠ›ï¼Œå‚³çµ±é—œä¿‚å‹è³‡æ–™åº«æ˜¯éå¸¸å‹ä»»çš„ã€‚\nå’Œã€Œç²¾ç¢ºåŒ¹é…ã€ç›¸æ¯”ï¼Œã€Œç›¸é—œæ€§åŒ¹é…ã€æ›´è²¼è¿‘äººçš„æ€ç¶­æ–¹å¼ã€‚\næ¯”å¦‚æˆ‘è¦æœä¸€é–€è¬›éã€Œèå£«æ¯”äºã€çš„èª²ç¨‹ï¼Œæˆ‘éœ€è¦åœ¨èª²ç¨‹çš„æ–‡ç¨¿é‡Œé€²è¡Œã€Œç›¸é—œæ€§åŒ¹é…ã€ï¼Œæ‰¾åˆ°å°æ‡‰çš„æ–‡ç¨¿ï¼Œä½ å¯èƒ½è¦ºå¾—ä¸€æ¢ sql èªå¥å°±å¯ä»¥è§£æ±ºé€™å€‹å•é¡Œï¼š\n1 select * from course where content like \u0026#34;%èå£«æ¯”äºš%\u0026#34; ç„¶è€Œï¼Œé€™éš»èƒ½ç®—æ˜¯ã€Œæ¨¡ç³ŠæŸ¥è©¢ã€ï¼Œç”¨ä½ è¦æœç´¢çš„å­—ä¸²ï¼Œå»ã€Œç²¾ç¢ºã€çš„ã€Œæ¨¡ç³ŠæŸ¥è©¢ã€ï¼Œå…¶å¯¦é‚„æ˜¯ã€Œç²¾ç¢ºåŒ¹é…ã€ï¼Œæ©Ÿæ¢°æ€ç¶­ã€‚\né‚£éº¼åˆ°åº•ä»€éº¼æ˜¯ã€Œç›¸é—œæ€§åŒ¹é…ã€ï¼Œä»€éº¼æ‰æ˜¯ã€Œäººçš„æ€ç¶­ã€å‘¢ï¼Ÿ\næ¯”å¦‚æˆ‘æœã€Œèå£«æ¯”äºã€ï¼Œæˆ‘è¦çš„è‚¯å®šä¸åªæ˜¯ç²¾ç²¾ç¢ºç¢ºåŒ…å«ã€Œèå£«æ¯”äºã€çš„æ–‡ç¨¿ï¼Œæˆ‘å¯èƒ½é‚„è¦æœã€Œèç¿ã€ã€ã€ŒShakespeareã€ã€ã€Œå“ˆå§†é›·ç‰¹ã€ã€ã€Œç¾…å¯†æ­å’Œæœ±éº—è‘‰ã€ã€ã€Œå¨å°¼æ–¯çš„å•†äººã€\u0026hellip;\nåˆæ¯”å¦‚æˆ‘è¼¸éŒ¯äº†ï¼Œè¼¸æˆã€Œèå£«ç­†äºã€ï¼Œã€Œç›¸é—œæ€§åŒ¹é…ã€å¯ä»¥æ™ºæ…§çš„å¹«æˆ‘å„ªåŒ–ç‚ºã€Œèå£«æ¯”äºã€ï¼Œè¿”å›å°æ‡‰çš„æœå°‹çµæœã€‚\né€™å°±æ˜¯æœå°‹å¼•æ“çš„å¼·å¤§ä¹‹è™•ï¼Œå®ƒä¼¼ä¹å¯ä»¥ç†è§£ä½ çš„çœŸå¯¦æ„åœ–ã€‚\nåŸç† Inverted index åå‘ç´¢å¼•\nanalyzer åˆ†è©å™¨\nå·¥å…· FullText Index(å…¨æ–‡æª¢ç´¢)\nelastic\nSolr\nåƒè€ƒ ä¸ºä»€ä¹ˆéœ€è¦ Elasticsearch - çŸ¥ä¹ (zhihu.com)\n","date":"2024-11-20T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/fulltext-search/","title":"å…¨æ–‡æª¢ç´¢"},{"content":"Materialized MySQL (å¯¦é©—æ€§) ClickHouse æä¾›äº† MaterializedMySQL çš„ database engine å…è¨± ClickHouse ä½œç‚º MySQL çš„ replicaï¼Œé€éè®€å– MySQL çš„ binlog ä¾†åŸ·è¡Œ DDLã€DML åˆ° ClickHouse ä¸Š\nMySQL server åœ¨å»ºç«‹ MySQL å’Œ ClickHouse çš„åŒæ­¥ä¹‹å‰ï¼Œåœ¨ MySQL Server é€™é‚Šéœ€è¦æœ‰ä»¥ä¸‹è¨­å®šï¼š\nMySQL éœ€è¦é–‹å•Ÿ gtid æ¨¡å¼ï¼š\n1 2 gtid-mode = ON enforce-gtid-consistency = ON å»ºç«‹ ClickHouse é€£ç·šæ‰€éœ€çš„æ¬Šé™ï¼Œéœ€æ³¨æ„ ClickHouse åªèƒ½ä½¿ç”¨ mysql_native_password çš„ plugin ä¾†é€£ç·š MySQL é€²è¡Œé©—è­‰ï¼š\n1 2 CREATE USER clickhouse@\u0026#39;%\u0026#39; IDENTIFIED WITH mysql_native_password BY \u0026#39;ClickHouse\u0026#39;; GRANT RELOAD, REPLICATION SLAVE, REPLICATION CLIENT,SELECT ON *.* TO clickhouse@\u0026#39;%\u0026#39;; ClickHouse è¨­å®š è¨­ç½®ä»¥ä¸‹è¨­å®š\n1 set allow_experimental_database_materialized_mysql = 1; 1 2 3 CREATE DATABASE [IF NOT EXISTS] db_name [ON CLUSTER cluster] ENGINE = MaterializedMySQL(\u0026#39;host:port\u0026#39;, [\u0026#39;database\u0026#39; | database], \u0026#39;user\u0026#39;, \u0026#39;password\u0026#39;) [SETTINGS ...] [TABLE OVERRIDE table1 (...), TABLE OVERRIDE table2 (...)] SETTINGS æä¾›çš„åƒæ•¸ max_rows_in_bufferï¼šå…è¨±æ•¸æ“šåœ¨å…§å­˜ä¸­æœ€å¤§çš„è¡Œæ•¸ï¼Œç•¶è¶…éæ­¤è¨­å®šæ™‚æ•¸æ“šå°‡è¢« materializedï¼Œé è¨­å€¼ç‚º 65505 max_bytes_in_buffer max_flush_data_time max_wait_time_when_mysql_unavailable allows_query_when_mysql_lost materialized_mysql_tables_list 1 2 3 4 5 6 7 8 CREATE DATABASE db1_mysql ENGINE = MaterializedMySQL( \u0026#39;mysql-host.domain.com:3306\u0026#39;, \u0026#39;db1\u0026#39;, \u0026#39;clickhouse_user\u0026#39;, \u0026#39;ClickHouse_123\u0026#39; ); ","date":"2024-10-17T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-materialized-mysql/","title":"ClickHouse Materialized MySQL"},{"content":"TPC-H æ¸¬è©¦ å®‰è£ åˆ° TPC å®˜æ–¹ä¸‹è¼‰ TPC-H å·¥å…·\né€™å€‹æ­¥é©Ÿéœ€å¡«å¯« emailï¼Œä¸‹è¼‰é€£çµæœƒå¯„åˆ° email\nè§£å£“ç¸®æª”æ¡ˆï¼Œä¸¦å»ºç«‹ Makefile æª”æ¡ˆ\n1 2 3 4 unzip 025654ff-3a66-4e25-9f7c-ee2f2e6bbf18-tpc-h-tool.zip mv \u0026#39;TPC-H V3.0.1\u0026#39; \u0026#39;TPC-H_Tools_v3.0.1\u0026#39; cd ./TPC-H_Tools_v3.0.1/dbgen cp makefile.suite Makefile MySQL ä¿®æ”¹ Makefile ä¸­çš„ CCã€DATABASEã€MACHINEã€WORKLOAD ç­‰åƒæ•¸è¨­å®š\n1 2 3 4 5 6 7 8 9 10 -\u0026gt; ~ vim Makefile CC = gcc # Current values for DATABASE are: INFORMIX, DB2, TDAT (Teradata) # SQLSERVER, SYBASE, ORACLE, VECTORWISE # Current values for MACHINE are: ATT, DOS, HP, IBM, ICL, MVS, # SGI, SUN, U2200, VMS, LINUX, WIN32 # Current values for WORKLOAD are: TPCH DATABASE= MYSQL MACHINE = LINUX WORKLOAD = TPCH ä¿®æ”¹ tpcd.h æ–‡ä»¶ï¼Œæ–°å¢ mysql ç›¸é—œå®šç¾©\n1 2 3 4 5 6 7 8 9 -\u0026gt; ~ vim tpcd.h #ifdef MYSQL #define GEN_QUERY_PLAN \u0026#34;\u0026#34; #define START_TRAN \u0026#34;START TRANSACTION\u0026#34; #define END_TRAN \u0026#34;COMMIT\u0026#34; #define SET_OUTPUT \u0026#34;\u0026#34; #define SET_ROWCOUNT \u0026#34;limit %d;\\n\u0026#34; #define SET_DBASE \u0026#34;use %s;\\n\u0026#34; #endif ç·¨è­¯\n1 make ç·¨è­¯å¾Œè©²ç›®éŒ„æœƒå¤šå‡º 2 å€‹å¯åŸ·è¡Œæª”ï¼š\ndbgenï¼šç”¢ç”Ÿæ¸¬è©¦æ•¸æ“šçš„å·¥å…· qgenï¼šç”¢ç”Ÿ SQL èªå¥çš„å·¥å…· é€é dbgen ç”¢ç”Ÿæ¸¬è©¦æ•¸æ“š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # ç”¢ç”Ÿ 5G æ•¸æ“š ./dbgen -s 5 # å°‡æ•¸æ“šæ–‡ä»¶æ”¾åˆ°è³‡æ–™å¤¾æ–¹ä¾¿è™•ç† mkdir test mv *.tbl test/ -\u0026gt; ~ ll -h tpch5/ ç¸½è¨ˆ 5.3G -rw-r--r-- 1 root root 117M 12æœˆ 23 16:36 customer.tbl -rw-r--r-- 1 root root 3.6G 12æœˆ 23 16:36 lineitem.tbl -rw-r--r-- 1 root root 2.2K 12æœˆ 23 16:36 nation.tbl -rw-r--r-- 1 root root 830M 12æœˆ 23 16:36 orders.tbl -rw-r--r-- 1 root root 573M 12æœˆ 23 16:36 partsupp.tbl -rw-r--r-- 1 root root 116M 12æœˆ 23 16:36 part.tbl -rw-r--r-- 1 root root 389 12æœˆ 23 16:36 region.tbl -rw-r--r-- 1 root root 6.8M 12æœˆ 23 16:36 supplier.tbl èªªæ˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 æ•°æ®é‡çš„å¤§å°å¯¹æŸ¥è¯¢é€Ÿåº¦æœ‰ç›´æ¥çš„å½±å“ï¼ŒTPC-Hä¸­ä½¿ç”¨SFæè¿°æ•°æ®é‡ï¼Œ1SFå¯¹åº”1 GBå•ä½ã€‚1000SFï¼Œå³1 TBã€‚1SFå¯¹åº”çš„æ•°æ®é‡åªæ˜¯8ä¸ªè¡¨çš„æ€»æ•°æ®é‡ä¸åŒ…æ‹¬ç´¢å¼•ç­‰ç©ºé—´å ç”¨ï¼Œå‡†å¤‡æ•°æ®æ—¶éœ€é¢„ç•™æ›´å¤šç©ºé—´ã€‚ -sè¡¨ç¤ºsfå€¼ï¼Œå¦‚-s 1è¡¨ç¤ºç”Ÿæˆ1Gæ•°æ®ï¼š -s 0.16æœ€å¤§è¡¨lineitemçº¦96ä¸‡æ¡æ•°æ® -s 1.6æœ€å¤§è¡¨lineitemçº¦960ä¸‡æ¡æ•°æ® -s 16æœ€å¤§è¡¨lineitemçº¦0.96äº¿æ¡æ•°æ® -s 20æœ€å¤§è¡¨lineitemçº¦1.2äº¿æ¡æ•°æ® -Sè¡¨ç¤ºå½“å‰å‘½ä»¤ç”Ÿæˆç¬¬å‡ ä¸ª chunkã€‚ -Cè¡¨ç¤ºä¸€å…±åˆ†æˆå‡ ä¸ªchunkã€‚ä¸€æ¡è¯­å¥åªèƒ½ç”Ÿæˆä¸€ä¸ª chunkã€‚ -fè¡¨ç¤ºå¼ºåˆ¶ç”Ÿæˆï¼Œä¼šæ›¿æ¢ä¹‹å‰ç”Ÿæˆçš„.tblæ–‡ä»¶ æ›´å¤šdbgenå‘½ä»¤è¯´æ˜è¯·ä½¿ç”¨./dbgen --helpæŸ¥çœ‹ï¼š -C \u0026lt;n\u0026gt; â€“ separate data set into \u0026lt;n\u0026gt; chunks (requires -S, default: 1) -f â€“ force. Overwrite existing files -h â€“ display this message -q â€“ enable QUIET mode -s \u0026lt;n\u0026gt; â€“ set Scale Factor (SF) to \u0026lt;n\u0026gt; (default: 1) -S \u0026lt;n\u0026gt; â€“ build the \u0026lt;n\u0026gt;th step of the data/update set (used with -C or -U) -U \u0026lt;n\u0026gt; â€“ generate \u0026lt;n\u0026gt; update sets -v â€“ enable VERBOSE mode -b \u0026lt;s\u0026gt; â€“ load distributions for \u0026lt;s\u0026gt; (default: dists.dss) -d \u0026lt;n\u0026gt; â€“ split deletes between \u0026lt;n\u0026gt; files (requires -U) -i \u0026lt;n\u0026gt; â€“ split inserts between \u0026lt;n\u0026gt; files (requires -U) -T c â€“ generate cutomers ONLY -T l â€“ generate nation/region ONLY -T L â€“ generate lineitem ONLY -T n â€“ generate nation ONLY -T o â€“ generate orders/lineitem ONLY -T O â€“ generate orders ONLY -T p â€“ generate parts/partsupp ONLY -T P â€“ generate parts ONLY -T r â€“ generate region ONLY -T s â€“ generate suppliers ONLY -T S â€“ generate partsupp ONLY To generate the SF=1 (1GB), validation database population, use: dbgen -vf -s 1 To generate updates for a SF=1 (1GB), use: dbgen -v -U 1 -s 1 å»ºç«‹ schema\nschema\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 create table part ( p_partkey bigint not null, p_name varchar(55) not null, p_mfgr char(25) not null, p_brand char(10) not null, p_type varchar(25) not null, p_size bigint not null, p_container char(10) not null, p_retailprice decimal(15,2) not null, p_comment varchar(23) not null, primary key (p_partkey) ) engine = innodb; create table supplier ( s_suppkey bigint not null, s_name char(25) not null, s_address varchar(40) not null, s_nationkey bigint not null, s_phone char(15) not null, s_acctbal decimal(15,2) not null, s_comment varchar(101) not null, primary key (s_suppkey) ) engine = innodb; create table partsupp ( ps_partkey bigint not null, ps_suppkey bigint not null, ps_availqty bigint not null, ps_supplycost decimal(15,2) not null, ps_comment varchar(199) not null, primary key (ps_partkey, ps_suppkey) ) engine = innodb; create table customer ( c_custkey bigint not null, c_name varchar(25) not null, c_address varchar(40) not null, c_nationkey bigint not null, c_phone char(15) not null, c_acctbal decimal(15,2) not null, c_mktsegment char(10) not null, c_comment varchar(117) not null, primary key (c_custkey) ) engine = innodb; create table orders ( o_orderkey bigint not null, o_custkey bigint not null, o_orderstatus char(1) not null, o_totalprice decimal(15,2) not null, o_orderdate date not null, o_orderpriority char(15) not null, o_clerk char(15) not null, o_shippriority bigint not null, o_comment varchar(79) not null, primary key (o_orderkey) ) engine = innodb; create table lineitem ( l_orderkey bigint not null, l_partkey bigint not null, l_suppkey bigint not null, l_linenumber bigint not null, l_quantity decimal(15,2) not null, l_extendedprice decimal(15,2) not null, l_discount decimal(15,2) not null, l_tax decimal(15,2) not null, l_returnflag char(1) not null, l_linestatus char(1) not null, l_shipdate date not null, l_commitdate date not null, l_receiptdate date not null, l_shipinstruct char(25) not null, l_shipmode char(10) not null, l_comment varchar(44) not null, primary key (l_orderkey, l_linenumber) ) engine = innodb; create table nation ( n_nationkey bigint not null, n_name char(25) not null, n_regionkey bigint not null, n_comment varchar(152), primary key (n_nationkey) ) engine = innodb; create table region ( r_regionkey bigint not null, r_name char(25) not null, r_comment varchar(152), primary key (r_regionkey) ) engine = innodb; 1 2 mysql -uroot -S/var/lib/mysql-replica01/mysql.sock -e\u0026#34;CREATE DATABASE test\u0026#34; mysql -uroot -S/var/lib/mysql-replica01/mysql.sock -Dtest \u0026lt; tpch_mysql_schema.sql åŒ¯æ•¸æ“š\n1 2 # client ç«¯éœ€åŠ ä¸Š --local-infile=1 æ‰èƒ½ LOAD DATA mysql -uroot -S/var/lib/mysql-replica01/mysql.sock --local-infile=1 -Dtest 1 2 3 4 5 6 7 8 9 10 11 # local_infile = ON æ‰èƒ½ LOAD DATA SET GLOBAL local_infile = \u0026#39;ON\u0026#39;; # LOAD DATA LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/customer.tbl\u0026#39; INTO TABLE customer FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/lineitem.tbl\u0026#39; INTO TABLE lineitem FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/nation.tbl\u0026#39; INTO TABLE nation FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/orders.tbl\u0026#39; INTO TABLE orders FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/part.tbl\u0026#39; INTO TABLE part FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/partsupp.tbl\u0026#39; INTO TABLE partsupp FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/region.tbl\u0026#39; INTO TABLE region FIELDS TERMINATED BY \u0026#39;|\u0026#39;; LOAD DATA LOCAL INFILE \u0026#39;/root/TPC-H_Tools_v3.0.1/dbgen-clickhouse/test_data/supplier.tbl\u0026#39; INTO TABLE supplier FIELDS TERMINATED BY \u0026#39;|\u0026#39;; ClickHouse ä¿®æ”¹ Makefile ä¸­çš„ CCã€DATABASEã€MACHINEã€WORKLOAD ç­‰åƒæ•¸è¨­å®š\n1 2 3 4 5 6 7 8 9 10 -\u0026gt; ~ vim Makefile CC = gcc # Current values for DATABASE are: INFORMIX, DB2, TDAT (Teradata) # SQLSERVER, SYBASE, ORACLE, VECTORWISE # Current values for MACHINE are: ATT, DOS, HP, IBM, ICL, MVS, # SGI, SUN, U2200, VMS, LINUX, WIN32 # Current values for WORKLOAD are: TPCH DATABASE= CLICKHOUSE MACHINE = LINUX WORKLOAD = TPCH ä¿®æ”¹ tpcd.h æ–‡ä»¶ï¼Œæ–°å¢ mysql ç›¸é—œå®šç¾©\n1 2 3 4 5 6 7 8 9 -\u0026gt; ~ vim tpcd.h #ifdef CLICKHOUSE #define GEN_QUERY_PLAN \u0026#34;\u0026#34; #define START_TRAN \u0026#34;\u0026#34; #define END_TRAN \u0026#34;\u0026#34; #define SET_OUTPUT \u0026#34;\u0026#34; #define SET_ROWCOUNT \u0026#34;limit %d;\\n\u0026#34; #define SET_DBASE \u0026#34;use %s;\\n\u0026#34; #endif ç·¨è­¯\n1 make ç·¨è­¯å¾Œè©²ç›®éŒ„æœƒå¤šå‡º 2 å€‹å¯åŸ·è¡Œæª”ï¼š\ndbgenï¼šç”¢ç”Ÿæ¸¬è©¦æ•¸æ“šçš„å·¥å…· qgenï¼šç”¢ç”Ÿ SQL èªå¥çš„å·¥å…· ç”¢ç”Ÿæ¸¬è©¦æ•¸æ“š\n1 2 3 ./dbgen -s 5 mkdir test_data mv *.tbl test_data åŒ¯å…¥æ•¸æ“š\nCH schema\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 create table part ( p_partkey bigint not null, p_name varchar(55) not null, p_mfgr char(25) not null, p_brand char(10) not null, p_type varchar(25) not null, p_size bigint not null, p_container char(10) not null, p_retailprice decimal(15,2) not null, p_comment varchar(23) not null ) engine = MergeTree order by (p_partkey); create table supplier ( s_suppkey bigint not null, s_name char(25) not null, s_address varchar(40) not null, s_nationkey bigint not null, s_phone char(15) not null, s_acctbal decimal(15,2) not null, s_comment varchar(101) not null ) engine = MergeTree order by (s_suppkey); create table partsupp ( ps_partkey bigint not null, ps_suppkey bigint not null, ps_availqty bigint not null, ps_supplycost decimal(15,2) not null, ps_comment varchar(199) not null ) engine = MergeTree order by (ps_partkey, ps_suppkey); create table customer ( c_custkey bigint not null, c_name varchar(25) not null, c_address varchar(40) not null, c_nationkey bigint not null, c_phone char(15) not null, c_acctbal decimal(15,2) not null, c_mktsegment char(10) not null, c_comment varchar(117) not null ) engine = MergeTree order by (c_custkey); create table orders ( o_orderkey bigint not null, o_custkey bigint not null, o_orderstatus char(1) not null, o_totalprice decimal(15,2) not null, o_orderdate date not null, o_orderpriority char(15) not null, o_clerk char(15) not null, o_shippriority bigint not null, o_comment varchar(79) not null ) engine = MergeTree order by (o_orderkey); create table lineitem ( l_orderkey bigint not null, l_partkey bigint not null, l_suppkey bigint not null, l_linenumber bigint not null, l_quantity decimal(15,2) not null, l_extendedprice decimal(15,2) not null, l_discount decimal(15,2) not null, l_tax decimal(15,2) not null, l_returnflag char(1) not null, l_linestatus char(1) not null, l_shipdate date not null, l_commitdate date not null, l_receiptdate date not null, l_shipinstruct char(25) not null, l_shipmode char(10) not null, l_comment varchar(44) not null ) engine = MergeTree order by (l_orderkey, l_linenumber); create table nation ( n_nationkey bigint not null, n_name char(25) not null, n_regionkey bigint not null, n_comment varchar(152) ) engine = MergeTree order by (n_nationkey); create table region ( r_regionkey bigint not null, r_name char(25) not null, r_comment varchar(152) ) engine = MergeTree order by (r_regionkey); 1 2 3 4 5 6 7 8 9 10 11 clickhouse client -q \u0026#34;CREATE DATABASE IF NOT EXISTS test\u0026#34; clickhouse client -n --queries-file tpch_ch_schema.sql -d test clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.customer format CSV\u0026#34; \u0026lt; customer.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.lineitem format CSV\u0026#34; \u0026lt; lineitem.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.nation format CSV\u0026#34; \u0026lt; nation.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.orders format CSV\u0026#34; \u0026lt; orders.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.partsupp format CSV\u0026#34; \u0026lt; partsupp.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.part format CSV\u0026#34; \u0026lt; part.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.region format CSV\u0026#34; \u0026lt; region.tbl clickhouse client -m --format_csv_delimiter=\u0026#34;|\u0026#34; --query=\u0026#34;insert into test.supplier format CSV\u0026#34; \u0026lt; supplier.tbl MySQL \u0026amp; ClickHouse æ¸¬è©¦ è¦æ ¼ æ©Ÿå™¨è¦æ ¼ï¼ˆå€‹äºº Citrix Linux æ©Ÿå™¨ï¼‰ï¼š CPUï¼š2 Core Memoryï¼š8 GB DB çš†ä½¿ç”¨ 7GB memory DB çš†ç‚ºå–® node å„å€‹ Table è³‡æ–™é‡ï¼š lineitemï¼š59,986,052 customerï¼š1,500,000 nationï¼š25 ordersï¼š15,000,000 partï¼š2,000,000 partsuppï¼š8,000,000 regionï¼š5 supplierï¼š100,000 æ¸¬è©¦çµæœ å¯«å…¥å¾Œä½”ç”¨ç©ºé–“é‡ (MySQL ç´„ç‚º ClickHouse çš„ 4 å€)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 localhost :) SELECT table, formatReadableSize(sum(bytes)) AS size FROM system.parts WHERE active AND database = \u0026#39;test\u0026#39; GROUP BY table; â”Œâ”€tableâ”€â”€â”€â”€â”¬â”€sizeâ”€â”€â”€â”€â”€â”€â”€â” â”‚ lineitem â”‚ 2.70 GiB â”‚ â”‚ orders â”‚ 614.02 MiB â”‚ â”‚ partsupp â”‚ 447.38 MiB â”‚ â”‚ customer â”‚ 121.90 MiB â”‚ â”‚ part â”‚ 89.70 MiB â”‚ â”‚ supplier â”‚ 7.55 MiB â”‚ â”‚ nation â”‚ 1.66 KiB â”‚ â”‚ region â”‚ 523.00 B â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 8 rows in set. Elapsed: 0.008 sec. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 SELECT TABLE_NAME, CASE WHEN floor(( DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024 / 1024) \u0026gt; 0 THEN CONCAT(ROUND((( DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024 / 1024),2), \u0026#34;GB\u0026#34;) WHEN floor(( DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024 ) \u0026gt; 0 THEN CONCAT(ROUND((( DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024 ),2), \u0026#34;MB\u0026#34;) WHEN floor(( DATA_LENGTH + INDEX_LENGTH) / 1024) \u0026gt; 0 THEN CONCAT(ROUND((( DATA_LENGTH + INDEX_LENGTH) / 1024),2), \u0026#34;KB\u0026#34;) ELSE CONCAT((( DATA_LENGTH + INDEX_LENGTH)), \u0026#34;Byte\u0026#34;) END AS `size` FROM information_schema.TABLES WHERE TABLE_SCHEMA = \u0026#39;test\u0026#39; ORDER BY DATA_LENGTH DESC; +------------+----------+ | TABLE_NAME | size | +------------+----------+ | lineitem | 8.05GB | | orders | 2.06GB | | partsupp | 2.03GB | | part | 329.89MB | | customer | 290.84MB | | supplier | 18.55MB | | nation | 16.00KB | | region | 16.00KB | +------------+----------+ 8 rows in set (0.01 sec) ç„¡ä»»ä½•å„ªåŒ–\nTPC-H èªæ³• èªæ³•é¡å‹ MySQL ClickHouse 1.sql lineitem GROUP BY 1m17.663s 0m1.780s 2.sql part, supplier, partsupp, nation, region äº”è¡¨ JOIN 0m22.257s 2m17.674s 3.sql customer, orders, lineitem ä¸‰è¡¨ JOIN 0m29.132s 0m3.624s 4.sql 0m26.961s 0m1.760s 5.sql 0m35.477s 0m5.084s 6.sql 0m0.012s 0m0.571s 7.sql 0m57.946s 0m17.775s 8.sql 0m57.167s 0m48.609s 9.sql 4m13.980s 4m48.043s 10.sql 0m59.013s 0m3.348s 11.sql 0m0.010s 0m4.750s 12.sql 0m33.102s 0m1.271s 13.sql 0m20.790s 0m3.518s 14.sql 0m0.013s 0m0.925s 15.sql 0m26.780s 0m1.196s 16.sql 0m10.672s 0m1.082s 17.sql 0m0.010s 0m2.975s 18.sql 0m28.808s 0m7.432s 19.sql 0m40.692s è¶…é 30 m 20.sql 0m47.100s 0m3.690s 21.sql 1m47.974s 0m36.074s 22.sql 0m0.011s 0m0.371s TPC-H èªæ³• èªæ³•é¡å‹ MySQL ClickHouse 1.sql lineitem GROUP BY 2m35.400s 0m4.737s 2.sql part, supplier, partsupp, nation, region äº”è¡¨ JOIN 0m44.018s 9m12.907s 3.sql customer, orders, lineitem ä¸‰è¡¨ JOIN 1m3.439s 0m8.025s 4.sql 1m3.102s 0m3.722s 5.sql 1m15.256s 0m11.686s 6.sql 0m0.059s 0m1.156s 7.sql 1m44.087s 0m39.855s 8.sql 1m50.143s 3m37.400s 9.sql 6m31.232s 24m26.138s 10.sql 1m57.491s 0m6.302s 11.sql 0m0.065s 0m8.977s 12.sql 0m58.876s 0m2.719s 13.sql 0m41.079s 0m7.431s 14.sql 0m0.050s 0m1.613s 15.sql 0m45.950s 0m2.278s 16.sql 0m30.624s 0m1.245s 17.sql 0m0.060s 0m5.937s 18.sql 0m46.592s 0m15.944s 19.sql 1m4.889s è¶…é 30 m 20.sql 4m0.176s 0m4.841s 21.sql 8m58.563s 1m18.094s 22.sql 0m0.061s 0m1.139s Query å…§å®¹ Q1ï¼šå–®å¼µå¤§è¡¨ GROUP BY 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 select l_returnflag, l_linestatus, sum(l_quantity) as sum_qty, sum(l_extendedprice) as sum_base_price, sum(l_extendedprice*(1-l_discount)) as sum_disc_price, sum(l_extendedprice*(1-l_discount)*(1+l_tax)) as sum_charge, avg(l_quantity) as avg_qty, avg(l_extendedprice) as avg_price, avg(l_discount) as avg_disc, count(*) as count_order from lineitem where l_shipdate \u0026lt;= date \u0026#39;1998-12-01\u0026#39; - interval \u0026#39;[DELTA]\u0026#39; day (3) //DELTAæ˜¯60~120å†…çš„å€¼ group by l_returnflag, l_linestatus order by l_returnflag, l_linestatus; Q2ï¼šäº”å¼µè¡¨ JOIN 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 select s_acctbal, s_name, n_name, p_partkey, p_mfgr, s_address, s_phone, s_comment /*æŸ¥è¯¢ä¾›åº”è€…çš„å¸æˆ·ä½™é¢ã€åå­—ã€å›½å®¶ã€é›¶ä»¶çš„å·ç ã€ç”Ÿäº§è€…ã€ä¾›åº”è€…çš„åœ°å€ã€ç”µè¯å·ç ã€å¤‡æ³¨ä¿¡æ¯ */ from part, supplier, partsupp, nation, region //äº”è¡¨è¿æ¥ where p_partkey = ps_partkey and s_suppkey = ps_suppkey and p_size = [SIZE] //æŒ‡å®šå¤§å°ï¼Œåœ¨åŒºé—´[1, 50]å†…éšæœºé€‰æ‹© and p_type like \u0026#39;%[TYPE]\u0026#39; //æŒ‡å®šç±»å‹ï¼Œåœ¨TPC-Hæ ‡å‡†æŒ‡å®šçš„èŒƒå›´å†…éšæœºé€‰æ‹© and s_nationkey = n_nationkey and n_regionkey = r_regionkey and r_name = \u0026#39;[REGION]\u0026#39; //æŒ‡å®šåœ°åŒºï¼Œåœ¨TPC-Hæ ‡å‡†æŒ‡å®šçš„èŒƒå›´å†…éšæœºé€‰æ‹© and ps_supplycost = ( //å­æŸ¥è¯¢ select min(ps_supplycost) //èšé›†å‡½æ•° from partsupp, supplier, nation, region //ä¸çˆ¶æŸ¥è¯¢çš„è¡¨æœ‰é‡å  where p_partkey = ps_partkey and s_suppkey = ps_suppkey and s_nationkey = n_nationkey and n_regionkey = r_regionkey and r_name = \u0026#39;[REGION]\u0026#39; ) order by //æ’åº ç¸½çµ å¯ä»¥çœ‹å‡ºä¾† ClickHouse æ“…é•·çš„æ˜¯å–®å¼µå¤§è¡¨èšåˆæŸ¥è©¢ï¼Œä¸æ“…é•·æ–¼å¤šè¡¨ JOIN æŸ¥è©¢ã€‚\n","date":"2024-10-16T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-tpch-test/","title":"ClickHouse TPC-H Test"},{"content":"æœ¬æ–‡è¼ƒé•·å»ºè­°æ­é…å³å´ç›®éŒ„é»æ“ŠæŸ¥çœ‹ã€‚\nHOW? å»ºç«‹ä¸€å¼µå’ŒåŸè¡¨çµæ§‹ç›¸åŒçš„ ghost è¡¨ ALTER ghost è¡¨ gh-ost å½è£æˆ SLAVE å¾ Master/Slave æ‹‰å– binlog å°‡è³‡æ–™å¯«å…¥ ghost è¡¨ å°‡ binlog event æ‡‰ç”¨åˆ° ghost è¡¨ å¾åŸè¡¨è¤‡è£½ rows åˆ° ghost è¡¨ åˆ‡æ› ghost è¡¨å’ŒåŸè¡¨ ä¸Šè¿°çš„æ­¥é©Ÿä¸­å¯ä»¥çœ‹å‡º gh-ost çš„å¤§éƒ¨åˆ†å’Œå…¶ä»–online DDL å·¥å…·å¤§é«”ç›¸åŒï¼Œå”¯ä¸€çš„ä¸åŒè™•å°±æ˜¯ gh-ost ä¸æ˜¯åŸºæ–¼ trigger ã€‚ gh-ost çš„é–‹ç™¼åœ˜éšŠèªç‚ºä½¿ç”¨ trigger æœ‰è¨±å¤šçš„é™åˆ¶èˆ‡é¢¨éšªï¼Œæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒå®˜æ–¹æ–‡æª” Why triggerless é€™ç¯‡èªªæ˜ã€‚\nå–è€Œä»£ä¹‹çš„æ˜¯ gh-ost é€é binlog ä¾†ç²å–åŸè¡¨è³‡æ–™çš„æ”¹å‹•ï¼Œä¸¦å°‡ä¹‹ç•°æ­¥æ‡‰ç”¨åˆ° ghost è¡¨ã€‚ gh-ost æ‰¿æ“”äº†å…¶ä»–å·¥å…·ç•™çµ¦ DATABASE åŸ·è¡Œçš„ä»»å‹™(trigger)ï¼Œç­‰æ–¼æ˜¯å®Œå…¨åˆ†é›¢äº†é·ç§»è³‡æ–™æ™‚çš„å¯«Loadingå’Œ DATABASE æœå‹™æœ¬èº«çš„ Loadingï¼Œå› æ­¤ gh-ost å¯èƒ½æ›´å¥½çš„æ§åˆ¶æ•´å€‹é·ç§»çš„éç¨‹ï¼Œå¯ä»¥åšåˆ°çœŸæ­£çš„æš«åœã€‚\nç‰¹é» No triggerï¼šé€™æ˜¯ gh-ostçš„ç‰¹é»ï¼ŒåŸºæ–¼ triggerçš„æ–¹æ¡ˆæœƒå° MySQLçš„æ€§èƒ½é€ æˆè¼ƒå¤§çš„å½±éŸ¿ã€‚ gh-ost è§£æ binlog å¾Œå¯«å…¥æ•¸æ“šï¼Œä¸åƒ…å¯æ§å° MySQL çš„æ€§èƒ½å½±éŸ¿ä¹Ÿå¾ˆå°ã€‚ çœŸæ­£çš„æš«åœï¼šç•¶ gh-osté€²å…¥ throttleç‹€æ…‹æ™‚ï¼Œ gh-ost çœŸæ­£åœæ­¢äº†å° MASTER çš„å¯«å…¥(é™¤äº†å¿…è¦çš„ä½è² è¼‰çš„å¿ƒè·³ç´€éŒ„)ï¼Œè®“ MASTER å¯ä»¥å›åˆ°åŸå§‹çš„ Loading ç‹€æ…‹ã€‚ å‹•æ…‹æ§åˆ¶ï¼šå³ä½¿å·²ç¶“é–‹å§‹é‹è¡Œ gh-ostï¼Œä¹Ÿå¯ä»¥é€é äº¤äº’å¼å‘½ä»¤ éš¨æ™‚é‡æ–°é…ç½® gh-ost éƒ¨åˆ†åƒæ•¸ï¼Œç”šè‡³ä½ å¯ä»¥å¼·åˆ¶è®“ gh-ost é€²å…¥ throttle ç‹€æ…‹ã€‚ å¯å¯©æ ¸ï¼šå¯ä»¥é€é unix socketã€ TCP æˆ– table _ghc æŸ¥è©¢ gh-ost ç‹€æ…‹ã€‚ å¯æ¸¬è©¦ï¼š gh-ost å¯ä»¥åœ¨ SLAVE é€²è¡Œé·ç§»ï¼Œç”¨ä»¥è§€å¯Ÿ Loading å’Œ æ­£ç¢ºæ€§å¾Œå†æŠ•å…¥ä½¿ç”¨ã€‚ æ§åˆ¶åˆ‡æ›éšæ®µï¼š cut over æ˜¯ gh-ost æœ€é—œéµçš„ä¸€å€‹æ­¥é©Ÿï¼Œä½ å¯ä»¥éš¨æ™‚æ±ºå®š cut over çš„æ™‚é–“ã€‚ å¤–éƒ¨ hookï¼š gh-ost æä¾› hook åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå¯ä»¥ç”¨æ–¼æ¨é€åˆ° SLACK ç¾¤çµ„å‘ŠçŸ¥é€²åº¦ã€‚ åŸ·è¡Œæ­¥é©Ÿ åˆå§‹æ­¥é©Ÿæª¢æŸ¥ä¸€ä¸‹åƒæ•¸ï¼Œä¸¦æ–°å¢å…©å¼µè¡¨ ghost table(_gho)ã€ log\u0026amp;heartbeat table(_ghc)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 -- SLAVE SET autocommit=true SET NAMES utf8mb4 select @@global.version select @@global.port select @@global.hostname, @@global.port show /* gh-ost */ grants for current_user() select @@global.log_bin, @@global.binlog_format select @@global.binlog_row_image show /* gh-ost */ table status from `ghost_test` like \u0026#39;event_1\u0026#39; -- Master SET autocommit=true SET NAMES utf8mb4 select @@global.version select @@global.port select @@global.time_zone select @@global.hostname, @@global.port show columns from `ghost_test`.`event_1` show /* gh-ost */ table status from `ghost_test` like \u0026#39;_event_1_gho\u0026#39; show /* gh-ost */ table status from `ghost_test` like \u0026#39;_event_1_del\u0026#39; drop /* gh-ost */ table if exists `ghost_test`.`_event_1_ghc` create /* gh-ost */ table `ghost_test`.`_event_1_ghc` ( id bigint auto_increment, last_update timestamp not null DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, hint varchar(64) charset ascii not null, value varchar(4096) charset ascii not null, primary key(id), unique key hint_uidx(hint) ) auto_increment=256 create /* gh-ost */ table `ghost_test`.`_event_1_gho` like `ghost_test`.`event_1` alter /* gh-ost */ table `ghost_test`.`_event_1_gho` ADD COLUMN test varchar(20) AFTER remark æ ¹æ“š exact-rowcount çš„è¨­å®šä¾†æ±ºå®šè¨ˆç®—è¡Œæ•¸çš„æ–¹å¼ï¼Œåœ¨ Slave åŸ·è¡Œ\n1 2 3 4 --no exact-rowcountï¼šé€éexplianå–å¾—ä¼°ç®—å€¼ explain select /* gh-ost */ * from `ghost_test`.`event_1` where 1=1; --exact-rowcountï¼šé€écount(*)å–å¾—ç²¾æº–å€¼ select /* gh-ost */ count(*) as rows from `ghost_test`.`event_1`; é€šé order by ä¾†å–å¾— shared key æœ€å°å€¼å’Œæœ€å¤§å€¼ç¯„åœ\n1 2 3 4 5 6 7 8 -- Master select /* gh-ost `ghost_test`.`event_1` */ `order_id` from `ghost_test`.`event_1` order by `order_id` asc limit 1 select /* gh-ost `ghost_test`.`event_1` */ `order_id` from `ghost_test`.`event_1` order by `order_id` desc limit 1 é€éä»¥ä¸‹èªæ³•åˆ¤æ–·æ˜¯å¦é‚„æœ‰æœªè¤‡è£½çš„è³‡æ–™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 -- Master -- å‡è¨­æ¯æ¬¡æ‰¹æ¬¡ç‚º1000ç­† -- å–å¾—æ¯æ¬¡æ‰¹æ¬¡çš„ç¬¬1000ã€2000...ç­†order_id select /* gh-ost `ghost_test`.`event_1` iteration:0 */ `order_id` from `ghost_test`.`event_1` where ((`order_id` \u0026gt; _binary\u0026#39;00AD4267F1A3467\u0026#39;) or ((`order_id` = _binary\u0026#39;00AD4267F1A3467\u0026#39;))) and ((`order_id` \u0026lt; _binary\u0026#39;FEB556F8553843A\u0026#39;) or ((`order_id` = _binary\u0026#39;FEB556F8553843A\u0026#39;))) order by `order_id` asc limit 1 offset 999 -- è‹¥ä¸Šè¿°sqlè¿”å›ç©ºå€¼ï¼Œå‰‡ä½¿ç”¨æ­¤èªæ³•æ’ˆå–æœ€å¾Œä¸€ç­†order_id select /* gh-ost `ghost_test`.`event_1` iteration:1 */ `order_id` from ( select `order_id` from `ghost_test`.`event_1` where ((`order_id` \u0026gt; _binary\u0026#39;FE01373BB55A45F\u0026#39;)) and ((`order_id` \u0026lt; _binary\u0026#39;FEB556F8553843A\u0026#39;) or ((`order_id` = _binary\u0026#39;FEB556F8553843A\u0026#39;))) order by `order_id` asc limit 1000 ) select_osc_chunk order by `order_id` desc limit 1 ç•¶æœ‰æœªè¤‡è£½çš„è³‡æ–™ï¼Œé€éä¸‹é¢çš„æ–¹å¼å¾åŸè¡¨è¤‡è£½è³‡æ–™åˆ° ghost table\n1 2 3 4 5 6 7 -- Master insert /* gh-ost `ghost_test`.`event_1` */ ignore into `ghost_test`.`_event_1_gho` (`site_id`, `order_id`, `game_hall`, `user_id`, `op_id`, `txn_id`, `amount`, `event_time`, `remark`, `create_time`, `update_time`) (select `site_id`, `order_id`, `game_hall`, `user_id`, `op_id`, `txn_id`, `amount`, `event_time`, `remark`, `create_time`, `update_time` from `ghost_test`.`event_1` force index (`PRIMARY`) where (((`order_id` \u0026gt; _binary\u0026#39;2B94A39A501247D\u0026#39;) or ((`order_id` = _binary\u0026#39;2B94A39A501247D\u0026#39;))) and ((`order_id` \u0026lt; _binary\u0026#39;2B94A39A501247D\u0026#39;) or ((`order_id` = _binary\u0026#39;2B94A39A501247D\u0026#39;)))) lock in share mode) æœ€å¾Œä¸€æ­¥cut-over éšæ®µ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 -- Master create /* gh-ost */ table `ghost_test`.`_event_1_del` ( id int auto_increment primary key ) engine=InnoDB comment=\u0026#39;ghost-cut-over-sentry\u0026#39; lock /* gh-ost */ tables `ghost_test`.`event_1` write, `g host_test`.`_event_1_del` write rename /* gh-ost */ table `ghost_test`.`event_1` to `ghost_test`.`_event_1_del`, `ghost_test`.`_event_1_gho` to `ghost_test`.`event_1` drop /* gh-ost */ table if exists `ghost_test`.`_event_1_del` drop /* gh-ost */ table if exists `ghost_test`.`_event_1_ghc` unlock tables è®“æˆ‘å€‘æ•´ç†ä¸€ä¸‹ gh-ost çš„æ“ä½œï¼š\næ‡‰ç”¨é¡å‹ åŸè¡¨æ“ä½œ æ–°è¡¨æ“ä½œ Row Copy SELECT INSERT IGNORE INTO Binlog Apply INSERT REPLACE INTO Binlog Apply UPDATE UPDATE (æ‰€æœ‰æ¬„ä½ï¼‰ Binlog Apply DELETE DELETE åœ¨æ•¸æ“šé·ç§»çš„éç¨‹ä¸­ï¼Œæ•¸æ“šçš„è®Šå‹•æœ‰ä»¥ä¸‹ä¸‰ç¨®çµ„åˆï¼š\nå¾åŸè¡¨ RowCopy â†’ å° åŸè¡¨DMLæ“ä½œ â†’ Binlog Apply åœ¨æ­¤æƒ…æ³ä¸‹ä¸€åˆ‡éƒ½ç…§é †åºé‹è¡Œï¼Œå› æ­¤ä¸è«–æ˜¯ INSERTã€ UPDATEã€ DELETE éƒ½æ²’æœ‰ç–‘æ…®ã€‚ å° åŸè¡¨DMLæ“ä½œ â†’ Binlog Apply â†’ å¾åŸè¡¨ RowCopy INSERTï¼š Row Copy è¢«è½‰æ›ç‚º INSERT INGNORE INTOï¼Œå› æ­¤ä¸æœƒè“‹æ‰ Binlog Apply çš„ INSERT æ“ä½œã€‚ UPDATEã€DELETEï¼šå› ç‚ºé‚„æ²’å¾åŸè¡¨ Copy éä¾†ï¼Œæ‰€ä»¥ Binlog Apply çš„æ“ä½œæœƒæ²’æœ‰ä»»ä½•çµæœï¼Œä½†æ˜¯æœ€å¾Œå¾åŸè¡¨ Copy éä¾†æ™‚å³æœƒæ˜¯æœ€æ–°çš„æ•¸æ“šï¼Œå› æ­¤ä¹Ÿæ²’æœ‰å•é¡Œã€‚ å° åŸè¡¨DML æ“ä½œ â†’ å¾åŸè¡¨ RowCopy â†’ Binlog Apply INSERTï¼š Binlog Apply:INSERTè¢«è½‰æ›ç‚º REPLACE INTOï¼Œæœƒè¦†è“‹æ‰ Row Copy:INSERT æ“ä½œï¼Œä½†å…©è€…çš„çµæœä¸€æ¨£å› æ­¤ä¸å½±éŸ¿ã€‚ UPDATEã€DELETEï¼šå¾åŸè¡¨ Copy éä¾†å°±æ˜¯æœ€æ–°çš„æ•¸æ“šï¼Œå¾ŒçºŒçš„ Binlog Apply ä¹Ÿä¸æœƒå½±éŸ¿åˆ°æ•¸æ“šï¼Œå› æ­¤ä¹Ÿæ²’æœ‰å•é¡Œã€‚ è¦æ±‚èˆ‡é™åˆ¶ Requirements è¦æ±‚ï¼š\ngh-ost éœ€è¦åœ¨ MySQL 5.7 ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸Šé‹è¡Œ server å¿…é ˆé–‹å•Ÿ log_binï¼Œè‹¥ç‚º Slave åŒæ™‚ä¹Ÿå¿…é ˆé–‹å•Ÿ log_slave_updates éœ€è¦ä¸€å° binlog_format ç‚º ROW åŠ binlog_row_image ç‚º full æ¨¡å¼çš„ server å¦‚æœåœ¨slaveä¸Šä½¿ç”¨ï¼Œå¿…é ˆç¢ºä¿è¦ALTERçš„TABLEåœ¨Masterå’ŒSlaveä¸ŠSchemaç›¸åŒ æ¬Šé™ï¼š ALTER, CREATE, DELETE, DROP, INDEX, INSERT, LOCK TABLES, SELECT, TRIGGER, UPDATE ON database.* OR *.* SUPER, REPLICATION SLAVE on *.* æˆ– REPLICATION CLIENT, REPLICATION SLAVE on *.* SUPERæ¬Šé™ç”¨æ–¼ STOP SLAVE å’Œ START SLAVEï¼Œå…·é«”ç”¨é€”ç‚ºï¼š\nç•¶ binlog_formatä¸æ˜¯ ROW ä¸¦ä¸”æŒ‡å®š --switch-to-rbr æ™‚ï¼Œå°‡åˆ‡æ› binlog_format ä¸¦é‡å•Ÿ replicationã€‚å¦‚æœæ˜¯ ROW æ¨¡å¼å¯ä»¥æŒ‡å®š --assume-rbr é¿å… STOP SLAVE å’Œ START SLAVE ï¼Œåœ¨æ­¤æƒ…æ³ä¸‹ï¼Œä¸éœ€è¦æä¾› SUPER æ¬Šé™ã€‚ (æé†’ï¼è‹¥è‡ªè¡Œåˆ‡æ› binlog_format é ˆè¨˜å¾—é‡å•Ÿreplicationï¼) é‹è¡Œ --test-on-replica æ™‚ï¼Œgh-oståˆ‡æ›è¡¨å¾Œæœƒåœæ­¢ replication ï¼Œè®“ä½¿ç”¨è€…æ¯”è¼ƒå…©å¼µè¡¨ã€‚ Limitations é™åˆ¶ï¼š\nç›®å‰ä¸æ”¯æŒå¤–éµã€‚æœªä¾†å¯èƒ½æœƒæä¾›ä¸€å®šç¨‹åº¦çš„æ”¯æŒ ç›®å‰ä¸æ”¯æŒtriggerã€‚æœªä¾†å¯èƒ½æœƒæä¾›æ”¯æŒ æ”¯æŒMySQL 5.7çš„ JSON ï¼Œä½†å‰ææ˜¯ä¸èƒ½æ˜¯ PRIMARY KEY çš„ä¸€éƒ¨åˆ† æ–°è¡¨å’ŒèˆŠè¡¨å¿…é ˆä½¿ç”¨ç›¸åŒçš„ PRIMARY KEY æˆ– UNIQUE KEY ã€‚å› ç‚ºè¤‡è£½æ™‚æœƒ gh-ost æœƒåˆ©ç”¨è©² KEYéæ­·æ‰€æœ‰è¡Œã€‚é·ç§»éµå¿…é ˆç‚º NOT NULL (å¯ä»¥ç‚ºç©ºå€¼)ã€‚æˆ–æ˜¯æœ‰ NULLå±¬æ€§ ä¸¦ä½¿ç”¨ --allow-nullable-unique-key ä½†å¿…é ˆç¢ºä¿å¯¦éš›ä¸Šæ²’æœ‰ NULL å€¼ï¼Œå¦å‰‡å¯èƒ½å°è‡´æ•¸æ“šä¸å®Œæ•´ã€‚ ç•¶å­˜åœ¨åç¨±ç›¸åŒåƒ…å¤§å°å¯«ä¸åŒçš„tableæ™‚ç„¡æ³•é€²è¡Œ é˜¿é‡Œé›²RDSèƒ½æ­£å¸¸é‹ä½œï¼Œåƒ…éœ€è¦æ·»åŠ  --aliyun-rds Google Cloud SQLå¯ä½¿ç”¨ï¼Œåƒ…éœ€æ·»åŠ  --gcp Amazon RDSå¯ä»¥ä½¿ç”¨ï¼Œä½†æœ‰äº›é™åˆ¶ï¼Œè«‹åƒé–±å®˜æ–¹æ–‡æª” ç•¶ SLAVE çš„ä¾†æºç‚ºmultiæ™‚ï¼Œç„¡æ³•æ”¯æŒåœ¨ SLAVE ä¸ŠåŸ·è¡Œï¼Œå»ºè­°ç›´æ¥åœ¨ MASTERä¸Šé€²è¡Œï¼Œéœ€æ·»åŠ  --allow-on-master ç›®å‰ç•¶åœ¨ master-master é‹è¡Œ gh-ost æ™‚ï¼Œæ²’æœ‰è¾¦æ³•æ”¯æ´å…©é‚Šéƒ½æœ‰å¯«å…¥çš„æƒ…æ³ã€‚å°‡ä¾†å¯èƒ½æ”¯æ´ è‹¥å°‡ enum å‹æ…‹çš„æ¬„ä½ä½œç‚º PRIMARY KEY å°‡ä½¿æ€§èƒ½é™ä½ ä¸æ”¯æ´ federated Table ï¼Œä¸¦ä¸”èˆ‡ gh-ost æƒ³è¦è§£æ±ºçš„æ–¹æ¡ˆç„¡é—œ ä¸æ”¯æŒ ALTER TABLE ... RENAME TO some_other_name ï¼Œé€™æ¨£çš„æ“ä½œä¸æ‡‰è©²æ˜¯ç”¨ gh-ost ä¸¦ç™¼é·ç§»(Concurrent migrations) çµ•å°ä¸è¦é‹è¡Œåœ¨åŒä¸€å€‹ Table ä¸Šã€‚ å¦‚æœé‹è¡Œåœ¨ä¸åŒçš„ SLAVE ä¸Šï¼Œä¸éœ€è¦å…¶ä»–èª¿æ•´ã€‚ä¾‹å¦‚ï¼štable1 on slave1 å’Œ table2 on slave2ã€‚ å¦‚æœåœ¨åŒä¸€å€‹æ©Ÿå™¨é‹è¡Œ gh-ost ç¢ºä¿ -server-socket-file è¨­ç½®ä¸åŒåç¨±ï¼ˆæˆ–ç”± gh-ost å‘½åï¼‰ã€‚ é€é -throttle-additional-flag-file æ§åˆ¶æ‰€æœ‰ gh-ostï¼Œå¦å¤–é€é throttle-flag-file æ§åˆ¶å–®ä¸€ gh-ost ã€‚ å¦‚æœ -host ç›¸åŒï¼Œå‰‡å¿…é ˆå°æ¯å€‹ gh-ost è¨­å®šå”¯ä¸€çš„ replica-server-id é¿å…è¡çªã€‚ Throttle ä»‹ç´¹ åœ¨é·ç§»çš„éä¸­ï¼Œ gh-ost çš„ç‹€æ…‹é™¤äº†æŒçºŒçš„è¤‡è£½åŸè¡¨å’Œæ‡‰ç”¨binlogå¤–ï¼Œé‚„æœ‰å¦ä¸€å€‹ç‹€æ…‹æ˜¯ throttling\nç•¶ throttled(é™åˆ¶) çš„æ™‚å€™ï¼Œ gh-ost æœƒæš«åœæ‰€æœ‰å¯«æ“ä½œï¼ŒåŒ…å«è¤‡è£½åŸè¡¨çš„è³‡æ–™å’Œæª¢æŸ¥binlogï¼Œä½†ä»æœƒåš low-volume changlog status writes å’Œ heartbeat writes ã€‚\nç•¶ gh-ost è¢«é™åˆ¶æ™‚ï¼Œå°ä¸»æ©Ÿçš„ Loading å°‡å¾¹åº•æ¶ˆå¤±ï¼Œå’ŒåŸºæ–¼ trigger åŸç†çš„å·¥å…·ç›¸æ¯”é€™æ˜¯ gh-ost çš„å„ªå‹¢ï¼Œå› ç‚º trigger ç„¡æ³•æš«åœæœƒæŒçºŒçš„å¯«å…¥æ–°è³‡æ–™ï¼Œç›¸åçš„ gh-ost åŒ…å«è¤‡è£½åŸè¡¨è³‡æ–™å’Œå¯«å…¥æ–°è³‡æ–™ï¼ˆé€éæ‡‰ç”¨ binlog eventï¼‰éƒ½æ˜¯ç”± gh-ost é€²è¡Œæ§åˆ¶ã€‚\ngh-ost æ”¯æŒå„ç¨®é™åˆ¶çš„æ–¹æ³•ï¼Œä¸¦ä¸”ä»–èƒ½å…è¨±ä½¿ç”¨è€…å‹•æ…‹çš„èª¿æ•´ã€‚\nåƒæ•¸å’Œå› ç´  Replication lag æ¨è–¦å°‡ gh-ost é€£çµåˆ° Slaveï¼Œ gh-ost æœƒè‡ªè¡Œæ‰¾å‡º Master é–‹å§‹é€²è¡Œé·ç§»çš„åŒæ™‚ï¼Œ gh-ost æœ‰è‡ªå·±çš„å¿ƒè·³æ©Ÿåˆ¶å»æª¢æŸ¥ä»–æ‰€é€£æ¥çš„ Slave æ˜¯å¦æœ‰ replication lag çš„ç‹€æ³ã€‚æˆ–è€…ä¹Ÿå¯ä»¥è‡ªè¡ŒæŒ‡å®šè¦æª¢æŸ¥ replication lag çš„æ¸…å–®ã€‚\n--throttle-control-replicas ï¼šæ˜ç¢ºåˆ—å‡ºéœ€è¦ gh-ost æª¢æŸ¥ replication lag çš„ Slave æ¸…å–® ç¯„ä¾‹ï¼š\u0026ndash;throttle-control-replicas=myhost1.com:3306,myhost2.com,myhost3.com:3307\n--max-lag-millisï¼šå…è¨± replication lag çš„æœ€å¤§å€¼ï¼Œä»»ä½•åœ¨æª¢æŸ¥æ¸…å–®ä¸­çš„ replication lag è¶…éæ­¤å€¼éƒ½å°‡å°è‡´ throttlingï¼Œé™¤éæ¸…å–®ä¸­çš„æ‰€æœ‰ replication lag éƒ½å°æ–¼æ­¤å€¼æ‰æœƒæ¢å¾©ã€‚\nä»¥ä¸Šè¨­å®šå¯ä»¥é€é Interaction commands ä¾†éš¨æ™‚å‹•æ…‹èª¿æ•´ã€‚\nStatus thresholds --max-load ï¼šç•¶æŒ‡å®šçš„æŒ‡æ¨™è¶…éè¨­å®šçš„é–¾å€¼æ™‚ï¼Œå°‡å°è‡´ throttling ç™¼ç”Ÿã€‚\nç¯„ä¾‹ï¼š\u0026ndash;max-load=\u0026lsquo;Threads_running=100,Threads_connected=500\u0026rsquo;\næŒ‡æ¨™å¿…é ˆæ˜¯æœ‰æ•ˆä¸”ç‚ºæ•¸å­—çš„ status variables (å¯åƒè€ƒmysql å®˜ç¶²)\nThrottle query ç•¶æä¾› --throttle-query æ™‚ï¼Œå¿…é ˆç¢ºä¿è¿”å›æ•´æ•¸ï¼Œæ¯ç§’æœƒåŸ·è¡Œè©²æŸ¥è©¢(å› æ­¤æ‡‰ç¢ºä¿æ­¤æŸ¥è©¢ç‚ºè¼•é‡çš„)ï¼Œç•¶è¿”å›å€¼ \u0026gt; 0 æ™‚ gh-ost å°‡é€²å…¥ throttling ç‹€æ…‹ï¼›åä¹‹ç•¶è¿”å›å€¼ \u0026lt;= 0 æ™‚ä¸”æ²’æœ‰å…¶ä»–é™åˆ¶å› ç´ æ™‚ï¼Œå‰‡ gh-ost æ­£å¸¸é‹ä½œ\nç¯„ä¾‹ï¼š\u0026ndash;throttle-query=\u0026ldquo;select hour(now()) between 8 and 17\u0026rdquo; è¡¨ç¤º 8:00am é–‹å§‹é€²å…¥ throttling ç‹€æ…‹ï¼Œç›´åˆ° 18:00pm è§£é™¤ã€‚\nHTTP Throttle The --throttle-http flag allows for throttling via HTTP. Every 100ms gh-ost issues a HEAD request to the provided URL. If the response status code is not 200 throttling will kick in until a 200 response status code is returned.\nIf no URL is provided or the URL provided doesn\u0026rsquo;t contain the scheme then the HTTP check will be disabled. For example --throttle-http=\u0026quot;http://1.2.3.4:6789/throttle\u0026quot; will enable the HTTP check/throttling, but --throttle-http=\u0026quot;1.2.3.4:6789/throttle\u0026quot; will not.\nThe URL can be queried and updated dynamically via interactive interface.\næ‰‹å‹•æ§åˆ¶ é™¤äº†ä»¥ä¸Šçš„è‡ªå‹•æ§åˆ¶ï¼Œé‚„å¯ä»¥éš¨æ™‚æ‰‹å‹•è®“ gh-ost é€²å…¥ throttling ç‹€æ…‹ã€‚\n--throttle-flag-file ï¼šç•¶è©²æ–‡ä»¶å­˜åœ¨æ™‚ï¼Œé€²å…¥ throttling ç‹€æ…‹ã€‚å¯ä»¥ä½¿ç”¨ touch å»ºç«‹å³å¯\n--throttle-additional-flag-file ï¼šèˆ‡ä¸Šè¿°é¡ä¼¼ï¼Œç•¶è©²æ–‡ä»¶å­˜åœ¨æ™‚ï¼Œé€²å…¥ throttling ç‹€æ…‹ã€‚\né»˜èªå€¼ç‚ºï¼š /tmp/gh-ost.throttle\næœ‰å…©ç¨®åƒæ•¸çš„åŸå› æ˜¯å¯ä»¥é‹è¡Œå¤šå€‹ gh-ost ï¼Œ--throttle-flag-file ç‚ºå–®å€‹ gh-ost æ‰€ä½¿ç”¨ï¼Œ--throttle-additional-flag-file å‰‡æ˜¯åŒæ™‚æ§åˆ¶æ‰€æœ‰ gh-ost ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é€é touch ä¸åŒçš„æ–‡ä»¶ä¾†é™åˆ¶å–®å€‹æˆ–å¤šå€‹ gh-ost\né€é Interactive commands å° gh-ost ä¸‹é” throttle\nç¯„ä¾‹ï¼š\n1 2 echo throttle | nc -U /tmp/gh-ost.test.sample_data_0.sock echo no-throttle | nc -U /tmp/gh-ost.test.sample_data_0.sock Throttle precedence ä¸Šè¿°æåˆ°çš„ä»»ä½•å› ç´ éƒ½å°‡å°è‡´ gh-ost é€²å…¥ throttling ç‹€æ…‹ï¼Œå› æ­¤ä¸€æ—¦å…¶ä¸­ä¸€å€‹å› ç´ å¼•ç™¼ throttling ä½ éƒ½ç„¡æ³•å¼·åˆ¶ç¹¼çºŒåŸ·è¡Œé·ç§»ã€‚\ngh-ost æœƒåœ¨ä¸åŒçš„æ™‚é–“é»ç¨ç«‹æ”¶é›†ä¸åŒçš„æŒ‡æ¨™ï¼Œä¸¦ç•°æ­¥æª¢æŸ¥ä¸åŒçš„æŒ‡æ¨™æ˜¯å¦æœ‰é”åˆ°é–¾å€¼ï¼Œå› æ­¤ gh-ost åªæœƒè¿”å›ç¬¬ä¸€å€‹è¶…éé–¾å€¼çš„æŒ‡æ¨™ä½œç‚º throttling åŸå› ã€‚\nThrottle status throttle ç‹€æ…‹æœƒä½œç‚º status message å®šæœŸçš„ print å‡ºä¾†ï¼š\n1 2 Copy: 0/2915 0.0%; Applied: 0; Backlog: 0/100; Elapsed: 41s(copy), 41s(total); streamer: mysql-bin.000551:47983; ETA: throttled, flag-file Copy: 0/2915 0.0%; Applied: 0; Backlog: 0/100; Elapsed: 42s(copy), 42s(total); streamer: mysql-bin.000551:49370; ETA: throttled, commanded by user å¯ä»¥ throttle å¤šä¹… æœ€é•·å¯ä»¥ç¶­æŒ throttle ç‹€æ…‹çš„æ™‚é–“ä¾è³´æ–¼ binlog ä¿ç•™çš„æ™‚é–“ï¼Œå› ç‚ºç•¶é€²å…¥ throttling ç‹€æ…‹æ™‚ï¼Œ gh-ost å°‡æš«åœè®€å– binlog ï¼Œä¹‹å¾Œæ¢å¾©æœƒå¾åŒä¸€å€‹ binlog é–‹å§‹ã€‚\nbinlog ä¿ç•™æ™‚é–“é€šå¸¸é€é expire_logs_days è¨­å®šï¼Œæˆ–è€…æ˜¯å…¶ä»–å¤–éƒ¨è…³æœ¬ï¼Œå› æ­¤å¿…é ˆå…ˆç¢ºèªæ©Ÿå™¨ä¸Šçš„éƒ¨å±¬ï¼Œå¦å¤–é›–ç„¶ binlog ä¿ç•™å¤šä¹… gh-ost å°±èƒ½ throttle å¤šä¹…ï¼Œä½†æ˜¯åœ¨æ­¤æœŸé–“ gh-ost å¿…é ˆä¸€ç›´é‹è¡Œï¼Œä¸¦ä¸”ç›¸æ‡‰çš„ç•¶æ¢å¾©ä¹‹å¾Œéœ€è¦æ‡‰ç”¨ç›¸ç•¶å¤§é‡çš„ binlog event ã€‚\näº’å‹•æŒ‡ä»¤ gh-ost å…è¨±ç”¨æˆ¶åœ¨é‹è¡Œæ™‚æ§åˆ¶å…¶è¡Œç‚º\nInteractive interfaces gh-ost å¯ä»¥é€éä»¥ä¸‹æ–¹å¼é€²è¡Œç›£è½ï¼š\nUNIX socket fileï¼š gh-ost é‹è¡Œæ™‚æœƒç”¢ç”Ÿ socket file ä¹Ÿå¯ä»¥é€é --server-socket-file æŒ‡å®šä½ç½®ã€‚ TCPï¼šéœ€è¦å¸¶å…¥ --server-tcp-port åƒæ•¸ Known commands helpï¼šæç¤ºå¯ä»¥ä½¿ç”¨çš„å‘½ä»¤ statusï¼šè¿”å›é·ç§»çš„é€²åº¦ï¼Œå’Œè©³ç´°çš„ç‹€æ…‹ supï¼šè¿”å›é·ç§»é€²åº¦çš„ç°¡è¦ç‹€æ…‹ coordinatesï¼šè¿”å›è¢«æª¢æŸ¥ binlog çš„ serverï¼Œæœ€æ–°çš„positionä½ç½® chunk-size=\u0026lt;newsize\u0026gt;ï¼šä¿®æ”¹ chunk-sizeï¼Œå°‡åœ¨ä¸‹ä¸€æ¬¡ copy-iteration ç”Ÿæ•ˆ dml-batch-size=\u0026lt;newsize\u0026gt;ï¼šä¿®æ”¹ dml-batch-sizeï¼Œå°‡åœ¨ä¸‹ä¸€æ¬¡æ‡‰ç”¨ binlog event ç”Ÿæ•ˆ max-lag-millis=\u0026lt;max-lag\u0026gt;ï¼šèª¿æ•´ max-lag-millis çš„é…ç½® max-load=\u0026lt;max-load-thresholds\u0026gt;ï¼šä¿®æ”¹ max-load çš„é…ç½®ï¼Œå°‡åœ¨ä¸‹ä¸€æ¬¡ copy-iteration ç”Ÿæ•ˆ critical-load=\u0026lt;critical-load-thresholds\u0026gt;ï¼šä¿®æ”¹ critical-load çš„é…ç½® nice-ratio=\u0026lt;ratio\u0026gt;ï¼šä¿®æ”¹ nice-ratio æ¯”ä¾‹ throttle-httpï¼šchange throttle HTTP endpoint throttle-queryï¼šä¿®æ”¹ throttle query throttle-control-replicas='replica1,replica2'ï¼šä¿®æ”¹ throttle control replicas throttleï¼šå¼·åˆ¶é€²å…¥ throttle ç‹€æ…‹ no-throttleï¼šå–æ¶ˆå¼·åˆ¶é€²å…¥ throttle ç‹€æ…‹ï¼Œä½†ä»æœƒå—å…¶ä»–å› ç´ æš«åœ unpostponeï¼šåœ¨ gh-ost æ¨é² cut-over éšæ®µæ™‚ï¼Œåªæ˜¯ gh-ost åœæ­¢æ¨é²ä¸¦ç«‹åˆ» cut-over panicï¼šç«‹å³ panic ä¸¦åœæ­¢æ“ä½œ Querying for data å°æ–¼ä¸Šè¿°å‘½ä»¤åœ¨å‚³éåƒæ•¸æ™‚ï¼Œè¨­ç½®ç‚º ? æ™‚ï¼Œå¯ä»¥æŸ¥è©¢æ•¸æ“š\nç¯„ä¾‹ 1 2 3 4 5 6 7 8 $ echo status | nc -U /tmp/gh-ost.test.sample_data_0.sock # Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst` # Migration started at Tue Jun 07 11:45:16 +0200 2016 # chunk-size: 200; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20] # Throttle additional flag file: /tmp/gh-ost.throttle # Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock # Serving on TCP port: 10001 Copy: 0/2915 0.0%; Applied: 0; Backlog: 0/100; Elapsed: 40s(copy), 41s(total); streamer: mysql-bin.000550:49942; ETA: throttled, flag-file 1 2 3 4 5 6 7 $ echo \u0026#34;chunk-size=250\u0026#34; | nc -U /tmp/gh-ost.test.sample_data_0.sock # Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst` # Migration started at Tue Jun 07 11:56:03 +0200 2016 # chunk-size: 250; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20] # Throttle additional flag file: /tmp/gh-ost.throttle # Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock # Serving on TCP port: 10001 1 2 $ echo \u0026#34;chunk-size=?\u0026#34; | nc -U /tmp/gh-ost.test.sample_data_0.sock 250 1 2 3 4 5 6 7 8 9 10 $ echo throttle | nc -U /tmp/gh-ost.test.sample_data_0.sock $ echo status | nc -U /tmp/gh-ost.test.sample_data_0.sock # Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst` # Migration started at Tue Jun 07 11:56:03 +0200 2016 # chunk-size: 250; max lag: 1500ms; max-load: map[Threads_connected:20] # Throttle additional flag file: /tmp/gh-ost.throttle # Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock # Serving on TCP port: 10001 Copy: 0/2915 0.0%; Applied: 0; Backlog: 0/100; Elapsed: 59s(copy), 59s(total); streamer: mysql-bin.000551:68067; ETA: throttled, commanded by user Cut over è§£æ æƒ…å¢ƒ å‡è¨­ C10ã€C20 ç‚º gh-ost æ‰€ä½¿ç”¨çš„é€£çµï¼Œ C1..C9ã€ C11..C19ã€ C21..C29 ç‚ºå…¶ä»–é€£ç·šã€‚\nC1..C9ï¼šå° åŸè¡¨(tb1) é€²è¡Œ INSERTã€UPDATEã€DELETE ç­‰DMLæ“ä½œ C10ï¼š CREATE TABLE tb1_old(id int primary key) COMMENT='magic-be-here' C10ï¼š LOCK TABLES tb1 WRITE, tb1_old WRITE C11..C19ï¼šæ–°çš„é€£ç·šå° tb1é€²è¡ŒDMLæ“ä½œï¼Œä½†ç”±æ–¼ tb1è¢« LOCKä½è€Œé˜»å¡ C20ï¼š RENAME TABLE tbl TO tbl_old, ghost TO tblï¼Œé›–ç„¶å› ç‚º LOCK æ­¤æ“ä½œæœƒè¢«é˜»å¡ï¼Œä½†åœ¨é˜»å¡çš„å°åˆ—ä¸­å„ªå…ˆç´šæœƒé«˜æ–¼ C1..C9 å’Œ C11..C19 C21..C29ï¼šæ–°çš„é€£ç·šå° tb1é€²è¡ŒDMLæ“ä½œï¼Œä½†ç”±æ–¼ tb1è¢« LOCKä½è€Œé˜»å¡ C10ï¼šé€é show processlist ç¢ºèªæ˜¯å¦æœ‰ C20çš„RENAME æ“ä½œ C10ï¼š DROP TABLE tbl_oldï¼Œä»€éº¼äº‹éƒ½æ²’æœ‰ç™¼ç”Ÿ tb1 ä»èˆŠè¢« LOCK C10ï¼š UNLOCK TABLES æœ€å¾Œï¼Œé˜»å¡çš„å°åˆ—ä¸­ RENAME å„ªå…ˆè¢«åŸ·è¡Œï¼Œæ¥ä¸‹ä¾†æ˜¯ C1..C9 C11..C19 C21..C29 éƒ½ç›´æ¥æ‡‰ç”¨åˆ°æ›´æ–°å¾Œçš„ tb1ã€‚\nè§£æ åœ¨ MySQL ä¸­æœ‰å…©ç¨®æ–¹å¼å¯ä»¥ RENAME TABLEï¼š RENAME TABLEï¼šèƒ½å¤ åŒæ™‚ renameå¤šå¼µè¡¨ï¼Œé€™è¡¨ç¤º renameå¤šå¼µè¡¨æ˜¯åŸå­çš„æ“ä½œã€‚ä½†åœ¨ 8.0.13 ä¹‹å‰ç„¡æ³•åœ¨åŒä¸€å€‹ session åŒæ™‚ LOCKå’Œ RENAMEã€‚ ALTER TABLE RENAMEï¼šèƒ½å¤ åœ¨ LOCK TABLE çš„ session é€²è¡Œï¼Œä½†å»ç„¡æ³•ä¸€æ¬¡ RENAMEå¤šå¼µè¡¨ã€‚ tb1_oldçš„å­˜åœ¨ï¼Œé¿å… Locké€£ç·šæ­»æ‰å¾Œçš„å½±éŸ¿ã€‚ Lock Table é¿å… RENAME éæ—©åŸ·è¡Œã€‚ åœ¨é˜»å¡çš„å°åˆ—ä¸­ï¼Œ RENAMEç¸½æ˜¯å„ªå…ˆæ–¼ INSERTã€UPDATEã€DELETEã€‚ å¤±æ•—çš„å½±éŸ¿ å¦‚æœåœ¨ C10 Create table æˆ– Lock tableå¤±æ•—ï¼Œå‰‡ä¸æœƒç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ­¥é©Ÿã€‚ å¦‚æœåœ¨ C20 Renameæ™‚ C10 Locké€£ç·šæ­»äº¡ï¼Œå› ç‚º tb1_oldçš„å­˜åœ¨ Renameå¤±æ•—ï¼ŒåŒæ™‚ Lock è§£é™¤ï¼Œ C1..C9å’Œ C11..C19æ­£å¸¸åŸ·è¡Œï¼Œå”¯ä¸€çš„å½±éŸ¿åªæœ‰æŸ¥è©¢è¢«é˜»å¡äº†ä¸€æ®µæ™‚é–“ã€‚ å¦‚æœ C20 Renameåœ¨ C10 Drop æˆ– Unlockä¹‹å‰æ­»äº¡ï¼Œ gh-ostæœƒæ­£å¸¸åŸ·è¡Œ Dropã€UnLockï¼Œå› æ­¤å”¯ä¸€çš„å½±éŸ¿ä¸€æ¨£åªæ˜¯æŸ¥è©¢è¢«é˜»å¡ä¸€æ®µæ™‚é–“ã€‚ hook ç”¨é€”ç¯„ä¾‹ å¸Œæœ›é·ç§»å®Œæˆ/å¤±æ•—æ™‚ï¼Œèƒ½å¤ æ”¶åˆ°é€šçŸ¥ å¸Œæœ›ç•¶ gh-ost é–‹å§‹æ¨é² cut-over æ™‚æ”¶åˆ°é€šçŸ¥ å¸Œæœ› gh-ost å®šæœŸå›å ±é€²åº¦ ä½¿ç”¨hook æ‰€æœ‰çš„hookéƒ½æ‡‰è©²æ”¾åœ¨ --hooks-path æŒ‡å®šçš„ç›®éŒ„è£¡ï¼Œå¦‚æœæ²’æœ‰æä¾›å‰‡ä¸åŸ·è¡Œ hookã€‚\nhookçš„å‘½åå¿…é ˆç‚ºä»¥ä¸‹å‰ç¶´ï¼š\ngh-ost-on-startup gh-ost-on-validated gh-ost-on-rowcount-complete gh-ost-on-before-row-copy gh-ost-on-status gh-ost-on-interactive-command gh-ost-on-row-copy-complete gh-ost-on-stop-replication gh-ost-on-start-replication gh-ost-on-begin-postponed gh-ost-on-before-cut-over gh-ost-on-success gh-ost-on-failure ç’°å¢ƒè®Šé‡ GH_OST_DATABASE_NAME GH_OST_TABLE_NAME GH_OST_GHOST_TABLE_NAME GH_OST_OLD_TABLE_NAMEï¼šåŸå§‹è¡¨åœ¨ cut-over ä¹‹å¾Œçš„åç¨± GH_OST_DDLï¼šDDL èªå¥ GH_OST_ELAPSED_SECONDSï¼šç¸½é‹è¡Œæ™‚é–“ GH_OST_ELAPSED_COPY_SECONDSï¼šRow copy èŠ±è²»çš„æ™‚é–“ GH_OST_ESTIMATED_ROWSï¼šä¼°è¨ˆçš„è¡Œæ•¸ GH_OST_COPIED_ROWSï¼šgh-ost è¤‡è£½çš„è¡Œæ•¸ GH_OST_INSPECTED_LAGï¼šreplication lag (second) GH_OST_PROGRESSï¼šé·ç§»çš„é€²åº¦ [0\u0026hellip;100] % GH_OST_MIGRATED_HOST GH_OST_INSPECTED_HOST GH_OST_EXECUTING_HOST GH_OST_HOOKS_HINTï¼š --hooks-hintçš„å€¼ GH_OST_HOOKS_HINT_OWNERï¼š --hooks-hint-ownerçš„å€¼ GH_OST_HOOKS_HINT_TOKENï¼š--hooks-hint-tokençš„å€¼ GH_OST_DRY_RUNï¼š gh-ost æ˜¯å¦æ˜¯ dry run GH_OST_COMMANDï¼šonly available in gh-ost-on-interactive-command GH_OST_STATUSï¼šonly available in gh-ost-on-status ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash # ç•¶gh-ostå•Ÿå‹•æ™‚æ¨é€åˆ°slack slack_hook=`cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook` show_time=$(date +\u0026#34;(%:z)%Y-%m-%d %H:%M:%S\u0026#34;) show_day=$(date +\u0026#34;%b %-d\u0026#34;) GH_OST_MIGRATED_HOST=$GH_OST_MIGRATED_HOST GH_OST_DATABASE_NAME=$GH_OST_DATABASE_NAME GH_OST_TABLE_NAME=$GH_OST_TABLE_NAME GH_OST_DDL=$GH_OST_DDL # æ¨é€åˆ°slack curl -X POST -H \u0026#39;Content-type: application/json\u0026#39; --data \u0026#39;{\u0026#34;blocks\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*\u0026lt;gh-ost.com|[Start] - gh-ost å·²é–‹å§‹ç†±æ›´æ–° :gh-ost:\u0026gt;*\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*Start_Time:* \u0026#39;\u0026#34;${show_time}\u0026#34;\u0026#39;\\n*Host:* \u0026#39;\u0026#34;${GH_OST_MIGRATED_HOST}\u0026#34;\u0026#39;\\n*Table:* `\u0026#39;\u0026#34;${GH_OST_DATABASE_NAME}\u0026#34;\u0026#39;`.`\u0026#39;\u0026#34;${GH_OST_TABLE_NAME}\u0026#34;\u0026#39;`\\n*DDL:* \u0026#39;\u0026#34;${GH_OST_DDL}\u0026#34;\u0026#39;\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;,\u0026#34;elements\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;:gh-ost: *gh-ost* | \u0026#39;\u0026#34;${show_day}\u0026#34;\u0026#39; \u0026#34;}]}]}\u0026#39; ${slack_hook} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/bin/bash # Sample hook file for gh-ost-on-status # gh-ost æ¨é€ç‹€æ…‹åˆ° slack slack_hook=`cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook` show_time=$(date +\u0026#34;(%:z)%Y-%m-%d %H:%M:%S\u0026#34;) show_day=$(date +\u0026#34;%b %-d\u0026#34;) GH_OST_MIGRATED_HOST=$GH_OST_MIGRATED_HOST GH_OST_DATABASE_NAME=$GH_OST_DATABASE_NAME GH_OST_TABLE_NAME=$GH_OST_TABLE_NAME GH_OST_DDL=$GH_OST_DDL GH_OST_ELAPSED_SECONDS=$GH_OST_ELAPSED_SECONDS GH_OST_STATUS=$GH_OST_STATUS GH_OST_PROGRESS=$GH_OST_PROGRESS # è¨ˆç®—æ¯åˆ†é˜å¹³å‡é€²åº¦ cycle_calc=`echo | awk \u0026#34;{print $GH_OST_PROGRESS/$GH_OST_ELAPSED_SECONDS*60}\u0026#34;` # è¨ˆç®—ä¸Šä¸€åˆ†é˜çš„é€²åº¦ last_progress=`echo | awk \u0026#34;{print $GH_OST_PROGRESS-$cycle_calc}\u0026#34;` # é€²åº¦è¶…é80%ä»¥ä¸Šæ™‚æ¨é€ä¸€æ¬¡å³å¯ã€‚ç•¶æœ¬åˆ†é˜é€²åº¦ \u0026gt; 80 ä¸” ä¸Šä¸€åˆ†é˜é€²åº¦å°æ–¼80æ™‚å°å‡º if [ `echo $GH_OST_PROGRESS | cut -d . -f 1` -eq 100 ] \u0026amp;\u0026amp; [ `echo $GH_OST_PROGRESS | cut -d . -f 1` -ge 80 ] \u0026amp;\u0026amp; [ `echo $last_progress | cut -d . -f 1` -lt 80 ]; then curl -X POST -H \u0026#39;Content-type: application/json\u0026#39; --data \u0026#39;{\u0026#34;blocks\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*\u0026lt;gh-ost.com|[Report] - gh-ost å›å ±ç›®å‰ç‹€æ…‹ :busy:\u0026gt;*\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*Report_Time:* \u0026#39;\u0026#34;${show_time}\u0026#34;\u0026#39;\\n*Host:* \u0026#39;\u0026#34;${GH_OST_MIGRATED_HOST}\u0026#34;\u0026#39;\\n*Table:* `\u0026#39;\u0026#34;${GH_OST_DATABASE_NAME}\u0026#34;\u0026#39;`.`\u0026#39;\u0026#34;${GH_OST_TABLE_NAME}\u0026#34;\u0026#39;`\\n*DDL:* \u0026#39;\u0026#34;${GH_OST_DDL}\u0026#34;\u0026#39;\\n*Time elapsed(sec):* \u0026#39;\u0026#34;${GH_OST_ELAPSED_SECONDS}\u0026#34;\u0026#39;\\n*Status:*\\n ```\u0026#39;\u0026#34;${GH_OST_STATUS}\u0026#34;\u0026#39;```\\n*ç•¶å‰é€²åº¦:* \u0026#39;\u0026#34;${GH_OST_PROGRESS}\u0026#34;\u0026#39;%\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;,\u0026#34;elements\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;:gh-ost: *gh-ost* | \u0026#39;\u0026#34;${show_day}\u0026#34;\u0026#39;\u0026#34;}]}]}\u0026#39; ${slack_hook} fi 1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash # Sample hook file for gh-ost-on-failure # ç•¶gh-ostå¤±æ•—æ™‚æ¨é€åˆ°slack slack_hook=`cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook` show_time=$(date +\u0026#34;(%:z)%Y-%m-%d %H:%M:%S\u0026#34;) show_day=$(date +\u0026#34;%b %-d\u0026#34;) GH_OST_MIGRATED_HOST=$GH_OST_MIGRATED_HOST GH_OST_DATABASE_NAME=$GH_OST_DATABASE_NAME GH_OST_TABLE_NAME=$GH_OST_TABLE_NAME GH_OST_DDL=$GH_OST_DDL curl -X POST -H \u0026#39;Content-type: application/json\u0026#39; --data \u0026#39;{\u0026#34;blocks\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*\u0026lt;gh-ost.com|[`Warning`] - gh-ost ç†±æ›´æ–°å¤±æ•—:alert:\u0026gt;*\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*Failed_Time:* \u0026#39;\u0026#34;${show_time}\u0026#34;\u0026#39;\\n*Host:* \u0026#39;\u0026#34;${GH_OST_MIGRATED_HOST}\u0026#34;\u0026#39;\\n*Table:* `\u0026#39;\u0026#34;${GH_OST_DATABASE_NAME}\u0026#34;\u0026#39;`.`\u0026#39;\u0026#34;${GH_OST_TABLE_NAME}\u0026#34;\u0026#39;`\\n*DDL:* \u0026#39;\u0026#34;${GH_OST_DDL}\u0026#34;\u0026#39;\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;,\u0026#34;elements\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;:gh-ost: *gh-ost* | \u0026#39;\u0026#34;${show_day}\u0026#34;\u0026#39;\u0026#34;}]}]}\u0026#39; ${slack_hook} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/bash # Sample hook file for gh-ost-on-begin-postponed # ç•¶gh-ost é–‹å§‹æ¨é²cut overæ™‚æ¨é€slack slack_hook=`cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook` show_time=$(date +\u0026#34;(%:z)%Y-%m-%d %H:%M:%S\u0026#34;) show_day=$(date +\u0026#34;%b %-d\u0026#34;) GH_OST_MIGRATED_HOST=$GH_OST_MIGRATED_HOST GH_OST_DATABASE_NAME=$GH_OST_DATABASE_NAME GH_OST_TABLE_NAME=$GH_OST_TABLE_NAME GH_OST_DDL=$GH_OST_DDL GH_OST_ELAPSED_SECONDS=$GH_OST_ELAPSED_SECONDS curl -X POST -H \u0026#39;Content-type: application/json\u0026#39; --data \u0026#39;{\u0026#34;blocks\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*\u0026lt;gh-ost.com|[Postpon] - gh-ost is ready to cut-over(rename) :gj:\u0026gt;*\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*Postponed_Time:* \u0026#39;\u0026#34;${show_time}\u0026#34;\u0026#39;\\n*Host:* \u0026#39;\u0026#34;${GH_OST_MIGRATED_HOST}\u0026#34;\u0026#39;\\n*Table:* `\u0026#39;\u0026#34;${GH_OST_DATABASE_NAME}\u0026#34;\u0026#39;`.`\u0026#39;\u0026#34;${GH_OST_TABLE_NAME}\u0026#34;\u0026#39;`\\n*DDL:* \u0026#39;\u0026#34;${GH_OST_DDL}\u0026#34;\u0026#39;\\n*Time elapsed(sec):* \u0026#39;\u0026#34;${GH_OST_ELAPSED_SECONDS}\u0026#34;\u0026#39;\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;,\u0026#34;elements\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;:gh-ost: *gh-ost* | \u0026#39;\u0026#34;${show_day}\u0026#34;\u0026#39;\u0026#34;}]}]}\u0026#39; ${slack_hook} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #!/bin/bash # Sample hook file for gh-ost-on-status # gh-ost æ”¶åˆ°äº’å‹•å¼å‘½ä»¤æ™‚æ¨é€åˆ° slack slack_hook=`cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook` show_time=$(date +\u0026#34;(%:z)%Y-%m-%d %H:%M:%S\u0026#34;) show_day=$(date +\u0026#34;%b %-d\u0026#34;) GH_OST_MIGRATED_HOST=$GH_OST_MIGRATED_HOST GH_OST_DATABASE_NAME=$GH_OST_DATABASE_NAME GH_OST_TABLE_NAME=$GH_OST_TABLE_NAME GH_OST_DDL=$GH_OST_DDL GH_OST_ELAPSED_SECONDS=$GH_OST_ELAPSED_SECONDS GH_OST_STATUS=$GH_OST_STATUS GH_OST_PROGRESS=$GH_OST_PROGRESS GH_OST_COMMAND=$(echo $GH_OST_COMMAND | sed \u0026#39;s/\u0026#39;\u0026#34;\u0026#39;\u0026#34;/\u0026#39;`\u0026#39;\u0026#39;/g\u0026#39;) if [ ${GH_OST_COMMAND} = \u0026#39;`unpostpone`\u0026#39; ] || [ ${GH_OST_COMMAND} = \u0026#39;`throttle`\u0026#39; ] || [ ${GH_OST_COMMAD} = \u0026#39;`panic`\u0026#39; ] || [ ${GH_OST_COMMAND} = \u0026#39;`no-throttle`\u0026#39; ] ; then curl -X POST -H \u0026#39;Content-type: application/json\u0026#39; --data \u0026#39;{\u0026#34;blocks\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*\u0026lt;gh-ost.com|[New command] - gh-ost æ”¶åˆ°å‘½ä»¤ :ook:\u0026gt;*\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*Report_Time:* \u0026#39;\u0026#34;${show_time}\u0026#34;\u0026#39;\\n*Host:* \u0026#39;\u0026#34;${GH_OST_MIGRATED_HOST}\u0026#34;\u0026#39;\\n*Table:* `\u0026#39;\u0026#34;${GH_OST_DATABASE_NAME}\u0026#34;\u0026#39;`.`\u0026#39;\u0026#34;${GH_OST_TABLE_NAME}\u0026#34;\u0026#39;`\\n*DDL:* \u0026#39;\u0026#34;${GH_OST_DDL}\u0026#34;\u0026#39;\\n*Time elapsed(sec):* \u0026#39;\u0026#34;${GH_OST_ELAPSED_SECONDS}\u0026#34;\u0026#39;\\n*ç•¶å‰é€²åº¦:* \u0026#39;\u0026#34;${GH_OST_PROGRESS}\u0026#34;\u0026#39;%\\n*Command:*\u0026#39;\u0026#34;${GH_OST_COMMAND}\u0026#34;\u0026#39;\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;,\u0026#34;elements\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;:gh-ost: *gh-ost* | \u0026#39;\u0026#34;${show_day}\u0026#34;\u0026#39;\u0026#34;}]}]}\u0026#39; ${slack_hook} fi 1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash # Sample hook file for gh-ost-on-success # ç•¶gh-ost å®Œæˆæ™‚æ¨é€slack slack_hook=`cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook` show_time=$(date +\u0026#34;(%:z)%Y-%m-%d %H:%M:%S\u0026#34;) show_day=$(date +\u0026#34;%b %-d\u0026#34;) GH_OST_MIGRATED_HOST=$GH_OST_MIGRATED_HOST GH_OST_DATABASE_NAME=$GH_OST_DATABASE_NAME GH_OST_TABLE_NAME=$GH_OST_TABLE_NAME GH_OST_DDL=$GH_OST_DDL curl -X POST -H \u0026#39;Content-type: application/json\u0026#39; --data \u0026#39;{\u0026#34;blocks\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*\u0026lt;gh-ost.com|[Success] - gh-ost å·²å®Œæˆç†±æ›´æ–°:tada:\u0026gt;*\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;,\u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;*Success_Time:* \u0026#39;\u0026#34;${show_time}\u0026#34;\u0026#39;\\n*Host:* \u0026#39;\u0026#34;${GH_OST_MIGRATED_HOST}\u0026#34;\u0026#39;\\n*Table:* `\u0026#39;\u0026#34;${GH_OST_DATABASE_NAME}\u0026#34;\u0026#39;`.`\u0026#39;\u0026#34;${GH_OST_TABLE_NAME}\u0026#34;\u0026#39;`\\n*DDL:* \u0026#39;\u0026#34;${GH_OST_DDL}\u0026#34;\u0026#39;\u0026#34;}},{\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;,\u0026#34;elements\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;,\u0026#34;text\u0026#34;: \u0026#34;:gh-ost: *gh-ost* | \u0026#39;\u0026#34;${show_day}\u0026#34;\u0026#39;\u0026#34;}]}]}\u0026#39; ${slack_hook} æ–¹æ¡ˆæ¯”è¼ƒèˆ‡é¸æ“‡ ","date":"2024-10-16T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/gh-ost/","title":"gh-ost"},{"content":"æ±ºå®šæ›´æ–°æ–¹å¼ MySQL Online DDL 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // ä»¥ä¸‹æ›´æ–°é …ç›®å¯ç›´æ¥ä½¿ç”¨ MySQL Online DDL æ›´æ–°å³å¯ MySQL 5.7ï¼š 1. drop \u0026amp; rename index 2. rename column \u0026amp; table 3. èª¿æ•´é»˜èªå€¼ 4. varcharæ¬„ä½åŠ å¤§ (0~255) or (256~) 5. æ–°å¢ \u0026amp; åˆªé™¤è™›æ“¬åˆ— 6. auto_increment = ? MySQL 8.0.29ä»¥ä¸‹ å¿«é€ŸåŠ åˆ—æ¢ä»¶èˆ‡é™åˆ¶ï¼š 1. ä¸èƒ½å’Œå…¶ä»–ä¸æ”¯æŒ INSTANT çš„ DDL èªå¥åŒæ™‚ä½¿ç”¨ 2. åªèƒ½åŠ åœ¨è¡¨ä¸­çš„æœ€å¾Œä¸€åˆ— 3. åŠ åˆ—ä¸èƒ½åœ¨ ROW_FORMAT = COMPRESSED ä½¿ç”¨ 4. åŠ åˆ—ä¸èƒ½åœ¨åŒ…å« FULLTEXT INDEX çš„è¡¨ä¸­ä½¿ç”¨ 5. åŠ åˆ—ä¸èƒ½æ·»åŠ åˆ° temporary table ä¸­ 6. Columns cannot be added to tables that reside in the data dictionary tablespace. 7. åªåœ¨ UPDATEã€INSERT æ™‚ï¼Œæ‰æª¢æŸ¥ ROW æ˜¯å¦ç¬¦åˆ TABLE å¤§å°é™åˆ¶ MySQL 8.0.29é–‹å§‹ï¼š 1. å¿«é€ŸåŠ åˆ—ä¸å†æœ‰ä½ç½®é™åˆ¶ 2. drop column æ³¨æ„ï¼šç•¶é” 64 æ¬¡æ“ä½œ INSTANT ç®—æ³•å¾Œï¼Œéœ€è¦ä½¿ç”¨ COPY ç®—æ³•æˆ– gh-ost ç­‰æ–¹æ¡ˆé‡ç½®æ­¤è¨ˆæ•¸ï¼Œä¸é MySQL 9.1 é–‹å§‹æ¬¡æ•¸å¢åŠ åˆ° 225 æ¬¡ã€‚ å¯é€éä»¥ä¸‹èªæ³•ç¢ºèªç›®å‰æ¬¡æ•¸ï¼š SELECT NAME, TOTAL_ROW_VERSIONS FROM INFORMATION_SCHEMA.INNODB_TABLES WHERE NAME LIKE \u0026#39;dbname/tablename\u0026#39;; gh-ost æ–¹æ¡ˆ äº‹å‰è¨­å®š 1 2 3 4 5 6 7 8 9 10 // Linux å®‰è£ gh-ost sudo rpm -ivh gh-ost.rpm // Linux å®‰è£ nc sudo yum install nc // vim my.cnfï¼ŒæŒä¹…åŒ– binlog_format è¨­å®š binlog_format = ROW binlog_rows_query_log_events = ON binlog_row_image = full åŸ·è¡Œæ­¥é©Ÿ system variables æª¢æŸ¥\n1 2 3 4 5 6 // æª¢æŸ¥ system variables SHOW GLOBAL VARIABLES LIKE \u0026#39;binlog_format\u0026#39;; # ROW SHOW GLOBAL VARIABLES LIKE \u0026#39;binlog_row_image\u0026#39;; # full SHOW GLOBAL VARIABLES LIKE \u0026#39;sql_mode\u0026#39;; # \u0026#39;\u0026#39;ï¼Œè‹¥ä¸æ˜¯åš´æ ¼æ¨¡å¼ï¼Œéœ€æ·»åŠ -skip-strict-mode SHOW GLOBAL VARIABLES LIKE \u0026#39;log_bin\u0026#39;; # ON SHOW GLOBAL VARIABLES LIKE \u0026#39;log_slave_updates\u0026#39;; # ON ä¸è¦å¸¶å…¥ --execute é€²è¡Œç°¡æ˜“æ¸¬è©¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 slave_host=\u0026#34;slave_host\u0026#34; database_name=\u0026#34;ghost_test\u0026#34; table_name=\u0026#34;event_1\u0026#34; ddl_query=\u0026#34;ADD COLUMN test varchar(20) AFTER remark, ADD COLUMN test2 varchar(20) AFTER test\u0026#34; gh_ost_user=\u0026#34;OdLd\u0026#34; # åƒæ•¸è©³ç´°å¯åƒè€ƒï¼š[https://www.notion.so/eb0d22b2eea64fb7bfed176a8efab6c1?v=b9f4fd843f69483cbbe74aa04c4a1372](gh-ost%20b1e6f809c8c54a009cde6b2b7f1ab00c/%E5%8F%83%E6%95%B8%20eb0d22b2eea64fb7bfed176a8efab6c1.md) gh-ost \\ --assume-rbr \\ --exact-rowcount \\ --concurrent-rowcount \\ `# global sql_mode ä¸æ˜¯åš´æ ¼æ¨¡å¼éœ€æ·»åŠ ` \\ --skip-strict-mode \\ --host=\u0026#34;${slave_host}\u0026#34; --port=3306 --user=\u0026#34;${gh_ost_user}\u0026#34; --ask-pass \\ --database=\u0026#34;${database_name}\u0026#34; --table=\u0026#34;${table_name}\u0026#34; \\ --alter=\u0026#34;${ddl_query}\u0026#34; \\ --timestamp-old-table \\ `# gh-ost çš„ server_id, è¨­å®šç‚º 1000000000 + linux pid` \\ --replica-server-id=$((1000000000+$$)) \\ `# é€²å…¥ throttle çš„ loading é–€æª»` \\ --max-load=Threads_running=200 \\ `# éœ€è¦ç›£æ§replication lag çš„slaveï¼Œç•¶gh-oståµæ¸¬ä¸åˆ°æ™‚ä½¿ç”¨ï¼Œæ ¼å¼ï¼šmyhost1.com:3307,myhost2.com:3308` \\ `#--throttle-control-replicas=myhost1.com:3307,myhost2.com:3308` \\ --max-lag-millis=1000 \\ `# ç•¶å­˜åœ¨è©²æ–‡ä»¶æ™‚ï¼Œé€²å…¥throttle` \\ --throttle-flag-file=/tmp/gh-ost_${database_name}_${table_name}_throttle.flag \\ --throttle-additional-flag-file=/tmp/gh-ost_all_throttle.flag \\ `# --throttle-query string` \\ `# critical load è¨­å®šï¼Œæ ¼å¼:some_status=\u0026lt;numeric-threshold\u0026gt;[,some_status=\u0026lt;numeric-threshold\u0026gt;...]` \\ --critical-load=Threads_running=250 \\ --critical-load-hibernate-seconds 60 \\ `# æ¯æ¬¡è™•ç†çš„è¡Œæ•¸ï¼Œå¯ä»¥è¦–loadingèª¿æ•´ï¼Œé è¨­1000` \\ --chunk-size=1000 \\ `# ç¯„åœ 0.0~100.0ï¼Œæ¯è¤‡è£½å®Œä¸€å€‹chunkçš„è³‡æ–™å¾Œï¼Œ gh-ost å°‡ä¼‘çœ  è¤‡è£½æ¶ˆè€—çš„æ™‚é–“ * nice-ratio` \\ `# å‡è¨­æ¯è¤‡è£½ä¸€å€‹chunkçš„è³‡æ–™éœ€è¦ 100msï¼Œç•¶ nice-ratio=0.5 æ™‚ï¼Œ gh-ost å°‡ä¼‘çœ  100*0.5=50ms` \\ --nice-ratio=0 \\ `# gh-ost æ‰¹æ¬¡æ‡‰ç”¨ binlog äº‹ä»¶çš„æ•¸é‡ï¼Œé€šå¸¸ä¸éœ€è¦èª¿æ•´` \\ --dml-batch-size=10 \\ `# è©²æ–‡ä»¶å­˜åœ¨æ™‚ï¼Œgh-ostæœƒç›´æ¥ä¸­æ–·ï¼Œä¸¦ä¸”ä¸è™•ç†å·²è¤‡è£½çš„è³‡æ–™` \\ --panic-flag-file=/tmp/gh-ost_${database_name}_${table_name}_panic.flag \\ --force-named-cut-over --force-named-panic \\ `#è‹¥æƒ³ç«‹åˆ»åˆ‡æ›æ–°è¡¨ï¼Œè«‹å–è¨»è§£ä¸‹æ–¹åƒæ•¸ï¼Œä½†ä¸å»ºè­°` \\ --postpone-cut-over-flag-file=/tmp/gh-ost_${database_name}_${table_name}_postpone.flag \\ --verbose è‹¥ä»¥ä¸Šæ¸¬è©¦å¾Œæ²’æœ‰å•é¡Œå¯ä»¥æ­£å¼åŸ·è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 slave_host=\u0026#34;slave_host\u0026#34; database_name=\u0026#34;ghost_test\u0026#34; table_name=\u0026#34;event_1\u0026#34; ddl_query=\u0026#34;ADD COLUMN test varchar(20) AFTER remark, ADD COLUMN test2 varchar(20) AFTER test\u0026#34; gh_ost_user=\u0026#34;OdLd\u0026#34; gh-ost \\ --assume-rbr \\ --exact-rowcount \\ --concurrent-rowcount \\ `# global sql_mode ä¸æ˜¯åš´æ ¼æ¨¡å¼éœ€æ·»åŠ ` \\ --skip-strict-mode \\ --host=\u0026#34;${slave_host}\u0026#34; --port=3306 --user=\u0026#34;${gh_ost_user}\u0026#34; --ask-pass \\ --database=\u0026#34;${database_name}\u0026#34; --table=\u0026#34;${table_name}\u0026#34; \\ --alter=\u0026#34;${ddl_query}\u0026#34; \\ --timestamp-old-table \\ `# gh-ost çš„ server_id, è¨­å®šç‚º 1000000000 + linux pid` \\ --replica-server-id=$((1000000000+$$)) \\ `# é€²å…¥ throttle çš„ loading é–€æª»` \\ --max-load=Threads_running=200 \\ `# éœ€è¦ç›£æ§replication lag çš„slaveï¼Œç•¶gh-oståµæ¸¬ä¸åˆ°æ™‚ä½¿ç”¨ï¼Œæ ¼å¼ï¼šmyhost1.com:3307,myhost2.com:3308` \\ `#--throttle-control-replicas=myhost1.com:3307,myhost2.com:3308` \\ --max-lag-millis=1000 \\ `# ç•¶å­˜åœ¨è©²æ–‡ä»¶æ™‚ï¼Œé€²å…¥throttle` \\ --throttle-flag-file=/tmp/gh-ost_${database_name}_${table_name}_throttle.flag \\ --throttle-additional-flag-file=/tmp/gh-ost_all_throttle.flag \\ `# --throttle-query string` \\ `# critical load è¨­å®šï¼Œæ ¼å¼:some_status=\u0026lt;numeric-threshold\u0026gt;[,some_status=\u0026lt;numeric-threshold\u0026gt;...]` \\ --critical-load=Threads_running=250 \\ --critical-load-hibernate-seconds 60 \\ `# æ¯æ¬¡è™•ç†çš„è¡Œæ•¸ï¼Œå¯ä»¥è¦–loadingèª¿æ•´ï¼Œé è¨­1000` \\ --chunk-size=1000 \\ `# ç¯„åœ 0.0~100.0ï¼Œæ¯è¤‡è£½å®Œä¸€å€‹chunkçš„è³‡æ–™å¾Œï¼Œ gh-ost å°‡ä¼‘çœ  è¤‡è£½æ¶ˆè€—çš„æ™‚é–“ * nice-ratio` \\ `# å‡è¨­æ¯è¤‡è£½ä¸€å€‹chunkçš„è³‡æ–™éœ€è¦ 100msï¼Œç•¶ nice-ratio=0.5 æ™‚ï¼Œ gh-ost å°‡ä¼‘çœ  100*0.5=50ms` \\ --nice-ratio=0 \\ `# gh-ost æ‰¹æ¬¡æ‡‰ç”¨ binlog äº‹ä»¶çš„æ•¸é‡ï¼Œé€šå¸¸ä¸éœ€è¦èª¿æ•´` \\ --dml-batch-size=10 \\ `# è©²æ–‡ä»¶å­˜åœ¨æ™‚ï¼Œgh-ostæœƒç›´æ¥ä¸­æ–·ï¼Œä¸¦ä¸”ä¸è™•ç†å·²è¤‡è£½çš„è³‡æ–™` \\ --panic-flag-file=/tmp/gh-ost_${database_name}_${table_name}_panic.flag \\ --force-named-cut-over --force-named-panic \\ --verbose \\ `#è‹¥æƒ³ç«‹åˆ»åˆ‡æ›æ–°è¡¨ï¼Œè«‹å–è¨»è§£ä¸‹æ–¹åƒæ•¸ï¼Œä½†ä¸å»ºè­°` \\ --postpone-cut-over-flag-file=/tmp/gh-ost_${database_name}_${table_name}_postpone.flag \\ --hooks-path=/var/lib/DBA/gh-ost/gh-ost_hooks \\ --execute 2\u0026gt;\u0026amp;1 | tee /tmp/gh-ost_${database_name}_${table_name}.log è‹¥åœ¨éæ­£å¼ç’°å¢ƒï¼Œå¯ä»¥åœ¨åˆ‡æ›å‰ç›´æ¥æ¯”è¼ƒæ–°èˆŠè¡¨çš„éƒ¨åˆ†è³‡æ–™ï¼›è‹¥åœ¨æ­£å¼ç’°å¢ƒï¼Œå¯ä»¥åœ¨åˆ‡æ›å‰åˆ° å‚™ä»½æ©Ÿ stop slave å¾Œï¼Œå¾¹åº•æ¯”è¼ƒæ–°èˆŠè¡¨çš„è³‡æ–™æ›´å®‰å¿ƒ\nç¢ºå®šè¦åˆ‡æ›è¡¨ä¹‹å¾Œï¼Œé–‹å•Ÿå¦å¤–ä¸€å€‹è¦–çª—ï¼Œåˆªé™¤ postpone-cut-over-flag-file æŒ‡å®šçš„æª”æ¡ˆ\n1 2 3 4 5 6 7 8 9 10 11 #Copy: 0/0 100.0%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 0s(copy); #streamer: bin.000002:104008387; Lag: 0.01s, State: postponing cut-over; ETA: due #å¦‚ä¸Šä¾‹ç•¶é€²åº¦ä¸­å‡ºç¾State: postponing cut-overè¡¨ç¤ºåŸè¡¨çš†å·²é·ç§»å®Œæˆï¼Œæ­¤æ™‚é€²åº¦ä¹Ÿæœƒæ˜¯100% #å¯ä»¥å°‡æ–°èˆŠè¡¨äº¤æ›äº†ï¼Œæ­¤æ™‚å¯ä»¥é€éä»¥ä¸‹å…©ç¨®æ–¹å¼ç¹¼çºŒä¸‹ä¸€æ­¥åˆ‡è¡¨å‹•ä½œ # ç¬¬ä¸€ç¨®æ–¹å¼ ls -l /tmp rm -f /tmp/gh-ost_databasename_tablename_postpone.flag # ç¬¬äºŒç¨®æ–¹å¼ echo unpostpone=\u0026#39;tablename\u0026#39; | nc -U /tmp/gh-ost.dbname.tablename.sock æ–¼ loading è¼ƒä½çš„æ™‚æ®µåŸ·è¡Œåˆªé™¤èˆŠè¡¨çš„å‹•ä½œ\n1 DROP TABLE ... ç‰¹æ®Šæƒ…æ³ _gho(æˆ–_ghc) already exists æˆ– sock: bind:address already in use ç•¶ç™¼ç”ŸéŒ¯èª¤ï¼š _gho(æˆ–_ghc) already exists æˆ– sock: bind:address already in useï¼Œæœ‰å¯èƒ½æ˜¯ ä¸Šä¸€æ¬¡é·ç§»å¤±æ•— æˆ–è€… å·²ç¶“æœ‰gh-oståœ¨é·ç§»è©²å¼µè¡¨ï¼Œå¦‚æœæ˜¯ ä¸Šä¸€æ¬¡é·ç§»å¤±æ•— è«‹åˆªé™¤ table OR socket å³å¯æ­£å¸¸é‹ä½œã€‚\n1 2 3 4 5 6 7 8 # table å·²å­˜åœ¨ FATAL Table `_tablename_gho` already exists. Panicking. Use --initially-drop-ghost-table to force dropping it, though I really prefer that you drop it or rename it away # socket å·²å­˜åœ¨ FATAL listen unix /tmp/gh-ost.databasename.tablename.sock: bind: address already in use å¦‚æœæ²’æœ‰Slaveï¼Œå¦‚ä½•ä½¿ç”¨ gh-ost å‘¢? 1 2 3 4 5 # host çš„éƒ¨åˆ†å¡«å…¥ masterï¼Œä¸¦åŠ ä¸Š allow-on-master çš„åƒæ•¸ slave_host=\u0026#34;master_host\u0026#34; gh-ost \\ --allow-on-master \\ [error] binlogstreamer.go:77 close sync with err: sync is been closing\u0026hellip; æˆåŠŸåŸ·è¡Œå®Œç•¢å¾Œå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼Œè‹¥DDLæœ‰æ­£å¸¸åŸ·è¡Œå¯ä»¥å¿½ç•¥\n1 2 3 # gh-ost é‡è¤‡é—œé–‰è¤‡è£½é€šé“ [error] binlogstreamer.go:77 close sync with err: sync is been closing... # å¯åƒè€ƒ [https://github.com/github/gh-ost/issues/597](https://github.com/github/gh-ost/issues/597) ERROR Error 1146: Table \u0026lsquo;account_proxy._sms_validate_code_ghc\u0026rsquo; doesn\u0026rsquo;t exist æˆåŠŸåŸ·è¡Œå®Œç•¢å¾Œå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼Œè‹¥DDLæœ‰æ­£å¸¸åŸ·è¡Œå¯ä»¥å¿½ç•¥\n1 2 3 # gh-ost åˆªé™¤ ghc tableå¾Œï¼Œbinlogæ‡‰ç”¨è·Ÿåˆ°æ­¤èªæ³•ä¸”è¢« gh-ost æ•æ‰åˆ° ERROR Error 1146: Table \u0026#39;account_proxy._sms_validate_code_ghc\u0026#39; doesn\u0026#39;t exist # å¯åƒè€ƒ [https://github.com/github/gh-ost/issues/657](https://github.com/github/gh-ost/issues/657) gh-ost åŸ·è¡Œéç¨‹å‡ºç¾ ERROR 1364 ç•¶åŸ·è¡Œ gh-ost é€”ä¸­å‡ºç¾ ERROR 1364 å¦‚ä¸‹éŒ¯èª¤ï¼š\n1 2 3 4 5 6 7 8 Copy: 1/1 100.0%; Applied: 0; Backlog: 0/1000; Time: 22s(total), 1s(copy); streamer: binlog.000002:382415; Lag: 0.12s, State: postponing cut-over; ETA: due 2021-11-24 15:21:26 ERROR Error 1364: Field \u0026#39;test_2\u0026#39; doesn\u0026#39;t have a default value; query= replace /* gh-ost `test`.`_test_gho` */ into `test`.`_test_gho` (`id`, `test_1`) values (?, ?) ; args=[2 test2] é€™å€‹åŸå› é€šå¸¸æ˜¯ç™¼ç”Ÿåœ¨æ–°å¢ä¸€å€‹ NOT NULL ä¸”æ²’æœ‰ DEFAULT å€¼çš„æ¬„ä½çš„æ™‚å€™ï¼Œå› ç‚º gh-ost é è¨­æœƒå¦‚ä¸‹åœ¨ session åŠ ä¸Šåš´æ ¼æ¨¡å¼ï¼š\n1 2 SET SESSION time_zone = \u0026#39;+00:00\u0026#39;, sql_mode = CONCAT(@@session.sql_mode, \u0026#39;,,NO_AUTO_VALUE_ON_ZERO,STRICT_ALL_TABLES\u0026#39;) æˆ‘å€‘éƒ½çŸ¥é“ç•¶ sql_mode åœ¨åš´æ ¼æ¨¡å¼ (STRICT_ALL_TABLES) ä¹‹ä¸‹æ™‚ï¼Œå°æ–¼ NOT NULL æ²’æœ‰é è¨­å€¼çš„æ¬„ä½å¦‚æœåœ¨ insert into å’Œ replace into æ²’æœ‰çµ¦å€¼ï¼Œå°±æœƒå°è‡´å™´éŒ¯ doesn't have a default value è€Œç„¡æ³•æ–°å¢ã€‚\næ¥ä¸‹ä¾†è®“æˆ‘å€‘è¤‡ç¿’ä¸€ä¸‹ gh-ost æ˜¯å¦‚ä½•ä½œè³‡æ–™é·ç§»çš„ï¼š\næ‡‰ç”¨é¡å‹ åŸè¡¨æ“ä½œ æ–°è¡¨æ“ä½œ Row Copy SELECT INSERT IGNORE INTO Binlog Apply INSERT REPLACE INTO å°æ–¼åŸè¡¨å·²ç¶“å­˜åœ¨çš„è³‡æ–™ gh-ost æ˜¯æ¡ç”¨ INSERT IGNORE INTO ä¾†å¯«åˆ° _gho è¡¨ï¼Œæ‰€ä»¥é›–ç„¶ä¸€æ¨£æœƒç™¼ç”Ÿ ERROR 1364ï¼Œä½†æ˜¯ IGNORE æ“ä½œåªæœƒ warnings æç¤ºï¼Œè€Œä¸æœƒé˜»æ“‹ INSERTï¼Œå¦‚ä¸‹äº‹ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 mysql\u0026gt; show create table test\\G *************************** 1. row *************************** Table: test Create Table: CREATE TABLE `test` ( `id` int NOT NULL AUTO_INCREMENT, `test` varchar(10) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci mysql\u0026gt; INSERT IGNORE INTO test(id) values(1); Query OK, 1 row affected, 1 warnings (0.00 sec) mysql\u0026gt; SHOW warnings\\G *************************** 1. row *************************** Level: Warning Code: 1364 Message: Field \u0026#39;test\u0026#39; doesn\u0026#39;t have a default value mysql\u0026gt; SELECT * FROM test; +----+--------+ | id | test_1 | +----+--------+ | 1 | | +----+--------+ å°æ–¼ gh-ost åŸ·è¡ŒæœŸé–“ INSERT é€²ä¾†çš„æ–°è³‡æ–™æ˜¯æ¡ç”¨ REPLACE INTO ä¾†å¯«åˆ° _gho è¡¨ï¼Œæœƒç™¼ç”Ÿ ERROR 1364 ä¸¦è¢«é˜»æ“‹ INSERTï¼Œå¦‚ä¸‹äº‹ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 mysql\u0026gt; REPLACE INTO test(id) values(2); ERROR 1364 (HY000): Field \u0026#39;test_1\u0026#39; doesn\u0026#39;t have a default value mysql\u0026gt; SELECT * FROM test; +----+--------+ | id | test_1 | +----+--------+ | 1 | | +----+--------+ è§£æ±ºæ–¹æ³•æœ‰å…©ç¨®ï¼š\nNOT NULL æ¬„ä½éƒ½åŠ ä¸Šé»˜èªçš„ defaults å±¬æ€§\nç¢ºä¿ GLOBAL sql_mode åœ¨éåš´æ ¼æ¨¡å¼æ™‚ï¼Œå¯ä»¥åœ¨ gh-ost æ·»åŠ  --skip-strict-mode é¸é …ã€‚ æ·»åŠ æ­¤é¸é …å¾Œ gh-ost çš„ session é€£ç·šå°±ä¸æœƒä¸»å‹•è¨­å®šåš´æ ¼æ¨¡å¼äº†ï¼Œå¦‚ä¸‹ï¼š\n1 2 SET SESSION time_zone = \u0026#39;+00:00\u0026#39;, sql_mode = CONCAT(@@session.sql_mode, \u0026#39;,,NO_AUTO_VALUE_ON_ZERO\u0026#39;) æ‰‹å‹•æš«æ™‚åœæ­¢ gh-ost å¸¶ä¾†çš„ loading 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æš«åœ gh-ost å¯«å…¥è³‡æ–™ echo throttle | nc -U /tmp/gh-ost.dbname.tablename.sock # æª¢æŸ¥ç›®å‰ç‹€æ³ï¼Œå¯ä»¥ç™¼ç¾ throttled, commanded by user $ echo status | nc -U /tmp/gh-ost.test.sample_data_0.sock # Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst` # Migration started at Tue Jun 07 11:56:03 +0200 2016 # chunk-size: 250; max lag: 1500ms; max-load: map[Threads_connected:20] # Throttle additional flag file: /tmp/gh-ost.throttle # Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock # Serving on TCP port: 10001 Copy: 0/2915 0.0%; Applied: 0; Backlog: 0/100; Elapsed: 59s(copy), 59s(total); streamer: mysql-bin.000551:68067; ETA: throttled, commanded by user # gh-ost ç¹¼çºŒå¯«å…¥è³‡æ–™ echo no-throttle | nc -U /tmp/gh-ost.dbname.tablename.sock å¦‚ä½•ä¸­æ–· gh-ost 1 2 # ä¸­æ–· gh-ost echo panic=\u0026#39;tablename\u0026#39; | nc -U /tmp/gh-ost.dbname.tablename.sock èª¿æ•´ gh-ost loading ç›¸é—œçš„åƒæ•¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # æŸ¥è©¢ echo \u0026#34;chunk-size=?\u0026#34; | nc -U /tmp/gh-ost.dbname.tablename.sock 1000 # ä¿®æ”¹ echo \u0026#34;chunk-size=250\u0026#34; | nc -U /tmp/gh-ost.dbname.tablename.sock # Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst` # Migration started at Tue Jun 07 11:56:03 +0200 2016 # chunk-size: 250; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20] # Throttle additional flag file: /tmp/gh-ost.throttle # Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock # Serving on TCP port: 10001 # å†æ¬¡æŸ¥è©¢ echo \u0026#34;chunk-size=?\u0026#34; | nc -U /tmp/gh-ost.dbname.tablename.sock 250 å¦‚ä½•èª¿æ•´ primary key ç”±æ–¼ gh-ostè¦æ±‚æ¯æ¬¡é·ç§»æ–°è¡¨å’ŒèˆŠè¡¨å¿…é ˆå…±äº«ä¸€å€‹ å”¯ä¸€ä¸”NOT NULL çš„ KEY(åªéœ€è¦æ¬„ä½ç›¸åŒï¼Œä¸éœ€è¦åŒå)ã€‚å› æ­¤å¦‚æœç•¶è¡¨ä¸­åªæœ‰ primary keyæ™‚ï¼Œç„¡æ³•ç›´æ¥èª¿æ•´ primary keyï¼Œè€Œæ˜¯éœ€è¦å…ˆæ–°å¢ä¸€å€‹ unique keyï¼Œå†ç¬¬äºŒæ¬¡é·ç§»æ™‚æ‰èƒ½èª¿æ•´ primark keyã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # åŸè¡¨ CREATE TABLE tbl ( id bigint unsigned not null, data varchar(255), new_pk_column int not null, PRIMARY KEY(id) ) # gh-ost ç¬¬ä¸€æ¬¡åŸ·è¡Œ # ddl_query=\u0026#34;ADD UNIQUE KEY temp_pk(new_pk_column)\u0026#34; CREATE TABLE tbl ( id bigint unsigned not null, data varchar(255), new_pk_column int not null, PRIMARY KEY(id), UNIQUE temp_pk(new_pk_column) ) # åŸè¡¨å’Œæ–°è¡¨ä»¥ PRIMARY KEY(id) ä½œç‚º Shared key # gh-ost ç¬¬äºŒæ¬¡åŸ·è¡Œ # ddl_query=\u0026#34;DROP PRIMARY KEY, # DROP KEY temp_pk, # ADD PRIMARY KEY (new_pk_column)\u0026#34; CREATE TABLE tbl ( id bigint unsigned not null, data varchar(255), new_pk_column int not null, PRIMARY KEY(new_pk_column) ) # åŸè¡¨ UNIQUE temp_pk(new_pk_column) å’Œæ–°è¡¨ PRIMARY KEY(new_pk_column) # ä½œç‚º Shared key å¦‚ä½•è§£æ±º Unexpected database port ç•¶å°é›²æœå‹™å•†çš„ rds æˆ–è€… dockerï¼Œ --port æŒ‡å®šç‚ºé 3306 æ™‚ï¼Œæœƒå› ç‚ºå…¶å…§éƒ¨ç¢ºå¯¦æ˜¯ 3306 è€Œå°è‡´æœªé€šéé©—è­‰ï¼Œæ­¤æ™‚å¯ä»¥é€éä½¿ç”¨ --aliyun-rds æˆ– --gcp ä¾†è·³éé©—è­‰ã€‚\nåƒè€ƒï¼šhttps://github.com/github/gh-ost/issues/631\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # å° rds æˆ– docker æŒ‡å®š 3306 ä»¥å¤–çš„ port gh-ost \\ --port=3307 \\ --verbose # error 2020-10-16 16:27:09 FATAL Unexpected database port reported: 3306 # åŠ ä¸Š --aliyun-rds è·³éé©—è­‰ gh-ost \\ --port=3307 \\ --aliyun-rds --verbose # æ­£å¸¸é‹ä½œ gh-ost å·åƒæ­¥ åªè·‘ä¸€æ¬¡ gh-ost çš„å·åƒæ­¥æ–¹æ³•ï¼Œå› ç‚º gh-ost åªæœ‰åœ¨ä¸€é–‹å§‹æœƒé©—è­‰æ–°èˆŠè¡¨æ˜¯å¦å¯ä»¥æ¬é·ï¼Œæ‰€ä»¥å¯ä»¥ç­‰ gh-ost å»ºç«‹å®Œæ–°è¡¨ gho å¾Œï¼Œå…ˆæš«åœè¤‡è£½è³‡æ–™çš„éç¨‹ï¼Œæˆ‘å€‘å‰‡å¯ä»¥é€²åˆ° DB æ‰‹å‹• ALTER æ–°è¡¨ ghoï¼Œæ­¤æ–¹æ³•å¯ä»¥ç”¨ä¾†è¶ŠéæŸäº›é™åˆ¶ï¼Œä½†å¯èƒ½é€ æˆè³‡æ–™ææ¯€ï¼Œè«‹æ˜ç¢ºçŸ¥é“è‡ªå·±åœ¨åšä»€éº¼æ‰èƒ½ä½¿ç”¨ï¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # é€éå»ºç«‹æ­¤æª”æ¡ˆï¼Œè®“ gh-ost å»ºç«‹å®Œæ–°è¡¨å¾Œå°±å…ˆæš«åœè¤‡è£½è³‡æ–™(æ³¨æ„ï¼šæœƒæš«åœæ‰€æœ‰gh-ost) touch /tmp/gh-ost_all_throttle.flag # å‚™è¨»ï¼šä¸ä½¿ç”¨ throttle-flag-file æ˜¯å› ç‚ºå¿…é ˆè¦ gh-ost åŸ·è¡Œå¾Œï¼Œå»ºç«‹æ‰æœƒç”Ÿæ•ˆ # åŸ·è¡Œ gh-ost gh-ost \\ --alter=\u0026#34;ADD COLUMN test VARCHAR(10) NOT NULL DEFAULT \u0026#39;\u0026#39;\u0026#34; \\ ... \\ --throttle-additional-flag-file=/tmp/gh-ost_all_throttle.flag \\ --execute # Copy: 0/1 0.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: bin-log.000006:305893; Lag: 0.01s, State: migrating; ETA: N/A # Copy: 0/1 0.0%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 1s(copy); streamer: bin-log.000006:311112; Lag: 0.01s, State: throttled, flag-file; ETA: N/A # ... # é€²åˆ° MySQL èª¿æ•´æ–°è¡¨ mysql \u0026gt; ALTER TABLE table_gho ADD INDEX test(`test`); # åˆªé™¤ flag rm -rf /tmp/gh-ost_all_throttle.flag # gh-ost æ­£å¸¸é‹è¡Œï¼Œæ–°çš„è¡¨æœƒåŒæ™‚å¤šä¸€å€‹ test æ¬„ä½å’Œ test index 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # åŸ·è¡Œ gh-ostï¼Œè®“ throttle é–€æª»å¾ˆä½ï¼Œä¸€å•Ÿå‹•å°±æš«åœ gh-ost \\ --alter=\u0026#34;ADD COLUMN test VARCHAR(10) NOT NULL DEFAULT \u0026#39;\u0026#39;\u0026#34; \\ ... \\ --max-load=Threads_running=0 \\ --execute # Copy: 0/1 0.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: bin-log.000006:305893; Lag: 0.01s, State: migrating; ETA: N/A # Copy: 0/1 0.0%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 1s(copy); streamer: bin-log.000006:311112; Lag: 0.01s, State: throttled, flag-file; ETA: N/A # ... # é€²åˆ° MySQL èª¿æ•´æ–°è¡¨ mysql \u0026gt; ALTER TABLE table_gho ADD INDEX test(`test`); # èª¿å›é–€æª» echo \u0026#34;max-load=Threads_running=200\u0026#34; | nc -U /tmp/gh-ost.test.sample_data_0.sock # gh-ost æ­£å¸¸é‹è¡Œï¼Œæ–°çš„è¡¨æœƒåŒæ™‚å¤šä¸€å€‹ test æ¬„ä½å’Œ test index pt-osc æ–¹æ¡ˆ åŸ·è¡Œ çµ¦äºˆsuperæ¬Šé™\n1 2 SELECT host FROM mysql.user WHERE user = \u0026#39;OdLd\u0026#39;; GRANT PROCESS,SUPER ON *.* TO \u0026#39;OdLd\u0026#39;@\u0026#39;\u0026#39;; åŸºæœ¬æ¸¬è©¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 pt-online-schema-change \\ --host=master_host --port=3306 \\ u=OdLd,D=database_name,t=table_name \\ --ask-pass \\ `#å¦‚æœæ–°å¢çš„æ¬„ä½ç‚ºNot Null å‰‡å¿…é ˆè¨­å®šDefaultå€¼,å¦å‰‡ptå·¥å…·æœƒå¤±æ•—` \\ --alter \u0026#34;add column test varchar(50) not null default \u0026#39;\u0026#39; after remark\u0026#34; \\ --print \\ --statistics \\ `#slaveå»¶é²æ™‚é–“` \\ --max-lag=1500 \\ `#æš«åœå¤šä¹…å¾Œå†ç¹¼çºŒ` \\ --check-interval=5 \\ `#é”åˆ° --max-load æœƒæš«åœç¨‹åº` \\ --max-load Threads_running=200 \\ `#é”åˆ° --critical-load æœƒåœæ­¢ç¨‹åº` \\ --critical-load Threads_running=400 \\ `#è‹¥ä¸æƒ³ç«‹åˆ»åˆ‡æ›æ–°è¡¨ï¼Œè«‹è¨»è§£ä¸‹æ–¹ï¼Œä½†ä¸å»ºè­°` \\ --no-drop-trigger --no-swap-tables \\ `#åŸ·è¡Œå‰å»ºè­°å…ˆç”¨dry-runåšåŸºæœ¬çš„æ¸¬è©¦` \\ --charset=utf8 \\ --dry-run æ­£å¼åŸ·è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 pt-online-schema-change \\ --host=master_host --port=3306 \\ u=OdLd,D=database_name,t=table_name \\ --ask-pass \\ `#å¦‚æœæ–°å¢çš„æ¬„ä½ç‚ºNot Null å‰‡å¿…é ˆè¨­å®šDefaultå€¼,å¦å‰‡ptå·¥å…·æœƒå¤±æ•—` \\ --alter \u0026#34;add column test varchar(50) not null default \u0026#39;\u0026#39; after remark\u0026#34; \\ --print \\ --statistics \\ `#slaveå»¶é²æ™‚é–“` \\ --max-lag=1500 \\ `#æš«åœå¤šä¹…å¾Œå†ç¹¼çºŒ` \\ --check-interval=5 \\ `#é”åˆ° --max-load æœƒæš«åœç¨‹åº` \\ --max-load Threads_running=200 \\ `#é”åˆ° --critical-load æœƒåœæ­¢ç¨‹åº` \\ --critical-load Threads_running=400 \\ `#è‹¥ä¸æƒ³ç«‹åˆ»åˆ‡æ›æ–°è¡¨ï¼Œè«‹è¨»è§£ä¸‹æ–¹ï¼Œä½†ä¸å»ºè­°` \\ --no-drop-trigger --no-swap-tables \\ --charset=utf8 \\ --execute å¦‚æœè¦æ‰‹å‹•åˆ‡æ› tableï¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 # äº¤æ› RENAME TABLE origan_table TO origan_table_old,new_table TO origan_table; # åˆªé™¤ Trigger DROP TRIGGER IF EXISTS database_name.pt_osc_database_name_table_name_del; DROP TRIGGER IF EXISTS database_name.pt_osc_database_name_table_name_upd; DROP TRIGGER IF EXISTS database_name.pt_osc_database_name_table_name_ins; # åˆªé™¤èˆŠè¡¨ DROP TABLE IF EXISTS origan_table_old; # ç§»é™¤æ¬Šé™ REVOKE PROCESS,SUPER ON *.* FROM \u0026#39;OdLd\u0026#39;@\u0026#39;\u0026#39;; ","date":"2024-10-16T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-online-ddl-sop/","title":"Online DDL SOP"},{"content":"ç°¡ä»‹ åœ¨ MergeTree ä¸­æœƒä¾ç…§è¡¨ä¸Šçš„ partition by æŒ‡å®šçš„åˆ†å€éµå°‡ INSERT çš„è³‡æ–™å¡å…¥åˆ°å°æ‡‰çš„åˆ†å€ä¸­ï¼Œä¸åŒåˆ†å€çš„è³‡æ–™æœƒåˆ†æ•£åœ¨ä¸åŒçš„å¯¦é«”ç›®éŒ„ï¼Œåœ¨è¨ªå•æ•¸æ“šæ™‚å¯ä»¥å¹«åŠ© ClickHouse ç›¡å¯èƒ½å°‘çš„æƒææ•¸æ“šã€‚\nå¤§å¤šæ•¸çš„æƒ…æ³ä¸‹ä¸éœ€è¦åˆ†å€éµï¼Œå³ä½¿éœ€è¦é€šå¸¸ä¹Ÿä¸éœ€è¦æ¯”æœˆä»½æ›´ç²¾ç´°çš„åˆ†å€éµï¼Œéæ–¼ç²¾ç´°çš„åˆ†å€åè€Œæœƒé™ä½æ•ˆç‡ï¼Œä¾‹å¦‚ï¼šä¸å»ºè­°å°‡ id è¨­ç‚ºåˆ†å€éµï¼Œè€Œæ˜¯æ‡‰è©²é€é order by è¨­ç‚ºç¨€ç–ç´¢å¼•ã€‚\nç¯„ä¾‹ å»ºç«‹ä¸€å¼µåŒ…å«åˆ†å€è¨­å®šçš„è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 CREATE DATABASE test_db; CREATE TABLE test_db.test_table( id BIGINT NOT NULL, name String NOT NULL, date Datetime NOT NULL ) ENGINE = MergeTree PARTITION BY toYYYYMM(date) ORDER BY (id) SETTINGS index_granularity = 8192, index_granularity_bytes = 0; # æŸ¥çœ‹ test_table çš„åˆ†å€ç›®éŒ„ SELECT partition, name, active FROM system.parts WHERE table = \u0026#39;test_table\u0026#39; 0 rows in set. å› ç‚ºè¡¨æ‰å»ºç«‹é‚„æ²’æœ‰å¡å…¥æ•¸æ“šï¼Œå› æ­¤çœ‹ä¸åˆ°ä»»ä½•åˆ†å€ç›®éŒ„ï¼š\n1 2 3 âœ ~ ll /var/lib/clickhouse/data/test_db/test_table drwxr-x--- 2 clickhouse clickhouse 6 5æœˆ 13 10:53 detached -rw-r----- 1 clickhouse clickhouse 1 5æœˆ 13 10:53 format_version.txt å‘è¡¨ä¸­æ’å…¥æ–°æ•¸æ“šæ™‚ï¼ŒåŒä¸€æ‰¹æ¬¡çš„æ–°æ•¸æ“šæœƒè¢«å„²å­˜åœ¨å–®ç¨çš„åˆ†å€ç›®éŒ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 INSERT INTO test_db.test_table VALUES (1,\u0026#39;test1\u0026#39;,\u0026#39;2022-09-01 00:00:00\u0026#39;), (2,\u0026#39;test2\u0026#39;,\u0026#39;2022-10-01 00:00:00\u0026#39;), (3,\u0026#39;test3\u0026#39;,\u0026#39;2022-09-01 00:00:00\u0026#39;); # æŸ¥çœ‹ test_table çš„åˆ†å€ç›®éŒ„ SELECT partition, name, active FROM system.parts WHERE table = \u0026#39;test_table\u0026#39; â”Œâ”€partitionâ”€â”¬â”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€activeâ”€â” â”‚ 202209 â”‚ 202209_1_1_0 â”‚ 1 â”‚ â”‚ 202210 â”‚ 202210_2_2_0 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ INSERT INTO test_db.test_table VALUES (4,\u0026#39;test4\u0026#39;,\u0026#39;2022-08-01 00:00:00\u0026#39;), (5,\u0026#39;test5\u0026#39;,\u0026#39;2022-09-01 00:00:00\u0026#39;), (6,\u0026#39;test6\u0026#39;,\u0026#39;2022-11-01 00:00:00\u0026#39;); # æŸ¥çœ‹ test_table çš„åˆ†å€ç›®éŒ„ â”Œâ”€partitionâ”€â”¬â”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€activeâ”€â” â”‚ 202208 â”‚ 202208_3_3_0 â”‚ 1 â”‚ â”‚ 202209 â”‚ 202209_1_1_0 â”‚ 1 â”‚ â”‚ 202209 â”‚ 202209_4_4_0 â”‚ 1 â”‚ â”‚ 202210 â”‚ 202210_2_2_0 â”‚ 1 â”‚ â”‚ 202211 â”‚ 202211_5_5_0 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 âœ ~ ll /var/lib/clickhouse/data/test_db/test_table # åŒ…å« id = 1ã€3 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202209_1_1_0 # åŒ…å« id = 2 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202210_2_2_0 # åŒ…å« id = 4 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202208_3_3_0 # åŒ…å« id = 5 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202209_4_4_0 # åŒ…å« id = 6 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202211_5_5_0 drwxr-x--- 2 clickhouse clickhouse 6 5æœˆ 13 10:53 detached -rw-r----- 1 clickhouse clickhouse 1 5æœˆ 13 10:53 format_version.txt éš¨å¾Œç¶“éç´„ 10~15 åˆ†é˜å¾Œ (æˆ–è€…æ˜¯ä½¿ç”¨ OPTIMIZE TABLE) åŒä¸€åˆ†å€çš„è³‡æ–™æœƒåˆä½µåˆ°ä¸€å€‹æ–°çš„åˆ†å€ç›®éŒ„ï¼Œä¸¦ä¸”èˆŠçš„åˆ†å€ç›®éŒ„å…¶ active æœƒè¢«è¨­ç‚º 0 ä¸å†ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 âœ ~ ll /var/lib/clickhouse/data/test_db/test_table # åŒ…å« id = 1ã€3 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 0 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202209_1_1_0 # åŒ…å« id = 2 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202210_2_2_0 # åŒ…å« id = 4 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202208_3_3_0 # åŒ…å« id = 5 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 0 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202209_4_4_0 # åŒ…å« id = 6 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202211_5_5_0 # åŒ…å« id = 1ã€3ã€5 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202209_1_4_1 drwxr-x--- 2 clickhouse clickhouse 6 5æœˆ 13 10:53 detached -rw-r----- 1 clickhouse clickhouse 1 5æœˆ 13 10:53 format_version.txt â”Œâ”€partitionâ”€â”¬â”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€activeâ”€â” â”‚ 202208 â”‚ 202208_3_3_0 â”‚ 1 â”‚ â”‚ 202209 â”‚ 202209_1_1_0 â”‚ 0 â”‚ â”‚ 202209 â”‚ 202209_1_4_1 â”‚ 1 â”‚ â”‚ 202209 â”‚ 202209_4_4_0 â”‚ 0 â”‚ â”‚ 202210 â”‚ 202210_2_2_0 â”‚ 1 â”‚ â”‚ 202211 â”‚ 202211_5_5_0 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ éš¨å¾Œç¶“éç´„ 10 åˆ†é˜å¾Œï¼Œactive = 0 çš„åˆ†å€ç›®éŒ„æœƒè¢«åˆªé™¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 âœ ~ ll /var/lib/clickhouse/data/test_db/test_table # åŒ…å« id = 1ã€3ã€5 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202209_1_4_1 # åŒ…å« id = 2 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202210_2_2_0 # åŒ…å« id = 4 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202208_3_3_0 # åŒ…å« id = 6 çš„è³‡æ–™ï¼Œæ­¤ç›®éŒ„ active = 1 drwxr-x--- 2 clickhouse clickhouse 4096 9æœˆ 20 14:47 202211_5_5_0 drwxr-x--- 2 clickhouse clickhouse 6 5æœˆ 13 10:53 detached -rw-r----- 1 clickhouse clickhouse 1 5æœˆ 13 10:53 format_version.txt åˆ†å€ç›®éŒ„çš„å‘½åè¦å‰‡ PartitionIDï¼šåˆ†å€IDï¼Œç‚ºä¾ç…§åˆ†å€éµè¨ˆç®—çš„çµæœã€‚\nMinBlockNumã€MaxBlockNumï¼š\nBlockNum æ˜¯ä¸€å€‹ä»¥è¡¨ç‚ºå–®ä½çš„è‡ªå¢å€¼ï¼Œæ¯ç•¶æ–°å»ºä¸€å€‹åˆ†å€ç›®éŒ„æ™‚ BlockNum å°±æœƒå¢é•·ã€‚\nå› æ­¤ Minã€Max çš„ BlockNum å°±è¡¨ç¤ºè©²åˆ†å€ç›®éŒ„æ‰€åŒ…å«çš„æœ€å°å’Œæœ€å¤§ BlockNumã€‚\nå°æ–¼ä¸€å€‹æ–°å»ºçš„åˆ†å€ç›®éŒ„ Minã€Max BlockNum æœƒæ˜¯ç›¸ç­‰çš„ï¼š\n1 2 3 4 âœ ~ ll /var/lib/clickhouse/data/test_db/test_table 20220920_1_1_0 20220921_2_2_0 20220920_3_3_0 åˆ†å€åˆä½µæ™‚æ‰æœƒç™¼ç”Ÿåˆ†å€ç›®éŒ„çš„ Minã€Max BlockNum ä¸ç›¸åŒï¼š\n1 2 3 4 5 âœ ~ ll /var/lib/clickhouse/data/test_db/test_table 20220920_1_3_1 20220921_2_2_0 # åŸæœ¬çš„åˆ†å€ç›®éŒ„ 20220920_1_1_0ã€20220920_3_3_0 å› ç‚º PartitionID ç›¸åŒï¼Œå› æ­¤å¯ä»¥é€²è¡Œåˆä½µï¼Œåˆä½µä¹‹å¾Œ 20220920 çš„ MinBlockNum = 1, MaxBlockNum = 3 Levelï¼šåˆ†å€åˆä½µçš„æ¬¡æ•¸ï¼Œå°æ–¼æ¯ä¸€å€‹ PartitionID æ‰€å±¬çš„åˆ†å€ç›®éŒ„å…¶èµ·å§‹å€¼ç‚º 0ã€‚\nåˆ†å€ç›®éŒ„çš„åˆä½µéç¨‹ åƒè€ƒ Custom Partitioning Key | ClickHouse Docs\nClickHouseè¡¨å¼•æ“ 1.MergeTree å»ºè¡¨æ–¹å¼ä¸åˆ†åŒºè§„åˆ™ | hnbian\nhttps://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup32/æœ±å‡¯.ppt\n","date":"2024-10-15T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-partition/","title":"ClickHouse Partition"},{"content":"å„²å­˜çµæ§‹ partition dir è¡¨å…§çš„å¯¦é«”æª”æœƒä¾ç…§æ‰€å±¬çš„ partition æ”¾åˆ°å°æ‡‰çš„ partition ç›®éŒ„ä¸‹ã€‚\nchecksums.txt äºŒé€²åˆ¶æ ¼å¼çš„æ ¡é©—æ–‡ä»¶ï¼Œå„²å­˜äº†è©²ç›®éŒ„ä¸‹å…¶ä»–æ–‡ä»¶çš„ size å¤§å°åŠ Hash å€¼ï¼Œç”¨ä¾†å¿«é€Ÿæ ¡é©—æ–‡ä»¶çš„å®Œæ•´æ€§å’Œæ­£ç¢ºæ€§ã€‚\ncolumns.txt ç´€éŒ„ Table çš„æ¬„ä½è³‡è¨Šï¼Œç‚ºç›´æ¥ä½¿ç”¨æ˜æ–‡ç´€éŒ„ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 âœ ~ cat columns.txt columns format version: 1 3 columns: `UserID` UInt32 `URL` String `EventTime` DateTime count.txt ä»¥æ˜æ–‡ç´€éŒ„è©² partition ä¸‹çš„è³‡æ–™ç¸½ç­†æ•¸ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 âœ ~ count.txt 1112526 primary.idx äºŒé€²åˆ¶æ ¼å¼å„²å­˜ Sparse Primary Indexes æ–‡ä»¶ã€‚\n[column].bin äºŒé€²åˆ¶æ•¸æ“šæ–‡ä»¶ï¼Œå„²å­˜è©²æ¬„ä½çš„æ‰€æœ‰æ•¸æ“šï¼Œé»˜èªä½¿ç”¨ LZ4 å£“ç¸®æ ¼å¼ã€‚\nç”±æ–¼ clickhouse æ˜¯ column-oriented çš„è³‡æ–™åº«ï¼Œå› æ­¤æ¯å€‹ column éƒ½æœ‰ä¸€å€‹ç¨ç«‹çš„ .bin æ•¸æ“šæ–‡ä»¶ï¼Œå„è‡ªç´€éŒ„å±¬æ–¼è©² column çš„æ‰€æœ‰æ•¸æ“šã€‚\n[column].mrk äºŒé€²åˆ¶æ¨™è¨˜æ–‡ä»¶ï¼Œç´€éŒ„ primary,idx å’Œ [column].bin ä¹‹é–“çš„æ˜ å°„é—œä¿‚ã€‚\n[column].mrk2 å¦‚æœä½¿ç”¨è‡ªé©æ‡‰å¤§å°ç´¢å¼•é¡†ç²’ (adaptive index granularity) å‰‡æ¨™è¨˜æ–‡ä»¶æœƒä»¥ .mrk2 å‘½åï¼Œå·¥ä½œåŸç†å’Œ mrk ç›¸åŒã€‚\npartition.datã€minmax_[column].idx å¦‚æœä½¿ç”¨äº† PARTITION BY åˆ†å€éµæ‰æœƒç”Ÿæˆï¼š\npartition.datï¼šäºŒé€²åˆ¶ç´€éŒ„ç•¶å‰ partition ä¸‹ partition_expr çš„å€¼ã€‚ minmax_[column].idxï¼šäºŒé€²åˆ¶ç´€éŒ„ç•¶å‰ partition ä¸‹åŸå§‹æ•¸æ“šçš„æœ€å°å’Œæœ€å¤§å€¼ã€‚ ä¾‹å¦‚ï¼šå‡è¨­ table ä¸Šå®šç¾© PARTITION BY toYear(${column})ï¼Œåœ¨è©² table ä¸Šæ­¤ column æœ‰ä»¥ä¸‹ 4 å€‹å€¼ï¼š 2022-01-01ã€2022-06-01ã€2022-12-20 å’Œ 2023-02-01ï¼Œå‰‡åœ¨2022 å¹´çš„ partition ç›®éŒ„ä¸‹\npartition.dat æœƒè¨˜éŒ„ 2022ã€‚ minmax_[column].idx æœƒè¨˜éŒ„ 2022-01-01ã€2022-12-20ã€‚ skp_idx_[column].idxã€skp_idx_[column].mrk å¦‚æœåœ¨è¡¨ä¸Šå®šç¾©äº† skipping index æ‰æœƒç”Ÿæˆï¼š\nidxï¼šäºŒé€²åˆ¶ skipping index æ–‡ä»¶ã€‚ mrkï¼šäºŒé€²åˆ¶æ¨™è¨˜æ–‡ä»¶ï¼Œç´€éŒ„ skp_idx_[column].idx å’Œ [column].bin ä¹‹é–“çš„æ˜ å°„é—œä¿‚ã€‚ åƒè€ƒ ClickHouseè¡¨å¼•æ“ 1.MergeTree å»ºè¡¨æ–¹å¼ä¸åˆ†åŒºè§„åˆ™ | hnbian\nClickhouseæŠ€æœ¯åˆ†äº«: åˆ†åŒºè£å‰ª | HuangZhaowei\u0026rsquo; Blog (saintbacchus.github.io)\næ·±å…¥æµ…å‡ºClickhouse: ç´¢å¼•ç»“æ„è®¾è®¡ | HuangZhaowei\u0026rsquo; Blog (saintbacchus.github.io)\n","date":"2024-10-13T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-storage-file/","title":"ClickHouse å„²å­˜çµæ§‹"},{"content":"Sparse Primary Indexes èªªæ˜ å‚³çµ±çš„ RDBMS è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•¸æ“šéƒ½æœ‰ä¸€å€‹ primary key ä¸¦ä¸”å„²å­˜ç‚º B+ Tree çš„è³‡æ–™çµæ§‹ï¼Œé€™æ¨£çš„è¨­è¨ˆä¸‹å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°ç‰¹å®š row çš„è³‡æ–™ï¼Œä½†ç›¸æ‡‰çš„éœ€è¦é¡å¤–çš„ diskã€memory é–‹éŠ·ã€‚\nClickHouse çš„ MergeTree å¼•æ“ç”¨ä¾†å„ªåŒ–è™•ç†å¤§é‡æ•¸æ“šï¼Œä¸¦ä¸”æ•¸æ“šæ˜¯è¢«ä¸€æ‰¹ä¸€æ‰¹çš„å¯«å…¥è¡¨ä¸­ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ diskã€memory æ•ˆç‡å¾ˆé‡è¦ï¼Œå› æ­¤ä¸æ˜¯ç‚ºæ¯ä¸€è¡Œæ•¸æ“šå»ºç«‹ primary keyï¼Œè€Œæ˜¯è¦ç‚ºä¸€çµ„æ•¸æ“š (ç¨±ç‚º granule) å»ºç«‹ä¸€å€‹ index entry (ç¨±ç‚º mark)ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ ClickHouse ä¸­ primary index æ˜¯å°æ‡‰å¤šç­†è³‡æ–™è€Œä¸æ˜¯å”¯ä¸€çš„è³‡æ–™ã€‚\nsparse primery index ä¸åƒåŸºæ–¼ B+ Tree çš„ç´¢å¼•å¯ä»¥ç›´æ¥å®šä½åˆ°ç‰¹å®šè¡Œï¼Œè€Œæ˜¯å¯ä»¥é€é binary search çš„æ–¹å¼å¿«é€Ÿæ‰¾åˆ°å¯èƒ½åŒ¹é…æŸ¥è©¢çš„ granule ä¸¦å‚³è¼¸åˆ° ClickHouse engine ä¾†æ‰¾åˆ°åŒ¹é…çš„çµæœã€‚\né€™ç¨® sparse primery index çš„è¨­è¨ˆï¼Œè®“ primary index è¶³å¤ å°å¯ä»¥æ”¾åˆ° memory ä¸­ï¼Œä¸¦ä¸”å°æ–¼ OLAP çš„ç¯„åœæŸ¥è©¢èƒ½æœ‰æ•ˆåŠ å¿«ã€‚\näº‹ä¾‹ schema 1 2 3 4 5 6 7 8 9 10 CREATE TABLE hits_UserID_URL ( `UserID` UInt32, `URL` String, `EventTime` DateTime ) ENGINE = MergeTree PRIMARY KEY (UserID, URL) ORDER BY (UserID, URL, EventTime) SETTINGS index_granularity = 8192, index_granularity_bytes = 0; schema èªªæ˜ï¼š\nORDER BY æ˜¯æ’åºéµ(sorting key)ï¼Œæ±ºå®š .bin ä¸­çš„æ–‡ä»¶å¦‚ä½•æ’åº PRIMARY KEY ç‚ºé¸å¡«çš„è¨­å®šï¼Œç”¨ä¾†ç”Ÿæˆ primary.idx çš„æª”æ¡ˆï¼Œå¿…é ˆæ˜¯ ORDER BY çš„å‰ç¶´ï¼Œå¦‚æœæ²’æœ‰è¨­å®šæœƒå°‡ PRIMARY KEY å®šç¾©ç‚ºæ’åºéµã€‚ é»˜èªæƒ…æ³ä¸‹ sorting key å’Œ primary key ç›¸åŒï¼Œä»¥ sorting key ç‚ºä¸»ï¼Œå› æ­¤å¤§å¤šæƒ…æ³ä¸‹ä¸éœ€è¦æŒ‡å®š primary keyï¼Œé€šå¸¸åªæœ‰ SummingMergeTree å’Œ AggregatingMergeTree å¼•æ“æ™‚ é¡¯å¼çš„è¨­ç½® PRIMARY KEY å’Œ ORDER BY ä¸åŒæ˜¯ç‚ºäº†é€²ä¸€æ­¥å„ªåŒ–ï¼Œä¾‹å¦‚ï¼šé‡å° WHERE A GROUP BY A, B, C çš„æŸ¥è©¢ä¸‹ï¼Œå¯ä»¥å»ºç«‹ä¸€å€‹è¡¨ PRIMARY KEY A ORDER BY A, B , Cã€‚ index_granularity é»˜èªå€¼ç‚º 8192ï¼Œæ„æ€æ˜¯æ¯ 8192 è¡Œè³‡æ–™ç‚ºä¸€çµ„æœƒæœ‰ä¸€å€‹ primary index entry index_granularity_bytesï¼š0 è¡¨ç¤ºç¦æ­¢ adaptive index granularityï¼Œå¦‚æœé–‹å•Ÿæ­¤è¨­å®šç•¶ç¬¦åˆä»¥ä¸‹æ¢ä»¶æ™‚æœƒè‡ªå‹•æœ€ä¸€çµ„ n è¡Œè³‡æ–™å‰µå»ºä¸€å€‹ primary index entryã€‚ n \u0026lt; 8192 (index_granularity)ï¼Œä½† n è¡Œæ•¸æ“šå¤§å° \u0026lt;= index_granularity_bytes(é è¨­å€¼ç‚º 10 MB) n é”åˆ° 8192 (index_granularity) æ’å…¥çš„è¡ŒæœƒæŒ‰ç…§ PRIMARY KEY æŒ‰é †åº (ascending å‡åº) å„²å­˜åœ¨ disk ä¸Šï¼ŒåŒæ™‚ ClickHouse å…è¨±æ’å…¥å…·æœ‰ç›¸åŒ PK çš„å¤šç­†è³‡æ–™ï¼Œç•¶ PK ç›¸åŒæ™‚å‰‡æœƒä¾ç…§æ’åºéµä¸­çš„ EventTime æ’åºï¼š\nClickHouse å°‡è¡¨ä¸­çš„è³‡æ–™åŠƒåˆ†ç‚ºå¤šå€‹ granuleï¼Œgranule æ˜¯ ClickHouse é€²è¡Œæ•¸æ“šè™•ç†çš„æœ€å°å–®ä½ï¼Œä¹Ÿå°±æ˜¯èªª ClickHouse ä¸æ˜¯è®€å–å–®ç¨è¡Œï¼Œè€Œæ˜¯ç¸½æ˜¯è®€å–æ•´å€‹ granule ã€‚æ­¤ä¾‹ä¸­ index_granularity = 8192ï¼Œå› æ­¤æ¯ 8192 è¡Œç‚ºä¸€å€‹ granuleï¼š\nå¦å¤–å¯ä»¥çœ‹åˆ°ä¸Šåœ–ä¸­æœ‰æ©˜è‰²çš„å­—ï¼Œé€™äº›è¡¨ç¤ºè©² column åœ¨è©² granule ä¸­çš„æœ€å°å€¼ï¼Œä¸éæœ€å¾Œä¸€å€‹ granule ä¸­å‰‡æ˜¯æœƒæœ€å¤§å€¼ï¼š\nç¬¬ä¸€å€‹ index entry (ä¸‹åœ–ä¸­çš„ mark 0) å„²å­˜ granule 0 ä¸­çš„æœ€å°å€¼ ç¬¬äºŒå€‹ index entry (ä¸‹åœ–ä¸­çš„ mark 1) å„²å­˜ granule 1 ä¸­çš„æœ€å°å€¼ ä»¥æ­¤é¡æ¨â€¦â€¦ æœ€å¾Œä¸€å€‹ index entry (ä¸‹åœ–ä¸­çš„ mark 1082) å„²å­˜ granule 1082 ä¸­çš„æœ€å¤§å€¼ é€™äº›æ¯å€‹ column åœ¨æ¯å€‹ granule ä¸­çš„æœ€å°å€¼(æœ€å¾Œä¸€å€‹ç‚ºæœ€å¤§å€¼) æœƒè¢«å¯«å…¥åˆ° primary.idx æª”æ¡ˆä¸­ï¼š\næ³¨æ„å› ç‚ºæ˜¯å°‡æ¯å€‹ column åœ¨æ¯å€‹ granule ä¸­çš„æ¥µå€¼æŒ‘å‡ºä¾†ï¼Œæ‰€ä»¥ä¸Šä¾‹ä¸­çš„ mark 0 çš„ UserIDã€URL çš„å€¼æ˜¯ä¾†è‡ªåŒä¸€å€‹ granule ä¸­çš„ä¸åŒè¡Œã€‚\nğŸ’¡ primary.idx æ­¤æ–‡ä»¶æœƒè¢«å®Œå…¨è¢« loading åˆ°å…§å­˜ä¸­ï¼Œå¦‚æœæ–‡ä»¶å¤§æ–¼å¯ç”¨çš„å…§å­˜ç©ºé–“ï¼Œå‰‡ ClickHouse å°‡å¼•ç™¼éŒ¯èª¤ã€‚\næŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 SELECT URL, count(URL) AS Count FROM hits_UserID_URL WHERE UserID = 749927693 GROUP BY URL ORDER BY Count DESC LIMIT 10; 10 rows in set. Elapsed: 0.005 sec. Processed 8.19 thousand rows, 740.18 KB (1.53 million rows/s., 138.59 MB/s.) ä¸Šä¾‹æŸ¥è©¢ä¸­æˆ‘å€‘éœ€è¦æ‰¾åˆ° UserID = 749927693 çš„è³‡æ–™ï¼Œé¦–å…ˆæˆ‘å€‘é€é primary.idx æ‰¾åˆ° UserID = 749927693 çš„å€¼ä»‹æ–¼ index mark 176 çš„ 747148242 ä¹‹å¾Œ mark 177 çš„ 751802947 ä¹‹å‰ï¼Œå› æ­¤åªéœ€è¦å–å‡º mark 176 å°æ‡‰çš„ granuleï¼š\næ¥è‘—éœ€è¦ mark 176 ä¸­å°æ‡‰çš„ granule ä¸­çš„ 8192 è¡Œè³‡æ–™è®€å–åˆ° ClickHouseï¼Œå› æ­¤éœ€è¦çŸ¥é“ granule 176 ç‰©ç†ä½ç½®ï¼Œæ¯å€‹ granule çš„ç‰©ç†ä½ç½®è¢«å„²å­˜åœ¨ æ¬„ä½.mrk çš„æ–‡ä»¶ä¸­ï¼š\nå¦‚ä¸Šåœ–æ‰€ç¤º æ¬„ä½.mrk æ–‡ä»¶ä¸­æœƒè¨˜éŒ„æ¯å€‹ granule æ‰€åœ¨çš„ç‰©ç†ä½ç½®ï¼Œä¹Ÿå°±æ˜¯åœ¨ æ¬„ä½.bin æ•¸æ“šæ–‡ä»¶ä¸­çš„ä½ç½®ï¼Œå…¶ä¸­æœ‰ 2 å€‹å…§å®¹ï¼š\nblock_offsetï¼šè¨˜éŒ„äº†æ‰€é¸ granule å£“ç¸®ç‰ˆæœ¬æ‰€åœ¨çš„å£“ç¸®æ•¸æ“šå¡Šã€‚\næ¯å€‹å£“ç¸®å¡Šå¯èƒ½åŒ…å«å¤šå€‹ granule (å£“ç¸®éçš„)ï¼Œè©²å£“ç¸®æ•¸æ“šå¡Šåœ¨è®€å–æ™‚è¢«è§£å£“ç¸®åˆ°å…§å­˜ä¸­ã€‚\ngranule_offsetï¼šè¨˜éŒ„äº† granule åœ¨è§£å£“ç¸®å¾Œæ•¸æ“šå¡Šçš„ä½ç½®ã€‚\nä¸Šåœ–é¡¯ç¤ºäº† ClickHouse é€é UserID.mrk å®šä½åˆ° UserID.bin æ•¸æ“šæ–‡ä»¶ä¸­åŒ…å«ç¬¦åˆæŸ¥è©¢æ¢ä»¶ granule çš„éç¨‹ï¼ŒåŒæ™‚ ClickHouse ä¹Ÿæœƒå° URL æ¬„ä½åŸ·è¡Œç›¸åŒçš„å‹•ä½œï¼Œéš¨å¾Œé€™ 2 å€‹ä¸åŒçš„ granule æœƒè¢«å°é½Šå€åŠ è¼‰åˆ° ClickHouse å¼•æ“é€²è¡Œé€²ä¸€æ­¥è™•ç†ï¼Œä¹Ÿå°±æ˜¯ Aggrigation æ“ä½œã€‚\néæœ€å·¦å‰ç¶´æ¬„ä½çš„æŸ¥è©¢ ä¸Šé¢æˆ‘å€‘çœ‹åˆ°æ˜¯ç”¨è¤‡åˆä¸»éµçš„ç¬¬ä¸€å€‹æ¬„ä½ UserID é€²è¡Œéæ¿¾ï¼Œä½†æ˜¯å°±åƒ MySQL ç´¢å¼•æœ‰æœ€å·¦å‰ç¶´åŸå‰‡ä¸€æ¨£ï¼ŒPK(UserID, URL) å¯ä»¥æ˜é¡¯åŠ å¿«ä»¥ UserID ç‚ºæ¢ä»¶çš„éæ¿¾ï¼Œä½†æ˜¯å–®ç´”ä»¥ URL ç‚ºæ¢ä»¶çš„æŸ¥è©¢å»ä¸¦æ²’æœ‰ä»€éº¼å¹«åŠ©ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯å…ˆ UserID æ’åºå†ä»¥ URL æ’åºï¼Œä¹Ÿå°±æ˜¯èªªé›–ç„¶ UserID æ˜¯æ‰€æœ‰ granule ä»¥å°æ’åˆ°å¤§ï¼Œä½†æ˜¯ URL å»åªæœ‰åœ¨å…¶ granule å…§ä¸­æ’åºã€‚\n1 2 3 4 5 6 7 8 9 10 SELECT UserID, count(UserID) AS Count FROM hits_UserID_URL WHERE URL = \u0026#39;http://public_search\u0026#39; GROUP BY UserID ORDER BY Count DESC LIMIT 10; 10 rows in set. Elapsed: 0.086 sec. Processed 8.81 million rows, 799.69 MB (102.11 million rows/s., 9.27 GB/s.) 1 2 3 4 5 6 7 8 -- trace log ...Executor): Key condition: (column 1 in [\u0026#39;http://public_search\u0026#39;, \u0026#39;http://public_search\u0026#39;]) ...Executor): Used generic exclusion search over index for part all_1_9_2 with 1537 steps ...Executor): Selected 1/1 parts by partition key, 1 parts by primary key, 1076/1083 marks by primary key, 1076 marks to read from 5 ranges ...Executor): Reading approx. 8814592 rows with 10 streams å¦‚ä¸Šæ‰€ç¤ºå¯ä»¥çœ‹åˆ°è©²æŸ¥è©¢åŸ·è¡Œæ™‚ 1083 å€‹ granule å…¶ä¸­æœ‰ 1076 å€‹ granule è¢«é¸ä¸­\nGeneric exclusion search algorithm ç•¶æŸ¥è©¢è¤‡åˆä¸»éµçš„ä¸€éƒ¨åˆ†çš„ column (ä½†ä¸æ˜¯ç¬¬ä¸€å€‹ column)ï¼ŒClickHouse æœƒä½¿ç”¨ Generic exclusion search æ¼”ç®—æ³•è€Œä¸æ˜¯ç”¨ binary search æ¼”ç®—æ³•ï¼Œä½†æ˜¯æ­¤ç®—æ³•åƒ…åœ¨å‰ç¶´ç´¢å¼• cardinality è¼ƒä½æ™‚æ‰è¼ƒæœ‰æ•ˆæœï¼Œè®“æˆ‘å€‘ä¾†çœ‹çœ‹ä¸åŒ cardiality çš„å‰ç¶´ç´¢å¼•çš„æƒ…å¢ƒï¼š\nå‰ç¶´ä¸»éµä½ cardinality\nå‡è¨­ UserID çš„ cardinality è¼ƒä½æ™‚ï¼Œç›¸åŒçš„ UserID å€¼å¯èƒ½åˆ†å¸ƒåœ¨å¤šå€‹ granule ä¸­ï¼Œç›¸æ‡‰çš„ primary.idx å…§å¤šå€‹ index mark æœƒæœ‰å¤šå€‹ç›¸åŒçš„ UserID å€¼ï¼Œé€™åŒæ™‚ä¹Ÿæ„å‘³è‘—é€™äº› index mark ä¸­çš„ URL ä¹ŸæœƒæŒ‰é †åºæ’åºï¼š\nmark 0 çš„ URL æœ€å°å€¼ç‚º W1 å°æ–¼ç›®æ¨™ W3ï¼Œæ¥è‘— mark 1ã€2 çš„ UserID éƒ½å’Œ mark 0 ä¸€æ¨£æ˜¯ U1ï¼Œä¸” mark 1 çš„ URL æœ€å°å€¼ç‚º W2 å°æ–¼ç›®æ¨™ W3ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ’é™¤ mark 0 çš„ granuleã€‚ mark 1 çš„ URL å€¼ W2 â‰¤ W3ï¼Œä¸” mark 2 çš„ URL å€¼ W4 â‰¥ W3ï¼Œå› æ­¤é¸æ“‡ mark 1 çš„ granuleã€‚ mark 2ã€3 çš„ UserId ä¹Ÿæ˜¯ U1ï¼Œä¸” URL å€¼ W4ã€W5 \u0026gt; W3ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ’é™¤ mark 2ã€3 çš„ granuleã€‚ å‰ç¶´ä¸»éµé«˜ cardinality\nå‡è¨­ UserID çš„ cardinality è¼ƒé«˜æ™‚ï¼Œç›¸åŒçš„ UserID å€¼ä¸å¤ªå¯èƒ½åˆ†å¸ƒåœ¨å¤šå€‹ granule ä¸­ï¼Œé€™åŒæ™‚æ„å‘³è‘— primary.idx å…§çš„ URL ä¸æœƒå–®ç´”æŒ‰é †åºæ’åºï¼š\nmark 0 çš„ URL æœ€å°å€¼ç‚º W1 å°æ–¼ç›®æ¨™ W3ï¼Œé›–ç„¶ mark 1 çš„ UserID å’Œ mark 0 ä¸€æ¨£ï¼Œä½†æ˜¯å› ç‚º mark 2 çš„ UserID ä¸ä¸€æ¨£ï¼Œå› æ­¤ç„¡æ³•ä¿è­‰ granule 1 åªåŒ…å« U1 çš„æ•¸æ“šï¼Œå°æ‡‰çš„ä¹Ÿä¸èƒ½ä¿è­‰ mark 1 çš„ W2 æ˜¯è·Ÿ U1 åŒä¸€è¡Œçš„è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯å°ç„¡æ³•æ’é™¤ granule 0 çš„æ•¸æ“šæ²’æœ‰åŒ…å« W3 çš„è³‡æ–™ï¼Œå› æ­¤å¿…é ˆé¸æ“‡ mark 0 å°æ‡‰çš„ granule 0 ã€‚\nå…¶ä¸­ granule 1ã€2ã€3 ä¹Ÿå› ç‚ºä»¥ä¸Šçš„åŸå› ç„¡æ³•è¢«æ’é™¤ï¼Œéƒ½éœ€è¦è¢«æŒ‘é¸ä¸¦ loading åˆ° ClickHouse ä¸­ï¼Œå› æ­¤éæ¿¾çš„æ•ˆç‡éå¸¸å·®ã€‚\nä½¿ç”¨å¤šå€‹ primary index é€²è¡Œå„ªåŒ– å¦‚æœæˆ‘å€‘æƒ³åŒæ™‚åŠ å¿«ä¸‹è¿°å…©å¥èªæ³•ï¼š\n1 2 3 4 5 6 7 8 9 SELECT URL, count(URL) AS Count FROM hits_UserID_URL WHERE UserID = 749927693 GROUP BY URL ORDER BY Count DESC LIMIT 10; SELECT UserID, count(UserID) AS Count FROM hits_UserID_URL WHERE URL = \u0026#39;http://public_search\u0026#39; GROUP BY UserID ORDER BY Count DESC LIMIT 10; åˆ†åˆ¥é‡å° UserIDã€URL é€²è¡Œéæ¿¾ï¼Œå°±éœ€è¦ç”¨å¤šå€‹ primary index ä¾†é€²è¡Œå„ªåŒ–ï¼Œæˆ‘å€‘æœ‰ä»¥ä¸‹ä¸‰ç¨®æ–¹å¼ï¼š\næ–°å»ºä¸€å€‹æœ‰ä¸åŒä¸»éµçš„æ–°è¡¨\næ–°å¢ä¸€å€‹å…·æœ‰ä¸åŒ PRIMARY KEYã€ORDER BY ç›¸åŒæ¬„ä½çš„ tableï¼Œä¹‹å¾Œéœ€è¦è‡ªè¡ŒåŒæ­¥å…©å¼µè¡¨çš„è³‡æ–™ï¼Œä¸¦æ ¹æ“šæŸ¥è©¢æ¢ä»¶è‡ªè¡Œé¸æ“‡é©åˆçš„ tableï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nå¦‚ä¸‹ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE TABLE hits_URL_UserID( `UserID` UInt32, `URL` String, `EventTime` DateTime ) ENGINE = MergeTree PRIMARY KEY (URL, UserID) ORDER BY (URL, UserID, EventTime) SETTINGS index_granularity = 8192, index_granularity_bytes = 0; INSERT INTO hits_URL_UserID SELECT * from hits_UserID_URL; OPTIMIZE TABLE hits_URL_UserID FINAL; å‰µå»ºä¸€å€‹ materialized view\nåœ¨åŸè¡¨ä¸Šå‰µå»º materialized viewï¼Œé€™å€‹é¡å¤–çš„è¡¨æœƒè¢«éš±è—èµ·ä¾†ï¼Œæ•¸æ“šæœƒè‡ªå‹•åœ¨è¡¨ä¹‹é–“ä¿æŒåŒæ­¥ï¼Œä¹Ÿå°±æ˜¯èªªä»åªéœ€åœ¨åŸè¡¨å¯«å…¥è³‡æ–™ï¼Œä¸éœ€è¦åƒä¸Šä¸€å€‹æ–¹æ¡ˆè‡ªè¡Œå¯«å…¥æ–°çš„è¡¨ï¼Œä½†æŸ¥è©¢æ™‚éœ€è¦è‡ªè¡Œé¸æ“‡åˆé©çš„è¡¨ï¼Œä¸¦ä¸”ä¸æä¾›æ•¸æ“šä¸€è‡´æ€§ä¿è­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nå¦‚ä¸‹ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE MATERIALIZED VIEW mv_hits_URL_UserID ENGINE = MergeTree() PRIMARY KEY (URL, UserID) ORDER BY (URL, UserID, EventTime) -- POPULATE ç”¨ä¾†è¡¨ç¤ºå»ºç«‹ view å¾Œå°‡åŸè¡¨çš„è³‡æ–™åŒ¯å…¥ (è‹¥æœªæ·»åŠ å‰‡åªæœƒåŒæ­¥å»ºç«‹ view ä¹‹å¾Œæ’å…¥çš„è³‡æ–™) POPULATE AS SELECT * FROM hits_UserID_URL; SELECT UserID, count(UserID) AS Count FROM mv_hits_URL_UserID WHERE URL = \u0026#39;http://public_search\u0026#39; GROUP BY UserID ORDER BY Count DESC LIMIT 10; å»ºç«‹ä¹‹å¾Œçœ‹åˆ° view çš„æ•¸æ“šæ–‡ä»¶å¦‚ä¸‹ï¼š\nå°è©²è¡¨æ–°å¢ projection\nprojection æ˜¯æœ€é€æ˜çš„æ–¹æ¡ˆï¼Œå› ç‚ºé™¤äº†æœƒéš±è—é™„åŠ çš„è¡¨ï¼ŒClickHouse é‚„æœƒè‡ªå‹•é¸æ“‡æœ€æœ‰æ•ˆçš„è¡¨ç‰ˆæœ¬ä¾†æŸ¥è©¢ï¼Œä¸¦ä¸”é‚„ä¿è­‰æ•¸æ“šä¸€è‡´æ€§ï¼š\näº‹ä¾‹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 -- åœ¨åŸè¡¨ä¸Šå‰µå»º projection ALTER TABLE hits_UserID_URL ADD PROJECTION prj_url_userid ( SELECT * ORDER BY (URL, UserID) ); -- materialize projectionï¼Œç«‹å³å°‡æºè¡¨è³‡æ–™å°å…¥éš±è—è¡¨ ALTER TABLE hits_UserID_URL MATERIALIZE PROJECTION prj_url_userid; å»ºç«‹ä¹‹å¾Œæœƒçœ‹åˆ°åœ¨è©² table ä¸‹å¤šäº†ä¸€å€‹ç›®éŒ„ç´€éŒ„ prjection çš„ç›¸æ‡‰è³‡è¨Šï¼š\né€™ 3 å€‹æ–¹æ³•éƒ½æ˜¯æœƒæœ‰æ•ˆçš„æ•¸æ“šè¤‡è£½åˆ°å¦ä¸€å€‹è¡¨ä¸­ï¼Œä»¥ä¾¿é‡æ–°çµ„ç¹” table çš„ primary index å’Œæ’åºï¼Œå€åˆ¥åœ¨æ–¼å°æŸ¥è©¢å’Œä½¿ç”¨è€…çš„é€æ˜ç¨‹åº¦\nSkipping Indexes åœ¨å¤§å¤šæ•¸æƒ…å¢ƒä¸­å½±éŸ¿ ClickHouse æ•ˆèƒ½æœ€é—œéµçš„å› ç´ æ˜¯ WHERE å­å¥çš„æ¢ä»¶æ˜¯å¦å¯ä»¥ä½¿ç”¨ primary indexï¼Œä½†ä¸ç®¡æ€éº¼èª¿å„ª primary index é‚„æ˜¯ä¸å¯é¿å…çš„æœƒå‡ºç¾ä¸èƒ½æœ‰æ•ˆä½¿ç”¨çš„æ¡ˆä¾‹ã€‚\nåœ¨å¦‚ MySQL ç­‰å‚³çµ±æ•¸æ“šåº«ï¼Œè§£æ±ºæ–¹æ¡ˆæ˜¯æ·»åŠ å°æ‡‰çš„ secondary indexï¼Œä¸€å€‹ B+Tree çµæ§‹è®“æ™‚é–“è¤‡é›œåº¦ç”±å…¨è¡¨æƒæçš„ O(n) è®Šæˆ O(logn) çš„ç´¢å¼•æƒæã€‚\né€™ç¨®é¡å‹çš„ secondary index ä¸é©åˆ ClickHouse (æˆ–å…¶ä»– column-oriented æ•¸æ“šåº«)ï¼Œå› ç‚º disk ä¸Šæ•¸æ“šçš„ç´€éŒ„æ˜¯ä»¥ granule ç‚ºå–®ä½ï¼Œæ‰€ä»¥æ²’æœ‰å–®ç¨çš„è¡Œå¯ä»¥ç‚ºå…¶æ·»åŠ å–®ç¨çš„ indexã€‚ ç›¸æ‡‰çš„ ClickHouse æä¾›äº†ç¨±ç‚º skipping index ä¾†å¹«åŠ©è·³éæ²’æœ‰åŒ¹é…å€¼çš„ granuleã€‚\nskipping index æœ‰ä»¥ä¸‹ 4 å€‹åƒæ•¸ï¼š\nindex nameï¼šindex åç¨±ã€‚ index expressionï¼šè¨ˆç®—è¡¨é”æ˜¯ TYPEï¼šskipping index çš„é¡å‹ã€‚ GRANULARITYï¼šæ¯å€‹ index block åŒ…å«äº† N å€‹ granularityã€‚ä¾‹å¦‚ï¼š index_granularity ç‚º 8192ï¼ŒGRANULARITY ç‚º 4ï¼Œå‰‡æ¯å€‹ indexed block åŒ…å«äº† 8192*4 = 32768 è¡Œè³‡æ–™ã€‚ ç•¶å‰µå»º Skipping indexï¼Œè©²è¡¨çš„æ•¸æ“šç›®éŒ„ä¸­æœƒç”¢ç”Ÿä»¥ä¸‹ 2 å€‹æª”æ¡ˆï¼š\nskp*idx*{index_name}.idxï¼šå°‡ index expression çš„ values æ’åºå¾Œè¨˜éŒ„ä¸‹ä¾†ã€‚ skp*idx*{index_name}.mrk2ï¼šå°‡ index é—œé€£åˆ°çš„ column æ•¸æ“šæ–‡ä»¶æ‰€åœ¨çš„åç§»é‡ã€‚ Skipping index Type æ¯éš” index_granularity * GRANULARITY æ˜¯ä¸€å€‹ blockï¼Œskipping index æœƒä¾ç…§æ¯å€‹ block å…§ index expression ç”¢ç”Ÿçš„çµæœä¾†ç”Ÿæˆ indexã€‚\nSkipping index çš„ Type å…±åˆ†ç‚ºä»¥ä¸‹ 3 ç¨®ï¼š\nminmaxï¼šå„²å­˜æ¯å€‹ block ä¸­ index expression çš„ min/max å€¼ã€‚\nset(max_size)ï¼š å„²å­˜æ¯å€‹ block ä¸­ index expression çš„ä¸é‡è¤‡å€¼ã€‚\nå¦‚æœä¸é‡è¤‡å€¼çš„æ•¸é‡ \u0026gt; max_size æ™‚å‰‡ç‚ºç©ºï¼Œå¦‚æœ max_size = 0 å‰‡è¡¨ç¤ºä¸é™åˆ¶ã€‚\næ­¤é¡å‹é©åˆç”¨æ–¼æ¯å€‹ block ä¸­çš„ cardinality ä½ï¼Œä½†æ•´å€‹ column çš„ cardinality é«˜çš„æƒ…å¢ƒï¼Œè©²ç´¢å¼•æˆæœ¬å’Œæ€§èƒ½å–æ±ºæ–¼å–®å€‹ block çš„ cardinalityã€‚å¦‚æœæ¯å€‹ block åŒ…å«å¤§é‡å”¯ä¸€å€¼å‰‡æˆæœ¬å°‡ç›¸å°é«˜ï¼Œæˆ–è€…æ˜¯è¶…é max_size è€Œç‚ºç©ºå°è‡´ä¸ä½¿ç”¨æ­¤ index ã€‚\nBloom Filter Typesï¼šæ˜¯ä¸€ç¨®æ•¸æ“šçµæ§‹ï¼Œä»¥å°‘é‡çš„å½é™½æ€§ ( false positive) ç‚ºä»£åƒ¹èƒ½å¤ å° block é€²è¡Œé«˜æ•ˆçš„ space-efficient æ¸¬è©¦ã€‚\nåŸç†ç´°ç¯€\né€™é‚Šå…ˆé™„ä¸Šä¸€å€‹å¯ä»¥ç·šä¸Šæ¼”ç¤ºçš„ç¶²ç«™ï¼šBloom Filters by Example (llimllib.github.io)\nä¸€å€‹ç©ºçš„ bloom filter æ˜¯ä¸€å€‹ m bits çš„ bit arrayã€‚\nä¸‹åœ–æ˜¯ä¸€å€‹ 14 bits çš„ bloom filterï¼Œä¸‹é¢çš„æ•¸å­—è¡¨ç¤ºç´¢å¼•ï¼Œä¸Šé¢çš„ç™½è‰²å€å¡Šè¡¨ç¤ºå°šæœªæœ‰è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯ falseã€0ï¼š\nç•¶è¼¸å…¥ä¸€å€‹æ•¸æ“šæ™‚ï¼Œæœƒç¶“é k å€‹ hash functionï¼Œç”¢ç”Ÿ k å€‹çµæœä¸¦åœ¨å°æ‡‰çš„ index ä¸Šæ¨™ä¸Š trueã€1ã€‚\nä¸‹åœ–ä¸­ input äº† ee é€™å€‹å€¼ï¼Œç¶“é 2 å€‹ hash functionï¼šfnvã€murmurï¼Œå¾—å‡ºäº† 0ã€4 çš„çµæœï¼Œå› æ­¤åœ¨ 0ã€4 çš„ index æ¨™ä¸Šç¶ è‰²ï¼Œä¹Ÿå°±æ˜¯ trueã€1ï¼š\né€™æ™‚å€™ç•¶å†è¼¸å…¥ eee æ™‚ï¼Œ2 å€‹ hash function æœƒå¾—å‡º 7ã€11 å’ŒåŸæœ¬çš„ 0ã€4 æ²’æœ‰ä»»ä½•äº¤é›†ï¼Œå› æ­¤å¯ä»¥åˆ¤æ–· eee é‚„ä¸åœ¨é€™å€‹çµæœé›†å…§ï¼š\nä½†å¦‚æœé€™æ™‚å€™è¼¸å…¥ eeee æ™‚ï¼Œ2 å€‹ hash function æœƒå¾—å‡º 0ã€4 å’ŒåŸæœ¬çš„ 0ã€4 ä¸€æ¨£ï¼Œå› æ­¤æˆ‘å€‘æœƒå¾—å‡º eeee å¯èƒ½æœ‰åœ¨çµæœé›†å…§ï¼Œä½†æ˜¯å¯¦éš›ä¸Šå»æ²’æœ‰ï¼Œé€™å°±æ˜¯ bloom filter çš„å½é™½æ€§ï¼š\nåœ¨ skipping index çš„ä½¿ç”¨å ´æ™¯å½é™½æ€§ ( false positive) ä¸æ˜¯ä»€éº¼å•é¡Œï¼Œå› ç‚ºå”¯ä¸€çš„ç¼ºé»æ˜¯å¤šè®€å–äº†ä¸€äº›ä¸å¿…è¦çš„ granuleï¼Œè€Œä¸”ä¹Ÿç¸½æ¯”è·³éæœ‰æ•ˆçš„ granule å¥½ã€‚\nå› ç‚º Bloom Filter å¯ä»¥æœ‰æ•ˆçš„è™•ç†å¤§é‡é›¢æ•£å€¼çš„æ¸¬è©¦ï¼Œæ‰€ä»¥ä»–å€‘æ›´é©åˆç”¨æ–¼å¯ä»¥ç”¢ç”Ÿå¤šå€‹æ¸¬è©¦å€¼çš„ index expressionï¼Œç‰¹åˆ¥æ˜¯é€é mapKeys æˆ– mapValues function ä¾†ç”¢ç”Ÿ arrayã€map ä¾†é€²è¡Œå¤šå€¼çš„ space-efficient æ¸¬è©¦ã€‚\nåŸºæ–¼ Bloom Filter çš„ skipping index åˆç´°åˆ†ç‚º 3 ç¨®ï¼š åŸºæœ¬çš„bloom_filter\næ”¯æŒçš„æ•¸æ“šå‹æ…‹ï¼šInt*, UInt*, Float*, Enum, Date, DateTime, String, FixedString, Array, LowCardinality, Nullableã€‚\næœƒä½¿ç”¨åˆ°è©²ç´¢å¼•çš„ Functionï¼šequals, notEquals, in, notin, hasã€‚\næœ‰ä¸€å€‹å¯é¸çš„åƒæ•¸ false_positiveï¼šè©²åƒæ•¸è¡¨ç¤º 0~1 ä¹‹é–“å…è¨±çš„å‡é™½æ€§ç‡ï¼Œé è¨­ç‚º .025ã€‚\ntokenbf_v1ï¼šå°å­—ç¬¦ä¸²åš tokenization å¾Œå„²å­˜ï¼Œé©åˆç”¨æ–¼ LIKEã€EQUALSã€inã€hasToke() ç­‰ç­‰é•·å­—ç¬¦ä¸²çš„æœç´¢ï¼Œæ¥å— Stringã€FixedStringã€Map å‹æ…‹çš„æ•¸æ“šã€‚æœƒå°‡index expression ä¾ç…§éå­—æ¯æ•¸å­—çš„å­—ç¬¦é€²è¡Œåˆ‡å‰²ï¼Œä¾‹å¦‚ï¼šThis is a full text searchï¼Œæœƒè¢«åˆ†å‰²ç‚º This is a full text search ã€‚\néœ€è¦ä»¥ä¸‹ 3 å€‹åƒæ•¸ï¼š\nsize_of_bloom_filter_in_bytesï¼šbloom filter çš„å¤§å°ï¼Œä»¥ byte ç‚ºå–®ä½ï¼Œä½¿ç”¨çš„è¶Šå¤§å¯ä»¥æ¸›å°‘å‡é™½æ€§ï¼Œä½†æœ‰æ›´é«˜çš„å­˜å„²æˆæœ¬ã€‚ number_of_hash_functionsï¼šä½¿ç”¨çš„ hash function çš„å€‹æ•¸ï¼Œä½¿ç”¨çš„è¶Šå¤šå¯ä»¥æ¸›å°‘å‡é™½æ€§ã€‚ random_seedï¼šhash function çš„éš¨æ©Ÿç¨®å­ ngrambf_v1**ï¼š**å’Œ tokenbf_v1 é¡ä¼¼ï¼Œä½†æ˜¯æ˜¯ç”¨ ngram ä¾†åˆ‡å‰²è€Œä¸æ˜¯éå­—æ¯æ•¸å­—çš„å­—ç¬¦ä¾†åˆ‡å‰²ï¼Œé©åˆç”¨æ–¼ä¸­æ–‡é€™é¡æ²’æœ‰ç”¨ç©ºæ ¼åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ n = 2ï¼Œæœƒå°‡ é€™æ˜¯æ¸¬è©¦ åˆ†å‰²ç‚º é€™æ˜¯ æ˜¯æ¸¬ æ¸¬è©¦ã€‚\næ¯” tokenbf_v1 å¤šä¸€å€‹åƒæ•¸ï¼Œéœ€è¦ä»¥ä¸‹ 4 å€‹åƒæ•¸ï¼š\nnï¼šngram çš„çŸ­èªé•·åº¦ã€‚ size_of_bloom_filter_in_bytes number_of_hash_functions random_seed Skipping index æ”¯æŒçš„ function Where å­å¥ä¸­çš„æ¢ä»¶å¯ä»¥åŒ…å«å°æŸå€‹ column é€²è¡Œé‹ç®—çš„å‡½æ•¸è¡¨é”å¼ï¼Œå‡å¦‚ column æ˜¯ index çš„ä¸€éƒ¨åˆ†ï¼ŒClickHouse æœƒåœ¨åŸ·è¡Œ function æ™‚å˜—è©¦ä½¿ç”¨ indexã€‚\nset type çš„ skipping index æ”¯æŒæ‰€æœ‰çš„ functionï¼Œå…¶ä»– index æ”¯æŒçš„ function å¦‚ä¸‹è¡¨æ‰€åˆ—ï¼š\nå¦‚æœ function çš„å¸¸é‡åƒæ•¸å°æ–¼ ngram å¤§å°å‰‡ä¸èƒ½ä½¿ç”¨ ngrambf_v1 é€²è¡ŒæŸ¥è©¢å„ªåŒ–ã€‚\nğŸ’¡ å› ç‚º bloom filter æœ‰å½é™½æ€§çš„ç‹€æ³ï¼Œå› æ­¤ bloom filter çš„ skipping index ä¸èƒ½ç”¨æ–¼çµæœè¿”å›ç‚º false çš„ functionï¼Œä¾‹å¦‚ï¼š èƒ½å„ªåŒ–çš„å ´æ™¯ï¼š s LIKE \u0026lsquo;%test%â€™ NOT s NOT LIKE \u0026lsquo;%test%â€™ s = 1 NOT s != 1 startsWith(s, â€˜testâ€™) ä¸èƒ½å„ªåŒ–çš„å ´æ™¯ï¼š NOT s LIKE \u0026lsquo;%test%â€™ s NOT LIKE \u0026lsquo;%test%â€™ NOT s = 1 S != 1 NOT startsWith(s, â€˜testâ€™)\nSkipping index çš„é…ç½® use_skip_indexes ( 0 | 1 )ï¼šé è¨­å€¼ç‚º 1ï¼Œå°æ–¼ä¸å¤ªå¯èƒ½å¾ Skipping index ç²ç›Šçš„æŸ¥è©¢å»ºè­°å¯ä»¥è¨­ç½®ç‚º 0 æ¸›å°‘ä¸å¿…è¦çš„æˆæœ¬ã€‚ force_data_skipping_indexes (ä»¥é€—è™Ÿåˆ†éš” skipping index çš„åç¨±)ï¼šå¼·è¿«æŸ¥è©¢ä½¿ç”¨æŒ‡å®šçš„ skipping indexï¼Œè‹¥æŒ‡å®šå¾Œä¸æœƒç”¨åˆ°åŠå€‹ skipping index å‰‡æœƒè¿”å›ç•°å¸¸ï¼Œé¿å…ç³Ÿç³•çš„æŸ¥è©¢è€—è²»æ©Ÿå™¨æ•ˆèƒ½ã€‚ æœ€ä½³å¯¦è¸ å‡è¨­æœ‰ä¸€å¼µè¡¨çš„ primary index æ˜¯ timestampï¼Œä¸¦ä¸”åœ¨ visitor_id æœ‰ä¸€å€‹ indexï¼Œä¸¦æœ‰ä»¥æŸ¥è©¢ï¼š\nSELECT timestamp, url FROM table WHERE visitor_id = 1001\nå°æ–¼é€™ç¨®æ•¸æ“šåˆ†å¸ƒèˆ‡ç›¸æ‡‰çš„æŸ¥è©¢ï¼Œå‚³çµ± RDBMS çš„ secondary index éå¸¸æœ‰æ•ˆï¼Œé€é secondary index èƒ½å¤ ç›´æ¥è®€å–é€™ 5 è¡Œæ•¸æ“šã€‚\nå°æ–¼ ClickHouse çš„ Skipping index æƒ…æ³å»ä¸åŒï¼Œç„¡æ³•æ˜¯å“ªä¸€ç¨® Type çš„ Skipping index éƒ½éœ€è¦å¾ 8192*4=32678 çš„å€¼éƒ½éœ€è¦æ¸¬è©¦ã€‚\nå¯ä»¥çœ‹åˆ°åœ¨ä»¥ä¸Šä¾‹å­ä¸­ Skipping index ä¸¦æ²’æœ‰æœ‰æ•ˆçš„æ•ˆæœï¼Œè¦æœ‰æ•ˆçš„ä½¿ç”¨ Skipping index æœ‰ä»¥ä¸‹æƒ…å¢ƒï¼š\næ¯å€‹ granule å¤šæ•¸çš„è³‡æ–™ç¬¦åˆæ¢ä»¶ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨è©² granule æœ‰ä½ cardinalityã€‚ ç¯„ä¾‹ï¼šå¦‚æœ primary key æ˜¯ä¸€å¤©ä¸­çš„æ™‚é–“ï¼Œå¦å¤–æœ‰ä¸€å€‹ column æ˜¯é›»è¦–è§€çœ¾å¹´é½¡ï¼Œå¾ˆæ˜é¡¯å…©è€…æ˜¯æœ‰ç›¸é—œæ€§çš„ï¼Œæ­¤æ™‚ minmax type çš„ Skipping index å¯èƒ½å°±å¾ˆæœ‰æ•ˆï¼Œå› ç‚ºåªæœ‰å°‘æ•¸çš„ granule æœƒè¢«é¸ä¸­ã€‚ åœ¨æ’å…¥æ•¸æ“šæ™‚å¯ä»¥å¢åŠ é€™ç¨®ç›¸é—œæ€§ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š åœ¨æ’åºéµ (order by) ä¸­æ·»åŠ æ­¤åˆ— Insert æ™‚å…ˆå°‡ Primary key èˆ‡è©²åˆ—åˆ†çµ„å¾Œåœ¨æ‰¹æ¬¡æ’å…¥ ç›¡å¯èƒ½æ¸›å°‘ granule è¢«é¸åˆ°ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨æ•´å€‹ table æœ‰é«˜ cardinalityã€‚ ç¯„ä¾‹ï¼šä¸€å€‹ API ä¸­å¾ˆå°‘è¦‹çš„ error codeï¼Œä½†å»ç‰¹åˆ¥é‡è¦éœ€è¦ç¶“å¸¸æœå°‹ï¼Œæ­¤æ™‚ set(max_size) type çš„ Skipping index å°±å¾ˆæœ‰æ•ˆï¼Œå› ç‚ºå¤§å¤š granule æœƒè¢«è·³éã€‚ å› æ­¤æ„åœ–é€éç°¡å–®æ·»åŠ  Skipping index ä¾†åŠ é€ŸæŸ¥è©¢çš„æ•ˆèƒ½æ˜¯ä¸æ­£ç¢ºçš„ï¼Œå»ºè­°å…ˆç ”ç©¶å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ï¼šä¿®æ”¹ primary indexã€ä½¿ç”¨ projectionsã€ä½¿ç”¨ materialized viewsï¼Œç ”ç©¶é€™äº›æ–¹æ³•ä¹‹å¾Œæ‰è€ƒæ…® Skipping indexï¼Œè€Œä¸”å’Œ secondary index ä¸åŒï¼ŒSkipping index çš„è¡Œç‚ºæ˜¯ä¸å®¹æ˜“é æ¸¬ï¼Œå› ç‚ºå’Œæ•¸æ“šçš„çœŸå¯¦åˆ†å¸ƒæƒ…æ³æ¯æ¯ç›¸é—œï¼Œä¸¦ä¸”å°‡ä»–å€‘æ·»åŠ åˆ°è¡¨ä¸­å°æ–¼ç„¡æ³•ä½¿ç”¨ç´¢å¼•çš„æŸ¥è©¢æœƒç”¢ç”Ÿå¾ˆå¤§çš„æˆæœ¬ï¼Œå› æ­¤å»ºè­°åœ¨çœŸå¯¦æ•¸æ“šä¸Šé€²è¡Œæ¸¬è©¦ã€‚\nåƒè€ƒ ClickHouseä¸»é”®ç´¢å¼•æœ€ä½³å®è·µ | ClickHouse Docs\nClickHouse Index Design | ClickHouse Docs\nã€ClickHouse æç®€æ•™ç¨‹-å›¾æ–‡è¯¦è§£åŸç†ç³»åˆ—ã€‘ClickHouse ä¸»é”®ç´¢å¼•çš„å­˜å‚¨ç»“æ„ä¸æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ– - ç®€ä¹¦ (jianshu.com)\nhttps://github.com/ClickHouse/ClickHouse/issues/5125\n","date":"2024-10-12T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-index/","title":"ClickHouse ç´¢å¼•"},{"content":"MergeTree è¡¨å¼•æ“\nSparse Primary Index Partition Data Replication Data Sampling Replacing MergeTree ç‰¹è‰²ï¼šåœ¨ merge æ™‚æœƒåˆªé™¤å…·æœ‰ç›¸åŒ sorting key çš„è³‡æ–™ã€‚\næ³¨æ„äº‹é …ï¼š\né‡è¤‡çš„åˆ¤æ–·æ˜¯ä¾ç…§ ORDER BY è€Œä¸æ˜¯ Primary key å› ç‚ºåªæœ‰åœ¨ merge æ™‚æœƒè§¸ç™¼ï¼Œå› æ­¤ä¸ä¿è­‰ä»»ä½•æ™‚åˆ»éƒ½æ²’æœ‰é‡è¤‡è³‡æ–™ã€‚ å› ç‚ºåªæœ‰åœ¨ merge æ™‚æœƒè§¸ç™¼ï¼Œå› æ­¤ä¸åŒ partition çš„è³‡æ–™ä¸æœƒå»é‡ã€‚ ç¼ºé»ï¼š\næƒ³è¦å¾—åˆ°æ­£ç¢ºçš„çµæœåªèƒ½é€é FINAL ä¿®é£¾ç¬¦ï¼Œæˆ–è€…æ‰‹å‹•åŸ·è¡Œ OPTIMIZE ä¾†è®“ TABLE è§¸ç™¼ Mergeï¼Œä¸è«–å“ªä¸€ç¨®éƒ½æ˜¯æ˜‚è²´çš„æ“ä½œã€‚ ä»¥ä¸‹ç‚ºå»ºç«‹ä¸€å€‹ ReplacingMergeTree çš„èªæ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... ) ENGINE = ReplacingMergeTree([ver]) [PARTITION BY expr] [ORDER BY expr] [PRIMARY KEY expr] [SAMPLE BY expr] [SETTINGS name=value, ...] ç›¸é—œåƒæ•¸ï¼š\nver - å¸¶æœ‰ç‰ˆæœ¬è™Ÿçš„æ¬„ä½ï¼Œå…è¨± UInt*ã€Dateã€DateTimeã€DateTime64 çš„æ¬„ä½ï¼Œå¯é¸åƒæ•¸ã€‚ è‹¥æœªæŒ‡å®š ver åœ¨ merge æ™‚ï¼ŒåŒæ¨£ sorting key çš„è³‡æ–™æœƒä¿ç•™æœ€å¾Œæ’å…¥çš„ä¸€ç­†ã€‚\nç•¶æŒ‡å®š ver åœ¨ merge æ™‚ï¼ŒåŒæ¨£ sorting key çš„è³‡æ–™æœƒä¿ç•™ ver æŒ‡å®šçš„æ¬„ä½æœ€é«˜çš„ä¸€ç­†ï¼Œå¦‚æœç›¸åŒå‰‡åŒæ¨£æ˜¯ä¿ç•™æœ€å¾Œæ’å…¥çš„ä¸€ç­†ã€‚\nç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 -- without ver - the last inserted \u0026#39;wins\u0026#39; CREATE TABLE replacing_test ( `key` Int64, `someCol` String, `eventTime` DateTime ) ENGINE = ReplacingMergeTree ORDER BY key; INSERT INTO replacing_test Values (1, \u0026#39;first\u0026#39;, \u0026#39;2020-01-01 01:01:01\u0026#39;); INSERT INTO replacing_test Values (1, \u0026#39;second\u0026#39;, \u0026#39;2020-01-01 00:00:00\u0026#39;); SELECT * FROM replacing_testFINAL; â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€eventTimeâ”€â” â”‚ 1 â”‚ second â”‚ 2020-01-01 00:00:00 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ -- with ver - the row with the biggest ver \u0026#39;wins\u0026#39; DROP TABLE replacing_test; CREATE TABLE replacing_test ( `key` Int64, `someCol` String, `eventTime` DateTime ) ENGINE = ReplacingMergeTree(eventTime) ORDER BY key; INSERT INTO replacing_test Values (1, \u0026#39;first\u0026#39;, \u0026#39;2020-01-01 01:01:01\u0026#39;); INSERT INTO replacing_test Values (1, \u0026#39;second\u0026#39;, \u0026#39;2020-01-01 00:00:00\u0026#39;); # é‚„æ²’è§¸ç™¼ mergeï¼Œå› æ­¤æ²’æœ‰ç™¼ç”Ÿåˆªé™¤ SELECT * FROM replacing_test; â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€eventTimeâ”€â” â”‚ 1 â”‚ second â”‚ 2020-01-01 00:00:00 â”‚ â”‚ 1 â”‚ first â”‚ 2020-01-01 01:01:01 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # ä½¿ç”¨ FINAL ä¿®é£¾ç¬¦ç›´æ¥æŸ¥åˆ°æœ€å¾Œçµæœ SELECT * FROM replacing_test FINAL; â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€eventTimeâ”€â” â”‚ 1 â”‚ first â”‚ 2020-01-01 01:01:01 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # ä½¿ç”¨ optimize table è§¸ç™¼åˆä½µå¾ŒæŸ¥è©¢ OPTIMIZE TABLE replacing_test; SELECT * FROM replacing_test; â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€eventTimeâ”€â” â”‚ 1 â”‚ first â”‚ 2020-01-01 01:01:01 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Summing MergeTree ç‰¹è‰²ï¼šåœ¨ merge æ™‚æœ‰ç›¸åŒ sorting key çš„è³‡æ–™æœƒé€²è¡Œåˆä½µï¼Œä¸¦ä¾è¨­å®šå°‡æŒ‡å®šæˆ–å…¨éƒ¨çš„æ•¸å€¼æ¬„ä½é€²è¡Œç›¸åŠ ï¼Œéå½™ç¸½çš„æ¬„ä½å‰‡åªæœƒä¿ç•™æœ€æ—©æ’å…¥çš„æ•¸æ“šã€‚\næ³¨æ„äº‹é …ï¼š\nåˆ¤æ–·æ˜¯ä¾ç…§ ORDER BY è€Œä¸æ˜¯ Primary key å› ç‚ºåªæœ‰åœ¨ merge æ™‚æœƒè§¸ç™¼ï¼Œå› æ­¤ä¸ä¿è­‰ä»»ä½•æ™‚åˆ»è³‡æ–™éƒ½å·²å½™æ•´å®Œç•¢ï¼Œå› æ­¤å»ºè­°æŸ¥è©¢æ™‚ä»èˆŠé¡¯ç¤ºæŒ‡å®š SUM()ã€GROUP BYã€‚ å› ç‚ºåªæœ‰åœ¨ merge æ™‚è§¸ç™¼ï¼Œå› æ­¤ä¸åŒ partition çš„è³‡æ–™ä¸æœƒåˆä½µã€‚ ä»¥ä¸‹ç‚ºå»ºç«‹ä¸€å€‹ SummingMergeTree çš„èªæ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... ) ENGINE = SummingMergeTree([columns]) [PARTITION BY expr] [ORDER BY expr] [SAMPLE BY expr] [SETTINGS name=value, ...] ç›¸é—œåƒæ•¸ï¼š\ncolumns - æŒ‡å®šè¦å½™ç¸½çš„æ¬„ä½åç¨±ï¼Œæ‰€é¸çš„æ¬„ä½å¿…é ˆç‚ºæ•¸å€¼å‹æ…‹ï¼Œä¸¦ä¸”ä¸å¯åœ¨ ORDER BY ä¸­ã€‚ç‚ºå¯é¸çš„åƒæ•¸ï¼Œå¦‚æœæœªæŒ‡å®šå‰‡æœƒåŠ ç¸½æ‰€æœ‰çš„é ORDER BY çš„æ•¸å€¼å‹æ…‹æ¬„ä½ã€‚ éå½™ç¸½çš„æ¬„ä½åªæœƒä¿ç•™æœ€æ—©æ’å…¥çš„æ•¸æ“šã€‚ ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 CREATE TABLE summtt ( key UInt32, value UInt32 ) ENGINE = SummingMergeTree() ORDER BY key INSERT INTO summtt Values(1,1),(1,2),(2,1) SELECT key, value FROM summtt â”Œâ”€keyâ”€â”¬â”€sum(value)â”€â” â”‚ 2 â”‚ 1 â”‚ â”‚ 1 â”‚ 3 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # é¿å…æœ‰é‚„æœª merge çš„è³‡æ–™ï¼Œå› æ­¤æ‡‰è©²ç¸½æ˜¯ä½¿ç”¨ sumã€group by é€²è¡ŒæŸ¥è©¢ SELECT key, sum(value) FROM summtt GROUP BY key â”Œâ”€keyâ”€â”¬â”€sum(value)â”€â” â”‚ 2 â”‚ 1 â”‚ â”‚ 1 â”‚ 3 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Aggregating MergeTree ç‰¹è‰²ï¼šåœ¨ merge æ™‚æœ‰ç›¸åŒ sorting key çš„è³‡æ–™æœƒé€²è¡Œåˆä½µï¼Œä¸¦æŒ‰ç…§é å…ˆå®šç¾©çš„æ¢ä»¶èšåˆè³‡æ–™ã€‚\næ³¨æ„äº‹é …ï¼š\nåˆ¤æ–·æ˜¯ä¾ç…§ ORDER BY è€Œä¸æ˜¯ Primary key å› ç‚ºåªæœ‰åœ¨ merge æ™‚æœƒè§¸ç™¼ï¼Œå› æ­¤ä¸ä¿è­‰ä»»ä½•æ™‚åˆ»è³‡æ–™éƒ½å·²å½™æ•´å®Œç•¢ï¼Œå› æ­¤å»ºè­°æŸ¥è©¢æ™‚ä»èˆŠé¡¯ç¤ºæŒ‡å®š SUM()ã€GROUP BYã€‚ å› ç‚ºåªæœ‰åœ¨ merge æ™‚è§¸ç™¼ï¼Œå› æ­¤ä¸åŒ partition çš„è³‡æ–™ä¸æœƒåˆä½µã€‚ ä»¥ä¸‹ç‚ºå»ºç«‹ä¸€å€‹ AggregatingMergeTree çš„èªæ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... ) ENGINE = AggregatingMergeTree() [PARTITION BY expr] [ORDER BY expr] [SAMPLE BY expr] [TTL expr] [SETTINGS name=value, ...] ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 -- å»ºè¡¨ CREATE TABLE db_merge.t_merge_agg ( `id` String, `city` String, `code` AggregateFunction(uniq,String), -- èšåˆå­—æ®µ ç­‰åŒæ–¼ UNIQ(code) `value` AggregateFunction(sum,UInt32), -- èšåˆå­—æ®µ ç­‰åŒæ–¼ SUM(value) `create_time` DateTime ) ENGINE = AggregatingMergeTree() partition by toYYYYMM(create_time) ORDER BY (id,city) -- å¯ä»¥è¦–ç‚º group by id,city primary key id; -- æ’å…¥æ•°æ® -- éœ€è¦ä½¿ç”¨ UNIQ() å°æ‡‰çš„ uniqState æ–¹æ³• å’Œ sum å°æ‡‰çš„ sumState æ–¹æ³•ï¼Œä¸¦ä½¿ç”¨ INSERT INTO SELECT ä¾†æ’å…¥ insert into table db_merge.t_merge_agg select \u0026#39;A01\u0026#39;,\u0026#39;shenzhen\u0026#39;,uniqState(\u0026#39;code1\u0026#39;),sumState(toUInt32(100)),\u0026#39;2021-06-04 15:27:22\u0026#39; union all select \u0026#39;A01\u0026#39;,\u0026#39;shenzhen\u0026#39;,uniqState(\u0026#39;code2\u0026#39;),sumState(toUInt32(200)),\u0026#39;2021-06-04 15:28:22\u0026#39;; -- æŸ¥è¯¢æ•°æ® -- éœ€è¦è°ƒç”¨ UNIQå¯¹åº”çš„ uniqMrege æ–¹æ³• å’Œ sum å¯¹åº”çš„ sumMerge æ–¹æ³• select id,city,uniqMerge(code),sumMerge(value) from db_merge.t_merge_agg group by id,city; â”Œâ”€idâ”€â”€â”¬â”€cityâ”€â”€â”€â”€â”€â”¬â”€uniqMerge(code)â”€â”¬â”€sumMerge(value)â”€â” â”‚ A01 â”‚ shenzhen â”‚ 2 â”‚ 300 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Collapsing MergeTree åŒ…å« collapsing(æ‘ºç–Š) é‚è¼¯çš„ MergeTreeï¼Œé€™åœ¨ merge æ™‚æœƒå°‡ sorting key ç›¸åŒçš„è³‡æ–™ä¾ç…§æ‘ºç–Šç®—æ³•å°‡æ•¸æ“šæŠ˜ç–Šï¼Œä»¥æ­¤æ¸›å°‘è³‡æ–™é‡æå‡å¾ŒçºŒçš„æŸ¥è©¢æ•ˆç‡ã€‚\nä»¥ä¸‹ç‚ºå»ºç«‹ä¸€å€‹ CollapsingMergeTree\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... ) ENGINE = CollapsingMergeTree(sign) [PARTITION BY expr] [ORDER BY expr] [SAMPLE BY expr] [SETTINGS name=value, ...] ç›¸é—œåƒæ•¸ï¼š\nsign - å‹æ…‹ç‚º Int8ï¼Œç”¨ä¾†è¡¨ç¤ºè©² row çš„ç‹€æ…‹ï¼š 1ï¼šè¡¨ç¤ºè©² row ï¼Œç¨±å…¶ç‚º state rowã€‚ -1ï¼šè¡¨ç¤ºè©² row ï¼Œç¨±å…¶ç‚º cancel rowã€‚ æ‘ºç–Šç®—æ³• ç•¶ CH åˆä½µæ•¸æ“šæ™‚ï¼Œæœƒå°‡å…·æœ‰ç›¸åŒ sorting key çš„è¡Œæ¸›å°‘åˆ°ä¸è¶…é 2 è¡Œï¼Œä¸€å€‹ state ä¸€å€‹ cancleï¼Œå…·é«”å¦‚ä½•ä¿ç•™å¦‚ä¸‹ï¼š\nå¦‚æœ state = cancel ä¸”æœ€å¾Œä¸€è¡Œæ˜¯ stateï¼Œå‰‡ä¿ç•™ç¬¬ä¸€ç­† cancel å’Œæœ€å¾Œä¸€ç­† state è¡Œã€‚ å¦‚æœ state \u0026gt; cancel ï¼Œå‰‡åªä¿ç•™æœ€å¾Œä¸€å€‹ state è¡Œã€‚ å¦‚æœ state \u0026lt; cancel ï¼Œå‰‡åªä¿ç•™ç¬¬ä¸€å€‹ cancel è¡Œã€‚ å…¶ä»–æƒ…æ³ï¼Œå‰‡ä¸ä¿ç•™ä»»ä½•è¡Œã€‚ ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 # å»ºç«‹ä¸€å€‹ CollapsingMergeTree table CREATE TABLE test_db.UAct ( UserID UInt64, PageViews UInt8, Duration UInt8, Sign Int8 ) ENGINE = CollapsingMergeTree(Sign) ORDER BY UserID # å¡å…¥æ•¸æ“š INSERT INTO test_db.UAct VALUES (4324182021466249494, 5, 146, 1); INSERT INTO test_db.UAct VALUES (4324182021466249494, 5, 146, -1),(4324182021466249494, 6, 185, 1); # æŸ¥è©¢ï¼Œå› ç‚ºé‚„æ²’è§¸ç™¼ merge SELECT * FROM test_db.UAct â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€UserIDâ”€â”¬â”€PageViewsâ”€â”¬â”€Durationâ”€â”¬â”€Signâ”€â” â”‚ 4324182021466249494 â”‚ 5 â”‚ 146 â”‚ -1 â”‚ â”‚ 4324182021466249494 â”‚ 6 â”‚ 185 â”‚ 1 â”‚ â”‚ 4324182021466249494 â”‚ 5 â”‚ 146 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ # å»ºè­°ä½¿ç”¨ä»¥ä¸‹æŸ¥è©¢ä¾†ç¢ºä¿æŸ¥å‡ºä¾†çš„æ•¸æ“šç¶“éæ‘ºç–Š SELECT UserID, sum(PageViews * Sign) AS PageViews, sum(Duration * Sign) AS Duration FROM test_db.UAct GROUP BY UserID HAVING sum(Sign) \u0026gt; 0 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€UserIDâ”€â”¬â”€PageViewsâ”€â”¬â”€Durationâ”€â” â”‚ 4324182021466249494 â”‚ 6 â”‚ 185 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # ä½¿ç”¨ Final ä¿®é£¾ç¬¦ï¼ŒæŸ¥çœ‹ merge å¾Œçš„çµæœ # æ³¨æ„ï¼šä¸å»ºè­°ä½¿ç”¨ï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ SELECT * FROM test_db.UAct FINAL â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€UserIDâ”€â”¬â”€PageViewsâ”€â”¬â”€Durationâ”€â”¬â”€Signâ”€â” â”‚ 4324182021466249494 â”‚ 6 â”‚ 185 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ # å¼·è¿« merge å¾ŒæŸ¥è©¢ optimize table test_db.UAct; SELECT * FROM test_db.UAct â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€UserIDâ”€â”¬â”€PageViewsâ”€â”¬â”€Durationâ”€â”¬â”€Signâ”€â” â”‚ 4324182021466249494 â”‚ 6 â”‚ 185 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ æ³¨æ„äº‹é … åŒæ¨£åªæœ‰ç›¸åŒåˆ†å€çš„è³‡æ–™æ‰æœƒåœ¨ merge æ™‚æ‘ºç–Š\nCollapsing MergeTree åš´æ ¼è¦æ±‚æ•¸æ“šæŒ‰ç…§å…ˆå¯«å…¥ sign = 1 å†å¯«å…¥ sign = -1 çš„é †åºï¼Œå¦å‰‡æ•¸æ“šç„¡æ³•æ‘ºç–Šï¼š\n1 2 3 4 5 6 7 8 9 10 INSERT INTO test_db.UAct VALUES (4324182021466249494, 5, 146, -1); INSERT INTO test_db.UAct VALUES (4324182021466249494, 5, 146, 1); optimize table test_db.UAct; SELECT * FROM test_db.UAct â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€UserIDâ”€â”¬â”€PageViewsâ”€â”¬â”€Durationâ”€â”¬â”€Signâ”€â” â”‚ 4324182021466249494 â”‚ 5 â”‚ 146 â”‚ -1 â”‚ â”‚ 4324182021466249494 â”‚ 5 â”‚ 146 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ å¦‚æœæ•¸æ“šæ˜¯å¤šç·šç¨‹å¯«å…¥å‰‡ä¸å¤ªå®¹æ˜“æ§åˆ¶é †åºï¼Œå› æ­¤ Collapsing MergeTree çš„æ‘ºç–Šæ©Ÿè‡´ç„¡æ³•é †åˆ©é‹ä½œï¼Œæ­¤æ™‚å¯ä»¥ä½¿ç”¨ CH æä¾›çš„ Versioned Collapsing MergeTree ä¾†è§£æ±ºã€‚\nVersioned Collapsing MergeTree ç”¨é€”å’Œ Collapsing MergeTree ç›¸åŒï¼Œä½†ä½¿ç”¨ä¸åŒçš„æŠ˜ç–Šç®—æ³•ï¼Œé€éè‡ªå®šç¾©çš„ç‰ˆæœ¬è™Ÿä¾†æ‘ºç–Šï¼Œå› æ­¤ä¸åƒ Collapsing MergeTree å—æ’å…¥é †åºçš„å½±éŸ¿ã€‚\nä»¥ä¸‹ç‚ºå»ºç«‹ä¸€å€‹ Versioned Collapsing MergeTree çš„èªæ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] ( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2], ... ) ENGINE = VersionedCollapsingMergeTree(sign, version) [PARTITION BY expr] [ORDER BY expr] [SAMPLE BY expr] [SETTINGS name=value, ...] ç›¸é—œåƒæ•¸ï¼š\nsign - å‹æ…‹ç‚º Int8ï¼Œç”¨ä¾†è¡¨ç¤ºè©² row çš„ç‹€æ…‹ï¼š 1ï¼šè¡¨ç¤ºè©² row ï¼Œç¨±å…¶ç‚º state rowã€‚ -1ï¼šè¡¨ç¤ºè©² row ï¼Œç¨±å…¶ç‚º cancel rowã€‚ version - å‹æ…‹ç‚º UInt* ï¼Œç”¨ä¾†æŒ‡å®šç‚ºç‰ˆæœ¬è™Ÿçš„æ¬„ä½ã€‚ ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 CREATE TABLE versioned_collapsing_test ( `key` Int64, `someCol` String, `sign` Int8, `version` UInt8 ) ENGINE = VersionedCollapsingMergeTree(sign,version) ORDER BY key; INSERT INTO versioned_collapsing_test VALUES (1, \u0026#39;first\u0026#39;, 1, 1); INSERT INTO versioned_collapsing_test VALUES (1, \u0026#39;second\u0026#39;, 1, 2); INSERT INTO versioned_collapsing_test VALUES (1, \u0026#39;first\u0026#39;, -1, 1); SELECT * FROM versioned_collapsing_test; â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€signâ”€â”¬â”€versionâ”€â” â”‚ 1 â”‚ first â”‚ 1 â”‚ 1 â”‚ â”‚ 1 â”‚ second â”‚ 1 â”‚ 2 â”‚ â”‚ 1 â”‚ first â”‚ -1 â”‚ 1 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # å»ºè­°ä½¿ç”¨ä»¥ä¸‹æŸ¥è©¢ä¾†ç¢ºä¿æŸ¥å‡ºä¾†çš„æ•¸æ“šç¶“éæ‘ºç–Š SELECT key, sum(someCol * Sign) AS someCol FROM versioned_collapsing_test GROUP BY key HAVING sum(Sign) \u0026gt; 0 â”Œâ”€keyâ”€â”¬â”€someColâ”€â” â”‚ 1 â”‚ second â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # ä½¿ç”¨ Final ä¿®é£¾ç¬¦ï¼ŒæŸ¥çœ‹ merge å¾Œçš„çµæœ # æ³¨æ„ï¼šä¸å»ºè­°ä½¿ç”¨ï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ SELECT * FROM versioned_collapsing_test FINAL â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€signâ”€â”¬â”€versionâ”€â” â”‚ 1 â”‚ second â”‚ 1 â”‚ 2 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # å¼·è¿« merge å¾ŒæŸ¥è©¢ optimize table versioned_collapsing_test; SELECT * FROM versioned_collapsing_test â”Œâ”€keyâ”€â”¬â”€someColâ”€â”¬â”€signâ”€â”¬â”€versionâ”€â” â”‚ 1 â”‚ second â”‚ 1 â”‚ 2 â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ³¨æ„äº‹é …\nClickhouse åˆä½µæ•¸æ“šæ™‚æœƒåˆªé™¤æ¯ä¸€å°å…·æœ‰ç›¸åŒ primary keyã€version ä»¥åŠä¸åŒ sign çš„æ•¸æ“šã€‚ Clickhouse æœƒéš±å¼çš„å°‡ version æ¬„ä½æ·»åŠ åˆ° primary keyã€‚ Graphite MergeTree ç”¨æ–¼ aggregating/averaging (rollup) Graphite æ•¸æ“šè€Œè¨­è¨ˆã€‚\nåƒè€ƒ MergeTree Engine Family | ClickHouse Docs\nClickHouse ä¸­æœ€é‡è¦çš„è¡¨å¼•æ“ï¼šMergeTree çš„æ·±åº¦åŸç†è§£æ - å¤æ˜åœ°ç›† - åšå®¢å›­ (cnblogs.com)\nClickHouseè¡¨å¼•æ“ 1.MergeTree å»ºè¡¨æ–¹å¼ä¸åˆ†åŒºè§„åˆ™ | hnbian\nClickHouseè¡¨å¼•æ“ 2.MergeTree ç´¢å¼•ä¸æ•°æ®å­˜å‚¨æ–¹å¼ | hnbian\nClickHouseè¡¨å¼•æ“ 5.MergeTree å®¶æ—å…¶å®ƒå¼•æ“ | hnbian\nMySQLåˆ°ClickHouseçš„é«˜é€Ÿå…¬è·¯-MaterializeMySQLå¼•æ“-äº‘ç¤¾åŒº-åä¸ºäº‘ (huaweicloud.com)\n","date":"2024-10-11T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-mergetree/","title":"ClickHouse MergeTree å¼•æ“"},{"content":"ClickHouse æ˜¯ä¸€å€‹ç”¨æ–¼ OLAP çš„åˆ—å¼ (column-oriented) è³‡æ–™åº«ã€‚\nrow-oriented èˆ‡ column-oriented è³‡æ–™åº«çš„æ¯”è¼ƒ ä»¥ MySQLã€Postgress é€™é¡å‚³çµ±è¡Œå¼ (row-oriented) è³‡æ–™åº«æœƒç”¨ä»¥ä¸‹æ–¹å¼å„²å­˜è³‡æ–™ï¼š\nåœ¨åŒä¸€è¡Œä¸­ (Row ç·¨è™Ÿç›¸åŒ) çš„è³‡æ–™åœ¨ç‰©ç†ä¸Šæ˜¯å„²å­˜åœ¨ä¸€èµ·çš„ã€‚\nClickHouse é€™é¡åˆ—å¼ (column-oriented) è³‡æ–™åº«å‰‡æ˜¯ä»¥å¦‚ä¸‹çš„æ–¹å¼å„²å­˜è³‡æ–™ï¼š\nåœ¨ä¸åŒåˆ—çš„å€¼æ˜¯åˆ†é–‹å„²å­˜çš„ï¼Œä¾†è‡ªåŒä¸€åˆ— ( column åç¨±ç›¸åŒ) çš„æ•¸æ“šå‰‡æ˜¯è¢«å„²å­˜å†ä¸€èµ·\nå¸¸è¦‹çš„åˆ—å¼æ•¸æ“šåº«æœ‰ï¼š Verticaã€ Paraccel (Actian Matrixï¼ŒAmazon Redshift)ã€ Sybase IQã€ Exasolã€ Infobrightã€ InfiniDBã€ MonetDB (VectorWiseï¼Œ Actian Vector)ã€ LucidDBã€ SAP HANAã€ Google Dremelã€ Google PowerDrillã€ Druidã€ kdb+ã€‚\nOLAP å ´æ™¯ç‰¹æ€§ ä»¥è®€è«‹æ±‚ç‚ºä¸» æ•¸æ“šä¸å¤ªæœƒä¸€æ¬¡åªæ–°å¢å–®å€‹ rowï¼Œé€šå¸¸éƒ½æ˜¯å¤§æ‰¹æ¬¡ (\u0026gt; 1000 row) çš„å¯«å…¥ æ–°å¢åˆ°è³‡æ–™åº«çš„æ•¸æ“šä¸æœƒå†ä¿®æ”¹ æ¯å€‹ TABLE åŒ…å«å¤§é‡çš„ column (å¯¬è¡¨)ï¼Œä½†æŸ¥è©¢é€šå¸¸åªå–å°‘æ•¸ column æŸ¥è©¢ç›¸å°è¼ƒå°‘ï¼Œé€šå¸¸å–®å€‹ server çš„ qps åƒ…æ•¸ç™¾æ¬¡æˆ–æ›´å°‘ å°æ–¼ç°¡å–®çš„æŸ¥è©¢ï¼Œå…è¨±å»¶é²å¤§ç´„ 50 ms åˆ—ä¸­çš„æ•¸æ“šç›¸å°è¼ƒå°ï¼šæ•¸å­—å’ŒçŸ­å­—ç¬¦ä¸² è™•ç†å€‹æŸ¥è©¢æ™‚éœ€è¦é«˜ååé‡ï¼Œå–®å€‹ server æ¯ç§’å¯èƒ½é ˆè®€å–æ•¸åå„„è¡Œè³‡æ–™ äº‹å‹™ä¸æ˜¯å¿…éœ€çš„ å°æ•¸æ“šä¸€è‡´æ€§è¦æ±‚ä½ æŸ¥è©¢çµæœç¶“ééæ¿¾å’Œèšåˆæœƒæ˜é¡¯å°æ–¼æºæ•¸æ“šï¼Œå› æ­¤çµæœé©åˆæ”¾åœ¨å–®å€‹ server çš„ RAM ä¸­ column-oriented è³‡æ–™åº«æ›´é©åˆ OLAP å ´æ™¯çš„åŸå›  ä»¥ä¸‹ç¨å¾®æ¼”ç¤º OLAP æŸ¥è©¢è¼ƒç‚ºå¿«é€Ÿçš„åŸå› ï¼š\nrow-orientedï¼š column-orientedï¼š å®‰è£\nç´¢å¼•\nPartition\nMaterialized MySQL (å¯¦é©—æ€§)\nProjection\nå„²å­˜çµæ§‹\nMergeTree è¡¨å¼•æ“\nTPC-H æ¸¬è©¦\n","date":"2024-10-11T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/clickhouse-introduction/","title":"ClickHouse ç°¡ä»‹"},{"content":"MySQL 8.4 æ›´æ–° å¾ MySQL 8.4 é–‹å§‹ï¼ŒUNIX é è¨­å€¼æ”¹ç‚º O_DIRECT if supported, otherwise fsync æ‰€ä»¥æœªä¾†ä¸å¤ªéœ€è¦èª¿æ•´æ­¤åƒæ•¸äº†\nåŸæ–‡ (MySQL 8.0) è¨­å®š flush data åˆ° InnoDB data files å’Œ log files ä½¿ç”¨çš„æ–¹æ³•ï¼Œæ­¤åƒæ•¸æœƒå½±éŸ¿åˆ° IO ååé‡\nfsync(or 0)ï¼šInnoDB use fsync() system call to flush dataï¼Œé€™åœ¨ 5.7ã€8.0 ç‚ºé»˜èªè¨­å®šã€‚ O_DSYNC(or 1)ï¼šInnoDB use O_SYNC to open and flush the log files, and fsync() to flush the data fileã€‚ InnoDBä¸ç›´æ¥ä½¿ç”¨ O_DSYNC å› ç‚ºåœ¨è¨±å¤š Unix ç‰ˆæœ¬ä¸Šéƒ½å­˜åœ¨å•é¡Œã€‚ littlesync(or 2)ï¼šæ­¤é¸é …ç”¨æ–¼å…§éƒ¨æ€§èƒ½æ¸¬è©¦ï¼Œç›®å‰ç‰ˆæœ¬ä¸æ”¯æŒã€‚ä½¿ç”¨å¾Œé¢¨éšªè‡ªè² ã€‚(5.7ã€8.0) nosync(or 3)ï¼šæ­¤é¸é …ç”¨æ–¼å…§éƒ¨æ€§èƒ½æ¸¬è©¦ï¼Œç›®å‰ç‰ˆæœ¬ä¸æ”¯æŒã€‚ä½¿ç”¨å¾Œé¢¨éšªè‡ªè² ã€‚(5.7ã€8.0) O_DIRECT(or 4)ï¼šInnoDB use O_DIRECT (or directio() on Solaris) to open the date files , and use fsync() to flush both the data and log files. æ­¤é¸é …åœ¨æŸäº› GNU/Linux ç‰ˆæœ¬ã€ FreeBSD å’Œ Solaris ä¸Šå¯ä»¥ä½¿ç”¨ã€‚ O_DIRECT_NO_FSYNCï¼šInnoDB use O_DIRECT during flushing I/O, but skips the fsync() system call after each write operation. åœ¨ 5.7.25ã€8.0.14 ä¹‹å‰ï¼Œæ­¤è¨­å®šä¸é©ç”¨æ–¼ XFSã€ EXT4 ç­‰ file systemï¼Œå› é€™é¡ file sysetméœ€è¦èª¿ç”¨ fsync() ä¾†åŒæ­¥ file system metadataçš„è®Šæ›´ï¼Œå¦‚æœä¸ç¢ºå®šæ˜¯å¦éœ€è¦è«‹èª¿æ•´ç‚º O_DIRECTã€‚ åœ¨ 5.7.25ã€8.0.14 é–‹å§‹ï¼Œåœ¨å»ºç«‹æ–°çš„æ–‡ä»¶ã€å¢åŠ æ–‡ä»¶å¤§å°ã€é—œé–‰æ–‡ä»¶å¾Œé€™äº›è®Šæ›´åˆ° file system metadata çš„æƒ…æ³æ‰æœƒèª¿ç”¨ fsync()ï¼Œå…¶é¤˜æƒ…å¯«å…¥æ“ä½œæœƒè·³é fsync()ã€‚ å¦‚æœ data files å’Œ log files å„²å­˜åœ¨ä¸åŒçš„è¨­å‚™ï¼Œä¸” data files çš„å„²å­˜è¨­å‚™æ²’æœ‰å¾Œå‚™é›»æ± ï¼Œå‰‡å¯èƒ½å°è‡´æ•¸æ“šä¸Ÿå¤±å»ºè­°æ”¹ç‚ºä½¿ç”¨ O_DIRECTã€‚ åœ¨ MySQL 8.0.14 é–‹å§‹ï¼Œè‹¥ innodb_dedicated_server å•Ÿç”¨æ™‚ï¼Œå‰‡æœƒå°‡ innodb_flush_method è¨­å®šç‚º O_DIRECT_NO_FSYNC\nè¨­å®šå€¼ Open log files Flush log Open dataFile Flush data fsync fsync() fsync() O_DSYNC O_SYNC O_SYNC fsync() O_DIRECT fsync() O_DIRECT fsync() O_DIRECT_NO_FSYNC åƒè€ƒ Adjusting MySQL 8.0 Memory Parameters - Percona\nä½¿ç”¨O_DIRECT_NO_FSYNCæ¥æå‡MySQLæ€§èƒ½ - æº«æ­£æ¹–(ç¶²æ˜“æ•¸æ“šåº«å…§æ ¸é–‹ç™¼)\n","date":"2024-04-30T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-innodb-flush-method/","title":"innodb_flush_method"},{"content":"åœ¨ MySQL 8.0 ä¹‹å‰åªèƒ½å¾ SHOW SLAVE STATUS ä¸­çš„ Second_Behind_Master ä¾†ç¢ºèª replication delayï¼Œä½†æ˜¯é€™å°æ–¼è¤‡é›œçš„ replication topologies (æ‹“æ’²) ä¸é©ç”¨ï¼Œä¾‹å¦‚ï¼š\nå¦‚ä¸Šåœ–ï¼Œåœ¨ 8.0 ä¹‹å‰æˆ‘å€‘åœ¨ C çš„æ©Ÿå™¨åªèƒ½çŸ¥é“ Bã€C ä¹‹é–“çš„ replication delayï¼Œç„¡æ³•çŸ¥é“ Aã€C ä¹‹é–“çš„ replication delayï¼Œè€Œ MySQL 8.0 é€²è¡Œäº†ä¸€äº›æ”¹å–„ã€‚\nReplication Delay Timestamps MySQL 8.0 é–‹å§‹æä¾›äº†æ–°çš„æ–¹å¼ä¾†æ¸¬é‡ replication delayï¼Œæ–¹æ³•æ˜¯åœ¨ binlog ä¸­ç‚º Transaction æ·»åŠ ä»¥ä¸‹å…©å€‹æ™‚é–“æˆ³ï¼š\noriginal_commit_timestampï¼šç´€éŒ„ Transaction åœ¨æœ€åŸæœ¬çš„ Master commit çš„æ™‚é–“æˆ³ immediate_commit_timestampï¼šç´€éŒ„ Transaction åœ¨ Slave é€£ç·šçš„ Master ä¸Š commit çš„æ™‚é–“æˆ³ é€é mysqlbinlog æŒ‡ä»¤æŸ¥çœ‹ MySQL 8.0 ä¹‹å¾Œçš„ binlogï¼š\n1 2 3 4 5 6 7 8 9 #221202 18:02:25 server id 1 end_log_pos 707 CRC32 0xf8ff712d Anonymous_GTID last_committed=2 sequence_number=3 rbr_only=yes original_committed_timestamp=1669975345432917 immediate_commit_timestamp=1669975527438008 transaction_length=357 /*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/; # original_commit_timestamp=1669975345432917 (2022-12-02 18:02:25.432917 CST) # immediate_commit_timestamp=1669975527438008 (2022-12-02 18:05:27.438008 CST) /*!80001 SET @@session.original_commit_timestamp=1669975345432917*//*!*/; /*!80014 SET @@session.original_server_version=80031*//*!*/; /*!80014 SET @@session.immediate_server_version=80031*//*!*/; SET @@SESSION.GTID_NEXT= \u0026#39;ANONYMOUS\u0026#39;/*!*/; # at 707 åœ¨æ‰€æœ‰çš„ Replica ä¸­ï¼Œæ‰€æœ‰è¢«å›æ”¾çš„ Transaction å…¶ original_commit_timestamp å§‹çµ‚ç›¸åŒï¼Œéƒ½æ˜¯æœ€æºé ­çš„ Source åŸ·è¡Œè©² Query æ™‚ commit çš„æ™‚é–“ã€‚ åœ¨æºé ­çš„ Source binlog ä¸­ original_commit_timestamp ç­‰æ–¼ immediate_commit_timestampã€‚ åœ¨ Replica çš„ relay log ä¸­å…¶ original_commit_timestamp ã€immediate_commit_timestamp æœƒç­‰æ–¼å…¶é€£ç·š Source ä¸Šçš„ binlog ç´€éŒ„ã€‚ åœ¨ Replica çš„ binlog ä¸­ï¼Œimmediate_commit_timestamp æ˜¯è‡ªå·± commit çš„æ™‚é–“æˆ³ã€‚ Monitoring Replication Delay é™¤äº†æ·»åŠ äº†æ–°çš„ replication delay timestampï¼Œ8.0 ä¹Ÿåœ¨ performance_schema ä¸­æ–°å¢ä»¥ä¸‹ä¸‰å¼µè¡¨æ–¹ä¾¿è§€å¯Ÿ replication delayï¼š\nreplication_connection_statusï¼šç´€éŒ„ IO_THREAD åœ¨å¯«å…¥ relay log çš„å·¥ä½œç‹€æ…‹ã€‚ LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP\næœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction å…¶ original_commit_timestampã€‚\nLAST_QUEUED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction å…¶ immediate_commit_timestampã€‚\nLAST_QUEUED_TRANSACTION_START_QUEUE_TIMESTAMP æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction çš„é–‹å§‹æ™‚é–“ã€‚\nLAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction çš„çµæŸæ™‚é–“ã€‚\nQUEUEING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP æ­£åœ¨å¯«å…¥ relay log çš„ Transaction å…¶ original_commit_timestampã€‚\nQUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP æ­£åœ¨å¯«å…¥ relay log çš„ Transaction å…¶ immediate_commit_timestampã€‚\nQUEUEING_TRANSACTION_START_QUEUE_TIMESTAMP æ­£åœ¨å¯«å…¥ relay log çš„ Transaction å…¶é–‹å§‹å¯«å…¥çš„æ™‚é–“ã€‚\nreplication_applier_status_by_workerï¼šè¨˜éŒ„æ¯ä¸€æ¢ SQL_THREAD çš„å·¥ä½œç‹€æ…‹ã€‚ LAST_APPLIED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶ original_commit_timestampã€‚ LAST_APPLIED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶ immediate_commit_timestampã€‚ LAST_APPLIED_TRANSACTION_START_APPLY_TIMESTAMP æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶å›æ”¾çš„é–‹å§‹æ™‚é–“ã€‚ LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶å›æ”¾çš„çµæŸæ™‚é–“ã€‚ APPLYING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP æ­£åœ¨è¢«å›æ”¾çš„ Transaction å…¶ original_commit_timestampã€‚ APPLYING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP æ­£åœ¨è¢«å›æ”¾çš„ Transaction å…¶ immediate_commit_timestampã€‚ APPLYING_TRANSACTION_START_APPLY_TIMESTAMP æ­£åœ¨è¢«å›æ”¾çš„ Transaction å…¶å›æ”¾çš„é–‹å§‹æ™‚é–“ã€‚ replication_applier_status_by_coordinatorï¼šç´€éŒ„ MTS ä¸­çš„ Coordinator ç·šç¨‹çš„å·¥ä½œç‹€æ…‹ï¼Œç•¶æœªé–‹å•Ÿ MTS æ­¤è¡¨ç‚ºç©ºã€‚ LAST_PROCESSED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP æœ€å¾Œä¸€å€‹è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ original_commit_timestampã€‚\nLAST_PROCESSED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP æœ€å¾Œä¸€å€‹è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ immediate_commit_timestampã€‚\nLAST_PROCESSED_TRANSACTION_START_BUFFER_TIMESTAMP æœ€å¾Œä¸€å€‹ Transaction ä»€éº¼æ™‚å€™é–‹å§‹è¢« Coordinator å¯«å…¥ Worker ç·šç¨‹çš„ bufferã€‚\nLAST_PROCESSED_TRANSACTION_END_BUFFER_TIMESTAMP\næœ€å¾Œä¸€å€‹ Transaction ä»€éº¼æ™‚å€™è¢« Coordinator å¯«å…¥ Worker ç·šç¨‹çš„ bufferã€‚\nPROCESSING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP\næ­£åœ¨è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ original_commit_timestampã€‚\nPROCESSING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP æ­£åœ¨è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ immediate_commit_timestampã€‚\nPROCESSING_TRANSACTION_START_BUFFER_TIMESTAMP\næ­£åœ¨è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶é–‹å§‹å¯«å…¥ Worker ç·šç¨‹çš„ buffer çš„æ™‚é–“ã€‚\næ³¨æ„ï¼šé€™äº› Table ä¸­çš„ immediate_commit_timestamp éƒ½æ˜¯å¾ relay log ä¸­å–å¾—ã€‚\nç¯„ä¾‹ è§€å¯Ÿ A â†’ C ä¹‹é–“å®Œæ•´çš„å»¶é²\n1 2 3 4 5 SELECT TIMEDIFF( LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP, LAST_APPLIED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP ) FROM performance_schema.replication_applier_status_by_worker è§€å¯Ÿ B â†’ C ä¹‹é–“å®Œæ•´çš„å»¶é²\n1 2 3 4 5 SELECT TIMEDIFF( LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP, LAST_APPLIED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP ) FROM performance_schema.replication_applier_status_by_worker C æ­£åœ¨å›æ”¾çš„ Transaction å’Œ B çš„å»¶é²\n1 2 3 4 5 SELECT TIMEDIFF( APPLYING_TRANSACTION_START_APPLY_TIMESTAMP, APPLYING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP ) FROM performance_schema.replication_applier_status_by_worker é–‹å•Ÿ MTS æ™‚ï¼ŒCoordinator æ­£åœ¨è™•ç†çš„ Transaction å’Œ B çš„å»¶é²\n1 2 3 4 5 SELECT TIME_DIFF( PROCESSING_TRANSACTION_START_BUFFER_TIMESTAMP, PROCESSING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP ) FROM performance_schema.replication_applier_status_by_coordinator è§€å¯Ÿ C relaylog ä¸­æœ€å¾Œå¯«å…¥çš„ Transaction åœ¨ A commit çš„å»¶é²\n1 2 3 4 5 SELECT TIMEDIFF( LAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP, LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP ) FROM performance_schema.replication_connection_status è§€å¯Ÿ B â†’ C ä¹‹é–“ relaylog çš„å¯«å…¥å»¶é²\n1 2 3 4 5 SELECT TIMEDIFF( QUEUEING_TRANSACTION_START_QUEUE_TIMESTAMP, QUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP ) FROM performance_schema.replication_connection_status å…¶ä»–ç”¨é€” åœ¨ binlog ä¸­æˆ‘å€‘çŸ¥é“æœ‰ exec_time é€™å€‹å€¼ï¼Œä½†é€™å€‹å€¼ä¸¦ä¸èƒ½è®“æˆ‘å€‘æº–ç¢ºçš„çŸ¥é“ Transaction commit çš„ç¢ºåˆ‡æ™‚é–“ï¼Œä½†åœ¨ MySQL 8.0 ä¹‹å¾Œæˆ‘å€‘å¯ä»¥é€éè§€æ¸¬ original_commit_timestamp ä¾†ç¢ºèªï¼Œåƒè€ƒä»¥ä¸‹ä¾‹å­ï¼šåœ¨ä¸€å¼µè¡¨ä¸ŠåŸ·è¡Œäº† 458752 ç­†è³‡æ–™çš„ updateï¼Œç¸½è¨ˆèŠ±è²»æ™‚é–“ 13.62 sec\n1 2 3 4 5 6 7 8 9 10 mysql\u0026gt; select now(); update t1 set name=repeat(\u0026#39;c\u0026#39;,2000); +---------------------+ | now() | +---------------------+ | 2022-12-06 08:55:06 | +---------------------+ 1 row in set (0.00 sec) Query OK, 458752 rows affected (13.62 sec) Rows matched: 524288 Changed: 458752 è®“æˆ‘å€‘çœ‹ä¸€ä¸‹ binlogï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #221206 16:55:06 server id 1 end_log_pos 241 CRC32 0x4cc632cf Anonymous_GTID last_committed=0 sequence_number=1 rbr_only=yes original_committed_timestamp=1670316919294397 immediate_commit_timestamp=1670316919294397 transaction_length=190792863 /*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/; # original_commit_timestamp=1670316919294397 (2022-12-06 16:55:19.294397 CST) # immediate_commit_timestamp=1670316919294397 (2022-12-06 16:55:19.294397 CST) /*!80001 SET @@session.original_commit_timestamp=1670316919294397*//*!*/; /*!80014 SET @@session.original_server_version=80021*//*!*/; /*!80014 SET @@session.immediate_server_version=80021*//*!*/; SET @@SESSION.GTID_NEXT= \u0026#39;ANONYMOUS\u0026#39;/*!*/; # at 241 #221206 16:55:06 server id 1 end_log_pos 325 CRC32 0x3035566a Query thread_id=2244 exec_time=1 error_code=0 ... #221206 16:55:06 server id 1 end_log_pos 384 CRC32 0xeed08d18 Rows_query # update t1 set name=repeat(\u0026#39;c\u0026#39;,2000) ... å¯ä»¥çœ‹åˆ° exec_time é¡¯ç¤ºçš„æ˜¯ 1ï¼Œè€Œä¸æ˜¯æ­£ç¢ºçš„åŸ·è¡Œæ™‚é–“ï¼Œé€™æ˜¯å› ç‚º exec_time æŒ‡çš„æ˜¯ update ç¬¬ä¸€ç­†è³‡æ–™èŠ±è²»çš„æ™‚é–“ï¼Œè€Œä¸æ˜¯æ•´å€‹ update èªå¥åŸ·è¡Œçš„æ™‚é–“ã€‚\nä¸éå¾ MySQL 8.0 é–‹å§‹æˆ‘å€‘å°±å¯ä»¥é€é transaction é–‹å§‹æ™‚é–“ (ä¹Ÿå°±æ˜¯ 16:55:06) å’Œ transaction commit çš„æ™‚é–“ - immediate_commit_timestamp (ä¹Ÿå°±æ˜¯ 16:55:19) åˆ¤æ–·å‡ºé€™å€‹ transaction åŸ·è¡Œäº† 13 secã€‚\nåƒè€ƒ MySQL :: MySQL 8.0 Reference Manual :: 17.4.11 Delayed Replication\nMySQL :: WL#7319: Infrastructure for GTID based delayed replication and replication lag monitoring\nMySQL :: WL#7374: Performance schema tables to monitor replication lags and queue\næ–°ç‰¹æ€§è§£è¯» | MySQL 8 å¤åˆ¶å»¶è¿Ÿè§‚æµ‹æ–°æ–¹å¼ï¼Œæ›´å…¨é¢æ›´ç²¾å‡† - çŸ¥ä¹ (zhihu.com)\nbinlogè®°å½•SQLæ‰§è¡Œæ—¶é—´å—ï¼Œå‡†ä¸å‡†ï¼Œæ—¶é—´æ˜¯å¦åŒ…å«é”ç­‰å¾…æ—¶é—´ - æŸ´ç±³æ²¹ç›é…±é†‹ - åšå®¢å›­ (cnblogs.com)\nMySQL Â· ç­”ç–‘è§£æƒ‘ Â· å¤‡åº“Seconds_Behind_Masterè®¡ç®— (taobao.org)\nMySQL å¤åˆ¶å»¶è¿Ÿè®¡ç®—çš„é—®é¢˜åˆ†æ - ZhenXing_Yu - åšå®¢å›­ (cnblogs.com)\n","date":"2022-12-23T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/","title":"MySQL8.0 å°æ–¼ replication delay è§€æ¸¬æ”¹é€²"},{"content":"é‡ç¾ äº‹å‰æº–å‚™ (schemaã€åˆå§‹è³‡æ–™)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 CREATE TABLE `round_to_txn` ( `round_id` varchar(30) NOT NULL COMMENT \u0026#39;è¨‚å–®è™Ÿ\u0026#39;, `txn_id` char(50) NOT NULL COMMENT \u0026#39;äº¤æ˜“ä»£ç¢¼\u0026#39;, `end_time` timestamp NOT NULL DEFAULT \u0026#39;0000-00-00 00:00:00\u0026#39; COMMENT \u0026#39;çµç®—æ™‚é–“\u0026#39;, `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;å»ºç«‹æ™‚é–“\u0026#39;, PRIMARY KEY (`round_id`,`txn_id`,`end_time`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\u0026#39;å±€è™Ÿé—œè¯çš„äº¤æ˜“å–®è™Ÿ\u0026#39; /*!50100 PARTITION BY RANGE (unix_timestamp(`end_time`)) (PARTITION PHISTORY VALUES LESS THAN (1654056000) ENGINE = InnoDB, PARTITION P202206 VALUES LESS THAN (1656648000) ENGINE = InnoDB, PARTITION P202207 VALUES LESS THAN (1659326400) ENGINE = InnoDB, PARTITION P202208 VALUES LESS THAN (1662004800) ENGINE = InnoDB, PARTITION P202209 VALUES LESS THAN (1664596800) ENGINE = InnoDB, PARTITION P202210 VALUES LESS THAN (1667275200) ENGINE = InnoDB, PARTITION P202211 VALUES LESS THAN (1669867200) ENGINE = InnoDB, PARTITION P202212 VALUES LESS THAN (1672545600) ENGINE = InnoDB, PARTITION P202301 VALUES LESS THAN (1675224000) ENGINE = InnoDB, PARTITION P202302 VALUES LESS THAN (1677643200) ENGINE = InnoDB, PARTITION P202303 VALUES LESS THAN (1680321600) ENGINE = InnoDB, PARTITION P202304 VALUES LESS THAN (1682913600) ENGINE = InnoDB, PARTITION P202305 VALUES LESS THAN (1685592000) ENGINE = InnoDB, PARTITION P202306 VALUES LESS THAN (1688184000) ENGINE = InnoDB, PARTITION POTHER VALUES LESS THAN MAXVALUE ENGINE = InnoDB) */ ; INSERT INTO round_to_txn(round_id, txn_id, end_time) VALUES (\u0026#39;039910eukXEC\u0026#39;, \u0026#39;5\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039911eukXEC\u0026#39;, \u0026#39;6\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039910eukXEC\u0026#39;, \u0026#39;7\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039911eukXEC\u0026#39;, \u0026#39;8\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039912eukXEC\u0026#39;, \u0026#39;9\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039913eukXEC\u0026#39;, \u0026#39;10\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039912eukXEC\u0026#39;, \u0026#39;11\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039913eukXEC\u0026#39;, \u0026#39;12\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039914eukXEC\u0026#39;, \u0026#39;13\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039914eukXEC\u0026#39;, \u0026#39;14\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039915eukXEC\u0026#39;, \u0026#39;15\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039915eukXEC\u0026#39;, \u0026#39;16\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039916eukXEC\u0026#39;, \u0026#39;17\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039917eukXEC\u0026#39;, \u0026#39;18\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039916eukXEC\u0026#39;, \u0026#39;19\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039917eukXEC\u0026#39;, \u0026#39;20\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039918eukXEC\u0026#39;, \u0026#39;21\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039919eukXEC\u0026#39;, \u0026#39;22\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039918eukXEC\u0026#39;, \u0026#39;23\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039919eukXEC\u0026#39;, \u0026#39;24\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039920eukXEC\u0026#39;, \u0026#39;25\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039920eukXEC\u0026#39;, \u0026#39;26\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039921eukXEC\u0026#39;, \u0026#39;27\u0026#39;, \u0026#39;0000-00-00 00:00:00\u0026#39;), (\u0026#39;039909eukXEC\u0026#39;, \u0026#39;4\u0026#39;, \u0026#39;2022-11-01 00:10:00\u0026#39;), (\u0026#39;039909eukXEC\u0026#39;, \u0026#39;3\u0026#39;, \u0026#39;2022-11-01 00:10:00\u0026#39;), (\u0026#39;039908eukXEC\u0026#39;, \u0026#39;2\u0026#39;, \u0026#39;2022-10-01 00:10:00\u0026#39;), (\u0026#39;039908eukXEC\u0026#39;, \u0026#39;1\u0026#39;, \u0026#39;2022-10-01 00:10:00\u0026#39;); æ¨¡æ“¬ä¸¦è¡Œ update è³‡æ–™çš„ç¨‹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 package main import ( \u0026#34;database/sql\u0026#34; _ \u0026#34;github.com/go-sql-driver/mysql\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) const ( dbHost string = \u0026#34;10.17.117.203\u0026#34; dbPort int = 3331 dbUser string = \u0026#34;root\u0026#34; dbPassword string = \u0026#34;root\u0026#34; dbDatabase string = \u0026#34;test\u0026#34; dbMaxOpenConns int = 10 dbMaxIdleConns int = 10 dbMaxLifetime int = 3600 ) var DB *sql.DB func initDB() { var err error dsn := fmt.Sprintf(\u0026#34;%s:%s@tcp(%s:%d)/%s\u0026#34;, dbUser, dbPassword, dbHost, dbPort, dbDatabase) DB, err = sql.Open(\u0026#34;mysql\u0026#34;, dsn) DB.SetMaxOpenConns(dbMaxOpenConns) DB.SetMaxIdleConns(dbMaxIdleConns) DB.SetConnMaxLifetime(time.Duration(dbMaxLifetime) * time.Second) if err != nil { fmt.Println(\u0026#34;connection to mysql failed:\u0026#34;, err) return } fmt.Println(\u0026#34;connnect success\u0026#34;) } func txUpdateTest(roundId string, endTime string, wg *sync.WaitGroup) { defer wg.Done() // begin transaction tx, err := DB.Begin() if err != nil { fmt.Println(\u0026#34;begin fail: \u0026#34;, err) return } // prepare stmt, err := tx.Prepare(\u0026#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ?\u0026#34;) // æœƒ deadlock // stmt, err := tx.Prepare(\u0026#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND `end_time` = \u0026#39;0000-00-00 00:00:00\u0026#39;\u0026#34;) // ä¸æœƒ deadlock // stmt, err := tx.Prepare(\u0026#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND `end_time` \u0026lt;= \u0026#39;2022-10-31 23:59:59\u0026#39;\u0026#34;) // ä¸æœƒ deadlock //stmt, err := tx.Prepare(\u0026#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND (`end_time` \u0026lt;= \u0026#39;2022-10-31 23:59:59\u0026#39; OR `end_time` \u0026gt;= \u0026#39;2022-12-01 00:00:00\u0026#39; )\u0026#34;) // ä¸æœƒ deadlock // stmt, err := tx.Prepare(\u0026#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND (`end_time` \u0026lt;= \u0026#39;2022-11-10 23:59:59\u0026#39;)\u0026#34;) // æœƒ deadlock if err != nil { fmt.Println(\u0026#34;prepare fail: \u0026#34;, err) return } // exec _, err = stmt.Exec(endTime, roundId) if err != nil { fmt.Println(\u0026#34;Exec fail: \u0026#34;, err) return } // commit tx.Commit() } func updateTest(roundId string, endTime string) { _, err := DB.Exec(\u0026#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ?\u0026#34;, endTime, roundId) if err != nil { fmt.Println(\u0026#34;update fail:\u0026#34;, err) return } } func main() { wg := new(sync.WaitGroup) initDB() defer DB.Close() type sqlValue struct { roundId string endTime string } var initValue = []sqlValue{} for i := 10; i \u0026lt; 21; i++ { initValue = append(initValue, sqlValue{fmt.Sprintf(\u0026#34;0399%deukXEC\u0026#34;, i), \u0026#34;0000-00-00 00:00:00\u0026#34;}) } for _, e := range initValue { updateTest(e.roundId, e.endTime) } var testValue = []sqlValue{} for i := 10; i \u0026lt; 21; i++ { testValue = append(testValue, sqlValue{fmt.Sprintf(\u0026#34;0399%deukXEC\u0026#34;, i), \u0026#34;2022-11-16 08:53:08\u0026#34;}) } for _, e := range testValue { wg.Add(1) go txUpdateTest(e.roundId, e.endTime, wg) } wg.Wait() } æ¸¬è©¦çµæœå¦‚ä¸‹è¡¨ï¼š\nèªæ³•ï¼šUPDATE round_to_txn SET end_time = \u0026ldquo;2022-11-16 08:53:08â€ WHERE â€¦ æ˜¯å¦æœ‰ deadlock round_id = ? Yes round_id = ? AND end_time = â€˜0000-00-00 00:00:00â€™ No round_id = ? AND end_time \u0026lt;= \u0026lsquo;2022-10-31 23:59:59\u0026rsquo; No round_id = ? AND end_time \u0026lt;= \u0026lsquo;2022-11-10 23:59:59\u0026rsquo; No round_id = ? AND (end_time \u0026lt;= \u0026lsquo;2022-10-31 23:59:59\u0026rsquo; OR end_time \u0026gt;= \u0026lsquo;2022-12-01 00:00:00\u0026rsquo; ) Yes DeadLock åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ------------------------ LATEST DETECTED DEADLOCK ------------------------ 2022-11-18 09:00:57 140176279025408 *** (1) TRANSACTION: TRANSACTION 4914, ACTIVE 0 sec inserting mysql tables in use 1, locked 1 LOCK WAIT 32 lock struct(s), heap size 3488, 18 row lock(s) MySQL thread id 9140, OS thread handle 140176259069696, query id 21183 10.17.117.103 root updating UPDATE `round_to_txn` SET `end_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039912eukXEC\u0026#39; *** (1) HOLDS THE LOCK(S): RECORD LOCKS space id 74 page no 4 n bits 80 index PRIMARY of table `test`.`round_to_txn` /* Partition `p202211` */ trx id 4914 lock_mode X locks gap before rec ... *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 74 page no 4 n bits 80 index PRIMARY of table `test`.`round_to_txn` /* Partition `p202211` */ trx id 4914 lock_mode X locks gap before rec insert intention waiting ... *** (2) TRANSACTION: TRANSACTION 4923, ACTIVE 0 sec inserting mysql tables in use 1, locked 1 LOCK WAIT 32 lock struct(s), heap size 3488, 18 row lock(s) MySQL thread id 9142, OS thread handle 140176262240000, query id 21200 10.17.117.103 root updating UPDATE `round_to_txn` SET `end_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039915eukXEC\u0026#39; *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 74 page no 4 n bits 80 index PRIMARY of table `test`.`round_to_txn` /* Partition `p202211` */ trx id 4923 lock_mode X locks gap before rec ... *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 74 page no 4 n bits 80 index PRIMARY of table `test`.`round_to_txn` /* Partition `p202211` */ trx id 4923 lock_mode X locks gap before rec insert intention waiting ... *** WE ROLL BACK TRANSACTION (2) çœ‹ä¸€ä¸‹ä¸Šæ–¹çš„ log å¯ä»¥çœ‹åˆ° deadlock çš„åŸå› æ˜¯å…©è€…éƒ½æœ‰ GAP LOCKï¼Œè€Œ GAP LOCK æœ¬èº«äº’ç›¸ä¸è¡çªï¼Œä½†æ˜¯éƒ½æœƒé˜»å¡ INSERT æ“ä½œä¾†é”åˆ° RR ç´šåˆ¥çš„å¯é‡è¤‡è®€ï¼Œå°±åœ¨é€™æ™‚å€™ 2 å€‹ Transaction åŒæ™‚åˆè¦æ±‚ Insert Intention Locksï¼Œé€™å°±å°è‡´é›™æ–¹éƒ½åœ¨ç­‰å¾…å°æ–¹é‡‹æ”¾ GAP LOCKï¼Œå› æ­¤ç™¼ç”Ÿäº† DEADLOCKã€‚\nä½†æ˜¯å•é¡Œä¾†äº†ï¼Œé€™å…©å€‹ Transaction éƒ½æ˜¯ UPDATE æ“ä½œï¼Œç‚ºä»€éº¼æœƒæœ‰ INSERT æ“ä½œæ‰æœ‰çš„ Insert Intention Locks å‘¢?\nå¯¦é©— æ²’æœ‰ partition çš„æ¸¬è©¦ æˆ‘å€‘å»ºç«‹ä¸€å€‹ schema ç›¸åŒï¼Œä½†æ˜¯æ²’æœ‰ partition çš„ table æ¸¬è©¦\n1 2 3 4 5 6 7 8 9 10 11 mysql\u0026gt; show create table nop_test\\G *************************** 1. row *************************** Table: nop_test Create Table: CREATE TABLE `nop_test` ( `round_id` varchar(30) NOT NULL COMMENT \u0026#39;è¨‚å–®è™Ÿ\u0026#39;, `txn_id` char(50) NOT NULL COMMENT \u0026#39;äº¤æ˜“ä»£ç¢¼\u0026#39;, `end_time` timestamp NOT NULL DEFAULT \u0026#39;0000-00-00 00:00:00\u0026#39; COMMENT \u0026#39;çµç®—æ™‚é–“\u0026#39;, `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;å»ºç«‹æ™‚é–“\u0026#39;, `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æœ€æ–°æ›´æ–°æ™‚é–“\u0026#39;, PRIMARY KEY (`round_id`,`txn_id`,`end_time`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\u0026#39;å±€è™Ÿé—œè¯çš„äº¤æ˜“å–®è™Ÿ\u0026#39; å–®ç¨ä¸€å€‹ update æ“ä½œçš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 mysql\u0026gt; begin; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; update nop_test set end_time = now() where round_id = \u0026#39;039910eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+-----------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+-----------+-------------+ | 6502 | nop_test | NULL | TABLE | IX | GRANTED | | 6502 | nop_test | PRIMARY | RECORD | X | GRANTED | | 6502 | nop_test | PRIMARY | RECORD | X,GAP | GRANTED | +------+-------------+------------+-----------+-----------+-------------+ mysql\u0026gt; SHOW ENGINE INNODB STATUS\\G *************************** 1. row *************************** ... ---TRANSACTION 6502, ACTIVE 18 sec 3 lock struct(s), heap size 1128, 5 row lock(s), undo log entries 4 MySQL thread id 17233, OS thread handle 140176258012928, query id 39405 localhost root starting SHOW ENGINE INNODB STATUS TABLE LOCK table `test`.`nop_test` trx id 6502 lock mode IX RECORD LOCKS space id 115 page no 4 n bits 96 index PRIMARY of table `test`.`nop_test` trx id 6502 lock_mode X Record lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 32 0: len 12; hex 30333939313065756b584543; asc 039910eukXEC;; 1: len 30; hex 352020202020202020202020202020202020202020202020202020202020; asc 5 ; (total 50 bytes); 2: len 4; hex 00000000; asc ;; 3: len 6; hex 000000001966; asc f;; 4: len 7; hex 020000011e1518; asc ;; 5: len 4; hex 637ae7b8; asc cz ;; 6: len 4; hex 637ae7b8; asc cz ;; ... ... Record lock, heap no 30 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 12; hex 30333939313065756b584543; asc 039910eukXEC;; 1: len 30; hex 372020202020202020202020202020202020202020202020202020202020; asc 7 ; (total 50 bytes); 2: len 4; hex 637ae7c9; asc cz ;; 3: len 6; hex 000000001966; asc f;; 4: len 7; hex 8200000105015d; asc ];; 5: len 4; hex 637ae7b8; asc cz ;; 6: len 4; hex 637ae7c9; asc cz ;; å¯ä»¥çœ‹åˆ°å¦‚æœåœ¨æ²’æœ‰ partition çš„ table ä¸Šé€²è¡Œ update æ“ä½œæœƒæœ‰ä»¥ä¸‹ LOCKï¼š\nè©² Table çš„ IX å› ç‚ºæ˜¯é€é PK ä¾†æƒæï¼Œå› æ­¤åœ¨ PK ä¸Šå‘½ä¸­çš„è¡ŒåŠ ä¸Š Record Lock å› ç‚ºæ¢ä»¶æ²’æœ‰è¦†è“‹ PK æ¢ä»¶ï¼Œå› æ­¤åœ¨ç¬¦åˆçš„ä½ç½®åŠ ä¸Š Gap Lock é¿å…è¢« INSERT è¤‡æ•¸ update æ“ä½œçš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 -- Transaction 1 mysql\u0026gt; begin; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; update p_test set end_time = now() where round_id = \u0026#39;039910eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 -- Transaction 2 mysql\u0026gt; begin; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; update p_test set end_time = now() where round_id = \u0026#39;039910eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+-----------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+-----------+-------------+ | 6545 | nop_test | NULL | TABLE | IX | GRANTED | | 6545 | nop_test | PRIMARY | RECORD | X | GRANTED | | 6545 | nop_test | PRIMARY | RECORD | X,GAP | GRANTED | | 6544 | nop_test | NULL | TABLE | IX | GRANTED | | 6544 | nop_test | PRIMARY | RECORD | X | GRANTED | | 6544 | nop_test | PRIMARY | RECORD | X,GAP | GRANTED | +------+-------------+------------+-----------+-----------+-------------+ mysql\u0026gt; show engine innodb status\\G *************************** 1. row *************************** ---TRANSACTION 6545, ACTIVE 21 sec 3 lock struct(s), heap size 1128, 5 row lock(s), undo log entries 4 MySQL thread id 17290, OS thread handle 140175996847872, query id 39805 localhost root TABLE LOCK table `test`.`nop_test` trx id 6545 lock mode IX RECORD LOCKS space id 115 page no 4 n bits 96 index PRIMARY of table `test`.`nop_test` trx id 6545 lock_mode X ... RECORD LOCKS space id 115 page no 4 n bits 96 index PRIMARY of table `test`.`nop_test` trx id 6545 lock_mode X locks gap before rec ... ---TRANSACTION 6544, ACTIVE 32 sec 3 lock struct(s), heap size 1128, 5 row lock(s), undo log entries 4 MySQL thread id 17233, OS thread handle 140176258012928, query id 39809 localhost root starting show engine innodb status TABLE LOCK table `test`.`nop_test` trx id 6544 lock mode IX RECORD LOCKS space id 115 page no 4 n bits 96 index PRIMARY of table `test`.`nop_test` trx id 6544 lock_mode X ... RECORD LOCKS space id 115 page no 4 n bits 96 index PRIMARY of table `test`.`nop_test` trx id 6544 lock_mode X locks gap before rec ... å¯ä»¥çœ‹åˆ°ç•¶æœ‰ 2 å¥ update æ“ä½œæ™‚å…¶å¯¦ LOCK æƒ…æ³ä¸¦æ²’æœ‰åˆ†åˆ¥ï¼Œä¸”å› ç‚ºå…©è€… Record Lock ä¸è¡çªï¼Œä¸” Gap Lock äº’ç›¸ä¸é˜»å¡ï¼Œå› æ­¤å…©è€…éƒ½èƒ½æˆåŠŸ UPDATEã€‚\næœ‰ partition çš„æ¸¬è©¦ å–®ç¨ä¸€å€‹ update é partition keyæ“ä½œçš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 mysql\u0026gt; begin; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; update p_test set update_time = now() where round_id = \u0026#39;039910eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+-----------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+-----------+-------------+ | 7968 | p_test | NULL | TABLE | IX | GRANTED | | 7968 | p_test | PRIMARY | RECORD | X | GRANTED | | 7968 | p_test | PRIMARY | RECORD | X,GAP | GRANTED | +------+-------------+------------+-----------+-----------+-------------+ 3 rows in set (0.00 sec) mysql\u0026gt; SHOW ENGINE INNODB STATUS\\G *************************** 1. row *************************** ... ---TRANSACTION 7968, ACTIVE 34 sec 31 lock struct(s), heap size 3488, 17 row lock(s), undo log entries 2 MySQL thread id 17290, OS thread handle 140175996847872, query id 43462 localhost root starting SHOW ENGINE INNODB STATUS TABLE LOCK table `test`.`p_test` /* Partition `pother` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202306` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202305` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202304` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202303` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202302` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202301` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202212` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202211` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202210` */ trx id 7968 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS -------- çœ‹èµ·ä¾†å’Œ partition çš„å–®ç¨ update ç›¸åŒï¼Œåªæ˜¯å› ç‚ºæœ‰åˆ‡ partitionï¼Œæ‰€ä»¥éœ€è¦å°æ¯å€‹ Partition åŠ ä¸Š IX ã€‚\nè¤‡æ•¸ update é partition key æ“ä½œçš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 -- Transaction 1 mysql\u0026gt; begin; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; UPDATE `round_to_txn` SET `update_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039912eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 -- Transaction 2 mysql\u0026gt; begin; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; UPDATE `round_to_txn` SET `update_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039913eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+-----------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+-----------+-------------+ | 7969 | p_test | NULL | TABLE | IX | GRANTED | | 7969 | p_test | PRIMARY | RECORD | X | GRANTED | | 7969 | p_test | PRIMARY | RECORD | X,GAP | GRANTED | | 7968 | p_test | NULL | TABLE | IX | GRANTED | | 7968 | p_test | PRIMARY | RECORD | X | GRANTED | | 7968 | p_test | PRIMARY | RECORD | X,GAP | GRANTED | +------+-------------+------------+-----------+-----------+-------------+ 6 rows in set (0.00 sec) mysql\u0026gt; show engine innodb status\\G *************************** 1. row *************************** ---TRANSACTION 7969, ACTIVE 35 sec 31 lock struct(s), heap size 3488, 17 row lock(s), undo log entries 2 MySQL thread id 17233, OS thread handle 140176258012928, query id 43468 localhost root TABLE LOCK table `test`.`p_test` /* Partition `pother` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202306` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202305` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202304` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202303` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202302` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202301` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202212` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202211` */ trx id 7969 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202210` */ trx id 7969 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS ---TRANSACTION 7968, ACTIVE 108 sec 31 lock struct(s), heap size 3488, 17 row lock(s), undo log entries 2 MySQL thread id 17290, OS thread handle 140175996847872, query id 43472 localhost root starting show engine innodb status TABLE LOCK table `test`.`p_test` /* Partition `pother` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202306` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202305` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202304` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202303` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202302` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202301` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202212` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202211` */ trx id 7968 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202210` */ trx id 7968 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS å¯ä»¥çœ‹åˆ°å’Œå–®ç¨åŸ·è¡Œä¸€å¥ update ä¸€æ¨£ï¼Œåªæœ‰ Record Lockã€Gap Lock ä¸¦æ²’æœ‰ç”¢ç”Ÿè¡çª\nå–®ç¨ä¸€å€‹ update partition key æ“ä½œçš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 mysql\u0026gt; begin; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; update p_test set end_time = now() where round_id = \u0026#39;039910eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+-------------+------------+-----------+-----------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+-------------+------------+-----------+-----------+-------------+ | 6228 | p_test | NULL | TABLE | IX | GRANTED | | 6228 | p_test | PRIMARY | RECORD | X | GRANTED | | 6228 | p_test | PRIMARY | RECORD | X,GAP | GRANTED | +------+-------------+------------+-----------+-----------+-------------+ 3 rows in set (0.00 sec) mysql\u0026gt; SHOW ENGINE INNODB STATUS\\G *************************** 1. row *************************** ... ---TRANSACTION 6228, ACTIVE 48 sec 32 lock struct(s), heap size 3488, 19 row lock(s), undo log entries 4 MySQL thread id 17233, OS thread handle 140176258012928, query id 39374 localhost root starting SHOW ENGINE INNODB STATUS TABLE LOCK table `test`.`p_test` /* Partition `pother` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202306` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202305` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202304` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202303` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202302` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202301` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202212` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202211` */ trx id 6228 lock mode IX TABLE LOCK table `test`.`p_test` /* Partition `p202210` */ trx id 6228 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS -------- çœ‹èµ·ä¾†å’Œ partition çš„å–®ç¨ update ç›¸åŒï¼Œåªæ˜¯å› ç‚ºæœ‰åˆ‡ partitionï¼Œæ‰€ä»¥éœ€è¦å°æ¯å€‹ Partition åŠ ä¸Š IX ã€‚\nè¤‡æ•¸ update partition key æ“ä½œçš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 -- Transaction 1 mysql\u0026gt; begin; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; UPDATE `round_to_txn` SET `end_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039912eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 -- Transaction 2 mysql\u0026gt; begin; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; UPDATE `round_to_txn` SET `end_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039913eukXEC\u0026#39;; -- Lock Wait ... mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+--------------+------------+-----------+------------------------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+--------------+------------+-----------+------------------------+-------------+ | 7961 | round_to_txn | NULL | TABLE | IX | GRANTED | | 7961 | round_to_txn | PRIMARY | RECORD | X | GRANTED | | 7961 | round_to_txn | PRIMARY | RECORD | X,GAP | GRANTED | | 7961 | round_to_txn | PRIMARY | RECORD | X,GAP,INSERT_INTENTION | WAITING | | 7956 | round_to_txn | NULL | TABLE | IX | GRANTED | | 7956 | round_to_txn | PRIMARY | RECORD | X | GRANTED | | 7956 | round_to_txn | PRIMARY | RECORD | X,GAP | GRANTED | +------+--------------+------------+-----------+------------------------+-------------+ mysql\u0026gt; show engine innodb status\\G *************************** 1. row *************************** ---TRANSACTION 7961, ACTIVE 20 sec inserting mysql tables in use 1, locked 1 LOCK WAIT 32 lock struct(s), heap size 3488, 18 row lock(s) MySQL thread id 17290, OS thread handle 140175996847872, query id 43421 localhost root updating UPDATE `round_to_txn` SET `end_time` = \u0026#39;2022-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039913eukXEC\u0026#39; ------- TRX HAS BEEN WAITING 20 SEC FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 74 page no 4 n bits 80 index PRIMARY of table `test`.`round_to_txn` /* Partition `p202211` */ trx id 7961 lock_mode X locks gap before rec insert intention waiting Record lock, heap no 6 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 12; hex 30333939313865756b584543; asc 039918eukXEC;; 1: len 30; hex 323120202020202020202020202020202020202020202020202020202020; asc 21 ; (total 50 bytes); 2: len 4; hex 6374a4f4; asc ct ;; 3: len 6; hex 000000001f09; asc ;; 4: len 7; hex 82000000fc0110; asc ;; 5: len 4; hex 63760cc6; asc cv ;; 6: len 4; hex 637b2b14; asc c ;; ------------------ TABLE LOCK table `test`.`round_to_txn` /* Partition `pother` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202306` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202305` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202304` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202303` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202302` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202301` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202212` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202211` */ trx id 7961 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202210` */ trx id 7961 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS ---TRANSACTION 7956, ACTIVE 27 sec 31 lock struct(s), heap size 3488, 19 row lock(s), undo log entries 4 MySQL thread id 17233, OS thread handle 140176258012928, query id 43425 localhost root starting show engine innodb status TABLE LOCK table `test`.`round_to_txn` /* Partition `pother` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202306` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202305` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202304` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202303` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202302` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202301` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202212` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202211` */ trx id 7956 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202210` */ trx id 7956 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS æˆ‘å€‘å¯ä»¥çœ‹åˆ°å‡ºç¾äº† Insert Intention Locksï¼Œå› ç‚º Insert Intention Locks æ˜¯å»¶é²åŠ é–æ©Ÿåˆ¶ï¼Œåªæœ‰å’Œ Gap Lock ç™¼ç”Ÿè¡çªæ‰åŠ ä¸Šä¾†çš„ï¼Œæ‰€ä»¥å–®ç¨åŸ·è¡Œæ²’ç™¼ç”Ÿè¡çªä¹Ÿçœ‹ä¸åˆ° Insert Intention Locksï¼ŒåŒæ™‚æˆ‘å€‘ä¹ŸçŸ¥é“äº†ç•¶åœ¨\nè¤‡æ•¸ update partition key æ“ä½œï¼Œä½†ä¸è®Šå‹• partition key çš„ Lock æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 -- Transaction 1 mysql\u0026gt; begin; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; UPDATE `round_to_txn` SET `end_time` = \u0026#39;2020-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039912eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 -- Transaction 2 mysql\u0026gt; begin; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; UPDATE `round_to_txn` SET `end_time` = \u0026#39;2020-11-16 08:53:08\u0026#39; WHERE `round_id` = \u0026#39;039913eukXEC\u0026#39;; Query OK, 2 rows affected (0.00 sec) Rows matched: 2 Changed: 2 Warnings: 0 mysql\u0026gt; SELECT DISTINCT ENGINE_TRANSACTION_ID AS TID,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS FROM performance_schema.data_locks; +------+--------------+------------+-----------+-----------+-------------+ | TID | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | +------+--------------+------------+-----------+-----------+-------------+ | 8908 | round_to_txn | NULL | TABLE | IX | GRANTED | | 8908 | round_to_txn | PRIMARY | RECORD | X,GAP | GRANTED | | 8908 | round_to_txn | PRIMARY | RECORD | X | GRANTED | | 8907 | round_to_txn | NULL | TABLE | IX | GRANTED | | 8907 | round_to_txn | PRIMARY | RECORD | X,GAP | GRANTED | | 8907 | round_to_txn | PRIMARY | RECORD | X | GRANTED | +------+--------------+------------+-----------+-----------+-------------+ mysql\u0026gt; show engine innodb status\\G *************************** 1. row *************************** ------------ TRANSACTIONS ------------ Trx id counter 8913 Purge done for trx\u0026#39;s n:o \u0026lt; 8913 undo n:o \u0026lt; 0 state: running but idle History list length 2 LIST OF TRANSACTIONS FOR EACH SESSION: ---TRANSACTION 421651726690736, not started 0 lock struct(s), heap size 1128, 0 row lock(s) ---TRANSACTION 421651726689928, not started 0 lock struct(s), heap size 1128, 0 row lock(s) ---TRANSACTION 8908, ACTIVE 39 sec 31 lock struct(s), heap size 3488, 19 row lock(s), undo log entries 4 MySQL thread id 29087, OS thread handle 140175996847872, query id 66467 localhost root starting show engine innodb status TABLE LOCK table `test`.`round_to_txn` /* Partition `pother` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202306` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202305` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202304` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202303` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202302` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202301` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202212` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202211` */ trx id 8908 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202210` */ trx id 8908 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS ---TRANSACTION 8907, ACTIVE 50 sec 31 lock struct(s), heap size 3488, 19 row lock(s), undo log entries 4 MySQL thread id 29008, OS thread handle 140176595552000, query id 66460 localhost root TABLE LOCK table `test`.`round_to_txn` /* Partition `pother` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202306` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202305` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202304` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202303` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202302` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202301` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202212` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202211` */ trx id 8907 lock mode IX TABLE LOCK table `test`.`round_to_txn` /* Partition `p202210` */ trx id 8907 lock mode IX 10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS æˆ‘å€‘å¯ä»¥çœ‹åˆ°é€™ä¸€æ¬¡æ²’æœ‰ Insert Intention Locksï¼Œé€™æ˜¯å› ç‚º update çš„å€¼æ²’æœ‰å°è‡´è³‡æ–™éœ€è¦è¢«è®Šæ›´åˆ°åˆ¥çš„ partitionï¼Œæ‰€ä»¥åŠ é–çš„æƒ…æ³æœƒç­‰åŒæ–¼æ™®é€šçš„ update ä¸¦ä¸æœƒç”¢ç”Ÿ Insert Intention Locks å¾è€Œå°è‡´ DeadLock çš„ç™¼ç”Ÿã€‚\nçµè«– åœ¨æœ‰ partition çš„ Table ä¸ŠåŸ·è¡Œ UPDATE æ“ä½œæ›´æ–° partition key ç™¼ç”Ÿè·¨å€æ™‚ï¼Œæœƒå…ˆç”± UPDATE æ“ä½œç”¢ç”Ÿ Record Lock (æˆ– Next Key Lock ä¹Ÿå°±æ˜¯åŒ…å« Gap Lock)ï¼Œä¹‹å¾Œè½‰è®Šæˆ INSERT æ“ä½œå°‡è³‡æ–™å¡å…¥æ–°çš„åˆ†å€ã€‚\nå› æ­¤å¦‚æœå¯ä»¥ç›¡é‡é¿å…å» UPDATE æœ‰åˆ‡ partition çš„æ¬„ä½ã€‚\n","date":"2022-11-28T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-partition-deadlock/","title":"partition deadlock"},{"content":"semi-join ç•¶å…©å€‹ Table ä¹‹é–“é€²è¡Œ INNER JOIN æ™‚ï¼Œç•¶åŒä¸€å€‹å€¼æœ‰å¤šå€‹ç¬¦åˆçš„è¡Œï¼Œå°±æœƒè¿”å›åŒç­‰çš„æ•¸é‡ã€‚ä½†æ˜¯æœ‰æ™‚å€™ï¼Œæˆ‘å€‘åªåœ¨ä¹æ˜¯å¦æœ‰ç¬¦åˆçš„è¡Œï¼Œè€Œä¸æ˜¯ç¬¦åˆçš„æ•¸é‡ã€‚å‡è¨­ç•¶æˆ‘å€‘æƒ³çŸ¥é“æœ‰å“ªäº›å•†å“(product)è¢«è³¼è²·æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„èªæ³•ï¼š\n1 2 3 4 SELECT product.product_num , product.product_name FROM product INNER JOIN orders WHERE product.product_num = orders.product_num; ä½†æ˜¯ç•¶æœ‰ä¸€æ¨£å•†å“è¢«é‡è¤‡è³¼è²·æ™‚ï¼Œä¸Šè¿°æŸ¥è©¢æœƒç”¢ç”Ÿé‡è¤‡çš„çµæœã€‚\nç•¶ç„¶ä¹Ÿå¯ä»¥é€é DISTINCT ä¾†å»é™¤é‡è¤‡ï¼Œä½†å…ˆç”Ÿç”¢æ‰€æœ‰ç¬¦åˆçš„è¡Œæ‰å»é™¤é‡è¤‡ï¼Œå› æ­¤æ•ˆç‡å¾ˆä½ã€‚æ­¤æ™‚å¯ä»¥ä½¿ç”¨å­æŸ¥è©¢ä¾†ç²å¾—åŒæ¨£ä¸é‡è¤‡\n1 2 3 4 SELECT product.product_num , product.product_name FROM product WHERE product_num IN (SELECT product_num FROM orders); ä½¿ç”¨ä»¥ä¸Šèªæ³•å„ªåŒ–å™¨å¯ä»¥çŸ¥é“æ­¤è™•çš„ IN èªå¥è¦æ±‚å­æŸ¥è©¢åªéœ€è¦è¿”å›ä¸é‡è¤‡çš„ product_numï¼Œåœ¨æ­¤æƒ…æ³ä¸‹ï¼ŒæŸ¥è©¢æœƒä½¿ç”¨ semi-joinã€‚\nå¾ 8.0.16é–‹å§‹ï¼Œå¸¶æœ‰ EXISTSå­æŸ¥è©¢çš„èªå¥ï¼Œä¹Ÿèƒ½äº«å—åˆ° IN å­æŸ¥è©¢æ‰€ä½¿ç”¨çš„ semi-joinå„ªåŒ–ï¼\n1 2 3 4 SELECT product.product_num , product.product_name FROM product WHERE EXISTS (SELECT * FROM orders WHERE product.product_num = orders.product_num); anti-join å¾ 8.0.17 é–‹å§‹åŠ å…¥äº† anti-joinçš„å„ªåŒ–ï¼Œå’Œ semi-joinæ˜¯ç›¸åŒçš„ï¼Œå·®åˆ¥åœ¨æ–¼å¤šäº† NOTçš„ä¿®é£¾ï¼Œä»¥ä¸‹å­æŸ¥è©¢å°‡è¢«è½‰æ›ç‚º anti-joinï¼š\nNOT IN (SELECT \u0026hellip; FROM \u0026hellip;) *å­æŸ¥è©¢ä¸­ä¸å¯æœ‰NULLå€¼ NOT EXISTS (SELECT \u0026hellip; FROM \u0026hellip;) IN (SELECT \u0026hellip; FROM \u0026hellip;) IS NOT TRUE EXISTS (SELECT \u0026hellip; FROM \u0026hellip;) IS NOT TRUE IN (SELECT \u0026hellip; FROM \u0026hellip;) IS FALSE EXISTS (SELECT \u0026hellip; FROM \u0026hellip;) IS FALSE ç°¡è€Œè¨€ä¹‹ï¼Œåªè¦æ˜¯å¦å®šå¸¶æœ‰ IN (SELECT ... FROM ...) æˆ– EXISTS (SELECT ... FROM ...) çš„å­æŸ¥è©¢éƒ½æœƒè¢«è½‰æ›ç‚º anti-joinã€‚\nanti-join åªæœƒè¿”å›æ²’æœ‰ç¬¦åˆçš„è¡Œï¼Œè€ƒæ…®ä»¥ä¸‹æŸ¥è©¢ï¼\n1 2 3 4 SELECT product.product_num , product.product_name FROM product WHERE product_num NOT IN (SELECT product_num FROM orders); æ­¤æŸ¥è©¢æœƒåœ¨å…§éƒ¨è¢«æ”¹å¯«ç‚º anti-joinï¼Œå°æ–¼ product çš„æ¯ä¸€è¡Œè³‡æ–™ï¼Œåªè¦åœ¨ orders ä¸­æœ‰æ‰¾åˆ°ç¬¦åˆçš„è³‡æ–™ï¼Œ product å°±æœƒä¸Ÿæ£„ç¬¦åˆçš„è³‡æ–™ã€‚\næ­¤å¤–ç•¶é‡åˆ°è¡¨é”å¼æœ‰ NULLå€¼æ™‚ï¼Œå‰‡ç„¡æ³•è½‰æ›ç‚º anti-joinï¼Œé™¤éä½¿ç”¨ ... NOT IN (SELECT ...) IS NOT FALSEæˆ–åŒç­‰çš„ ... IN (SELECT ...) IS NOT TRUEæ‰èƒ½è½‰æ›ç‚º anti-joinã€‚\né©ç”¨æƒ…å¢ƒ å­æŸ¥è©¢è‹¥ç¬¦åˆä»¥ä¸‹æ¢ä»¶ï¼Œå°±èƒ½ä½¿ç”¨ semi-join(8.0.17 anti-join)ä¾†å„ªåŒ–\né€šç”¨è¦å‰‡ å¿…é ˆæ˜¯ IN æˆ– =ANY å‡ºç¾åœ¨æœ€å¤–å±¤çš„ WHEREæˆ– ONèªå¥ ä¸åŒ…å« UNIONçµæ§‹çš„ SINGAL SELECT ä¸åŒ…å« HAVING ä¸èƒ½åŒ…å«ä»»ä½•èšåˆå‡½æ•¸(SUMã€ MAX\u0026hellip;) ä¸åŒ…å« LIMIT ä¸åŒ…å« STRAIGHT_JOIN (æŒ‰ç…§æ’°å¯«é †åºåš INNER JOINçš„èªå¥) The number of outer and inner tables together must be less than the maximum number of tables permitted in a join. 5.7.* è¦å‰‡ ä¸åŒ…å« GROUP BY ä¸åŒ…å« ORDER BY ä¸åŒ…å« IS [NOT] TRUE|FALSE 8.0.16ä»¥ä¸Š è¦å‰‡ é™¤äº† IN æˆ– =ANY é‚„å¯ä»¥æ˜¯ EXISTS åœ¨æ²’æœ‰èšåˆå‡½æ•¸çš„æƒ…æ³ä¸‹ä½¿ç”¨ GROUP BYï¼Œä½†æœƒè¢«å¿½ç•¥æ‰ DISTINTCT å¯ä»¥ä½¿ç”¨ï¼Œä½†æœƒè¢«å¿½ç•¥æ‰ ORDER BY å¯ä»¥ä½¿ç”¨ï¼Œä½†æœƒè¢«å¿½ç•¥æ‰ ä¸åŒ…å« IS [NOT] TRUE|FALSE 8.0.17ä»¥ä¸Šè¦å‰‡ å¯ä»¥åŒ…å« IS [NOT] TRUE|FALSE æ³¨æ„ï¼š UPDATE å’Œ DELETE ç„¡æ³•ä½¿ç”¨ semi-join å„ªåŒ–ï¼Œå»ºè­°æ¡ç”¨ JOIN ä¾†é€²è¡Œå„ªåŒ–\nå„ªåŒ–æ–¹å¼ TablePullout\nå‡è¨­æœ‰ä»¥ä¸‹æŸ¥è©¢ï¼Œæ‰¾å‡ºæ‰€å±¬åŸå¸‚æœ‰å°æ–¼ç‰¹å®šäººå£æ•¸çš„åœ‹å®¶\n1 2 3 4 5 6 7 SELECT * FROM city WHERE city.country IN ( SELECT country.code FROM country WHERE country.population \u0026lt; 100*1000 ); ç•¶ conutry.codeåœ¨ country ä¸­ä¸é‡è¤‡(å³ç‚º PRIMARY KEYæˆ– UNIQUE INDEX) æ™‚ï¼Œå¯ä»¥ç›´æ¥æ”¹å¯«ç‚ºä¸€èˆ¬çš„ INNER JOINå³å¯ã€‚\n1 2 3 4 SELECT city.* FROM city,country WHERE city.country = country.code AND country.population \u0026lt; 100*1000; ç•¶è§¸ç™¼ TablePulloutæ™‚ï¼Œ EXPLAIN å¾Œ SHOW WARNINGS æ™‚å¯ä»¥çœ‹åˆ°èªå¥è¢«æ”¹å¯«ç‚º INNER JOIN\né©ç”¨æƒ…å¢ƒï¼š\noptimizer_switch ä¸­ semijoin=on (é è¨­) IN å­å¥ç•¶ä¸­çš„æ¬„ä½ï¼Œå¿…é ˆç‚ºè©²è¡¨çš„ PRIMARY KEY æˆ– UNIQUE INDEX FirstMatch\nå‡è¨­æœ‰ä»¥ä¸‹æŸ¥è©¢ï¼Œæ‰¾å‡ºæ‰€å±¬åŸå¸‚æœ‰è¶…éç‰¹å®šäººå£æ•¸çš„åœ‹å®¶\n1 2 3 4 5 6 7 SELECT * FROM country WHERE country.code IN ( SELECT city.country FROM city WHERE city.population \u0026gt; 1*1000*1000 ); å‡è¨­ä½¿ç”¨ INNER JOIN å¦‚ä¸‹åœ–ï¼Œå¯ä»¥çœ‹åˆ°å°±ç®—æ‰¾åˆ°äº†Germanyæœ‰ç¬¦åˆæ¢ä»¶çš„åŸå¸‚(Berlin)ï¼Œä»èˆŠæœƒç¯©é¸Germanyçš„ä¸‹ä¸€å€‹åŸå¸‚(Koln)ï¼Œå¾è€Œé€ æˆä¸å¿…è¦çš„ç¯©é¸èˆ‡é‡è¤‡çµæœ\nè‹¥ä½¿ç”¨ FirstMatch å‰‡å¦‚ä¸‹åœ–ï¼Œå¯ä»¥çœ‹å‡ºå€åˆ¥åœ¨æ–¼ç•¶æ‰¾åˆ°Germanyæœ‰ç¬¦åˆçš„åŸå¸‚(Berlin)ä¹‹å¾Œï¼Œå°±ä¸æœƒå†å¾€ä¸‹ç¢ºèªä¸‹ä¸€å€‹åŸå¸‚(Koln)ï¼Œè€Œæ˜¯æœƒç¢ºèªä¸‹ä¸€å€‹country Franceæ˜¯å¦æœ‰ç¬¦åˆçš„åŸå¸‚ï¼Œé¿å…äº†ä¸å¿…è¦çš„æª¢æŸ¥èˆ‡ç”¢ç”Ÿé‡è¤‡çš„çµæœ\nç•¶è§¸ç™¼ FirstMatchæ™‚ï¼Œ EXPLAIN ä¸­çš„ EXTRA ä¸­æœƒé¡¯ç¤º FirstMatch\né©ç”¨æƒ…å¢ƒï¼š\noptimizer_switchä¸­ firstmatch=on(é è¨­) å­æŸ¥è©¢ä¸­æ²’æœ‰ GROUP BY / èšåˆå‡½æ•¸ Duplicate Weedout\næ­¤æ–¹æ¡ˆæœƒå…ˆä½¿ç”¨ä¸€èˆ¬çš„ INNER JOIN ä¹‹å¾Œï¼Œä¸¦ä½¿ç”¨ è‡¨æ™‚è¡¨å»é™¤é‡è¤‡ã€‚å‡è¨­æœ‰ä¸€å€‹æŸ¥è©¢ç‚ºæ‰¾å‡ºæœ‰åŸå¸‚äººå£æ•¸è¶…éåœ‹å®¶ç¸½äººå£çš„33%ä»¥ä¸Šä¸”è¶…é 110001000\n1 2 3 4 5 6 7 8 SELECT * FROM country where country.code IN ( SELECT city.country FROM city WHERE city.population \u0026gt; 0.33 * country.population AND city.population \u0026gt; 1*1000*1000 ); å°é€™å…©å¼µè¡¨é€²è¡Œ INNER JOIN\né€éå¸¶æœ‰ PRIMARY KEYçš„ è‡¨æ™‚è¡¨ å°‡é‡è¤‡çš„è³‡æ–™é€²è¡Œéæ¿¾\nç•¶è§¸ç™¼ Duplicate Weedoutæ™‚ï¼Œæœƒåœ¨ EXPLAIN çš„ Extra ä¸­é¡¯ç¤º Start temporary; End temporary\né©ç”¨æƒ…å¢ƒï¼š\noptimizer_switchä¸­ duplicateweedout=on (é è¨­) å­æŸ¥è©¢ä¸­æ²’æœ‰ GROUP BY / èšåˆå‡½æ•¸ LooseScan\nå‡è¨­æœ‰ä»¥ä¸‹æŸ¥è©¢æ“æœ‰è¡›æ˜Ÿçš„åœ‹å®¶ï¼Œå…¶ä¸­ satellite.country_code æœ‰ INDEX\n1 2 3 4 5 6 SELECT * FROM country WHERE country.code IN ( SELECT country_code FROM satellite ); æ­¤æ™‚æœƒé€é INDEX å–å¾— GROUP BY çš„å‹•ä½œï¼Œä¾†é”åˆ°å»é™¤é‡è¤‡çš„ç›®çš„\nç•¶è§¸ç™¼ LooseScanæ™‚ï¼Œæœƒåœ¨ EXPLAIN çš„ Extra ä¸­é¡¯ç¤º LooseScan\né©ç”¨æƒ…å¢ƒï¼š\noptimizer_switchä¸­ looseScan=on (é è¨­)\nexpr IN (SELECT tbl.keypart1 FROM tbl ...) æˆ–\nexpr IN (SELECT tbl.keypart2 FROM tbl WHERE tbl.keypart1=const AND ...)\nmaterialization\nå‡è¨­æœ‰ä»¥ä¸‹æŸ¥è©¢è¦å°‹æ‰¾æ“æœ‰å¤§åŸå¸‚çš„æ­æ´²åœ‹å®¶\n1 2 3 4 5 6 7 SELECT * FROM country WHERE country.code IN ( SELECT city.country FROM city WHERE city.population \u0026gt; 7*1000*1000 ) AND country.continent = \u0026#39;Europe\u0026#39; æ­¤æ–¹æ¡ˆæœƒå…ˆåŸ·è¡Œ INå¾Œé¢çš„å­å¥ä¸¦å°‡çµæœå­˜å…¥ è‡¨æ™‚è¡¨ï¼Œè¡¨ä¸­æœ‰ PRIMARY KEYä¾†å»é™¤é‡è¤‡ï¼Œä¹‹å¾Œå†å’Œå¤–å´çš„Countryåš INNDER JOINä¾†ç¯©é¸æ­æ´²åœ‹å®¶\nç•¶è§¸ç™¼ materializationæ™‚ï¼Œæœƒåœ¨ EXPLAIN çš„ table ä¸­å‡ºç¾ \u0026lt;subquery\u0026gt; ä¸¦ä¸” select_type ä¸­æœƒå‡ºç¾ MATERIALIZED\nåƒè€ƒè³‡æ–™ MySQL 5.7 æ–‡æª”\nMySQL 8.0 æ–‡æª”\nMaria DB æ–‡æª”\nAntijoin in MySQL8(by MySQL Server Blog)\nanti-joinå¹¾é»ç¸½çµ(by çŸ¥ä¹-çŸ¥æ•¸å ‚)\n","date":"2022-07-01T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-semi-join-and-anti-join/","title":"semi-join(åŠé€£çµ)å’Œanti-join(åé€£çµ)"},{"content":"Password Verification-Required Policy MySQL 8.0.13 é–‹å§‹ï¼Œå¯ä»¥è¨­å®šåœ¨ä¿®æ”¹å¯†ç¢¼æ™‚éœ€è¦ä¸€ä½µæä¾›èˆŠå¯†ç¢¼ã€‚\nå¯é€éä»¥ä¸‹ 2 ç¨®æ–¹å¼è¨­å®š -\nå…¨åŸŸç³»çµ±è®Šæ•¸ password_require_current é è¨­å€¼ç‚º OFF ï¼Œå¯ä»¥é€éèª¿æ•´ç‚º ON è¦æ±‚ä¿®æ”¹å¯†ç¢¼æ™‚æä¾›å°±å¯†ç¢¼ã€‚\nCREATE æˆ– ALTER USER æ™‚åŠ ä¸Š PASSWORD REQUIRE CURRENT [DEFAULT | OPTIONAL] è¨­å®šã€‚\n1 2 3 4 5 6 7 8 9 10 -- admin å»ºç«‹å¸³è™Ÿ mysql\u0026gt; CREATE USER test@localhost IDENTIFIED BY \u0026#39;123\u0026#39; PASSWORD REQUIRE CURRENT; Query OK, 0 rows affected (0.00 sec) -- user ä¿®æ”¹å¯†ç¢¼ mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY \u0026#39;123\u0026#39;; ERROR 3892 (HY000): Current password needs to be specified in the REPLACE clause in order to change it. mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY \u0026#39;123\u0026#39; REPLACE \u0026#39;456\u0026#39;; Query OK, 0 rows affected (0.01 sec) PASSWORD REQUIRE CURRENTï¼šå¯†ç¢¼æ›´æ”¹å¿…é ˆæŒ‡å®šç•¶å‰å¯†ç¢¼ã€‚\nPASSWORD REQUIRE CURRENT OPTIONALï¼šå¯†ç¢¼æ›´æ”¹ä¸å¼·è¿«æŒ‡å®šç•¶å‰å¯†ç¢¼ã€‚\nPASSWORD REQUIRE CURRENT DEFAUTï¼šä¾ç…§å…¨åŸŸç³»çµ±è®Šæ•¸ password_require_current è¨­å®šã€‚\nğŸ’¡ NOTEï¼šç•¶ USER å…·æœ‰ global create user æ¬Šé™æˆ–è€…æ˜¯åœ¨ mysql database å…·æœ‰ update æ¬Šé™æ™‚ï¼Œå‰‡ä¸å—ä»»ä½•é™åˆ¶ï¼Œæ„å³ä¸éœ€è¦æä¾›èˆŠå¯†ç¢¼ã€‚\nåƒè€ƒ\nhttps://dev.mysql.com/doc/refman/8.0/en/password-management.html#password-reverification-policy\nhttps://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_password_require_current\né›™å¯†ç¢¼åŠŸèƒ½ (Dual Passwords) MySQL 8.0.14 é–‹å§‹åœ¨å¸³æˆ¶ç®¡ç†æ–°å¢äº† 2 å€‹å­å¥ï¼Œç”¨ä¾†æä¾›é›™å¯†ç¢¼çš„åŠŸèƒ½ï¼Œé€™æ¨£å°±å¯ä»¥åˆ†éšæ®µä¸”ä¸éœ€å„å–®ä½é…åˆä¹Ÿä¸éœ€è¦åœæ©Ÿçš„æ³ä¸‹æ›´æ›å¯†ç¢¼ã€‚\nRETAIN CURRENT PASSWORD å°‡ user ç•¶å‰(èˆŠ)å¯†ç¢¼æ›¿æ›ç‚ºç¬¬äºŒ(secondary)å¯†ç¢¼ï¼Œæ–°çš„å¯†ç¢¼å‰‡æœƒæˆç‚ºä¸»(primary)å¯†ç¢¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 mysql\u0026gt; CREATE USER test@localhost IDENTIFIED BY \u0026#39;123\u0026#39;; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY \u0026#39;456\u0026#39; RETAIN CURRENT PASSWORD; Query OK, 0 rows affected (0.04 sec) -- ä½¿ç”¨ secondary(èˆŠ) å¯†ç¢¼ç™»å…¥æˆåŠŸ [root@localhost ~]$ mysql -utest -p123 Your MySQL connection id is 82583 Server version: 8.0.21 MySQL Community Server - GPL -- ä½¿ç”¨ primary(æ–°) å¯†ç¢¼ç™»å…¥æˆåŠŸ [root@localhost ~]$ mysql -utest -p456 Your MySQL connection id is 82584 Server version: 8.0.21 MySQL Community Server - GPL æ–°èˆŠå¯†ç¢¼ç‚ºç©ºæ™‚ï¼Œç„¡æ³•æŒ‡å®š RETAIN CURRENT PASSWORDã€‚\n1 2 3 4 5 6 7 8 9 10 11 mysql\u0026gt; CREATE USER test@localhost; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; ALTER USER test@localhost identified by \u0026#39;123\u0026#39; RETAIN CURRENT PASSWORD; ERROR 3878 (HY000): Empty password can not be retained as second password for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39;. mysql\u0026gt; ALTER USER test@localhost identified by \u0026#39;123\u0026#39;; Query OK, 0 rows affected (0.02 sec) mysql\u0026gt; ALTER USER test@localhost identified by \u0026#39;\u0026#39; RETAIN CURRENT PASSWORD; ERROR 3895 (HY000): Current password can not be retained for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39; because new password is empty. ç•¶ user å·²æœ‰ç¬¬äºŒ(secondary)å¯†ç¢¼æ™‚ï¼Œåœ¨æœªæŒ‡å®š RETAIN CURRENT PASSWORD çš„æƒ…æ³ä¸‹æ›´æ”¹ä¸»(primary)å¯†ç¢¼ï¼Œç¬¬äºŒ(secondary)å¯†ç¢¼æœƒç¶­æŒä¸è®Šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 mysql\u0026gt; CREATE USER test@localhost IDENTIFIED BY \u0026#39;123\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY \u0026#39;456\u0026#39; RETAIN CURRENT PASSWORD; Query OK, 0 rows affected (0.00 sec) -- æ­¤æ™‚ 123 ç‚º secondary passwordï¼Œ 456 ç‚º parmary password mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY \u0026#39;789\u0026#39;; Query OK, 0 rows affected (0.00 sec) -- æ­¤æ™‚ 123 ç‚º secondary passwordï¼Œ 789 ç‚º parmary password -- ä½¿ç”¨ 123 ç™»å…¥æˆåŠŸ [root@localhost ~]$ mysql -utest -p123 Your MySQL connection id is 82583 Server version: 8.0.21 MySQL Community Server - GPL -- ä½¿ç”¨ 456 ç™»å…¥å¤±æ•— [root@localhost ~]$ mysql -utest -p456 ERROR 1045 (28000): Access denied for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39; (using password: YES) -- ä½¿ç”¨ 789 ç™»å…¥æˆåŠŸ [root@localhost ~]$ mysql -utest -p789 Your MySQL connection id is 82583 Server version: 8.0.21 MySQL Community Server - GPL mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY \u0026#39;abc\u0026#39; RETAIN CURRENT PASSWORD; Query OK, 0 rows affected (0.00 sec) -- æ­¤æ™‚ 789 ç‚º secondary passwordï¼Œ abc ç‚º parmary password ç•¶æ›´æ”¹èº«åˆ†é©—è­‰æ’ä»¶æ™‚ï¼Œç„¡æ³•æŒ‡å®š RETAIN CURRENT PASSWORDï¼Œä¸¦ä¸”æœƒå°‡ç¬¬äºŒ(secondary)å¯†ç¢¼ä¸Ÿæ£„ã€‚\nDISCARD OLD PASSWORD åˆªé™¤ç¬¬äºŒ(secondary)å¯†ç¢¼ã€‚\n1 2 3 4 5 ALTER USER test@localhost DISCARD OLD PASSWORD; -- ä½¿ç”¨ secondary password ç™»å…¥ [root@localhost ~]$ mysql -utest -p123 ERROR 1045 (28000): Access denied for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39; (using password: YES) åƒè€ƒ\nhttps://dev.mysql.com/doc/refman/8.0/en/alter-user.html\nhttps://dev.mysql.com/doc/refman/8.0/en/password-management.html#dual-passwords\nhttps://www.percona.com/blog/using-mysql-8-dual-passwords/\nç”Ÿæˆéš¨æ©Ÿå¯†ç¢¼(Random Password Generation) MySQL 8.0.18 é–‹å§‹åœ¨è¨­å®šå¯†ç¢¼çš„æ™‚å€™å¯ä»¥ä½¿ç”¨ RANDOM PASSWORD ä¾†ç‚º USER ç”Ÿæˆéš¨æ©Ÿå¯†ç¢¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mysql\u0026gt; CREATE USER test@localhost IDENTIFIED BY RANDOM PASSWORD; +------+-----------+----------------------+ | user | host | generated password | +------+-----------+----------------------+ | test | localhost | Oa-J)+nSI40_!TqIaYIt | +------+-----------+----------------------+ mysql\u0026gt; ALTER USER test@localhost IDENTIFIED BY RANDOM PASSWORD; +------+-----------+----------------------+ | user | host | generated password | +------+-----------+----------------------+ | test | localhost | XgtPCz\u0026gt;Sx)Yf8Sxhpg:D | +------+-----------+----------------------+ 1 row in set (0.02 sec) ç”Ÿæˆçš„å¯†ç¢¼é•·åº¦ç”±ç³»çµ±è®Šæ•¸ generated_random_password_length æ±ºå®šï¼Œé è¨­å€¼ç‚º 20ã€‚\nåƒè€ƒ\nhttps://dev.mysql.com/doc/refman/8.0/en/password-management.html#random-password-generation\nhttps://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_generated_random_password_length\nç™»å…¥å¤±æ•—è¿½è¹¤å’Œå¸³è™Ÿæš«æ™‚é–å®š(Failed-Login Tracking and Temporary Account Locking) MySQL 8.0.19 é–‹å§‹ï¼Œå¯ä»¥è¨­å®šç•¶è©²å¸³è™Ÿé€£çºŒè¼¸å…¥éŒ¯èª¤çš„å¯†ç¢¼æ™‚ï¼Œæš«æ™‚å°‡å¸³è™Ÿé–å®šã€‚\nFAILED_LOGIN_ATTEMPTS Nï¼šè¡¨ç¤ºç•¶é€£çºŒè¼¸å…¥ N æ¬¡éŒ¯èª¤å¯†ç¢¼æ™‚ï¼Œå°‡æœƒè§¸ç™¼é–å®šã€‚ PASSWORD_LOCK_TIME {N | UNBOUNDED}ï¼šè¡¨ç¤ºè¦é–å®š N å¤©ï¼Œå…¶ä¸­ UNBOUNDED è¡¨ç¤ºæ°¸ä¹…é–å®šç›´åˆ°è¢«è§£é–ã€‚ ä»¥ä¸Š N çš„å…è¨±å€¼ç‚º 0~32767ï¼Œå…¶ä¸­ 0 è¡¨ç¤ºç¦ç”¨ï¼Œé è¨­å€¼çš†ç‚º 0ã€‚åªæœ‰ç•¶å…©å€‹ N éƒ½ä¸ç‚º 0 ï¼Œæ‰èƒ½ä½¿ç”¨åˆ°æ­¤åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # å»ºç«‹å¸³è™Ÿï¼Œä¸¦è¨­å®šç•¶å¯†ç¢¼é€£çºŒè¼¸å…¥éŒ¯èª¤ 3æ¬¡æ™‚ï¼Œå‰‡æœƒé–å®š 3 å¤© mysql\u0026gt; CREATE USER test@localhost IDENTIFIED BY \u0026#39;123\u0026#39; -\u0026gt; FAILED_LOGIN_ATTEMPTS 3 PASSWORD_LOCK_TIME 3; Query OK, 0 rows affected (0.02 sec) [root@localhost ~]$ mysql -utest -p Enter password: ERROR 1045 (28000): Access denied for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39; (using password: YES) [root@localhost ~]$ mysql -utest -p Enter password: ERROR 1045 (28000): Access denied for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39; (using password: YES) [root@localhost ~]$ mysql -utest -p Enter password: ERROR 3955 (HY000): Access denied for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39;. Account is blocked for 3 day(s) (3 day(s) remaining) due to 3 consecutive failed logins. -- error log 2021-07-07T08:13:23.364124Z 86982 [Note] [MY-010914] [Server] Access denied for user \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39;. Account is blocked for 3 day(s) (3 day(s) remaining) due to 3 consecutive failed logins. ä»¥ä¸‹æ–¹å¼å¯ä»¥é‡ç½®è¨ˆæ•¸ä¸¦è§£é–æ‰€æœ‰å¸³è™Ÿï¼š\né‡å•Ÿ server åŸ·è¡Œ FLUSH PRIVILEGES ä»¥ä¸‹ç‹€æ³æœƒé‡ç½®è¨ˆæ•¸æˆ–è§£é–å€‹åˆ¥å¸³è™Ÿï¼š\næˆåŠŸç™»å…¥\næŒçºŒé–å®šçš„æ™‚é–“å·²é\nä½¿ç”¨ ALTER USER è®Šæ›´é–å®šè¨­å®šï¼Œæˆ–è€…æ˜¯ä½¿ç”¨ ACCOUNT UNLOCK èªå¥ã€‚\n1 2 3 4 5 6 7 # è®Šæ›´é–å®šè¨­å®šä¹Ÿæœƒé‡ç½® mysql\u0026gt; ALTER USER test@localhost FAILED_LOGIN_ATTEMPTS 3 PASSWORD_LOCK_TIME 1; Query OK, 0 rows affected (0.02 sec) # ä½¿ç”¨ ALTER USER ... ACCOUNT UNLOCK è§£é– mysql\u0026gt; ALTER USER \u0026#39;test\u0026#39;@\u0026#39;localhost\u0026#39; ACCOUNT UNLOCK; Query OK, 0 rows affected (0.00 sec) åƒè€ƒ\nhttps://dev.mysql.com/doc/refman/8.0/en/password-management.html#failed-login-tracking\n","date":"2021-07-12T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-account-manage-new-feature/","title":"MySQL8.0 æ–°å¢çš„å¸³è™Ÿç®¡ç†åŠŸèƒ½"},{"content":"åœ¨ MySQL 8.0.16 ä¹‹å‰ï¼Œå¦‚æœæˆ‘å€‘è¦çµ¦äºˆ USER é™¤äº†æŸå€‹ DATABASE ä»¥å¤–éƒ½æœ‰æ¬Šé™ï¼Œåªèƒ½å¤ æ¯å€‹ DATABASE éƒ½ GRANT ä¸€æ¬¡æ¬Šé™ï¼Œé€™æ–¹é¢æœ‰æ™‚å€™ä¸¦ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚ä¾‹å¦‚ï¼šç¸½å…±æœ‰ 100 å€‹ DATABASE å…¶ä¸­åªæœ‰ 1 å€‹ä¸çµ¦äºˆ USER æ¬Šé™ï¼Œæˆ‘å€‘å°±éœ€è¦åŸ·è¡Œ 99 å€‹ GRANT èªæ³•ã€‚\nå¾ MySQL 8.0.16 é–‹å§‹ï¼Œæ¨å‡ºäº†å¯ä»¥å›æ”¶éƒ¨åˆ†æ¬Šé™ (Partial Revokes) çš„åŠŸèƒ½ï¼Œå°‡ç²—ç²’åº¦çš„ GRANT æ¬Šé™ç”¨ REVOKE æ”¶å›ä¸€éƒ¨åˆ†ç´°ç²’åº¦æ¬Šé™ï¼Œå¤§å¤§å¢åŠ äº†é€™æ–¹é¢éœ€æ±‚çš„æ–¹ä¾¿æ€§ã€‚\nå±•ç¤º ç›®æ¨™æ˜¯çµ¦äºˆ USER é™¤äº† mysql.* ä»¥å¤–çš„æ‰€æœ‰æ¬Šé™ï¼Œè«‹æŸ¥çœ‹ä»¥ä¸‹ç¯„ä¾‹ï¼š\nç•¶ MySQL ç‰ˆæœ¬ä½æ–¼ 8.0.16 æˆ–è€…é—œé–‰ partial revokes åŠŸèƒ½ï¼Œæˆ‘å€‘åªèƒ½é€ä¸€çµ¦äºˆå…¶ä»– DB æ¬Šé™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 -- BEFORE MySQL 8.0.16ï¼Œæˆ–é—œé–‰ partial revokes åŠŸèƒ½ mysql\u0026gt; SHOW GLOBAL VARIABLES LIKE \u0026#39;partial_revokes\u0026#39;; +-----------------+-------+ | Variable_name | Value | +-----------------+-------+ | partial_revokes | OFF | +-----------------+-------+ 1 row in set (0.00 sec) mysql\u0026gt; SHOW GRANTS FOR test@localhost; +-------------------------------------------+ | Grants for test@localhost | +-------------------------------------------+ | GRANT SELECT ON *.* TO `test`@`localhost` | +-------------------------------------------+ 1 row in set (0.00 sec) mysql\u0026gt; REVOKE SELECT ON mysql.* FROM test@localhost; ERROR 1141 (42000): There is no such grant defined for user \u0026#39;test\u0026#39; on host \u0026#39;localhost\u0026#39; mysql\u0026gt; REVOKE SELECT ON *.* FROM test@localhost; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; GRANT SELECT ON test.* TO test@localhost; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; GRANT SELECT ON performance_schema.* TO test@localhost; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; GRANT SELECT ON sys.* TO test@localhost; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; SHOW GRANTS FOR test@localhost; +--------------------------------------------------------------+ | Grants for test@localhost | +--------------------------------------------------------------+ | GRANT USAGE ON *.* TO `test`@`localhost` | | GRANT SELECT ON `sys`.* TO `test`@`localhost` | | GRANT SELECT ON `test`.* TO `test`@`localhost` | | GRANT SELECT ON `performance_schema`.* TO `test`@`localhost` | +--------------------------------------------------------------+ 5 rows in set (0.00 sec) ç•¶ MySQL ç‰ˆæœ¬ä¸å°æ–¼ 8.0.16 ä¸”é–‹å•Ÿ partial revokes åŠŸèƒ½ï¼Œå°±èƒ½å¾ˆæ–¹ä¾¿çš„å®Œæˆéœ€æ±‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 -- AFTER MySQL 8.0.16ï¼Œä¸¦é–‹å•Ÿ partial revokes åŠŸèƒ½ mysql\u0026gt; SET GLOBAL partial_revokes = ON; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; SHOW GLOBAL VARIABLES LIKE \u0026#39;partial_revokes\u0026#39;; +-----------------+-------+ | Variable_name | Value | +-----------------+-------+ | partial_revokes | ON | +-----------------+-------+ 1 row in set (0.00 sec) mysql\u0026gt; REVOKE SELECT ON mysql.* FROM `test`@`localhost`; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; SHOW GRANTS FOR test@localhost; +----------------------------------------------------+ | Grants for test@localhost | +----------------------------------------------------+ | GRANT SELECT ON *.* TO `test`@`localhost` | | REVOKE SELECT ON `mysql`.* FROM `test`@`localhost` | +----------------------------------------------------+ 2 rows in set (0.00 sec) åƒè€ƒ MySQL æ–‡æª” - GRANT Statement\n","date":"2021-03-12T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-partial-revokes/","title":"MySQL8.0.16 æ–°å¢ partial revokes åŠŸèƒ½"},{"content":"Skip Scan Range ç•¶æŸ¥è©¢æƒ³è¦é€é index å„ªåŒ–æ™‚ï¼Œéœ€è¦éµå¾ªæœ€å·¦å‰ç¶´çš„åŸå‰‡ï¼Œæ„å³è‹¥æœ‰ index(A,B)ï¼ŒæŸ¥è©¢æ¢ä»¶åªæœ‰ A = ? å’Œ A = ? AND B = ? æ‰èƒ½åƒåˆ°é€™å€‹ indexï¼Œ B = ? çš„æ¢ä»¶å‰‡ç„¡æ³•åˆ©ç”¨åˆ°é€™å€‹ index\nå¾ MySQL 8.0.13 é–‹å§‹æ–°å¢äº†ä¸€å€‹å„ªåŒ–ï¼Œè®“æŸäº›æƒ…æ³ä¸‹ B = ? çš„æ¢ä»¶å¯ä»¥é€éé€™å€‹ index å„ªåŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 CREATE TABLE t1 (id int NOT NULL AUTO_INCREMENT,f1 INT NOT NULL, f2 INT NOT NULL, PRIMARY KEY(id),KEY test(`f1`,`f2`)); INSERT INTO t1(f1,f2) VALUES(1,1), (1,2), (1,3), (1,4), (1,5),(2,1), (2,2), (2,3), (2,4), (2,5); INSERT INTO t1(f1,f2) SELECT f1, f2 + 5 FROM t1; INSERT INTO t1(f1,f2) SELECT f1, f2 + 10 FROM t1; INSERT INTO t1(f1,f2) SELECT f1, f2 + 20 FROM t1; INSERT INTO t1(f1,f2) SELECT f1, f2 + 40 FROM t1; ANALYZE TABLE t1; EXPLAIN SELECT f1, f2 FROM t1 WHERE f2 \u0026gt; 40; -- 8.0.13ä»¥ä¸Šï¼Œä¸¦ä¸”skip_scan=on (default) +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------------+ | 1 | SIMPLE | t1 | NULL | range | f1 | f1 | 8 | NULL | 53 | 100.00 | Using where; Using index for skip scan | +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+----------------------------------------+ -- 8.0.13ä»¥ä¸‹ï¼Œæˆ– skip_scan=off +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+ | 1 | SIMPLE | t1 | NULL | index | NULL | f1 | 8 | NULL | 160 | 33.33 | Using where; Using index | +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+ å¯¦ç¾æ–¹å¼:1. åœ¨ç´¢å¼•å‰ç¶´(f1) scan å‡º distinct å€¼2. å°å…¶é¤˜ç´¢å¼•æ¬„ä½(f2)ï¼Œå»ºæ§‹subrange scanç°¡å–®ä¾†èªªï¼Œå°±æ˜¯æœƒå°‡å…¶è½‰åŒ–ç‚ºå¤šå€‹å­ç¯„åœæƒæï¼Œä»¥æ­¤ç¯„ä¾‹æœ‰é»é¡ä¼¼ä»¥ä¸‹æŸ¥è©¢ï¼š\n1 2 SELECT f1, f2 FROM t1 WHERE f1 = 1 AND f2 \u0026gt; 40; SELECT f1, f2 FROM t1 WHERE f1 = 2 AND f2 \u0026gt; 40; ä¸»è¦é™åˆ¶ï¼š\nå¿…é ˆæ˜¯è¤‡åˆç´¢å¼•ï¼ŒEXï¼šKEY(A,B,C)\nåªä½¿ç”¨äº†ä¸€å¼µè¡¨\nä¸èƒ½æœ‰ group by å’Œ select distinct\nä¸èƒ½å›è¡¨ï¼Œæ„å³ query ä¸­çš„selectã€where åªæœ‰ä½¿ç”¨è©² index(å«pk) çš„æ¬„ä½\nåƒè€ƒï¼š\nMySQL å®˜æ–¹æ–‡æª” MySQL WL#11322 [æ•¸æ“šåº«å…§æ ¸æœˆå ±(2019/05)](http://mysql.taobao.org/monthly/2019/05/06/ ","date":"2021-02-26T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-skip-scan-range/","title":"MySQL8.0 skip scan range å„ªåŒ–"},{"content":"MySQL å¾ 8.0.23 é–‹å§‹æ”¯æŒåœ¨å‰µå»º user æ™‚ä½¿ç”¨ netmask é®ç½©ä¾†é™åˆ¶ç”¨æˆ¶çš„è¨ªå•ç¯„åœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 mysql\u0026gt; SELECT @@version; +-----------+ | @@version | +-----------+ | 8.0.23 | +-----------+ 1 row in set (0.00 sec) mysql\u0026gt; create user test@\u0026#39;172.17.0.0/24\u0026#39; identified by \u0026#39;test\u0026#39;; Query OK, 0 rows affected (0.01 sec) mysql\u0026gt; select user,host from mysql.user; +------------------+---------------+ | user | host | +------------------+---------------+ | test | 172.17.0.0/24 | ... +------------------+---------------+ HOST 172.17.0.1 \u0026gt; mysql -utest -p --host 172.17.0.5 Enter password: Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 20 Server version: 8.0.23 MySQL Community Server - GPL åƒè€ƒ https://dev.mysql.com/doc/refman/8.0/en/account-names.html\n","date":"2021-02-26T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-user-netmask/","title":"MySQL8.0.23 user æ”¯æŒ netmask é®ç½©"},{"content":"Continuous Queries(CQ) é¡ä¼¼æ–¼ MySQL çš„ Event å¯ä»¥è‡ªå‹•å®šæœŸçš„åŸ·è¡Œ queryï¼Œä¸¦å°‡çµæœå„²å­˜åˆ°ç‰¹å®šçš„ measurement ã€‚\nCQ çš„ä½¿ç”¨å ´æ™¯ æ¡æ¨£å’Œæ•¸æ“šä¿ç•™ï¼šé€é CQ å’Œ RP æ¸›è¼•å„²å­˜å£“åŠ›ï¼Œé€éå°‡é«˜ç²¾åº¦æ•¸æ“šæ¡æ¨£æˆä½ç²¾åº¦æ•¸æ“šï¼Œå†è®“ RP å°‡é‡è¦åº¦ä¸é«˜çš„é«˜ç²¾åº¦æ•¸æ“š purge æ‰ã€‚ é å…ˆè¨ˆç®—æ˜‚è²´çš„æŸ¥è©¢ï¼šé€éä½¿ç”¨ CQ é å…ˆå°‡é«˜ç²¾åº¦æ•¸æ“šæ¡æ¨£åˆ°è¼ƒä½ç²¾åº¦ï¼Œå†ä½¿ç”¨ä½ç²¾åº¦çš„æ•¸æ“šæŸ¥è©¢å°‡èŠ±è²»è¼ƒå°‘çš„æ™‚é–“ã€‚ æ›¿ä»£ HAVING å­å¥ï¼š InfluxDB ä¸æ”¯æŒ SQL ä¸­çš„ HAVING å­å¥ï¼Œå› æ­¤å¯ä»¥é€é CQ å…ˆå°‡ GROUP BY è¨ˆç®—å¾Œçš„çµæœå¯«å…¥å¦ä¸€å€‹ measurementï¼Œéš¨å¾Œå†é€é WHERE æ¢ä»¶å¾æ–°çš„ measurement ä¸­éæ¿¾è³‡æ–™ã€‚ åŸºæœ¬ CQ èªæ³• 1 2 3 4 CREATE CONTINUOUS QUERY \u0026lt;cq_name\u0026gt; ON \u0026lt;database_name\u0026gt; BEGIN \u0026lt;cq_query\u0026gt; END \u0026lt;cq_query\u0026gt; 1 2 3 4 5 SELECT \u0026lt;function[s]\u0026gt; INTO \u0026lt;destination_measurement\u0026gt; FROM \u0026lt;measurement\u0026gt; [WHERE \u0026lt;stuff\u0026gt;] GROUP BY time(\u0026lt;interval\u0026gt;)[,\u0026lt;tag_key[s]\u0026gt;] cq_query å…§ä¸­å¿…é ˆè¦æœ‰ functionã€ INTO å’Œ GROUP BY time() é€™3å€‹è¦ç´ ã€‚\nGROUP BY time() ä¸­çš„ \u0026lt;interval\u0026gt; åŒæ™‚ä¹Ÿæ˜¯ CQ åŸ·è¡Œçš„é »ç‡ã€‚\ncq_query ä¸­çš„ WHERE ä¸éœ€è¦æ™‚é–“ç¯„åœï¼Œå°±ç®—å¯«äº†ä¹Ÿæœƒè¢«å¿½ç•¥ï¼Œå› ç‚º InfluxDB æœƒåœ¨åŸ·è¡Œæ™‚è‡ªå‹•å¸¶å…¥ now() ~ now() - \u0026lt;interval\u0026gt; çš„æ™‚é–“ç¯„åœã€‚\nGROUP BY time() é™¤äº† interval ä¹ŸåŒæ¨£å¯ä»¥åŠ ä¸Š offset_intervalã€‚å¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 CREATE CONTINUOUS QUERY \u0026#34;cq_cpu_average\u0026#34; ON \u0026#34;test\u0026#34; BEGIN SELECT mean(\u0026#34;loading\u0026#34;) INTO \u0026#34;cpu_average_loading\u0026#34; FROM \u0026#34;cpu\u0026#34; GROUP BY time(1h,15m) END å‡è¨­åœ¨ 16:00 æ–°å¢æ­¤ CQï¼Œå‰‡å°‡åœ¨ 16:15 åŸ·è¡Œ 15:15 ~ 16:14.99999999 çš„è³‡æ–™é‹ç®—ã€‚\nå’Œä¸€èˆ¬çš„ SELECT INTO ä¸€æ¨£ï¼Œå¯ä»¥åœ¨ INTO \u0026lt;destination_measurement\u0026gt; ä¸­ä½¿ç”¨åå‘å¼•ç”¨èªæ³• :MEASUREMENã€‚åœ¨ FROM å¯ä»¥ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ã€‚å¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 CREATE CONTINUOUS QUERY \u0026#34;cq_average\u0026#34; ON \u0026#34;test\u0026#34; BEGIN SELECT mean(*) INTO \u0026#34;test\u0026#34;.\u0026#34;autogen\u0026#34;.:MEASUREMENT FROM /.*/ GROUP BY time(30m),* END åŸºæœ¬ CQ èªæ³•ä¸æ”¯æŒä½¿ç”¨ fill() æ›´æ”¹ä¸å«æ•¸æ“šçš„é–“éš”ä¹‹å›å‚³å€¼ï¼Œå› æ­¤ç•¶è©²æ®µå€é–“æ²’æœ‰è³‡æ–™å°‡ä¸å¯«å…¥ä»»ä½•çµæœï¼Œå¯ä»¥ä½¿ç”¨é€²éšèªæ³•è™•ç†ã€‚\nCQ èªæ³•ä¸æœƒå°èˆŠæœ‰çš„å€é–“åŸ·è¡Œï¼Œè«‹æ‰‹å‹•ä½¿ç”¨ SELECT INTO èªæ³•ã€‚\nç”±æ–¼ç•¶èªæ³•ä¸­æœªåŒ…å« GROUP BY * æ™‚ï¼ŒåŸè¡¨çš„ tag åœ¨æ–°è¡¨å°‡è¢«è½‰æ›ç‚º fieldï¼Œå› æ­¤åŸæœ¬ç”¨ tag å€åˆ¥çš„æ•¸æ“šè¢« overwriteï¼Œé€™å¯èƒ½å°è‡´æ•¸æ“šçš„ä¸Ÿå¤±ã€‚è‹¥è¦ä¿ç•™ tag è«‹å‹™å¿…åŠ ä¸Š GROUP BY *ã€‚\né€²éš CQ èªæ³• 1 2 3 4 5 CREATE CONTINUOUS QUERY \u0026lt;cq_name\u0026gt; ON \u0026lt;database_name\u0026gt; RESAMPLE EVERY \u0026lt;interval\u0026gt; FOR \u0026lt;interval\u0026gt; BEGIN \u0026lt;cq_query\u0026gt; END å¯ä»¥çœ‹åˆ°é€²éš CQ èªæ³•å¤šäº† 2 å€‹å…ƒç´ ï¼\nEVERY \u0026lt;interval\u0026gt;ï¼šå®šç¾© CQ åŸ·è¡Œçš„é–“éš”ã€‚ å‡è¨­ åœ¨ EVERY ä¸­å°æ–¼(\u0026lt;) GROUP BYï¼Œå‰‡æ¯ EVERY æ™‚é–“åŸ·è¡ŒæŸ¥è©¢ GROUP BY æ™‚é–“ç¯„åœçš„è³‡æ–™ï¼š\n1 2 3 4 5 6 7 8 CREATE CONTINUOUS QUERY \u0026#34;cq_every\u0026#34; ON \u0026#34;test\u0026#34; RESAMPLE EVERY 30m BEGIN SELECT mean(\u0026#34;loading\u0026#34;) INTO \u0026#34;result_measurement\u0026#34; FROM \u0026#34;source_measurement\u0026#34; GROUP BY time(1h) END ç•¶æ²’æœ‰ RESAMPLE EVERY 30mï¼š\nåœ¨ 8:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 7:00 , 8:00 ) åœ¨ 9:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 8:00 , 9:00 ) ç•¶æœ‰ RESAMPLE EVERY 30mï¼š\nåœ¨ 8:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 7:00 , 8:00 ) åœ¨ 8:30 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 8:00 , 9:00 ) åœ¨ 9:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 8:00 , 9:00 )ï¼Œç”±æ–¼åŸ·è¡Œå‡ºä¾†çš„ time æ¬„ä½å’Œ 8:30 ç›¸åŒï¼Œå› æ­¤æœƒè¦†è“‹ä¸Šä¸€æ¬¡ 8:30 åŸ·è¡Œ CQ çš„çµæœã€‚ å‡è¨­ åœ¨ EVERY ä¸­ç­‰æ–¼(=) GROUP BYï¼Œå‰‡å’ŒåŸºæœ¬èªæ³•ç›¸åŒæ²’æœ‰ä»»ä½•å½±éŸ¿ã€‚\nå‡è¨­ åœ¨ EVERY ä¸­å¤§æ–¼(\u0026gt;) GROUP BYï¼Œå‰‡åŸ·è¡Œæ™‚é–“å’Œæ™‚é–“ç¯„åœéƒ½ä»¥ EVERY ç‚ºä¸»ï¼š\n1 2 3 4 5 6 7 8 CREATE CONTINUOUS QUERY \u0026#34;cq_every\u0026#34; ON \u0026#34;test\u0026#34; RESAMPLE EVERY 2h BEGIN SELECT mean(\u0026#34;loading\u0026#34;) INTO \u0026#34;result_measurement\u0026#34; FROM \u0026#34;source_measurement\u0026#34; GROUP BY time(1h) END ç•¶æ²’æœ‰ RESAMPLE EVERY 2hï¼š\nåœ¨ 8:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 7:00 , 8:00 ) åœ¨ 9:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 8:00 , 9:00 ) ç•¶æœ‰ RESAMPLE EVERY 2hï¼š\nåœ¨ 8:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 6:00 , 8:00 ) åœ¨ 10:00 åŸ·è¡Œ CQï¼Œè³‡æ–™ç¯„åœ [ 8:00 , 10:00 ) FOR \u0026lt;interval\u0026gt;ï¼šå®šç¾© CQ åŸ·è¡Œæ™‚æŸ¥è©¢çš„æ™‚é–“ç¯„åœã€‚ å‡è¨­ åœ¨ FOR ä¸­å¤§æ–¼(\u0026gt;) GROUP BYï¼Œå‰‡æ¯éš” GROUP BY æ™‚é–“åŸ·è¡ŒæŸ¥è©¢ FOR æ™‚é–“ç¯„åœçš„è³‡æ–™ï¼Œä½†æœƒä»¥ GROUP BY æ™‚é–“åˆ†çµ„ï¼š\n1 2 3 4 5 6 7 8 CREATE CONTINUOUS QUERY \u0026#34;cq_every\u0026#34; ON \u0026#34;test\u0026#34; RESAMPLE FOR 1h BEGIN SELECT mean(\u0026#34;loading\u0026#34;) INTO \u0026#34;result_measurement\u0026#34; FROM \u0026#34;source_measurement\u0026#34; GROUP BY time(30m) END ç•¶æ²’æœ‰ RESAMPLE FOR 1hï¼š\nåœ¨ 8:00 åŸ·è¡Œ CQ è³‡æ–™ç¯„åœ [ 7:30 , 8:00 ) åœ¨ 8:30 åŸ·è¡Œ CQ è³‡æ–™ç¯„åœ [ 8:00 , 8:30 ) ç•¶æœ‰ RESAMPLE FOR 1hï¼š\nåœ¨ 8:00 åŸ·è¡Œ CQ è³‡æ–™ç¯„åœ [ 7:00 , 8:00 )ï¼Œç”¢ç”Ÿ 2 å€‹ Point [ 7:00 , 7:30 ) å’Œ [ 7:30 , 8:00 ) åœ¨ 8:30 åŸ·è¡Œ CQ è³‡æ–™ç¯„åœ [ 7:30 , 8:30 )ï¼Œç”¢ç”Ÿ 2 å€‹ Point [ 7:30 , 8:00 ) å’Œ [ 8:00 , 8:30 ) åœ¨ 9:00 åŸ·è¡Œ CQ è³‡æ–™ç¯„åœ [ 8:00 , 9:00 )ï¼Œç”¢ç”Ÿ 2 å€‹ Point [ 8:00 , 8:30 ) å’Œ [ 8:30 , 9:00 ) å‡è¨­ åœ¨ FOR ä¸­ç­‰æ–¼(=) GROUP BYï¼Œå‰‡å’ŒåŸºæœ¬èªæ³•ç›¸åŒæ²’æœ‰ä»»ä½•å½±éŸ¿ã€‚\nå‡è¨­ åœ¨ FOR ä¸­å°æ–¼(\u0026lt;) GROUP BYï¼Œå‰‡ä¸å…è¨±å»ºç«‹æ­¤ CQã€‚\nSHOW CQ é¡¯ç¤ºæ‰€æœ‰çš„ CQ ï¼Œæœƒä¾ç…§ database é€²è¡Œåˆ†çµ„é¡¯ç¤ºã€‚\n1 SHOW CONTINUOUS QUERIES DROP CQ å¾ä¸€å€‹æŒ‡å®šçš„ database åˆªé™¤ CQã€‚\n1 DROP CONTINUOUS QUERY \u0026lt;cq_name\u0026gt; ON \u0026lt;database_name\u0026gt; ä¿®æ”¹ CQ CQ å»ºç«‹å¾Œç„¡æ³•ä¿®æ”¹ï¼Œåªèƒ½ DROP ä¹‹å¾Œé‡æ–° CREATEã€‚\n","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/continuous-queries/","title":"InfluxDB 1.X CQ"},{"content":"InfluxDB is not CRUD é¦–å…ˆæˆ‘å€‘è¦äº†è§£åˆ° InfluxDB æ˜¯é‡å°æ™‚é–“åºåˆ—æ•¸æ“šé€²è¡Œå„ªåŒ–çš„æ•¸æ“šåº«ï¼Œä¸¦ä¸”æ™‚é–“åºåˆ—çš„æ•¸æ“šé€šå¸¸åªæœƒå¯«å…¥ä¸€æ¬¡ï¼Œå¾ˆå°‘æœƒç™¼ç”Ÿæ›´æ–°çš„æƒ…å¢ƒï¼Œå› æ­¤ InfluxDB æ²’æœ‰å®Œæ•´çš„ CRUDï¼Œå®˜æ–¹å°‡å…¶ç¨±ç‚º CR-udã€‚\nç›¸æ¯” UPDATE å’Œ DELETE æ›´è‘—é‡åœ¨ CREATE å’Œ READ ä¸Šï¼Œç‚ºäº†è®“ CREATE å’Œ READ æ€§èƒ½æ›´é«˜ï¼Œ UPDATE å’Œ DELETE æ“ä½œæœ‰ä»¥ä¸‹çš„é™åˆ¶ï¼š\nå¦‚æœè¦ UPDATE ä¸€å€‹ pointï¼Œåªèƒ½é€é INSERT ä¸€å€‹å…·æœ‰ç›¸åŒ series + timestamp çš„ point ä¸å¯æ ¹æ“š field value åˆªé™¤æ•¸æ“šï¼Œå¯ä»¥å…ˆé€é READ å–å¾— timestampï¼Œéš¨å¾Œåœ¨é€é timestamp é€²è¡Œåˆªé™¤ã€‚ ä¸èƒ½å¤  UPDATE æˆ– RENAME tags ï¼Œæœ‰é—œæ›´å¤šè¨Šæ¯å¯ä»¥åƒè€ƒ github ä¸èƒ½å¤ é€é tag key åˆªé™¤ tag InfluxQL (v1.x SQL LIKE) Database Manage Query Show Schema INSERT SELECT Continuous Queries æ¬Šé™ FLUX (v2.0 JavaScript LIKE) åƒè€ƒ Influx Query Language (InfluxQL) reference - influxdata æ–‡æª”\nExplore your schema using InfluxQL - influxdata æ–‡æª”\nManage your database - influxdata æ–‡æª”\nExplore data using InfluxQL\n","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/","title":"InfluxDB 1.X CR-ud"},{"content":"CREATE DATABASE 1 CREATE DATABASE \u0026lt;database_name\u0026gt; [WITH [DURATION \u0026lt;duration\u0026gt;] [REPLICATION \u0026lt;n\u0026gt;] [SHARD DURATION \u0026lt;duration\u0026gt;] [NAME \u0026lt;retention-policy-name\u0026gt;]] WITH å¾Œé¢æ˜¯å¯é¸çš„ï¼Œç”¨ä¾†ç‚º database è¨­å®š retention policyï¼Œè‹¥æ²’æœ‰æŒ‡å®šå‰‡æœƒé è¨­ç‚º autogen\nç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026gt; CREATE DATABASE test \u0026gt; SHOW DATABASES name: databases name ---- _internal test \u0026gt; CREATE DATABASE test2 WITH DURATION 3d REPLICATION 1 SHARD DURATION 1h NAME \u0026#34;liquid\u0026#34; \u0026gt; SHOW DATABASES name: databases name ---- _internal test test2 DROP DATABASE 1 DROP DATABASE \u0026lt;database_name\u0026gt; USE DATABASE 1 USE \u0026lt;database_name\u0026gt; CREATE Retention policy 1 CREATE RETENTION POLICY \u0026lt;retention_policy_name\u0026gt; ON \u0026lt;database_name\u0026gt; DURATION \u0026lt;duration\u0026gt; REPLICATION \u0026lt;n\u0026gt; [SHARD DURATION \u0026lt;duration\u0026gt;] [DEFAULT] DURATIONï¼šç”¨ä¾†å®šç¾© InfluxDB æœƒä¿å­˜æ•¸æ“šå¤šä¹…ã€‚\næ ¼å¼ç‚º int + æ™‚é–“å–®ä½ï¼Œæ­¤å¤–é‚„å¯ä»¥è¨­ç½®æˆ INF(infinite) è¡¨ç¤ºæ°¸ä¹…ä¿å­˜ã€‚\n1 2 duration_unit = \u0026#34;ns\u0026#34; | \u0026#34;u\u0026#34; | \u0026#34;Âµ\u0026#34; | \u0026#34;ms\u0026#34; | \u0026#34;s\u0026#34; | \u0026#34;m\u0026#34; | \u0026#34;h\u0026#34; | \u0026#34;d\u0026#34; | \u0026#34;w\u0026#34; \u0026lt;duration\u0026gt; = int duration_unit | INF duration_unitï¼š\nREPLICATIONï¼š æ•¸æ“šå­˜åœ¨ cluster è£¡é¢çš„å‰¯æœ¬æ•¸é‡ï¼Œé–‹æºå–®ç¯€é»ç‰ˆæœ¬åªæœƒæ˜¯ 1ã€‚\nSHARD DURATIONï¼šé¸å¡«ï¼Œè¡¨ç¤ºæ¯å€‹ shard group åŒ…å«çš„æ™‚é–“ç¯„åœã€‚\næ ¼å¼ç‚º int + æ™‚é–“å–®ä½ï¼Œä½†ä¸å¯ä»¥è¨­ç½®æˆ INFï¼Œæœ€å°å€¼ç‚º 1hã€‚\nç•¶ 1h \u0026gt; duration \u0026gt; 0s å‰‡æœƒè‡ªå‹•å°‡ æ”¹ç‚º 1hï¼›\nç•¶ duration = 0s å‰‡æœƒè‡ªå‹•å°‡ æ”¹ç‚ºé è¨­å€¼ã€‚\né è¨­å€¼æœƒæ ¹æ“š retention policy çš„ DURATITION æ±ºå®šï¼Œå¦‚ä¸‹åœ–ï¼š\nDEFAULTï¼šé¸å¡«ï¼Œå°‡æ­¤ RP è¨­å®šç‚º database é è¨­çš„ RPã€‚\nç¯„ä¾‹ï¼š\n1 CREATE RETENTION POLICY \u0026#34;one_day_only\u0026#34; ON \u0026#34;NOAA_water_database\u0026#34; DURATION 23h60m REPLICATION 1 DEFAULT ALTER Retention policy 1 ALTER RETENTION POLICY \u0026lt;retention_policy_name\u0026gt; ON \u0026lt;database_name\u0026gt; [DURATION \u0026lt;duration\u0026gt;] [REPLICATION \u0026lt;n\u0026gt;] [SHARD DURATION \u0026lt;duration\u0026gt;] [DEFAULT] DURATIONã€ REPLICATIONã€ SHARD DURATION å’Œ DEFAULT è‡³å°‘é¸å¡«å…¶ä¸­ä¸€é …ï¼Œæœªå¡«å¯«çš„éƒ¨åˆ†æœƒä¿æŒåŸæœ¬çš„è¨­å®šå€¼ã€‚\nDROP Retention policy åˆªé™¤ RP å’Œè©² RP åº•ä¸‹æ‰€æœ‰çš„ measurements and data\n1 DROP RETENTION POLICY \u0026lt;retention_policy_name\u0026gt; ON \u0026lt;database_name\u0026gt; CREATE Measurement åœ¨ InfluxDB ä¸­ä¸éœ€è¦é¡¯å¼çš„å»ºç«‹ measurementï¼Œåœ¨ INSERT æ•¸æ“šæ™‚å°±æœƒè‡ªå‹•å»ºç«‹ã€‚\nDROP Measurement 1 DROP MEASUREMENT \u0026lt;measurement_name\u0026gt; DROP SERIES åˆªé™¤æŒ‡å®š series çš„æ‰€æœ‰ Pointsï¼Œä¸¦å°‡ series å¾ index ä¸­åˆªé™¤\n1 DROP SERIES FROM \u0026lt;measurement_name[,measurement_name]\u0026gt; WHERE \u0026lt;tag_key\u0026gt;=\u0026#39;\u0026lt;tag_value\u0026gt;\u0026#39; åˆªé™¤å–®å€‹ measurement çš„æ‰€æœ‰ series å’Œ points\n1 \u0026gt; DROP SERIES FROM \u0026#34;test\u0026#34; åˆªé™¤å–®å€‹ measurement çš„ç‰¹å®š tag pair çš„ series å’Œ points\n1 \u0026gt; DROP SERIES FROM \u0026#34;test\u0026#34; WHERE \u0026#34;host\u0026#34; = \u0026#39;A\u0026#39; åˆªé™¤ database å…§æ‰€æœ‰æ“æœ‰ç‰¹å®š tag pair çš„ measurement å…§çš„ series å’Œ points\n1 \u0026gt; DROP SERIES WHERE \u0026#34;host\u0026#34; = \u0026#39;A\u0026#39; DELETE Series åˆªé™¤æŒ‡å®š series çš„æ‰€æœ‰ Pointsï¼Œä½†ä¸å°‡ series å¾ index ä¸­åˆªé™¤ã€‚\n1 DELETE FROM \u0026lt;measurement_name\u0026gt; WHERE [\u0026lt;tag_key\u0026gt;=\u0026#39;\u0026lt;tag_value\u0026gt;\u0026#39;] | [\u0026lt;time interval\u0026gt;] åˆªé™¤ database å…§æ‰€æœ‰å°æ–¼ 2020-01-01 çš„ Points\n1 \u0026gt; DELETE WHERE time \u0026lt; \u0026#39;2020-01-01\u0026#39; DELETE åœ¨ FROM çš„ \u0026lt;measurement_name\u0026gt; å’Œ WHERE çš„ tag_value éƒ½æ”¯æŒæ­£å‰‡è¡¨é”å¼ã€‚ DELETE ä¸æ”¯æŒåœ¨ WHERE æ¢ä»¶ä¸­ä»¥ fields ç‚ºæ¢ä»¶ã€‚ DELETE é è¨­æœƒå¸¶å…¥ time \u0026lt; now() æ¢ä»¶ï¼Œå› æ­¤è‹¥è¦åˆªé™¤æœªä¾†æ™‚é–“çš„è³‡æ–™ï¼Œéœ€è¦æ˜ç¢ºæŒ‡å®šæ™‚é–“ã€‚ DROP Shard 1 DROP SHARD \u0026lt;shard_id_number\u0026gt; ","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/database-mange-query/","title":"InfluxDB 1.X Database Manage Query"},{"content":"Syntax 1 2 3 4 5 6 -- insert ä¸æŒ‡å®š RP INSERT \u0026lt;line protocol\u0026gt; -- insert æŒ‡å®š RP INSERT INTO \u0026lt;retention policy\u0026gt; \u0026lt;line protocol\u0026gt; -- line protocol \u0026lt;line protocol\u0026gt;: \u0026lt;measurement\u0026gt;[,\u0026lt;tag_key\u0026gt;=\u0026lt;tag_value\u0026gt;[,\u0026lt;tag_key\u0026gt;=\u0026lt;tag_value\u0026gt;]] \u0026lt;field_key\u0026gt;=\u0026lt;field_value\u0026gt;[,\u0026lt;field_key\u0026gt;=\u0026lt;field_value\u0026gt;] [\u0026lt;timestamp\u0026gt;] line protocol å…ƒç´  1 2 3 4 measurementName,tagKey=tagValue fieldKey=\u0026#34;fieldValue\u0026#34; 1465839830100400200 --------------- --------------- --------------------- ------------------- | | | | | | Measurement Tag set ç©ºæ ¼ Field set ç©ºæ ¼ Timestamp Measurement å¿…å¡«ï¼Œ Measurement åç¨±å°æ–¼å¤§å°å¯«æ˜¯æ•æ„Ÿçš„ï¼Œä¸¦ä¸”ä¸å¯ä»¥ _ ç‚ºé–‹é ­ï¼Œæ­¤ _ ç‚º InfluxDB system ä¿ç•™ä½¿ç”¨ã€‚ Data type:Â String\nTag set é¸å¡«ï¼Œç•¶æœ‰å¤šå€‹ Tag set æ™‚ç”¨ , åšç‚ºå€éš”ã€‚ Tag set å°æ–¼å¤§å°å¯«æ˜¯æ•æ„Ÿçš„ï¼Œ Tag key ä¸å¯ä»¥ _ ç‚ºé–‹é ­ã€‚ Key data type:Â String\nValue data type:Â String\nField set å¿…å¡«ï¼Œ Point å¿…é ˆè‡³å°‘æœ‰ä¸€å° Field setï¼Œç•¶æœ‰å¤šå€‹ Field set æ™‚ç”¨ , åšç‚ºå€éš”ã€‚ Field keys å°æ–¼å¤§å°å¯«æ˜¯æ•æ„Ÿçš„ï¼Œä¸”ä¸å¯ä»¥ _ ç‚ºé–‹é ­ã€‚ ç•¶ Field values ç‚º String å‹æ…‹æ™‚ï¼Œè«‹ä½¿ç”¨é›™å¼•è™Ÿ \u0026quot; åŒ…èµ·ä¾†ã€‚ Key data type:Â String\nValue data type:Â FloatÂ |Â IntegerÂ |Â UIntegerÂ |Â StringÂ |Â Boolean\nTimestamp é¸å¡«ï¼Œé è¨­ä½¿ç”¨ InfluxDB Host çš„ç³»çµ±æ™‚é–“(UTC)ã€‚ ç‚ºäº†ç¢ºä¿ Point ä¸Šçš„æ™‚é–“ç‚ºè§€æ¸¬åˆ°æ•¸æ“šçš„æ™‚é–“ï¼Œè€Œä¸æ˜¯ InfluxDB æ”¶åˆ°çš„æ™‚é–“ï¼Œå› æ­¤å»ºè­°ç¸½æ˜¯å¸¶å…¥ Timestampã€‚ é»˜èªç²¾åº¦ç‚º nanoseconds(ns)ï¼Œè‹¥ insert çš„æ™‚é–“ç²¾åº¦ä¸æ˜¯ ns å‰‡å¿…é ˆæŒ‡å®šç²¾åº¦ï¼ŒInfluxDB æ¥å—ä»¥ä¸‹ç²¾åº¦ï¼š nanoseconds(ns)ã€microseconds(us)ã€milliseconds(ms) å’Œ seconds(s)ã€‚ Data type: Unix timestamp\nLine Protocol Data types Float æ­¤ç‚ºé è¨­çš„æ•¸å€¼å‹æ…‹ï¼Œç‚º IEEE-754 64-bit çš„æµ®é»æ•¸ï¼Œä¸¦ä¸” InfluxDB æ”¯æ´ç§‘å­¸è¨˜è™Ÿçš„æ–¹å¼è¨˜éŒ„\n1 2 3 myMeasurement fieldKey=1.0 myMeasurement fieldKey=1 myMeasurement fieldKey=-1.234456e+78 Integer åœ¨æ•¸å€¼çš„å¾Œæ–¹åŠ ä¸Š i æŒ‡å®šå…¶ç‚ºæ•´æ•¸å‹æ…‹ï¼Œç‚º Signed 64-bit æ•´æ•¸ã€‚\n1 2 3 myMeasurement fieldKey=-1i myMeasurement fieldKey=12485903i myMeasurement fieldKey=-12485903i UInteger åœ¨æ•¸å€¼çš„å¾Œæ–¹åŠ ä¸Š u æŒ‡å®šå…¶ç‚º Unsigned çš„æ•´æ•¸å‹æ…‹ï¼Œç‚º Unsigned 64-bit æ•´æ•¸ã€‚\n1 2 myMeasurement fieldKey=1u myMeasurement fieldKey=12485903u String å­—ä¸²ï¼Œé•·åº¦é™åˆ¶ç‚º 64KB\n1 2 # String measurement name, field key, and field value myMeasurement fieldKey=\u0026#34;this is a string\u0026#34; Bollean True or Falseï¼Œæ”¯æŒä»¥ä¸‹åç¨±ï¼š\næ³¨æ„ä¸å¯åŒ…å« \u0026quot; ï¼Œå¦å‰‡æœƒè¢«è½‰æ›ç‚º string å‹æ…‹\n1 2 3 4 5 6 myMeasurement fieldKey=true myMeasurement fieldKey=false myMeasurement fieldKey=t myMeasurement fieldKey=f myMeasurement fieldKey=TRUE myMeasurement fieldKey=FALSE Unix timestamp æ”¯æŒçš„ç²¾åº¦ï¼šnanoseconds(ns)ã€microseconds(us)ã€milliseconds(ms) å’Œ seconds(s)ï¼Œé è¨­ç‚º nsã€‚\n1 myMeasurementName fieldKey=\u0026#34;fieldValue\u0026#34; 1556813561098000000 å¼•è™Ÿ(Quotes) InfluxDB æ”¯æŒå–®é›™å¼•è™Ÿï¼Œå…·é«”å¦‚ä¸‹ï¼š\nField value çš„ String å¿…é ˆä¹Ÿåªèƒ½ä½¿ç”¨é›™å¼•è™Ÿ \u0026quot; åŒ…èµ·ä¾†ã€‚\nLimited è¡¨ç¤ºå¼•è™Ÿæœƒè¢«è¦–ç‚ºåç¨±çš„éƒ¨åˆ†ï¼Œç¯„ä¾‹ï¼š\n1 2 3 4 5 6 \u0026gt; insert test,\u0026#39;host\u0026#39;=\u0026#34;A\u0026#34;,host=A value=\u0026#34;test\u0026#34; \u0026gt; select * from test name: test time \u0026#39;host\u0026#39; host value ---- ------ ---- ----- 1607417652586210324 \u0026#34;A\u0026#34; A test ç‰¹æ®Šå­—å…ƒèˆ‡è½‰ç¾© ç•¶ Strings å‹æ…‹ä¸­å‡ºç¾ç‰¹æ®Šå­—å…ƒæ™‚ï¼Œéœ€è¦ä½¿ç”¨ \\ é€²è¡Œè½‰ç¾©ï¼Œä»¥ä¸‹ç‰¹æ®Šå­—å…ƒéœ€è¦è½‰ç¾©ï¼š\n1 2 3 4 5 6 7 8 9 10 11 # Measurement åç¨±ä¸­æœ‰ç©ºæ ¼ my\\ Measurement fieldKey=\u0026#34;string value\u0026#34; # field values çš„ sting ä¸­æœ‰é›™å¼•è™Ÿ myMeasurement fieldKey=\u0026#34;\\\u0026#34;string\\\u0026#34; within a string\u0026#34; # Tag keys and values åç¨±ä¸­æœ‰ç©ºæ ¼ myMeasurement,tag\\ Key1=tag\\ Value1,tag\\ Key2=tag\\ Value2 fieldKey=100 # Emojis ä¸éœ€è¦è½‰ç¾© myMeasurement,tagKey=ğŸ­ fieldKey=\u0026#34;Launch ğŸš€\u0026#34; 1556813561098000000 è¨»è§£ å¯«åœ¨ # å¾Œçš„çš†ç‚ºè¨»è§£ï¼Œç›´åˆ°æ›è¡Œ \\nã€‚\n1 2 # This is a comment myMeasurement fieldKey=\u0026#34;string value\u0026#34; 1556813561098000000 å‘½åé™åˆ¶ Measurement namesã€ tag keys å’Œ field keys ä¸èƒ½ä»¥ _ ç‚ºé–‹é ­ï¼Œæ­¤é–‹é ­ç‚º InfluxDB ç³»çµ±ä½¿ç”¨ã€‚\nåƒè€ƒ Write data to InfluxDB with insert - influxdata æ–‡æª”\nLine protocol - influxdata æ–‡æª”\nline protocol - data types and format - influxdata æ–‡æª”\n","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/insert/","title":"InfluxDB 1.X INSERT èªå¥"},{"content":"InfluxQL æ˜¯ SQL LIKE èªæ³•ï¼Œæ‰€ä»¥æ•´é«”è€Œè¨€çš„èªæ³•å¾ˆ SQL æ²’æœ‰å¤ªå¤§çš„å€åˆ¥ï¼Œä»¥ä¸‹æ–‡ä»¶å‡å®šä½¿ç”¨è€…äº†è§£SQLèªæ³•ï¼Œå› æ­¤åªç°¡åˆ—å‡ºç‰¹åˆ¥éœ€è¦æ³¨æ„çš„éƒ¨åˆ†ã€‚ä»¥ä¸‹ç‚ºç›®éŒ„ï¼š\nSELECT \u0026hellip; FROM \u0026hellip; ç”¨æ–¼å¾ FROM æŒ‡å®šçš„ measurementï¼Œå°‡ SELECT çš„ fields å’Œ tags é¡¯ç¤ºå‡ºä¾†ã€‚\n1 2 SELECT \u0026lt;field_key\u0026gt;[,\u0026lt;field_key\u0026gt;,\u0026lt;tag_key\u0026gt;] FROM \u0026lt;measurement_name\u0026gt;[,\u0026lt;measurement_name\u0026gt;] SELECT * è¡¨ç¤ºè¿”å›æ‰€æœ‰çš„ field_key tag_keyã€‚\nç•¶éœ€è¦ SELECT tag_key æ™‚ï¼Œè‡³å°‘éœ€è¦åŒ…å«ä¸€å€‹ field_keyï¼Œå¦å‰‡ä¸æœƒè¿”å›ä»»ä½•çµæœï¼Œé€™æ˜¯æœ‰é—œæ–¼æ•¸æ“šå„²å­˜æ–¹å¼çš„çµæœã€‚\nSELECT \u0026quot;\u0026lt;field_key\u0026gt;\u0026quot;::field,\u0026quot;\u0026lt;tag_key\u0026gt;\u0026quot;::tag å…¶ä¸­ ::[field | tag] æ˜¯ç”¨ä¾†å€åˆ†æ“æœ‰ç›¸åŒåç¨±çš„ field_key å’Œ tag_keyï¼Œç•¶åŒåæ²’æœ‰æŒ‡å®š ::[field | tag] æ™‚ï¼Œé è¨­æœƒæ˜¯é¡¯ç¤º field key\nç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026gt; INSERT test,host=A host=\u0026#34;B\u0026#34;,loading=0.5 \u0026gt; SELECT * FROM test name: test time host host_1 loading ---- ---- ------ ------- 1607668578356932984 B A 0.5 \u0026gt; SELECT host,loading FROM test name: test time host loading ---- ---- ------- 1607668578356932984 B 0.5 \u0026gt; SELECT host::tag,loading FROM test name: test time host loading ---- ---- ------- 1607668578356932984 A 0.5 SELECT ä¸å¯åœ¨ä½¿ç”¨ èšåˆå‡½æ•¸ æ™‚ï¼ŒåŒ…å« éèšåˆå‡½æ•¸ã€field key æˆ– tag keyã€‚ä¹Ÿå°±æ˜¯ç›¸ç•¶æ–¼ MySQL ä¸­ sql_mode åŒ…å« ONLY_FULL_GROUP_BY çš„æƒ…æ³ã€‚\n1 2 3 4 5 6 7 8 \u0026gt; SELECT * FROM test name: test time host loading ---- ---- ------- 1607672144573710142 A 0.5 1607672146554038115 A 0.6 \u0026gt; SELECT host,SUM(loading) FROM test ERR: mixing aggregate and non-aggregate queries is not supported FROM \u0026lt;database_name\u0026gt;.\u0026lt;retention_policy_name\u0026gt;.\u0026lt;measurement_name\u0026gt; å¯ä»¥ä½¿ç”¨æ­¤æ–¹å¼æŒ‡å®šåˆ°ç‰¹å®š database å’Œ retention policy çš„ measurementã€‚\nFROM \u0026lt;database_name\u0026gt;..\u0026lt;measurement_name\u0026gt; æ­¤æ–¹å¼æœƒæŒ‡å®šåˆ°å°æ‡‰ database ä½¿ç”¨ DEFAULT RP çš„ measuremenã€‚\nFROM \u0026lt;measurement_name\u0026gt;,\u0026lt;measurement_name\u0026gt; æœƒå‚³å›å¤šå€‹ measurement çš„æ•¸æ“šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026gt; INSERT test,host=A loading=0.5,extra=\u0026#34;test\u0026#34; \u0026gt; INSERT test2,host=B loading=0.5,extra2=\u0026#34;test2\u0026#34; \u0026gt; SELECT * FROM test,test2 name: test time extra extra2 host loading ---- ----- ------ ---- ------- 1607672996339840129 test A 0.5 name: test2 time extra extra2 host loading ---- ----- ------ ---- ------- 1607673009199242222 test2 B 0.5 å¼•è™Ÿçš„è¦å‰‡å’Œ line protocol ä¸åŒï¼Œè¦å‰‡å¦‚ä¸‹ï¼š\n' ç”¨æ–¼ String å’Œ timestamp valuesï¼Œè«‹å‹¿ç”¨æ–¼æ¨™è­˜ç¬¦(database names, retention policy names, user names, measurement names, tag keys, and field keys)ã€‚ \u0026quot; ç”¨æ–¼æ¨™è­˜ç¬¦ï¼Œæ¨™è­˜ç¬¦database names, retention policy names, user names, measurement names, tag keys, and field keys)ã€‚ 1 2 3 4 5 6 7 8 9 10 -- YES SELECT bikes_available FROM bikes WHERE station_id=\u0026#39;9\u0026#39; SELECT \u0026#34;bikes_available\u0026#34; FROM \u0026#34;bikes\u0026#34; WHERE \u0026#34;station_id\u0026#34;=\u0026#39;9\u0026#39; SELECT MIN(\u0026#34;avgrq-sz\u0026#34;) AS \u0026#34;min_avgrq-sz\u0026#34; FROM telegraf SELECT * from \u0026#34;cr@zy\u0026#34; where \u0026#34;p^e\u0026#34;=\u0026#39;2\u0026#39; SELECT \u0026#34;water_level\u0026#34; FROM \u0026#34;h2o_feet\u0026#34; WHERE time \u0026gt; \u0026#39;2015-08-18T23:00:01.232000000Z\u0026#39; AND time \u0026lt; \u0026#39;2015-09-19\u0026#39; -- NO SELECT \u0026#39;bikes_available\u0026#39; FROM \u0026#39;bikes\u0026#39; WHERE \u0026#39;station_id\u0026#39;=\u0026#34;9\u0026#34; SELECT * from cr@zy where p^e=\u0026#39;2\u0026#39; SELECT \u0026#34;water_level\u0026#34; FROM \u0026#34;h2o_feet\u0026#34; WHERE time \u0026gt; \u0026#34;2015-08-18T23:00:01.232000000Z\u0026#34; AND time \u0026lt; \u0026#34;2015-09-19\u0026#34; WHERE åªé¡¯ç¤ºç¬¦åˆ WHERE æ¢ä»¶çš„è³‡æ–™ã€‚\n1 SELECT ... FROM ... WHERE \u0026lt;conditional_expression\u0026gt; [(AND|OR) \u0026lt;conditional_expression\u0026gt; [...]] Fields 1 field_key \u0026lt;operator\u0026gt; [\u0026#39;string\u0026#39; | boolean | float | integer] String field value å¿…é ˆä½¿ç”¨ ' åŒ…èµ·ä¾†ï¼Œå¦å‰‡ä¸æœƒè¿”å›æ•¸æ“šï¼Œä¸¦èµ·å¤§éƒ¨åˆ†æ™‚å€™ä¸æœƒè¿”å›éŒ¯èª¤ã€‚ operator æ”¯æ´ï¼š=ã€ \u0026lt;\u0026gt;ã€!=ã€\u0026gt;ã€\u0026gt;=ã€\u0026lt;ã€\u0026lt;=ã€ç®—è¡“é‹ç®—ç¬¦å’Œæ­£å‰‡è¡¨é”å¼ã€‚ Tags 1 tag_key \u0026lt;operator\u0026gt; [\u0026#39;tag_value\u0026#39;] tag value å¿…é ˆä½¿ç”¨ ' åŒ…èµ·ä¾†ï¼Œå¦å‰‡ä¸æœƒè¿”å›æ•¸æ“šï¼Œä¸¦èµ·å¤§éƒ¨åˆ†æ™‚å€™ä¸æœƒè¿”å›éŒ¯èª¤ã€‚ operator æ”¯æ´ï¼š=ã€ \u0026lt;\u0026gt;ã€!= å’Œ æ­£å‰‡è¡¨é”å¼ã€‚ Timestamp é è¨­å€¼ç‚º (UTC) 1677-09-21 00:12:43.145224194 ~ 2262-04-11T23:47:16.854775806Z ç•¶åŒ…å« GROUP BY time() æ™‚ï¼Œé è¨­å€¼ç‚º (UTC) 1677-09-21 00:12:43.145224194 ~ now() ä¸æ”¯æŒåœ¨ time ä¸Šä½¿ç”¨ OR æŒ‡å®šå¤šå€‹æ™‚é–“ç¯„åœï¼Œå°æ–¼è©²æŸ¥è©¢æœƒè¿”å›ç©ºçµæœã€‚ SELECT INTO å°‡ SELECT çš„çµæœå¯«å…¥åˆ° INTO æŒ‡å®šçš„ measurement\n1 SELECT_clause INTO \u0026lt;measurement_name\u0026gt; FROM_clause [WHERE_clause] [GROUP_BY_clause] å¯ç”¨æ–¼ RENAME DATABASEï¼Œå¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 SELECT * INTO \u0026#34;copy_test\u0026#34;.\u0026#34;autogen\u0026#34;.:MEASUREMENT FROM \u0026#34;test\u0026#34;.\u0026#34;autogen\u0026#34;./.*/ GROUP BY * å°‡ test DB ä¸‹ autogen RP çš„è³‡æ–™å¯«å…¥åˆ° copy_test DB ä¸‹ autogen RP ã€‚ åå‘å¼•ç”¨èªæ³• \u0026lt;:MEASUREMENT\u0026gt; è®“ copy_test DB ä¸­ measurement åç¨±å¼•ç”¨ test DB ä¸­çš„åç¨±ã€‚è«‹æ³¨æ„åœ¨åŸ·è¡Œå‰å¿…é ˆç¢ºä¿ copy_test DB åŠ autogen RP å­˜åœ¨ã€‚ è‹¥èªæ³•ä¸­æœªåŒ…å« GROUP BY * åœ¨æ–°çš„ measurement ä¸­ tag æœƒè¢«è½‰ç‚º fieldã€‚ ç•¶ç§»å‹•å¤§é‡æ•¸æ“šæ™‚ï¼Œå»ºè­°åœ¨ WHERE æ¢ä»¶ä¸­åŠ å…¥æ™‚é–“æ¢ä»¶åˆ†æ‰¹å¯«å…¥ï¼Œé¿å…ç³»çµ±å…§å­˜ä¸è¶³ã€‚ ç¶“å¸¸ç”¨æ–¼æ¡æ¨£ï¼Œå°‡é«˜ç²¾åº¦çš„è³‡æ–™é€é function å’Œ group by èšåˆæˆä½ç²¾åº¦çš„æ•¸æ“šã€‚\nç”±æ–¼ç•¶èªæ³•ä¸­æœªåŒ…å« GROUP BY * æ™‚ï¼ŒåŸè¡¨çš„ tag åœ¨æ–°è¡¨å°‡è¢«è½‰æ›ç‚º fieldï¼Œå› æ­¤åŸæœ¬ç”¨ tag å€åˆ¥çš„æ•¸æ“šè¢« overwriteï¼Œé€™å¯èƒ½å°è‡´æ•¸æ“šçš„ä¸Ÿå¤±ã€‚è‹¥è¦ä¿ç•™ tag è«‹å‹™å¿…åŠ ä¸Š GROUP BY *ã€‚\nGROUP BY å°‡æ•¸æ“šä¾ç…§ GROUP BY æŒ‡å®šçš„ tag key æˆ– æ™‚é–“å€é–“ é€²è¡Œåˆ†çµ„ä¸¦èšåˆã€‚\ntags 1 SELECT_clause FROM_clause [WHERE_clause] GROUP BY [* | \u0026lt;tag_key\u0026gt;[,\u0026lt;tag_key]] GROUP BY * æœƒé€éæ‰€æœ‰çš„ tag_key ä¾†èšåˆçµæœã€‚ time() 1 SELECT \u0026lt;function\u0026gt;(\u0026lt;field_key\u0026gt;) FROM_clause WHERE \u0026lt;time_range\u0026gt; GROUP BY time(\u0026lt;time_interval\u0026gt;[,\u0026lt;offset_interval\u0026gt;]),[tag_key] [fill(\u0026lt;fill_option\u0026gt;)] time(time_interval)ï¼šInfluxDB æ ¹æ“š time_interval å°æ™‚é–“ç¯„åœé€²è¡Œåˆ†çµ„ï¼Œåˆ†çµ„å‡ºä¾†çš„çµæœåŒ…ä¸‹ä¸åŒ…ä¸Šã€‚å¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026gt; SELECT * FROM \u0026#34;test\u0026#34; name: test -------------- time value 2015-08-18T00:00:00Z 1 2015-08-18T00:12:00Z 1 2015-08-18T00:18:00Z 1 \u0026gt; SELECT COUNT(\u0026#34;value\u0026#34;) FROM \u0026#34;test\u0026#34; GROUP BY time(12m) name: test -------------- time count 2015-08-18T00:00:00Z 1 2015-08-18T00:12:00Z 2 -- 2015-08-18T00:00:00Zï¼š 2015-08-18T00:00:00Z \u0026lt;= time \u0026lt; 2015-08-18T00:12:00Z -- 2015-08-18T00:12:00Zï¼š 2015-08-18T00:12:00Z \u0026lt;= time \u0026lt; 2015-08-18T00:24:00Z time_interval çš„æ ¼å¼ç‚º uint + time unitsï¼Œ time units å¯åƒè€ƒä»¥ä¸‹è¡¨æ ¼ï¼š\ntime(time_interval,offset_interval)ï¼š InfluxDB æ ¹æ“š offset_interval èª¿æ•´æ™‚é–“é‚Šç•Œï¼Œä¸¦æ ¹æ“š time_interval å°æ™‚é–“ç¯„åœé€²è¡Œåˆ†çµ„ã€‚\noffset_interval çš„æ ¼å¼ç‚º int(å¯ä»¥ç‚ºè² ) + time unitsã€‚\nç•¶æœªæŒ‡å®š offset_interval æ™‚ï¼ŒInfluxDBæœƒä»¥é è¨­çš„æ™‚é–“é‚Šç•Œé–‹å§‹åˆ†çµ„ã€‚å¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u0026gt; SELECT * FROM test name: test time host value ---- ---- ----- 2020-11-01T00:00:00Z A 0 2020-11-01T00:06:00Z A 1 2020-11-01T00:12:00Z A 2 2020-11-01T00:18:00Z A 3 2020-11-01T00:24:00Z A 4 2020-11-01T00:36:00Z A 5 -- GROUP BY time(8m)ï¼Œé è¨­å¾ 00:00:00 é–‹å§‹æ¯8åˆ†é˜ç‚ºä¸€çµ„ï¼ŒCOUNT åœ¨ WHERE æ™‚é–“ç¯„åœå…§çš„ç­†æ•¸ \u0026gt; SELECT COUNT(\u0026#34;value\u0026#34;) FROM \u0026#34;test\u0026#34; WHERE time \u0026gt;= \u0026#39;2020-11-01T00:06:00Z\u0026#39; AND time \u0026lt;= \u0026#39;2020-11-01T00:36:00Z\u0026#39; GROUP BY time(8m) name: test time count ---- ----- 2020-11-01T00:00:00Z 1 2020-11-01T00:08:00Z 1 2020-11-01T00:16:00Z 1 2020-11-01T00:24:00Z 1 2020-11-01T00:32:00Z 1 -- GROUP BY time(8m,6m)ï¼Œå¾ 00:06:00 é–‹å§‹æ¯8åˆ†é˜ç‚ºä¸€çµ„ï¼ŒCOUNT åœ¨ WHERE æ™‚é–“ç¯„åœå…§çš„ç­†æ•¸ \u0026gt; SELECT COUNT(\u0026#34;value\u0026#34;) FROM \u0026#34;test\u0026#34; WHERE time \u0026gt;= \u0026#39;2020-11-01T00:06:00Z\u0026#39; AND time \u0026lt;= \u0026#39;2020-11-01T00:36:00Z\u0026#39; GROUP BY time(8m,6m) name: test time count ---- ----- 2020-11-01T00:06:00Z 2 2020-11-01T00:14:00Z 1 2020-11-01T00:22:00Z 1 2020-11-01T00:30:00Z 1 fill(\u0026lt;fill_option\u0026gt;)ï¼šé¸å¡«ï¼Œé è¨­æƒ…æ³ä¸‹ç•¶çµ„åˆ¥æ²’æœ‰è³‡æ–™æ™‚æœƒè¿”å› NULLï¼Œè©²é¸é …ç”¨ä¾†æ”¹è®Šç•¶æ²’æœ‰è³‡æ–™æ™‚è¿”å›çš„çµæœã€‚\nfill_option æœ‰ä»¥ä¸‹å€¼ï¼\nnullï¼šåŒ…å«è©²çµ„åˆ¥ä½†å€¼è¿”å› NULLï¼Œæ­¤ç‚ºé»˜èªå€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 \u0026gt; SELECT MAX(\u0026#34;value\u0026#34;) FROM \u0026#34;cpu\u0026#34; GROUP BY time(1s) name: cpu time max ---- --- 1607937488000000000 1 1607937489000000000 1607937490000000000 1607937491000000000 2 1607937492000000000 3 1607937493000000000 4 numerical valueï¼šè¿”å›è©²æ•¸å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 \u0026gt; SELECT MAX(\u0026#34;value\u0026#34;) FROM \u0026#34;cpu\u0026#34; GROUP BY time(1s) fill(100) name: cpu time max ---- --- 1607937488000000000 1 1607937489000000000 100 1607937490000000000 100 1607937491000000000 2 1607937492000000000 3 1607937493000000000 4 linearï¼š æ ¹æ“š linear interpolation é¡¯ç¤ºå€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 \u0026gt; SELECT MAX(\u0026#34;value\u0026#34;) FROM \u0026#34;cpu\u0026#34; GROUP BY time(1s) fill(linear) name: cpu time max ---- --- 1607937488000000000 1 1607937489000000000 1.3333333333333333 1607937490000000000 1.6666666666666665 1607937491000000000 2 1607937492000000000 3 1607937493000000000 4 noneï¼šä¸é¡¯ç¤ºè©²çµ„åˆ¥ã€‚\n1 2 3 4 5 6 7 8 \u0026gt; SELECT MAX(\u0026#34;value\u0026#34;) FROM \u0026#34;cpu\u0026#34; GROUP BY time(1s) fill(none) name: cpu time max ---- --- 1607937488000000000 1 1607937491000000000 2 1607937492000000000 3 1607937493000000000 4 previousï¼šé¡¯ç¤ºå‰ä¸€å€‹çµ„åˆ¥çš„çµæœã€‚\n1 2 3 4 5 6 7 8 9 10 \u0026gt; SELECT MAX(\u0026#34;value\u0026#34;) FROM \u0026#34;cpu\u0026#34; GROUP BY time(1s) fill(previous) name: cpu time max ---- --- 1607937488000000000 1 1607937489000000000 1 1607937490000000000 1 1607937491000000000 2 1607937492000000000 3 1607937493000000000 4 ORDER BY time å°‡çµæœæŒ‰ç…§æ™‚é–“æ’åºã€‚\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] [GROUP_BY_clause] ORDER BY time ASC|DESC é è¨­ä½¿ç”¨ ASC æ’åº åœ¨ influxQL ä¸­åªèƒ½ç”¨ time æ’åº LIMIT and SLIMIT LIMIT LIMIT \u0026lt;N\u0026gt; è¿”å›å‰ N å€‹ Pointsã€‚\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] [GROUP_BY_clause] [ORDER_BY_clause] LIMIT \u0026lt;N\u0026gt; SLIMIT SLIMIT \u0026lt;N\u0026gt; è¿”å›å‰ N å€‹ Series çš„æ‰€æœ‰ Pointsï¼Œæ³¨æ„å¿…é ˆè¦æ­é… GROUP BY æ‰èƒ½ä½¿ç”¨ã€‚\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] GROUP BY *[,time(\u0026lt;time_interval\u0026gt;)] [ORDER_BY_clause] SLIMIT \u0026lt;N\u0026gt; LIMIT SLIMIT è¿”å› N2 å€‹ Seriesï¼Œæ¯å€‹ Series è¿”å› N1 å€‹ Points\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] GROUP BY *[,time(\u0026lt;time_interval\u0026gt;)] [ORDER_BY_clause] LIMIT \u0026lt;N1\u0026gt; SLIMIT \u0026lt;N2\u0026gt; OFFSET and SOFFSET OFFSET è¿”å›è³‡æ–™æ™‚ï¼Œè·³éå‰é¢ N ç­† Points\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] [GROUP_BY_clause] [ORDER_BY_clause] LIMIT_clause OFFSET \u0026lt;N\u0026gt; [SLIMIT_clause] SOFFSET è¿”å›è³‡æ–™æ™‚ï¼Œè·³éå‰é¢ N å€‹ Seriesï¼Œæ³¨æ„å¿…é ˆè¦æ­é… GROUP BY å’Œ SLIMIT æ‰èƒ½ä½¿ç”¨ã€‚\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] GROUP BY *[,time(time_interval)] [ORDER_BY_clause] [LIMIT_clause] [OFFSET_clause] SLIMIT_clause SOFFSET \u0026lt;N\u0026gt; Time Zone tz() é è¨­æƒ…æ³ä¸‹ InfluxDB è¿”å› UTC+0 æ™‚é–“ï¼Œå¯ä»¥åœ¨ SELECT èªå¥çš„æœ«å°¾åŠ ä¸Š tz('æ™‚å€') ï¼Œä½¿å…¶å°‡ time çš„æ™‚å€é€²è¡Œè½‰æ›ã€‚\n1 SELECT_clause [INTO_clause] FROM_clause [WHERE_clause] [GROUP_BY_clause] [ORDER_BY_clause] [LIMIT_clause] [OFFSET_clause] [SLIMIT_clause] [SOFFSET_clause] tz(\u0026#39;\u0026lt;time_zone\u0026gt;\u0026#39;) æ™‚é–“æ ¼å¼å¿…é ˆæ¡ç”¨ RFC3339 format æ‰æœƒé€²è¡Œè½‰æ›ã€‚ \u0026lt;time_zone\u0026gt; å¯åƒè€ƒ List of tz database time zones(WIKI) ã€‚ åƒè€ƒ Explore data using InfluxQL - Influxdata æ–‡æª”\n","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/select/","title":"InfluxDB 1.X SELECT èªå¥"},{"content":"Show Schema SHOW DATABASE 1 SHOW \u0026lt;database_name\u0026gt; SHOW Retention policy 1 SHOW RETENTION POLICIES [ON \u0026lt;database_name\u0026gt;] ON \u0026lt;database_name\u0026gt; é›–ç„¶æ˜¯é¸å¡«çš„ï¼Œä½†æ˜¯è‹¥ä¸å¸¶å…¥å¿…é ˆå…ˆé‹è¡Œ USE \u0026lt;database_name\u0026gt;ã€‚ SHOW Measurement 1 SHOW MEASUREMENTS [ON \u0026lt;database_name\u0026gt;] [WITH MEASUREMENT \u0026lt;regular_expression\u0026gt;] [WHERE \u0026lt;tag_key\u0026gt; \u0026lt;operator\u0026gt; [\u0026#39;\u0026lt;tag_value\u0026gt;\u0026#39; | \u0026lt;regular_expression\u0026gt;]] [LIMIT_clause] [OFFSET_clause] ON \u0026lt;database_name\u0026gt; é›–ç„¶æ˜¯é¸å¡«çš„ï¼Œä½†æ˜¯è‹¥ä¸å¸¶å…¥å¿…é ˆå…ˆé‹è¡Œ USE \u0026lt;database_name\u0026gt;ã€‚ SHOW Series 1 SHOW SERIES [ON \u0026lt;database_name\u0026gt;] [FROM_clause] [WHERE \u0026lt;tag_key\u0026gt; \u0026lt;operator\u0026gt; [ \u0026#39;\u0026lt;tag_value\u0026gt;\u0026#39; | \u0026lt;regular_expression\u0026gt;]] [LIMIT_clause] [OFFSET_clause] ON \u0026lt;database_name\u0026gt; é›–ç„¶æ˜¯é¸å¡«çš„ï¼Œä½†æ˜¯è‹¥ä¸å¸¶å…¥å¿…é ˆå…ˆé‹è¡Œ USE \u0026lt;database_name\u0026gt;ã€‚\nWHERE æ¢ä»¶ä¸æ”¯æŒ field åˆ¤æ–·\nWHERE æ¢ä»¶ä¸­çš„ operator æ”¯æŒ ç­‰æ–¼ =ã€ä¸ç­‰æ–¼ \u0026lt;\u0026gt; OR !=ã€ LIKE =~ã€ NOT LIKE !~\nWHERE æ¢ä»¶ä¸­é‚„èƒ½å¸¶å…¥ time é™ç¸®ï¼Œåªæœ‰ç•¶æ¢ä»¶ç‚º time æ™‚æ‰å¯ä»¥ä½¿ç”¨ \u0026gt; \u0026lt; ã€‚ ç•¶ä»¥æ™‚é–“ç‚ºæ¢ä»¶æ™‚ï¼Œå¯¦éš›ä¸Šæ˜¯ä½¿ç”¨ shard ç‚ºç²’åº¦ï¼Œæœƒåˆ¤æ–·è©²æ™‚é–“æ‰€å±¬å“ªä¸€å€‹ shard ä»¥æ­¤é€²è¡Œç¯©é¸ï¼Œæ‰€ä»¥æœƒå‡ºç¾è¶…å‡º time ç¯„åœçš„è³‡æ–™ï¼Œå¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \u0026gt; show shards name: hour_test id database retention_policy shard_group start_time end_time expiry_time owners -- -------- ---------------- ----------- ---------- -------- ----------- ------ 50 hour_test mytest 50 2020-12-08T03:00:00Z 2020-12-08T04:00:00Z 2020-12-15T04:00:00Z 52 hour_test mytest 52 2020-12-08T04:00:00Z 2020-12-08T05:00:00Z 2020-12-15T05:00:00Z 51 hour_test mytest 51 2020-12-08T05:00:00Z 2020-12-08T06:00:00Z 2020-12-15T06:00:00Z 53 hour_test mytest 53 2020-12-08T06:00:00Z 2020-12-08T07:00:00Z 2020-12-15T07:00:00Z 54 hour_test mytest 54 2020-12-08T07:00:00Z 2020-12-08T08:00:00Z 2020-12-15T08:00:00Z \u0026gt; select * from test name: test time test_key_12 test_key_13 test_key_init value ---- ----------- ----------- ------------- ----- 1607399129788792227 0 1 1607400000000000000 12 1 1607403600000000000 13 1 \u0026gt; show series where time \u0026gt; 1607400000000000000 key --- test,test_key_12=12 test,test_key_13=13 SHOW Tag Keys 1 SHOW TAG KEYS [ON \u0026lt;database_name\u0026gt;] [FROM_clause] [WHERE \u0026lt;tag_key\u0026gt; \u0026lt;operator\u0026gt; [\u0026#39;\u0026lt;tag_value\u0026gt;\u0026#39; | \u0026lt;regular_expression\u0026gt;]] [LIMIT_clause] [OFFSET_clause] ON \u0026lt;database_name\u0026gt; é›–ç„¶æ˜¯é¸å¡«çš„ï¼Œä½†æ˜¯è‹¥ä¸å¸¶å…¥å¿…é ˆå…ˆé‹è¡Œ USE \u0026lt;database_name\u0026gt;ã€‚ WHERE æ¢ä»¶ä¸æ”¯æŒ field åˆ¤æ–· WHERE æ¢ä»¶ä¸­çš„ operator æ”¯æŒ ç­‰æ–¼ =ã€ä¸ç­‰æ–¼ \u0026lt;\u0026gt; OR !=ã€ LIKE =~ã€ NOT LIKE !~ WHERE æ¢ä»¶ä¸­é‚„èƒ½å¸¶å…¥ time é™ç¸®ï¼Œåªæœ‰ç•¶æ¢ä»¶ç‚º time æ™‚æ‰å¯ä»¥ä½¿ç”¨ \u0026gt; \u0026lt; ã€‚ ç•¶ä»¥æ™‚é–“ç‚ºæ¢ä»¶æ™‚ï¼Œå¯¦éš›ä¸Šæ˜¯ä½¿ç”¨ shard ç‚ºç²’åº¦ï¼Œæœƒåˆ¤æ–·è©²æ™‚é–“æ‰€å±¬å“ªä¸€å€‹ shard ä»¥æ­¤é€²è¡Œç¯©é¸ï¼Œæ‰€ä»¥æœƒå‡ºç¾è¶…å‡º time ç¯„åœçš„è³‡æ–™ã€‚ SHOW Tag Values 1 SHOW TAG VALUES [ON \u0026lt;database_name\u0026gt;][FROM_clause] WITH KEY [ [\u0026lt;operator\u0026gt; \u0026#34;\u0026lt;tag_key\u0026gt;\u0026#34; | \u0026lt;regular_expression\u0026gt;] | [IN (\u0026#34;\u0026lt;tag_key1\u0026gt;\u0026#34;,\u0026#34;\u0026lt;tag_key2\u0026#34;)]] [WHERE \u0026lt;tag_key\u0026gt; \u0026lt;operator\u0026gt; [\u0026#39;\u0026lt;tag_value\u0026gt;\u0026#39; | \u0026lt;regular_expression\u0026gt;]] [LIMIT_clause] [OFFSET_clause] ON \u0026lt;database_name\u0026gt; é›–ç„¶æ˜¯é¸å¡«çš„ï¼Œä½†æ˜¯è‹¥ä¸å¸¶å…¥å¿…é ˆå…ˆé‹è¡Œ USE \u0026lt;database_name\u0026gt;ã€‚\nWHERE æ¢ä»¶ä¸æ”¯æŒ field åˆ¤æ–·\nWITH å’Œ WHERE æ¢ä»¶ä¸­ operator æ”¯æŒ ç­‰æ–¼ =ã€ä¸ç­‰æ–¼ \u0026lt;\u0026gt; OR !=ã€ LIKE =~ã€ NOT LIKE !~\nWITH ç‚ºå¿…å¡«æ”¯æ´æŒ‡å®šçš„ tag_keyã€æ­£å‰‡è¡¨é”å¼å’Œå¤šå€‹ tag_key (IN)\n1 2 3 4 5 6 7 8 \u0026gt; SHOW TAG VALUES ON \u0026#34;NOAA_water_database\u0026#34; WITH KEY IN (\u0026#34;location\u0026#34;,\u0026#34;randtag\u0026#34;) WHERE \u0026#34;randtag\u0026#34; =~ /./ LIMIT 3 name: h2o_quality key value --- ----- location coyote_creek location santa_monica randtag\t1 WHERE æ¢ä»¶ä¸­é‚„èƒ½å¸¶å…¥ time é™ç¸®ï¼Œåªæœ‰ç•¶æ¢ä»¶ç‚º time æ™‚æ‰å¯ä»¥ä½¿ç”¨ \u0026gt; \u0026lt; ã€‚ ç•¶ä»¥æ™‚é–“ç‚ºæ¢ä»¶æ™‚ï¼Œå¯¦éš›ä¸Šæ˜¯ä½¿ç”¨ shard ç‚ºç²’åº¦ï¼Œæœƒåˆ¤æ–·è©²æ™‚é–“æ‰€å±¬å“ªä¸€å€‹ shard ä»¥æ­¤é€²è¡Œç¯©é¸ï¼Œæ‰€ä»¥æœƒå‡ºç¾è¶…å‡º time ç¯„åœçš„è³‡æ–™ã€‚\nSHOW Field Keys 1 SHOW FIELD KEYS [ON \u0026lt;database_name\u0026gt;] [FROM \u0026lt;measurement_name\u0026gt;] ON \u0026lt;database_name\u0026gt; é›–ç„¶æ˜¯é¸å¡«çš„ï¼Œä½†æ˜¯è‹¥ä¸å¸¶å…¥å¿…é ˆå…ˆé‹è¡Œ USE \u0026lt;database_name\u0026gt;ã€‚\nWHERE æ¢ä»¶ä¸­é‚„èƒ½å¸¶å…¥ time é™ç¸®ï¼Œåªæœ‰ç•¶æ¢ä»¶ç‚º time æ™‚æ‰å¯ä»¥ä½¿ç”¨ \u0026gt; \u0026lt; ã€‚ ç•¶ä»¥æ™‚é–“ç‚ºæ¢ä»¶æ™‚ï¼Œå¯¦éš›ä¸Šæ˜¯ä½¿ç”¨ shard ç‚ºç²’åº¦ï¼Œæœƒåˆ¤æ–·è©²æ™‚é–“æ‰€å±¬å“ªä¸€å€‹ shard ä»¥æ­¤é€²è¡Œç¯©é¸ï¼Œæ‰€ä»¥æœƒå‡ºç¾è¶…å‡º time ç¯„åœçš„è³‡æ–™ã€‚\nField Values åœ¨ä¸åŒçš„ shard å…è¨±ä¸åŒçš„è³‡æ–™å‹æ…‹ï¼Œå› æ­¤ SHOW FIELD KEYS æœƒè¿”å›æ‰€æœ‰çš„è³‡æ–™å‹æ…‹ï¼Œå¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 \u0026gt; SHOW FIELD KEYS FROM cpu name: cpu fieldKey fieldType -------- --------- all_the_types integer all_the_types float all_the_types string all_the_types boolean ","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/show-schema/","title":"InfluxDB 1.X show schema"},{"content":"æ¬Šé™ é–‹å•Ÿé©—è­‰ å»ºç«‹ admin å¸³è™Ÿ\n1 CREATE USER \u0026lt;username\u0026gt; WITH PASSWORD \u0026#39;\u0026lt;password\u0026gt;\u0026#39; WITH ALL PRIVILEGES èª¿æ•´è¨­å®šæª”\né è¨­æƒ…æ³ä¸‹æ˜¯æ²’æœ‰é–‹å•Ÿé©—è­‰çš„ï¼Œéœ€è¦å…ˆåˆ°è¨­å®šæª”/etc/influxdb/influxdb.conf å°‡ [http] åº•ä¸‹çš„ auth-enabled æ¸¬å®šç‚º true\n1 2 3 4 ... [http] auth-enabled = true ... é‡å•Ÿ\n1 systemctl restart influxdb ç™»å…¥æ–¹å¼ HTTP API ç•¶ä½¿ç”¨ HTTP API æ™‚ï¼Œæœ‰ä»¥ä¸‹å…©ç¨®ç™»å…¥æ–¹å¼ã€‚\næŸ¥è©¢æ™‚ï¼ŒåŠ å…¥ -u \u0026lt;username\u0026gt;:\u0026lt;password\u0026gt; é€²è¡Œé©—è­‰ï¼Œæ­¤ç‚ºæ¨è–¦çš„æ–¹å¼ã€‚ 1 curl -G http://localhost:8086/query -u root:root --data-urlencode \u0026#34;q=SHOW DATABASES\u0026#34; æŸ¥è©¢æ™‚ï¼ŒåŠ å…¥ --data-urlencode \u0026quot;u=\u0026lt;username\u0026gt;\u0026quot; --data-urlencode \u0026quot;p=\u0026lt;password\u0026gt;\u0026quot; é€²è¡Œé©—è­‰ã€‚ 1 curl -G http://localhost:8086/query --data-urlencode \u0026#34;u=root\u0026#34; --data-urlencode \u0026#34;p=root\u0026#34; --data-urlencode \u0026#34;q=SHOW DATABASES\u0026#34; CLI ç•¶ä½¿ç”¨ CLI æ™‚ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç¨®ç™»å…¥æ–¹å¼ã€‚\nè¨­ç½®ç’°å¢ƒè®Šæ•¸å¾Œï¼Œç›´æ¥ç™»å…¥ã€‚ 1 2 3 export INFLUX_USERNAME=root export INFLUX_PASSWORD=root influx ç™»å…¥æ™‚ä½¿ç”¨ -username å’Œ -password é¸é …å¸¶å…¥å¸³è™Ÿå¯†ç¢¼ã€‚ 1 influx -username root -password root é€²å…¥ influxdb å¾Œï¼Œä½¿ç”¨ auth æŒ‡ä»¤é©—è­‰ã€‚ 1 2 3 4 5 6 [root@localhost lib]# influx Connected to http://localhost:8086 version 1.8.3 InfluxDB shell version: 1.8.3 \u0026gt; auth username: root password: æ¬Šé™ç®¡ç† æ¬Šé™ ç¸½å…±æœ‰ä»¥ä¸‹å››ç¨®æ¬Šé™ï¼\nALL PRIVILEGESï¼š admin æ¬Šé™ã€‚ READ ON \u0026lt;database_name\u0026gt;ï¼šå° \u0026lt;database_name\u0026gt; æœ‰ SELECTã€SHOW æ¬Šé™ã€‚ WRITE ON \u0026lt;database_name\u0026gt;ï¼šå° \u0026lt;database_name\u0026gt; æœ‰ INSERT æ¬Šé™ã€‚ ALL ON \u0026lt;database_name\u0026gt;ï¼šå° \u0026lt;database_name\u0026gt; æœ‰ INSERTã€SELECT å’Œ SHOW æ¬Šé™ã€‚ æŒ‡ä»¤ é¡¯ç¤ºæ‰€æœ‰ USER\n1 SHOW USERS å»ºç«‹ USER\nç•¶ \u0026lt;username\u0026gt; åŒ…å«ä¿ç•™å­—ã€ç‰¹æ®Šç¬¦è™Ÿæˆ–æ•¸å­—é–‹é ­æ™‚ï¼Œå¿…é ˆä½¿ç”¨ \u0026quot; åŒ…èµ·ä¾†ã€‚\n\u0026lt;password\u0026gt; å¿…é ˆä½¿ç”¨ ' åŒ…èµ·ä¾†ï¼Œç•¶åŒ…å« ' æˆ– æ›è¡Œç¬¦è™Ÿæ™‚ï¼Œéœ€ä½¿ç”¨ / è½‰è­¯ã€‚\n1 2 3 4 5 -- å»ºç«‹ admin user CREATE USER \u0026#34;\u0026lt;username\u0026gt;\u0026#34; WITH PASSWORD \u0026#39;\u0026lt;password\u0026gt;\u0026#39; WITH ALL PRIVILEGES -- å»ºç«‹é admin user CREATE USER \u0026#34;\u0026lt;username\u0026gt;\u0026#34; WITH PASSWORD \u0026#39;\u0026lt;password\u0026gt;\u0026#39; åˆªé™¤ USER\n1 DROP USER \u0026lt;username\u0026gt; çµ¦äºˆæ¬Šé™\n1 2 3 4 5 -- æ–°å¢ admin æ¬Šé™ GRANT ALL PRIVILEGES TO \u0026lt;username\u0026gt; -- æ–°å¢ éadmin æ¬Šé™ GRANT [READ,WRITE,ALL] ON \u0026lt;database_name\u0026gt; TO \u0026lt;username\u0026gt; é¡¯ç¤º USER æ¬Šé™\n1 SHOW GRANTS FOR \u0026lt;user_name\u0026gt; ç§»é™¤æ¬Šé™\n1 2 3 4 5 -- ç§»é™¤ admin æ¬Šé™ REVOKE ALL PRIVILEGES FROM \u0026lt;username\u0026gt; -- ç§»é™¤ éadmin æ¬Šé™ REVOKE [READ,WRITE,ALL] ON \u0026lt;database_name\u0026gt; FROM \u0026lt;username\u0026gt; é‡è¨­å¯†ç¢¼\n1 SET PASSWORD FOR \u0026lt;username\u0026gt; = \u0026#39;\u0026lt;password\u0026gt;\u0026#39; åƒè€ƒ Authentication and authorization in InfluxDB - influxdata æ–‡æª”\n","date":"2021-01-22T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-1-cr-ud/privilege/","title":"InfluxDB 1.X æ¬Šé™ç®¡ç†"},{"content":"InfluxDB å„²å­˜å¼•æ“æ˜¯ TSM ä¸»è¦æ˜¯æ ¹æ“š LSM å„ªåŒ–è€Œä¾†çš„\nç›®éŒ„èˆ‡æª”æ¡ˆçµæ§‹ InfluxDB çš„è³‡æ–™å¤¾ä¸‹ï¼Œå¤§ç•¥æ˜¯ä»¥ä¸‹çµæ§‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /var/lib/influxdb |-- data | |-- test | |-- _series | | |-- 00 | | | `-- 0000 | `-- autogen | `-- 140 | |-- 000000002-000000003.tsm | `-- fields.idx |-- meta | `-- meta.db `-- wal |-- test `-- autogen `-- 140 `-- _00004.wal æ¯ä¸€å€‹ shard(å¦‚ï¼š140) éƒ½æœƒæœ‰ä¸€å€‹è‡ªå·±çš„è³‡æ–™å¤¾ï¼Œè³‡æ–™å¤¾ä¸‹åŒ…å«ä»¥ä¸‹è³‡æ–™ï¼š\ndata #####.tsmï¼šå¯¦éš›å„²å­˜æ•¸æ“šçš„æ–‡ä»¶ã€‚ #####.tombstoneï¼šç´€éŒ„åˆªé™¤çš„æ•¸æ“šï¼Œç•¶ TSM Files é‡å¯«å£“ç¸®åˆªé™¤äº†æ•¸æ“šå¾Œï¼Œæœƒå°‡æ­¤æª”æ¡ˆåˆªé™¤ã€‚ fields.idxï¼šå­˜æ”¾ fields çš„ metadataã€‚ meta meta.dbï¼šç”¨ä¾†å„²å­˜ InfluxDB çš„ metadataï¼ŒåŒ…æ‹¬ usersã€databases ã€ retention policiesã€shards å’Œ continuous queriesã€‚ wal #####.walï¼šæ•¸æ“šå¯«å…¥æ™‚ï¼Œæœƒå…ˆ appended åˆ° WAL æ–‡ä»¶é¿å…æ•¸æ“šä¸Ÿå¤±ã€‚ ç•¶ Compact åˆ° TSM Files å¾Œï¼Œæœƒåˆªé™¤å°æ‡‰çš„ WAL æ–‡ä»¶é‡‹æ”¾ç©ºé–“ã€‚ TSM çµ„ä»¶ WAL (Write Ahead Log) ä¸€ç¨®å°ˆé–€é‡å°å¯«å…¥å„ªåŒ–çš„å„²å­˜æ ¼å¼ï¼Œå¯«å…¥æ™‚æ˜¯å°‡è³‡æ–™ append åˆ° WAL Fileï¼Œé€éé †åºå¯«å…¥ Disk çš„æ–¹å¼ï¼Œå¤§å¹…æå‡æ•¸æ“šå¯«å…¥çš„æ€§èƒ½ ï¼Œä½†ä¹Ÿå› æ­¤çŠ§ç‰²äº†è®€å–çš„æ€§èƒ½ã€‚\nå¯«å…¥è³‡æ–™æ™‚ï¼Œé™¤äº†å¯«å…¥ Cache é‚„æœƒå¯«å…¥ WAL ç¢ºä¿æ•¸æ“šä¸æœƒä¸Ÿå¤±ï¼Œç”¨é€”é¡ä¼¼æ–¼ MySQL çš„ binlog ã€‚\nWAL è¢«å„²å­˜æˆ _00001.wal é€™ç¨®æ¨£å­çš„æª”æ¡ˆï¼Œæ¯ç•¶ä¸€å€‹æª”æ¡ˆåˆ°é” 10MB ä¹‹å¾Œæœƒå†å‰µå»ºä¸€å€‹æ–°çš„ WAL æ–‡ä»¶ä¸¦éå¢ç·¨è™Ÿï¼Œå¦‚ï¼š _00002.walã€‚\nCache å¯«å…¥è³‡æ–™æ™‚ï¼Œé™¤äº†å¯«å…¥ WAL é‚„æœƒå¯«å…¥ Cacheï¼Œ cache æ˜¯ WAL æ–‡ä»¶ä¸­çš„æ•¸æ“šåœ¨å…§å­˜ä¸­çš„ç·©å­˜ï¼Œå› æ­¤å¯ä»¥é€éé‡æ–°è®€å– WAL æ–‡ä»¶ï¼Œé‡æ–°å‰µå»º cache ç·©å­˜ã€‚\nåœ¨æŸ¥è©¢æ•¸æ“šæ™‚ï¼Œæœƒå°‡ Cache å’Œ TSM Files çš„æ•¸æ“šé€²è¡Œåˆä½µï¼Œåœ¨ Cache ä¸­çš„æ•¸æ“šå„ªå…ˆåº¦è¼ƒé«˜ã€‚\nå’Œ TSM Files ä¸åŒï¼Œç·©å­˜åœ¨ cache å…§çš„æ•¸æ“šä¸æœƒè¢«å£“ç¸®ã€‚\ncache æœ‰ 2 å€‹å¾ˆé‡è¦çš„è¨­å®šï¼Œæ¯æ¬¡å¯«å…¥æ•¸æ“šæ™‚éƒ½æœƒæª¢æŸ¥ä»¥ä¸‹é–¾å€¼ï¼š\nç•¶ cache å…§çš„è³‡æ–™é”åˆ° cache-snapshot-memory-size(é è¨­25M) æ‰€è¨­å®šçš„å¤§å°æ™‚ï¼Œæœƒå°‡æ•¸æ“šå¯«å…¥ TSM Files ä¸¦é‡‹æ”¾å…§å­˜ç©ºé–“ã€‚ ç•¶ cache å…§çš„è³‡æ–™è¶…é cache-max-memory-size(é è¨­1G) è¨­å®šçš„å¤§å°æ™‚ï¼Œå‰‡æœƒæ‹’çµ•æ•¸æ“šå¯«å…¥ã€‚ æ­¤å¤–ï¼Œé‚„æœ‰ä¸€å€‹è¨­å®šï¼ cache-snapshot-write-cold-duration(é è¨­10m)ï¼Œç•¶è©² shard è¶…éé€™æ®µæ™‚é–“æ²’æœ‰æ”¶åˆ° insertã€delete è«‹æ±‚ä¹Ÿæœƒå°‡æ•¸æ“šå¯«å…¥ TSM Files é‡‹æ”¾å…§å­˜ç©ºé–“ã€‚\nTSM Files ç”¨æ–¼å­˜æ”¾ç¶“éå£“ç¸®çš„æ•¸æ“šã€‚\nFileStore ç”¨ä¾†ç®¡ç† TSM Filesï¼Œä¸¦å¯ä»¥ç¢ºä¿ TSM Files å†å£“ç¸®é‡å¯«æ™‚ä¿æŒ atomically(åŸå­æ€§)ã€‚\nCompactor è² è²¬å°‡ TSM Files é€²è¡Œå„ªåŒ–ï¼Œä¾¿æ–¼æŸ¥è©¢å’Œç¯€çœç©ºé–“ï¼Œé€éä»¥ä¸‹ 4 ç¨®æ–¹å¼ï¼š\nSnapshotsï¼šå°‡ Cache å’Œ WAL ä¸­çš„æ•¸æ“šè½‰æ›ç‚º TSM Filesï¼Œä¾†é‡‹æ”¾ WAL segment å’Œ Cache æ‰€ä½¿ç”¨çš„å…§å­˜å’Œç£ç¢Ÿç©ºé–“ã€‚ Level Compactionsï¼šåˆ†ç‚º 1~4 ç´šï¼Œæœƒå°‡ TSM Files å­˜ Snapshots å£“ç¸®åˆ° 1ç´šæ–‡ä»¶ï¼Œå†å°‡å¤šå€‹ 1ç´šæ–‡ä»¶å£“ç¸®æˆ 2ç´šæ–‡ä»¶ï¼Œç›´åˆ°æ–‡ä»¶é”åˆ° 4ç´šæˆ–è€…é”åˆ° TSM Files çš„æœ€å¤§å¤§å°é™ã€‚ä½ç´šåˆ¥çš„æ–‡ä»¶è¡¨ç¤ºæ•¸æ“šæ™‚é–“é»è¼ƒæ–°ï¼Œç‚ºäº†é¿å…è§£å£“ç¸®è€—è²»å¤§é‡ CPUï¼Œå› æ­¤ä½¿ç”¨è¼ƒä½çš„å£“ç¸®ç‡ã€‚é«˜ç´šåˆ¥çš„æ–‡ä»¶è¡¨ç¤ºæ•¸æ“šæ™‚é–“é»è¼ƒèˆŠï¼Œå› ç‚ºä½¿ç”¨çš„é »ç‡é™ä½ï¼Œæ‰€ä»¥ä½¿ç”¨è¼ƒé«˜çš„å£“ç¸®ç‡ã€‚ Index Optimizationï¼šç•¶ç©ç´¯äº†è¨±å¤š 4 ç´š TSM Files æ™‚ï¼Œ å…§éƒ¨ç´¢å¼•è¶Šä¾†è¶Šå¤§ï¼Œé€ æˆæœå°‹çš„æˆæœ¬å¢åŠ ï¼Œé€éå°‡ç›¸åŒ series çš„ points æ‹†åˆ†åˆ°ä¸€çµ„æ–°çš„ TSM Filesï¼Œè®“åŒä¸€å€‹ series ï¼Œé¿å…åŒä¸€å€‹ series çš„è³‡æ–™éœ€è¦è·¨è¶Šå¤šå€‹ TSM Files ä¾†æŸ¥è©¢ã€‚ Full Compactionï¼šç•¶è©² shard å·²ç¶“è®Šæˆå†·æ•¸æ“šï¼Œæˆ–è€… shard ä¸Šå‡ºç¾äº† delete æ“ä½œ ï¼ŒæœƒåŸ·è¡ŒåŒ…æ‹¬ Level Compactions å’Œ Index Optimization çš„æ‰€æœ‰å„ªåŒ–ï¼Œä»¥æ­¤ç”¢ç”Ÿæœ€ä½³çš„ TSM Filesï¼Œé™¤éè©² shard æœ‰å¿ƒçš„ insertã€delete ï¼Œå¦å‰‡ä¸æœƒå†åŸ·è¡Œå…¶ä»– compactionã€‚ Compaction Planner æ±ºå®šå“ªäº› TSM Files å¯ä»¥é€²è¡Œå£“ç¸®ï¼Œä¸¦ç¢ºä¿å¤šå€‹ä½µç™¼çš„ Compactor ä¸æœƒäº’ç›¸å½±éŸ¿ã€‚\nCompression æ ¹æ“šä¸åŒçš„è³‡æ–™å‹æ…‹å°è³‡æ–™é€²è¡Œå£“ç¸®å’Œè§£ç¢¼ã€‚\nè³‡æ–™æµ INSERT INSERT æ“ä½œæœƒè¢« appended åˆ°ç•¶å‰çš„ WAL segmentï¼Œä¸¦ä¸”ä¹Ÿæœƒè¢«å¯«åˆ° cache ä¸­ã€‚\nç•¶ WAL segment é”åˆ° 10MB ä¹‹å¾Œï¼Œæœƒé—œé–‰ä¸¦å»ºç«‹ä¸€å€‹æ–°çš„ WAL segmentã€‚ ç•¶ WAL segment è¢«é—œé–‰å¾Œï¼Œå‰‡æœƒåŸ·è¡Œ Snapshots å°‡è³‡æ–™å¯«å…¥ TSM Files ä¸¦ä¸” fsync åˆ°ç¡¬ç¢Ÿä¸Šï¼Œéš¨å¾Œè®“ FilsStore é€²è¡ŒåŠ è¼‰å’Œå¼•ç”¨ã€‚ ç•¶ cache å…§ç·©å­˜çš„æ•¸æ“šé‡é”åˆ° cache-snapshot-memory-size æ™‚ï¼Œä¹Ÿæœƒå•Ÿå‹• Snapshotsã€‚ ç•¶ cache å…§ç·©å­˜çš„æ•¸æ“šé‡é€²ä¸€æ­¥é”åˆ° cache-max-memory-size æ™‚ï¼Œå‰‡æœƒæ‹’çµ•å¯«å…¥ç›´åˆ° Snapshots ç·šç¨‹å°‡ cache é‡‹æ”¾ã€‚ UPDATE é‡å°å·²ç¶“å¯«å…¥çš„ Points å¯«å…¥æ–°çš„å€¼ï¼Œåœ¨ InfluxDB ä¸­ç­‰åŒæ–¼ INSERT æ“ä½œï¼Œè¼ƒæ–°å¯«å…¥çš„å€¼å…·æœ‰å„ªå…ˆæ¬Šæœƒè¦†è“‹èˆŠçš„å€¼ã€‚\nDELETE DELETE åœ¨ WAL segment å¯«å…¥ä¹‹å¾Œï¼Œæœƒæ›´æ–° Cache å’Œ FileStore ä¾†é€²è¡Œåˆªé™¤ã€‚\nåˆªé™¤ Cache å…§çš„ç›¸é—œæ•¸æ“šã€‚ FileStore æœƒåœ¨ TSM è³‡æ–™å¤¾ä¸‹å»ºç«‹ .tombstone æª”æ¡ˆï¼Œç•¶å¾ TSM Files æŸ¥è©¢æ•¸æ“šæ™‚æœƒæ¯”å° .tombston çš„æ•¸æ“šä¾†éæ¿¾åˆªé™¤çš„æ•¸æ“šã€‚ ç•¶è§¸ç™¼ Compactor é‡å¯«å£“ç¸® TSM Files æ™‚ï¼Œæœƒé€é .tombstone è®“åˆªé™¤çš„æ•¸æ“šä¸å†å¯«å…¥æ–°çš„ TSM Filesï¼Œé”æˆçœŸæ­£åˆªé™¤æ•¸æ“šçš„å‹•ä½œã€‚ SELECT SELECT æ“ä½œé€é FileStore å’Œ Cache è®€å–è³‡æ–™ã€‚\nCache ä¸­çš„å€¼å› ç‚ºè¼ƒæ–°ï¼Œæ‰€ä»¥æœƒ overlaid(è¦†è“‹) åœ¨ FileStore è¿”å›çš„å€¼ä¸Šã€‚ åƒè€ƒ In-memory indexing and the Time-Structured Merge Tree (TSM) - influxdata æ–‡æª”\ninfluxdb/tsdb/engine/tsm1/DESIGN.md - github\nLSM Tree å­¦ä¹ ç¬”è®° - fatedier blog\nInfluxDBè¯¦è§£ä¹‹TSMå­˜å‚¨å¼•æ“è§£æï¼ˆä¸€ï¼‰ - fatedier blog\nInfluxDBè¯¦è§£ä¹‹TSMå­˜å‚¨å¼•æ“è§£æï¼ˆäºŒï¼‰ - fatedier blog\n","date":"2021-01-18T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-introduction-3/","title":"InfluxDB ç°¡ä»‹ - 3"},{"content":"InfluxDB æ ¸å¿ƒè¡“èª Database å°æ‡‰ SQL ä¸­çš„ databaseã€‚ä¸åŒçš„ database è³‡æ–™å­˜æ”¾åœ¨ä¸åŒç›®éŒ„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 -- influxDB \u0026gt; create database test; \u0026gt; show databases; name: databases name ---- _internal test \u0026gt; use test; Using database test -- linux root@e6c0eae8a31f:/var/lib/influxdb/data# ls -l total 0 drwx------ 4 root root 36 Nov 3 02:49 _internal drwx------ 4 root root 36 Nov 13 10:05 test Retention Policy ç”¨ä¾†è¨­å®šæ•¸æ“šä¿ç•™ç­–ç•¥ï¼ŒéæœŸçš„æ•¸æ“šæœƒè¢«åˆªé™¤ã€‚åŒ…å«ä»¥ä¸‹ä¸‰å€‹å…ƒç´ ï¼\ndurationï¼šç”¨ä¾†æè¿° influxDB æœƒä¿å­˜æ•¸æ“šå¤šä¹…ã€‚ replication factorï¼šæ•¸æ“šå­˜åœ¨ cluster è£¡é¢çš„å‰¯æœ¬æ•¸é‡ï¼Œé–‹æºç‰ˆæœ¬åªæœƒæ˜¯ 1ã€‚ shard (group) durationï¼šè¡¨ç¤ºä¸€å€‹ shard (group) è·¨è¶Šäº†å¤šå°‘çš„æ™‚é–“ã€‚ ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 -- autogen ç‚ºé»˜èªçš„ä¿ç•™ç­–ç•¥ï¼Œæ•¸æ“šä¿ç•™æ™‚é–“ç‚ºæ°¸ä¹… \u0026gt; show retention policies; name duration shardGroupDuration replicaN default ---- -------- ------------------ -------- ------- autogen 0s 168h0m0s 1 true \u0026gt; show shards name: test id database retention_policy shard_group start_time end_time expiry_time owners -- -------- --------------- ----------- ---------- -------- ----------- ------ 12 test autogen 12 2020-11-09T00:00:00Z 2020-11-16T00:00:00Z 2020-11-16T00:00:00Z 16 test autogen 16 2020-11-16T00:00:00Z 2020-11-23T00:00:00Z 2020-11-23T00:00:00Z 24 test autogen 24 2020-11-23T00:00:00Z 2020-11-30T00:00:00Z 2020-11-30T00:00:00Z 32 test autogen 32 2020-11-30T00:00:00Z 2020-12-07T00:00:00Z 2020-12-07T00:00:00Z Shard é¡ä¼¼æ–¼ MySQL çš„ partition åœ¨åŒä¸€å€‹å¯¦ä¾‹ä¸Šå°‡ä¸€å¼µ table åˆ‡ç‚ºå¤šå€‹å¯¦é«”æª”æ¡ˆã€‚\nåŒ…å«å¯¦éš›çš„æ•¸æ“šï¼Œåœ¨ disk ä¸Šå„²å­˜ç‚º TSM æ–‡ä»¶ï¼Œæ¯ä¸€å€‹ shard éƒ½åŒ…å«äº†ä¸€å€‹å½¼æ­¤ä¸é‡è¤‡çš„æ™‚é–“æ®µã€‚\n1 2 3 4 5 6 7 8 \u0026gt; show shards name: test id database retention_policy shard_group start_time end_time expiry_time owners -- -------- --------------- ----------- ---------- -------- ----------- ------ 12 test autogen 12 2020-11-09T00:00:00Z 2020-11-16T00:00:00Z 2020-11-16T00:00:00Z 16 test autogen 16 2020-11-16T00:00:00Z 2020-11-23T00:00:00Z 2020-11-23T00:00:00Z 24 test autogen 24 2020-11-23T00:00:00Z 2020-11-30T00:00:00Z 2020-11-30T00:00:00Z 32 test autogen 32 2020-11-30T00:00:00Z 2020-12-07T00:00:00Z 2020-12-07T00:00:00Z 1 2 3 4 5 6 7 root@e6c0eae8a31f:/var/lib/influxdb# tree ./data/test/autogen test |-- autogen |-- 12 `-- 16 |-- 000000003-000000002.tsm `-- fields.idx Shard groups é¡ä¼¼æ–¼ Mongo çš„ shardingï¼Œå°‡åŒå€‹ table çš„è³‡æ–™åˆ†æ•£åˆ°ä¸åŒçš„å¯¦ä¾‹ä¸Šã€‚\nshard çš„ logical containersï¼Œæ¯å€‹ shard éƒ½åªæœƒå±¬æ–¼å…¶ä¸­ä¸€å€‹ shard groupï¼ŒInfluxDB å°‡æ•¸æ“šé€²è¡Œ hash å¯«å…¥åˆ°ä¸åŒçš„ serverï¼Œæ¯å€‹ server åŒä¸€å€‹æ™‚é–“å€é–“çš„æ‰€æœ‰shard å°±å±¬æ–¼åŒä¸€å€‹ shard groupã€‚\næ­¤ç‚ºä»˜è²»ç‰ˆæœ¬çš„ cluster åŠŸèƒ½ï¼Œé–‹æºçš„å–®å¯¦ä¾‹ç‰ˆæœ¬ç„¡æ­¤åŠŸèƒ½ã€‚\nShard (group) duration è¡¨ç¤ºä¸€å€‹ shard (group) è·¨è¶Šäº†å¤šå°‘çš„æ™‚é–“ï¼Œå¯ä»¥åœ¨ retention policy ä¸­è¨­å®šã€‚\nMeasurement å°æ‡‰ SQL ä¸­çš„ tableï¼Œä½†ä¸éœ€è¦é å…ˆå»ºç«‹ï¼Œinsert è³‡æ–™æ™‚è‡ªå‹•å»ºç«‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026gt; show measurements \u0026gt; INSERT cpu,host=A loading=0.65 \u0026gt; show measurements name: measurements name ---- cpu \u0026gt; select * from \u0026#34;cpu\u0026#34; name: cpu time host loading ---- ---- ------- 1605592932144992788 A 0.65 Timestamp æ•¸æ“šé—œè¯çš„æ™‚é–“é»ï¼Œåœ¨ InfluxDB è£¡çš„æ‰€æœ‰æ™‚é–“éƒ½æ˜¯ UTCã€‚\nField (set) å„²å­˜ metadata å’Œ çœŸå¯¦æ•¸æ“šã€‚ä½œç‚ºæŸ¥è©¢æ¢ä»¶ä¸æœƒè¢«ç´¢å¼•ï¼Œåªèƒ½å…¨è¡¨æƒæã€‚\nfield keyï¼šå’Œ MySQL ä¸­æ²’æœ‰å»ºç«‹ index çš„ column æ¦‚å¿µç›¸ä¼¼ã€‚ field valueï¼šfield key æ‰€å°æ‡‰çš„å€¼ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 -- é™¤äº† time ä»¥å¤–ï¼Œé‚„æœ‰ host å’Œ loading 2å€‹æ¬„ä½ \u0026gt; select * from \u0026#34;cpu\u0026#34; name: cpu time host loading ---- ---- ------- 1605592932144992788 A 0.65 \u0026gt; show field keys from cpu; name: cpu fieldKey fieldType -------- --------- loading float -- loading æ˜¯ field key -- 0.65 æ˜¯ field value -- loading = 0.65 æ˜¯ field set Tag (set) é¸ç”¨ï¼Œç”¨æ–¼å„²å­˜å¸¸ç”¨çš„ metadataã€‚ä½œç‚ºæŸ¥è©¢æ¢ä»¶æœƒè¢«ç´¢å¼•ï¼ŒæŸ¥è©¢æ•ˆç‡é«˜ã€‚\nTag keyï¼šå’Œ MySQL ä¸­æœ‰å»ºç«‹ index çš„ column æ¦‚å¿µç›¸ä¼¼ã€‚ Tag valueï¼štag key æ‰€å°æ‡‰çš„å€¼ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 -- é™¤äº† time ä»¥å¤–ï¼Œé‚„æœ‰ host å’Œ loading 2å€‹æ¬„ä½ \u0026gt; select * from \u0026#34;cpu\u0026#34; name: cpu time host loading ---- ---- ------- 1605592932144992788 A 0.65 \u0026gt; show tag keys from cpu; name: cpu tagKey ------ host -- host æ˜¯ tag key -- A æ˜¯ tag value -- host = A æ˜¯ tag set Series æ“æœ‰ç›¸åŒ measurement å’Œ tag set çš„çµæœé›†ã€‚\nseries keyï¼š ç”± measurementã€ tag set å’Œ field key å®šç¾©ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \u0026gt; select * from cpu name: cpu time comment host loading ---- ------- ---- ------- 1605592932144992788 new A 0.65 1605592932144992788 B 0.05 1605592932144992790 next A 0.85 \u0026gt; show series from cpu key --- cpu,host=A cpu,host=B # ä¸Šè¿°ä¾‹å­ä¸­æœ‰å…©å€‹ series cpu,host=A 1605592932144992788 new A 0.65 1605592932144992790 next A 0.85 cpu,host=B 1605592932144992788 B 0.05 # ä¸Šè¿°ä¾‹å­ä¸­ series key æœ‰ä»¥ä¸‹4çµ„ cpu, host=A loading cpu, host=A comment cpu, host=B loading cpu, host=B comment Point å°æ‡‰ MySQL ä¸­ä¸€å€‹å®Œæ•´çš„ Rowï¼Œç”± measurementã€ tag setã€ field set å’Œ timestampçµ„æˆã€‚\nåœ¨åŒä¸€å€‹ series åº•ä¸‹æ™‚ï¼ŒåŒä¸€å€‹ timestamp åªæœƒæœ‰ä¸€å€‹ point ï¼Œå› æ­¤ series + timestamp å¯ä»¥è¦–ç‚º MySQL çš„ Primary keyã€‚\nè‹¥åœ¨åŒä¸€å€‹ series + timestamp INSERT è³‡æ–™ï¼Œfield æœƒåˆä½µï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š\nseries ç‚º cpu,host=Aï¼Œå› æ­¤åœ¨ cpu è£¡é¢ host = A ä¸” time=1605592932144992788 åªæœƒæœ‰ä¸€ç­†ç´€éŒ„ã€‚\n1 2 3 4 5 6 7 8 9 10 \u0026gt; select * from \u0026#34;cpu\u0026#34; name: cpu time host loading ---- ---- ------- 1605592932144992788 A 0.65 \u0026gt; show series from cpu key --- cpu,host=A æ–°å¢ series ç›¸åŒï¼Œä½† field key ä¸åŒçš„è³‡æ–™ï¼Œæœƒç™¼ç¾è³‡æ–™åˆä½µã€‚\n1 2 3 4 5 6 \u0026gt; INSERT cpu,host=A comment=\u0026#34;old\u0026#34; 1605592932144992788 \u0026gt; select * from cpu name: cpu time comment host loading ---- ------- ---- ------- 1605592932144992788 old A 0.65 æ–°å¢ series ç›¸åŒï¼Œä¸” field key ç›¸åŒçš„è³‡æ–™ï¼Œå‰‡æœƒç™¼ç¾è³‡æ–™è¢«è¦†è“‹ã€‚\n1 2 3 4 5 6 7 \u0026gt; INSERT cpu,host=A loading=0.05,comment=\u0026#34;new\u0026#34; 1605592932144992788 \u0026gt; select * from cpu name: cpu time comment host loading ---- ------- ---- ------- 1605592932144992788 new A 0.05 åƒè€ƒ influxdata - data elements\ninfluxdata - Simplifying InfluxDB: Shards and Retention Policies\ninfluxDB shard - Goèªè¨€ä¸­æ–‡ç¶²\n","date":"2021-01-10T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-introduction-2/","title":"InfluxDB ç°¡ä»‹ - 2"},{"content":"æ™‚é–“åºåˆ—æ•¸æ“š(Time Series Data) æ™‚é–“åºåˆ—æ•¸æ“šæ˜¯åœ¨ä¸€æ®µæ™‚é–“å…§é‡è¤‡æ¸¬é‡å–å¾—çš„çµæœé›†ï¼Œå¦‚ CPU ä½¿ç”¨ç‡éš¨æ™‚é–“çš„è®ŠåŒ–ã€‚\næ™‚åºæ•¸æ“šä»¥æ™‚é–“ä½œç‚ºä¸»è¦çš„æŸ¥è©¢ç¶­åº¦ï¼Œå°‡é€£çºŒçš„å¤šå€‹æ™‚åºæ•¸æ“šç¹ªè£½æˆå ±è¡¨ï¼Œå¯ä»¥ç”¨æ–¼æ­ç¤ºèƒŒå¾Œçš„è¶¨å‹¢ã€è¦å¾‹å’Œç•°å¸¸ï¼Œåšç‚ºé æ¸¬å’Œé è­¦çš„ä¾æ“šã€‚\næ™‚åºæ•¸æ“šå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š\nä¸è®Šæ€§ï¼šå› ç‚ºè³‡æ–™æ˜¯æ­·å²æ•¸æ“šï¼Œä¸€æ—¦ç”¢ç”Ÿå°±ä¸æœƒåœ¨ç•°å‹•ã€‚ å”¯ä¸€æ€§ï¼šåŒä¸€å€‹æ™‚é–“åŒä¸€å€‹å°è±¡åŒä¸€å€‹æŒ‡æ¨™ï¼Œåªæœƒæœ‰ä¸€å€‹å€¼ã€‚ æŒ‰æ™‚é–“æ’åºï¼šæ™‚é–“ä¸»è¦çš„åº§æ¨™è»¸ï¼Œæ•¸æ“šéš¨è‘—æ™‚é–“é †åºç”¢ç”Ÿã€‚ æ™‚é–“åºåˆ—æ•¸æ“šåˆ†ç‚ºå…©ç¨®é¡å‹ï¼š\nå®šæœŸæ”¶é›†åˆ°çš„ metrics(æŒ‡æ¨™)ï¼Œä¾‹å¦‚ï¼šç›£æ§ã€‚\nä¸å®šæœŸæ”¶é›†åˆ°çš„ events(äº‹ä»¶)ï¼Œä¾‹å¦‚ï¼šLogsã€‚\næ™‚åºå‹è³‡æ–™åº«(Time Series Databaseã€TSDB) TSDB å°ˆé–€è™•ç†å¸¶æœ‰ time-stamped çš„ metrics(æŒ‡æ¨™)ã€ events é€™ç¨®æ™‚é–“åºåˆ—æ•¸æ“šçš„æ•¸æ“šåº«ã€‚\nTSDB å’Œå…¶ä»–è³‡æ–™åº«çš„è² è¼‰ä¸åŒï¼š\nå¹³ç©©ã€æŒçºŒçš„é«˜ä½µç™¼çš„ INSERT æ™‚åºæ•¸æ“šï¼Œæ²’æœ‰ UPDATE æ“ä½œ è³‡æ–™çš„å„²å­˜å’Œå£“ç¸® æ•¸æ“šçš„ç”Ÿå‘½é€±æœŸç®¡ç† æ•¸æ“šå½™æ•´ å¤§ç¯„åœä¸”å¤§é‡çš„æ•¸æ“šæƒæ InfluxDB ç”± InfluxData ä½¿ç”¨ GO èªè¨€é–‹ç™¼çš„é–‹æº TSDBï¼Œä¸¦æä¾› SQL LIKE çš„æŸ¥è©¢èªè¨€ InfluxQLï¼Œåœ¨ DB-ENGINES Ranking æ™‚åºè¡Œæ•¸æ“šåº«ä¸­æ’åç¬¬ä¸€ã€‚\næ’åç¬¬äºŒçš„ Kdb+ å‰‡æ˜¯å•†æ¥­è»Ÿé«”ï¼Œåªæœ‰ 32 ä½å…ƒçš„å…è²»ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ï¼Œçˆ¬æ–‡èªªæ˜¯è¯çˆ¾è¡—å»£æ³›æ‡‰ç”¨æ–¼è¡Œæƒ…æœå‹™çš„ TSDBï¼Œä»¥é€Ÿåº¦å¿«è‘—ç¨±ã€‚\næ’åç¬¬ä¸‰çš„ Prometheus ä¹Ÿæ˜¯é–‹æº TSDBï¼Œå‰‡æ˜¯æ›´é©åˆæ‡‰ç”¨åœ¨ç›£æ§ç³»çµ±çš„å ´æ™¯ã€‚\nğŸ’¡ å»¶ä¼¸é–±è®€ï¼š åœ¨æ—©æœŸ InfluxDB æ˜¯å®Œå…¨é–‹æºçš„ï¼Œå¾Œä¾†ç‚ºäº†ç¶­æŒå…¬å¸é‹ç‡Ÿï¼Œå› è€Œé–‰æºäº†é›†ç¾¤ç‰ˆæœ¬ã€‚ åœ¨ 2017 çš„ Percona Live ä¸Š InfluxData åšäº†é–‹æºæ•¸æ“šåº«å•†æ¥­æ¨¡å‹æ­£é¢è‡¨å±æ©Ÿçš„æ¼”è¬›ï¼Œé›²æœå‹™ä¾›æ‡‰å•†(å¦‚ï¼šAWS) å°‡é–‹æºé …ç›®ä½œç‚º SaaS(è»Ÿé«”åŠæœå‹™) é€²è¡Œç‡Ÿåˆ©ç²å–å¤§éƒ¨åˆ†çš„åˆ©æ½¤ï¼Œè€Œä¸”å¤§éƒ¨åˆ†é‚„ä¸å›é¥‹é–‹æºç¤¾å€ï¼Œè¢«å…¶ç¨±ç‚ºé–‹æºå¸è¡€é¬¼ï¼Œä¹Ÿè®“éƒ¨åˆ†é–‹æºè»Ÿé«”ä¿®æ”¹äº†é–‹æºçš„è¨±å¯æ–¹å¼ï¼Œä¾‹å¦‚ï¼š MongoDBã€ Redisã€Kafka\u0026hellip;\u0026hellip; ç­‰ã€‚\nInfluxdata åœ˜éšŠé‚„æä¾›äº†ä¸€å€‹å®Œæ•´çš„ç”Ÿæ…‹ç’°å¢ƒ TICKï¼Œå…¶ä¸­é™¤äº† influxDB é‚„åŒ…å«äº†å…¶ä»–ä¸‰ç¨®è»Ÿé«”ï¼š\nTelegrafï¼šæ•¸æ“šæ”¶é›†å™¨ï¼Œå”åŠ©æ”¶é›†æŒ‡æ¨™çš„ agentï¼Œé¡ä¼¼ pmm ä¸­ pmm-client çš„è§’è‰²ã€‚ influxDBï¼šæ™‚åºæ•¸æ“šåº«ï¼Œç”¨ä¾†å„²å­˜æ™‚åºæ•¸æ“šçš„è³‡æ–™åº«ï¼Œé¡ä¼¼ pmm ä¸­ prometheus çš„è§’è‰²ã€‚ Chronografï¼šå¯è¦–åŒ– UIï¼Œç”¨ä¾†æŸ¥è©¢å±•ç¤º influxDB çš„æ•¸æ“šï¼Œé¡ä¼¼ pmm ä¸­ grafana çš„è§’è‰²ã€‚ Kapacitorï¼šè™•ç†å’Œç›£æ§æœå‹™ï¼Œç”¨æ–¼è™•ç†ã€ç›£æ§å’Œå‘Šè­¦æ™‚åºæ•¸æ“šçš„æ¡†æ¶ã€‚ åœ¨ 2020-11-10 Influxdata ç™¼ä½ˆäº† influxDB 2.0 (GA) ç‰ˆæœ¬ï¼Œç›®æ¨™æ˜¯å°‡ TICK æ•´åˆç‚ºä¸€å€‹æ•´é«”ï¼Œä¸¦æä¾›äº†æ–°çš„ Flux èªè¨€ç”¨ä¾†å–ä»£ Kapacitor åŸæœ¬ä½¿ç”¨çš„ TICKscriptã€‚\nåƒè€ƒ TSDBï¼š\ninfluxdata (å®˜æ–¹æ–‡æª” \u0026amp; blog)\ninfluxdata\ninfluxdata - What is time series data\ninfluxdata - TSDB\nä¸­æ–‡ blog\nInfluxdb Â· æºç åˆ†æ Â· Influxdb clusterå®ç°æ¢ç©¶\næ™‚é–“åºåˆ—æ•¸æ“šåº«(TSDB) - ç°¡æ›¸\nInfluxDBèˆ‡Prometheusç”¨åœ¨æ–¼ç›£æ§ç³»çµ±ä¸Šçš„æ¯”è¼ƒ\nå…¶ä»–\nDB-ENGINES Ranking of TSDB\nå¼€æºå±æœºï¼šäº‘è®¡ç®—å‚å•†æˆä¸ºå¼€æºå¸è¡€é¬¼ï¼Ÿ\næ—¶åºæ•°æ®åº“InfluxDB 2.0 alpha å‘å¸ƒï¼šä¸»æ¨æ–°çš„FluxæŸ¥è¯¢è¯­è¨€ï¼ŒTICKæ ˆå°†æˆä¸ºæ•´ä½“\nDolphinDB åœ¨å°æ¹¾æ°¸ä¸°é‡‘è¯åˆ¸çš„åº”ç”¨\n","date":"2021-01-04T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/influxdb-introduction-1/","title":"InfluxDB ç°¡ä»‹ - 1"},{"content":"pager å¯ä»¥åšåˆ° Linux ä¸­çš„ pipe(|)åŠŸèƒ½ï¼Œåªéœ€è¦ client ç«¯ä¸­è¼¸å…¥é—œéµå­— pagerä¸¦åŠ ä¸Š Linux shell å‘½ä»¤å³å¯ï¼Œè‹¥æœ‰çµæŸåªéœ€è¦å†æ¬¡è¼¸å…¥ pager å³å¯ã€‚\nç¯„ä¾‹ï¼šé€é grep -vï¼Œåœ¨ show processlist æ™‚éæ¿¾æ‰ä¸éœ€è¦çœ‹åˆ°çš„ user\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 mysql\u0026gt; show processlist; +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ | Id | User | Host | db | Command | Time | State | Info | +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ | 1 | event_scheduler | localhost | NULL | Daemon | 62 | Waiting on empty queue | NULL | | 3 | rep | gateway:56222 | NULL | Binlog Dump | 59 | Master has sent all binlog to slave; waiting for more updates | NULL | | 4 | root | localhost | NULL | Query | 0 | starting | show processlist | +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; pager grep -v rep PAGER set to \u0026#39;grep -v rep\u0026#39; mysql\u0026gt; show processlist; +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ | Id | User | Host | db | Command | Time | State | Info | +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ | 1 | event_scheduler | localhost | NULL | Daemon | 125 | Waiting on empty queue | NULL | | 4 | root | localhost | NULL | Query | 0 | starting | show processlist | +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ 3 rows in set (0.01 sec) mysql\u0026gt; pager Default pager wasn\u0026#39;t set, using stdout. ç¯„ä¾‹ï¼šé€é cat \u0026gt; /dev/nullï¼Œè®“æŸ¥è©¢ä¸é¡¯ç¤ºçµæœé›†åªé¡¯ç¤ºåŸ·è¡Œçµæœï¼Œå¯ä»¥ç”¨æ–¼æ–¹ä¾¿åªéœ€è¦å–®ç´”æ¯”å°æŸ¥è©¢åŸ·è¡Œæ™‚é–“çš„æƒ…å¢ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 mysql\u0026gt; select * from test; +----+------+------+ | id | name | age | +----+------+------+ | 0 | C | 26 | | 1 | A | 30 | | 2 | B | 25 | +----+------+------+ 3 rows in set (0.00 sec) mysql\u0026gt; pager cat \u0026gt; /dev/null PAGER set to \u0026#39;cat \u0026gt; /dev/null\u0026#39; mysql\u0026gt; select * from test; 3 rows in set (0.00 sec) mysql\u0026gt; pager Default pager wasn\u0026#39;t set, using stdout. ç¯„ä¾‹ï¼šæˆ‘å€‘éƒ½çŸ¥é“ show engine innodb status çš„è¼¸å‡ºå¾ˆé•·ï¼Œé€™æ™‚å€™å°±å¯ä»¥é€é less æ–¹ä¾¿æŸ¥çœ‹\n1 2 3 4 5 6 7 8 mysql\u0026gt; pager less PAGER set to \u0026#39;less\u0026#39; mysql\u0026gt; show engine innodb status\\G 1 row in set (0.00 sec) mysql\u0026gt; pager Default pager wasn\u0026#39;t set, using stdout. ç¯„ä¾‹ï¼šé€é awk å–å¾— Command çµæœï¼Œä¸¦é€é sort æ’åºï¼Œæœ€å¾Œ uniq -cå»é™¤é‡è¤‡ä¸¦è¨ˆç®—æ•¸é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 mysql\u0026gt; show processlist; +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ | Id | User | Host | db | Command | Time | State | Info | +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ | 1 | event_scheduler | localhost | NULL | Daemon | 1024 | Waiting on empty queue | NULL | | 3 | rep | gateway:56222 | NULL | Binlog Dump | 1021 | Master has sent all binlog to slave; waiting for more updates | NULL | | 6 | root | localhost | NULL | Query | 0 | starting | show processlist | +----+-----------------+---------------+------+-------------+------+---------------------------------------------------------------+------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; pager awk -F \u0026#39;|\u0026#39; \u0026#39;{print $6}\u0026#39; | sort | uniq -c PAGER set to \u0026#39;awk -F \u0026#39;|\u0026#39; \u0026#39;{print $6}\u0026#39; | sort | uniq -c\u0026#39; mysql\u0026gt; show processlist; 3 1 Binlog Dump 1 Command 1 Daemon 1 Query 3 rows in set (0.00 sec) prompt å¯ä»¥è‡ªå®šç¾© mysql çš„ promptï¼Œé è¨­ç‚º mysql\u0026gt; ã€‚\næœ‰ä»¥ä¸‹æ–¹å¼å¯ä»¥è¨­ç½®ï¼š\nè¨­å®šåœ¨ OS å±¤ï¼Œå¯ä»¥ä½¿ç”¨ $() ä¾†åšå‘½ä»¤æ›¿æ›ï¼š\nè¨­å®š MYSQL_PS1 ç’°å¢ƒè®Šæ•¸\n1 export MYSQL_PS1=\u0026#34;`hostname -s` \\r:\\m:\\s [\\d] mysql\u0026gt; \u0026#34; é€£ç·šæ™‚æŒ‡å®š\n1 mysql -u -p --prompt=\u0026#34;`hostname -s` \\r:\\m:\\s [\\d] mysql\u0026gt; \u0026#34; é€é aliase (å¯ä»¥å¯«åˆ° bashrc æŒä¹…åŒ–)\n1 alias mysql=\u0026#39;mysql --prompt=\u0026#34;`hostname -s` \\r:\\m:\\s [\\d] mysql\u0026gt; \u0026#34;\u0026#39; è¨­å®šåœ¨ my.cnf ä¸­\n1 2 [mysql] (æˆ– [client]) prompt= \u0026#34;hoståç¨± \\\\r:\\\\m:\\\\s [\\\\d] mysql\u0026gt;\\\\_\u0026#34; ä¸Šè¿°çš„æ‡‰ç”¨çµæœå¦‚ä¸‹ï¼š\n1 2 3 [root@test-11 ~]$ mysql -uGuCi -p Enter password: test-11 01:51:17 [(none)] mysql\u0026gt; åƒè€ƒ MySQL :: MySQL 8.0 Reference Manual :: 4.5.1.2 mysql Client Commands\n","date":"2020-09-20T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-client-command/","title":"MySQL Client Command"},{"content":"MySQL5.6 é–‹å§‹æ–°å¢äº† semi-join å„ªåŒ–äº† IN (SELECT ... FROM ...)ï¼Œä½†æœ‰ç›¸ä¼¼æ•ˆæœçš„ EXISTS åŠ NOT IN/EXISTS å»æ²’æœ‰é¡ä¼¼çš„å„ªåŒ–ï¼Œå¤§å¤šæ™‚å€™å¯èƒ½éƒ½å¿…é ˆé€éå…¶ä»–çš„æ–¹å¼ (ä¾‹å¦‚ï¼š LEFT JOIN) ä¾†é”åˆ°å„ªåŒ–çš„æ•ˆæœï¼Œä½†å¾ 8.0.16å’Œ 8.0.17 å¤§å®¶éƒ½èƒ½äº«å—åˆ°å„ªåŒ–ï¼Œå¯ä»¥æ›´æ„‰å¿«çš„ä½¿ç”¨é€™é¡èªæ³•å›‰ï¼\nå¯¦éš›åŸ·è¡Œ è¡¨çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 CREATE TABLE `member` ( `id` int NOT NULL, `name` varchar(20) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; INSERT INTO member VALUES(1,\u0026#39;Johnson\u0026#39;),(2,\u0026#39;John\u0026#39;),(3,\u0026#39;Son\u0026#39;); CREATE TABLE `orders` ( `id` int NOT NULL, `member_id` int NOT NULL, `amount` int NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; INSERT INTO orders VALUES(1,1,10),(2,2,20),(3,3,30); EXISTS å„ªåŒ– 8.0.16 ä¸­å„ªåŒ–äº† EXISTS ä¹Ÿå¯ä»¥åƒåˆ° IN çš„ semi-join å„ªåŒ–ï¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 -- 5.7.* mysql\u0026gt; EXPLAIN SELECT * FROM orders WHERE EXISTS(SELECT * FROM member ); +----+-------------+--------+-------+---------+-------------+ | id | select_type | table | type | key | Extra | +----+-------------+--------+-------+---------+-------------+ | 1 | PRIMARY | orders | ALL | NULL | NULL | | 2 | SUBQUERY | member | index | PRIMARY | Using index | +----+-------------+--------+-------+---------+-------------+ 2 rows in set, 1 warning (0.00 sec) mysql\u0026gt; SHOW WARNINGS\\G *************************** 1. row *************************** Level: Note Code: 1003 Message: /* select#1 */ select `test`.`orders`.`id` AS `id`, `test`.`orders`.`member_id` AS `member_id`, `test`.`orders`.`amount` AS `amount` from `test`.`orders` where 1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 -- 8.0.16 mysql\u0026gt; EXPLAIN SELECT * FROM orders WHERE EXISTS(SELECT * FROM member ); +----+-------------+--------+-------+---------+---------------------------------------+ | id | select_type | table | type | key | Extra | +----+-------------+--------+-------+---------+---------------------------------------+ | 1 | SIMPLE | member | index | PRIMARY | Using index; FirstMatch | | 1 | SIMPLE | orders | ALL | NULL | Using join buffer (Block Nested Loop) | +----+-------------+--------+-------+---------+---------------------------------------+ 2 rows in set, 1 warning (0.00 sec) mysql\u0026gt; SHOW WARNINGS\\G *************************** 1. row *************************** Level: Note Code: 1003 Message: /* select#1 */ select `test`.`orders`.`id` AS `id`, `test`.`orders`.`member_id` AS `member_id`, `test`.`orders`.`amount` AS `amount` from `test`.`orders` semi join (`test`.`member`) where 1 å¦‚ä¸Šç¯„ä¾‹ï¼Œå¯ä»¥æ³¨æ„åˆ° 8.0.16 çš„ EXISTS èªå¥ä¸åªåœ¨ EXPLAIN ä¸­å‡ºç¾ semi-join çš„ FirstMatch å„ªåŒ–ï¼Œè€Œä¸”åœ¨ WARNINGS ä¸­çš„æ”¹å¯«ä¹Ÿå‡ºç¾ semi-joinï¼Œç›¸å°çš„ SUBQUERYä¹Ÿæ¶ˆå¤±äº†ã€‚\nNOT IN/EXISTS å„ªåŒ– 8.0.17 ä¸­å„ªåŒ–äº†å¸¶æœ‰ NOT çš„ INã€EXISTS å¯ä»¥ä½¿ç”¨ anti-join çš„å„ªåŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 -- 5.7.*ã€8.0.16 mysql\u0026gt; EXPLAIN SELECT count(*) FROM orders WHERE NOT EXISTS (SELECT * FROM member WHERE orders.member_id = member.id); +----+--------------------+--------+--------+---------+-----------------------+--------+-------------+ | id | select_type | table | type | key | ref | rows | Extra | +----+--------------------+--------+--------+---------+-----------------------+--------+-------------+ | 1 | PRIMARY | orders | ALL | NULL | NULL | 100536 | Using where | | 2 | DEPENDENT SUBQUERY | member | eq_ref | PRIMARY | test.orders.member_id | 1 | Using index | +----+--------------------+--------+--------+---------+-----------------------+--------+-------------+ 2 rows in set, 1 warning (0.00 sec) mysql\u0026gt; SHOW warnings\\G *************************** 1. row *************************** Level: Note Code: 1276 Message: Field or reference \u0026#39;test.orders.member_id\u0026#39; of SELECT #2 was resolved in SELECT #1 *************************** 2. row *************************** Level: Note Code: 1003 Message: /* select#1 */ select count(0) AS `count(*)` from `test`.`orders` where (not(exists(/* select#2 */ select 1 from `test`.`member` where (`test`.`orders`.`member_id` = `test`.`member`.`id`)))) mysql\u0026gt; SELECT count(*) FROM orders WHERE NOT EXISTS (SELECT * FROM member WHERE orders.member_id = member.id); +----------+ | count(*) | +----------+ | 99897 | +----------+ 1 row in set (0.25 sec) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 -- 8.0.17 mysql\u0026gt; EXPLAIN SELECT count(*) FROM orders WHERE NOT EXISTS (SELECT * FROM member WHERE orders.member_id = member.id); +----+--------------+-------------+--------+---------------------+-----------------------+--------+-------------------------+ | id | select_type | table | type | key | ref | rows | Extra | +----+--------------+-------------+--------+---------------------+-----------------------+--------+-------------------------+ | 1 | SIMPLE | orders | ALL | NULL | NULL | 100411 | NULL | | 1 | SIMPLE | \u0026lt;subquery2\u0026gt; | eq_ref | \u0026lt;auto_distinct_key\u0026gt; | test.orders.member_id | 1 | Using where; Not exists | | 2 | MATERIALIZED | member | index | PRIMARY | NULL | 100 | Using index | +----+--------------+-------------+--------+---------------------+-----------------------+--------+-------------------------+ 2 rows in set, 1 warning (0.00 sec) mysql\u0026gt; SHOW WARNINGS\\G *************************** 1. row *************************** Level: Note Code: 1276 Message: Field or reference \u0026#39;test.orders.member_id\u0026#39; of SELECT #2 was resolved in SELECT #1 *************************** 2. row *************************** Level: Note Code: 1003 Message: /* select#1 */ select count(0) AS `count(*)` from `test`.`orders` anti join (`test`.`member`) on((`\u0026lt;subquery2\u0026gt;`.`id` = `test`.`orders`.`member_id`)) where true mysql\u0026gt; SELECT count(*) FROM orders WHERE NOT EXISTS (SELECT * FROM member WHERE orders.member_id = member.id); +----------+ | count(*) | +----------+ | 99906 | +----------+ 1 row in set (0.03 sec) å¦‚ä¸Šç¯„ä¾‹ï¼Œå¯ä»¥æ³¨æ„åˆ° 8.0.17çš„ NOT INèƒ½çœ‹åˆ° WARNING ä¸­è¢«æ”¹å¯«ç‚º anti-joinï¼Œç›¸å°çš„ SUBQUERYä¹Ÿæ¶ˆå¤±äº†ï¼Œè€Œä¸”é‚„æ²’æœ‰å¯æ€•çš„ DEPENDENT SUBQUERYï¼ŒåŸ·è¡Œæ™‚é–“ä¸Šç•¶ç„¶ä¹Ÿæœ‰æ‰€ç¸®çŸ­ã€‚\nçµèªï¼š æœ¬æ¬¡ MySQL 8.0 é‡å° (NOT) IN|EXISTS çš„å„ªåŒ–æ–¹å¼å€‹äººèªç‚ºç›¸ç•¶çš„å¯¦ç”¨ï¼Œä¸¦ä¸” semi(anti)-join é‚„èƒ½å¤ æ­é…ä¸Š 8.0 çš„HASH JOIN ç›¸æ¯”éå»èƒ½æ›´å¤§å¹…åº¦çš„æ”¹å–„é€™é¡èªæ³•çš„æ•ˆèƒ½ï¼Œä¹Ÿä¸ç”¨åƒéå»ç‚ºäº†è®“é€™é¡èªæ³•æœ‰æ›´å¥½çš„æ•ˆèƒ½ï¼Œç”¨å…¶ä»–æ‰‹æ®µæ”¹å¯«å°è‡´å¯èƒ½çŠ§ç‰²ä¸€äº›å¯è®€æ€§ï¼Œä¸€èˆ‰æ•¸å¾—çœŸçš„å¾ˆæ£’å‘¢ ğŸ˜\nå»¶ä¼¸é–±è®€ semi-join(åŠé€£çµ)å’Œanti-join(åé€£çµ)\nåƒè€ƒè³‡æ–™ MySQL 5.7 æ–‡æª”\nMySQL 8.0 æ–‡æª”\nAntijoin in MySQL8(by MySQL Server Blog)\nanti-joinå¹¾é»ç¸½çµ(by çŸ¥ä¹-çŸ¥æ•¸å ‚)\n","date":"2020-07-23T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mysql-exists-optimize/","title":"MySQL8.0 EXISTS åŠ NOT IN/EXISTS å„ªåŒ–"},{"content":"Journaling é—œæ–¼ journal åœ¨ MongoDB å®˜æ–¹æ–‡æª”çš„é–‹é ­æœ‰ä»¥ä¸‹æè¿°ï¼š\nTo provide durability in the event of a failure, MongoDB usesÂ write ahead logging to on-disk journal files.\nå¯ä»¥è®“æˆ‘å€‘äº†è§£ MongoDB çš„ journal files æ˜¯ä¸€ç¨®é å¯«æ—¥èªŒ(WAL)ï¼Œä½œç”¨å°±é¡ä¼¼ MySQL çš„ redolog ï¼Œéƒ½æ˜¯ç‚ºäº†åœ¨ DB æœå‹™æ„å¤– crash å¾Œæ¢å¾©æ•¸æ“šä¿è­‰æ•¸æ“šæŒä¹…æ€§çš„æ–¹æ³•ã€‚\nJournaling å’Œ WiredTiger å„²å­˜å¼•æ“ WiredTiger ä½¿ç”¨ checkpoints ä¾†\næ¢å¾©çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\nåœ¨ data files ä¸­æ‰¾åˆ°æœ€å¾Œä¸€å€‹ checkpoint åœ¨ journal files ä¸­æ‰¾åˆ°ä¸Šä¸€æ­¥é©Ÿä¸­çš„ checkpoint æ‡‰ç”¨ journal files ä¸­ä¸Šä¸€æ­¥é©Ÿ checkpoint ä¹‹å¾Œçš„æ“ä½œ Journaling Process WiredTiger æœƒç‚ºæ¯å€‹ clinet ç«¯ç™¼èµ·çš„å¯«æ“ä½œå‰µå»ºä¸€å€‹ journal record ç´€éŒ„åŒ…å«å…§éƒ¨çš„æ‰€æœ‰å¯«å…¥æ“ä½œï¼Œä¾‹å¦‚ï¼šåŸ·è¡Œäº† update æ“ä½œï¼Œjournal record é™¤äº†æœƒè¨˜éŒ„æ›´æ–°æ“ä½œåŒæ™‚ä¹Ÿæœƒè¨˜éŒ„ç›¸æ‡‰ç´¢å¼•çš„ä¿®æ”¹ã€‚\nMongoDB è¨­å®š WiredTiger ä½¿ç”¨å…§å­˜ buffer ä¾†å„²å­˜ journal record\nWiredTiger æœƒåœ¨ä»¥ä¸‹æƒ…æ³ä¸‹å°‡ buffere ä¸­çš„ journal records å¯«å…¥ diskï¼š\nå°æ–¼ replica set members (åŒ…å« primary å’Œ secondary)ï¼š If there are operations waiting for oplog entries. Operations that can wait for oplog entries include: forward scanning queries against the oplog read operations performed as part ofÂ causally consistent sessions å°æ–¼ secondary åœ¨æ¯æ¬¡æ‰¹é‡æ‡‰ç”¨ oplog ä¹‹å¾Œã€‚ ç•¶å¯«å…¥æ“ä½œåŒ…å« j: true é¸é …ã€‚ ä¾æ“š storage.journal.commitIntervalMs çš„è¨­ç½®é »ç‡ï¼Œé è¨­ç‚ºæ¯ 100 msã€‚ ç•¶ WiredTiger å‰µå»ºä¸€å€‹æ–°çš„ journal file æ™‚ï¼Œç´„ç‚ºæ¯ 100MB æ•¸æ“šæœƒå‰µå»ºä¸€å€‹æ–°çš„ journal fileã€‚ ğŸ’¡ é€é serverStatus æŒ‡ä»¤ä¸­çš„ wiredTiger.log è³‡è¨Šå¯ä»¥æŸ¥çœ‹ WiredTiger journal çš„çµ±è¨ˆè³‡è¨Šã€‚ Journal file MongoDB æœƒåœ¨ dbPath è¨­å®šçš„ç›®éŒ„ä¸‹ä¸­å»ºç«‹ä¸€å€‹åç‚º journal çš„ç›®éŒ„ï¼ŒWiredTiger çš„ journal file æœƒåœ¨é€™å€‹ journal ç›®éŒ„ä¸‹ï¼š\n1 2 3 4 5 âœ ll /var/lib/mongo/journal ç¸½è¨ˆ 307200 -rw------- 1 root root 104857600 7æœˆ 15 17:04 WiredTigerLog.0000000058 -rw------- 1 root root 104857600 7æœˆ 12 16:49 WiredTigerPreplog.0000000027 -rw------- 1 root root 104857600 7æœˆ 15 16:29 WiredTigerPreplog.0000000054 å…¶ä¸­ WiredTigerLog.{åºè™Ÿ} æ˜¯å·²è¨˜éŒ„æˆ–ä½¿ç”¨ä¸­çš„ Journal fileï¼Œè€Œ WiredTigerPreplog.{åºè™Ÿ} æ˜¯é å…ˆåˆ†é…çš„ Journal fileã€‚\nWiredTiger çš„ journal file æœ€å¤§å¤§å°ç‚º 100MBï¼Œç•¶è¶…éæ™‚æœƒå»ºç«‹ä¸€å€‹æ–°çš„ journal fileï¼Œæ­¤å¤–æœƒè‡ªå‹•åˆªé™¤èˆŠçš„ journal file åƒ…ä¿ç•™å¾ä¸Šä¸€å€‹ checkpoint æ¢å¾©æ‰€éœ€è¦çš„æ–‡ä»¶ã€‚\nJournal record WiredTiger æœƒç‚ºæ¯å€‹ clinet ç«¯ç™¼èµ·çš„å¯«æ“ä½œå‰µå»ºä¸€å€‹ journal record ç´€éŒ„åŒ…å«å…§éƒ¨çš„æ‰€æœ‰å¯«å…¥æ“ä½œï¼Œä¾‹å¦‚ï¼šåŸ·è¡Œäº† update æ“ä½œï¼Œjournal record é™¤äº†æœƒè¨˜éŒ„æ›´æ–°æ“ä½œåŒæ™‚ä¹Ÿæœƒè¨˜éŒ„ç›¸æ‡‰ç´¢å¼•çš„ä¿®æ”¹ã€‚ æ¯å€‹ record æœƒæœ‰ä¸€å€‹ unique identifier WiredTiger çš„ journal record æœ€å°æœ‰ 128 bytes çš„å¤§å°ã€‚ é è¨­æƒ…æ³ä¸‹ MongoDB æœƒå°‡ WiredTiger è¶…é 128 bytes çš„ journal record ä½¿ç”¨ snappy é€²è¡Œå£“ç¸®ï¼Œé€™éƒ¨åˆ†å¯ä»¥é€éstorage.wiredTiger.engineConfig.journalCompressor è¨­å®šä¸åŒçš„å£“ç¸®æ¼”ç®—æ³•\nOpLog MongoDB åœ¨ primary node ä¸Šæ‡‰ç”¨è³‡æ–™åº«æ“ä½œä¹‹å¾Œæœƒå°‡å…¶è¨˜éŒ„åˆ° OpLogï¼Œä¹‹å¾Œ secondary node æœƒè¤‡è£½ä¸¦æ‡‰ç”¨é€™äº›æ“ä½œï¼Œä¹Ÿå°±æ˜¯é¡ä¼¼æ–¼ MySQL çš„ binlogã€‚\noplog ä¸­çš„æ¯å€‹æ“ä½œéƒ½æ˜¯å†ªç­‰ï¼Œä¹Ÿå°±æ˜¯èªª oplog ç„¡è«–åœ¨ç›®æ¨™ node ä¸Šæ‡‰ç”¨ä¸€æ¬¡æˆ–å¤šæ¬¡éƒ½æœƒç”¢ç”Ÿç›¸åŒçš„çµæœã€‚\ncluster ä¸­çš„æ‰€æœ‰ node éƒ½åŒ…å« local.oplog.rs collection ä¸­çš„ oplog å‰¯æœ¬ï¼Œæ‰€ä»¥æ‰€æœ‰çš„ secondary node å¯ä»¥å‘ cluster å…§çš„ä»»æ„ node ç²å– oplogã€‚\nåƒè€ƒ Journal file\nJournaling â€” MongoDB Manual\nWiredTiger Storage Engine â€” MongoDB Manual\nã€MongoDBã€‘æ•°æ®å­˜å‚¨ï¼ˆStorageï¼‰ä¹‹ æ—¥å¿—ï¼ˆJournalingï¼‰_å¥‡æ–¯çš„åšå®¢-CSDNåšå®¢_wiredtiger\nOpLOG\nReplica Set Oplog â€” MongoDB Manual\n","date":"2020-07-20T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mongodb-oplog-journalfile/","title":"MongoDB Oplog å’Œ Journal File"},{"content":"mongodumpã€mongorestore å°‡ MongoDB çš„è³‡æ–™å…§å®¹å°å‡ºæˆäºŒé€²åˆ¶æª”æ¡ˆ\n1 2 mongodump \u0026lt;options\u0026gt; \u0026lt;connection-string\u0026gt; mongorestore \u0026lt;options\u0026gt; \u0026lt;connection-string\u0026gt; \u0026lt;directory or file to restore\u0026gt; å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ --uri æˆ–è€…æ˜¯ --host çš„æ–¹å¼æŒ‡å®šè¦é€£ç·šçš„ MongoDB æœå‹™ï¼Œå¦‚ä¸‹ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # é€£ç·šåˆ° mongoDB instance mongodump --uri=\u0026#34;mongodb://mongodb0.example.com:27017\u0026#34; [additional options] mongodump --host=\u0026#34;mongodb0.example.com:27017\u0026#34; [additional options] mongodump --host=\u0026#34;mongodb0.example.com\u0026#34; --port=27017 [additional options] # é€£ç·šåˆ° mongoDB replica set (å„ªå…ˆå¾ primary è®€å–) mongodump --uri=\u0026#34;mongodb://mongodb0.example.com:27017,mongodb1.example.com:27017,mongodb2.example.com:27017/?replicaSet=myReplicaSetName\u0026#34; [additional options] mongodump --host=\u0026#34;myReplicaSetName/mongodb0.example.com:27017,mongodb1.example.com:27017,mongodb2.example.com\u0026#34; [additional options] # é€£ç·šåˆ° mongoDB replica set (å„ªå…ˆå¾ secondary è®€å–) mongodump --uri=\u0026#34;mongodb://mongodb0.example.com:27017,mongodb1.example.com:27017,mongodb2.example.com:27017/?replicaSet=myReplicaSetName\u0026amp;readPreference=secondary\u0026#34; [additional options] mongodump --host=\u0026#34;myReplicaSetName/mongodb0.example.com:27017,mongodb1.example.com:27017,mongodb2.example.com:27017\u0026#34; --readPreference=secondary [additional options] # é€£ç·šåˆ° mongoDB replica set (å„ªå…ˆå¾ secondary è®€å–ï¼Œä¸¦æŒ‡å®š tag) mongodump --uri=\u0026#34;mongodb://mongodb0.example.com:27017,mongodb1.example.com:27017,mongodb2.example.com:27017/?replicaSet=myReplicaSetName\u0026amp;readPreference=secondary\u0026amp;readPreferenceTags=region:east\u0026#34; [additional options] mongodump --host=\u0026#34;myReplicaSetName/mongodb0.example.com:27017,mongodb1.example.com:27017,mongodb2.example.com:27017\u0026#34; --readPreference=\u0026#39;{mode: \u0026#34;secondary\u0026#34;, tagSets: [ { \u0026#34;region\u0026#34;: \u0026#34;east\u0026#34; } ]}\u0026#39; [additional options] è¡Œç‚º åªèƒ½é‚„åŸåˆ°ç›¸åŒç‰ˆæœ¬çš„ MongoDB æœå‹™ï¼Œä¸¦ä¸” mongodump å’Œ mongorestore ç‰ˆæœ¬ä¹Ÿéœ€è¦ç›¸åŒã€‚ é è¨­æƒ…æ³ä¸‹æœƒå„ªå…ˆé€£ç·š Primary nodeï¼Œå¯ä»¥é€é readPreference é¸é …ä¾†èª¿æ•´ã€‚ mongodump ä¸æœƒ dump local databaseã€‚ mongodump ä¸æœƒå‚™ä»½ indexï¼Œéœ€è¦è‡ªè¡Œé‡å»ºã€‚ å¦‚æœæœ‰ä½¿ç”¨ read-only viewsï¼Œmongodump é è¨­åªæœƒ dump å…¶ metadataï¼Œéœ€è¦æ·»åŠ  --viewAsCollections ä¾†åŒ¯å‡º view ä¸­çš„æ•¸æ“šã€‚ mongodump æœƒåœ¨ä»¥ä¸‹æƒ…æ³ä¸‹ failsï¼š ç•¶ resharding æ­£åœ¨é‹è¡Œæ™‚ã€‚ ç•¶ reshardCollection æŒ‡ä»¤åœ¨ mongodump æ“ä½œæœŸé–“åŸ·è¡Œæ™‚ã€‚ å° WiredTiger å¼•æ“ä½¿ç”¨ mongodump æœƒåŒ¯å‡ºæœªå£“ç¸®çš„æ•¸æ“šã€‚ mongodump æœƒå½±éŸ¿åˆ° mongod çš„æ€§èƒ½ï¼Œå¦‚æœæ•¸æ“šé‡å¤§æ–¼ç³»çµ±å…§å­˜ mongodump æœƒå°è‡´ working set è¢«æ¨å‡ºå…§å­˜ã€‚ mongodump éœ€è¦å…·æœ‰æ¬²å‚™ä»½ database çš„ find æ¬Šé™ï¼Œå…§å»ºçš„ backup role å…·æœ‰å‚™ä»½æ‰€æœ‰ database çš„æ¬Šé™ã€‚ å¸¸ç”¨é¸é … --uri ï¼š\n1 2 3 --uri=\u0026#34;mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]\u0026#34; mongodump --username joe --password secret1 mongodb://mongodb0.example.com:27017 --ssl --host=\u0026lt;hostname\u0026gt;\u0026lt;:port\u0026gt;, -h=\u0026lt;hostname\u0026gt;\u0026lt;:port\u0026gt;ï¼šæŒ‡å®šè¦é€£ç·šçš„ mongodã€‚\n--readPreference=\u0026lt;string|document\u0026gt;ï¼šæŒ‡å®šå„ªå…ˆè®€å–çš„ nodeï¼Œé è¨­å€¼ç‚º primaryï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š\nmaxStalenessSecondsï¼šç”±æ–¼å„ç¨®åŸå›  secondary node å¯ä»¥æœƒè½å¾Œ prmary nodeï¼Œè©²é¸é …ç”¨ä¾†è¨­å®š secondary node æœ€å¤§å»¶é²çš„ç§’æ•¸ï¼Œç•¶ secondary è½å¾Œè¶…éè©²ç§’æ•¸å‰‡ mongodump åœæ­¢é€²è¡Œè®€å–æ“ä½œï¼Œè©²å€¼å¿…é ˆå¤§æ–¼ç­‰æ–¼ 90ã€‚ 1 2 3 4 5 # å„ªå…ˆè®€å– secondary node --readPreference=secondary # å„ªå…ˆè®€å– secondary ä¸­ tag ç‚º region:east çš„ nodeï¼Œå…è¨±çš„æœ€å¤§å»¶é²ç‚º 120 --readPreference=\u0026#39;{mode: \u0026#34;secondary\u0026#34;, tagSets: [ { \u0026#34;region\u0026#34;: \u0026#34;east\u0026#34; } ], maxStalenessSeconds: 120}\u0026#39; --db=\u0026lt;database\u0026gt;, -d=\u0026lt;database\u0026gt;ï¼šæŒ‡å®šè¦å‚™ä»½çš„ databaseï¼Œè‹¥æœªæŒ‡å®šæœƒå‚™ä»½ local ä»¥å¤–çš„æ‰€æœ‰ databaseã€‚\n--collection=\u0026lt;collection\u0026gt;, -c=\u0026lt;collection\u0026gt;ï¼šæŒ‡å®šè¦å‚™ä»½çš„ collectionï¼Œè‹¥æœªæŒ‡å®šæœƒå‚™ä»½ database å…§çš„æ‰€æœ‰ collectionã€‚\n--query=\u0026lt;json\u0026gt;, -q=\u0026lt;json\u0026gt;ï¼šå¿…é ˆæ­é… --collection é¸é …ï¼Œåƒ…åŒ¯å‡ºç¬¦åˆæ­¤æ¢ä»¶çš„æ•¸æ“šï¼Œå¿…é ˆä½¿ç”¨å–®å¼•è™Ÿ ' å°‡æŸ¥è©¢æ–‡æª”åŒ…èµ·ä¾†ï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š\n1 mongodump -d=test -c=records -q=\u0026#39;{ \u0026#34;a\u0026#34;: { \u0026#34;$gte\u0026#34;: 3 }, \u0026#34;date\u0026#34;: { \u0026#34;$lt\u0026#34;: { \u0026#34;$date\u0026#34;: \u0026#34;2016-01-01T00:00:00.000Z\u0026#34; } } }\u0026#39; --gzipï¼šå£“ç¸®è¼¸å‡ºã€‚\n--oplogï¼šç•¶æ²’æœ‰è©²é¸é …æ™‚ï¼Œmongodump é‹è¡ŒæœŸé–“çš„å¯«å…¥\nå°‡ mongodump é‹ä½œæœŸé–“ç”¢ç”Ÿçš„ oplog ä¸€ä½µåŒ¯å‡ºï¼Œè©²æª”æ¡ˆæä¾›äº†\nmongodump \u0026ndash;oplog é‹è¡Œéç¨‹ä¸­ client ç«¯é‹è¡Œä»¥ä¸‹æŒ‡ä»¤å°‡å°è‡´ mogodump å¤±æ•—ï¼š\nrenameCollection db.collection.renameCollection() db.collection.aggregate() with $out mongodump \u0026ndash;oplog å¿…é ˆå®Œæ•´å‚™ä»½ replica set ï¼Œå› æ­¤ä¸å¯å’Œ --db åŠ --collection ä¸€èµ·ä½¿ç”¨ã€‚\nå‚™ä»½ç­–ç•¥ mogodumpã€mongorestore å¯ä»¥ä½œç‚ºå–®å¯¦ä¾‹ã€ä¸€èˆ¬ cluster çš„å‚™æ´æ–¹æ¡ˆ\nmongodumpã€mongorestore é€šéèˆ‡æ­£åœ¨é‹è¡Œçš„ mongod instance äº¤äº’ä¾†é‹è¡Œï¼Œä¸åƒ…æœƒç”¢ç”Ÿæµé‡ï¼Œé‚„æœƒå¼·åˆ¶è³‡æ–™åº«é€éè¨˜æ†¶é«”è®€å–æ‰€æœ‰æ•¸æ“šï¼Œå› æ­¤æœƒå°è‡´mongod æ€§èƒ½ä¸‹é™ã€‚\nmogodumpã€mongorestore ä¸èƒ½ä½œç‚º sharding cluster çš„å‚™æ´æ–¹æ¡ˆï¼Œå› ç‚º mongodump å‰µå»ºçš„å‚™ä»½ä¸æœƒç¶­è­·è·¨ shard äº‹å‹™çš„åŸå­æ€§ä¿è­‰ã€‚\nå°æ–¼ sharding cluster å»ºè­°ä½¿ç”¨ä»¥ä¸‹æ”¯æŒç¶­è­·è·¨ shard äº‹å‹™åŸå­æ€§ä¿è­‰çš„å‚™æ´æ–¹æ¡ˆï¼š\nMongoDB Atlas MongoDB Cloud Manager MongoDB Ops Manager mongoexport å¯ä»¥å°‡ MongoDB ä¸­çš„æ•¸æ“šåŒ¯å‡ºæˆ JSON æˆ– CSV æ ¼å¼ã€‚\n1 mongoexport --collection=\u0026lt;coll\u0026gt; \u0026lt;options\u0026gt; \u0026lt;connection-string\u0026gt; mongoimport å°‡ mongoexport æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹åŒ¯å‡ºçš„ JSONã€CSV æˆ– TSV æ ¼å¼çš„æ•¸æ“šåŒ¯å…¥åˆ° MongoDBã€‚\nåƒè€ƒ mongodump â€” MongoDB Database Tools\nmongorestore â€” MongoDB Database Tools\nmongoexport â€” MongoDB Database Tools\nmongoimport â€” MongoDB Database Tools\nBack Up and Restore with MongoDB Tools â€” MongoDB Manual\nMongoDB Backup Methods â€” MongoDB Manual\nMongoDBçš„å¸¸è§„å¤‡ä»½ç­–ç•¥ - yaoxing - åšå®¢å›­ (cnblogs.com)\n","date":"2020-07-15T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/mongodb-backup-restore/","title":"MongoDB å‚™ä»½é‚„åŸ"},{"content":"åœ¨ MySQL ä¸­é€é undo log ä¾†å¯¦ç¾ MVCC çš„æ©Ÿåˆ¶ï¼Œä½†åœ¨ PG ä¸­æ˜¯å°‡æ–°èˆŠæ•¸æ“šéƒ½å­˜æ”¾åœ¨è¡¨ä¸­ï¼Œç”±æ­¤ç”¢ç”Ÿäº†è¡¨è†¨è„¹åŠ vacuum çš„æ©Ÿåˆ¶ã€‚\nMVCC å¸¸ç”¨å¯¦ç¾æ–¹å¼ ä¸€èˆ¬MVCCæœ‰2ç§å®ç°æ–¹æ³•ï¼š\nå†™æ–°æ•°æ®æ—¶ï¼ŒæŠŠæ—§æ•°æ®è½¬ç§»åˆ°ä¸€ä¸ªå•ç‹¬çš„åœ°æ–¹ï¼Œå¦‚å›æ»šæ®µä¸­ï¼Œå…¶ä»–äººè¯»æ•°æ®æ—¶ï¼Œä»å›æ»šæ®µä¸­æŠŠæ—§çš„æ•°æ®è¯»å‡ºæ¥ï¼Œå¦‚Oracleæ•°æ®åº“å’ŒMySQLä¸­çš„innodbå¼•æ“ã€‚ å†™æ–°æ•°æ®æ—¶ï¼Œæ—§æ•°æ®ä¸åˆ é™¤ï¼Œè€Œæ˜¯æŠŠæ–°æ•°æ®æ’å…¥ã€‚PostgreSQLå°±æ˜¯ä½¿ç”¨çš„è¿™ç§å®ç°æ–¹æ³•ã€‚ ä¸¤ç§æ–¹æ³•å„æœ‰åˆ©å¼Šï¼Œç›¸å¯¹äºç¬¬ä¸€ç§æ¥è¯´ï¼ŒPostgreSQLçš„MVCCå®ç°æ–¹å¼ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š\nä¼˜ç‚¹ æ— è®ºäº‹åŠ¡è¿›è¡Œäº†å¤šå°‘æ“ä½œï¼Œäº‹åŠ¡å›æ»šå¯ä»¥ç«‹å³å®Œæˆ æ•°æ®å¯ä»¥è¿›è¡Œå¾ˆå¤šæ›´æ–°ï¼Œä¸å¿…åƒOracleå’ŒMySQLçš„Innodbå¼•æ“é‚£æ ·éœ€è¦ç»å¸¸ä¿è¯å›æ»šæ®µä¸ä¼šè¢«ç”¨å®Œï¼Œä¹Ÿä¸ä¼šåƒoracleæ•°æ®åº“é‚£æ ·ç»å¸¸é‡åˆ°â€œORA-1555â€é”™è¯¯çš„å›°æ‰° ç¼ºç‚¹ æ—§ç‰ˆæœ¬çš„æ•°æ®éœ€è¦æ¸…ç†ã€‚å½“ç„¶ï¼ŒPostgreSQL 9.xç‰ˆæœ¬ä¸­å·²ç»å¢åŠ äº†è‡ªåŠ¨æ¸…ç†çš„è¾…åŠ©è¿›ç¨‹æ¥å®šæœŸæ¸…ç† æ—§ç‰ˆæœ¬çš„æ•°æ®å¯èƒ½ä¼šå¯¼è‡´æŸ¥è¯¢éœ€è¦æ‰«æçš„æ•°æ®å—å¢å¤šï¼Œä»è€Œå¯¼è‡´æŸ¥è¯¢å˜æ…¢ ä¹Ÿå°±æ˜¯èªª PostgresSQL çš„ MVCC å¯¦ç¾æ–¹å¼æœƒå°è‡´è¡¨ä¸­å †ç©ç„¡ç”¨çš„èˆŠæ•¸æ“šå°è‡´è¡¨ç©ºé–“çš„è†¨è„¹å•é¡Œï¼Œä¹Ÿå› æ­¤éœ€è¦é€éå®šæœŸçš„ vacuum æˆ–è€… auto vacuum ä¾†é‡‹æ”¾é€™äº›ç„¡ç”¨çš„èˆŠæ•¸æ“šå ç”¨çš„ç©ºé–“ã€‚\nvacuum æŒ‡ä»¤ æ”¯æŒä»¥ä¸‹é¸é …\nFULL [ ***boolean*** ]ï¼šå°‡è¡¨çš„å…¨éƒ¨å…§å®¹é‡å¯«åˆ°æ–°çš„ Disk æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯èªªèƒ½å¤ ç¢ºå¯¦é‡‹æ”¾æ‰€æœ‰ dead tuple å ç”¨çš„ç©ºé–“çµ¦ OSï¼Œä½†æ˜¯åœ¨å®Œæˆæ“ä½œä¹‹å‰ä¸æœƒé‡‹æ”¾èˆŠå‰¯æœ¬çš„Disk ç©ºé–“ï¼Œä¸¦ä¸”åœ¨é€™æœŸé–“è©²è¡¨æœƒè¢«åŠ ä¸Š ACCESS EXCLUSIVE LOCK é˜»å¡æ‰€æœ‰å°è©²è¡¨çš„æ“ä½œã€‚\nå‚™è¨»ï¼šæ²’æœ‰ FULL é¸é …çš„ vacuum åªæ˜¯å›æ”¶ç©ºé–“ä¾›è©²è¡¨èƒ½å¤ é‡è¤‡ä½¿ç”¨ï¼Œä¸¦ä¸æœƒå°‡ç©ºé–“é‡‹æ”¾çµ¦ OSã€‚\nå‚™è¨»ï¼šé¡ä¼¼æ–¼ MySQL OPTIMIZE TABLEã€‚\nFREEZE [ ***boolean*** ]ï¼šé¸æ“‡ç©æ¥µçš„ freezingï¼Œç­‰åŒæ–¼åœ¨ vacuum_freeze_min_ageã€vacuum_freeze_table_age è¨­ç½®ç‚º 0 æ™‚é‹è¡Œ vacuumã€‚\nå‚™è¨»ï¼šé¸é … FULL ç¸½æ˜¯æœƒç©æ¥µçš„ freezingï¼Œå› æ­¤æŒ‡å®š FULL é¸é …æ™‚ç„¡éœ€é™„å¸¶ FREEZE é¸é …ã€‚\nVERBOSE [ ***boolean*** ]ï¼šæ‰“å° VACUUM æœŸé–“çš„è©³ç´°è³‡è¨Šã€‚\nANALYZE [ ***boolean*** ]ï¼šåŸ·è¡Œ cacuum å¾ŒåŸ·è¡Œ ANALYZEï¼Œä¹Ÿå°±æ˜¯æœƒæ›´æ–° planner ä½¿ç”¨çš„çµ±è¨ˆè³‡è¨Šï¼Œç¢ºä¿ç”Ÿæˆé«˜æ•ˆçš„åŸ·è¡Œè¨ˆç•«ã€‚é¡ä¼¼æ–¼ MySQL çš„ ANALYZE TABLEã€‚\nDISABLE_PAGE_SKIPPING [ ***boolean*** ] ï¼šæ­¤é¸é …ç¦ç”¨ page_skpping è¡Œç‚ºï¼Œé€šå¸¸åªæœ‰åœ¨å°è‡´æ•¸æ“šåº«æå£çš„è»Ÿç¡¬ä»¶å•é¡Œæ™‚æ‰éœ€è¦ä½¿ç”¨ã€‚\nSKIP_LOCKED [ ***boolean*** ] ï¼šæŒ‡å®š VACUUM åœ¨é–‹å§‹è™•ç† relation æ™‚ä¸ç­‰å¾…å…¶ä»–è¡çªé–çš„é‡‹æ”¾ç›´æ¥è·³éã€‚\nINDEX_CLEANUP { AUTO | ON | OFF } ï¼šé»˜èªå€¼ç‚º AUTOï¼Œå…è¨± VACUUM åœ¨é©ç•¶çš„æƒ…æ³ä¸‹è·³é index cleanup éšæ®µã€‚\nPROCESS_TOAST [ ***boolean*** ] ï¼šæ­¤ç‚ºé»˜èªè¡Œç‚ºï¼ŒæŒ‡å®š Vacuum æ‡‰è©²å˜—è©¦è™•ç†å°æ‡‰çš„ TOAST è¡¨ã€‚\nå‚™è¨»ï¼šä½¿ç”¨é¸é … FULL æ™‚ï¼Œé‚„éœ€è¦åŒ…å«æ­¤é¸é …ã€‚\nTRUNCATE [ ***boolean*** ] ï¼šæŒ‡å®š VACUUM æ‡‰è©²æˆªæ–·è¡¨æœ«ä½çš„ç©ºé ï¼Œä¸¦å°‡å…¶ Disk ç©ºé–“è¿”å›çµ¦ OSã€‚\næ­¤ç‚ºé»˜èªè¡Œç‚ºï¼Œé™¤é vacuum_truncate = falseã€‚\nå‚™è¨»ï¼šåŒ…å«é¸é … FULL æ™‚ï¼Œæ­¤é¸é …ç„¡æ•ˆã€‚\nPARALLEL ***integer***ï¼šæŒ‡å®š index vacuumã€index cleanup éšæ®µæ™‚ä¸¦è¡Œç¸£ç¨‹æ•¸é‡ã€‚\næ­¤é¸é …é‚„å— max_parallel_maintenance_workers é™åˆ¶ä¸Šé™ï¼Œä¸¦ä¸”åªæœ‰ç•¶ INDEX å¤§å° \u0026gt; min_parallel_index_scan_size æ™‚ï¼Œè©² INDEX æ‰èƒ½ parallel vacuumã€‚\nå‚™è¨»ï¼šä¸èƒ½èˆ‡ FULL é¸é …ä¸€èµ·æŒ‡å®šã€‚\nå¸¶æœ‰ full é¸é …çš„ vacuum å¯ä»¥åœ¨ pg_stat_progress_cluster è§€å¯Ÿé€²åº¦ï¼Œå¦‚æœä¸å¸¶æœ‰ full é¸é …çš„ vacuum å‰‡æ˜¯åœ¨ pg_stat_progress_vacuum ä¸­è§€å¯Ÿé€²åº¦ã€‚\nAutoVacuum ç°¡è¿° PostgreSQLä¸­çš„MVCCæœºåˆ¶åŒæ—¶å­˜å‚¨æ–°æ—§ç‰ˆæœ¬çš„å…ƒç»„ï¼Œå¯¹äºç»å¸¸æ›´æ–°çš„è¡¨æ¥è¯´ï¼Œä¼šé€ æˆè¡¨è†¨èƒ€çš„æƒ…å†µã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒPostgreSQL å¼•å…¥äº† VACUUM å’Œ ANALYZE å‘½ä»¤ï¼Œå¹¶ä¸”å¼•å…¥äº†AutoVacuumè‡ªåŠ¨æ¸…ç†ã€‚\nåœ¨PostgreSQLä¸­ï¼ŒAutoVacuumè‡ªåŠ¨æ¸…ç†æ“ä½œåŒ…æ‹¬ï¼š\nåˆ é™¤æˆ–é‡ç”¨æ— æ•ˆå…ƒç»„çš„ç£ç›˜ç©ºé—´\næ›´æ–°æ•°æ®ç»Ÿè®¡ä¿¡æ¯ï¼Œä¿è¯æ‰§è¡Œè®¡åˆ’æ›´ä¼˜\næ›´æ–°visibility mapï¼ŒåŠ é€Ÿindex-only scans\né¿å…XID å›å·(wraparound)é€ æˆçš„æ•°æ®ä¸¢å¤±\nåœ¨ PG ä¸­ XID æ˜¯ç”¨32ä½æ— ç¬¦å·æ•°æ¥è¡¨ç¤ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸å¼•å…¥ç‰¹æ®Šçš„å¤„ç†ï¼Œå½“PostgreSQLçš„XID åˆ°è¾¾40äº¿ï¼Œä¼šé€ æˆæº¢å‡ºï¼Œä»è€Œæ–°çš„XID ä¸º0ã€‚è€ŒæŒ‰ç…§PostgreSQLçš„MVCC æœºåˆ¶å®ç°ï¼Œä¹‹å‰çš„äº‹åŠ¡å°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–°äº‹åŠ¡åˆ›å»ºçš„å…ƒç»„ï¼Œè€Œæ–°äº‹åŠ¡ä¸èƒ½çœ‹åˆ°ä¹‹å‰äº‹åŠ¡åˆ›å»ºçš„å…ƒç»„ï¼Œè¿™è¿åäº†äº‹åŠ¡çš„å¯è§æ€§ã€‚æœ¬æ–‡å°†è¿™ç§ç°è±¡ç§°ä¸ºXID çš„å›å·é—®é¢˜ã€‚\nå‚™è¨»ï¼šMySQL ç‚º 48 ä½ç´„ 281 å…†çš„é‡ï¼Œé›–ç„¶ç†è«–ä¸Šæœƒç™¼ç”ŸåŒæ¨£çš„ç‹€æ³ï¼Œä½†å¯¦å‹™ä¸Šéå¸¸å›°é›£ã€‚\nä¸ºäº†å®ç°è‡ªåŠ¨æ¸…ç†ï¼ŒPostgreSQLå¼•å…¥äº†ä¸¤ç§ç±»å‹çš„è¾…åŠ©è¿›ç¨‹ï¼š\nautovacuum launcherï¼šAutoVacuumæœºåˆ¶çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå‘¨æœŸæ€§åœ°è°ƒåº¦autovacuum workerè¿›ç¨‹ã€‚ autovacuum workerï¼šè¿›è¡Œå…·ä½“çš„è‡ªåŠ¨æ¸…ç†å·¥ä½œã€‚ ç›¸é—œåƒæ•¸ Automatic Vacuuming autovacuum (boolean)ï¼šæ˜¯å¦å•Ÿç”¨ auto vacuum åŠŸèƒ½ï¼Œéœ€è¦å•Ÿç”¨ track_counts (é»˜èª)ï¼Œé»˜èªæ˜¯é–‹å•Ÿçš„ï¼Œå¦å¤–æ­¤åƒæ•¸å¯ä»¥ BY Table å–®ç¨è¨­ç½®ã€‚\nautovacuum_max_workers (integer)ï¼šæŒ‡å®š auto vacuum é€²ç¨‹æ•¸ (ä¸åŒ…å« launcher) é»˜èªå€¼ç‚º 3ã€‚\nautovacuum_naptime (integer)ï¼šè¨­ç½®å…©æ¬¡ auto vacuum ä¹‹é–“çš„é–“éš”æ™‚é–“ï¼Œé»˜èªå€¼ç‚º 1minã€‚\nautovacuum_vacuum_threshold (integer)ï¼šèˆ‡ autovacuum_vacuum_scale_factor æ­é…ä½¿ç”¨ï¼Œé»˜èªå€¼ç‚º 50ã€‚\nautovacuum_vacuum_scale_factor (floating point)ï¼šç•¶ä¸€å¼µè¡¨çš„ update æˆ– delete çš„å…ƒçµ„ (tuples) æ•¸è¶…é autovacuum_vacuum_threshold + autovacuum_vacuum_scale_factor * table size æœƒè§¸ç™¼ vacuumã€‚é è¨­å€¼ç‚º 0.2 (è¡¨å¤§å°çš„ 20%)ï¼Œå¦å¤–æ­¤åƒæ•¸å¯ä»¥ BY Table å–®ç¨è¨­ç½®ã€‚\nautovacuum_analyze_threshold (integer)ï¼šèˆ‡ autovacuum_analyze_scale_factor æ­é…ä½¿ç”¨ï¼Œé»˜èªå€¼ç‚º 50ã€‚\nautovacuum_analyze_scale_factor (floating point)ï¼šç•¶ä¸€å¼µè¡¨çš„ update æˆ– delete çš„å…ƒçµ„ (tuples) æ•¸è¶…é autovacuum_analyze_threshold + autovacuum_analyze_scale_factor * table size æœƒè§¸ç™¼ ANALYZEã€‚é è¨­å€¼ç‚º 0.1 (è¡¨å¤§å°çš„ 10%)ï¼Œå¦å¤–æ­¤åƒæ•¸å¯ä»¥ BY Table å–®ç¨è¨­ç½®ã€‚\nautovacuum_vacuum_insert_threshold (integer)ï¼šèˆ‡ autovacuum_vacuum_insert_scale_factor æ­é…ä½¿ç”¨ï¼Œé»˜èªå€¼ç‚º 1000ã€‚\nautovacuum_vacuum_insert_scale_factor (floating point)ï¼šç•¶ä¸€å¼µè¡¨ insert æŒ‡å®šçš„å…ƒçµ„ (tuples) æ•¸é”åˆ° autovacuum_vacuum_insert_threshold + autovacuum_vacuum_insert_scale_factor * table size æœƒè§¸ç™¼ vacuumã€‚é è¨­å€¼ç‚º 0.2 (è¡¨å¤§å°çš„ 20%)ï¼Œå¦å¤–æ­¤åƒæ•¸å¯ä»¥ BY Table å–®ç¨è¨­ç½®ã€‚\nautovacuum_freeze_max_age (integer)ï¼šè¨­ç½®ç•¶ XID (pg_class .relminmxid)é”åˆ°æ­¤ä¸Šé™å€¼æ™‚ï¼Œå¿…é ˆå¼·åˆ¶ vacuum é¿å… XID çš„ wraparoundã€‚é»˜èªå€¼ç‚º 2 å„„ã€‚\næ³¨æ„ï¼šå³ä½¿ autovacuum æ²’æœ‰é–‹å•Ÿä»èˆŠæœƒè§¸ç™¼å¼·åˆ¶ vacuum ã€‚\nautovacuum_multixact_freeze_max_age (integer)ï¼šè¨­ç½®ç•¶ multi XID (pg_class .relminmxid)ä¸Šé™å€¼é”åˆ°æ­¤ä¸Šé™å€¼æ™‚ï¼Œå¿…é ˆå¼·åˆ¶ vacuum é¿å… XID çš„ wraparoundã€‚é»˜èªå€¼ç‚º 4 å„„ã€‚\næ³¨æ„ï¼šå³ä½¿ autovacuum æ²’æœ‰é–‹å•Ÿä»èˆŠæœƒè§¸ç™¼å¼·åˆ¶ vacuum ã€‚\nautovacuum_vacuum_cost_limit (integer)ï¼šè¨­ç½® auto vacuum çš„é–‹éŠ·é™åˆ¶ï¼Œé»˜èªå€¼ç‚º -1 è¡¨ç¤ºä½¿ç”¨ vacuum_cost_limit çš„è¨­å®šã€‚é–‹éŠ·çš„è¨ˆç®—ä¾æ“š vacuum_cost_page_hit, vacuum_cost_page_miss, vacuum_cost_page_dirty çš„è¨­ç½®ã€‚\nautovacuum_vacuum_cost_delay (floating point)ï¼šè¨­ç½®å¦‚éè¶…é autovacuum_vacuum_cost_limit ä¸Šçš„é–‹éŠ·é™åˆ¶ï¼Œå‰‡éœ€è¦å»¶é²å¤šå°‘æ™‚é–“æ¸…ç†ï¼Œé»˜èªå€¼ç‚º 2 (ms)ï¼Œç•¶æ­¤è¨­å®šè¨­ç½®ç‚º -1 æ™‚è¡¨ç¤ºä¾ç…§ vacuum_cost_delay çš„è¨­å®šã€‚\nRESOURCE USAGE autovacuum_work_mem (integer)ï¼šæŒ‡å®šæ¯å€‹ autovacuum worker é€²ç¨‹ä½¿ç”¨çš„æœ€å¤§ memory é‡ï¼Œé»˜èªå€¼ç‚º -1 è¡¨ç¤ºä½¿ç”¨ maintenance_work_memã€‚\nå»ºè­°å–®ç¨è¨­ç½®ï¼Œå› ç‚ºå¯¦éš›æœ€å¤šå¯èƒ½æœƒæ¶ˆè€— autovacuum_max_workers * autovacuum_work_mem é‡çš„ memoryï¼Œé€™éƒ¨åˆ†å’Œ maintenance_work_mem * max_connections ä¸åŒï¼Œå› æ­¤ç‚ºäº†æ›´åŠ å®‰å…¨çš„é™åˆ¶è³‡æºä½¿ç”¨é‡æ‡‰è©²åˆ†é–‹è¨­ç½®ã€‚\nvacuum_cost_page_hit (integer)ï¼šæ¸…ç†ä¸€ä¸ªåœ¨å…±äº«ç¼“å­˜ä¸­æ‰¾åˆ°çš„ç¼“å†²åŒºçš„ä¼°è®¡ä»£ä»·ã€‚å®ƒè¡¨ç¤ºé”ä½ç¼“å†²æ± ã€æŸ¥æ‰¾å…±äº«å“ˆå¸Œè¡¨å’Œæ‰«æé¡µå†…å®¹çš„ä»£ä»·ã€‚é»˜è®¤å€¼ä¸º1ã€‚\nvacuum_cost_page_miss (integer)ï¼šæ¸…ç†ä¸€ä¸ªå¿…é¡»ä»ç£ç›˜ä¸Šè¯»å–çš„ç¼“å†²åŒºçš„ä»£ä»·ã€‚å®ƒè¡¨ç¤ºé”ä½ç¼“å†²æ± ã€æŸ¥æ‰¾å…±äº«å“ˆå¸Œè¡¨ã€ä»ç£ç›˜è¯»å–éœ€è¦çš„å—ä»¥åŠæ‰«æå…¶å†…å®¹çš„ä»£ä»·ã€‚é»˜è®¤å€¼ä¸º10ã€‚\nvacuum_cost_page_dirty (integer)ï¼šå½“æ¸…ç†ä¿®æ”¹ä¸€ä¸ªä¹‹å‰å¹²å‡€çš„å—æ—¶éœ€è¦èŠ±è´¹çš„ä¼°è®¡ä»£ä»·ã€‚å®ƒè¡¨ç¤ºå†æ¬¡æŠŠè„å—åˆ·å‡ºåˆ°ç£ç›˜æ‰€éœ€è¦çš„é¢å¤–I/Oã€‚é»˜è®¤å€¼ä¸º20ã€‚\nvacuum_cost_limit (integer)ï¼šè¨­ç½® vacuum çš„é–‹éŠ·é™åˆ¶é”åˆ°æ­¤è¨­ç½®æ™‚ä¼‘çœ  vacuum_cost_delay çš„è¨­ç½®ï¼Œé»˜èªå€¼ç‚º 200ã€‚é–‹éŠ·çš„è¨ˆç®—ä¾æ“š vacuum_cost_page_hit, vacuum_cost_page_miss, vacuum_cost_page_dirty çš„è¨­ç½®ã€‚\nvacuum_cost_delay (floating point)ï¼šå¦‚éè¶…é vacuum é–‹éŠ·æˆæœ¬é”åˆ° vacuum_cost_limit é™åˆ¶æ™‚éœ€è¦ä¼‘çœ å¤šä¹…ï¼Œé»˜èªå€¼ç‚º 0 è¡¨ç¤ºç¦ç”¨åŸºæ–¼æˆæœ¬è¨ˆç®—çš„ delay åŠŸèƒ½ã€‚\u0026gt; 0 è¡¨ç¤ºé–‹å•Ÿï¼Œä½†ä¸€èˆ¬ä¹Ÿä¸å»ºè­°è¨­ç½®è¶…é \u0026gt; 1msï¼Œå»ºè­°å¯ä»¥ä¿æŒé»˜èªå€¼é—œé–‰å°±å¥½ã€‚\nå…¶ä»– track_counts (boolean)ï¼šæ˜¯å¦å•Ÿç”¨çµ±è¨ˆä¿¡æ¯æ”¶é›†åŠŸèƒ½ï¼Œé»˜èªæ˜¯é–‹å•Ÿçš„ï¼Œå› ç‚º autovacuum çš„ launcher é€²ç¨‹éœ€è¦é€™äº›çµ±è¨ˆè³‡è¨Šã€‚ log_autovacuum_min_duration (integer)ï¼šç•¶ auto vacuum é‹è¡Œè¶…éè©²æ™‚é–“æˆ–å› é–è¡çªè€Œé€€å‡ºå‰‡æœƒè¨˜éŒ„åˆ° log ä¸­ï¼Œé è¨­å€¼ç‚º 10 (min)ï¼Œè‹¥è¨­ç‚º -1 è¡¨ç¤ºç¦ç”¨ã€‚ è¨­ç½®å»ºè­° å›ºå®š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 vacuum_cost_delay = 0 # ä»¥ä¸‹ç„¡ç”¨ vacuum_cost_page_hit = 1 vacuum_cost_page_miss = 10 vacuum_cost_page_dirty = 20 vacuum_cost_limit = 10000 # ä»¥ä¸Šç„¡ç”¨ autovacuum = on log_autovacuum_min_duration = 0 autovacuum_analyze_scale_factor = 0.05 autovacuum_freeze_max_age = 1200000000 autovacuum_multixact_freeze_max_age = 1400000000 autovacuum_vacuum_cost_delay=0 autovacuum_vacuum_scale_factor = 0.02 # 0.005~ 0.15 vacuum_freeze_table_age = 200000000 vacuum_multixact_freeze_table_age = 200000000 è®Šå‹•\n1 2 autovacuum_work_mem # min( 8G, (è§„æ ¼å†…å­˜*1/8)/autovacuum_max_workers ) autovacuum_max_workers # max(min( 8 , CPUæ ¸æ•°/2 ) , 5) å¾Œè¨˜ åœ¨ PostgreSQL ä¸­å› ç‚ºé€éä¿å­˜èˆŠçš„ tuples (å…ƒçµ„) ä¾†å¯¦ç¾ MVCC æ©Ÿåˆ¶ï¼Œå®¹æ˜“é€ æˆæ•¸æ“šçš„è†¨è„¹é€²è€Œå°è‡´å„²å­˜ç©ºé–“çš„æ¶ˆè€—ä¹Ÿå¯èƒ½é™ä½æŸ¥è©¢çš„æ•ˆèƒ½ã€‚\nåœ¨é–‹æºç¤¾å€ä¹Ÿæœ‰æŒçºŒé€²è¡Œè¨è«–ï¼Œç›®å‰å…§éƒ¨æ¯”è¼ƒèªå¯çš„æ–¹å¼æ˜¯æ§‹å»ºä¸€ç¨®æ–°çš„å„²å­˜æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯ç”± *EnterpriseDB å…¬å¸ä¸»å°çš„ zheapã€‚\n*EnterpriseDB å…¬å¸æä¾›åŸºæ–¼ PostgreSQL çš„ä¼æ¥­ç´šç”¢å“èˆ‡æœå‹™å» å•†ã€‚\nåƒè€ƒ PostgreSQL: Documentation: 15: VACUUM\nPostgreSQL: Documentation: 15: 25.1.Â Routine Vacuuming\nPgSQL Â· ç‰¹æ€§åˆ†æ Â· MVCCæœºåˆ¶æµ…æ (taobao.org)\nPgSQL Â· ç­”ç–‘è§£æƒ‘ Â· è¡¨è†¨èƒ€ (taobao.org)\nPgSQL Â· æºç åˆ†æ Â· AutoVacuumæœºåˆ¶ä¹‹autovacuum launcher (taobao.org)\nPgSQL Â· æºç åˆ†æ Â· AutoVacuumæœºåˆ¶ä¹‹autovacuum worker (taobao.org)\nPgSQL Â· æ–°ç‰¹æ€§è§£è¯» Â· undo log å­˜å‚¨æ¥å£ï¼ˆä¸Šï¼‰ (taobao.org)\nPgSQL Â· ç‰¹æ€§åˆ†æ Â· äº‹åŠ¡IDå›å·é—®é¢˜ (taobao.org)\nblog/20181203_01.md at master Â· digoal/blog Â· GitHub\nã€Postgresqlã€‘VACUUM åƒåœ¾å›æ”¶ - çŸ¥ä¹ (zhihu.com)\nPostgreSQL VACUUM ä¹‹æ·±å…¥æµ…å‡º (ä¸€) - DBADaily - åšå®¢å›­ (cnblogs.com)\nPostgreSQL äº‹åŠ¡â€”MVCC_postgresql mvcc_obvious__çš„åšå®¢-CSDNåšå®¢\nPostgreSQL Vacuum\u0026mdash;å…ƒç»„åˆ é™¤_heap_page_obvious__çš„åšå®¢-CSDNåšå®¢\n","date":"2020-02-28T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/postgre-vacuum/","title":"PostgreSQL vacuum"},{"content":"pg_dump å°±åƒ mysqldump ä¸€æ¨£çš„æ•ˆæœï¼Œå°‡æ•¸æ“š dump æˆ SQL èªå¥ã€‚\nå‚™ä»½ ä½¿ç”¨ pg_dump ä¾†å‚™ä»½å–®å€‹ databaseï¼š\n1 /usr/bin/pg_dump test \u0026gt; test.dump 1 2 3 4 5 6 7 8 9 10 11 12 13 14 âœ ~ cat test.dump ... CREATE TABLE public.test ( id integer ); ALTER TABLE public.test OWNER TO postgres; COPY public.test (id) FROM stdin; 1 2 3 4 \\. ... é è¨­æƒ…æ³ä¸‹ dump å‡ºä¾†çš„å‚™ä»½æª”æ˜¯ä»¥ COPY èªå¥ä¾†é‚„åŸæ•¸æ“šï¼Œå¦‚æœéœ€è¦å°‡ copy èªæ³•è®Šç‚º insert å¯ä»¥ä½¿ç”¨ column-inserts ä¸¦é€é rows-per-insert æŒ‡å®šä¸€å€‹ insert èªå¥åŒ…å«çš„è¡Œæ•¸ï¼š\n1 2 3 4 5 6 7 8 9 /usr/bin/pg_dump --column-inserts --rows-per-insert 2 test \u0026gt; test.dump # test.dump ä¸­çš„éƒ¨åˆ†å…§å®¹ INSERT INTO public.test (id) VALUES (1), (2); INSERT INTO public.test (id) VALUES (3), (4); é‚„åŸ ä½¿ç”¨ psql ä¾†é‚„åŸï¼š\n1 2 3 4 # å»ºç«‹è¦é‚„åŸçš„ç›®æ¨™ database psql --command \u0026#34;create database test_restore\u0026#34; # é‚„åŸ psql test_restore \u0026lt; test.dump é è¨­æƒ…æ³ä¸‹é‚„åŸé‡åˆ°éŒ¯èª¤ç¹¼çºŒåŸ·è¡Œï¼Œå¦‚æœå¸Œæœ›å¯ä»¥ç™¼ç”Ÿ SQL éŒ¯èª¤æ™‚é€€å‡ºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š\n1 psql --set ON_ERROR_STOP=on dbname \u0026lt; dumpfile å¦‚æœé‚„éœ€è¦æ›´é€²ä¸€æ­¥å°‡æ•´å€‹é‚„åŸéç¨‹è¦–ç‚ºä¸€å€‹ Transactionï¼Œå¯ä»¥é€éæ·»åŠ  \u0026ndash;single-transactionï¼š\n1 psql --set ON_ERROR_STOP=on --single-transaction dbname \u0026lt; dumpfile æ­¤å¤–é‚„å¯ä»¥é€é pipeline çš„æ–¹å¼åœ¨ pg_dump çš„åŒæ™‚ç›´æ¥é‚„åŸï¼š\n1 pg_dump -h host1 dbname | psql -h host2 dbname å…¶ä»–äº‹é … pg_dump çš„ User éœ€è¦å°è©² Table æœ‰è®€å–æ¬Šé™ã€‚\npg_dump ä¸€æ¬¡åªèƒ½å‚™ä»½ä¸€å€‹ databaseï¼Œä¸¦ä¸”ä¸åŒ…å« roleã€tablespace (å› ç‚ºä»–å€‘å±¬æ–¼ cluster ç¯„åœï¼Œè€Œä¸æ˜¯ database)ã€‚\npg_dump é‹è¡Œæ™‚æœƒåŸ·è¡Œ database snapshot ä¾†é”åˆ°å…§éƒ¨ä¸€è‡´æ€§ã€‚\npg_dump æœƒå’Œ ALTER é˜»å¡ã€‚\nè¦ä¸€æ¬¡å‚™ä»½æ•´å€‹ cluster è«‹ä½¿ç”¨ pg_dumpallï¼Œé€™æœƒ dump æ‰€æœ‰çš„ database å’Œ cluster ç¯„åœçš„æ•¸æ“šï¼Œä¾‹å¦‚ roleã€tablespaceã€‚\n1 2 3 4 # å‚™ä»½ pg_dumpall \u0026gt; dumpfile # é‚„åŸ psql -f dumpfile postgres ä½†æ˜¯éœ€è¦æ³¨æ„å› ç‚ºåŒ…å« cluster ç¯„åœçš„æ•¸æ“šï¼Œå› æ­¤å¿…é ˆä½¿ç”¨ super user çš„æ¬Šé™ã€‚\næ³¨æ„ï¼špg_dumpall å¯¦éš›ä¸Šæœƒç‚ºæ¯å€‹ database èª¿ç”¨ pg_dumpï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è­‰æ‰€æœ‰ database snapshot æ˜¯åŒæ­¥çš„ã€‚\næ­¤å¤–å¯ä»¥é€é --globals-only é¸é …ä¾†åªæœ‰å‚™ä»½ cluster ç¯„åœçš„æ•¸æ“šã€‚\nå¦‚æœåœ¨ pg_dump æ™‚ä½¿ç”¨éç´”æ–‡æœ¬çš„æ ¼å¼(-Fc) æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ pg_restore ä¾†é‚„åŸã€‚\nå„ªé»ï¼š\nå¯ä»¥é‚„åŸåˆ°ä¸åŒçš„ RDBMSã€‚ å¯ä»¥é‚„åŸåˆ°ä¸åŒç‰ˆæœ¬çš„ PostgreSQLã€‚ ç¼ºé»ï¼š\nå› ç‚ºç­‰æ–¼éœ€è¦é‹è¡Œæ¯ä¸€å€‹ SQL å‘½ä»¤ä¾†é‚„åŸï¼Œå› æ­¤é‚„åŸé€Ÿåº¦è¼ƒæ…¢ã€‚ pg_basebackup ç‚º PostgreSQL å…§å»ºçš„ç‰©ç†å‚™ä»½å·¥å…·ï¼Œç”¨æ–¼å° PostgreSQL é€²è¡Œå…¨é‡ç‰©ç†ç†±å‚™ä»½ã€‚\npg_basebackup æœƒåœ¨å‚™ä»½æœŸé–“å‰µå»ºä¸€å€‹å‚™ä»½æ­·å²æ–‡ä»¶ï¼Œè©²æ–‡ä»¶æœƒä»¥å‚™ä»½æ™‚çš„ç¬¬ä¸€å€‹ WAL æ–‡ä»¶ç‚ºå‘½åï¼Œä¾‹å¦‚ 000000010000000000000002.00000028.backup è¡¨ç¤ºå‚™ä»½æ™‚ç¬¬ä¸€å€‹ WAL åç¨±æ˜¯ 000000010000000000000002 å¦å¤–çš„ 00000028 è¡¨ç¤ºå…¶ä¸­çš„ç¢ºåˆ‡ä½ç½® (ä¸€èˆ¬ä¾†èªªå¯ä»¥å¿½ç•¥)ï¼Œä»¥ä¸‹æ˜¯è©²æª”æ¡ˆåŒ…å«çš„è³‡è¨Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 [root@ed875d053382 pg_wal]# cat 000000010000000000000002.00000028.backup START WAL LOCATION: 0/2000028 (file 000000010000000000000002) STOP WAL LOCATION: 0/2000100 (file 000000010000000000000002) CHECKPOINT LOCATION: 0/2000060 BACKUP METHOD: streamed BACKUP FROM: primary START TIME: 2023-04-17 07:07:01 UTC LABEL: pg_basebackup base backup START TIMELINE: 1 STOP TIME: 2023-04-17 07:07:02 UTC STOP TIMELINE: 1 ä¹Ÿå°±æ˜¯èªªåªéœ€è¦ä¿å­˜åŒ…å« 000000010000000000000002 ä¹‹å¾Œçš„ WAL å°±å¯ä»¥å®Œæ•´çš„å¾©åŸã€‚\nç¯„ä¾‹ 1 pg_basebackup -P -D /var/data/backup/pg_back_$(date +\u0026#34;%F_%T\u0026#34;) é¸é … -Dï¼šæŒ‡å®šå‚™ä»½çš„ç›®çš„åœ° -Fã€ï¼šæŒ‡å®šè¼¸å‡ºçš„æ ¼å¼ pã€plainï¼šé è¨­å€¼ï¼Œè¼¸å‡ºæˆæ™®é€šæ–‡ä»¶ã€‚ tã€tarï¼šè¼¸å‡ºç‚º tar æ–‡ä»¶ã€‚ -Rï¼šå‰µå»º standy.signal æ–‡ä»¶ï¼Œä¸¦å°‡ç›¸é—œçš„é€£æ¥è¨­ç½®é™„åŠ åˆ° postgresql.auto.conf ä¸­ï¼Œç”¨æ–¼ä¾¿æ–¼å°‡å‚™ä»½æª”ç”¨æ–¼å»ºç½® replicaã€‚ -Xï¼šæŒ‡å®šå‚™ä»½åœ¨å‚™ä»½æœŸé–“ä¸­ç”¢ç”Ÿçš„ WALã€‚ nã€noneï¼šä¸å‚™ä»½ WALã€‚ fã€fetchï¼šå°‡åœ¨å‚™ä»½çµæŸå¾Œæ”¶é›† WALï¼Œå› æ­¤éœ€è¦æœ‰è¶³å¤ é«˜çš„ wal_keep_sizeï¼Œå¦å‰‡å¯èƒ½ç™¼ç”Ÿæ‰€éœ€çš„ wal è¢«å›æ”¶å°è‡´å‚™ä»½ç„¡æ³•ä½¿ç”¨ã€‚ sã€streamï¼šé»˜èªå€¼ï¼Œåœ¨å‚™ä»½çš„åŒæ™‚é€é streaming replication æŒçºŒå‚³è¼¸ WALï¼Œé€™å°‡é¡å¤–é–‹ä¸€å€‹é€£çµä¾†é€²è¡Œ WAL çš„å‚™ä»½ï¼Œ -Pï¼šé¡¯ç¤ºé€²åº¦ã€‚ å…¶ä»–äº‹é … å„ªé»ï¼š\nç¼ºé»ï¼šåªèƒ½å‚™ä»½æ•´å€‹ Instance ç„¡æ³•æŒ‡å®šå–®è¡¨ã€‚\nContinuous archiving èˆ‡ PITR åªè¦æ˜¯æ•¸æ“šåº«éƒ½æœ‰æœ€åŸºæœ¬çš„ Durability(æŒä¹…æ€§) éœ€è¦ä¿è­‰ï¼Œé€™å¤§éƒ¨åˆ†éƒ½æ˜¯é€é WAL æŠ€è¡“ä¹Ÿå°±æ˜¯æ—¥èªŒå…ˆè¡Œä¾†é”åˆ°ï¼Œåœ¨ MySQL ä¸­æ˜¯ REDO LOG è€Œåœ¨ PostgreSQL ä¸­å‰‡æ˜¯ WAL (åœ¨ PG 10 ä¹‹å‰ç¨±ç‚º xlog)ã€‚\nå› æ­¤å°±åƒ MySQL å¯ä»¥é€é xtrabackup çš„ç‰©ç†å‚™ä»½åŠ ä¸Š binlog åšå¾ŒçºŒçš„å¢é‡æ¢å¾©ï¼ŒPostgreSQL åŒæ¨£å¯ä»¥é€é pg_basebackup ç”¢ç”Ÿçš„å…¨é‡å‚™ä»½åŠ ä¸Šå¾ŒçºŒçš„ WAL é”åˆ°å¢é‡æ¢å¾©ï¼Œé€™æ¨£é‚„æœ‰ point-in-time recovery çš„å„ªå‹¢ã€‚\nè¨­ç½® WAL Archining PostgreSQL æ¯ 16 MB (é è¨­å€¼)å°±æœƒè¼ªæ›ä¸€å€‹æ–°çš„ WAL æ–‡ä»¶ï¼Œè€Œç•¶æ‰€æœ‰çš„ WAL è¶…é max_wal_size èˆŠçš„ WAL æœƒè¢«ä¸€ä¸€åˆªé™¤ (ä¾ç…§ checkpoint åˆ¤æ–·æ˜¯å¦ä¸å†éœ€è¦å°æ‡‰çš„ WAL)ï¼Œç‚ºäº†é¿å…å…¨é‡å‚™ä»½å¾Œæ‰€éœ€çš„ WAL åœ¨ç¶“éä¸€é™£å­å¾Œè¢«åˆªé™¤å°è‡´æ•´å€‹å…¨é‡å‚™ä»½ä¸å¯ç”¨ï¼Œæˆ‘å€‘éœ€è¦ç‚º WAL è¨­ç½® Archining çš„æ–¹å¼ï¼Œç¢ºä¿åœ¨åˆªé™¤ WAL ä¹‹å‰æœ‰é€²è¡Œæ­¸æª”ã€‚\nè¦é…ç½® WAL Archining éœ€è¦ä»¥ä¸‹è¨­å®šï¼š\nwal_level = replica | logical archive_mode = ON arvhive_command = â€˜test ! -f /mnt/server/archivedir/%f \u0026amp;\u0026amp; cp %p /mnt/server/archivedir/%fâ€™ %f æœƒè¢«æ›¿æ›æˆæ­¸æª”çš„ wal æ–‡ä»¶åç¨±ã€‚ %p æœƒè¢«æ›¿æ›æˆæ­¸æª”çš„ wal è·¯å¾‘ã€‚ 1 2 3 wal_level = replica archive_mode = ON arvhive_command = \u0026#39;test ! -f /var/data/xlog_archive/%f \u0026amp;\u0026amp; cp %p /var/data/xlog_archive/%f\u0026#39; ç¯„ä¾‹ é€é pg_basebackup ç²å–å…¨é‡å‚™ä»½\n1 pg_basebackup -P -D /var/data/backup/pg_back_$(date +\u0026#34;%F_%T\u0026#34;) é—œé–‰ serverï¼š\n1 pg_ctl stop å°ç•¶å‰çš„å¯¦é«”æª”æ¡ˆæš«å­˜ï¼Œä»¥å‚™ä¸æ™‚ä¹‹éœ€ï¼š\n1 cp -R /var/data/postgres/ /var/data/postgres_backup/ å‚™è¨»ï¼šå¦‚æœæ²’æœ‰è¶³å¤ çš„ç©ºé–“æ‡‰è‡³å°‘ä¿ç•™ pg_wal å­ç›®éŒ„ï¼Œå› ç‚ºå¯èƒ½åŒ…å«å°šæœª archive çš„ wal éœ€ç”¨æ–¼ç¨å¾Œæ¢å¾©ã€‚\næ¸…é™¤ç•¶å‰çš„å¯¦é«”æª”æ¡ˆ\n1 rm -rf /var/data/postgres/* å¾ Base Backup é€²è¡Œæ¢å¾©ï¼Œæ³¨æ„è«‹ä½¿ç”¨ DBç³»çµ±ç”¨æˆ¶ (postgre) é€²è¡ŒåŒ…å«æ­£ç¢ºæ¬Šé™çš„æ¢å¾©ã€‚\n1 cp -R /var/data/backup/pg_back_2023-04-13_02\\:55\\:49/* /var/data/postgres/ å¦‚æœæœ‰ä½¿ç”¨ tablespace æ‡‰è©²æª¢æŸ¥ pg_tblspc ä¸­çš„ symbolic link æ˜¯å¦æ­£ç¢ºæ¢å¾©ã€‚\nç§»é™¤ Base Backup ä¸­çš„ pg_wal/ ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå› ç‚ºé€™äº›æ˜¯ç•¶åˆ Base Backup çš„ wal æ–‡ä»¶å¯èƒ½å·²ç¶“éæ™‚äº†\n1 rm -rf /var/data/postgres/pg_wal/* å°‡æ­¥é©Ÿ 2 ä¸­ä¿å­˜çš„æœªæ­¸æª” wal æ–‡ä»¶è¤‡è£½åˆ° pg_wal\n1 cp -R /var/data/postgres_backup/pg_wal/* /var/data/postgres/pg_wal/ åœ¨ postgresql.conf ä¸­è¨­ç½®æ¢å¾©ç›¸é—œçš„é…ç½®\n1 2 3 restore_command = \u0026#39;cp /var/data/xlog_archive/%f %p\u0026#39; # recovery_target_time å¯ä»¥é…ç½®æ¢å¾©åˆ°çš„æ™‚é–“é» # recovery_target_timeline å»ºç«‹ recovery.signal æ–‡ä»¶ä¾†è§¸ç™¼ restore\n1 touch recovery.signal æ³¨æ„ï¼šæ­¤æ™‚é‚„å¯ä»¥èª¿æ•´ pg_hba.conf ä¾†é˜²æ­¢å…¶ä»– role ä¾†é€£ç·šå‰›æ¢å¾©çš„ clusterã€‚\nå•Ÿå‹• server\n1 pg_ctl -D /var/data/postgres -l logfile start æ¢å¾©æˆåŠŸå¾Œ recovery.signal æœƒè¢«åˆªé™¤ï¼Œé¿å…ç¨å¾Œæ„å¤–é‡æ–°é€²å…¥æ¢å¾©æ¨¡å¼ã€‚\næª¢æŸ¥æ•¸æ“šåº«æ˜¯å¦æ¢å¾©å®Œæˆï¼Œå¦‚æœå®Œæˆè¨˜å¾—é‡æ–°èª¿æ•´ pg_hba.conf æ¢å¾©å…¶ä»–ä½¿ç”¨è€…çš„å­˜å–ã€‚\nå¯¦ä¾‹ æ–°å¢ä¸€äº›æ¸¬è©¦è³‡æ–™ï¼š\n1 2 3 4 5 6 7 8 9 10 create database test; \\c test; create table test_table(id int primary key,name varchar(10)); [postgres @ test] [local]:5432] 02:53:21 \u0026gt; select * from test_table; id | name ----+------- 1 | test 2 | test2 (2 rows) é€²è¡Œ Base backupï¼š\n1 pg_basebackup -P -D /var/data/backup/pg_back_$(date +\u0026#34;%F_%T\u0026#34;) æ–°å¢å¢é‡æ¸¬è©¦è³‡æ–™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 create table test_table2(id int primary key,name varchar(10)); insert into test_table values(3,\u0026#39;test3\u0026#39;),(4,\u0026#39;test4\u0026#39;); insert into test_table2 values(5,\u0026#39;test5\u0026#39;),(6,\u0026#39;test6\u0026#39;); [postgres @ test] [local]:5432] 02:57:25 \u0026gt; select * from test_table; id | name ----+------- 1 | test 2 | test2 3 | test3 4 | test4 (4 rows) Time: 0.381 ms [postgres @ test] [local]:5432] 02:57:29 \u0026gt; select * from test_table2; id | name ----+------- 5 | test5 6 | test6 (2 rows) å¼·åˆ¶é—œé–‰ pg æœå‹™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [postgres@3f5b5718e08f postgres]$ ps aux| grep postgre root 801 0.0 0.1 83584 2196 pts/0 S 02:14 0:00 su postgres postgres 802 0.0 0.1 14096 2888 pts/0 S 02:14 0:00 bash postgres 1148 0.0 1.0 216872 19112 ? Ss 02:56 0:00 /usr/local/postgres/bin/postgres postgres 1150 0.0 0.0 216872 1568 ? Ss 02:56 0:00 postgres: checkpointer postgres 1151 0.0 0.1 217008 2596 ? Ss 02:56 0:00 postgres: background writer postgres 1152 0.0 0.5 216872 9720 ? Ss 02:56 0:00 postgres: walwriter postgres 1153 0.0 0.1 217428 2776 ? Ss 02:56 0:00 postgres: autovacuum launcher postgres 1154 0.0 0.0 216872 1580 ? Ss 02:56 0:00 postgres: archiver postgres 1155 0.0 0.0 67512 1756 ? Ss 02:56 0:00 postgres: stats collector postgres 1156 0.0 0.1 217428 2316 ? Ss 02:56 0:00 postgres: logical replication launcher postgres 1173 0.0 0.1 53332 1876 pts/0 R+ 02:57 0:00 ps aux postgres 1174 0.0 0.0 10696 984 pts/0 S+ 02:57 0:00 grep --color=auto postgre [postgres@3f5b5718e08f postgres]$ kill -9 postgres å‚™ä»½ç•¶å‰å¯¦é«”æª”æ¡ˆä¸¦æ¸…é™¤\n1 2 cp -R /var/data/postgres/ /var/data/postgres_backup/ rm -rf /var/data/postgres/* å¾ Base Backup é€²è¡Œæ¢å¾©ï¼Œä¸¦æ¸…ç©ºå‚™ä»½ä¸­çš„ walï¼Œå†å°‡åŸæœ¬çš„ wal æª”æ¡ˆè¤‡è£½éä¾†\n1 2 3 cp -R /var/data/backup/pg_back_2023-04-13_02\\:55\\:49/* /var/data/postgres/ rm -rf /var/data/postgres/pg_wal/* cp -R /var/data/postgres_backup/pg_wal/* /var/data/postgres/pg_wal/ é…ç½® restore_command\n1 restore_command = \u0026#39;cp /var/data/xlog_archive/%f %p\u0026#39; å»ºç«‹ recovery.signal æ–‡ä»¶ä¾†è§¸ç™¼ restore\n1 touch recovery.signal å•Ÿå‹•ä¸¦æª¢æŸ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 [postgres@3f5b5718e08f postgres]$ pg_ctl -D /var/data/postgres -l logfile start [postgres@3f5b5718e08f postgres]$ psql test Timing is on. psql (14.7) Type \u0026#34;help\u0026#34; for help. [postgres @ test] [local]:5432] 03:00:30 \u0026gt; \\dt List of relations Schema | Name | Type | Owner --------+-------------+-------+---------- public | test_table | table | postgres public | test_table2 | table | postgres (2 rows) [postgres @ test] [local]:5432] 03:00:32 \u0026gt; select * from test_table; id | name ----+------- 1 | test 2 | test2 3 | test3 4 | test4 (4 rows) Time: 0.620 ms [postgres @ test] [local]:5432] 03:00:37 \u0026gt; select * from test_table2; id | name ----+------- 5 | test5 6 | test6 (2 rows) Time: 0.715 ms Point-in-time recovery é è¨­æƒ…æ³ä¸‹æœƒç›´æ¥æ¢å¾©åˆ° WAL çš„æœ«å°¾ï¼Œå¯ä»¥é€éè¨­ç½® recovery_target ç›¸é—œåƒæ•¸ä¾†æŒ‡å®šä¸€å€‹æ›´æ—©çš„åœæ­¢é»ï¼Œé”åˆ° Point-in-time recoveryã€‚\nç›¸é—œåƒæ•¸å¦‚ä¸‹ï¼š\nrecovery_target = â€™immediateâ€™ï¼šç›®å‰åªæœ‰ immediate æ­¤è¨­å®šï¼Œè¡¨ç¤ºç›¡æ—©çµæŸä¹Ÿå°±æ˜¯è©²å‚™ä»½çµæŸçš„æ™‚é–“é»ã€‚\nrecovery_target_name (string)ï¼šæŒ‡å®šé€é pg_create_restore_point() æ‰€å‰µå»ºçš„ restore pointï¼ŒæŒ‡ç¤ºæ¢å¾©åˆ°æ­¤ä½ç½®ã€‚\nrecovery_target_time (timestamp)ï¼šæŒ‡å®šæ¢å¾©åˆ°æŒ‡å®šçš„æ™‚é–“æˆ³ã€‚\næº–ç¢ºä¾†èªªæ˜¯æŒ‡ WAL ä¸­è¨˜éŒ„\nrecovery_target_xid (string)ï¼šæŒ‡å®šæ¢å¾©åˆ°æŒ‡å®šçš„ Tranasction IDï¼Œæ³¨æ„é›–ç„¶ Transaction ID æ˜¯é †åºåˆ†é…çš„ï¼Œä½†æ˜¯å¯èƒ½ä¾ç…§ä¸åŒé †åº commitï¼Œæ­¤è¨­ç½®åŒæ™‚ä¹Ÿæœƒæ¢å¾©è©² Transaction ID ä¹‹å‰ commit ä½†å…·æœ‰æ›´å¤§çš„ Transaction ID çš„äº‹å‹™ã€‚\nrecovery_target_lsn (string)ï¼šæŒ‡å®šæ¢å¾©åˆ°æŒ‡å®šçš„ LSN ä½ç½®ã€‚\nrecovery_target_inclusive (boolean)ï¼šå½±éŸ¿ç•¶è¨­ç½® recovery_target_timeã€ recovery_target_xid å’Œ recovery_target_lsnï¼Œé»˜èªå€¼ ON è¡¨ç¤ºæ¢å¾©å®Œé€™äº›ç›®æ¨™æ‰åœæ­¢ï¼Œå¦‚æœæ˜¯ OFF å‰‡è¡¨ç¤ºæ¢å¾©åˆ°é€™äº›è¨­ç½®ä¹‹å‰å°±åœæ­¢ã€‚\nrecovery_target_timeline (string)ï¼šæŒ‡å®šæ¢å¾©åˆ°ä¸€å€‹ timeline ä¸­ï¼Œè©²å€¼å¯ä»¥ timeline id æˆ–ä»¥ä¸‹ç‰¹å®šå€¼ï¼š\ncurrentï¼šæ²¿è‘— base backup çš„ timeline é€²è¡Œæ¢å¾©ã€‚ latestï¼šé»˜èªå€¼ï¼Œæ¢å¾©åˆ°æœ€æ–°çš„ timelineã€‚ recovery_target_action (enum)ï¼šæŒ‡å®šç•¶é”åˆ° recovery target å¾Œçš„å‹•ä½œï¼š\npauseï¼šé»˜èªå€¼ï¼Œè¡¨ç¤ºåœæ­¢ recovery ä¸¦å…è¨±æŸ¥è©¢ã€‚\nå¦‚æœ hot_standby = offï¼Œå‰‡æ­¤å€¼è¡Œç‚ºå’Œ shutdown ç­‰åŒã€‚\nå¦‚æœåœ¨ promote ä¸­é”åˆ° recovery targetï¼Œå‰‡æ­¤å€¼è¡Œç‚ºå’Œ promote ç­‰åŒã€‚\npromoteï¼šè¡¨ç¤ºæ¢å¾©çµæŸå¾Œ sever å°‡å…è¨±é€£æ¥ã€‚\nshutdownï¼šè¡¨ç¤ºæ¢å¾©çµæŸå¾Œåœæ­¢ serverï¼Œè¨­ç½®æ­¤å€¼æ™‚ recovery.singal å°‡ä¸æœƒè¢«ç§»é™¤ã€‚\nå‚™è¨»ï¼šå¦‚æœæ²’æœ‰è¨­ç½® recovery target ç›¸é—œåƒæ•¸ï¼Œå‰‡æ­¤åƒæ•¸ç„¡æ•ˆã€‚\nğŸ’¡ æ³¨æ„ï¼šrecovery_targetã€recovery_target_nameã€recovery_target_timeã€recovery_target_xid ã€recovery_target_lsn åªèƒ½å¤ è¨­ç½®å…¶ä¸­ä¸€å€‹ï¼Œè¨­ç½®å¤šå€‹å°‡å¼•ç™¼éŒ¯èª¤ã€‚\nå¯¦åš ç•¶å‰è³‡æ–™åº«çš„è³‡æ–™å…§å®¹\n1 2 3 4 5 6 7 8 9 10 [postgres @ test] [local]:5432] 03:24:20 \u0026gt; select * from test; id | timeline | create_time ----+----------+---------------------------- 1 | 1 | 2023-04-19 03:07:52.695513 2 | 1 | 2023-04-19 03:08:06.031361 3 | 1 | 2023-04-19 03:08:14.686946 4 | 1 | 2023-04-19 03:15:46.191272 5 | 1 | 2023-04-19 03:20:29.690359 6 | 1 | 2023-04-19 03:24:08.854501 (6 rows) ä½¿ç”¨ base backup å¾©åŸå¾Œèª¿æ•´è¨­å®šæª”\n1 2 3 4 5 [postgres@31650d651e1c data]$ cp -r backup/pg_back_2023-04-19_03\\:08\\:41/* postgres/ [postgres@31650d651e1c postgres]$ vim postgresql.conf recovery_target_time = \u0026#39;2023-04-19 03:20:00\u0026#39; [postgres@31650d651e1c postgres]$ touch recovery.signal å‚™è¨»ï¼šå¯ä»¥é€é pg_waldump ç¢ºèª wal log ä¾†ç¢ºèªè¦æ¢å¾©åˆ°çš„ä½ç½®ï¼Œä¾‹å¦‚æˆ‘å¸Œæœ›æ¢å¾©åˆ° id = 5 è¢« insert ä¹‹å‰çš„ç‹€æ³ï¼Œé€é waldump ç¢ºèªè©² transaction åœ¨ 2023-04-19 03:20:29.690738 UTC commitï¼Œå› æ­¤åªè¦å°‡ recovery_target_time è¨­ç½®çš„æ¯”å…¶å°å³å¯ã€‚\n1 2 3 4 5 6 7 8 [postgres@31650d651e1c xlog_archive]$ pg_waldump 00000001000000000000000D rmgr: Standby len (rec/tot): 50/ 50, tx: 0, lsn: 0/0D000028, prev 0/0C000358, desc: RUNNING_XACTS nextXid 748 latestCompletedXid 747 oldestRunningXid 748 rmgr: Standby len (rec/tot): 50/ 50, tx: 0, lsn: 0/0D000060, prev 0/0D000028, desc: RUNNING_XACTS nextXid 748 latestCompletedXid 747 oldestRunningXid 748 rmgr: XLOG len (rec/tot): 114/ 114, tx: 0, lsn: 0/0D000098, prev 0/0D000060, desc: CHECKPOINT_ONLINE redo 0/D000060; tli 1; prev tli 1; fpw true; xid 0:748; oid 24582; multi 1; offset 0; oldest xid 726 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 748; online rmgr: Standby len (rec/tot): 50/ 50, tx: 0, lsn: 0/0D000110, prev 0/0D000098, desc: RUNNING_XACTS nextXid 748 latestCompletedXid 747 oldestRunningXid 748 rmgr: Heap len (rec/tot): 54/ 298, tx: 748, lsn: 0/0D000148, prev 0/0D000110, desc: INSERT off 5 flags 0x00, blkref #0: rel 1663/16384/16391 blk 0 FPW rmgr: Btree len (rec/tot): 53/ 193, tx: 748, lsn: 0/0D000278, prev 0/0D000148, desc: INSERT_LEAF off 5, blkref #0: rel 1663/16384/16394 blk 1 FPW rmgr: Transaction len (rec/tot): 34/ 34, tx: 748, lsn: 0/0D000340, prev 0/0D000278, desc: COMMIT 2023-04-19 03:20:29.690738 UTC å•Ÿå‹• server\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [postgres@945f297dce73 postgres]$ pg_ctl start 2023-04-19 07:44:25.775 UTC [1828] LOG: starting point-in-time recovery to 2023-04-19 03:20:00+00 2023-04-19 07:44:25.817 UTC [1828] LOG: restored log file \u0026#34;00000001000000000000000B\u0026#34; from archive 2023-04-19 07:44:25.975 UTC [1828] LOG: redo starts at 0/B000028 2023-04-19 07:44:25.977 UTC [1828] LOG: consistent recovery state reached at 0/B000100 2023-04-19 07:44:25.977 UTC [1827] LOG: database system is ready to accept read-only connections 2023-04-19 07:44:26.008 UTC [1828] LOG: restored log file \u0026#34;00000001000000000000000C\u0026#34; from archive 2023-04-19 07:44:26.198 UTC [1828] LOG: restored log file \u0026#34;00000001000000000000000D\u0026#34; from archive 2023-04-19 07:44:26.351 UTC [1828] LOG: recovery stopping before commit of transaction 748, time 2023-04-19 03:20:29.690738+00 2023-04-19 07:44:26.351 UTC [1828] LOG: pausing at the end of recovery 2023-04-19 07:44:26.351 UTC [1828] HINT: Execute pg_wal_replay_resume() to promote. [postgres@31650d651e1c postgres]$ psql test Timing is on. psql (14.7) Type \u0026#34;help\u0026#34; for help. [postgres @ test] [local]:5432] 05:13:41 \u0026gt; select * from test; test-# ; id | timeline | create_time ----+----------+---------------------------- 1 | 1 | 2023-04-19 03:07:52.695513 2 | 1 | 2023-04-19 03:08:06.031361 3 | 1 | 2023-04-19 03:08:14.686946 4 | 1 | 2023-04-19 03:15:46.191272 timeline æƒ³åƒæ™‚é–“æ—…è¡Œçš„ç§‘å¹»ä½œå“ï¼Œå¦‚æœå¾ç¾åœ¨å›åˆ°éå»ä¸¦æ”¹è®Šéå»ç™¼ç”Ÿçš„äº‹ä»¶æœƒå°è‡´æœªä¾†ç™¼ç”Ÿæ”¹è®Šï¼Œä¹Ÿå°±æ˜¯å‡ºç¾äº†ä¸åŒçš„æ™‚é–“ç·šã€‚\nåœ¨ PG ä¸­ä¹Ÿæœ‰é¡ä¼¼çš„ç‹€æ³ï¼Œå‡è¨­åœ¨ 12:00 èª¤åˆªé™¤äº†è³‡æ–™è¡¨ï¼Œä¸¦åœ¨ 13:00 å°‡ PG æ¢å¾©åˆ° 11:00 çš„æ™‚é–“é»ä¸¦æ­£å¸¸å•Ÿå‹•å’Œé‹ä½œï¼Œæ­¤æ™‚æœƒå‡ºç¾ 2 å€‹æ™‚é–“ç·šï¼š\néå» 11:00~13:00 ç”¢ç”Ÿçš„ WAL æ¢å¾©å¾Œå¾ 13:00 é–‹å§‹ç”¢ç”Ÿçš„ WAL å¦‚æœæ²’æœ‰ timeline çš„è¨­è¨ˆï¼Œæ¢å¾©å¾Œç”¢ç”Ÿçš„ WAL è¦†è“‹äº†éå»ç”¢ç”Ÿçš„ WALï¼Œæ­¤æ™‚å¦‚æœç™¼ç¾æ±ºç­–éŒ¯èª¤å¸Œæœ›å›åˆ°éå»çš„ 12:00 æ•¸æ“šåº«ç‹€æ…‹å°‡ç„¡æ³•åšåˆ°ã€‚\nå› æ­¤ PG æœ‰äº† timeline çš„è¨­è¨ˆï¼Œé€éä¿å­˜ä¸åŒ timeline çš„ WAL ä¾†è®“ä½¿ç”¨è€…èƒ½å¤ è‡ªç”±çš„æ¢å¾©åˆ°ä¸åŒçš„æ™‚é–“ç·šã€‚\næ–°çš„ timeline ç”¢ç”Ÿæ™‚æ©Ÿ PITRï¼šè¨­ç½® recovery_target ç›¸é—œåƒæ•¸é€²è¡Œæ¢å¾©å¾Œæœƒå‡ºç¾æ–°çš„ timelineã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [postgres@31650d651e1c postgres]$ ll pg_wal/ total 32768 -rw-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000B -rw-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000C drwx------. 2 postgres postgres 80 Apr 19 03:27 archive_status # é…ç½® recovery_target åƒæ•¸ä¸¦é€²è¡Œ PITR [postgres@31650d651e1c postgres]$ vim postgresql.conf recovery_target_time = \u0026#39;2023-04-19 03:15:46\u0026#39; recovery_target_action = \u0026#39;promote\u0026#39; [postgres@31650d651e1c postgres]$ touch recovery.singal [postgres@31650d651e1c postgres]$ pg_ctl -l logfile restart waiting for server to shut down.... done server stopped waiting for server to start.... done server started [postgres@31650d651e1c pg_wal]$ ll total 49156 -rw-------. 1 postgres postgres 16777216 Apr 19 03:30 00000001000000000000000C -rw-------. 1 postgres postgres 16777216 Apr 19 03:30 00000002000000000000000C -rw-------. 1 postgres postgres 16777216 Apr 19 03:27 00000002000000000000000D -rw-------. 1 postgres postgres 50 Apr 19 03:30 00000002.history drwx------. 2 postgres postgres 73 Apr 19 03:30 archive_status [postgres@31650d651e1c pg_wal]$ cat 00000002.history 1 0/C0002F8 before 2023-04-19 03:15:46.192096+00 standby promoteï¼šç•¶ standby è¢« promote æˆ primary æ™‚æœƒå‡ºç¾æ–°çš„ timelineã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [postgres@31650d651e1c pg_wal]$ ll total 32768 -rw-------. 1 postgres postgres 16777216 Apr 19 02:00 000000010000000000000006 -rw-------. 1 postgres postgres 16777216 Apr 19 02:00 000000010000000000000007 drwx------. 2 postgres postgres 6 Apr 19 02:00 archive_status [postgres@31650d651e1c pg_wal]$ pg_ctl promote waiting for server to promote.... done server promoted [postgres@31650d651e1c pg_wal]$ ll total 49160 -rw-------. 1 postgres postgres 16777216 Apr 19 02:03 000000010000000000000006.partial -rw-------. 1 postgres postgres 16777216 Apr 19 02:03 000000020000000000000006 -rw-------. 1 postgres postgres 16777216 Apr 19 02:00 000000020000000000000007 -rw-------. 1 postgres postgres 41 Apr 19 02:03 00000002.history drwx------. 2 postgres postgres 80 Apr 19 02:03 archive_status [postgres@31650d651e1c pg_wal]$ cat 00000002.history 1\t0/A000198\tno recovery target specified timeline å¯¦é«”æª”æ¡ˆ å¾ä¸Šä¸€ç¯€ä¸­å¯ä»¥çœ‹åˆ°ç”¢ç”Ÿæ–°çš„ timeline æ™‚æœƒå‡ºç¾å¾Œç¶´ç›¸åŒçš„ wal åŠ history æª”æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [postgres@31650d651e1c postgres]$ ll pg_wal/ total 32768 -rw-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000B -rw-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000C drwx------. 2 postgres postgres 80 Apr 19 03:27 archive_status # é…ç½® recovery_target åƒæ•¸ä¸¦é€²è¡Œ PITR [postgres@31650d651e1c postgres]$ vim postgresql.conf recovery_target_time = \u0026#39;2023-04-19 03:15:46\u0026#39; recovery_target_action = \u0026#39;promote\u0026#39; [postgres@31650d651e1c postgres]$ touch recovery.singal [postgres@31650d651e1c postgres]$ pg_ctl -l logfile restart waiting for server to shut down.... done server stopped waiting for server to start.... done server started [postgres@31650d651e1c pg_wal]$ ll total 49156 -rw-------. 1 postgres postgres 16777216 Apr 19 03:30 00000001000000000000000C -rw-------. 1 postgres postgres 16777216 Apr 19 03:30 00000002000000000000000C -rw-------. 1 postgres postgres 16777216 Apr 19 03:27 00000002000000000000000D -rw-------. 1 postgres postgres 50 Apr 19 03:30 00000002.history drwx------. 2 postgres postgres 73 Apr 19 03:30 archive_status [postgres@31650d651e1c pg_wal]$ cat 00000002.history 1 0/C0002F8 before 2023-04-19 03:15:46.192096+00 å¯ä»¥è§€å¯Ÿåˆ°æœ‰ä¸€å€‹ 00000002.history çš„ timeline ç›¸é—œæª”æ¡ˆï¼Œé€™å€‹ä»¶ç´€éŒ„äº†é€™å€‹ timeline å¾å“ªæ¢ timeline åˆ†æ”¯å‡ºä¾†åŠä»€éº¼æ™‚å€™ï¼Œé€™åŒ…å«äº†ä»¥ä¸‹ 3 å€‹å­—æ®µï¼š\nparentTLIï¼šparent timeline çš„ IDã€‚ LSNï¼šç™¼ç”Ÿ timline åˆ‡æ›çš„ WAL ä½ç½®ã€‚ reasonï¼štimeline ç”¢ç”Ÿçš„åŸå› ã€‚ ä¾‹å¦‚ï¼š\n1 2 [postgres@31650d651e1c pg_wal]$ cat 00000002.history 1\t0/A000198\tbefore 2023-4-19 12:05:00.861324+00 ä»¥ä¸Šè¡¨ç¤ºäº† timeline 2 æ˜¯åŸºæ–¼ timeline 1 çš„ basebackup é€é WAL æ¢å¾©åˆ° 0/A000198 å°æ‡‰ 2023-4-19 12:05:00.861324+00 ä¹‹å‰çš„ä½ç½®ã€‚\nå¦å¤–é‚„å¯ä»¥æ³¨æ„åˆ°å‡ºç¾æ–°çš„ timeline çš„æ™‚å€™ WAL æª”åä¹Ÿæœ‰äº†è®ŠåŒ–ï¼š00000001000000000000000C â†’ 00000002000000000000000Cï¼Œå¯ä»¥è§€å¯Ÿåˆ°å‰ 8 ç¢¼ç”± 00000001 è®Šæˆ 00000002ï¼Œäº‹å¯¦ä¸Š WAL æª”åçš„å‰ 8 ç¢¼å°±æ˜¯ç”¨ä¾†æ¨™ç¤ºå…¶æ‰€å±¬çš„ timeline idã€‚\nåƒè€ƒ PostgreSQL: Documentation: 15: ChapterÂ 26.Â Backup and Restore\nPostgreSQLå¤‡ä»½æ¢å¤å®ç° - çŸ¥ä¹ (zhihu.com)\n1.pg_basebackup ä»‹ç»åŠä½¿ç”¨ - www.cqdba.cn - åšå®¢å›­ (cnblogs.com)\nPostgreSQL å¾å…¥é–€åˆ°å‡ºé–€ ç¬¬ 8 ç¯‡ å‚™ä»½èˆ‡æ¢å¾© - å°éƒ¨è½ (twblogs.net)\nPostgreSQLæ—¶é—´çº¿(timeline)å’ŒHistory File_pg history_foucusã€çš„åšå®¢-CSDNåšå®¢\nThe Internals of PostgreSQL : Chapter 10 Base Backup \u0026amp; Point-in-Time Recovery (interdb.jp)\n","date":"2020-02-26T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/postgre-backup-restore/","title":"PostgreSQL å‚™ä»½é‚„åŸ"},{"content":"Replication æ˜¯æä¾›é«˜å¯ç”¨åŠ load balance çš„åŸºç¤ï¼Œå› æ­¤ä¸è«–åœ¨å“ªä¸€ç¨® database éƒ½æ˜¯ä¸€é …é‡è¦çš„åŠŸèƒ½ã€‚\nåœ¨ä¸åŒçš„ Database ä¸‹å°æ–¼ä¸»å‚™ Server éƒ½æœ‰ä¸åŒçš„è¡“èªï¼š\nMySQL \u0026lt; 8.0.26 MySQL \u0026gt; 8.0.26 MongoDB PostgreSQL ä¸» Master Source Primary Primary å‚™ Slave Replica Secondary Standby åœ¨ MySQL ä¸­é€é Server å±¤çš„ binlog é€é\nåœ¨ PG ä¸­å‰‡æ˜¯ç›´æ¥é€é WAL (ç›¸å°æ–¼ InnoDB redo log)\nStandby (Slave) çš„è¡Œç‚º ç•¶ server å•Ÿå‹•æ™‚æ•¸æ“šç›®éŒ„ä¸­åŒ…å« standby.signal æ–‡ä»¶æ™‚ï¼Œå‰‡ server æœƒé€²å…¥ standby æ¨¡å¼ã€‚\nåœ¨ standby æ¨¡å¼ä¸‹ï¼Œstandby å¯ä»¥é€éä»¥ä¸‹å…©ç¨®æ–¹å¼ä¾†ç²å–ä¸¦å›æ”¾ Primary ä¸Šçš„ WALï¼š\nWAL Archive Streaming Replication é™¤æ­¤ä¹‹å¤– Standby é‚„æœƒå˜—è©¦æ¢å¾©åœ¨ pg_wal ç›®éŒ„ä¸­çš„ä»»ä½• WALã€‚\nStandby åœ¨å•Ÿå‹•æ™‚æœƒæœ‰ä»¥ä¸‹è¡Œç‚ºï¼š\nèª¿ç”¨ restore_command é€²è¡Œæ¢å¾©ã€‚ ç•¶æ­¥é©Ÿ1 é”åˆ° WAL æœ«å°¾ä¸”æ¢å¾©å¤±æ•—ï¼Œå‰‡å°‡å˜—è©¦æ¢å¾© pg_wal ç›®éŒ„ä¸­å¯ç”¨çš„ WALã€‚ ç•¶æ­¥é©Ÿ2å¤±æ•—ï¼Œä¸”é…ç½®äº† Streaming Replication ï¼Œå‰‡æœƒå˜—è©¦é€£æ¥åˆ° Primary ä¸¦å¾å­˜æª”æˆ– pg_wal ç›®éŒ„ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ç´€éŒ„é–‹å§‹ Streaming WALã€‚ ç•¶æ­¥é©Ÿ3å¤±æ•—ï¼Œæˆ–æ˜¯æ²’æœ‰é…ç½® Streaming Replication å‰‡å°‡å›åˆ°æ­¥é©Ÿ1é‡æ–°å˜—è©¦ ä»¥ä¸Šæ­¥é©Ÿçš„ retry å¾ªç’°æˆ–ä¸€ç›´æŒçºŒåˆ° server é—œé–‰æˆ–è€… failoverã€‚\nfailover å¯ä»¥é€éé‹è¡Œ pg_ctl promoteã€èª¿ç”¨ pg_promote() æˆ–ç™¼ç¾ trigger file (promote_trigger_file) æ™‚ï¼Œå‰‡æœƒé€€é€€å‡º standby æ¨¡å¼æˆç‚º primary æä¾›æ­£å¸¸æ“ä½œã€‚\nå»ºè­° åœ¨ä¸åŒçš„ä¸»è¦ç‰ˆæœ¬è™Ÿä¸­é€šå¸¸æ˜¯ç„¡æ³•é€²è¡Œ log shipping çš„ é›–ç„¶ PG æ²’æœ‰æ­£å¼æ”¯æŒä¸åŒæ¬¡è¦ç‰ˆæœ¬ä¹‹é–“çš„ log shippingï¼Œä½†åœ¨æ¬¡è¦ç‰ˆæœ¬ä¸­ä¸€èˆ¬ä¸æ›´æ”¹ Disk æ ¼å¼ï¼Œä¸¦ä¸”æ–°çš„æ¬¡è¦ç‰ˆæœ¬æ›´å¯èƒ½å¾èˆŠçš„æ¬¡è¦ç‰ˆæœ¬è®€å– WALï¼Œå› æ­¤å‡ç´šå°ç‰ˆæœ¬è™Ÿæ™‚å»ºè­°å…ˆå‡ç´š standbyã€‚ åœ¨ Primary ä¸Šè¨­ç½® Continuous archiving æ™‚ï¼Œæ‡‰è©²è€ƒæ…®å°‡æ­¸æª”ä½ç½®è¨­ç‚º standby æœ¬èº«æˆ–æ˜¯é Primary æ©Ÿå™¨ä¸Šï¼Œé¿å…å› ç‚º Primary æ©Ÿå™¨æœ¬èº«å‡ºå•é¡Œè€Œç„¡æ³•è¨ªå•ã€‚ ä½¿ç”¨ Streaming Replicaiton éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é …ï¼š å‰µå»º replication roleï¼Œä¸¦åœ¨ ph_hba.conf æœ‰æ­£ç¢ºçš„è¨­ç½®ï¼Œç¢ºä¿ standby èƒ½å¤ é€£ç·š Primaryã€‚ ç¢ºä¿ Primary ä¸Šçš„ max_wal_senders è¨­ç½®è¶³å¤ å¤§ã€‚ å¦‚æœä½¿ç”¨ Replication Slot é‚„éœ€è¦ç¢ºä¿ max_replication_slots è¨­ç½®ã€‚ è¨­ç½® Standby Log Shipping (warm standby) åœ¨ PG 9.0 ä¹‹å‰ï¼ŒPostgreSQL åªæä¾›é€™ç¨®ç•°æ­¥ replication æ–¹å¼ï¼Œé€™æ˜¯é€é Primary æ¯æ¬¡å‚³é€ä¸€å€‹ WAL çµ¦ Standby ä¾†å¯¦ç¾ï¼Œç¼ºé™·ä¹Ÿå¾ˆæ˜é¡¯å°±æ˜¯ Standby è‡³å°‘æœƒè½å¾Œ Primary ä¸€å€‹ WALã€‚\né…ç½®æ–¹å¼ åœ¨ Primary ä¸­æ–°å¢ä»¥ä¸‹è¨­ç½®\n1 2 archive_mode = on archive_command = \u0026#39;test ! -f /var/data/xlog_archive/%f \u0026amp;\u0026amp; cp %p /var/data/xlog_archive/%f\u0026#39; å° Primary é€²è¡Œ Base backup\n1 pg_basebackup -P -D /var/data/backup/pg_back_$(date +\u0026#34;%F_%T\u0026#34;) é‚„åŸåˆ° Standby\n1 cp -R ./backup/pg_back_2023-04-17_07\\:06\\:57/* /var/data/postgres ä¿®æ”¹ Standby è¨­ç½®ï¼Œä¸¦ä»¥ standby æ¨¡å¼é‹è¡Œ\n1 restore_command = \u0026#39;cp /var/data/xlog_archive/%f \u0026#34;%p\u0026#34;\u0026#39; 1 2 touch standby.signal pg_ctl -D /var/data/postgres -l logfile start é€éåœ¨ Primary æ–°å¢è³‡æ–™ï¼Œä¸¦ä½¿ç”¨ pg_switch_wal() å¼·åˆ¶è§¸ç™¼ WAL çš„åˆ‡æ›ä¾†è§€å¯Ÿ\nprimary\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 -- primary [postgres @ postgres] [local]:5432] 07:16:07 \u0026gt; \\c test You are now connected to database \u0026#34;test\u0026#34; as user \u0026#34;postgres\u0026#34;. [postgres @ test] [local]:5432] 07:16:08 \u0026gt; select * from test; id | name ----+------- 1 | test1 (1 row) Time: 1.607 ms [postgres @ test] [local]:5432] 07:16:13 \u0026gt; insert into test values(2,\u0026#39;test2\u0026#39;); INSERT 0 1 Time: 1.594 ms [postgres @ test] [local]:5432] 07:16:24 \u0026gt; select * from test; id | name ----+------- 1 | test1 2 | test2 (2 rows) Time: 0.330 ms [postgres @ test] [local]:5432] 07:16:25 \u0026gt; SELECT pg_switch_wal(); pg_switch_wal --------------- 0/30003D8 (1 row) Time: 171.419 ms standby\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 [postgres @ postgres] [local]:5432] 07:15:41 \u0026gt; \\c test You are now connected to database \u0026#34;test\u0026#34; as user \u0026#34;postgres\u0026#34;. [postgres @ test] [local]:5432] 07:15:44 \u0026gt; \\dt List of relations Schema | Name | Type | Owner --------+------+-------+---------- public | test | table | postgres (1 row) [postgres @ test] [local]:5432] 07:15:52 \u0026gt; select * from test; id | name ----+------- 1 | test1 (1 row) Time: 0.660 ms [postgres @ test] [local]:5432] 07:16:00 \u0026gt; select * from test; id | name ----+------- 1 | test1 (1 row) Time: 0.425 ms -- åœ¨ primeary è§¸ç™¼ WAL åˆ·æ–°å¾Œ [postgres @ test] [local]:5432] 07:16:27 \u0026gt; select * from test; id | name ----+------- 1 | test1 2 | test2 (2 rows) Time: 0.334 ms ç›¸é—œåƒæ•¸ Archiving archive_mode (enum)ï¼šè¨­ç½®æ˜¯å¦é€²è¡Œ archiveï¼Œæœ‰ä»¥ä¸‹ä¸‰ç¨®è¨­ç½®ï¼š\noffï¼šé—œé–‰ archiveã€‚\nonï¼šæ­£å¸¸æ¨¡å¼ä¸‹é–‹å•Ÿ archiveï¼Œä½†æ˜¯åœ¨ recovery æˆ–æ˜¯ standby æ™‚ä¸é€²è¡Œ archvieã€‚\\\nç•¶ standbyæå‡ç‚º primary æ™‚åªæœƒ archive è‡ªå·±ç”¢ç”Ÿçš„ WALï¼Œè€Œä¸æœƒ archive åŸæœ¬å¾å¦ä¸€å€‹ primary å–å¾—çš„ WALã€‚\nalwaysï¼šä¸è«–ä»€éº¼æ¨¡å¼éƒ½é€²è¡Œ archiveã€‚\narchive_command (string)ï¼šè¨­ç½® archive WAL çš„ shell æŒ‡ä»¤ã€‚\narchive_library (string)ï¼šè¨­ç½®ç”¨æ–¼ archive WAL çš„ libraryï¼Œè‹¥ç‚ºç©ºè¡¨ç¤ºä½¿ç”¨ archive_commandã€‚\narchive_timeout (integer)ï¼šæ­¤åƒæ•¸ç‚ºæ™‚é–“è¨­ç½®é è¨­å–®ä½ç‚ºç§’ï¼Œç•¶æ­¤åƒæ•¸å¤§æ–¼ 0 æ™‚ï¼Œæœƒå¼·åˆ¶ server åªè¦è·é›¢ä¸Šæ¬¡åˆ‡æ›åˆ°æ–°çš„ WAL å·²ç¶“éå»é€™æ®µæ™‚é–“ï¼Œä¸”æœ‰æ•¸æ“šåº«æ´»å‹•å°±å¿…é ˆåˆ‡æ›åˆ°æ–°çš„ WALã€‚\nå› ç‚º archive åªæœƒé‡å°å®Œæˆçš„ WAL ä½œç”¨ï¼Œå› æ­¤è¨­ç½®æ­¤åƒæ•¸å¯ä»¥é¿å…ç•¶ WAL è¼ªæ›ä¸é »ç¹æ™‚ï¼Œå°è‡´ Transaction éä¹…æ²’æœ‰è¢«å®‰å…¨çš„æ­¸æª”æˆ–è€…åŒæ­¥åˆ° standbyã€‚\næ³¨æ„ï¼šå¼·åˆ¶åˆ‡æ› WAL çš„æ–‡ä»¶å¤§å°å’Œå®Œæ•´çš„æ–‡ä»¶å¤§å°ç›¸åŒéƒ½æ˜¯ 16MBï¼Œå› æ­¤è¨­ç½®å¤ªçŸ­çš„ archive_timeout æœƒå°è‡´æ­¸æª”å­˜æª”è†¨è„¹ï¼Œé€šå¸¸ 1 åˆ†é˜å·¦å³çš„è¨­ç½®æ˜¯åˆç†ã€‚å¦‚æœå¸Œæœ› Primary å’Œ Standby ä¹‹é–“çš„å»¶é²æ›´å°æ‡‰è©²è€ƒæ…® streaming replication è€Œä¸æ˜¯èª¿æ•´æ­¤å€¼ã€‚\nArchive Recovery æ­¤è™•ç”¨æ–¼è¨­ç½® recovery æœŸé–“çš„è¨­å®šï¼Œrecovery åŒ…å«ä»¥ä¸‹å…©è€…ï¼š\nrecovery modeï¼šé€éåœ¨æ•¸æ“šç›®éŒ„ä¸­å‰µå»º recovery.signal è¨­ç½® standby modeï¼šé€éåœ¨æ•¸æ“šç›®éŒ„ä¸­å‰µå»º standby.signal è¨­ç½®ï¼Œé¦–å…ˆé€²å…¥ recovery mode ä¸¦åœ¨æ¢å¾©åˆ°æ­¸æª”çš„ WAL æœ«å°¾æ™‚ä¸æœƒåœæ­¢ï¼Œè€Œæ˜¯æœƒå˜—è©¦é€é primary_conninfo å‘æŒ‡å®šçš„ primary è«‹æ±‚ WAL æˆ– restore_command ä¾†ç¹¼çºŒå›æ”¾ WALã€‚ å‚™æ³¨ï¼šå¦‚æœ 2 å€‹ signal éƒ½è¢«å»ºç«‹å‰‡æœƒä»¥ standby mode å„ªå…ˆã€‚\nrestore_command (string)ï¼šç”¨æ–¼è¨­ç½®å¦‚ä½•å°‡æ­¸æª”çš„ WAL ç”¨æ–¼ restore çš„ shell å‘½ä»¤ã€‚\nç¯„ä¾‹å¦‚ä¸‹ï¼š\n1 restore_command = \u0026#39;cp /mnt/server/archivedir/%f \u0026#34;%p\u0026#34;\u0026#39; ä¸Šè¿°è¨­å®šè¡¨ç¤ºå°‡è¤‡è£½ /mnt/server/archivdir åº•ä¸‹çš„ WAL åˆ° pg_wal ä¸­ã€‚\n%fï¼šè¡¨ç¤ºæ­¸æª” WAL æ–‡ä»¶åç¨±ã€‚ %pï¼šè¡¨ç¤ºæ”¾ç½®ç”¨æ–¼æ¢å¾© WAL çš„ç›®éŒ„ (pg_wal)ã€‚ archive_cleanup_cpmmand (string)ï¼šç”¨æ–¼è¨­ç½®æ¸…ç† standby ä¸å†éœ€è¦çš„æ­¸æª” WAL shell å‘½ä»¤ã€‚\nç¯„ä¾‹å¦‚ä¸‹ï¼š\n1 archive_cleanup_command = \u0026#39;pg_archivecleanup /mnt/server/archivedir %r\u0026#39; ä¸Šè¿°è¨­å®šè¡¨ç¤ºé‹è¡Œ pg_archivecleanup å°‡ä¸Šä¸€å€‹ WAL æ–‡ä»¶åˆªé™¤ã€‚\n%rï¼šè¡¨ç¤ºéœ€è¦çš„ WAL æ–‡ä»¶çš„ä¸Šä¸€å€‹ WAL æ–‡ä»¶åç¨±ã€‚ recovery_end_command (string)ï¼šç”¨æ–¼è¨­ç½®ç•¶ recovery çµæŸæ™‚åŸ·è¡Œçš„ shell å‘½ä»¤ï¼Œä¾‹å¦‚å¯ä»¥ç”¨æ–¼ç™¼é€ email é€šçŸ¥ï¼š\n1 recovery_end_command = \u0026#39;echo \u0026#34;Recovery complete\u0026#34; | mail -s \u0026#34;Recovery complete\u0026#34; admin@example.com\u0026#39; å°ç¯€ Log Shipping æ˜¯ä¸€ç¨®ç•°æ­¥ä¸”å³æ™‚æ€§ä¸é«˜çš„ replication æ–¹å¼ï¼Œä½†æ˜¯ä»–ç›¸æ‡‰çš„å„ªå‹¢å°±æ˜¯å› ç‚ºæ˜¯é€é primary æ­¸æª”å¾Œçš„ WAL é€²è¡Œæ¢å¾©ï¼Œå› æ­¤ä¸æœƒæœ‰ Streaming Replicaion ä¸Ÿå¤± WAL å°è‡´ç„¡æ³•å¾©åŸçš„å•é¡Œã€‚\né›–ç„¶ä¸æ¨è–¦å°‡ Log Shipping åšç‚ºä¸»åŠ›çš„ replication æ–¹æ¡ˆï¼Œä½†æ˜¯å¯ä»¥å°‡å…¶åŒæ™‚å’Œ Streaming Replication ä¸€èµ·é‹è¡Œä½œç‚ºé™„å±¬æ–¹æ¡ˆï¼Œåªæœ‰ç•¶ Streaming Replication å› ç‚ºæŸäº›åŸå› è·Ÿä¸ä¸Š Primary å°è‡´å°æ‡‰çš„ WAL è¢«åˆªé™¤æ™‚ï¼Œé€éæ­¸æª”çš„ WAL ä¾†é€²è¡Œå¾©åŸã€‚\nStreaming Replication (æµè¤‡è£½ æˆ–ç¨± ç‰©ç†è¤‡è£½) åœ¨ PG 9.0 é–‹å§‹æä¾›äº† Steaming Replicationï¼Œé›–ç„¶å’Œ Log Shipping ä¸€æ¨£éƒ½æ˜¯é€é WAL æ—¥èªŒçš„å›æ”¾ä¾†é”åˆ° Primary å’Œ Standby çš„åŒæ­¥ï¼Œä½†æ˜¯ Streaming Replication åªè¦åœ¨ WAL ä¸­ä¸€ç”¢ç”Ÿè®ŠåŒ–å°±æœƒç™¼é€çµ¦ Standbyï¼Œè€Œä¸éœ€è¦ç­‰åˆ° WAL åˆ‡æ›æ‰å‚³é€ï¼Œä¹Ÿå°±æ˜¯èªª Streaming Replication æœƒæœ‰æ›´çŸ­çš„ replication delayã€‚\nå…·é«”å¯¦ç¾æ–¹é¢å¤§é«”ä¸Šå…¶å¯¦å’Œ MySQL å·®ä¸å¤šï¼Œåªæ˜¯ MySQL æ˜¯é€é binlog ä¸­çš„é‚è¼¯è¤‡è£½ï¼Œä½† PG çš„ WAL æ¯”è¼ƒæ¥è¿‘ MySQL redo log ä¹Ÿå°±æ˜¯èªªæ˜¯æ ¹æ“šå¯¦éš›ä¿®æ”¹ Disk ç‰©ç†ç©ºé–“çš„ç´€éŒ„ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ PG ä¸­ Master å’Œ Slave çš„åº•å±¤æ•¸æ“šç‹€æ…‹æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚\nåœ¨ Streaming Replication æœ‰ä»¥ä¸‹è§’è‰²ï¼š\nMaster ä¸Šçš„ backend é€²ç¨‹ï¼šåŸ·è¡Œæ”¶åˆ°çš„ Query æŒ‡ä»¤ï¼Œåœ¨ä¿®æ”¹æ•¸æ“šå‰å…ˆå¯«å…¥ WALï¼Œä¸¦åœ¨ commit çš„æ™‚å€™å°‡ WAL fsync åˆ° Diskã€‚ Master ä¸Šçš„ WAL sender é€²ç¨‹ï¼šå°‡ WAL ç™¼é€çµ¦ Slave çš„ WAL receiver ã€‚ Slave ä¸Šçš„ WAL receiver é€²ç¨‹ï¼šæ¥æ”¶ä¸¦æŒä¹…åŒ–å„²å­˜ Master WAL sender ç™¼é€çš„ WALã€‚å¯ä»¥é¡æ¯”ç‚º MySQL çš„ IO THREADã€‚ Slave ä¸Šçš„ startup é€²ç¨‹ï¼šApply WAL receiver æ¥æ”¶åˆ°çš„ WALã€‚å¯ä»¥é¡æ¯”ç‚º MySQL çš„ SQL THREADã€‚ åŒæ­¥ OR ç•°æ­¥ æ­¤å¤–å’Œ MySQL ä¸€æ¨£ä¹Ÿåˆ†ç‚ºç•°æ­¥æˆ–åŒæ­¥ï¼Œä¸»è¦é€éä»¥ä¸‹åƒæ•¸æ§åˆ¶ï¼š\nsynchronous_commit (enum)ï¼šæŒ‡å®š server åœ¨å®Œæˆå¤šå°‘ WAL è™•ç†å¾Œæ‰è¿”å› Clinet ç«¯æˆåŠŸã€‚\nç•¶ synchronous_standby_names ç‚ºç©ºæ™‚ï¼Œåˆ†ç‚ºå…©ç¨®è¨­ç½®ï¼š\nonï¼šæ­¤ç‚ºé»˜èªå€¼ä¸” OFF ä»¥å¤–çš„è¨­ç½®éƒ½è¦–ç‚º ONï¼Œç•¶ WAL fsync åˆ° Disk æ‰è¿”å›æˆåŠŸçµ¦ Client ç«¯ã€‚ offï¼šä¸æœƒç­‰å¾… WAL çš„è™•ç†ï¼Œä¹Ÿå°±æ˜¯èªªå¯èƒ½æœƒä¸Ÿå¤± Transactionï¼Œæœ€å¤šå¯èƒ½æœƒå°è‡´ä¸Ÿå¤± wal_write_delay * 3ã€‚ ç•¶ synchronous_standby_names ä¸ç‚ºç©ºæ™‚ï¼Œåˆ†ç‚º5ç¨®è¨­ç½®ï¼š\nç¸½å…±æœ‰ä»¥ä¸‹ 5 å€‹å€¼ï¼š\nremote_applyï¼šä¿è­‰ Slave å·²ç¶“æ”¶åˆ°è©² Transaction çš„ WAL ä¸¦èª¿ç”¨ fsync() diskï¼Œç¢ºä¿äº†è©² Transaction åªæœ‰ Masterã€Slave éƒ½ç™¼ç”Ÿæ•¸æ“šæå£æ‰æœƒä¸Ÿå¤± Transactionï¼Œä¸¦ä¸”é‚„å®Œæˆäº† WAL å›æ”¾ï¼Œå› æ­¤åœ¨ Masterã€Slave ä¸Šæ“æœ‰ä¸€è‡´æ€§è®€å–ã€‚ onï¼šä¹Ÿå¯ç¨±ç‚º remote_flushï¼Œä¿è­‰ Slave å·²ç¶“æ”¶åˆ°è©² Transaction çš„ WAL ä¸¦èª¿ç”¨ fsync() diskï¼Œç¢ºä¿äº†è©² Transaction åªæœ‰ Masterã€Slave éƒ½ç™¼ç”Ÿæ•¸æ“šæå£æ‰æœƒä¸Ÿå¤± Transactionï¼Œä½†å› ç‚ºé‚„æ²’æœ‰å›æ”¾ WALï¼Œå› æ­¤ Masterã€Slave æ²’æœ‰ä¸€è‡´æ€§è®€å–ã€‚ remote_writeï¼šä¿è­‰ Slave å·²ç¶“æ”¶åˆ°è©² Transaction çš„ WAL ä¸¦å¯«å…¥ OS ç·©å­˜ï¼Œä½†æœªèª¿ç”¨ fsync() diskï¼Œä¹Ÿå°±æ˜¯èªª PG server crash ä¸¦ä¸æœƒå°è‡´ Transaction ä¸Ÿå¤±ï¼Œä½†æ˜¯æ•´å€‹ OS ç³»çµ± Crash å°‡å¯èƒ½å°è‡´ Transaction ä¸Ÿå¤±ã€‚ localï¼šç­‰åŒæ–¼ synchronous_standby_names ç‚ºç©ºæ™‚çš„ ON è¨­ç½®ï¼Œä¹Ÿå°±æ˜¯èªªåªè¦ Master çš„ WAL æœ‰ fsync å³å¯ä¸å¿…ç­‰å¾… slaveï¼Œä¹Ÿå°±æ˜¯ç•°æ­¥è¤‡è£½ã€‚ offï¼šä¸æœƒç­‰å¾… WAL çš„è™•ç†ï¼Œä¹Ÿå°±æ˜¯èªªå¯èƒ½æœƒä¸Ÿå¤± Transactionï¼Œæœ€å¤šå¯èƒ½æœƒå°è‡´ä¸Ÿå¤± wal_write_delay * 3ã€‚ æ³¨æ„ï¼šç•¶ synchronous_standby_names ç‚ºç©ºæ™‚ï¼Œé™¤äº† OFF ä»¥å¤–çš„è¨­å®šéƒ½æœƒè¢«è¦–ç‚º ONã€‚\nsynchronous_standby_names (string)ï¼šæŒ‡å®šè¦æ±‚åŒæ­¥ replication çš„ slave åˆ—è¡¨ã€‚\né€™é‚Šåˆ—å‡º Slave åœ¨ primary_conninfo ä¸­è¨­ç½®çš„ application_name (å¦‚æœæ²’æœ‰å‰‡æ˜¯ cluster_name)ã€‚\nå¯ä»¥è¨­ç½®æˆä»¥ä¸‹æ ¼å¼ï¼š\n1 2 3 [FIRST] num_sync ( standby_name [, ...] ) ANY num_sync ( standby_name [, ...] ) standby_name [, ...] å…¶ä¸­ num_sync ç‚ºæ•¸å­—ï¼Œè¡¨ç¤ºå¿…é ˆè‡³å°‘æœ‰å¤šå°‘ Slave å›è¦†å·²åŒæ­¥å®Œæˆçš„ Ack è¨Šè™Ÿï¼Œå’Œ FIRSTã€ANY çµ„åˆæœ‰ä»¥ä¸‹æ•ˆæœï¼š\n[FIRST] num_syncï¼šå¿…é ˆæŒ‰ç…§åˆ—è¡¨ä¸­çš„é †åºå‰ num_sync æ•¸é‡çš„ slave å›è¦†å·²åŒæ­¥å®Œæˆçš„ Ack è¨Šè™Ÿæ‰å¯ä»¥ï¼Œä¹‹å¾Œçš„ slave ä½œç‚ºåŒæ­¥ slave çš„å‚™é¸åªæœ‰å„ªå…ˆåºé«˜çš„å‡ºç¾å•é¡Œæ‰æœƒæ›¿è£œã€‚ ANY num_syncï¼šåªè¦åˆ—è¡¨ä¸­çš„ä»»æ„ num_sync æ•¸é‡çš„ slave å›è¦†å·²åŒæ­¥å®Œæˆçš„ Ack è¨Šè™Ÿå³å¯ã€‚ å»ºç½®ç¯„ä¾‹ æª¢æŸ¥ Source çš„è¨­å®š\n1 2 3 4 5 6 listen_addresses = \u0026#39;*\u0026#39; # ä»¥ä¸‹çš†ç‚ºé è¨­å€¼ hot_standby = ON wal_level = replica max_wal_senders = 10 è¨­ç½® replication ç”¨çš„ User\n1 createuser -U postgres --replication repl ç¢ºèª Source ä¸­çš„ pg_hba.conf æ˜¯å¦èƒ½æ¥å— Replica æ©Ÿå™¨çš„é€£ç·š\n1 2 # TYPE DATABASE USER ADDRESS METHOD host replication repl 172.17.0.3/16 trust å° Source é€²è¡Œ Base backup\n1 pg_basebackup -P -D /var/data/backup/pg_back_$(date +\u0026#34;%F_%T\u0026#34;) -R -U repl -R é¸é …æœƒåœ¨å‚™ä»½æª”ä¸­æœ‰ä»¥ä¸‹ä¸åŒ\nç”Ÿæˆ standby.signal\nåœ¨ postgresql.auto.conf ä¸­å¤šå‡º primary_conninfo çš„è³‡è¨Šï¼š\n1 primary_conninfo = \u0026#39;user=repl passfile=\u0026#39;\u0026#39;/home/postgres/.pgpass\u0026#39;\u0026#39; channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=disable krbsrvname=postgres target_session_attrs=any\u0026#39; å°‡ Source å‰›å‰›çš„ Base backup é‚„åŸåˆ° Replica ä¸Š\n1 cp -R /root/pg_data/source/backup/pg_back_2023-04-13_07\\:20\\:40/* /root/pg_data/replica/postgres å•Ÿå‹• replica\n1 pg_ctl -D /var/data/postgres -l logfile start 1 2 3 4 2023-04-13 09:10:54.724 UTC [1136] LOG: consistent recovery state reached at 0/1A000000 2023-04-13 09:10:54.725 UTC [1135] LOG: database system is ready to accept read-only connections 2023-04-13 09:10:54.733 UTC [1140] LOG: started streaming WAL from primary at 0/1A000000 on timeline 1 done å°ç¯€ å¯¦å‹™ä¸Šå¯ä»¥çµåˆ log shipping å’Œ streaming replication ä¸€èµ·ä½¿ç”¨ï¼Œç•¶ streaming replicaiton å› ç‚º TCP ç•°å¸¸æˆ–æ˜¯ Primary ä¸Ÿæ£„æ‰€éœ€çš„ WAL æ™‚ï¼ŒPG èƒ½å¤ è‡ªå‹•åˆ‡æ›å›ä½¿ç”¨ log shipping é€é restore_command ç¹¼çºŒè¿½è¶• Pimary çš„é€²åº¦ï¼Œç›´åˆ°è¶•ä¸Š Primary å¾Œ Standby æœƒé‡æ–°å˜—è©¦åˆ‡å› streaming replictionã€‚\nReplication Slot åŠŸç”¨ - Slave æ‰€éœ€çš„ WAL åœ¨ Master ä¸Šçš„ä¿ç•™ åœ¨ PostgreSQL 9.4 ä¹‹å‰æ˜¯æ²’æœ‰ Replication Slot çš„ï¼ŒSlave å› ç‚ºæŸäº›åŸå› æš«åœ replication ä¹‹å¾Œï¼Œå› ç‚ºåœ¨ Master ä¸Šéœ€è¦æ‡‰ç”¨çš„ WAL å·²ç¶“è¢«æ¸…é™¤ï¼Œå°è‡´ Slave æ¢å¾© replication å¾Œç™¼ç”Ÿä»¥ä¸‹ç‹€æ³ï¼šrequested WAL segment 0000000100000000000000xxx has already been removedï¼Œç‚ºäº†é¿å…é€™å€‹ç‹€æ³å¯ä»¥é€éä»¥ä¸‹åƒæ•¸çš„é…ç½®ï¼š\nwal_keep_sizeï¼šæŒ‡å®š pg_wal ç›®éŒ„ä¸‹è‡³å°‘éœ€ä¿ç•™çš„ WAL å¤§å°ã€‚\né»˜èªå€¼ç‚º 0 è¡¨ç¤ºä¸æœƒé¡å¤–ä¿ç•™ WALï¼Œä¹Ÿå°±æ˜¯èªª slave å¯ç”¨çš„ WAL segments æ•¸é‡å–æ±ºæ–¼å‰ä¸€å€‹ checkpoint å’Œ WAL archiving ç‹€æ…‹ã€‚\nå‚™è¨»ï¼šåœ¨ PG 13 ä¹‹å‰æ˜¯ä½¿ç”¨ wal_keep_segments ä¾†æ§åˆ¶ï¼Œä»–å€‘ä¹‹é–“çš„é—œä¿‚æ˜¯ wal_keep_size = wal_keep_segments * wal_segment_size (ä¸€èˆ¬æ˜¯ 16 MB)ã€‚\narchive_commandï¼šè¨­ç½® WAL archive çš„æŒ‡ä»¤ã€‚\nå°‡ WAL archive åˆ°å…¶ä»–åœ°æ–¹ï¼Œé€™æ¨£ Slave å°±èƒ½å¾å·²ç¶“ archive çš„ WAL ç¹¼çºŒæ¢å¾©ã€‚\nä¸éä»¥ä¸Šæ–¹æ³•æœƒä¿ç•™è¼ƒå¤šçš„ WALï¼Œå› æ­¤æœ‰äº† Replication Slot ç”¨ä¾†ç¢ºä¿ Master åœ¨æ‰€æœ‰ Slave æ”¶åˆ° WAL segments ä¹‹å‰ä¸æœƒåˆªé™¤å°æ‡‰çš„éƒ¨åˆ†ã€‚\nä½†é€™ä¹Ÿå¸¶ä¾†äº†ç›¸æ‡‰çš„å•é¡Œï¼šç•¶ Slave ç™¼ç”Ÿç•°å¸¸ç„¡æ³•å›è¦† Master ç•¶å‰çš„ lsn ä½ç½®ï¼Œå°±æœƒå°è‡´ Master ä¸æ–·ä¿ç•™ WAL æœ€å¾Œå°è‡´ Disk ç©ºé–“ç”¨ç›¡è€Œç„¡æ³•æä¾›æ­£å¸¸æœå‹™ã€‚\nåœ¨ PostgresSQL 13 ä¹‹å‰ï¼Œåªèƒ½é€éç›£æ§ replication ç‹€æ…‹ä¾†ç›¡æ—©ç™¼ç¾é€²è¡Œè™•ç†ï¼Œä¾‹å¦‚ä»¥ä¸‹èªå¥å¯ä»¥çŸ¥é“ä¿ç•™çš„ lsn åˆ°ç•¶å‰æœ€æ–°çš„ redo_lsn è½å¾Œå¤šå°‘ï¼š\n1 2 3 4 5 6 postgres=# SELECT redo_lsn, slot_name,restart_lsn, round((redo_lsn-restart_lsn)/1024/1024,2) AS MB_behind FROM pg_control_checkpoint(), pg_replication_slots; redo_lsn | slot_name | restart_lsn | mb_behind -----------+------------+-------------+----------- 0/AAFF2D0 | pgstandby1 | 0/AAFF3B8 | 0.00 (1 row) åœ¨ PostgresSQL 13 æ™‚æ¨å‡ºäº† max_slot_wal_keep_size é€™å€‹è¨­ç½®ï¼š\nmax_slot_wal_keep_size (integer)ï¼šè¨­ç½® replication slot åœ¨ pg_wal ç›®éŒ„ä¸­ä¿ç•™çš„æœ€å¤§ wal å¤§å°ã€‚\nç•¶ä¸€å€‹ slot çš„ restart_lsn è½å¾Œæ–¼ current_lsn æœ¬æ•¸å€¼å¾Œæœƒåœæ­¢ stream replicationï¼Œä¸”è©² slot æœƒè¢«æ¨™è¨˜ç‚ºç„¡æ•ˆï¼ŒåŒæ™‚ä¹‹å‰çš„ WAL å°‡è¢«åˆªé™¤ã€‚\né è¨­å€¼ç‚º -1 è¡¨ç¤ºä¸é™åˆ¶ã€‚\nä»¥ä¸Šåƒæ•¸æ¥µå¤§é¿å…äº†åœ¨ç™¼ç”Ÿ Master è¢« WAL æ’çˆ†çš„å•é¡Œï¼Œä¸¦ä¸”åœ¨ pg_replication_slots ä¹Ÿå¢åŠ äº† wal_status å’Œ safe_wal_size å­—æ®µæ–¹ä¾¿ç›£æ§ï¼š\n1 2 3 4 5 postgres=# select wal_status,safe_wal_size from pg_replication_slots; wal_status | safe_wal_size ------------+--------------- reserved | 1078987728 (1 row) wal_statusï¼šè¡¨ç¤ºè©² Slot æ‰€éœ€çš„ WAL ç‹€æ…‹ reservedï¼šåœ¨ max_wal_size ä¹‹å…§ã€‚ extendedï¼šè¶…å‡ºäº† max_wal_sizeï¼Œä½†ä»åœ¨ wal_keep_size æˆ– max_slot_wal_keep_size çš„ä¿è­·ç¯„åœå…§ã€‚ unreservedï¼šè¡¨ç¤º WAL å·²ç¶“ä¸åœ¨ä¿è­·ç¯„åœå…§ï¼Œé€™æ˜¯ä¸€å€‹è‡¨æ™‚ç‹€æ…‹ï¼Œéš¨å¾Œå¯èƒ½è®Šæˆ extended æˆ– lostã€‚ lostï¼šä»£è¡¨ WAL å·²è¢«åˆªé™¤ã€‚ safe_wal_sizeï¼šåªæœ‰è¨­ç½® max_slot_wal_keep_size æ‰æœƒå‡ºç¾ï¼Œè¡¨ç¤ºé‚„èƒ½å¯«å…¥å¤šå°‘ WAL å¤§å°æ‰ä¸æœƒè¶…é max_slot_wal_keep_size ã€‚ç•¶æ­¤å€¼ â‰¤ 0 æ™‚ï¼Œä¸€æ—¦è§¸ç™¼ checkpoint å°±æœƒç™¼ç”Ÿ wal_status = lost çš„ç‹€æ³ã€‚ åŠŸç”¨ - æ”¹å–„ Master çš„ vacuum éæ—©æ¸…é™¤ Slave æ‰€éœ€çš„ç´€éŒ„ ç•¶åœ¨ Master ä½¿ç”¨ vacuum æŒ‡ä»¤æˆ–è€…è§¸ç™¼ auto vacuum æ™‚ï¼Œå¦‚æœæ­¤æ“ä½œåœ¨ Slave å›æ”¾æ™‚æ°å·§æ­£åœ¨é€²è¡Œç›¸é—œè¡¨çš„æŸ¥è©¢æ™‚ï¼Œæœƒæª¢æ¸¬å‡º vacuum è¦æ¸…ç†çš„å…ƒçµ„ (tuple) ä»è¢«ä½¿ç”¨ä¸­ï¼Œå› æ­¤ä¸èƒ½åœ¨ Slave ä¸­ç«‹åˆ»æ¸…é™¤æœƒåœ¨ç­‰å¾… max_standby_streaming_delay (é»˜èªç‚º 30 ç§’) ä¹‹å¾Œçµ‚æ­¢è©²æŸ¥è©¢æ“ä½œï¼Œä¸¦è¿”å›ä»¥ä¸‹éŒ¯èª¤å¾Œé€²è¡Œ vacuumï¼š\n1 2 ERROR: canceling statement due to conflict with recovery Detail: User query might have needed to see row versions that must be removed åœ¨æ²’æœ‰ä½¿ç”¨ Replication Slot æ™‚ï¼Œå¯ä»¥é€éä»¥ä¸‹ 2 å€‹åƒæ•¸èª¿æ•´ï¼š\nåœ¨ Master ä¸Šè¨­ç½® vacuum_defer_cleanup_age (integer)ï¼šæŒ‡å®š vacuum å’Œ Hot updates å°‡å»¶é²å¤šå°‘ transaction ä¹‹å‰çš„ dead tuple å°‡ä¸é€²è¡Œåˆªé™¤ã€‚\né»˜èªå€¼ç‚º 0ï¼Œè¡¨ç¤ºå¯ä»¥ç›¡å¿«åˆªé™¤ dead tupleã€‚\nå•é¡Œï¼šèª¿å¤§æ­¤å€¼é›–ç„¶å¯ä»¥å¤šä¿ç•™ N å€‹ Transaction ä¹‹å‰çš„ dead tupleï¼Œä½†é€™æ˜¯æ ¹æ“š Master ä¸Šçš„ Transaction ç‹€æ³æ±ºå®šï¼Œå¯¦éš›ä¸Šå¾ˆé›£é æ¸¬ sLAVE éœ€è¦å¤šå°‘é¡å¤–çš„å¯¬é™æ™‚é–“ï¼Œå› æ­¤ä¸å¤ªå¯¦ç”¨ã€‚\nåœ¨ Slave ä¸Šè¨­ç½® hot_standby_feedback (boolean)ï¼šç•¶è¨­ç½®ç‚º ONï¼Œè¡¨ç¤º Slave æœƒé€šçŸ¥ Master è‡ªå·±ç›®å‰çš„æœ€å°æ´»èºäº‹å‹™id (xmin) å€¼ï¼Œé€™æ¨£ Master åœ¨åŸ·è¡Œ vacuum æ“ä½œæ™‚æœƒæš«æ™‚ä¸æ¸…é™¤å¤§æ–¼è©² xmin çš„ dead tupleã€‚\nå•é¡Œï¼šç•¶æ²’æœ‰ Slot æ™‚ï¼Œåœ¨ Slave æœªé€£çµçš„ä»»ä½•æ™‚é–“æ®µéƒ½ä¸æä¾›ä¿è­·ã€‚\nç•¶æœ‰ Replication Slot å’Œ hot_standby_feedback åƒæ•¸é…åˆæ™‚ï¼Œslot æœƒä¿æŒç´€éŒ„æœ€å¾Œå›å‚³çš„ xmin ä¿è­· dead tupleã€‚\nä¸éç†æ‰€ç•¶ç„¶çš„äº‹æƒ…æœ‰ä¸€é«”å…©é¢ï¼Œå¦‚æœ Slave ä¸Šè©²æŸ¥è©¢é‹è¡Œéä¹…ï¼ŒMaster ä¸Šå¯èƒ½æœƒç™¼ç”Ÿæ›´åš´é‡çš„è¡¨è†¨è„¹å•é¡Œã€‚\nä½¿ç”¨ Physical Replication slot æª¢æŸ¥ Source çš„è¨­å®š\n1 2 3 4 5 6 7 listen_addresses = \u0026#39;*\u0026#39; # ä»¥ä¸‹çš†ç‚ºé è¨­å€¼ hot_standby = ON wal_level = replica max_wal_senders = 10 max_replication_slots = 10 åœ¨ Sourrce ä¸Šå»ºç«‹ replication slot\n1 2 3 4 5 6 7 8 9 10 postgres=# SELECT * FROM pg_create_physical_replication_slot(\u0026#39;node_a_slot\u0026#39;); slot_name | lsn -------------+----- node_a_slot | postgres=# SELECT slot_name, slot_type, active FROM pg_replication_slots; slot_name | slot_type | active -------------+-----------+-------- node_a_slot | physical | f (1 row) ä¿®æ”¹ Replica ä¸Šçš„è¨­å®š\n1 2 primary_conninfo = \u0026#39;user=repl port=5432 host=172.17.0.2 application_name=replica\u0026#39; primary_slot_name = \u0026#39;node_a_slot\u0026#39; å°ç¯€ æˆ‘èªç‚ºæ‡‰è©²ä½¿ç”¨ replication slot\nLogical Replication (é‚è¼¯è¤‡è£½) PG 15(14) é™åˆ¶ åƒ…æœƒåŒæ­¥ table (åŒ…å« partitioned table)ï¼Œä¸æ”¯æŒ views, materialized views, or foreign tablesã€‚ ä¸æœƒè¤‡è£½ schema åŠ DDL å‘½ä»¤ã€‚ ä¸è¤‡è£½ sequence data ä¸æ”¯æŒ Large objectsã€‚ å»ºç½®ç¯„ä¾‹ èª¿æ•´ Masterã€Slave çš„è¨­å®šï¼Œå…¶ä¸­ wal_level å¿…é ˆèª¿æ•´ç‚º logical\n1 wal_level = logical åœ¨ Master å»ºç«‹ä¸€å€‹ç”¨æ–¼ Logical Replication çš„ roleï¼š\n1 2 3 4 5 create user logic_repl with replication; # é‚„å¿…é ˆæä¾› usage schemaã€select table çš„æ¬Šé™ grant usage on SCHEMA test_schema to logic_repl; grant select on test_schema.test_table to logic_repl è¨­ç½® Master pg_hba.confï¼Œæ³¨æ„é€™é‚Šå’Œç‰©ç†è¤‡è£½ä¸ä¸€æ¨£ï¼Œdatabase å¿…é ˆæä¾›ç›¸æ‡‰çš„ tableï¼š\n1 2 # TYPE DATABASE USER ADDRESS METHOD host test logic_repl 172.17.0.3/16 trust åœ¨ Master ä¸Šå»ºç«‹ PUBLICATIONï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [postgres @ test] [local]:5432] 07:57:41 \u0026gt; \\dRp List of publications Name | Owner | All tables | Inserts | Updates | Deletes | Truncates | Via root ------+-------+------------+---------+---------+---------+-----------+---------- (0 rows) [postgres @ test] [local]:5432] 07:57:59 \u0026gt; CREATE PUBLICATION repltest FOR TABLE test_schema.test_table; [postgres @ test] [local]:5432] 08:00:43 \u0026gt; \\dRp List of publications Name | Owner | All tables | Inserts | Updates | Deletes | Truncates | Via root --------+----------+------------+---------+---------+---------+-----------+---------- mytest | postgres | f | t | t | t | t | f (1 row) åœ¨ Slave ä¸Šå»ºç«‹ SUBSCRIPTION\n1 2 3 4 5 6 7 8 9 10 11 12 13 [postgres @ test] [local]:5432] 08:00:22 \u0026gt; \\dRs List of subscriptions Name | Owner | Enabled | Publication ------+-------+---------+------------- (0 rows) [postgres @ test] [local]:5432] 08:02:30 \u0026gt; CREATE SUBSCRIPTION mysub CONNECTION \u0026#39;dbname=test host=172.17.0.2 user=logic_repl\u0026#39; PUBLICATION repltest WITH (copy_data = false); [postgres @ test] [local]:5432] 08:45:07 \u0026gt; \\dRs List of subscriptions Name | Owner | Enabled | Publication -------+----------+---------+------------- mysub | postgres | t | {mytest} åƒè€ƒ PostgreSQL: Documentation: 15: ChapterÂ 27.Â High Availability, Load Balancing, and Replication\nPostgreSQL: Documentation: 15: ChapterÂ 31.Â Logical Replication\nPostgreSQL: Documentation: 15: 20.6.Â Replication\nPgSQL Â· ç‰¹æ€§åˆ†æ Â· PGä¸»å¤‡æµå¤åˆ¶æœºåˆ¶ (taobao.org)\nPgSQL Â· å†…æ ¸è§£æ Â· åŒæ­¥æµå¤åˆ¶å®ç°åˆ†æ (taobao.org)\nPostgreSQL 9.6 åŒæ­¥å¤šå‰¯æœ¬ ä¸ remote_applyäº‹åŠ¡åŒæ­¥çº§åˆ«\nä¸€æ–‡å½»åº•å¼„æ‡‚PostgreSQLæµå¤åˆ¶(å…¨ç½‘æœ€è¯¦ç»†)_pgæµå¤åˆ¶_foucusã€çš„åšå®¢-CSDNåšå®¢\nPgSQL Â· ç‰¹æ€§åˆ†æÂ· Replication Slot (taobao.org)\npostgresql-14æµå¤åˆ¶éƒ¨ç½²æ‰‹å†Œ_HistSpeedçš„åšå®¢-CSDNåšå®¢\nSetup PostgreSQL 14 Streaming Replication | Girders: the blog of Allen Fair\næˆ‘æ˜¯ä¸€ä¸ªæ’æ§½ï¼Œä»Šå¤©æˆ‘åšæ‰äº†æ•°æ®åº“ - çŸ¥ä¹ (zhihu.com)\nPGå¤åˆ¶çŠ¶æ€ç›‘æ§_wal_status reserved_ä¸‰æ€å‘ä¸‰æ€çš„åšå®¢-CSDNåšå®¢\nItâ€™s All About Replication Lag in PostgreSQL (percona.com)\n","date":"2020-02-19T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/postgre-replication/","title":"PostgreSQL Replication"},{"content":"pg_hba.conf hba è¡¨ç¤º host-based authenticationï¼Œè©²è¨­å®šæª”ç”¨ä¾†\nTYPEï¼šé€£ç·šæ–¹å¼ localï¼šä½¿ç”¨ unix domain socket é€£ç·šã€‚ hostï¼šä½¿ç”¨ TCP/IP é€£ç·šï¼Œä¸è«–æ˜¯å¦æœ‰ SSL åŠ å¯†ã€‚ hostsslï¼šåƒ…é™æ–¼ä½¿ç”¨ SSL åŠ å¯†çš„ TCP/IP é€£ç·šã€‚ hostnosslï¼šåƒ…é™æ–¼ä¸ä½¿ç”¨ SSL åŠ å¯†çš„ TCP/IP é€£ç·šã€‚ DATABASEï¼šæŒ‡å®šé€£ç·šçš„ DATABASE åç¨±ï¼Œå¤šå€‹åç¨±å¯ç”¨ , åˆ†éš”ã€‚ allï¼šè¡¨ç¤ºæ‰€æœ‰ databaseã€‚ sameuserï¼šè¡¨ç¤º database åç¨±å’Œ user åç¨±ç›¸åŒã€‚ sameroleï¼šè¡¨ç¤º database åç¨±å’Œ user æ‰€åœ¨çš„ role ç›¸åŒã€‚ replicationï¼šè¡¨ç¤ºç‚ºè«‹æ±‚ physical replicationã€‚ USERï¼šè¡¨ç¤ºæ­¤è¨­å®šé‡å°çš„ USER åç¨±ï¼Œå¤šå€‹åç¨±å¯ç”¨ , åˆ†éš”ã€‚ allï¼šè¡¨ç¤ºæ‰€æœ‰ user éƒ½é©ç”¨ã€‚ ADDRESSï¼šè¡¨ç¤º client ç«¯æ©Ÿå™¨ addressã€‚ METHODï¼šè¡¨ç¤ºé©—è­‰æ–¹å¼ã€‚ trustï¼šç„¡æ¢ä»¶å…è¨±ï¼Œä¸éœ€è¦ä»»ä½•é©—è­‰ã€‚ rejectï¼šç„¡æ¢ä»¶æ‹’çµ•ã€‚ scram-sha-256ï¼šä½¿ç”¨ scram-sha-256 èº«åˆ†é©—è­‰ï¼Œæ­¤ç‚ºç›®å‰æä¾›æœ€å®‰å…¨çš„å¯†ç¢¼é©—è­‰æ–¹æ³•ã€‚ md5ï¼šä½¿ç”¨ scram-sha-256 æˆ– MD5 èº«åˆ†é©—è­‰ï¼ŒMD5 ä¸¦ä¸å®‰å…¨ã€‚ passwordï¼šè¦æ±‚ client ç«¯æä¾›æœªåŠ å¯†çš„å¯†ç¢¼é€²è¡Œèº«åˆ†é©—è­‰ï¼Œé™¤éä½¿ç”¨ SSL åŠ å¯†é€£ç·šå¦å‰‡é€™æ¨£æ˜¯ä¸å®‰å…¨çš„ã€‚ gssï¼šä½¿ç”¨ GSSAPI ä¾†èº«åˆ†é©—è­‰ï¼Œåƒ…æ”¯æ´ TCP/IP é€£ç·šæ–¹å¼ã€‚ sspiï¼šä½¿ç”¨ SSPI ä¾†èº«åˆ†é©—è­‰ï¼Œåƒ…æ”¯æ´ windowsã€‚ 1 2 3 4 5 6 7 8 # TYPE DATABASE USER ADDRESS METHOD local database user auth-method [auth-options] host database user address auth-method [auth-options] hostssl database user address auth-method [auth-options] hostnossl database user address auth-method [auth-options] host database user IP-address IP-mask auth-method [auth-options] hostssl database user IP-address IP-mask auth-method [auth-options] hostnossl database user IP-address IP-mask auth-method [auth-options] åƒè€ƒ ã€èµµæ¸å¼ºè€å¸ˆã€‘å²ä¸Šæœ€è¯¦ç»†çš„PostgreSQLä½“ç³»æ¶æ„ä»‹ç» - çŸ¥ä¹ (zhihu.com)\nPostgreSQLæ•°æ®ç›®å½•ç»“æ„ - ç®€ä¹¦ (jianshu.com)\n","date":"2020-02-17T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/postgre-file-storage/","title":"PostgreSQL å¯¦é«”æª”æ¡ˆå„²å­˜"},{"content":"ç™¼ç¾ PG ä¸­æœ‰ä¸€å€‹ SCHEMA çš„å±¤ç´šé€™åœ¨ MySQL ä¸­æ˜¯æ²’æœ‰çš„ã€‚\nèˆ‡ MySQL é¡æ¯” åœ¨ MySQL ä¸­åˆ†ç‚ºä¸‰å€‹å±¤ç´š Instance â†’ DATABASE â†’ TABLEï¼Œåœ¨ MySQL ä¸­åŒä¸€å€‹ Instance åº•ä¸‹çš„ä»»æ„ Database å¯ä»¥å­˜å–å…¶ä»– database çš„ tableã€‚\nåœ¨ PG ä¸­åˆ†ç‚ºå››å€‹å±¤ç´š Instance â†’ DATABASE â†’ SCHEMA â†’ TABLEï¼Œåœ¨ PG ä¸­ä¸åŒ Database ä¹‹é–“æ˜¯ä¸èƒ½å­˜å–å°æ–¹ Table çš„ï¼Œä¹Ÿå°±æ˜¯èªªæ˜¯ç¨ç«‹çš„ã€‚\nä»¥æ­¤é¡æ¯”çš„æƒ…æ³ä¸‹ï¼ŒPG çš„ SCHEMA æœƒæ¯”è¼ƒæ¥è¿‘ MySQL çš„ Databaseï¼Œè€Œ PG çš„ Database æœƒæ¯”è¼ƒæ¥è¿‘ Instance çš„éš”é›¢å±¤ç´šã€‚\nç´°èªª æ¯ä¸€å€‹ Database å»ºç«‹å¾Œæœƒæœ‰ä»¥ä¸‹ 3 å€‹ schemaï¼š\npg_catalogï¼šç”¨æ–¼å„²å­˜ pg ç³»çµ±è‡ªå¸¶çš„å„ç¨® metadataã€‚ information_schemaï¼šç”¨æ–¼å„²å­˜æä¾›æŸ¥è©¢ metadata çš„æŸ¥è©¢ viewï¼Œä¸»è¦æ˜¯ç‚ºäº†ç¬¦åˆ SQL æ¨™æº–ã€‚æ­¤ schema å¯ä»¥å–®ç¨åˆªé™¤ (ä½†ä¸å»ºè­°)ã€‚ publicï¼šç”¨æ–¼å„²å­˜ä½¿ç”¨è€…å‰µå»ºçš„ tableï¼Œä½†ä¸€èˆ¬åŸºæ–¼å®‰å…¨æ€§ã€ç®¡ç†æ€§ä¸å»ºè­°ä½¿ç”¨ã€‚ åƒè€ƒ postgresql - cross-database references are not implemented: - Stack Overflow\ndatabase - What is the MySQL equivalent of a PostgreSQL \u0026lsquo;schema\u0026rsquo;? - Stack Overflow\nåœ¨æ•°æ®åº“ä¸­ï¼Œschemaã€catalogåˆ†åˆ«æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ - çŸ¥ä¹ (zhihu.com)\npostgresqlçš„databaseå’Œschemaçš„ç†è§£_Chsavvyçš„åšå®¢-CSDNåšå®¢\nPostgreSQLæ•™ç¨‹\u0026ndash;é€»è¾‘ç»“æ„ï¼šå®ä¾‹ã€æ•°æ®åº“ã€schemaã€è¡¨ä¹‹é—´çš„å…³ç³»_postgreé€»è¾‘ç»“æ„_javaç¼–ç¨‹è‰ºæœ¯çš„åšå®¢-CSDNåšå®¢\npostgresql - Difference between information_schema.tables and pg_tables - Stack Overflow\n","date":"2020-02-13T12:00:00+08:00","permalink":"https://FuweaY.github.io/p/postgre-schema/","title":"PostgreSQL schema"}]