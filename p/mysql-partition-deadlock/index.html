<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="測試總結當 update partition 欄位時引發的 deadlock"><title>partition deadlock</title>
<link rel=canonical href=https://FuweaY.github.io/p/mysql-partition-deadlock/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="partition deadlock"><meta property='og:description' content="測試總結當 update partition 欄位時引發的 deadlock"><meta property='og:url' content='https://FuweaY.github.io/p/mysql-partition-deadlock/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='deadlock'><meta property='article:tag' content='內核'><meta property='article:published_time' content='2022-11-28T12:00:00+08:00'><meta property='article:modified_time' content='2022-11-28T12:00:00+08:00'><meta name=twitter:title content="partition deadlock"><meta name=twitter:description content="測試總結當 update partition 欄位時引發的 deadlock"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐱</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>熱愛分享的 DBA 小天地</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>夜晚模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#重現>重現</a></li><li><a href=#deadlock-分析>DeadLock 分析</a></li><li><a href=#實驗>實驗</a><ol><li><a href=#沒有-partition-的測試>沒有 partition 的測試</a><ol><li><a href=#單獨一個-update-操作的-lock-測試>單獨一個 update 操作的 Lock 測試</a></li><li><a href=#複數-update-操作的-lock-測試>複數 update 操作的 Lock 測試</a></li></ol></li><li><a href=#有-partition-的測試>有 partition 的測試</a><ol><li><a href=#單獨一個-update--非-partition-key操作的-lock-測試>單獨一個 update 非 partition key操作的 Lock 測試</a></li><li><a href=#複數-update-非-partition-key-操作的-lock-測試>複數 update 非 partition key 操作的 Lock 測試</a></li><li><a href=#單獨一個-update-partition-key-操作的-lock-測試>單獨一個 update partition key 操作的 Lock 測試</a></li><li><a href=#複數-update-partition-key--操作的-lock-測試>複數 update partition key 操作的 Lock 測試</a></li><li><a href=#複數-update-partition-key--操作但不變動-partition-key-的-lock-測試>複數 update partition key 操作，但不變動 partition key 的 Lock 測試</a></li></ol></li></ol></li><li><a href=#結論>結論</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mysql/>MySQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/mysql-partition-deadlock/>partition deadlock</a></h2><h3 class=article-subtitle>測試總結當 update partition 欄位時引發的 deadlock</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 28, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>閱讀時間: 24 分鐘</time></div></footer></div></header><section class=article-content><h2 id=重現>重現</h2><ul><li><p>事前準備 (schema、初始資料)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;訂單號&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;交易代碼&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;結算時間&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>create_time</span><span class=o>`</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;建立時間&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>CHARSET</span><span class=o>=</span><span class=n>utf8mb4</span><span class=w> </span><span class=k>COLLATE</span><span class=o>=</span><span class=n>utf8mb4_0900_ai_ci</span><span class=w> </span><span class=k>COMMENT</span><span class=o>=</span><span class=s1>&#39;局號關聯的交易單號&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*!50100 PARTITION BY RANGE (unix_timestamp(`end_time`))
</span></span></span><span class=line><span class=cl><span class=cm>(PARTITION PHISTORY VALUES LESS THAN (1654056000) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202206 VALUES LESS THAN (1656648000) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202207 VALUES LESS THAN (1659326400) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202208 VALUES LESS THAN (1662004800) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202209 VALUES LESS THAN (1664596800) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202210 VALUES LESS THAN (1667275200) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202211 VALUES LESS THAN (1669867200) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202212 VALUES LESS THAN (1672545600) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202301 VALUES LESS THAN (1675224000) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202302 VALUES LESS THAN (1677643200) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202303 VALUES LESS THAN (1680321600) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202304 VALUES LESS THAN (1682913600) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202305 VALUES LESS THAN (1685592000) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION P202306 VALUES LESS THAN (1688184000) ENGINE = InnoDB,
</span></span></span><span class=line><span class=cl><span class=cm> PARTITION POTHER VALUES LESS THAN MAXVALUE ENGINE = InnoDB) */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>round_to_txn</span><span class=p>(</span><span class=n>round_id</span><span class=p>,</span><span class=w> </span><span class=n>txn_id</span><span class=p>,</span><span class=w> </span><span class=n>end_time</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;5&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039911eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;6&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;7&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039911eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;8&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039912eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;9&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039913eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039912eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;11&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039913eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;12&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039914eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;13&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039914eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;14&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039915eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;15&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039915eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;16&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039916eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;17&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039917eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;18&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039916eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;19&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039917eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;20&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039918eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;21&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039919eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;22&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039918eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;23&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039919eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;24&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039920eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;25&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039920eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;26&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039921eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;27&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039909eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;4&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2022-11-01 00:10:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039909eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2022-11-01 00:10:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039908eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2022-10-01 00:10:00&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;039908eukXEC&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2022-10-01 00:10:00&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>模擬並行 update 資料的程式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbHost</span>         <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;10.17.117.203&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbPort</span>         <span class=kt>int</span>    <span class=p>=</span> <span class=mi>3331</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbUser</span>         <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;root&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbPassword</span>     <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;root&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbDatabase</span>     <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;test&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbMaxOpenConns</span> <span class=kt>int</span>    <span class=p>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbMaxIdleConns</span> <span class=kt>int</span>    <span class=p>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>	<span class=nx>dbMaxLifetime</span>  <span class=kt>int</span>    <span class=p>=</span> <span class=mi>3600</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>DB</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>initDB</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nx>dsn</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%s@tcp(%s:%d)/%s&#34;</span><span class=p>,</span> <span class=nx>dbUser</span><span class=p>,</span> <span class=nx>dbPassword</span><span class=p>,</span> <span class=nx>dbHost</span><span class=p>,</span> <span class=nx>dbPort</span><span class=p>,</span> <span class=nx>dbDatabase</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>DB</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=nx>dsn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>DB</span><span class=p>.</span><span class=nf>SetMaxOpenConns</span><span class=p>(</span><span class=nx>dbMaxOpenConns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>DB</span><span class=p>.</span><span class=nf>SetMaxIdleConns</span><span class=p>(</span><span class=nx>dbMaxIdleConns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>DB</span><span class=p>.</span><span class=nf>SetConnMaxLifetime</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>dbMaxLifetime</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;connection to mysql failed:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;connnect success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>txUpdateTest</span><span class=p>(</span><span class=nx>roundId</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>endTime</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>wg</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// begin transaction</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;begin fail: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// prepare</span>
</span></span><span class=line><span class=cl>	<span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ?&#34;</span><span class=p>)</span> <span class=c1>// 會 deadlock</span>
</span></span><span class=line><span class=cl>	<span class=c1>// stmt, err := tx.Prepare(&#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND `end_time` = &#39;0000-00-00 00:00:00&#39;&#34;) // 不會 deadlock</span>
</span></span><span class=line><span class=cl>	<span class=c1>// stmt, err := tx.Prepare(&#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND `end_time` &lt;= &#39;2022-10-31 23:59:59&#39;&#34;) // 不會 deadlock</span>
</span></span><span class=line><span class=cl>	<span class=c1>//stmt, err := tx.Prepare(&#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND (`end_time` &lt;= &#39;2022-10-31 23:59:59&#39; OR `end_time` &gt;= &#39;2022-12-01 00:00:00&#39; )&#34;) // 不會 deadlock</span>
</span></span><span class=line><span class=cl>	<span class=c1>// stmt, err := tx.Prepare(&#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ? AND (`end_time` &lt;= &#39;2022-11-10 23:59:59&#39;)&#34;) // 會 deadlock</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;prepare fail: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// exec</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>endTime</span><span class=p>,</span> <span class=nx>roundId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Exec fail: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// commit</span>
</span></span><span class=line><span class=cl>	<span class=nx>tx</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>updateTest</span><span class=p>(</span><span class=nx>roundId</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>endTime</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;UPDATE `round_to_txn` SET `end_time` = ? WHERE `round_id` = ?&#34;</span><span class=p>,</span> <span class=nx>endTime</span><span class=p>,</span> <span class=nx>roundId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;update fail:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>initDB</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>DB</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>sqlValue</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>roundId</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=nx>endTime</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>initValue</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>sqlValue</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>21</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>initValue</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>initValue</span><span class=p>,</span> <span class=nx>sqlValue</span><span class=p>{</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;0399%deukXEC&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>),</span> <span class=s>&#34;0000-00-00 00:00:00&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>initValue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>updateTest</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>roundId</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>endTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>testValue</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>sqlValue</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>21</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>testValue</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>testValue</span><span class=p>,</span> <span class=nx>sqlValue</span><span class=p>{</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;0399%deukXEC&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>),</span> <span class=s>&#34;2022-11-16 08:53:08&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>testValue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nf>txUpdateTest</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>roundId</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>endTime</span><span class=p>,</span> <span class=nx>wg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p>測試結果如下表：</p><div class=table-wrapper><table><thead><tr><th>語法：UPDATE <code>round_to_txn</code> SET <code>end_time</code> = &ldquo;2022-11-16 08:53:08” WHERE …</th><th>是否有 deadlock</th></tr></thead><tbody><tr><td><code>round_id</code> = ?</td><td>Yes</td></tr><tr><td><code>round_id</code> = ? AND <code>end_time</code> = ‘0000-00-00 00:00:00’</td><td>No</td></tr><tr><td><code>round_id</code> = ? AND <code>end_time</code> &lt;= &lsquo;2022-10-31 23:59:59&rsquo;</td><td>No</td></tr><tr><td><code>round_id</code> = ? AND <code>end_time</code> &lt;= &lsquo;2022-11-10 23:59:59&rsquo;</td><td>No</td></tr><tr><td><code>round_id</code> = ? AND (<code>end_time</code> &lt;= &lsquo;2022-10-31 23:59:59&rsquo; OR <code>end_time</code> >= &lsquo;2022-12-01 00:00:00&rsquo; )</td><td>Yes</td></tr></tbody></table></div><h2 id=deadlock-分析>DeadLock 分析</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=o>----------------------</span><span class=c1>--
</span></span></span><span class=line><span class=cl><span class=c1>LATEST DETECTED DEADLOCK
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>----------------------</span><span class=c1>--
</span></span></span><span class=line><span class=cl><span class=c1>2022-11-18 09:00:57 140176279025408
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>***</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>TRANSACTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>TRANSACTION</span><span class=w> </span><span class=mi>4914</span><span class=p>,</span><span class=w> </span><span class=n>ACTIVE</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>sec</span><span class=w> </span><span class=n>inserting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=w> </span><span class=kp>tables</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LOCK</span><span class=w> </span><span class=n>WAIT</span><span class=w> </span><span class=mi>32</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=nf>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>18</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>9140</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176259069696</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>21183</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>17</span><span class=p>.</span><span class=mi>117</span><span class=p>.</span><span class=mi>103</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>updating</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=kt>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039912eukXEC&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>HOLDS</span><span class=w> </span><span class=n>THE</span><span class=w> </span><span class=k>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>74</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=n>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>4914</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>WAITING</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>BE</span><span class=w> </span><span class=n>GRANTED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>74</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=n>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>4914</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=n>intention</span><span class=w> </span><span class=n>waiting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=n>TRANSACTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>TRANSACTION</span><span class=w> </span><span class=mi>4923</span><span class=p>,</span><span class=w> </span><span class=n>ACTIVE</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>sec</span><span class=w> </span><span class=n>inserting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=w> </span><span class=kp>tables</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LOCK</span><span class=w> </span><span class=n>WAIT</span><span class=w> </span><span class=mi>32</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=nf>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>18</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>9142</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176262240000</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>21200</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>17</span><span class=p>.</span><span class=mi>117</span><span class=p>.</span><span class=mi>103</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>updating</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=kt>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039915eukXEC&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=n>HOLDS</span><span class=w> </span><span class=n>THE</span><span class=w> </span><span class=k>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>74</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=n>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>4923</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=n>WAITING</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>BE</span><span class=w> </span><span class=n>GRANTED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>74</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=n>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>4923</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=n>intention</span><span class=w> </span><span class=n>waiting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***</span><span class=w> </span><span class=n>WE</span><span class=w> </span><span class=n>ROLL</span><span class=w> </span><span class=n>BACK</span><span class=w> </span><span class=nf>TRANSACTION</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>看一下上方的 log 可以看到 deadlock 的原因是兩者都有 GAP LOCK，而 GAP LOCK 本身互相不衝突，但是都會阻塞 INSERT 操作來達到 RR 級別的可重複讀，就在這時候 2 個 Transaction 同時又要求 Insert Intention Locks，這就導致雙方都在等待對方釋放 GAP LOCK，因此發生了 DEADLOCK。</p><p>但是問題來了，這兩個 Transaction 都是 <code>UPDATE</code> 操作，為什麼會有 <code>INSERT</code> 操作才有的 Insert Intention Locks 呢?</p><h2 id=實驗>實驗</h2><h3 id=沒有-partition-的測試>沒有 partition 的測試</h3><p>我們建立一個 schema 相同，但是沒有 partition 的 table 測試</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>nop_test</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>Table</span><span class=p>:</span><span class=w> </span><span class=n>nop_test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Create</span><span class=w> </span><span class=k>Table</span><span class=p>:</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;訂單號&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;交易代碼&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s1>&#39;0000-00-00 00:00:00&#39;</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;結算時間&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>create_time</span><span class=o>`</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;建立時間&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;最新更新時間&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>CHARSET</span><span class=o>=</span><span class=n>utf8mb4</span><span class=w> </span><span class=k>COLLATE</span><span class=o>=</span><span class=n>utf8mb4_0900_ai_ci</span><span class=w> </span><span class=k>COMMENT</span><span class=o>=</span><span class=s1>&#39;局號關聯的交易單號&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=單獨一個-update-操作的-lock-測試>單獨一個 update 操作的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=n>nop_test</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>end_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>round_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>6502</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6502</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6502</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>STATUS</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 6502, ACTIVE 18 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>3</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>1128</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17233</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176258012928</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>39405</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>starting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>STATUS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6502</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=k>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>115</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>96</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6502</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Record</span><span class=w> </span><span class=k>lock</span><span class=p>,</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>PHYSICAL</span><span class=w> </span><span class=n>RECORD</span><span class=p>:</span><span class=w> </span><span class=n>n_fields</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w> </span><span class=n>compact</span><span class=w> </span><span class=n>format</span><span class=p>;</span><span class=w> </span><span class=n>info</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>12</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>30333939313065756</span><span class=n>b584543</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=mi>039910</span><span class=n>eukXEC</span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>1</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>30</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>352020202020202020202020202020202020202020202020202020202020</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=mi>5</span><span class=w>                             </span><span class=p>;</span><span class=w> </span><span class=p>(</span><span class=n>total</span><span class=w> </span><span class=mi>50</span><span class=w> </span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>2</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>00000000</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>     </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>3</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>000000001966</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>      </span><span class=n>f</span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>4</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>020000011</span><span class=n>e1518</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>        </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>5</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>637</span><span class=n>ae7b8</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>cz</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>6</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>637</span><span class=n>ae7b8</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>cz</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Record</span><span class=w> </span><span class=k>lock</span><span class=p>,</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=n>PHYSICAL</span><span class=w> </span><span class=n>RECORD</span><span class=p>:</span><span class=w> </span><span class=n>n_fields</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w> </span><span class=n>compact</span><span class=w> </span><span class=n>format</span><span class=p>;</span><span class=w> </span><span class=n>info</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>12</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>30333939313065756</span><span class=n>b584543</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=mi>039910</span><span class=n>eukXEC</span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>1</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>30</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>372020202020202020202020202020202020202020202020202020202020</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=mi>7</span><span class=w>                             </span><span class=p>;</span><span class=w> </span><span class=p>(</span><span class=n>total</span><span class=w> </span><span class=mi>50</span><span class=w> </span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>2</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>637</span><span class=n>ae7c9</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>cz</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>3</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>000000001966</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>      </span><span class=n>f</span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>4</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>8200000105015</span><span class=n>d</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>       </span><span class=p>];;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>5</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>637</span><span class=n>ae7b8</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>cz</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>6</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>637</span><span class=n>ae7c9</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>cz</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到如果在沒有 partition 的 table 上進行 update 操作會有以下 LOCK：</p><ul><li>該 Table 的 IX</li><li>因為是透過 PK 來掃描，因此在 PK 上命中的行加上 Record Lock</li><li>因為條件沒有覆蓋 PK 條件，因此在符合的位置加上 Gap Lock 避免被 INSERT</li></ul><h4 id=複數-update-操作的-lock-測試>複數 update 操作的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Transaction 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=n>p_test</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>end_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>round_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Transaction 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=n>p_test</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>end_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>round_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>6545</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6545</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6545</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6544</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6544</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6544</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nop_test</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 6545, ACTIVE 21 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>3</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>1128</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17290</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140175996847872</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>39805</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6545</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=k>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>115</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>96</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6545</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=k>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>115</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>96</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6545</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 6544, ACTIVE 32 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>3</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>1128</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17233</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176258012928</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>39809</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>starting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6544</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=k>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>115</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>96</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6544</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=k>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>115</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>96</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>nop_test</span><span class=o>`</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6544</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到當有 2 句 update 操作時其實 LOCK 情況並沒有分別，且因為兩者 Record Lock 不衝突，且 Gap Lock 互相不阻塞，因此兩者都能成功 UPDATE。</p><h3 id=有-partition-的測試>有 partition 的測試</h3><h4 id=單獨一個-update--非-partition-key操作的-lock-測試>單獨一個 update 非 partition key操作的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>update</span><span class=w> </span><span class=n>p_test</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>update_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>round_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>3</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>STATUS</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 7968, ACTIVE 34 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>31</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>17</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17290</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140175996847872</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>43462</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>starting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>STATUS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `pother` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202306` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202305` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202304` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202303` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202302` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202301` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202212` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202210` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>PRINTED</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=n>TRX</span><span class=p>:</span><span class=w> </span><span class=n>SUPPRESSING</span><span class=w> </span><span class=n>FURTHER</span><span class=w> </span><span class=n>PRINTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------
</span></span></span></code></pre></td></tr></table></div></div><p>看起來和 partition 的單獨 update 相同，只是因為有切 partition，所以需要對每個 Partition 加上 IX 。</p><h4 id=複數-update-非-partition-key-操作的-lock-測試>複數 update 非 partition key 操作的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Transaction 1 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039912eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Transaction 2 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039913eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>6</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 7969, ACTIVE 35 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>31</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>17</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17233</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176258012928</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>43468</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `pother` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202306` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202305` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202304` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202303` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202302` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202301` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202212` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202210` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7969</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>PRINTED</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=n>TRX</span><span class=p>:</span><span class=w> </span><span class=n>SUPPRESSING</span><span class=w> </span><span class=n>FURTHER</span><span class=w> </span><span class=n>PRINTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 7968, ACTIVE 108 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>31</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>17</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17290</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140175996847872</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>43472</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>starting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `pother` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202306` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202305` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202304` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202303` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202302` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202301` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202212` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202210` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7968</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>PRINTED</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=n>TRX</span><span class=p>:</span><span class=w> </span><span class=n>SUPPRESSING</span><span class=w> </span><span class=n>FURTHER</span><span class=w> </span><span class=n>PRINTS</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到和單獨執行一句 update 一樣，只有 Record Lock、Gap Lock 並沒有產生衝突</p><h4 id=單獨一個-update-partition-key-操作的-lock-測試>單獨一個 update partition key 操作的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>update</span><span class=w> </span><span class=n>p_test</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>end_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>round_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039910eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>p_test</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+-------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>3</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>STATUS</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 6228, ACTIVE 48 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>32</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>19</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17233</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176258012928</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>39374</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>starting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>STATUS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `pother` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202306` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202305` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202304` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202303` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202302` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202301` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202212` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>p_test</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202210` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>6228</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>PRINTED</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=n>TRX</span><span class=p>:</span><span class=w> </span><span class=n>SUPPRESSING</span><span class=w> </span><span class=n>FURTHER</span><span class=w> </span><span class=n>PRINTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------
</span></span></span></code></pre></td></tr></table></div></div><p>看起來和 partition 的單獨 update 相同，只是因為有切 partition，所以需要對每個 Partition 加上 IX 。</p><h4 id=複數-update-partition-key--操作的-lock-測試>複數 update partition key 操作的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Transaction 1 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039912eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Transaction 2 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039913eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Lock Wait ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+--------------+------------+-----------+------------------------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w>              </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+--------------+------------+-----------+------------------------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>                     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>                      </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>                  </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=p>,</span><span class=n>INSERT_INTENTION</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>WAITING</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>                     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>                      </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>                  </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+--------------+------------+-----------+------------------------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 7961, ACTIVE 20 sec inserting
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>use</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LOCK</span><span class=w> </span><span class=n>WAIT</span><span class=w> </span><span class=mi>32</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>18</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17290</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140175996847872</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>43421</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>updating</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2022-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039913eukXEC&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------- TRX HAS BEEN WAITING 20 SEC FOR THIS LOCK TO BE GRANTED:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RECORD</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=k>space</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>74</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=n>lock_mode</span><span class=w> </span><span class=n>X</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>gap</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>rec</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=n>intention</span><span class=w> </span><span class=n>waiting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Record</span><span class=w> </span><span class=k>lock</span><span class=p>,</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=n>PHYSICAL</span><span class=w> </span><span class=n>RECORD</span><span class=p>:</span><span class=w> </span><span class=n>n_fields</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w> </span><span class=n>compact</span><span class=w> </span><span class=n>format</span><span class=p>;</span><span class=w> </span><span class=n>info</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>12</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>30333939313865756</span><span class=n>b584543</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=mi>039918</span><span class=n>eukXEC</span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>1</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>30</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>323120202020202020202020202020202020202020202020202020202020</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=mi>21</span><span class=w>                            </span><span class=p>;</span><span class=w> </span><span class=p>(</span><span class=n>total</span><span class=w> </span><span class=mi>50</span><span class=w> </span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>2</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>6374</span><span class=n>a4f4</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>ct</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>3</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>000000001</span><span class=n>f09</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>       </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>4</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>82000000</span><span class=n>fc0110</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w>        </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>5</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>63760</span><span class=n>cc6</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=n>cv</span><span class=w>  </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=mi>6</span><span class=p>:</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>hex</span><span class=w> </span><span class=mi>637</span><span class=n>b2b14</span><span class=p>;</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=p>;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `pother` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202306` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202305` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202304` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202303` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202302` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202301` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202212` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202210` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7961</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>PRINTED</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=n>TRX</span><span class=p>:</span><span class=w> </span><span class=n>SUPPRESSING</span><span class=w> </span><span class=n>FURTHER</span><span class=w> </span><span class=n>PRINTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---TRANSACTION 7956, ACTIVE 27 sec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>31</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=n>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>size</span><span class=w> </span><span class=mi>3488</span><span class=p>,</span><span class=w> </span><span class=mi>19</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>undo</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MySQL</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>17233</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=mi>140176258012928</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>43425</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>starting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `pother` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202306` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202305` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202304` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202303` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202302` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202301` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202212` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202211` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TABLE</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=cm>/* Partition `p202210` */</span><span class=w> </span><span class=n>trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=mi>7956</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>mode</span><span class=w> </span><span class=n>IX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=n>LOCKS</span><span class=w> </span><span class=n>PRINTED</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>THIS</span><span class=w> </span><span class=n>TRX</span><span class=p>:</span><span class=w> </span><span class=n>SUPPRESSING</span><span class=w> </span><span class=n>FURTHER</span><span class=w> </span><span class=n>PRINTS</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>我們可以看到出現了 Insert Intention Locks，因為 Insert Intention Locks 是延遲加鎖機制，只有和 Gap Lock 發生衝突才加上來的，所以單獨執行沒發生衝突也看不到 Insert Intention Locks，同時我們也知道了當在</p><h4 id=複數-update-partition-key--操作但不變動-partition-key-的-lock-測試>複數 update partition key 操作，但不變動 partition key 的 Lock 測試</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Transaction 1 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2020-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039912eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Transaction 2 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>round_to_txn</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>end_time</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2020-11-16 08:53:08&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>round_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;039913eukXEC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>ENGINE_TRANSACTION_ID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TID</span><span class=p>,</span><span class=n>OBJECT_NAME</span><span class=p>,</span><span class=n>INDEX_NAME</span><span class=p>,</span><span class=n>LOCK_TYPE</span><span class=p>,</span><span class=n>LOCK_MODE</span><span class=p>,</span><span class=n>LOCK_STATUS</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>data_locks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+--------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>TID</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>OBJECT_NAME</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>INDEX_NAME</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_TYPE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_MODE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>LOCK_STATUS</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+--------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>8908</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>8908</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>8908</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>8907</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>TABLE</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>IX</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>8907</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=p>,</span><span class=n>GAP</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>8907</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>round_to_txn</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>RECORD</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>X</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>GRANTED</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>------+--------------+------------+-----------+-----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=mi>8913</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Purge</span><span class=w> </span><span class=n>done</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>trx</span><span class=s1>&#39;s n:o &lt; 8913 undo n:o &lt; 0 state: running but idle
</span></span></span><span class=line><span class=cl><span class=s1>History list length 2
</span></span></span><span class=line><span class=cl><span class=s1>LIST OF TRANSACTIONS FOR EACH SESSION:
</span></span></span><span class=line><span class=cl><span class=s1>---TRANSACTION 421651726690736, not started
</span></span></span><span class=line><span class=cl><span class=s1>0 lock struct(s), heap size 1128, 0 row lock(s)
</span></span></span><span class=line><span class=cl><span class=s1>---TRANSACTION 421651726689928, not started
</span></span></span><span class=line><span class=cl><span class=s1>0 lock struct(s), heap size 1128, 0 row lock(s)
</span></span></span><span class=line><span class=cl><span class=s1>---TRANSACTION 8908, ACTIVE 39 sec
</span></span></span><span class=line><span class=cl><span class=s1>31 lock struct(s), heap size 3488, 19 row lock(s), undo log entries 4
</span></span></span><span class=line><span class=cl><span class=s1>MySQL thread id 29087, OS thread handle 140175996847872, query id 66467 localhost root starting
</span></span></span><span class=line><span class=cl><span class=s1>show engine innodb status
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `pother` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202306` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202305` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202304` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202303` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202302` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202301` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202212` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202211` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202210` */ trx id 8908 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS
</span></span></span><span class=line><span class=cl><span class=s1>---TRANSACTION 8907, ACTIVE 50 sec
</span></span></span><span class=line><span class=cl><span class=s1>31 lock struct(s), heap size 3488, 19 row lock(s), undo log entries 4
</span></span></span><span class=line><span class=cl><span class=s1>MySQL thread id 29008, OS thread handle 140176595552000, query id 66460 localhost root
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `pother` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202306` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202305` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202304` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202303` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202302` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202301` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202212` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202211` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>TABLE LOCK table `test`.`round_to_txn` /* Partition `p202210` */ trx id 8907 lock mode IX
</span></span></span><span class=line><span class=cl><span class=s1>10 LOCKS PRINTED FOR THIS TRX: SUPPRESSING FURTHER PRINTS
</span></span></span></code></pre></td></tr></table></div></div><p>我們可以看到這一次沒有 Insert Intention Locks，這是因為 update 的值沒有導致資料需要被變更到別的 partition，所以加鎖的情況會等同於普通的 update 並不會產生 Insert Intention Locks 從而導致 DeadLock 的發生。</p><h2 id=結論>結論</h2><p>在有 partition 的 Table 上執行 UPDATE 操作更新 partition key 發生跨區時，會先由 <code>UPDATE</code> 操作產生 Record Lock (或 Next Key Lock 也就是包含 Gap Lock)，之後轉變成 <code>INSERT</code> 操作將資料塞入新的分區。</p><p><img src=/p/mysql-partition-deadlock/partition-deadlock.png width=834 height=248 srcset="/p/mysql-partition-deadlock/partition-deadlock_hu_78b43ec7bbbc68a7.png 480w, /p/mysql-partition-deadlock/partition-deadlock_hu_c4dd5dd87f8a8f66.png 1024w" loading=lazy alt="partition deadlock 成因" class=gallery-image data-flex-grow=336 data-flex-basis=807px></p><p>因此如果可以盡量避免去 UPDATE 有切 partition 的欄位。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/deadlock/>Deadlock</a>
<a href=/tags/%E5%85%A7%E6%A0%B8/>內核</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mysql-implicit-lock/><div class=article-details><h2 class=article-title>隱式鎖</h2></div></a></article><article><a href=/p/mysql-group-commit/><div class=article-details><h2 class=article-title>Group Commit</h2></div></a></article><article><a href=/p/mysql-semi-join-and-anti-join/><div class=article-details><h2 class=article-title>semi-join(半連結)和anti-join(反連結)</h2></div></a></article><article><a href=/p/mysql-exists-optimize/><div class=article-details><h2 class=article-title>MySQL8.0 EXISTS 及 NOT IN/EXISTS 優化</h2></div></a></article><article><a href=/p/mysql-mts/><div class=article-details><h2 class=article-title>並行複製 (Multi-Thread Slave, MTS)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//小小 DBA 個人筆記.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 建立<br>主題 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 設計</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>