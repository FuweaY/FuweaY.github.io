<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ä»‹ç´¹ MySQL GTID Replication"><title>GTID</title>
<link rel=canonical href=https://FuweaY.github.io/p/mysql-gtid/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="GTID"><meta property='og:description' content="ä»‹ç´¹ MySQL GTID Replication"><meta property='og:url' content='https://FuweaY.github.io/p/mysql-gtid/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Replication'><meta property='article:published_time' content='2025-03-27T12:00:00+08:00'><meta property='article:modified_time' content='2025-03-27T12:00:00+08:00'><meta name=twitter:title content="GTID"><meta name=twitter:description content="ä»‹ç´¹ MySQL GTID Replication"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ±</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>ç†±æ„›åˆ†äº«çš„ DBA å°å¤©åœ°</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#gtid-çµ„æˆ>GTID çµ„æˆ</a></li><li><a href=#gtid-life-cycle>GTID Life cycle</a></li><li><a href=#mysqlgtid_execute-è¡¨>mysql.gtid_execute è¡¨</a><ol><li><a href=#å£“ç¸®>å£“ç¸®</a></li></ol></li><li><a href=#ç³»çµ±è®Šé‡-gtid_executed-å’Œ-gtid_purged-çš„åˆå§‹åŒ–èˆ‡æ›´æ–°>ç³»çµ±è®Šé‡ gtid_executed å’Œ gtid_purged çš„åˆå§‹åŒ–èˆ‡æ›´æ–°</a><ol><li><a href=#åˆå§‹åŒ–>åˆå§‹åŒ–</a></li><li><a href=#æ›´æ–°>æ›´æ–°</a></li></ol></li><li><a href=#gtid-ç›¸é—œè®Šé‡>GTID ç›¸é—œè®Šé‡</a><ol><li><a href=#gtid_mode>gtid_mode</a></li><li><a href=#enforce_gtid_consistency>enforce_gtid_consistency</a></li><li><a href=#gtid_next>gtid_next</a></li><li><a href=#gtid_owned>gtid_owned</a></li><li><a href=#gtid_executed>gtid_executed</a></li><li><a href=#gtid_purged>gtid_purged</a></li><li><a href=#gtid_executed_compression_period>gtid_executed_compression_period</a></li><li><a href=#binlog_gtid_simple_recovery>binlog_gtid_simple_recovery</a></li></ol></li><li><a href=#gtid-é™åˆ¶>GTID é™åˆ¶</a></li><li><a href=#åœ¨ç·šé–‹å•Ÿ-gtid>åœ¨ç·šé–‹å•Ÿ GTID</a></li><li><a href=#gtid-ä¸­çš„ç¶­é‹>GTID ä¸­çš„ç¶­é‹</a><ol><li><a href=#show-slave-status>SHOW SLAVE STATUS</a></li><li><a href=#æ¸…é™¤-gtid-æ­·å²ç´€éŒ„>æ¸…é™¤ GTID æ­·å²ç´€éŒ„</a></li><li><a href=#è·³éä¸€å€‹-transaction>è·³éä¸€å€‹ Transaction</a></li><li><a href=#mysqldump-è¡Œç‚ºçš„è®ŠåŒ–>mysqldump è¡Œç‚ºçš„è®ŠåŒ–</a></li><li><a href=#replication-filter>Replication filter</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mysql/>MySQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/mysql-gtid/>GTID</a></h2><h3 class=article-subtitle>ä»‹ç´¹ MySQL GTID Replication</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 27, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 12 åˆ†é˜</time></div></footer></div></header><section class=article-content><p>GTID çš„å…¨åæ˜¯ Global Transaction identifier, MySQL æœƒç‚ºæ¯ä¸€å€‹ DML/DDL æ“ä½œéƒ½åˆ†é…ä¸€å€‹åœ¨æ•´å€‹ replicaion topology éƒ½å”¯ä¸€çš„ GTIDã€‚</p><p>åœ¨ replication ç’°å¢ƒä¸­ï¼Œmaster å¯ä»¥ç›´æ¥é€é GTID å®šä½ç™¼é€ binlog çµ¦ slave ä¸å†éœ€è¦æŒ‡å®š binlog åç¨±å’Œ postition åœ¨åŒæ­¥ä¸Šæ›´ç‚ºæ–¹ä¾¿ã€‚æ­¤å¤– Slave é‚„æœƒä¿ç•™å¾ Master åŒæ­¥éä¾†çš„ Transaction ç›¸åŒçš„ GTIDï¼Œä¸¦æŒä¹…åŒ–åˆ° mysql.gtid_executedï¼Œæ­é…ä¸Š GTID çš„è‡ªå‹•è·³éåŠŸèƒ½ï¼Œä¿è­‰äº†ç›¸åŒ GTID çš„ Transaction åœ¨åŒä¸€å€‹ instance ä¸­åªæœƒåŸ·è¡Œä¸€æ¬¡ï¼Œæ›´åŠ æœ‰åŠ©æ–¼ Replication çš„ä¸€è‡´æ€§ã€‚</p><h2 id=gtid-çµ„æˆ>GTID çµ„æˆ</h2><p>GTID çš„çµ„æˆç‚º source_id:transaction_idï¼Œç¯„ä¾‹ <code>3E11FA47-71CA-11E1-9E33-C80AA9429562:23</code></p><ul><li><p>source_idï¼šè©² DML/DDL æœ€åŸå§‹åŸ·è¡Œçš„ server å…¶ UUIDã€‚</p><p>åœ¨æºç¢¼ä¸­ç¨±ç‚º sidï¼Œæœƒåœ¨ MySQL å•Ÿå‹•æ™‚å¾ auto.cnf å–å¾—ï¼Œå¦‚æœæ²’æœ‰å‰‡æ ¹æ“šå•Ÿå‹•æ™‚é–“ã€ç·šç¨‹çš„ LWP ID åŠéš¨æ©Ÿå…§å­˜åœ°å€ç”Ÿæˆå¾Œä¸¦è¨˜éŒ„åœ¨ auto.cnf ä¸­ã€‚</p><p>æ³¨æ„ï¼šä¹Ÿå°±æ˜¯èªªå¦‚æœåˆªé™¤ç¾æœ‰çš„ auto.cnf æœƒåœ¨ä¸‹æ¬¡å•Ÿå‹•æ™‚ç”¢ç”Ÿä¸€å€‹ä¸åŒçš„ server uuidã€‚</p></li><li><p>transaction_idï¼šåŸå§‹ server ç‚ºè©² DML/DDL æ“ä½œåˆ†é…çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œè©²åºåˆ—è™Ÿæ˜¯é †åºéå¢çš„ã€‚</p><p>åœ¨æºç¢¼ä¸­ç¨±ç‚º gno æœƒåœ¨ Transaction é€²å…¥ Flush éšæ®µä¸­ç”Ÿæˆï¼ŒMySQL å…§éƒ¨ç¶­è­·äº†ä¸€å€‹å…¨å±€è®Šé‡ next_free_gno çš„è¨ˆæ•¸ä¾†ç”Ÿæˆ gnoã€‚</p></li></ul><h2 id=gtid-life-cycle>GTID Life cycle</h2><p>ä»¥ä¸‹ä»¥ MySQL 8.0.17 ä»¥ä¸Šä¾†èªªæ˜</p><ol><li><p>ç•¶ Transaction åœ¨ Master ä¸ŠåŸ·è¡Œæ™‚ï¼Œæœƒåœ¨ commit éç¨‹ä¸­çš„ Flush éšæ®µç”Ÿæˆ GTID ã€‚</p><p><img src=/p/mysql-gtid/gtid-step.jpg width=2000 height=734 srcset="/p/mysql-gtid/gtid-step_hu_314c6c6b0a235188.jpg 480w, /p/mysql-gtid/gtid-step_hu_cd0c8151a222e9ad.jpg 1024w" loading=lazy alt=gtid-step class=gallery-image data-flex-grow=272 data-flex-basis=653px></p></li><li><p>ç•¶åˆ†é… GTID ä¹‹å¾Œæœƒå°‡ Transaction å’Œå…¶å°æ‡‰çš„ GTID ä¸€èµ·å¯«å…¥ binlog (å°šæœªé€²å…¥ sync éšæ®µé€²è¡Œ fsync å› æ­¤åªæ˜¯å¯«å…¥ OS cache) åŒæ™‚æ›´æ–° mysql.gtid_executed è¡¨åŠ @@GLOBAL.gtid_executed è®Šé‡ã€‚</p></li><li><p>ç•¶ sync_binlog â‰  1 æ™‚ï¼Œå°±åœ¨ Flush éšæ®µå°‡ binlog å¯«å…¥ OS cache å¾Œç™¼é€ binlog event çµ¦ slaveã€‚</p><p>ç•¶ sync_binlog = 1 æ™‚ï¼Œåœ¨ sync éšæ®µ fsycn åˆ° disk å¾Œæ‰ç™¼é€ binlog event çµ¦ slaveã€‚</p><p>å› æ­¤ç•¶ sync_binlog â‰  1 æ™‚ï¼Œç•¶ Master crash æ™‚å¯èƒ½å°è‡´ Slave é€²åº¦å¤§æ–¼ Masterã€‚</p></li><li><p>Master çš„ dump ç·šç¨‹å°‡ binlog event å‚³é€çµ¦ Slave ä¿å­˜è‡³ relay logã€‚</p><ul><li>è©³ç´°éç¨‹<ol><li>åœ¨ Slave çš„ IO_Thread å»ºç«‹é€£ç·šæ™‚ï¼Œæœƒå°‡ <code>Retrieved_Gtid_Set</code> å’Œ <code>Executed_Gtid_Set</code>çš„ä¸¦é›† (UNION) åŠè‡ªå·±çš„ server_id ç™¼é€çµ¦ Masterã€‚</li><li>Master ç¢ºèªè‡ªå·±çš„ <code>gtid_purged</code> æ˜¯å¦ç‚º Slave ç™¼é€çš„å­é›†ï¼Œä»¥æ­¤ä¾†æª¢æŸ¥ master çš„ binlog å°šæœª purgeã€‚</li><li>Master åˆ¤æ–· Slave æœ‰å“ªäº› GTID é‚„æ²’åŸ·è¡Œï¼Œä¸¦ç™¼é€å°æ‡‰çš„ binlog çµ¦ Slaveã€‚</li></ol></li></ul></li><li><p>Slave å¾ relay log è®€å– GTIDï¼Œä¸¦å°‡ gtid_next è¨­ç‚ºè©² GTIDï¼Œä¸¦åˆ¤æ–·ä»¥ä¸‹ï¼š</p><ul><li>å¾ <code>@@GLOBAL.gtid_owned</code> ä¸­ç¢ºèªæ²’æœ‰å…¶ä»–ç·šç¨‹æ­£åœ¨ä½¿ç”¨è©² GTIDï¼Œä¿è­‰ä¸€æ¬¡åªæœ‰ä¸€å€‹ç·šç¨‹åœ¨è™•ç†è©² GTIDã€‚</li><li>å¾ <code>@@GLOBAL.gtid_executed</code> ä¸­ç¢ºèªè©² GTID æ˜¯å¦å·²ç¶“æ‡‰ç”¨éã€‚</li></ul></li><li><p>å¦‚æœè©² GTID å°šæœªè¢«è¢«æ‡‰ç”¨ï¼Œå‰‡åœ¨ Slave æ‡‰ç”¨è©² Event ä¸¦ç¶­æŒè©² Event åœ¨ Master ä¸Šçš„ GTIDï¼ŒåŒæ™‚æ›´æ–° mysql.gtid_executed è¡¨åŠ @@GLOBAL.gtid_executed è®Šé‡ã€‚è‹¥æœ‰é–‹å•Ÿ log_slave_update å‰‡ä¹Ÿå¯«å…¥ binlogã€‚</p></li></ol><p>åœ¨ 8.0.17 (å« 5.7 æ‰€æœ‰ç‰ˆæœ¬) ä¹‹å‰ mysql.gtid_executed ä¸¦ä¸ç¸½æ˜¯åŠæ™‚æ›´æ–°ï¼š</p><ul><li><p>ç•¶ <code>log_bin = OFF</code> æˆ–è€… <code>log_slave_update = OFF</code> æ™‚ï¼Œå‰‡ transaction å’Œ mysql.gtid_executed æœƒä¸€èµ· commit æˆ– rollbackã€‚</p></li><li><p>ç•¶ slave <code>log_bin = ON</code> ä¸” <code>log_slave_update = ON</code> æ™‚ (æ³¨æ„ï¼šå¦‚æœæ˜¯ master <code>log_bin = ON</code> ä¹Ÿé©ç”¨)ï¼Œ æ¯ç•¶ binlog rotate æˆ–è€… server é—œé–‰æ™‚ï¼Œæ‰æœƒå°‡å…ˆå‰ binlog çš„æ‰€æœ‰ transaction gtid å¯«å…¥ mysql.gtid_executed è¡¨ã€‚</p></li><li><p>ç•¶ server crash æ™‚ï¼Œæœƒåœ¨ crash recovery æ™‚å°‡ binlog ä¸­çš„ GTID æ·»åŠ åˆ° mysql.gtid_executed è¡¨ã€‚</p><p>æ³¨æ„ï¼šç•¶é–‹å•Ÿæ™‚ log_bin = OFF æ™‚ï¼Œæœƒç„¡æ³•æ¢å¾© GTID å°è‡´ç„¡æ³•å•Ÿå‹• replicationã€‚</p></li><li><p>æœƒä½¿ç”¨æ¯æ¬¡ Transaction commit æ™‚æ›´æ–°çš„ @@GLOBAL.gtid_executed ä¾†è¡¨ç¤º server çš„ GTID ç‹€æ…‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ mysql.gtid_executed è¡¨(å› ç‚ºä¸æœƒå³æ™‚æ›´æ–°)ã€‚</p></li></ul><p>å› ç‚ºä»¥ä¸Šè¡Œç‚ºç•¶é–‹å•Ÿ gtid æ¨¡å¼ä¸” log_slave_update = ON æ™‚ï¼Œå¿…é ˆè¦åŒæ™‚è¨­ç½® sync_binlog = 1 & innodb_flush_log_at_trx_commit = 1ï¼Œå¦å‰‡æœƒå°è‡´ relication åœ¨ OS crash æ™‚ç™¼ç”Ÿå•é¡Œã€‚</p><p>å¾ 8.0.17 é–‹å§‹ç‚ºäº†å¯¦ç¾ clone åŠŸèƒ½ (<a class=link href="https://dev.mysql.com/worklog/task/?id=9211" target=_blank rel=noopener>WL#9211</a>) æ›´æ”¹äº†æ­¤è¡Œç‚ºï¼Œä¸è«–å¦‚ä½•è¨­ç½® mysql.gtid_executed è¡¨ç¸½æ˜¯å’Œå°æ‡‰çš„ Event ä¸€èµ· commit (rollback) ã€‚</p><h2 id=mysqlgtid_execute-è¡¨>mysql.gtid_execute è¡¨</h2><p>è¨­è¨ˆçš„åˆè¡·æ˜¯ç”¨æ–¼ç•¶ slave æœªé–‹å•Ÿ binlog æˆ–è€…æ˜¯ <code>log_slave_update = OFF</code> æ™‚ï¼Œæˆ–è€…æ˜¯ç•¶ binlog ä¸Ÿå¤±æ™‚èƒ½å¤ ä¿ç•™ GTID çš„ç‹€æ…‹ï¼Œå› æ­¤æœƒåœ¨é€™å¼µè¡¨ä¸­æŒä¹…åŒ–å·²ç¶“åŸ·è¡Œçš„ GTID SETã€‚</p><aside>ğŸ’¡ RESET MASTER æœƒæ¸…ç©ºæ­¤è¡¨</aside><h3 id=å£“ç¸®>å£“ç¸®</h3><p>éš¨è‘—æ™‚é–“æ¨ç§» mysql.gtid_executed è¡¨æœƒæœ‰è¨±å¤šç­†è³‡æ–™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>+--------------------------------------+----------------+--------------+
</span></span><span class=line><span class=cl>| source_uuid                          | interval_start | interval_end |
</span></span><span class=line><span class=cl>|--------------------------------------+----------------+--------------|
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 37             | 37           |
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 38             | 38           |
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 39             | 39           |
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 40             | 40           |
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 41             | 41           |
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 42             | 42           |
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 43             | 43           |
</span></span><span class=line><span class=cl>+--------------------------------------+----------------+--------------+
</span></span></code></pre></td></tr></table></div></div><p>ç‚ºäº†ç¯€çœç©ºé–“ï¼ŒMySQL æœƒå®šæœŸå£“ç¸® mysql.gtid_executed è¡¨ï¼Œå£“ç¸®çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>+--------------------------------------+----------------+--------------+
</span></span><span class=line><span class=cl>| source_uuid                          | interval_start | interval_end |
</span></span><span class=line><span class=cl>|--------------------------------------+----------------+--------------|
</span></span><span class=line><span class=cl>| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 37             | 43           |
</span></span><span class=line><span class=cl>+--------------------------------------+----------------+--------------+
</span></span></code></pre></td></tr></table></div></div><p>å•Ÿç”¨ binlog æ™‚ï¼Œç•¶ç™¼ç”Ÿ binlog rotation æ™‚æœƒå£“ç¸® mysql.gtid_executed è¡¨ã€‚</p><p>ç•¶ç¦ç”¨ binlog æ™‚æœƒä¾æ“š <a class=link href=GTID%20903c4e34f0cc474ea92f3368b7d552de.md>gtid_executed_compression_period</a> çš„å€¼æ±ºå®šå£“ç¸®çš„æ™‚æ©Ÿé»ï¼Œæ¯ç•¶è™•ç† N å€‹ Transaction å¾Œæœƒå–šé†’å£“ç¸®ç·šç¨‹ (thread/sql/compress_gtid_table) å£“ç¸® mysql.gtid_executed è¡¨ã€‚</p><p>åœ¨ 8.0.17 ä¹‹å‰é è¨­å€¼ç‚º 1000ï¼Œè¡¨ç¤ºæ¯ 1000 å€‹ Transaction é€²è¡Œå£“ç¸®ï¼Œåœ¨è©²ç‰ˆæœ¬ä¹‹å‰ä¸å»ºè­°åœ¨é—œé–‰ binlog æ™‚è¨­å®šç‚º 0ï¼Œé€™å°‡æœƒå¢åŠ æ‰€éœ€çš„ disk ç©ºé–“ã€‚</p><p>å¾ 8.0.17 é–‹å§‹å»ºè­°è¨­ç½®ç‚º 0 (8.0.23 é è¨­å€¼)ï¼Œé€™æ˜¯å› ç‚ºå¾è©²ç‰ˆæœ¬é–‹å§‹ InnoDB çš„ Transaction å¯«å…¥æœƒç”±å¦ä¸€å€‹ innodb/clone_gtid_thread ç·šç¨‹ä¾†æ§åˆ¶å¯«å…¥å’Œå£“ç¸®ï¼Œ compress_gtid_table ç·šç¨‹æœƒå¹²æ“¾å…¶ä½œæ¥­ä¸¦é™ä½é€Ÿåº¦ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>threads</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>NAME</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;%gtid%&#39;</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>THREAD_ID</span><span class=p>:</span><span class=w> </span><span class=mi>26</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>NAME</span><span class=p>:</span><span class=w> </span><span class=n>thread</span><span class=o>/</span><span class=k>sql</span><span class=o>/</span><span class=n>compress_gtid_table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>TYPE</span><span class=p>:</span><span class=w> </span><span class=n>FOREGROUND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>PROCESSLIST_ID</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>PROCESSLIST_USER</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>PROCESSLIST_HOST</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>PROCESSLIST_DB</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PROCESSLIST_COMMAND</span><span class=p>:</span><span class=w> </span><span class=n>Daemon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>PROCESSLIST_TIME</span><span class=p>:</span><span class=w> </span><span class=mi>1509</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>PROCESSLIST_STATE</span><span class=p>:</span><span class=w> </span><span class=n>Suspending</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>PROCESSLIST_INFO</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>PARENT_THREAD_ID</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>ROLE</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>INSTRUMENTED</span><span class=p>:</span><span class=w> </span><span class=n>YES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HISTORY</span><span class=p>:</span><span class=w> </span><span class=n>YES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CONNECTION_TYPE</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>THREAD_OS_ID</span><span class=p>:</span><span class=w> </span><span class=mi>18677</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=ç³»çµ±è®Šé‡-gtid_executed-å’Œ-gtid_purged-çš„åˆå§‹åŒ–èˆ‡æ›´æ–°>ç³»çµ±è®Šé‡ gtid_executed å’Œ gtid_purged çš„åˆå§‹åŒ–èˆ‡æ›´æ–°</h2><h3 id=åˆå§‹åŒ–>åˆå§‹åŒ–</h3><p>æ¯å€‹ binlog çš„é–‹é ­éƒ½æœ‰ <code>Previous-GTIDs</code>ï¼šé€™æ˜¯ç”±ä¸Šä¸€å€‹ binlog æ–‡ä»¶çš„ <code>Previous-GTIDs</code> å’Œä¸Šä¸€å€‹ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTID çµ„æˆã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~ -&gt; mysqlbinlog --no-defaults --base64-output=DECODE-ROWS -vvv mysql-bin.000004
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>#230217  8:17:55 server id 1  end_log_pos 125 CRC32 0xa9000aca  Start: binlog v 4, server v 8.0.21 created 230217  8:17:55 at startup
</span></span><span class=line><span class=cl>ROLLBACK/*!*/;
</span></span><span class=line><span class=cl># at 125
</span></span><span class=line><span class=cl>#230217  8:17:55 server id 1  end_log_pos 196 CRC32 0xf3d86d46  Previous-GTIDs
</span></span><span class=line><span class=cl># 6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:1-3
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>SET @@SESSION.GTID_NEXT= &#39;6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:4&#39;/*!*/;
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>SET @@SESSION.GTID_NEXT= &#39;6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:5&#39;/*!*/;
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl># End of log file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>~ -&gt; mysql-docker $ mysqlbinlog --no-defaults --base64-output=DECODE-ROWS -vvv mysql-bin.000005
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>#230217  8:19:12 server id 1  end_log_pos 125 CRC32 0xd5587e96  Start: binlog v 4, server v 8.0.21 created 230217  8:19:12 at startup
</span></span><span class=line><span class=cl># Warning: this binlog is either in use or was not closed properly.
</span></span><span class=line><span class=cl>ROLLBACK/*!*/;
</span></span><span class=line><span class=cl># at 125
</span></span><span class=line><span class=cl>#230217  8:19:12 server id 1  end_log_pos 196 CRC32 0x2416aa2b  Previous-GTIDs
</span></span><span class=line><span class=cl># 6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:1-5
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>gtid_executed å’Œ gtid_purged é€™ 2 å€‹ç³»çµ±è®Šé‡åœ¨ MySQL å•Ÿå‹•æ™‚æœƒé€é binlog è¨ˆç®—é€²è¡Œåˆå§‹åŒ–ï¼š</p><ul><li>gtid_executedï¼šç”±æœ€æ–°çš„ binlog æ–‡ä»¶çš„ <code>Previous-GTIDs</code>ã€æœ€æ–°çš„ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTIDã€mysql.gtid_excuted ä¸¦é›† (UNION) è¨ˆç®—å¾—å‡ºã€‚</li><li>gtid_purgedï¼š<ol><li><p>å°‡æœ€æ–°çš„ binlog æ–‡ä»¶çš„ <code>Previous-GTIDs</code>ã€æœ€æ–°çš„ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTID ç›¸åŠ ï¼Œè¨ˆç®—å‡º gtids_in_binlog (è¡¨ç¤ºæ›¾å‡ºç¾åœ¨ binlog çš„æ‰€æœ‰ gtid)ã€‚</p></li><li><p>å°‡ gtids_in_binlog æ¸›å»æœ€èˆŠçš„ binlog æ–‡ä»¶çš„ <code>Previous-GTIDs</code>ï¼Œè¨ˆç®—å‡º gtids_in_binlog_not_purged (è¡¨ç¤ºæ‰€åœ¨çš„ binlog å°šæœªè¢«æ¸…é™¤çš„ gtid)ã€‚</p></li><li><p>å°‡ gtid_executed æ¸›å» gtids_in_binlog_not_purgedï¼Œå¾—å‡ºåœ¨ server ä¸ŠåŸ·è¡Œéä½† binlog å·²è¢«æ¸…æ¥šçš„ GTID SETã€‚</p><p>ç”±ä¸Šè¨ˆç®—å¾—çŸ¥å¦‚æœ binlog æœªé–‹å•Ÿæ™‚ï¼Œgtid_purged = gtid_executed ã€‚</p></li></ol></li></ul><h3 id=æ›´æ–°>æ›´æ–°</h3><ul><li>gtid_executedï¼š<ul><li>æœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚</li><li>set global gtid_purgedï¼Œè¨­ç‚ºåŸå…ˆ gtid_execute å’Œæ–°è¨­ç½® gtid_purged çš„ä¸¦é›† (UNION)ã€‚</li></ul></li><li>gtid_purgedï¼š<ul><li>ç•¶ log_slave_updates = OFF æ™‚ï¼Œæœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚</li><li>ç•¶ Master é–‹å•Ÿ binlog æ™‚ï¼Œç•¶åŸ·è¡Œ purge binary logs æˆ– binlog è¶…é expire_logs_days (binlog_expire_logs_seconds) çš„è¨­ç½®æ™‚ï¼Œè§¸ç™¼æ¸…é™¤ binlog çš„å‹•ä½œæ›´æ–°ã€‚</li><li>ç•¶ Slave é–‹å•Ÿ log_slave_updatesï¼Œç•¶åŸ·è¡Œ purge binary logs æˆ– binlog è¶…é expire_logs_days (binlog_expire_logs_seconds) çš„è¨­ç½®æ™‚ï¼Œè§¸ç™¼æ¸…é™¤ binlog çš„å‹•ä½œæ›´æ–°ã€‚</li><li>ç•¶ Slave é—œé–‰ log_slave_updates ï¼Œæœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚</li><li>set global gtid_purgedï¼Œè¢«è¨­å®šæˆ–å¢åŠ æŒ‡å®š gtid setã€‚</li></ul></li><li>å…±åŒï¼š<ul><li>RESET MASTER æ™‚è¨­ç‚ºç©ºå€¼ã€‚</li><li>åœ¨ MySQL å•Ÿå‹•æ™‚åˆå§‹åŒ–ã€‚</li><li>Master æœªé–‹å•Ÿ binlog æ™‚ï¼Œå› ç‚ºä¸æœƒç”¢ç”Ÿ GTIDï¼Œå› æ­¤ä¸æœƒæœ‰ä»»ä½•æ›´æ–°ã€‚</li></ul></li></ul><h2 id=gtid-ç›¸é—œè®Šé‡>GTID ç›¸é—œè®Šé‡</h2><h3 id=gtid_mode>gtid_mode</h3><p><img src=/p/mysql-gtid/gtid-mode.jpg width=572 height=315 srcset="/p/mysql-gtid/gtid-mode_hu_5b6a4a39e8b81977.jpg 480w, /p/mysql-gtid/gtid-mode_hu_cbc4da12f86538a1.jpg 1024w" loading=lazy alt=gtid_mode class=gallery-image data-flex-grow=181 data-flex-basis=435px></p><p>æ§åˆ¶æ˜¯å¦é–‹å•Ÿ GTID åŠŸèƒ½ã€‚</p><p>å¯ä»¥è¨­ç½®ç‚ºä»¥ä¸‹å€¼ï¼š</p><ul><li>OFFï¼šæ‰€æœ‰æ–°çš„æˆ–å›æ”¾çš„ Transaction éƒ½æ˜¯ anonymousã€‚</li><li>OFF_PERMISSIVEï¼šæ‰€æœ‰æ–°çš„ Transaction éƒ½æ˜¯ anonymousï¼Œä½†å›æ”¾çš„ Transaction å¯ä»¥æ˜¯ anonymous ä¹Ÿå¯ä»¥åŒ…å« GTIDã€‚</li><li>ON_PERMISSIVEï¼šæ‰€æœ‰æ–°çš„ Transaction éƒ½åŒ…å« GTIDï¼Œä½†å›æ”¾çš„ Transaction å¯ä»¥æ˜¯ anonymous ä¹Ÿå¯ä»¥åŒ…å« GTIDã€‚</li><li>ONï¼šå¿…é ˆåŒæ™‚è¨­ç½® enforce_gtid_consistency = ONã€‚</li></ul><p>åœ¨ä¿®æ”¹ gtid_mode æ™‚ä¸€æ¬¡åªèƒ½è®Šæ›´ç‚ºä¸Šä¸€å€‹æˆ–ä¸‹ä¸€å€‹å€¼ï¼Œä¾‹å¦‚ï¼šåŸå…ˆè¨­ç½®ç‚º OFF_PERMISSIVE å‰‡åªèƒ½è¨­ç½®ç‚º OFF æˆ– ON_PERMISSIVEã€‚</p><h3 id=enforce_gtid_consistency>enforce_gtid_consistency</h3><p><img src=/p/mysql-gtid/enforce-gtid-consistency.jpg width=576 height=296 srcset="/p/mysql-gtid/enforce-gtid-consistency_hu_70752c55119992ca.jpg 480w, /p/mysql-gtid/enforce-gtid-consistency_hu_4a8af9082bbea885.jpg 1024w" loading=lazy alt=enforce_gtid_consistency class=gallery-image data-flex-grow=194 data-flex-basis=467px></p><p>æ§åˆ¶æ˜¯å¦å…è¨±é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œï¼Œå¿…é ˆè¨­ç½®ç‚º ON æ‰èƒ½è¨­ç½® gtid_mode = ONã€‚</p><p>å¯ä»¥è¨­ç½®ç‚ºä»¥ä¸‹å€¼ï¼š</p><ul><li>OFF (0)ï¼šå…è¨±æ‰€æœ‰é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œã€‚</li><li>ON (1)ï¼šä¸å…è¨±ä»»ä½•é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œã€‚</li><li>WARN (2)ï¼šå…è¨±æ‰€æœ‰é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œï¼Œä½†æœƒç”¢ç”Ÿ warningã€‚</li></ul><p>åªæœ‰åœ¨èªå¥å¯«å…¥ binlog æ™‚æ‰æœƒæª¢æŸ¥ï¼Œä¹Ÿå°±æ˜¯æœªé–‹å•Ÿ binlog æˆ–ç•¶èªå¥è¢« filter éæ¿¾æ™‚ä¸æœƒæª¢æŸ¥ã€‚</p><p>é•å GTID ä¸€è‡´æ€§çš„èªå¥å¯ä»¥åƒè€ƒ <a class=link href=GTID%20903c4e34f0cc474ea92f3368b7d552de.md>GTID é™åˆ¶</a> ç« ç¯€ã€‚</p><h3 id=gtid_next>gtid_next</h3><p><img src=/p/mysql-gtid/gtid-next.jpg width=518 height=262 srcset="/p/mysql-gtid/gtid-next_hu_7927395141f577f7.jpg 480w, /p/mysql-gtid/gtid-next_hu_8dbd23ef2d81faf4.jpg 1024w" loading=lazy alt=gtid-next class=gallery-image data-flex-grow=197 data-flex-basis=474px></p><p>gtid_next ç”¨æ–¼æŒ‡å®šå¦‚ä½•ç²å–ä¸‹ä¸€å€‹ GTIDã€‚</p><p>gtid_next å¯ä»¥è¨­ç‚ºä»¥ä¸‹å€¼ï¼š</p><ul><li>AUTOMATICï¼šä½¿ç”¨ä¸‹ä¸€å€‹è‡ªå‹•ç”Ÿæˆçš„ GTIDã€‚</li><li>ANONYMOUSï¼šTransaction æ²’æœ‰ GTIDï¼Œåªæœ‰ gtid_mode = OFF æ™‚æ‰èƒ½è¨­ç½®çš„å€¼ã€‚</li><li>æŒ‡å®š GTID</li></ul><p>å°‡ gtid_next è¨­ç½®ç‚ºæŒ‡å®š GTID å¾Œï¼Œéœ€è¦åœ¨ Transaction commit æˆ– rollback å¾Œï¼Œå¿…é ˆåœ¨åŸ·è¡Œå…¶ä»–èªå¥ä¹‹å‰å†æ¬¡é¡¯å¼çš„ SET GTID_NEXTï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>gtid_next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;08d3c091-addb-11ed-8959-0242ac1c0002:5&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>rollback</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ERROR</span><span class=w> </span><span class=mi>1837</span><span class=w> </span><span class=p>(</span><span class=n>HY000</span><span class=p>):</span><span class=w> </span><span class=k>When</span><span class=w> </span><span class=o>@@</span><span class=k>SESSION</span><span class=p>.</span><span class=n>GTID_NEXT</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>GTID</span><span class=p>,</span><span class=w> </span><span class=n>you</span><span class=w> </span><span class=n>must</span><span class=w> </span><span class=n>explicitly</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>different</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=k>after</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>COMMIT</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=k>ROLLBACK</span><span class=p>.</span><span class=w> </span><span class=n>Please</span><span class=w> </span><span class=k>check</span><span class=w> </span><span class=n>GTID_NEXT</span><span class=w> </span><span class=k>variable</span><span class=w> </span><span class=n>manual</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>detailed</span><span class=w> </span><span class=n>explanation</span><span class=p>.</span><span class=w> </span><span class=k>Current</span><span class=w> </span><span class=o>@@</span><span class=k>SESSION</span><span class=p>.</span><span class=n>GTID_NEXT</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=s1>&#39;08d3c091-addb-11ed-8959-0242ac1c0002:5&#39;</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=gtid_owned>gtid_owned</h3><p><img src=/p/mysql-gtid/gtid-owned.jpg width=518 height=182 srcset="/p/mysql-gtid/gtid-owned_hu_787a44bbcfe7e1dd.jpg 480w, /p/mysql-gtid/gtid-owned_hu_1154763dda1a99ae.jpg 1024w" loading=lazy alt=gtid_owned class=gallery-image data-flex-grow=284 data-flex-basis=683px></p><p>æ­¤ç‚º read-only çš„è®Šé‡ï¼Œæ ¹æ“š Scope çš„ä¸åŒæœ‰ä¸åŒæ„æ€ï¼š</p><ul><li><p>Globalï¼šåˆ—å‡º server æ­£åœ¨ä½¿ç”¨çš„æ‰€æœ‰ GTID ä»¥åŠæ“æœ‰è©² GTID çš„ç·šç¨‹ IDã€‚</p><p>ä¸»è¦ç”¨æ–¼é–‹å•Ÿ MTS æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»– applier å·²ç¶“åœ¨æ‡‰ç”¨è©² GTIDï¼Œé¿å…åŒä¸€å€‹ GTID åœ¨åŒæ™‚è¢«å¤šå€‹ç·šç¨‹åŒæ™‚è™•ç†ã€‚</p></li><li><p>Sessionï¼šåˆ—å‡ºè©² session ä½¿ç”¨ä¸­çš„ GTIDã€‚</p><p>ç•¶æ‰‹å‹•è¨­ç½® gtid_next ç‚ºæŒ‡å®š GTID æ™‚ï¼Œå¯ä»¥åœ¨ Transaction åœ¨ commit (rollback) ä¹‹å‰é€é gtid_owned è§€å¯Ÿåˆ°æ­¤è¨­ç½®ã€‚</p><p>ç•¶ gtid_next = AUTOMATIC æ™‚ï¼Œåªæœ‰åœ¨ Trasnsaction commit æ™‚èƒ½å¾ gtid_next ä¸­çŸ­æš«è§€å¯Ÿåˆ°ï¼Œå…¶é¤˜æ™‚å€™æœƒæ˜¯ç©ºå€¼ã€‚</p></li></ul><h3 id=gtid_executed>gtid_executed</h3><p><img src=/p/mysql-gtid/gtid-executed.jpg width=517 height=185 srcset="/p/mysql-gtid/gtid-executed_hu_f490155faa0e6442.jpg 480w, /p/mysql-gtid/gtid-executed_hu_8a3533392ba7cd36.jpg 1024w" loading=lazy alt=gtid_executed class=gallery-image data-flex-grow=279 data-flex-basis=670px></p><p>æ­¤ç‚º read-only çš„è®Šé‡ï¼ŒæŒ‡çš„æ˜¯æ‰€æœ‰è©² server å·²ç¶“åŸ·è¡Œçš„ GTIDï¼Œä¹Ÿæœƒç­‰åŒæ–¼ SHOW MASTER ( | SLAVE ) STATUS ä¸­çš„ Executed_Gtid_Set å€¼ã€‚</p><p><strong>ç•¶åŸ·è¡Œ RESET MASTER æ™‚æœƒå°‡ gtid_executed è¨­ç½®ç‚ºç©ºå€¼ã€‚</strong></p><p>gtid_executed çš„ Gtid_Set æœƒåŒ…å« gtid_purged çš„ Gtid_Set ï¼Œå› æ­¤åœ¨ä»»ä½•æ™‚å€™åŸ·è¡Œ GTID_SUBTRACT(@@GLOBAL.gtid_executed, @@GLOBAL.gtid_purged) å¯ä»¥å¾—åˆ°æœªæ¸…é™¤çš„ binlog ä¸­æ‰€æœ‰çš„ GTIDã€‚</p><h3 id=gtid_purged>gtid_purged</h3><p><img src=/p/mysql-gtid/gtid-purged.jpg width=518 height=184 srcset="/p/mysql-gtid/gtid-purged_hu_e55e1429d397617b.jpg 480w, /p/mysql-gtid/gtid-purged_hu_4fd9f914a82e8f0d.jpg 1024w" loading=lazy alt=gtid_purged class=gallery-image data-flex-grow=281 data-flex-basis=675px></p><p>æ­¤è®Šé‡è¡¨ç¤ºåœ¨ server ä¸Šå·²ç¶“åŸ·è¡Œï¼Œä½†æ˜¯å°æ‡‰çš„ binlog å·²ç¶“è¢«æ¸…é™¤çš„ GTID SETï¼Œå› æ­¤ gtid_purged ç‚º gtid_executed çš„å­é›†ã€‚</p><p>ä»¥ä¸‹æƒ…æ³çš„ GTID æœƒåŒ…å«åœ¨ gtid_purgedï¼š</p><ul><li>ç•¶ slave æœªé–‹å•Ÿ log_slave_updates æ™‚ï¼Œå·²ç¶“å›æ”¾çš„ Transaction çš„ GTIDã€‚</li><li>åŒ…å«è©² GTID çš„ binlog å·²ç¶“è¢«æ¸…é™¤ã€‚</li><li>é€é SET @@GLOBAL.gtid_purged ä¾†é¡¯ç¤ºè¨­ç½®ã€‚</li></ul><p><strong>ç•¶åŸ·è¡Œ RESET MASTER æ™‚æœƒå°‡ gtid_purged è¨­ç½®ç‚ºç©ºå€¼ã€‚</strong></p><p>å¯ä»¥é€é SET @@GLOBAL.gtid_purged ä¾†é¡¯ç¤ºè¨­å®šï¼Œæœ‰ä»¥ä¸‹å…©ç¨®æ–¹å¼ï¼š</p><ul><li><p>å°‡ gtid_purged è®Šæ›´ç‚ºæŒ‡å®šçš„ GTID SETï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>gtid_purged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;gtid_set&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¶“éæ­¤è¨­ç½®å¾Œ gtid_purged ç­‰æ–¼ gtid_setï¼Œä¸” gtid_executed å€¼ (mysql.gtid_executed) ç­‰æ–¼ gtid_executed åŸæœ¬çš„å€¼å’Œ gtid_set çš„ä¸¦é›† (UNION)ã€‚</p><p>gtid_set é™åˆ¶ï¼š</p><ul><li>æŒ‡å®šçš„ gtid_set å¿…é ˆæ˜¯ gtid_purged ç•¶å‰å€¼çš„è¶…é›† (superset)ï¼Œä¹Ÿå°±æ˜¯æ–°è¨­ç½®çš„ GTID SET å¿…é ˆåŒ…å«åŸæœ¬çš„ gtid_purgedã€‚</li><li>æŒ‡å®šçš„ gtid_setä¸å¾—å’Œ gtid_subtract(gtid_executed,gtid_purged) ç›¸äº¤ï¼Œä¹Ÿå°±æ˜¯æ–°è¨­ç½®çš„ GTID SET ä¸èƒ½åŒ…å«åœ¨ gtid_executed ä¸­å°šæœªè¢«æ¸…é™¤çš„å€¼ã€‚</li><li>æŒ‡å®šçš„ gtid_set ä¸èƒ½åŒ…å« @@global.gtid_owned ä¸­çš„ä»»ä½• GTIDï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åŒ…å«ç•¶å‰ server æ­£åœ¨åŸ·è¡Œçš„ gtidã€‚</li></ul><p>ç”¨é€”ç¯„ä¾‹ï¼šä½¿ç”¨ mysqldump é‚„åŸ slave ä¸Šæå£çš„è¡¨ï¼Œå› ç‚ºå‚™ä»½æª”å’ŒåŸå…ˆ slave çš„ gtid æœ‰é‡ç–Šï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä½¿æ–¹å¼é€²è¡Œ gtid_purged çš„è¨­ç½®ã€‚</p></li><li><p>ç‚º gtid_purged append (æ–°å¢) æŒ‡å®šçš„ GTID SET</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>gtid_purged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;+gtid_set&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¶“éæ­¤è¨­ç½®å¾Œ gtid_executed (åŒ…å« mysql.gtid_executed)ã€gtid_purged æœƒæ–°å¢ gtid_setã€‚</p><p>gtid_set é™åˆ¶ï¼š</p><ul><li>gtid_set ä¸å¾—èˆ‡ gtid_executed çš„ç•¶å‰å€¼ç›¸äº¤ï¼Œä¹Ÿå°±æ˜¯æ–°é™„åŠ ä¸Šå»çš„ GTID SET ä¸èƒ½åŒ…å«åœ¨ gtid_executed å’Œ gtid_purged ä¸­çš„ GTIDã€‚</li><li>æŒ‡å®šçš„ gtid_set ä¸èƒ½åŒ…å« @@global.gtid_owned ä¸­çš„ä»»ä½• GTIDï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åŒ…å«ç•¶å‰ server æ­£åœ¨åŸ·è¡Œçš„ gtidã€‚</li></ul><p>ç”¨é€”ç¯„ä¾‹ï¼šç‚ºäº†é…ç½®å¤šå€‹ channel çš„ salveï¼Œå°‡ä¾†è‡ªä¸åŒ master çš„å‚™ä»½é‚„åŸåˆ°åŒä¸€å€‹ serverï¼Œå› ç‚ºå…©è€…çš„ Transaction ä¸ç›¸äº¤ï¼Œå› æ­¤ä½¿ç”¨ append çš„æ–¹å¼æ›´æ–° gtid_purgedã€‚</p></li></ul><p>æ³¨æ„ï¼šåœ¨ MySQL 5.7 ä¸­åªèƒ½ç›´æ¥è®Šæ›´æˆæŒ‡å®šçš„ GTID SETï¼Œç„¡æ³•ä½¿ç”¨ append çš„æ–¹å¼ï¼Œä¸”åªæœ‰ç•¶ gtid_executed ç‚ºç©º (ä¹Ÿå°±æ˜¯ gtid_purged å€¼ä¹Ÿç‚ºç©º) æ™‚æ‰å¯ä»¥æ›´æ–° gtid_purged çš„å€¼</p><h3 id=gtid_executed_compression_period>gtid_executed_compression_period</h3><p><img src=/p/mysql-gtid/gtid-executed-compression-period.jpg width=575 height=309 srcset="/p/mysql-gtid/gtid-executed-compression-period_hu_44a296a498aac305.jpg 480w, /p/mysql-gtid/gtid-executed-compression-period_hu_689a93edd88a4b11.jpg 1024w" loading=lazy alt=gtid_executed_compression_period class=gallery-image data-flex-grow=186 data-flex-basis=446px></p><p>æ­¤è¨­ç½®åªæœ‰ç¦ç”¨ binlog æ‰æœ‰æ•ˆï¼Œæ¯ç•¶è™•ç† N å€‹ Transaction å¾Œæœƒå–šé†’ç·šç¨‹å£“ç¸® mysql.gtid_executed è¡¨ï¼Œç•¶è¨­ç½®ç‚º 0 æ™‚è¡¨ç¤ºå£“ç¸®ä¸å›ºå®šåŸ·è¡Œï¼Œè€Œæ˜¯æ ¹æ“šéœ€è¦é€²è¡Œå£“ç¸®ã€‚</p><p>ç•¶å•Ÿç”¨ binlog æ™‚ï¼Œä¸æœƒä½¿ç”¨æ­¤è¨­ç½®ï¼Œè€Œæ˜¯ç•¶ binlog rotation æ™‚æ‰æœƒå£“ç¸® mysql.gtid_executed è¡¨ã€‚</p><h3 id=binlog_gtid_simple_recovery>binlog_gtid_simple_recovery</h3><p><img src=/p/mysql-gtid/binlog-gtid-simple-recovery.jpg width=573 height=217 srcset="/p/mysql-gtid/binlog-gtid-simple-recovery_hu_79291e933c1334db.jpg 480w, /p/mysql-gtid/binlog-gtid-simple-recovery_hu_e2c5b3fbe2aaea57.jpg 1024w" loading=lazy alt=binlog_gtid_simple_recovery class=gallery-image data-flex-grow=264 data-flex-basis=633px></p><p>æ§åˆ¶ MySQL å•Ÿå‹•æ™‚å¾ binlog å°‹æ‰¾ GTID çš„è¡Œç‚ºã€‚</p><h2 id=gtid-é™åˆ¶>GTID é™åˆ¶</h2><ol><li><p>ä¸èƒ½åœ¨ä¸€å€‹ Transaction ä¸­åŒæ™‚æ¶‰åŠ nontransactional å„²å­˜å¼•æ“ (ä¾‹å¦‚ï¼šMyISAM) å’Œ transactionalå„²å­˜å¼•æ“ (ä¾‹å¦‚ï¼šInnoDB) çš„è¡¨é€²è¡Œæ›´æ–°ã€‚</p></li><li><p>ä¸æ”¯æŒ sql_slave_skip_counterï¼Œé™¤é slave åœ¨ CHANGE MASTER æ™‚åŒ…å«äº† ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS æ‰èƒ½ä½¿ç”¨ sql_slave_skip_counterã€‚</p><p>å‚™è¨»ï¼šASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS è©²åŠŸèƒ½ç”¨ä¾†åœ¨æœªé–‹å•Ÿ GTID çš„ Master å’Œé–‹å•Ÿ GTID çš„ Slave é€²è¡Œ Replicationï¼Œä¸”æœƒç‚º Slave åŸ·è¡Œçš„ Transaction ç”Ÿæˆ GTIDã€‚</p></li><li><p>ä¸æ”¯æŒ CHANGE MASTER æ™‚ä½¿ç”¨ IGNORE_SERVER_IDS é¸é …ã€‚</p></li><li><p>åœ¨ MySQL 8.0.21 ä¹‹å‰ï¼Œä¸æ”¯æ´ <strong>CREATE TABLE &mldr; SELECT</strong> èªå¥ï¼Œå› ç‚ºè©²èªå¥åŸºæ–¼ STATEMENT æœƒç”¢ç”Ÿä¸€å€‹ GTIDï¼Œä½†ROW æ ¼å¼ç´€éŒ„æœƒç”¢ç”Ÿ 2 å€‹ GTIDï¼Œé€™æœƒå°è‡´ç„¡æ³•æ­£ç¢ºè™•ç† Transactionã€‚</p><p>åœ¨ MySQL 8.0.21 ä¹‹å¾Œï¼Œå› ç‚ºæ”¯æŒ atomic (åŸå­) DDL æ“ä½œï¼Œå› æ­¤ä¸å†æœ‰è©²é™åˆ¶ã€‚</p></li><li><p>åœ¨ MySQL 8.0.13 ä¹‹å‰ä¸èƒ½åœ¨ Transactionã€Proceduresã€Functions å’Œ Triggers å…§éƒ½ä¸èƒ½ä½¿ç”¨ CREATE/DROP TEMPORARY TABLEï¼Œåªèƒ½åœ¨é Transaction å…§ä¸” autocommit = 1 æ™‚æ‰èƒ½ä½¿ç”¨ã€‚</p><p>å¾ MySQL 8.0.13 é–‹å§‹ï¼Œç•¶ binlog_format è¨­ç½®ç‚º ROW æˆ– MIXED æ™‚ï¼Œåœ¨ä½¿ç”¨ GTID æ™‚å…è¨±ä½¿ç”¨ CREATE/DROP TEMPORARY TABLEï¼Œå› ç‚ºé€™äº›èªå¥å°‡ä¸æœƒå¯«å…¥ binlogã€‚</p></li><li><p>åœ¨ MySQL 8.0.16 ä¹‹å‰ï¼Œä¸èƒ½åœ¨ mysql_upgrade ä¸­åŠ ä¸Š <code>--write-binlog</code> é¸é …ã€‚</p><p>å¾ MySQL 8.0.16 é–‹å§‹ï¼ŒåŸ·è¡Œ mysql_upgrade æœŸé–“ç¸½æ˜¯æœƒè‡ªå‹•ç¦ç”¨ binlogï¼Œå› æ­¤æ²’æœ‰å•é¡Œã€‚</p></li></ol><h2 id=åœ¨ç·šé–‹å•Ÿ-gtid>åœ¨ç·šé–‹å•Ÿ GTID</h2><ol><li><p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>ENFORCE_GTID_CONSISTENCY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WARN</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¨­ç½®å¾Œè®“ MySQL æ¥å—æ­£å¸¸çš„æ“ä½œï¼Œä¸¦åœ¨æœŸé–“å¾ Error Log ç¢ºèªæ˜¯å¦æœ‰å‡ºç¾ GTID ä¸æ”¯æŒçš„ Queryï¼Œä¸¦å°å…¶é€²è¡Œä¿®æ­£ã€‚</p></li><li><p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>ENFORCE_GTID_CONSISTENCY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ON</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¨­ç½®å¾Œæ‰€æœ‰ GTID ä¸æ”¯æŒçš„æ“ä½œéƒ½å°‡è¢«æ‹’çµ•ã€‚</p></li><li><p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>GTID_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OFF_PERMISSIVE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¡¨ç¤º Master ç”Ÿæˆçš„æ˜¯ ANONYMOUS Transactionï¼ŒSlave å¯ä»¥æ‡‰ç”¨ ANONYMOUS ã€GTID Transactionã€‚</p><p>æ³¨æ„å‹™å¿…åœ¨æ‰€æœ‰ server éƒ½è¨­ç½®æ­¤æ­¥é©Ÿå¾Œï¼Œæ‰åŸ·è¡Œä¸‹ä¸€æ­¥é©Ÿã€‚</p></li><li><p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>GTID_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ON_PERMISSIVE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¡¨ç¤º Master ç”Ÿæˆçš„æ˜¯ GTID Transactionï¼ŒSlave å¯ä»¥æ‡‰ç”¨ ANONYMOUS ã€GTID Transactionã€‚</p></li><li><p>åœ¨æ‰€æœ‰çš„ MySQL server ä¸­ç¢ºå®šä»¥ä¸‹è®Šé‡ç‚º 0ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SHOW</span><span class=w> </span><span class=n>STATUS</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;ONGOING_ANONYMOUS_TRANSACTION_COUNT&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è©²å€¼å°±æ˜¯å°šæœª commit ANONYMOUS Transaction æ•¸é‡ï¼Œå› æ­¤å¿…é ˆç¢ºèªè©²å€¼ç‚º 0 è¡¨ç¤ºæ²’æœ‰ ANONYMOUS Transaction éƒ½æ˜¯ GTID Transaction ã€‚</p><ul><li>ONGOING_ANONYMOUS_TRANSACTION_COUNT å¢æ¸›çš„æ™‚æ©Ÿ<ul><li>åœ¨ Master ä¸Š<ul><li>å¢åŠ ï¼šç•¶ FLUSH éšæ®µåˆ†é… GTID æ™‚ï¼Œå¦‚æœç‚º ANONYMOUS Transaction å‰‡å¢åŠ è©²è¨ˆæ•¸ã€‚</li><li>æ¸›å°‘ï¼šåœ¨ COMMIT éšæ®µ InnoDB COMMIT ä¹‹å¾Œæœƒæ¸›å°‘è©²è¨ˆæ•¸ã€‚</li></ul></li><li>åœ¨ Slave ä¸Š<ul><li>å¢åŠ ï¼šç•¶ SQL Tread æ‡‰ç”¨åˆ° ANONYMOUS Transaction å‰‡å¢åŠ è©²è¨ˆæ•¸ã€‚</li><li>æ¸›å°‘ï¼šç•¶ SQL Tread åŸ·è¡Œ InnoDB COMMIT ä¹‹å¾Œæœƒæ¸›å°‘è©²è¨ˆæ•¸ã€‚</li></ul></li></ul></li></ul></li><li><p>ç•¶ ONGOING_ANONYMOUS_TRANSACTION_COUNT éƒ½ç‚º 0 çš„æ™‚å€™ï¼Œç¢ºèªæ‰€æœ‰ slave éƒ½æœ‰åŸ·è¡Œéå°æ‡‰ master binlog çš„ positionï¼Œä¸¦éæŒ‡ä¸èƒ½æœ‰å»¶é²åªæ˜¯è¦ç¢ºä¿æ‰€æœ‰çš„ ANONYMOUS Transaction éƒ½å·²ç¶“è¢«åŸ·è¡Œã€‚</p><p>åœ¨ Master ä»¥ä¸‹æŒ‡ä»¤ï¼Œ ç²å– Master binlogã€Master position</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=err>ç²å–</span><span class=w> </span><span class=n>Master</span><span class=w> </span><span class=n>binlog</span><span class=err>ã€</span><span class=n>Master</span><span class=w> </span><span class=k>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=n>STATUS</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ Slave åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œç¢ºèª slave æ˜¯å¦å·²åŸ·è¡Œ master å°æ‡‰çš„ binlog åŠ position</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=err>ç¢ºèª</span><span class=w> </span><span class=n>slave</span><span class=w> </span><span class=err>æ˜¯å¦å·²åŸ·è¡Œ</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=err>å°æ‡‰çš„</span><span class=w> </span><span class=n>binlog</span><span class=w> </span><span class=err>åŠ</span><span class=w> </span><span class=k>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>MASTER_POS_WAIT</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=k>position</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>å¦‚æœ binlog æœ‰ç”¨æ–¼ replication ä»¥å¤–çš„ç”¨é€” (ä¾‹å¦‚ï¼šåŸºæ–¼æ™‚é–“é»çš„å‚™ä»½å’Œæ¢å¾©)ï¼Œè«‹åœ¨æ­¤æ™‚ç¢ºä¿åŒ…å« ANONYMOUS Transaction çš„ Binlog å·²ä¸å†éœ€è¦ã€‚</p><p>ä¾‹å¦‚ï¼šåœ¨ç¬¬ 6 æ­¥å®Œæˆå¾Œï¼Œåœ¨å‚™ä»½æ©Ÿä¸ŠåŸ·è¡Œ flush logs å¾Œé€²è¡Œå‚™ä»½ã€‚</p></li><li><p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>GLOBAL</span><span class=p>.</span><span class=n>GTID_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ON</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨æ‰€æœ‰çš„ MySQL server çš„ my.cnf ä¸­æ·»åŠ </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>gtid_mode</span><span class=o>=</span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>enforce_gtid_consistency</span><span class=o>=</span><span class=k>ON</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ slave åŸ·è¡Œ change master</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>STOP</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=p>[</span><span class=k>FOR</span><span class=w> </span><span class=n>CHANNEL</span><span class=w> </span><span class=s1>&#39;channel&#39;</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CHANGE</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>MASTER_AUTO_POSITION</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>[</span><span class=k>FOR</span><span class=w> </span><span class=n>CHANNEL</span><span class=w> </span><span class=s1>&#39;channel&#39;</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>START</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=p>[</span><span class=k>FOR</span><span class=w> </span><span class=n>CHANNEL</span><span class=w> </span><span class=s1>&#39;channel&#39;</span><span class=p>];</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=gtid-ä¸­çš„ç¶­é‹>GTID ä¸­çš„ç¶­é‹</h2><h3 id=show-slave-status>SHOW SLAVE STATUS</h3><p>åœ¨é–‹å•Ÿ GTID å¾Œï¼Œé€é SHOW SLAVE STATUS æœƒå¢åŠ ä»¥ä¸‹è³‡è¨Šï¼š</p><ul><li><p>Retrieved_Gtid_Setï¼šSlave å¾ Master æ”¶åˆ°çš„ GTID SETï¼Œä¹Ÿå°±æ˜¯ IO_Thread å·²ç¶“æ¥æ”¶åˆ°çš„ GTIDã€‚</p><p>ç•¶ relay-log-recovery = 1 æˆ– RESET SLAVE æˆ– CHANGE MASTER æ™‚æœƒè¢«æ¸…ç©ºã€‚</p><p>ç•¶ relay-log-recovery = 0 æ™‚ï¼Œåœ¨ MySQL é‡å•Ÿæ™‚æœƒå¾ relay log ä¸­æƒæç¢ºèªã€‚</p></li><li><p>Executed_Gtid_Setï¼šSlave å·²ç¶“åŸ·è¡Œçš„ GTID SET (åŒ…å«ç›´æ¥åœ¨ slave ä¸ŠåŸ·è¡Œçš„èªå¥)ï¼Œç­‰åŒæ–¼ gtid_executedã€‚</p></li></ul><h3 id=æ¸…é™¤-gtid-æ­·å²ç´€éŒ„>æ¸…é™¤ GTID æ­·å²ç´€éŒ„</h3><p>å¦‚æœè¦å®Œå…¨æ¸…æ¥š GTID æ­·å²ç´€éŒ„å¯ä»¥ä½¿ç”¨ RESET MASTER æŒ‡ä»¤ã€‚</p><p>åŸ·è¡Œå‰å‹™å¿…å‚™ä»½ binlogã€binlog index æ–‡ä»¶ï¼Œç²å–ä¸¦ä¸”ä¿å­˜ gtid_executed è®Šé‡ã€‚</p><p>RESET MASTER åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>gtid_purged è¢«è¨­ç‚ºç©ºå­—ä¸²ã€‚</li><li>gtid_executed è¢«è¨­ç‚ºç©ºå­—ä¸²ã€‚</li><li>mysql.gtid_executed è¡¨è¢«æ¸…ç©ºã€‚</li><li>åˆªé™¤ç¾æœ‰ binlogï¼Œä¸¦æ¸…é™¤ binlog index æ–‡ä»¶ã€‚</li></ul><p>æ³¨æ„åªæœ‰ RESET MSTER æœƒé‡ç½® GTID çš„æ­·å²ç´€éŒ„ï¼ŒRESET SLAVE æ²’æœ‰ä»»ä½•å½±éŸ¿ã€‚</p><h3 id=è·³éä¸€å€‹-transaction>è·³éä¸€å€‹ Transaction</h3><p>ç•¶æœ‰ Transaction åœ¨ SQL_Thread ä¸­ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå¯ä»¥é€é performance_schema ä¸­çš„<code>replication_applier_status_by_worker</code> è©²è¡¨ä¸­çš„ APPLYING_TRANSACTION æ¬„ä½ç²å–è©² Transaction çš„ GTIDã€‚</p><p>ç•¶ç¢ºèªè¦è·³éè©²å¤±æ•—çš„ Transaction æ™‚ï¼Œåœ¨ GTID æ¨¡å¼ä¸‹å‚³çµ±çš„ sql_slave_skip_counter ä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>STOP</span><span class=w> </span><span class=n>SLAVE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>å°‡</span><span class=w> </span><span class=n>GTID_NEXT</span><span class=w> </span><span class=err>è¨­ç‚ºè¦è·³éçš„</span><span class=w> </span><span class=k>Transaction</span><span class=w> </span><span class=n>GTID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>GTID_NEXT</span><span class=o>=</span><span class=s1>&#39;aaa-bbb-ccc-ddd:N&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>å°‡è©²</span><span class=w> </span><span class=k>Transaction</span><span class=w> </span><span class=n>GTID</span><span class=w> </span><span class=err>è¨­ç‚ºä¸€å€‹ç©º</span><span class=w> </span><span class=k>Transaction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>GTID_NEXT</span><span class=o>=</span><span class=s1>&#39;AUTOMATIC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>START</span><span class=w> </span><span class=n>SLAVE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸Šè¿°æ­¥é©Ÿå¾Œæœƒå°‡è¦è·³éçš„ GTID è¨­ç‚ºä¸€å€‹ç©ºçš„ Transaction ä¸¦å°‡å…¶æ‡‰ç”¨ï¼Œæ­¤æ™‚ slave æœƒèªç‚ºè‡ªå·±å·²åŸ·è¡Œå®Œç•¢è©² GTIDï¼Œå› æ­¤å¯ä»¥å°‡ GTID_NEXT è¨­å› <code>AUTOMATIC</code> è®“ slave è‡ªè¡Œæ‰¾åˆ°ä¸‹ä¸€å€‹è¦åŸ·è¡Œçš„ GTIDã€‚</p><p>å¦‚æœæ˜¯æœ‰å¤šå€‹ channel çš„ slaveï¼Œcommit ä¸€å€‹ç©ºçš„ Transaction æ™‚ä¸éœ€è¦æŒ‡å®š channelï¼Œåªæœ‰åœ¨ START SLAVE æ‰éœ€è¦æŒ‡å®š channel åç¨±ã€‚</p><p>æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸é©ç”¨ ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS</p><p>åƒè€ƒ</p><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-administration-skip.html target=_blank rel=noopener>MySQL :: MySQL 8.0 Reference Manual :: 17.1.7.3 Skipping Transactions</a></p><h3 id=mysqldump-è¡Œç‚ºçš„è®ŠåŒ–>mysqldump è¡Œç‚ºçš„è®ŠåŒ–</h3><p>mysqldump åœ¨é–‹å•Ÿ gtid å¾Œé è¨­çš„ dump è¡Œç‚ºæœƒæœ‰æ‰€æ”¹è®Šï¼Œé€™æ˜¯å› ç‚º <code>--set-gtid-purged</code> è©²é¸é …é è¨­å€¼çš„å½±éŸ¿ï¼š</p><ul><li><p>AUTO (é è¨­å€¼)ï¼šåœ¨é–‹å•Ÿ GTID (gtid_mode = ON) æ™‚è‡ªå‹•è¨­ç‚º ONï¼Œåœ¨æœªé–‹å•Ÿ GTID (gtid_mode = OFF) æ™‚è‡ªå‹•è¨­ç‚º OFFã€‚</p></li><li><p>ONï¼šå‚™ä»½æª”ä¸­æœƒåŒ…å« <code>gtid_purgrd</code> ä¸”æœƒæ·»åŠ  <code>sql_log_bin = 0</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SET @MYSQLDUMP_TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;
</span></span><span class=line><span class=cl>SET @@SESSION.SQL_LOG_BIN= 0;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>-- GTID state at the beginning of the backup 
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SET @@GLOBAL.GTID_PURGED=&#39;42fe5059-32a7-11e6-9d29-000c29fcecda:1&#39;;
</span></span></code></pre></td></tr></table></div></div><p>é€™æ¨£çš„è¨­ç½®ä¸‹æœƒæœ‰ä»¥ä¸‹çµæœï¼š</p><ul><li>è¨­ç½® <code>sql_log_bin = 0</code>ï¼šé—œé–‰äº† binlog ç´€éŒ„ï¼Œå› æ­¤é‚„åŸçš„æ©Ÿå™¨ä¸æœƒç”Ÿæˆæ–°çš„ GTIDã€‚</li><li>è¨­ç½® <code>gtid_purgrd</code> ï¼šåŒæ™‚ä¹ŸæœƒåŒæ™‚ä¿®æ”¹ <code>gtid_executed</code> å€¼åŠ <code>mysql.gtid_executed</code> è¡¨ã€‚</li></ul><p>æ­¤è¨­ç½®é©åˆç”¨æ–¼é‚„åŸä¸€å€‹ slave æ¥ä¸Šå‚™ä»½æª”ä¾†æºçš„ replication topologyã€‚</p></li><li><p>OFFï¼šå‚™ä»½æª”ä¸­ä¸æœƒåŒ…å« <code>gtid_purgrd</code> ä¸”ä¸æœƒæ·»åŠ  <code>sql_log_bin = 0</code>ï¼Œæ­¤è¨­ç½®ç”¨æ–¼æœªé–‹å•Ÿ GTID çš„ MySQL æˆ–æ˜¯é©åˆæ–¼é‚„åŸä¸€å€‹å’ŒåŸæœ¬ replication topology ç„¡é—œçš„æ–° masterã€‚</p></li><li><p>COMMENTEDï¼šå¾ 8.0.17 é–‹å§‹å¯ç”¨ï¼Œå‚™ä»½æª”ä¸­æœƒæ·»åŠ  <code>sql_log_bin = 0</code>ï¼Œä¸¦åœ¨å‚™ä»½ä¸­ç”¨è¨»è§£çš„æ–¹å¼è¨˜éŒ„ <code>gtid_purgrd</code>ã€‚æ­¤æ–¹å¼è¼ƒç‚ºå½ˆæ€§é©åˆï¼Œç”¨æ–¼ä¸éœ€ç”Ÿæˆæ–°çš„ gtid (åŸºæœ¬ä¸Šè¡¨ç¤ºæœƒåœ¨åŒä¸€å€‹ replication topology) ä½†æƒ…å¢ƒè¼ƒç‚ºè¤‡é›œçš„éœ€è¦è‡ªè¡Œèª¿æ•´ <code>gtid_purgrd</code> æ™‚ï¼Œä¾‹å¦‚ï¼šé‚„åŸå¾Œçš„æ©Ÿå™¨æœƒæœ‰å¤šå€‹ channelã€‚</p></li></ul><p>å› æ­¤ç•¶é–‹å•Ÿ gtid å¾Œåœ¨ä½¿ç”¨ mysqldump æ™‚éœ€è¦æ³¨æ„ <code>--set-gtid-purged</code> çš„è¨­ç½®ï¼š</p><ul><li><p>ç•¶ <code>gtid_mode = OFF</code> æœªé–‹å•Ÿ GTID æ™‚ï¼Œå¯ä»¥ä¸éœ€è¦èª¿æ•´è©²åƒæ•¸æˆ–é¡¯å¼æŒ‡å®šç‚º OFFã€‚</p></li><li><p>ç•¶ <code>gtid_mode = ON</code> é–‹å•Ÿ GTID æ™‚ï¼Œè‹¥ç”¨æ–¼é‚„åŸåˆ°åŒä¸€å€‹ replication topology çš„æ©Ÿå™¨ï¼Œä¾‹å¦‚ï¼šæ–°å¢ä¸€å€‹ slaveã€ç‚º slave è£œä¸Šåœ¨ master binlog ä¸Šå·²ç¶“ purge çš„è³‡æ–™â€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥ä¿ç•™é è¨­å€¼æˆ–é¡¯å¼æŒ‡å®šç‚º <code>ON</code>ã€‚</p></li><li><p>ç•¶ <code>gtid_mode = ON</code> é–‹å•Ÿ GTID æ™‚ï¼Œä½†é‚„åŸåˆ°ä¸åŒ replication topology çš„æ©Ÿå™¨æˆ–éœ€è¦ç”Ÿæˆæ–°çš„ GTIDï¼Œä¾‹å¦‚ï¼šé‚„åŸæˆä¸€å€‹æ–°çš„ masterâ€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥è¨­ç½®ç‚º <code>OFF</code>ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœåœ¨åŒä¸€å€‹ replication topology ä¸­è¨­ç½® OFFï¼Œé™¤äº†å¯èƒ½ MS ç„¡æ³•é †åˆ©å»ºç½®ï¼Œä¹Ÿå¯èƒ½å°è‡´åœ¨ MS åˆ‡æ›æ™‚ æ–° Slave (åŸæœ¬çš„ Master) æœƒæ”¶åˆ° æ–° Master (åŸæœ¬çš„ Slave) é€éå‚™ä»½æª”é‚„åŸçš„è³‡æ–™å°è‡´é‡è¤‡åŸ·è¡Œçš„å•é¡Œã€‚</p></li><li><p>ç•¶ <code>gtid_mode = ON</code> é–‹å•Ÿ GTID æ™‚ï¼Œé›–ç„¶ä¸éœ€è¦ç”Ÿæˆæ–°çš„ GTID ä½†æƒ…æ³ç‰¹æ®Šéœ€è¦æ‰‹å‹•è¨­ç½® <code>gtid_purged</code> æ™‚ï¼Œä¾‹å¦‚ï¼šé‚„åŸçš„ Slave ä¸Šæœ‰å¤šå€‹ channel â€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥è¨­ç½®ç‚º <code>COMMENTED</code> å¾Œï¼Œæ ¹æ“šå¯¦éš›éœ€è¦æ‰‹å‹•èª¿æ•´è©²æ©Ÿå™¨çš„ <code>gtid_purgrd</code>ã€‚</p></li></ul><h3 id=replication-filter>Replication filter</h3><p>æ›¾ç¶“ç·šä¸Šç’°å¢ƒå¾å‚³çµ± Position é»ä½çš„ Replication åˆ‡æ›åˆ° GTID æ™‚ç™¼ç”Ÿäº†å•é¡Œ</p><p>Replication æ‹“æ¨¸çµæ§‹å¦‚ä¸‹ï¼š</p><ul><li>A Instance çš„ test database åŒæ™‚åŒæ­¥ B, C Instance</li><li>B Instance Replication çµ¦ Cï¼ŒåŒæ™‚è¨­ç½® Replicat_Do_DB ä¸åŒ…å« test database</li></ul><p>ç•¶åˆ‡æ›åˆ° GTID æ™‚ï¼Œæœƒå› ç‚ºä»¥ä¸‹æƒ…æ³ä¸Ÿå¤±è³‡æ–™ï¼š</p><ol><li><p>A åŸ·è¡Œå° test database çš„ç•°å‹• Query åŒæ­¥çµ¦ B, C</p></li><li><p>B æ”¶åˆ°ä¸¦åŸ·è¡Œ A å° test database çš„ç•°å‹• Query çµ¦ C</p></li><li><p>C æ”¶åˆ° B åŒæ­¥éä¾†çš„ Queryï¼Œä½†å› ç‚º Replicat_Do_DB çš„è¨­ç½®ï¼ŒC ä¸¦ä¸æœƒåŸ·è¡Œ B åŒæ­¥éä¾† test database ç•°å‹•èªæ³•ã€‚</p><p><strong>æ³¨æ„ï¼š å„˜ç®¡æ²’æœ‰çœŸçš„åŸ·è¡Œï¼Œä½†æ­¤æ™‚è©² GTID æœƒè¢«åŠ å…¥åˆ° C çš„ gtid_executed ä¸­</strong></p></li><li><p>C éš¨å¾Œæ”¶åˆ° A åŒæ­¥éä¾†çš„ test database ç•°å‹• Queryï¼Œä½†å› ç‚ºè©² GTID åœ¨æ­¥é©Ÿ 3 å·²ç¶“åŸ·è¡Œéï¼Œæ‰€ä»¥ç›´æ¥è·³éã€‚</p></li></ol><p>è§£æ±ºæ–¹æ¡ˆä¹Ÿå¾ˆç°¡å–®ï¼šç›´æ¥ç§»é™¤ B, C ä¹‹é–“çš„ replication filterï¼Œå› ç‚º GTID ä¸æœƒé‡è¤‡åŸ·è¡Œä¸ç”¨åƒå‚³çµ± Position ä¸€æ¨£éœ€è¦ filter é¿å…é‡è¤‡åŸ·è¡Œã€‚</p><p>æˆªè‡ªå®˜æ–¹æ–‡æª”èªªæ˜ï¼š</p><blockquote><p><strong>Important:</strong>
For a multi-source replica in a diamond topology (where the replica replicates from two or more sources, which in turn replicate from a common source), when GTID-based replication is in use, ensure that any replication filters or other channel configuration are identical on all channels on the multi-source replica. With GTID-based replication, filters are applied only to the transaction data, and GTIDs are not filtered out. This happens so that a replicaâ€™s GTID set stays consistent with the sourceâ€™s, meaning GTID auto-positioning can be used without re-acquiring filtered out transactions each time. In the case where the downstream replica is multi-source and receives the same transaction from multiple sources in a diamond topology, the downstream replica now has multiple versions of the transaction, and the result depends on which channel applies the transaction first. The second channel to attempt it skips the transaction using GTID auto-skip, because the transactionâ€™s GTID was added to theÂ <a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-gtids.html#sysvar_gtid_executed target=_blank rel=noopener><code>gtid_executed</code></a>Â set by the first channel. With identical filtering on the channels, there is no problem because all versions of the transaction contain the same data, so the results are the same. However, with different filtering on the channels, the database can become inconsistent and replication can hang.</p></blockquote><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-rules-channel-based-filters.html target=_blank rel=noopener>MySQL :: MySQL 8.0 Reference Manual :: 17.2.5.4 Replication Channel Based Filters</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/replication/>Replication</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸é—œæ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mysql-mts/><div class=article-details><h2 class=article-title>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</h2></div></a></article><article><a href=/p/mysql-replication-delay-observation-improve/><div class=article-details><h2 class=article-title>MySQL8.0 å°æ–¼ replication delay è§€æ¸¬æ”¹é€²</h2></div></a></article><article><a href=/p/mysql-implicit-lock/><div class=article-details><h2 class=article-title>éš±å¼é–</h2></div></a></article><article><a href=/p/mysql-group-commit/><div class=article-details><h2 class=article-title>Group Commit</h2></div></a></article><article><a href=/p/mysql-fulltext-index/><div class=article-details><h2 class=article-title>MySQL FullText Index(å…¨æ–‡æª¢ç´¢)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//å°å° DBA å€‹äººç­†è¨˜.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>