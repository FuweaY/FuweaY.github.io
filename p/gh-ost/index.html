<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="介紹 Github 開源的 MySQL Schema migration 工具"><title>gh-ost</title>
<link rel=canonical href=https://FuweaY.github.io/p/gh-ost/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="gh-ost"><meta property='og:description' content="介紹 Github 開源的 MySQL Schema migration 工具"><meta property='og:url' content='https://FuweaY.github.io/p/gh-ost/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='工具'><meta property='article:published_time' content='2024-10-16T12:00:00+08:00'><meta property='article:modified_time' content='2024-10-16T12:00:00+08:00'><meta name=twitter:title content="gh-ost"><meta name=twitter:description content="介紹 Github 開源的 MySQL Schema migration 工具"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐱</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>熱愛分享的 DBA 小天地</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>夜晚模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#how>HOW?</a></li><li><a href=#特點>特點</a></li><li><a href=#執行步驟>執行步驟</a></li><li><a href=#要求與限制>要求與限制</a></li><li><a href=#並發遷移concurrent-migrations>並發遷移(Concurrent migrations)</a></li><li><a href=#throttle>Throttle</a><ol><li><a href=#介紹>介紹</a></li><li><a href=#參數和因素>參數和因素</a><ol><li><a href=#replication-lag>Replication lag</a></li><li><a href=#status-thresholds>Status thresholds</a></li><li><a href=#throttle-query>Throttle query</a></li><li><a href=#http-throttle>HTTP Throttle</a></li><li><a href=#手動控制>手動控制</a></li></ol></li><li><a href=#throttle-precedence>Throttle precedence</a></li><li><a href=#throttle-status>Throttle status</a></li><li><a href=#可以-throttle-多久>可以 throttle 多久</a></li></ol></li><li><a href=#互動指令>互動指令</a><ol><li><a href=#interactive-interfaces>Interactive interfaces</a></li><li><a href=#known-commands>Known commands</a></li><li><a href=#querying-for-data>Querying for data</a></li><li><a href=#範例>範例</a></li></ol></li><li><a href=#cut-over-解析>Cut over 解析</a><ol><li><a href=#情境>情境</a></li><li><a href=#解析>解析</a></li><li><a href=#失敗的影響>失敗的影響</a></li></ol></li><li><a href=#hook>hook</a><ol><li><a href=#用途範例>用途範例</a></li><li><a href=#使用hook>使用hook</a></li><li><a href=#環境變量>環境變量</a></li><li><a href=#範例-1>範例</a></li></ol></li><li><a href=#方案比較與選擇>方案比較與選擇</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mysql/>MySQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/gh-ost/>gh-ost</a></h2><h3 class=article-subtitle>介紹 Github 開源的 MySQL Schema migration 工具</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 16, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>閱讀時間: 11 分鐘</time></div></footer></div></header><section class=article-content><p>本文較長建議搭配右側目錄點擊查看。</p><h2 id=how>HOW?</h2><p><img src=/p/gh-ost/How-gh-ost-work.png width=1724 height=772 srcset="/p/gh-ost/How-gh-ost-work_hu_a491c83ffc9ed16d.png 480w, /p/gh-ost/How-gh-ost-work_hu_cc0e77036e78be1.png 1024w" loading=lazy alt="How gh-ost work" class=gallery-image data-flex-grow=223 data-flex-basis=535px></p><ul><li>建立一張和原表結構相同的 <code>ghost</code> 表</li><li>ALTER <code>ghost</code> 表</li><li><code>gh-ost</code> 偽裝成 <code>SLAVE</code> 從 <code>Master/Slave</code> 拉取 <code>binlog</code></li><li>將資料寫入 <code>ghost</code> 表<ul><li>將 <code>binlog event</code> 應用到 <code>ghost</code> 表</li><li>從原表複製 <code>rows</code> 到 <code>ghost</code> 表</li></ul></li><li>切換 <code>ghost</code> 表和原表</li></ul><p>上述的步驟中可以看出 <code>gh-ost</code> 的大部分和其他online DDL 工具大體相同，唯一的不同處就是 <code>gh-ost</code> 不是基於 <code>trigger</code> 。 <code>gh-ost</code> 的開發團隊認為使用 <code>trigger</code> 有許多的限制與風險，有興趣可以參考官方文檔 <a class=link href=https://github.com/github/gh-ost/blob/master/doc/why-triggerless.md target=_blank rel=noopener>Why triggerless</a> 這篇說明。</p><p>取而代之的是 <code>gh-ost</code> 透過 <code>binlog</code> 來獲取原表資料的改動，並將之異步應用到 <code>ghost</code> 表。 <code>gh-ost</code> 承擔了其他工具留給 DATABASE 執行的任務(<code>trigger</code>)，等於是完全分離了遷移資料時的寫Loading和 DATABASE 服務本身的 Loading，因此 <code>gh-ost</code> 可能更好的控制整個遷移的過程，可以做到真正的暫停。</p><h2 id=特點>特點</h2><ul><li>No <code>trigger</code>：這是 <code>gh-ost</code>的特點，基於 <code>trigger</code>的方案會對 <code>MySQL</code>的性能造成較大的影響。 <code>gh-ost</code> 解析 <code>binlog</code> 後寫入數據，不僅可控對 <code>MySQL</code> 的性能影響也很小。</li><li>真正的暫停：當 <code>gh-ost</code>進入 <code>throttle</code>狀態時， <code>gh-ost</code> 真正停止了對 <code>MASTER</code> 的寫入(除了必要的低負載的心跳紀錄)，讓 <code>MASTER</code> 可以回到原始的 Loading 狀態。</li><li>動態控制：即使已經開始運行 <code>gh-ost</code>，也可以透過 <code>交互式命令</code> 隨時重新配置 <code>gh-ost</code> 部分參數，甚至你可以強制讓 <code>gh-ost</code> 進入 <code>throttle</code> 狀態。</li><li>可審核：可以透過 <code>unix socket</code>、 <code>TCP</code> 或 <code>table _ghc</code> 查詢 <code>gh-ost</code> 狀態。</li><li>可測試： <code>gh-ost</code> 可以在 <code>SLAVE</code> 進行遷移，用以觀察 Loading 和 正確性後再投入使用。</li><li>控制切換階段： <code>cut over</code> 是 <code>gh-ost</code> 最關鍵的一個步驟，你可以隨時決定 <code>cut over</code> 的時間。</li><li>外部 hook： <code>gh-ost</code> 提供 <code>hook</code> 功能，例如：可以用於推送到 <code>SLACK</code> 群組告知進度。</li></ul><h2 id=執行步驟>執行步驟</h2><p>初始步驟檢查一下參數，並新增兩張表 <code>ghost table(_gho)</code>、 <code>log&amp;heartbeat table(_ghc)</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- SLAVE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>autocommit</span><span class=o>=</span><span class=k>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=k>NAMES</span><span class=w> </span><span class=n>utf8mb4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=k>version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=n>grants</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>current_user</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>log_bin</span><span class=p>,</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>binlog_format</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>binlog_row_image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;event_1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>autocommit</span><span class=o>=</span><span class=k>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=k>NAMES</span><span class=w> </span><span class=n>utf8mb4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=k>version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>time_zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>columns</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;_event_1_gho&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;_event_1_del&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>drop</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_ghc</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_ghc</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=n>auto_increment</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>last_update</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>hint</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=n>charset</span><span class=w> </span><span class=n>ascii</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>value</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span><span class=w> </span><span class=n>charset</span><span class=w> </span><span class=n>ascii</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=n>hint_uidx</span><span class=p>(</span><span class=n>hint</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>auto_increment</span><span class=o>=</span><span class=mi>256</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>alter</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>AFTER</span><span class=w> </span><span class=n>remark</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>根據 <code>exact-rowcount</code> 的設定來決定計算行數的方式，在 <code>Slave</code> 執行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>--no exact-rowcount：透過explian取得估算值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>explain</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=mi>1</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--exact-rowcount：透過count(*)取得精準值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通過 <code>order by</code> 來取得 <code>shared key</code> 最小值和最大值範圍</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>透過以下語法判斷是否還有未複製的資料</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1>-- 假設每次批次為1000筆
</span></span></span><span class=line><span class=cl><span class=c1>-- 取得每次批次的第1000、2000...筆order_id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w>  </span><span class=cm>/* gh-ost `ghost_test`.`event_1` iteration:0 */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;00AD4267F1A3467&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;00AD4267F1A3467&#39;</span><span class=p>)))</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>and</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>asc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>offset</span><span class=w> </span><span class=mi>999</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 若上述sql返回空值，則使用此語法撈取最後一筆order_id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` iteration:1 */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>select</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>where</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FE01373BB55A45F&#39;</span><span class=p>))</span><span class=w> </span><span class=k>and</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>select_osc_chunk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>當有未複製的資料，透過下面的方式從原表複製資料到 <code>ghost table</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>insert</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` */</span><span class=w> </span><span class=k>ignore</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>site_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>game_hall</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>op_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>amount</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>remark</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>create_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=o>`</span><span class=n>site_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>game_hall</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>op_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>amount</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>remark</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>create_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>force</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=k>PRIMARY</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=p>(((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>)))</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>and</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>))))</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>lock</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>share</span><span class=w> </span><span class=k>mode</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>最後一步<code>cut-over</code> 階段</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>create</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>id</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=n>auto_increment</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>engine</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>comment</span><span class=o>=</span><span class=s1>&#39;ghost-cut-over-sentry&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>lock</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>write</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=k>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>host_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=w> </span><span class=k>write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>rename</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>drop</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>drop</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_ghc</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>unlock</span><span class=w> </span><span class=n>tables</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>讓我們整理一下 gh-ost 的操作：</p><div class=table-wrapper><table><thead><tr><th>應用類型</th><th>原表操作</th><th>新表操作</th></tr></thead><tbody><tr><td>Row Copy</td><td>SELECT</td><td>INSERT IGNORE INTO</td></tr><tr><td>Binlog Apply</td><td>INSERT</td><td>REPLACE INTO</td></tr><tr><td>Binlog Apply</td><td>UPDATE</td><td>UPDATE (所有欄位）</td></tr><tr><td>Binlog Apply</td><td>DELETE</td><td>DELETE</td></tr></tbody></table></div><p>在數據遷移的過程中，數據的變動有以下三種組合：</p><ul><li>從原表 <code>RowCopy</code> → 對 <code>原表DML</code>操作 → <code>Binlog Apply</code><ul><li>在此情況下一切都照順序運行，因此不論是 <code>INSERT</code>、 <code>UPDATE</code>、 <code>DELETE</code> 都沒有疑慮。</li></ul></li><li>對 <code>原表DML</code>操作 → <code>Binlog Apply</code> → 從原表 <code>RowCopy</code><ul><li><code>INSERT</code>： <code>Row Copy</code> 被轉換為 <code>INSERT INGNORE INTO</code>，因此不會蓋掉 <code>Binlog Apply</code> 的 <code>INSERT</code> 操作。</li><li><code>UPDATE、DELETE</code>：因為還沒從原表 <code>Copy</code> 過來，所以 <code>Binlog Apply</code> 的操作會沒有任何結果，但是最後從原表 <code>Copy</code> 過來時即會是最新的數據，因此也沒有問題。</li></ul></li><li>對 <code>原表DML</code> 操作 → 從原表 <code>RowCopy</code> → <code>Binlog Apply</code><ul><li><code>INSERT</code>： <code>Binlog Apply:INSERT</code>被轉換為 <code>REPLACE INTO</code>，會覆蓋掉 <code>Row Copy:INSERT</code> 操作，但兩者的結果一樣因此不影響。</li><li><code>UPDATE、DELETE</code>：從原表 <code>Copy</code> 過來就是最新的數據，後續的 <code>Binlog Apply</code> 也不會影響到數據，因此也沒有問題。</li></ul></li></ul><h2 id=要求與限制>要求與限制</h2><p>Requirements 要求：</p><ul><li><code>gh-ost</code> 需要在 MySQL 5.7 以上的版本上運行</li><li>server 必須開啟 <code>log_bin</code>，若為 Slave 同時也必須開啟 <code>log_slave_updates</code></li><li>需要一台 <code>binlog_format</code> 為 <code>ROW</code> 及 <code>binlog_row_image</code> 為 <code>full</code> 模式的 server</li><li>如果在slave上使用，必須確保要ALTER的TABLE在Master和Slave上Schema相同</li><li>權限：<ul><li>ALTER, CREATE, DELETE, DROP, INDEX, INSERT, LOCK TABLES, SELECT, TRIGGER, UPDATE ON database.* OR <code>*.*</code></li><li>SUPER, REPLICATION SLAVE on <code>*.*</code> 或 REPLICATION CLIENT, REPLICATION SLAVE on <code>*.*</code><blockquote><p><code>SUPER</code>權限用於 <code>STOP SLAVE</code> 和 <code>START SLAVE</code>，具體用途為：</p><ol><li>當 <code>binlog_format</code>不是 <code>ROW</code> 並且指定 <code>--switch-to-rbr</code> 時，將切換 <code>binlog_format</code> 並重啟 replication。如果是 <code>ROW</code> 模式可以指定 <code>--assume-rbr</code> 避免 <code>STOP SLAVE</code> 和 <code>START SLAVE</code> ，在此情況下，不需要提供 <code>SUPER</code> 權限。
(提醒！若自行切換 <code>binlog_format</code> 須記得重啟replication！)</li><li>運行 <code>--test-on-replica</code> 時，gh-ost切換表後會停止 <code>replication</code> ，讓使用者比較兩張表。</li></ol></blockquote></li></ul></li></ul><p>Limitations 限制：</p><ul><li>目前不支持外鍵。未來可能會提供一定程度的支持</li><li>目前不支持trigger。未來可能會提供支持</li><li>支持MySQL 5.7的 <code>JSON</code> ，但前提是不能是 <code>PRIMARY KEY</code> 的一部分</li><li>新表和舊表必須使用相同的 <code>PRIMARY KEY</code> 或 <code>UNIQUE KEY</code> 。因為複製時會 <code>gh-ost</code> 會利用該 KEY遍歷所有行。遷移鍵必須為 <code>NOT NULL</code> (可以為空值)。或是有 <code>NULL屬性</code> 並使用 <code>--allow-nullable-unique-key</code> 但必須確保實際上沒有 <code>NULL</code> 值，否則可能導致數據不完整。</li><li>當存在名稱相同僅大小寫不同的table時無法進行</li><li>阿里雲RDS能正常運作，僅需要添加 <code>--aliyun-rds</code></li><li>Google Cloud SQL可使用，僅需添加 <code>--gcp</code></li><li>Amazon RDS可以使用，但有些限制，請參閱<a class=link href=https://github.com/github/gh-ost/blob/master/doc/rds.md target=_blank rel=noopener>官方文檔</a></li><li>當 <code>SLAVE</code> 的來源為multi時，無法支持在 <code>SLAVE</code> 上執行，建議直接在 <code>MASTER</code>上進行，需添加 <code>--allow-on-master</code></li><li>目前當在 <code>master-master</code> 運行 <code>gh-ost</code> 時，沒有辦法支援兩邊都有寫入的情況。將來可能支援</li><li>若將 <code>enum</code> 型態的欄位作為 <code>PRIMARY KEY</code> 將使性能降低</li><li>不支援 <code>federated Table</code> ，並且與 <code>gh-ost</code> 想要解決的方案無關</li><li>不支持 <code>ALTER TABLE ... RENAME TO some_other_name</code> ，這樣的操作不應該是用 <code>gh-ost</code></li></ul><h2 id=並發遷移concurrent-migrations>並發遷移(Concurrent migrations)</h2><ul><li>絕對不要運行在同一個 <code>Table</code> 上。</li><li>如果運行在不同的 <code>SLAVE</code> 上，不需要其他調整。例如：table1 on slave1 和 table2 on slave2。</li><li>如果在同一個機器運行 <code>gh-ost</code><ul><li>確保 <code>-server-socket-file</code> 設置不同名稱（或由 <code>gh-ost</code> 命名）。</li><li>透過 <code>-throttle-additional-flag-file</code> 控制所有 <code>gh-ost</code>，另外透過 <code>throttle-flag-file</code> 控制單一 <code>gh-ost</code> 。</li></ul></li><li>如果 <code>-host</code> 相同，則必須對每個 <code>gh-ost</code> 設定唯一的 <code>replica-server-id</code> 避免衝突。</li></ul><h2 id=throttle>Throttle</h2><h3 id=介紹>介紹</h3><p>在遷移的過中， <code>gh-ost</code> 的狀態除了持續的複製原表和應用binlog外，還有另一個狀態是 <code>throttling</code></p><p>當 <code>throttled(限制)</code> 的時候， <code>gh-ost</code> 會暫停所有寫操作，包含複製原表的資料和檢查binlog，但仍會做 <code>low-volume changlog status writes</code> 和 <code>heartbeat writes</code> 。</p><p>當 <code>gh-ost</code> 被限制時，對主機的 Loading 將徹底消失，和基於 <code>trigger</code> 原理的工具相比這是 <code>gh-ost</code> 的優勢，因為 <code>trigger</code> 無法暫停會持續的寫入新資料，相反的 <code>gh-ost</code> 包含複製原表資料和寫入新資料（透過應用 <code>binlog event</code>）都是由 <code>gh-ost</code> 進行控制。</p><p><code>gh-ost</code> 支持各種限制的方法，並且他能允許使用者動態的調整。</p><h3 id=參數和因素>參數和因素</h3><h4 id=replication-lag>Replication lag</h4><p>推薦將 <code>gh-ost</code> 連結到 <code>Slave</code>， <code>gh-ost</code> 會自行找出 <code>Master</code> 開始進行遷移的同時， <code>gh-ost</code> 有自己的心跳機制去檢查他所連接的 <code>Slave</code> 是否有 <code>replication lag</code> 的狀況。或者也可以自行指定要檢查 <code>replication lag</code> 的清單。</p><ul><li><p><code>--throttle-control-replicas</code> ：明確列出需要 <code>gh-ost</code> 檢查 <code>replication lag</code> 的 <code>Slave</code> 清單
範例：&ndash;throttle-control-replicas=myhost1.com:3306,myhost2.com,myhost3.com:3307</p></li><li><p><code>--max-lag-millis</code>：允許 <code>replication lag</code> 的最大值，任何在檢查清單中的 <code>replication lag</code> 超過此值都將導致 <code>throttling</code>，除非清單中的所有 <code>replication lag</code> 都小於此值才會恢復。</p></li></ul><p>以上設定可以透過 <code>Interaction commands</code> 來隨時動態調整。</p><h4 id=status-thresholds>Status thresholds</h4><p><code>--max-load</code> ：當指定的指標超過設定的閾值時，將導致 <code>throttling</code> 發生。</p><p>範例：&ndash;max-load=&lsquo;Threads_running=100,Threads_connected=500&rsquo;</p><p>指標必須是有效且為數字的 <a class=link href=https://dev.mysql.com/doc/refman/5.7/en/server-status-variables.html target=_blank rel=noopener><code>status variables</code></a> (可參考mysql 官網)</p><h4 id=throttle-query>Throttle query</h4><p>當提供 <code>--throttle-query</code> 時，必須確保返回整數，每秒會執行該查詢(因此應確保此查詢為輕量的)，當返回值 <code>> 0</code> 時 <code>gh-ost</code> 將進入 <code>throttling</code> 狀態；反之當返回值 <code>&lt;= 0</code> 時且沒有其他限制因素時，則 <code>gh-ost</code> 正常運作</p><p>範例：&ndash;throttle-query=&ldquo;select hour(now()) between 8 and 17&rdquo; 表示 <code>8:00am</code> 開始進入 <code>throttling</code> 狀態，直到 <code>18:00pm</code> 解除。</p><h4 id=http-throttle>HTTP Throttle</h4><p>The <code>--throttle-http</code> flag allows for throttling via HTTP. Every 100ms <code>gh-ost</code> issues a <code>HEAD</code> request to the provided URL. If the response status code is not <code>200</code> throttling will kick in until a <code>200</code> response status code is returned.</p><p>If no URL is provided or the URL provided doesn&rsquo;t contain the scheme then the HTTP check will be disabled. For example <code>--throttle-http="http://1.2.3.4:6789/throttle"</code> will enable the HTTP check/throttling, but <code>--throttle-http="1.2.3.4:6789/throttle"</code> will not.</p><p>The URL can be queried and updated dynamically via <a class=link href=https://github.com/github/gh-ost/blob/master/doc/interactive-commands.md target=_blank rel=noopener>interactive interface</a>.</p><h4 id=手動控制>手動控制</h4><p>除了以上的自動控制，還可以隨時手動讓 <code>gh-ost</code> 進入 <code>throttling</code> 狀態。</p><ul><li><p><code>--throttle-flag-file</code> ：當該文件存在時，進入 <code>throttling</code> 狀態。可以使用 <code>touch</code> 建立即可</p></li><li><p><code>--throttle-additional-flag-file</code> ：與上述類似，當該文件存在時，進入 <code>throttling</code> 狀態。</p><p>默認值為： <code>/tmp/gh-ost.throttle</code></p><p>有兩種參數的原因是可以運行多個 <code>gh-ost</code> ，<code>--throttle-flag-file</code> 為單個 <code>gh-ost</code> 所使用，<code>--throttle-additional-flag-file</code> 則是同時控制所有 <code>gh-ost</code> ，因此我們可以透過 <code>touch</code> 不同的文件來限制單個或多個 <code>gh-ost</code></p></li><li><p>透過 <code>Interactive commands</code> 對 <code>gh-ost</code> 下達 <code>throttle</code></p><p>範例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> throttle <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=nb>echo</span> no-throttle <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=throttle-precedence>Throttle precedence</h3><p>上述提到的任何因素都將導致 <code>gh-ost</code> 進入 <code>throttling</code> 狀態，因此一旦其中一個因素引發 <code>throttling</code> 你都無法強制繼續執行遷移。</p><p><code>gh-ost</code> 會在不同的時間點獨立收集不同的指標，並異步檢查不同的指標是否有達到閾值，因此 <code>gh-ost</code> 只會返回第一個超過閾值的指標作為 <code>throttling</code> 原因。</p><h3 id=throttle-status>Throttle status</h3><p><code>throttle</code> 狀態會作為 <code>status message</code> 定期的 <code>print</code> 出來：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 41s<span class=o>(</span>copy<span class=o>)</span>, 41s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000551:47983<span class=p>;</span> ETA: throttled, flag-file
</span></span><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 42s<span class=o>(</span>copy<span class=o>)</span>, 42s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000551:49370<span class=p>;</span> ETA: throttled, commanded by user
</span></span></code></pre></td></tr></table></div></div><h3 id=可以-throttle-多久>可以 throttle 多久</h3><p>最長可以維持 <code>throttle</code> 狀態的時間依賴於 <code>binlog</code> 保留的時間，因為當進入 <code>throttling</code> 狀態時， <code>gh-ost</code> 將暫停讀取 <code>binlog</code> ，之後恢復會從同一個 <code>binlog</code> 開始。</p><p><code>binlog</code> 保留時間通常透過 <code>expire_logs_days</code> 設定，或者是其他外部腳本，因此必須先確認機器上的部屬，另外雖然 <code>binlog</code> 保留多久 <code>gh-ost</code> 就能 <code>throttle</code> 多久，但是在此期間 <code>gh-ost</code> 必須一直運行，並且相應的當恢復之後需要應用相當大量的 <code>binlog event</code> 。</p><h2 id=互動指令>互動指令</h2><p><code>gh-ost</code> 允許用戶在運行時控制其行為</p><h3 id=interactive-interfaces>Interactive interfaces</h3><p><code>gh-ost</code> 可以透過以下方式進行監聽：</p><ul><li>UNIX socket file： <code>gh-ost</code> 運行時會產生 <code>socket file</code> 也可以透過 <code>--server-socket-file</code> 指定位置。</li><li>TCP：需要帶入 <code>--server-tcp-port</code> 參數</li></ul><h3 id=known-commands>Known commands</h3><ul><li><code>help</code>：提示可以使用的命令</li><li><code>status</code>：返回遷移的進度，和詳細的狀態</li><li><code>sup</code>：返回遷移進度的簡要狀態</li><li><code>coordinates</code>：返回被檢查 binlog 的 server，最新的position位置</li><li><code>chunk-size=&lt;newsize></code>：修改 <code>chunk-size</code>，將在下一次 <code>copy-iteration</code> 生效</li><li><code>dml-batch-size=&lt;newsize></code>：修改 <code>dml-batch-size</code>，將在下一次應用 <code>binlog event</code> 生效</li><li><code>max-lag-millis=&lt;max-lag></code>：調整 <code>max-lag-millis</code> 的配置</li><li><code>max-load=&lt;max-load-thresholds></code>：修改 <code>max-load</code> 的配置，將在下一次 <code>copy-iteration</code> 生效</li><li><code>critical-load=&lt;critical-load-thresholds></code>：修改 <code>critical-load</code> 的配置</li><li><code>nice-ratio=&lt;ratio></code>：修改 <code>nice-ratio</code> 比例</li><li><code>throttle-http</code>：change throttle HTTP endpoint</li><li><code>throttle-query</code>：修改 throttle query</li><li><code>throttle-control-replicas='replica1,replica2'</code>：修改 throttle control replicas</li><li><code>throttle</code>：強制進入 throttle 狀態</li><li><code>no-throttle</code>：取消強制進入 throttle 狀態，但仍會受其他因素暫停</li><li><code>unpostpone</code>：在 <code>gh-ost</code> 推遲 <code>cut-over</code> 階段時，只是 <code>gh-ost</code> 停止推遲並立刻 <code>cut-over</code></li><li><code>panic</code>：立即 <code>panic</code> 並停止操作</li></ul><h3 id=querying-for-data>Querying for data</h3><p>對於上述命令在傳遞參數時，設置為 <code>?</code> 時，可以查詢數據</p><h3 id=範例>範例</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> status <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=c1># Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst`</span>
</span></span><span class=line><span class=cl><span class=c1># Migration started at Tue Jun 07 11:45:16 +0200 2016</span>
</span></span><span class=line><span class=cl><span class=c1># chunk-size: 200; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20]</span>
</span></span><span class=line><span class=cl><span class=c1># Throttle additional flag file: /tmp/gh-ost.throttle</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on TCP port: 10001</span>
</span></span><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 40s<span class=o>(</span>copy<span class=o>)</span>, 41s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000550:49942<span class=p>;</span> ETA: throttled, flag-file
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;chunk-size=250&#34;</span> <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=c1># Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst`</span>
</span></span><span class=line><span class=cl><span class=c1># Migration started at Tue Jun 07 11:56:03 +0200 2016</span>
</span></span><span class=line><span class=cl><span class=c1># chunk-size: 250; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20]</span>
</span></span><span class=line><span class=cl><span class=c1># Throttle additional flag file: /tmp/gh-ost.throttle</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on TCP port: 10001</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;chunk-size=?&#34;</span> <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=m>250</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> throttle <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> status <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=c1># Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst`</span>
</span></span><span class=line><span class=cl><span class=c1># Migration started at Tue Jun 07 11:56:03 +0200 2016</span>
</span></span><span class=line><span class=cl><span class=c1># chunk-size: 250; max lag: 1500ms; max-load: map[Threads_connected:20]</span>
</span></span><span class=line><span class=cl><span class=c1># Throttle additional flag file: /tmp/gh-ost.throttle</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on TCP port: 10001</span>
</span></span><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 59s<span class=o>(</span>copy<span class=o>)</span>, 59s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000551:68067<span class=p>;</span> ETA: throttled, commanded by user
</span></span></code></pre></td></tr></table></div></div><h2 id=cut-over-解析>Cut over 解析</h2><h3 id=情境>情境</h3><p>假設 <code>C10、C20</code> 為 <code>gh-ost</code> 所使用的連結， <code>C1..C9</code>、 <code>C11..C19</code>、 <code>C21..C29</code> 為其他連線。</p><ul><li><code>C1..C9</code>：對 <code>原表(tb1)</code> 進行 <code>INSERT、UPDATE、DELETE</code> 等DML操作</li><li><code>C10</code>： <code>CREATE TABLE tb1_old(id int primary key) COMMENT='magic-be-here'</code></li><li><code>C10</code>： <code>LOCK TABLES tb1 WRITE, tb1_old WRITE</code></li><li><code>C11..C19</code>：新的連線對 <code>tb1</code>進行DML操作，但由於 <code>tb1</code>被 <code>LOCK</code>住而阻塞</li><li><code>C20</code>： <code>RENAME TABLE tbl TO tbl_old, ghost TO tbl</code>，雖然因為 <code>LOCK</code> 此操作會被阻塞，但在阻塞的對列中優先級會高於 <code>C1..C9</code> 和 <code>C11..C19</code></li><li><code>C21..C29</code>：新的連線對 <code>tb1</code>進行DML操作，但由於 <code>tb1</code>被 <code>LOCK</code>住而阻塞</li><li><code>C10</code>：透過 <code>show processlist</code> 確認是否有 <code>C20的RENAME</code> 操作</li><li><code>C10</code>： <code>DROP TABLE tbl_old</code>，什麼事都沒有發生 <code>tb1</code> 仍舊被 <code>LOCK</code></li><li><code>C10</code>： <code>UNLOCK TABLES</code></li></ul><p>最後，阻塞的對列中 <code>RENAME</code> 優先被執行，接下來是 <code>C1..C9</code> <code>C11..C19</code> <code>C21..C29</code> 都直接應用到更新後的 <code>tb1</code>。</p><h3 id=解析>解析</h3><ul><li>在 <code>MySQL</code> 中有兩種方式可以 <code>RENAME TABLE</code>：<ol><li><code>RENAME TABLE</code>：能夠同時 <code>rename</code>多張表，這表示 <code>rename</code>多張表是原子的操作。但在 <code>8.0.13</code> 之前無法在同一個 session 同時 <code>LOCK</code>和 <code>RENAME</code>。</li><li><code>ALTER TABLE RENAME</code>：能夠在 <code>LOCK TABLE</code> 的 session 進行，但卻無法一次 <code>RENAME</code>多張表。</li></ol></li><li><code>tb1_old</code>的存在，避免 <code>Lock</code>連線死掉後的影響。</li><li><code>Lock Table</code> 避免 <code>RENAME</code> 過早執行。</li><li>在阻塞的對列中， <code>RENAME</code>總是優先於 <code>INSERT、UPDATE、DELETE</code>。</li></ul><h3 id=失敗的影響>失敗的影響</h3><ol><li>如果在 <code>C10 Create table 或 Lock table</code>失敗，則不會繼續執行後續步驟。</li><li>如果在 <code>C20 Rename</code>時 <code>C10 Lock連線死亡</code>，因為 <code>tb1_old</code>的存在 <code>Rename</code>失敗，同時 <code>Lock</code> 解除， <code>C1..C9</code>和 <code>C11..C19</code>正常執行，唯一的影響只有查詢被阻塞了一段時間。</li><li>如果 <code>C20 Rename</code>在 <code>C10 Drop 或 Unlock</code>之前死亡， <code>gh-ost</code>會正常執行 <code>Drop、UnLock</code>，因此唯一的影響一樣只是查詢被阻塞一段時間。</li></ol><h2 id=hook>hook</h2><h3 id=用途範例>用途範例</h3><ul><li>希望遷移完成/失敗時，能夠收到通知</li><li>希望當 <code>gh-ost</code> 開始推遲 <code>cut-over</code> 時收到通知</li><li>希望 <code>gh-ost</code> 定期回報進度</li></ul><h3 id=使用hook>使用hook</h3><p>所有的hook都應該放在 <code>--hooks-path</code> 指定的目錄裡，如果沒有提供則不執行 hook。</p><p>hook的命名必須為以下前綴：</p><ul><li><code>gh-ost-on-startup</code></li><li><code>gh-ost-on-validated</code></li><li><code>gh-ost-on-rowcount-complete</code></li><li><code>gh-ost-on-before-row-copy</code></li><li><code>gh-ost-on-status</code></li><li><code>gh-ost-on-interactive-command</code></li><li><code>gh-ost-on-row-copy-complete</code></li><li><code>gh-ost-on-stop-replication</code></li><li><code>gh-ost-on-start-replication</code></li><li><code>gh-ost-on-begin-postponed</code></li><li><code>gh-ost-on-before-cut-over</code></li><li><code>gh-ost-on-success</code></li><li><code>gh-ost-on-failure</code></li></ul><h3 id=環境變量>環境變量</h3><ul><li><code>GH_OST_DATABASE_NAME</code></li><li><code>GH_OST_TABLE_NAME</code></li><li><code>GH_OST_GHOST_TABLE_NAME</code></li><li><code>GH_OST_OLD_TABLE_NAME</code>：原始表在 cut-over 之後的名稱</li><li><code>GH_OST_DDL</code>：DDL 語句</li><li><code>GH_OST_ELAPSED_SECONDS</code>：總運行時間</li><li><code>GH_OST_ELAPSED_COPY_SECONDS</code>：Row copy 花費的時間</li><li><code>GH_OST_ESTIMATED_ROWS</code>：估計的行數</li><li><code>GH_OST_COPIED_ROWS</code>：gh-ost 複製的行數</li><li><code>GH_OST_INSPECTED_LAG</code>：replication lag (second)</li><li><code>GH_OST_PROGRESS</code>：遷移的進度 [0&mldr;100] %</li><li><code>GH_OST_MIGRATED_HOST</code></li><li><code>GH_OST_INSPECTED_HOST</code></li><li><code>GH_OST_EXECUTING_HOST</code></li><li><code>GH_OST_HOOKS_HINT</code>： <code>--hooks-hint</code>的值</li><li><code>GH_OST_HOOKS_HINT_OWNER</code>： <code>--hooks-hint-owner</code>的值</li><li><code>GH_OST_HOOKS_HINT_TOKEN</code>：<code>--hooks-hint-token</code>的值</li><li><code>GH_OST_DRY_RUN</code>： <code>gh-ost</code> 是否是 <code>dry run</code></li><li><code>GH_OST_COMMAND</code>：only available in gh-ost-on-interactive-command</li><li><code>GH_OST_STATUS</code>：only available in gh-ost-on-status</li></ul><h3 id=範例-1>範例</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># 當gh-ost啟動時推送到slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推送到slack</span>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Start] - gh-ost 已開始熱更新 :gh-ost:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Start_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39; &#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-status</span>
</span></span><span class=line><span class=cl><span class=c1># gh-ost 推送狀態到 slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=o>=</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_STATUS</span><span class=o>=</span><span class=nv>$GH_OST_STATUS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_PROGRESS</span><span class=o>=</span><span class=nv>$GH_OST_PROGRESS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 計算每分鐘平均進度</span>
</span></span><span class=line><span class=cl><span class=nv>cycle_calc</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=p>|</span> awk <span class=s2>&#34;{print </span><span class=nv>$GH_OST_PROGRESS</span><span class=s2>/</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span><span class=s2>*60}&#34;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=c1># 計算上一分鐘的進度</span>
</span></span><span class=line><span class=cl><span class=nv>last_progress</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=p>|</span> awk <span class=s2>&#34;{print </span><span class=nv>$GH_OST_PROGRESS</span><span class=s2>-</span><span class=nv>$cycle_calc</span><span class=s2>}&#34;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 進度超過80%以上時推送一次即可。當本分鐘進度 &gt; 80 且 上一分鐘進度小於80時印出</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>echo</span> <span class=nv>$GH_OST_PROGRESS</span> <span class=p>|</span> cut -d . -f 1<span class=sb>`</span> -eq <span class=m>100</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>echo</span> <span class=nv>$GH_OST_PROGRESS</span> <span class=p>|</span> cut -d . -f 1<span class=sb>`</span> -ge <span class=m>80</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>echo</span> <span class=nv>$last_progress</span> <span class=p>|</span> cut -d . -f 1<span class=sb>`</span> -lt <span class=m>80</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Report] - gh-ost 回報目前狀態 :busy:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Report_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Time elapsed(sec):* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Status:*\n ```&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_STATUS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;```\n*當前進度:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_PROGRESS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;%&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-failure</span>
</span></span><span class=line><span class=cl><span class=c1># 當gh-ost失敗時推送到slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[`Warning`] - gh-ost 熱更新失敗:alert:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Failed_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-begin-postponed</span>
</span></span><span class=line><span class=cl><span class=c1># 當gh-ost 開始推遲cut over時推送slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=o>=</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Postpon] - gh-ost is ready to cut-over(rename) :gj:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Postponed_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Time elapsed(sec):* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-status</span>
</span></span><span class=line><span class=cl><span class=c1># gh-ost 收到互動式命令時推送到 slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=o>=</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_STATUS</span><span class=o>=</span><span class=nv>$GH_OST_STATUS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_PROGRESS</span><span class=o>=</span><span class=nv>$GH_OST_PROGRESS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_COMMAND</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$GH_OST_COMMAND</span> <span class=p>|</span> sed <span class=s1>&#39;s/&#39;</span><span class=s2>&#34;&#39;&#34;</span>/<span class=s1>&#39;`&#39;&#39;/g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`unpostpone`&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`throttle`&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAD</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`panic`&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`no-throttle`&#39;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[New command] - gh-ost 收到命令
</span></span></span><span class=line><span class=cl><span class=s1> :ook:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Report_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Time elapsed(sec):* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*當前進度:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_PROGRESS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;%\n*Command:*&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-success</span>
</span></span><span class=line><span class=cl><span class=c1># 當gh-ost 完成時推送slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Success] - gh-ost 已完成熱更新:tada:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Success_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=方案比較與選擇>方案比較與選擇</h2><p><img src=/p/gh-ost/DDL-Plan-Diff.png width=904 height=579 srcset="/p/gh-ost/DDL-Plan-Diff_hu_cade177af89ba4a5.png 480w, /p/gh-ost/DDL-Plan-Diff_hu_7117b4e11486b293.png 1024w" loading=lazy alt="DDL 方案比較" class=gallery-image data-flex-grow=156 data-flex-basis=374px></p><p><img src=/p/gh-ost/DDL-Choose.png width=1112 height=1111 srcset="/p/gh-ost/DDL-Choose_hu_7d997967438f26bf.png 480w, /p/gh-ost/DDL-Choose_hu_d50012658dbb8670.png 1024w" loading=lazy alt="DDL 方案選擇" class=gallery-image data-flex-grow=100 data-flex-basis=240px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E5%B7%A5%E5%85%B7/>工具</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mysql-client-command/><div class=article-details><h2 class=article-title>MySQL Client Command</h2></div></a></article><article><a href=/p/mysql-mts/><div class=article-details><h2 class=article-title>並行複製 (Multi-Thread Slave, MTS)</h2></div></a></article><article><a href=/p/mysql-implicit-lock/><div class=article-details><h2 class=article-title>隱式鎖</h2></div></a></article><article><a href=/p/mysql-gtid/><div class=article-details><h2 class=article-title>GTID</h2></div></a></article><article><a href=/p/mysql-group-commit/><div class=article-details><h2 class=article-title>Group Commit</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//小小 DBA 個人筆記.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 建立<br>主題 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 設計</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>