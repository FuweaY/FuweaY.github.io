<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ä»‹ç´¹ Github é–‹æºçš„ MySQL Schema migration å·¥å…·"><title>gh-ost</title>
<link rel=canonical href=https://FuweaY.github.io/p/gh-ost/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="gh-ost"><meta property='og:description' content="ä»‹ç´¹ Github é–‹æºçš„ MySQL Schema migration å·¥å…·"><meta property='og:url' content='https://FuweaY.github.io/p/gh-ost/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='å·¥å…·'><meta property='article:published_time' content='2024-10-16T12:00:00+08:00'><meta property='article:modified_time' content='2024-10-16T12:00:00+08:00'><meta name=twitter:title content="gh-ost"><meta name=twitter:description content="ä»‹ç´¹ Github é–‹æºçš„ MySQL Schema migration å·¥å…·"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ±</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>ç†±æ„›åˆ†äº«çš„ DBA å°å¤©åœ°</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#how>HOW?</a></li><li><a href=#ç‰¹é»>ç‰¹é»</a></li><li><a href=#åŸ·è¡Œæ­¥é©Ÿ>åŸ·è¡Œæ­¥é©Ÿ</a></li><li><a href=#è¦æ±‚èˆ‡é™åˆ¶>è¦æ±‚èˆ‡é™åˆ¶</a></li><li><a href=#ä¸¦ç™¼é·ç§»concurrent-migrations>ä¸¦ç™¼é·ç§»(Concurrent migrations)</a></li><li><a href=#throttle>Throttle</a><ol><li><a href=#ä»‹ç´¹>ä»‹ç´¹</a></li><li><a href=#åƒæ•¸å’Œå› ç´ >åƒæ•¸å’Œå› ç´ </a><ol><li><a href=#replication-lag>Replication lag</a></li><li><a href=#status-thresholds>Status thresholds</a></li><li><a href=#throttle-query>Throttle query</a></li><li><a href=#http-throttle>HTTP Throttle</a></li><li><a href=#æ‰‹å‹•æ§åˆ¶>æ‰‹å‹•æ§åˆ¶</a></li></ol></li><li><a href=#throttle-precedence>Throttle precedence</a></li><li><a href=#throttle-status>Throttle status</a></li><li><a href=#å¯ä»¥-throttle-å¤šä¹…>å¯ä»¥ throttle å¤šä¹…</a></li></ol></li><li><a href=#äº’å‹•æŒ‡ä»¤>äº’å‹•æŒ‡ä»¤</a><ol><li><a href=#interactive-interfaces>Interactive interfaces</a></li><li><a href=#known-commands>Known commands</a></li><li><a href=#querying-for-data>Querying for data</a></li><li><a href=#ç¯„ä¾‹>ç¯„ä¾‹</a></li></ol></li><li><a href=#cut-over-è§£æ>Cut over è§£æ</a><ol><li><a href=#æƒ…å¢ƒ>æƒ…å¢ƒ</a></li><li><a href=#è§£æ>è§£æ</a></li><li><a href=#å¤±æ•—çš„å½±éŸ¿>å¤±æ•—çš„å½±éŸ¿</a></li></ol></li><li><a href=#hook>hook</a><ol><li><a href=#ç”¨é€”ç¯„ä¾‹>ç”¨é€”ç¯„ä¾‹</a></li><li><a href=#ä½¿ç”¨hook>ä½¿ç”¨hook</a></li><li><a href=#ç’°å¢ƒè®Šé‡>ç’°å¢ƒè®Šé‡</a></li><li><a href=#ç¯„ä¾‹-1>ç¯„ä¾‹</a></li></ol></li><li><a href=#æ–¹æ¡ˆæ¯”è¼ƒèˆ‡é¸æ“‡>æ–¹æ¡ˆæ¯”è¼ƒèˆ‡é¸æ“‡</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mysql/>MySQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/gh-ost/>gh-ost</a></h2><h3 class=article-subtitle>ä»‹ç´¹ Github é–‹æºçš„ MySQL Schema migration å·¥å…·</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 16, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 11 åˆ†é˜</time></div></footer></div></header><section class=article-content><p>æœ¬æ–‡è¼ƒé•·å»ºè­°æ­é…å³å´ç›®éŒ„é»æ“ŠæŸ¥çœ‹ã€‚</p><h2 id=how>HOW?</h2><p><img src=/p/gh-ost/How-gh-ost-work.png width=1724 height=772 srcset="/p/gh-ost/How-gh-ost-work_hu_a491c83ffc9ed16d.png 480w, /p/gh-ost/How-gh-ost-work_hu_cc0e77036e78be1.png 1024w" loading=lazy alt="How gh-ost work" class=gallery-image data-flex-grow=223 data-flex-basis=535px></p><ul><li>å»ºç«‹ä¸€å¼µå’ŒåŸè¡¨çµæ§‹ç›¸åŒçš„ <code>ghost</code> è¡¨</li><li>ALTER <code>ghost</code> è¡¨</li><li><code>gh-ost</code> å½è£æˆ <code>SLAVE</code> å¾ <code>Master/Slave</code> æ‹‰å– <code>binlog</code></li><li>å°‡è³‡æ–™å¯«å…¥ <code>ghost</code> è¡¨<ul><li>å°‡ <code>binlog event</code> æ‡‰ç”¨åˆ° <code>ghost</code> è¡¨</li><li>å¾åŸè¡¨è¤‡è£½ <code>rows</code> åˆ° <code>ghost</code> è¡¨</li></ul></li><li>åˆ‡æ› <code>ghost</code> è¡¨å’ŒåŸè¡¨</li></ul><p>ä¸Šè¿°çš„æ­¥é©Ÿä¸­å¯ä»¥çœ‹å‡º <code>gh-ost</code> çš„å¤§éƒ¨åˆ†å’Œå…¶ä»–online DDL å·¥å…·å¤§é«”ç›¸åŒï¼Œå”¯ä¸€çš„ä¸åŒè™•å°±æ˜¯ <code>gh-ost</code> ä¸æ˜¯åŸºæ–¼ <code>trigger</code> ã€‚ <code>gh-ost</code> çš„é–‹ç™¼åœ˜éšŠèªç‚ºä½¿ç”¨ <code>trigger</code> æœ‰è¨±å¤šçš„é™åˆ¶èˆ‡é¢¨éšªï¼Œæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒå®˜æ–¹æ–‡æª” <a class=link href=https://github.com/github/gh-ost/blob/master/doc/why-triggerless.md target=_blank rel=noopener>Why triggerless</a> é€™ç¯‡èªªæ˜ã€‚</p><p>å–è€Œä»£ä¹‹çš„æ˜¯ <code>gh-ost</code> é€é <code>binlog</code> ä¾†ç²å–åŸè¡¨è³‡æ–™çš„æ”¹å‹•ï¼Œä¸¦å°‡ä¹‹ç•°æ­¥æ‡‰ç”¨åˆ° <code>ghost</code> è¡¨ã€‚ <code>gh-ost</code> æ‰¿æ“”äº†å…¶ä»–å·¥å…·ç•™çµ¦ DATABASE åŸ·è¡Œçš„ä»»å‹™(<code>trigger</code>)ï¼Œç­‰æ–¼æ˜¯å®Œå…¨åˆ†é›¢äº†é·ç§»è³‡æ–™æ™‚çš„å¯«Loadingå’Œ DATABASE æœå‹™æœ¬èº«çš„ Loadingï¼Œå› æ­¤ <code>gh-ost</code> å¯èƒ½æ›´å¥½çš„æ§åˆ¶æ•´å€‹é·ç§»çš„éç¨‹ï¼Œå¯ä»¥åšåˆ°çœŸæ­£çš„æš«åœã€‚</p><h2 id=ç‰¹é»>ç‰¹é»</h2><ul><li>No <code>trigger</code>ï¼šé€™æ˜¯ <code>gh-ost</code>çš„ç‰¹é»ï¼ŒåŸºæ–¼ <code>trigger</code>çš„æ–¹æ¡ˆæœƒå° <code>MySQL</code>çš„æ€§èƒ½é€ æˆè¼ƒå¤§çš„å½±éŸ¿ã€‚ <code>gh-ost</code> è§£æ <code>binlog</code> å¾Œå¯«å…¥æ•¸æ“šï¼Œä¸åƒ…å¯æ§å° <code>MySQL</code> çš„æ€§èƒ½å½±éŸ¿ä¹Ÿå¾ˆå°ã€‚</li><li>çœŸæ­£çš„æš«åœï¼šç•¶ <code>gh-ost</code>é€²å…¥ <code>throttle</code>ç‹€æ…‹æ™‚ï¼Œ <code>gh-ost</code> çœŸæ­£åœæ­¢äº†å° <code>MASTER</code> çš„å¯«å…¥(é™¤äº†å¿…è¦çš„ä½è² è¼‰çš„å¿ƒè·³ç´€éŒ„)ï¼Œè®“ <code>MASTER</code> å¯ä»¥å›åˆ°åŸå§‹çš„ Loading ç‹€æ…‹ã€‚</li><li>å‹•æ…‹æ§åˆ¶ï¼šå³ä½¿å·²ç¶“é–‹å§‹é‹è¡Œ <code>gh-ost</code>ï¼Œä¹Ÿå¯ä»¥é€é <code>äº¤äº’å¼å‘½ä»¤</code> éš¨æ™‚é‡æ–°é…ç½® <code>gh-ost</code> éƒ¨åˆ†åƒæ•¸ï¼Œç”šè‡³ä½ å¯ä»¥å¼·åˆ¶è®“ <code>gh-ost</code> é€²å…¥ <code>throttle</code> ç‹€æ…‹ã€‚</li><li>å¯å¯©æ ¸ï¼šå¯ä»¥é€é <code>unix socket</code>ã€ <code>TCP</code> æˆ– <code>table _ghc</code> æŸ¥è©¢ <code>gh-ost</code> ç‹€æ…‹ã€‚</li><li>å¯æ¸¬è©¦ï¼š <code>gh-ost</code> å¯ä»¥åœ¨ <code>SLAVE</code> é€²è¡Œé·ç§»ï¼Œç”¨ä»¥è§€å¯Ÿ Loading å’Œ æ­£ç¢ºæ€§å¾Œå†æŠ•å…¥ä½¿ç”¨ã€‚</li><li>æ§åˆ¶åˆ‡æ›éšæ®µï¼š <code>cut over</code> æ˜¯ <code>gh-ost</code> æœ€é—œéµçš„ä¸€å€‹æ­¥é©Ÿï¼Œä½ å¯ä»¥éš¨æ™‚æ±ºå®š <code>cut over</code> çš„æ™‚é–“ã€‚</li><li>å¤–éƒ¨ hookï¼š <code>gh-ost</code> æä¾› <code>hook</code> åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå¯ä»¥ç”¨æ–¼æ¨é€åˆ° <code>SLACK</code> ç¾¤çµ„å‘ŠçŸ¥é€²åº¦ã€‚</li></ul><h2 id=åŸ·è¡Œæ­¥é©Ÿ>åŸ·è¡Œæ­¥é©Ÿ</h2><p>åˆå§‹æ­¥é©Ÿæª¢æŸ¥ä¸€ä¸‹åƒæ•¸ï¼Œä¸¦æ–°å¢å…©å¼µè¡¨ <code>ghost table(_gho)</code>ã€ <code>log&amp;heartbeat table(_ghc)</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- SLAVE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>autocommit</span><span class=o>=</span><span class=k>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=k>NAMES</span><span class=w> </span><span class=n>utf8mb4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=k>version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=n>grants</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>current_user</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>log_bin</span><span class=p>,</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>binlog_format</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>binlog_row_image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;event_1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>autocommit</span><span class=o>=</span><span class=k>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=k>NAMES</span><span class=w> </span><span class=n>utf8mb4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=k>version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>time_zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=o>@@</span><span class=k>global</span><span class=p>.</span><span class=n>port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>columns</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;_event_1_gho&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;_event_1_del&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>drop</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_ghc</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_ghc</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=n>auto_increment</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>last_update</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>hint</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=n>charset</span><span class=w> </span><span class=n>ascii</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>value</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span><span class=w> </span><span class=n>charset</span><span class=w> </span><span class=n>ascii</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=n>hint_uidx</span><span class=p>(</span><span class=n>hint</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>auto_increment</span><span class=o>=</span><span class=mi>256</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>alter</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>AFTER</span><span class=w> </span><span class=n>remark</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ ¹æ“š <code>exact-rowcount</code> çš„è¨­å®šä¾†æ±ºå®šè¨ˆç®—è¡Œæ•¸çš„æ–¹å¼ï¼Œåœ¨ <code>Slave</code> åŸ·è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>--no exact-rowcountï¼šé€éexplianå–å¾—ä¼°ç®—å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>explain</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=mi>1</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--exact-rowcountï¼šé€écount(*)å–å¾—ç²¾æº–å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é€šé <code>order by</code> ä¾†å–å¾— <code>shared key</code> æœ€å°å€¼å’Œæœ€å¤§å€¼ç¯„åœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é€éä»¥ä¸‹èªæ³•åˆ¤æ–·æ˜¯å¦é‚„æœ‰æœªè¤‡è£½çš„è³‡æ–™</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1>-- å‡è¨­æ¯æ¬¡æ‰¹æ¬¡ç‚º1000ç­†
</span></span></span><span class=line><span class=cl><span class=c1>-- å–å¾—æ¯æ¬¡æ‰¹æ¬¡çš„ç¬¬1000ã€2000...ç­†order_id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w>  </span><span class=cm>/* gh-ost `ghost_test`.`event_1` iteration:0 */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;00AD4267F1A3467&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;00AD4267F1A3467&#39;</span><span class=p>)))</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>and</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>asc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>offset</span><span class=w> </span><span class=mi>999</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- è‹¥ä¸Šè¿°sqlè¿”å›ç©ºå€¼ï¼Œå‰‡ä½¿ç”¨æ­¤èªæ³•æ’ˆå–æœ€å¾Œä¸€ç­†order_id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` iteration:1 */</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>select</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>where</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FE01373BB55A45F&#39;</span><span class=p>))</span><span class=w> </span><span class=k>and</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;FEB556F8553843A&#39;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>asc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>select_osc_chunk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç•¶æœ‰æœªè¤‡è£½çš„è³‡æ–™ï¼Œé€éä¸‹é¢çš„æ–¹å¼å¾åŸè¡¨è¤‡è£½è³‡æ–™åˆ° <code>ghost table</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>insert</span><span class=w> </span><span class=cm>/* gh-ost `ghost_test`.`event_1` */</span><span class=w> </span><span class=k>ignore</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>site_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>game_hall</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>op_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>amount</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>remark</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>create_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=o>`</span><span class=n>site_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>game_hall</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>op_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>txn_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>amount</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>remark</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>create_time</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>update_time</span><span class=o>`</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>force</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=k>PRIMARY</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=p>(((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>)))</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>and</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>)</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=p>((</span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_binary</span><span class=s1>&#39;2B94A39A501247D&#39;</span><span class=p>))))</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>lock</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>share</span><span class=w> </span><span class=k>mode</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æœ€å¾Œä¸€æ­¥<code>cut-over</code> éšæ®µ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Master
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>create</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>id</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=n>auto_increment</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>engine</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>comment</span><span class=o>=</span><span class=s1>&#39;ghost-cut-over-sentry&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>lock</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>write</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=k>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>host_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=w> </span><span class=k>write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>rename</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_gho</span><span class=o>`</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>event_1</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>drop</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_del</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>drop</span><span class=w> </span><span class=cm>/* gh-ost */</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=o>`</span><span class=n>ghost_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>_event_1_ghc</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>unlock</span><span class=w> </span><span class=n>tables</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è®“æˆ‘å€‘æ•´ç†ä¸€ä¸‹ gh-ost çš„æ“ä½œï¼š</p><div class=table-wrapper><table><thead><tr><th>æ‡‰ç”¨é¡å‹</th><th>åŸè¡¨æ“ä½œ</th><th>æ–°è¡¨æ“ä½œ</th></tr></thead><tbody><tr><td>Row Copy</td><td>SELECT</td><td>INSERT IGNORE INTO</td></tr><tr><td>Binlog Apply</td><td>INSERT</td><td>REPLACE INTO</td></tr><tr><td>Binlog Apply</td><td>UPDATE</td><td>UPDATE (æ‰€æœ‰æ¬„ä½ï¼‰</td></tr><tr><td>Binlog Apply</td><td>DELETE</td><td>DELETE</td></tr></tbody></table></div><p>åœ¨æ•¸æ“šé·ç§»çš„éç¨‹ä¸­ï¼Œæ•¸æ“šçš„è®Šå‹•æœ‰ä»¥ä¸‹ä¸‰ç¨®çµ„åˆï¼š</p><ul><li>å¾åŸè¡¨ <code>RowCopy</code> â†’ å° <code>åŸè¡¨DML</code>æ“ä½œ â†’ <code>Binlog Apply</code><ul><li>åœ¨æ­¤æƒ…æ³ä¸‹ä¸€åˆ‡éƒ½ç…§é †åºé‹è¡Œï¼Œå› æ­¤ä¸è«–æ˜¯ <code>INSERT</code>ã€ <code>UPDATE</code>ã€ <code>DELETE</code> éƒ½æ²’æœ‰ç–‘æ…®ã€‚</li></ul></li><li>å° <code>åŸè¡¨DML</code>æ“ä½œ â†’ <code>Binlog Apply</code> â†’ å¾åŸè¡¨ <code>RowCopy</code><ul><li><code>INSERT</code>ï¼š <code>Row Copy</code> è¢«è½‰æ›ç‚º <code>INSERT INGNORE INTO</code>ï¼Œå› æ­¤ä¸æœƒè“‹æ‰ <code>Binlog Apply</code> çš„ <code>INSERT</code> æ“ä½œã€‚</li><li><code>UPDATEã€DELETE</code>ï¼šå› ç‚ºé‚„æ²’å¾åŸè¡¨ <code>Copy</code> éä¾†ï¼Œæ‰€ä»¥ <code>Binlog Apply</code> çš„æ“ä½œæœƒæ²’æœ‰ä»»ä½•çµæœï¼Œä½†æ˜¯æœ€å¾Œå¾åŸè¡¨ <code>Copy</code> éä¾†æ™‚å³æœƒæ˜¯æœ€æ–°çš„æ•¸æ“šï¼Œå› æ­¤ä¹Ÿæ²’æœ‰å•é¡Œã€‚</li></ul></li><li>å° <code>åŸè¡¨DML</code> æ“ä½œ â†’ å¾åŸè¡¨ <code>RowCopy</code> â†’ <code>Binlog Apply</code><ul><li><code>INSERT</code>ï¼š <code>Binlog Apply:INSERT</code>è¢«è½‰æ›ç‚º <code>REPLACE INTO</code>ï¼Œæœƒè¦†è“‹æ‰ <code>Row Copy:INSERT</code> æ“ä½œï¼Œä½†å…©è€…çš„çµæœä¸€æ¨£å› æ­¤ä¸å½±éŸ¿ã€‚</li><li><code>UPDATEã€DELETE</code>ï¼šå¾åŸè¡¨ <code>Copy</code> éä¾†å°±æ˜¯æœ€æ–°çš„æ•¸æ“šï¼Œå¾ŒçºŒçš„ <code>Binlog Apply</code> ä¹Ÿä¸æœƒå½±éŸ¿åˆ°æ•¸æ“šï¼Œå› æ­¤ä¹Ÿæ²’æœ‰å•é¡Œã€‚</li></ul></li></ul><h2 id=è¦æ±‚èˆ‡é™åˆ¶>è¦æ±‚èˆ‡é™åˆ¶</h2><p>Requirements è¦æ±‚ï¼š</p><ul><li><code>gh-ost</code> éœ€è¦åœ¨ MySQL 5.7 ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸Šé‹è¡Œ</li><li>server å¿…é ˆé–‹å•Ÿ <code>log_bin</code>ï¼Œè‹¥ç‚º Slave åŒæ™‚ä¹Ÿå¿…é ˆé–‹å•Ÿ <code>log_slave_updates</code></li><li>éœ€è¦ä¸€å° <code>binlog_format</code> ç‚º <code>ROW</code> åŠ <code>binlog_row_image</code> ç‚º <code>full</code> æ¨¡å¼çš„ server</li><li>å¦‚æœåœ¨slaveä¸Šä½¿ç”¨ï¼Œå¿…é ˆç¢ºä¿è¦ALTERçš„TABLEåœ¨Masterå’ŒSlaveä¸ŠSchemaç›¸åŒ</li><li>æ¬Šé™ï¼š<ul><li>ALTER, CREATE, DELETE, DROP, INDEX, INSERT, LOCK TABLES, SELECT, TRIGGER, UPDATE ON database.* OR <code>*.*</code></li><li>SUPER, REPLICATION SLAVE on <code>*.*</code> æˆ– REPLICATION CLIENT, REPLICATION SLAVE on <code>*.*</code><blockquote><p><code>SUPER</code>æ¬Šé™ç”¨æ–¼ <code>STOP SLAVE</code> å’Œ <code>START SLAVE</code>ï¼Œå…·é«”ç”¨é€”ç‚ºï¼š</p><ol><li>ç•¶ <code>binlog_format</code>ä¸æ˜¯ <code>ROW</code> ä¸¦ä¸”æŒ‡å®š <code>--switch-to-rbr</code> æ™‚ï¼Œå°‡åˆ‡æ› <code>binlog_format</code> ä¸¦é‡å•Ÿ replicationã€‚å¦‚æœæ˜¯ <code>ROW</code> æ¨¡å¼å¯ä»¥æŒ‡å®š <code>--assume-rbr</code> é¿å… <code>STOP SLAVE</code> å’Œ <code>START SLAVE</code> ï¼Œåœ¨æ­¤æƒ…æ³ä¸‹ï¼Œä¸éœ€è¦æä¾› <code>SUPER</code> æ¬Šé™ã€‚
(æé†’ï¼è‹¥è‡ªè¡Œåˆ‡æ› <code>binlog_format</code> é ˆè¨˜å¾—é‡å•Ÿreplicationï¼)</li><li>é‹è¡Œ <code>--test-on-replica</code> æ™‚ï¼Œgh-oståˆ‡æ›è¡¨å¾Œæœƒåœæ­¢ <code>replication</code> ï¼Œè®“ä½¿ç”¨è€…æ¯”è¼ƒå…©å¼µè¡¨ã€‚</li></ol></blockquote></li></ul></li></ul><p>Limitations é™åˆ¶ï¼š</p><ul><li>ç›®å‰ä¸æ”¯æŒå¤–éµã€‚æœªä¾†å¯èƒ½æœƒæä¾›ä¸€å®šç¨‹åº¦çš„æ”¯æŒ</li><li>ç›®å‰ä¸æ”¯æŒtriggerã€‚æœªä¾†å¯èƒ½æœƒæä¾›æ”¯æŒ</li><li>æ”¯æŒMySQL 5.7çš„ <code>JSON</code> ï¼Œä½†å‰ææ˜¯ä¸èƒ½æ˜¯ <code>PRIMARY KEY</code> çš„ä¸€éƒ¨åˆ†</li><li>æ–°è¡¨å’ŒèˆŠè¡¨å¿…é ˆä½¿ç”¨ç›¸åŒçš„ <code>PRIMARY KEY</code> æˆ– <code>UNIQUE KEY</code> ã€‚å› ç‚ºè¤‡è£½æ™‚æœƒ <code>gh-ost</code> æœƒåˆ©ç”¨è©² KEYéæ­·æ‰€æœ‰è¡Œã€‚é·ç§»éµå¿…é ˆç‚º <code>NOT NULL</code> (å¯ä»¥ç‚ºç©ºå€¼)ã€‚æˆ–æ˜¯æœ‰ <code>NULLå±¬æ€§</code> ä¸¦ä½¿ç”¨ <code>--allow-nullable-unique-key</code> ä½†å¿…é ˆç¢ºä¿å¯¦éš›ä¸Šæ²’æœ‰ <code>NULL</code> å€¼ï¼Œå¦å‰‡å¯èƒ½å°è‡´æ•¸æ“šä¸å®Œæ•´ã€‚</li><li>ç•¶å­˜åœ¨åç¨±ç›¸åŒåƒ…å¤§å°å¯«ä¸åŒçš„tableæ™‚ç„¡æ³•é€²è¡Œ</li><li>é˜¿é‡Œé›²RDSèƒ½æ­£å¸¸é‹ä½œï¼Œåƒ…éœ€è¦æ·»åŠ  <code>--aliyun-rds</code></li><li>Google Cloud SQLå¯ä½¿ç”¨ï¼Œåƒ…éœ€æ·»åŠ  <code>--gcp</code></li><li>Amazon RDSå¯ä»¥ä½¿ç”¨ï¼Œä½†æœ‰äº›é™åˆ¶ï¼Œè«‹åƒé–±<a class=link href=https://github.com/github/gh-ost/blob/master/doc/rds.md target=_blank rel=noopener>å®˜æ–¹æ–‡æª”</a></li><li>ç•¶ <code>SLAVE</code> çš„ä¾†æºç‚ºmultiæ™‚ï¼Œç„¡æ³•æ”¯æŒåœ¨ <code>SLAVE</code> ä¸ŠåŸ·è¡Œï¼Œå»ºè­°ç›´æ¥åœ¨ <code>MASTER</code>ä¸Šé€²è¡Œï¼Œéœ€æ·»åŠ  <code>--allow-on-master</code></li><li>ç›®å‰ç•¶åœ¨ <code>master-master</code> é‹è¡Œ <code>gh-ost</code> æ™‚ï¼Œæ²’æœ‰è¾¦æ³•æ”¯æ´å…©é‚Šéƒ½æœ‰å¯«å…¥çš„æƒ…æ³ã€‚å°‡ä¾†å¯èƒ½æ”¯æ´</li><li>è‹¥å°‡ <code>enum</code> å‹æ…‹çš„æ¬„ä½ä½œç‚º <code>PRIMARY KEY</code> å°‡ä½¿æ€§èƒ½é™ä½</li><li>ä¸æ”¯æ´ <code>federated Table</code> ï¼Œä¸¦ä¸”èˆ‡ <code>gh-ost</code> æƒ³è¦è§£æ±ºçš„æ–¹æ¡ˆç„¡é—œ</li><li>ä¸æ”¯æŒ <code>ALTER TABLE ... RENAME TO some_other_name</code> ï¼Œé€™æ¨£çš„æ“ä½œä¸æ‡‰è©²æ˜¯ç”¨ <code>gh-ost</code></li></ul><h2 id=ä¸¦ç™¼é·ç§»concurrent-migrations>ä¸¦ç™¼é·ç§»(Concurrent migrations)</h2><ul><li>çµ•å°ä¸è¦é‹è¡Œåœ¨åŒä¸€å€‹ <code>Table</code> ä¸Šã€‚</li><li>å¦‚æœé‹è¡Œåœ¨ä¸åŒçš„ <code>SLAVE</code> ä¸Šï¼Œä¸éœ€è¦å…¶ä»–èª¿æ•´ã€‚ä¾‹å¦‚ï¼štable1 on slave1 å’Œ table2 on slave2ã€‚</li><li>å¦‚æœåœ¨åŒä¸€å€‹æ©Ÿå™¨é‹è¡Œ <code>gh-ost</code><ul><li>ç¢ºä¿ <code>-server-socket-file</code> è¨­ç½®ä¸åŒåç¨±ï¼ˆæˆ–ç”± <code>gh-ost</code> å‘½åï¼‰ã€‚</li><li>é€é <code>-throttle-additional-flag-file</code> æ§åˆ¶æ‰€æœ‰ <code>gh-ost</code>ï¼Œå¦å¤–é€é <code>throttle-flag-file</code> æ§åˆ¶å–®ä¸€ <code>gh-ost</code> ã€‚</li></ul></li><li>å¦‚æœ <code>-host</code> ç›¸åŒï¼Œå‰‡å¿…é ˆå°æ¯å€‹ <code>gh-ost</code> è¨­å®šå”¯ä¸€çš„ <code>replica-server-id</code> é¿å…è¡çªã€‚</li></ul><h2 id=throttle>Throttle</h2><h3 id=ä»‹ç´¹>ä»‹ç´¹</h3><p>åœ¨é·ç§»çš„éä¸­ï¼Œ <code>gh-ost</code> çš„ç‹€æ…‹é™¤äº†æŒçºŒçš„è¤‡è£½åŸè¡¨å’Œæ‡‰ç”¨binlogå¤–ï¼Œé‚„æœ‰å¦ä¸€å€‹ç‹€æ…‹æ˜¯ <code>throttling</code></p><p>ç•¶ <code>throttled(é™åˆ¶)</code> çš„æ™‚å€™ï¼Œ <code>gh-ost</code> æœƒæš«åœæ‰€æœ‰å¯«æ“ä½œï¼ŒåŒ…å«è¤‡è£½åŸè¡¨çš„è³‡æ–™å’Œæª¢æŸ¥binlogï¼Œä½†ä»æœƒåš <code>low-volume changlog status writes</code> å’Œ <code>heartbeat writes</code> ã€‚</p><p>ç•¶ <code>gh-ost</code> è¢«é™åˆ¶æ™‚ï¼Œå°ä¸»æ©Ÿçš„ Loading å°‡å¾¹åº•æ¶ˆå¤±ï¼Œå’ŒåŸºæ–¼ <code>trigger</code> åŸç†çš„å·¥å…·ç›¸æ¯”é€™æ˜¯ <code>gh-ost</code> çš„å„ªå‹¢ï¼Œå› ç‚º <code>trigger</code> ç„¡æ³•æš«åœæœƒæŒçºŒçš„å¯«å…¥æ–°è³‡æ–™ï¼Œç›¸åçš„ <code>gh-ost</code> åŒ…å«è¤‡è£½åŸè¡¨è³‡æ–™å’Œå¯«å…¥æ–°è³‡æ–™ï¼ˆé€éæ‡‰ç”¨ <code>binlog event</code>ï¼‰éƒ½æ˜¯ç”± <code>gh-ost</code> é€²è¡Œæ§åˆ¶ã€‚</p><p><code>gh-ost</code> æ”¯æŒå„ç¨®é™åˆ¶çš„æ–¹æ³•ï¼Œä¸¦ä¸”ä»–èƒ½å…è¨±ä½¿ç”¨è€…å‹•æ…‹çš„èª¿æ•´ã€‚</p><h3 id=åƒæ•¸å’Œå› ç´ >åƒæ•¸å’Œå› ç´ </h3><h4 id=replication-lag>Replication lag</h4><p>æ¨è–¦å°‡ <code>gh-ost</code> é€£çµåˆ° <code>Slave</code>ï¼Œ <code>gh-ost</code> æœƒè‡ªè¡Œæ‰¾å‡º <code>Master</code> é–‹å§‹é€²è¡Œé·ç§»çš„åŒæ™‚ï¼Œ <code>gh-ost</code> æœ‰è‡ªå·±çš„å¿ƒè·³æ©Ÿåˆ¶å»æª¢æŸ¥ä»–æ‰€é€£æ¥çš„ <code>Slave</code> æ˜¯å¦æœ‰ <code>replication lag</code> çš„ç‹€æ³ã€‚æˆ–è€…ä¹Ÿå¯ä»¥è‡ªè¡ŒæŒ‡å®šè¦æª¢æŸ¥ <code>replication lag</code> çš„æ¸…å–®ã€‚</p><ul><li><p><code>--throttle-control-replicas</code> ï¼šæ˜ç¢ºåˆ—å‡ºéœ€è¦ <code>gh-ost</code> æª¢æŸ¥ <code>replication lag</code> çš„ <code>Slave</code> æ¸…å–®
ç¯„ä¾‹ï¼š&ndash;throttle-control-replicas=myhost1.com:3306,myhost2.com,myhost3.com:3307</p></li><li><p><code>--max-lag-millis</code>ï¼šå…è¨± <code>replication lag</code> çš„æœ€å¤§å€¼ï¼Œä»»ä½•åœ¨æª¢æŸ¥æ¸…å–®ä¸­çš„ <code>replication lag</code> è¶…éæ­¤å€¼éƒ½å°‡å°è‡´ <code>throttling</code>ï¼Œé™¤éæ¸…å–®ä¸­çš„æ‰€æœ‰ <code>replication lag</code> éƒ½å°æ–¼æ­¤å€¼æ‰æœƒæ¢å¾©ã€‚</p></li></ul><p>ä»¥ä¸Šè¨­å®šå¯ä»¥é€é <code>Interaction commands</code> ä¾†éš¨æ™‚å‹•æ…‹èª¿æ•´ã€‚</p><h4 id=status-thresholds>Status thresholds</h4><p><code>--max-load</code> ï¼šç•¶æŒ‡å®šçš„æŒ‡æ¨™è¶…éè¨­å®šçš„é–¾å€¼æ™‚ï¼Œå°‡å°è‡´ <code>throttling</code> ç™¼ç”Ÿã€‚</p><p>ç¯„ä¾‹ï¼š&ndash;max-load=&lsquo;Threads_running=100,Threads_connected=500&rsquo;</p><p>æŒ‡æ¨™å¿…é ˆæ˜¯æœ‰æ•ˆä¸”ç‚ºæ•¸å­—çš„ <a class=link href=https://dev.mysql.com/doc/refman/5.7/en/server-status-variables.html target=_blank rel=noopener><code>status variables</code></a> (å¯åƒè€ƒmysql å®˜ç¶²)</p><h4 id=throttle-query>Throttle query</h4><p>ç•¶æä¾› <code>--throttle-query</code> æ™‚ï¼Œå¿…é ˆç¢ºä¿è¿”å›æ•´æ•¸ï¼Œæ¯ç§’æœƒåŸ·è¡Œè©²æŸ¥è©¢(å› æ­¤æ‡‰ç¢ºä¿æ­¤æŸ¥è©¢ç‚ºè¼•é‡çš„)ï¼Œç•¶è¿”å›å€¼ <code>> 0</code> æ™‚ <code>gh-ost</code> å°‡é€²å…¥ <code>throttling</code> ç‹€æ…‹ï¼›åä¹‹ç•¶è¿”å›å€¼ <code>&lt;= 0</code> æ™‚ä¸”æ²’æœ‰å…¶ä»–é™åˆ¶å› ç´ æ™‚ï¼Œå‰‡ <code>gh-ost</code> æ­£å¸¸é‹ä½œ</p><p>ç¯„ä¾‹ï¼š&ndash;throttle-query=&ldquo;select hour(now()) between 8 and 17&rdquo; è¡¨ç¤º <code>8:00am</code> é–‹å§‹é€²å…¥ <code>throttling</code> ç‹€æ…‹ï¼Œç›´åˆ° <code>18:00pm</code> è§£é™¤ã€‚</p><h4 id=http-throttle>HTTP Throttle</h4><p>The <code>--throttle-http</code> flag allows for throttling via HTTP. Every 100ms <code>gh-ost</code> issues a <code>HEAD</code> request to the provided URL. If the response status code is not <code>200</code> throttling will kick in until a <code>200</code> response status code is returned.</p><p>If no URL is provided or the URL provided doesn&rsquo;t contain the scheme then the HTTP check will be disabled. For example <code>--throttle-http="http://1.2.3.4:6789/throttle"</code> will enable the HTTP check/throttling, but <code>--throttle-http="1.2.3.4:6789/throttle"</code> will not.</p><p>The URL can be queried and updated dynamically via <a class=link href=https://github.com/github/gh-ost/blob/master/doc/interactive-commands.md target=_blank rel=noopener>interactive interface</a>.</p><h4 id=æ‰‹å‹•æ§åˆ¶>æ‰‹å‹•æ§åˆ¶</h4><p>é™¤äº†ä»¥ä¸Šçš„è‡ªå‹•æ§åˆ¶ï¼Œé‚„å¯ä»¥éš¨æ™‚æ‰‹å‹•è®“ <code>gh-ost</code> é€²å…¥ <code>throttling</code> ç‹€æ…‹ã€‚</p><ul><li><p><code>--throttle-flag-file</code> ï¼šç•¶è©²æ–‡ä»¶å­˜åœ¨æ™‚ï¼Œé€²å…¥ <code>throttling</code> ç‹€æ…‹ã€‚å¯ä»¥ä½¿ç”¨ <code>touch</code> å»ºç«‹å³å¯</p></li><li><p><code>--throttle-additional-flag-file</code> ï¼šèˆ‡ä¸Šè¿°é¡ä¼¼ï¼Œç•¶è©²æ–‡ä»¶å­˜åœ¨æ™‚ï¼Œé€²å…¥ <code>throttling</code> ç‹€æ…‹ã€‚</p><p>é»˜èªå€¼ç‚ºï¼š <code>/tmp/gh-ost.throttle</code></p><p>æœ‰å…©ç¨®åƒæ•¸çš„åŸå› æ˜¯å¯ä»¥é‹è¡Œå¤šå€‹ <code>gh-ost</code> ï¼Œ<code>--throttle-flag-file</code> ç‚ºå–®å€‹ <code>gh-ost</code> æ‰€ä½¿ç”¨ï¼Œ<code>--throttle-additional-flag-file</code> å‰‡æ˜¯åŒæ™‚æ§åˆ¶æ‰€æœ‰ <code>gh-ost</code> ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é€é <code>touch</code> ä¸åŒçš„æ–‡ä»¶ä¾†é™åˆ¶å–®å€‹æˆ–å¤šå€‹ <code>gh-ost</code></p></li><li><p>é€é <code>Interactive commands</code> å° <code>gh-ost</code> ä¸‹é” <code>throttle</code></p><p>ç¯„ä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> throttle <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=nb>echo</span> no-throttle <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=throttle-precedence>Throttle precedence</h3><p>ä¸Šè¿°æåˆ°çš„ä»»ä½•å› ç´ éƒ½å°‡å°è‡´ <code>gh-ost</code> é€²å…¥ <code>throttling</code> ç‹€æ…‹ï¼Œå› æ­¤ä¸€æ—¦å…¶ä¸­ä¸€å€‹å› ç´ å¼•ç™¼ <code>throttling</code> ä½ éƒ½ç„¡æ³•å¼·åˆ¶ç¹¼çºŒåŸ·è¡Œé·ç§»ã€‚</p><p><code>gh-ost</code> æœƒåœ¨ä¸åŒçš„æ™‚é–“é»ç¨ç«‹æ”¶é›†ä¸åŒçš„æŒ‡æ¨™ï¼Œä¸¦ç•°æ­¥æª¢æŸ¥ä¸åŒçš„æŒ‡æ¨™æ˜¯å¦æœ‰é”åˆ°é–¾å€¼ï¼Œå› æ­¤ <code>gh-ost</code> åªæœƒè¿”å›ç¬¬ä¸€å€‹è¶…éé–¾å€¼çš„æŒ‡æ¨™ä½œç‚º <code>throttling</code> åŸå› ã€‚</p><h3 id=throttle-status>Throttle status</h3><p><code>throttle</code> ç‹€æ…‹æœƒä½œç‚º <code>status message</code> å®šæœŸçš„ <code>print</code> å‡ºä¾†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 41s<span class=o>(</span>copy<span class=o>)</span>, 41s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000551:47983<span class=p>;</span> ETA: throttled, flag-file
</span></span><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 42s<span class=o>(</span>copy<span class=o>)</span>, 42s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000551:49370<span class=p>;</span> ETA: throttled, commanded by user
</span></span></code></pre></td></tr></table></div></div><h3 id=å¯ä»¥-throttle-å¤šä¹…>å¯ä»¥ throttle å¤šä¹…</h3><p>æœ€é•·å¯ä»¥ç¶­æŒ <code>throttle</code> ç‹€æ…‹çš„æ™‚é–“ä¾è³´æ–¼ <code>binlog</code> ä¿ç•™çš„æ™‚é–“ï¼Œå› ç‚ºç•¶é€²å…¥ <code>throttling</code> ç‹€æ…‹æ™‚ï¼Œ <code>gh-ost</code> å°‡æš«åœè®€å– <code>binlog</code> ï¼Œä¹‹å¾Œæ¢å¾©æœƒå¾åŒä¸€å€‹ <code>binlog</code> é–‹å§‹ã€‚</p><p><code>binlog</code> ä¿ç•™æ™‚é–“é€šå¸¸é€é <code>expire_logs_days</code> è¨­å®šï¼Œæˆ–è€…æ˜¯å…¶ä»–å¤–éƒ¨è…³æœ¬ï¼Œå› æ­¤å¿…é ˆå…ˆç¢ºèªæ©Ÿå™¨ä¸Šçš„éƒ¨å±¬ï¼Œå¦å¤–é›–ç„¶ <code>binlog</code> ä¿ç•™å¤šä¹… <code>gh-ost</code> å°±èƒ½ <code>throttle</code> å¤šä¹…ï¼Œä½†æ˜¯åœ¨æ­¤æœŸé–“ <code>gh-ost</code> å¿…é ˆä¸€ç›´é‹è¡Œï¼Œä¸¦ä¸”ç›¸æ‡‰çš„ç•¶æ¢å¾©ä¹‹å¾Œéœ€è¦æ‡‰ç”¨ç›¸ç•¶å¤§é‡çš„ <code>binlog event</code> ã€‚</p><h2 id=äº’å‹•æŒ‡ä»¤>äº’å‹•æŒ‡ä»¤</h2><p><code>gh-ost</code> å…è¨±ç”¨æˆ¶åœ¨é‹è¡Œæ™‚æ§åˆ¶å…¶è¡Œç‚º</p><h3 id=interactive-interfaces>Interactive interfaces</h3><p><code>gh-ost</code> å¯ä»¥é€éä»¥ä¸‹æ–¹å¼é€²è¡Œç›£è½ï¼š</p><ul><li>UNIX socket fileï¼š <code>gh-ost</code> é‹è¡Œæ™‚æœƒç”¢ç”Ÿ <code>socket file</code> ä¹Ÿå¯ä»¥é€é <code>--server-socket-file</code> æŒ‡å®šä½ç½®ã€‚</li><li>TCPï¼šéœ€è¦å¸¶å…¥ <code>--server-tcp-port</code> åƒæ•¸</li></ul><h3 id=known-commands>Known commands</h3><ul><li><code>help</code>ï¼šæç¤ºå¯ä»¥ä½¿ç”¨çš„å‘½ä»¤</li><li><code>status</code>ï¼šè¿”å›é·ç§»çš„é€²åº¦ï¼Œå’Œè©³ç´°çš„ç‹€æ…‹</li><li><code>sup</code>ï¼šè¿”å›é·ç§»é€²åº¦çš„ç°¡è¦ç‹€æ…‹</li><li><code>coordinates</code>ï¼šè¿”å›è¢«æª¢æŸ¥ binlog çš„ serverï¼Œæœ€æ–°çš„positionä½ç½®</li><li><code>chunk-size=&lt;newsize></code>ï¼šä¿®æ”¹ <code>chunk-size</code>ï¼Œå°‡åœ¨ä¸‹ä¸€æ¬¡ <code>copy-iteration</code> ç”Ÿæ•ˆ</li><li><code>dml-batch-size=&lt;newsize></code>ï¼šä¿®æ”¹ <code>dml-batch-size</code>ï¼Œå°‡åœ¨ä¸‹ä¸€æ¬¡æ‡‰ç”¨ <code>binlog event</code> ç”Ÿæ•ˆ</li><li><code>max-lag-millis=&lt;max-lag></code>ï¼šèª¿æ•´ <code>max-lag-millis</code> çš„é…ç½®</li><li><code>max-load=&lt;max-load-thresholds></code>ï¼šä¿®æ”¹ <code>max-load</code> çš„é…ç½®ï¼Œå°‡åœ¨ä¸‹ä¸€æ¬¡ <code>copy-iteration</code> ç”Ÿæ•ˆ</li><li><code>critical-load=&lt;critical-load-thresholds></code>ï¼šä¿®æ”¹ <code>critical-load</code> çš„é…ç½®</li><li><code>nice-ratio=&lt;ratio></code>ï¼šä¿®æ”¹ <code>nice-ratio</code> æ¯”ä¾‹</li><li><code>throttle-http</code>ï¼šchange throttle HTTP endpoint</li><li><code>throttle-query</code>ï¼šä¿®æ”¹ throttle query</li><li><code>throttle-control-replicas='replica1,replica2'</code>ï¼šä¿®æ”¹ throttle control replicas</li><li><code>throttle</code>ï¼šå¼·åˆ¶é€²å…¥ throttle ç‹€æ…‹</li><li><code>no-throttle</code>ï¼šå–æ¶ˆå¼·åˆ¶é€²å…¥ throttle ç‹€æ…‹ï¼Œä½†ä»æœƒå—å…¶ä»–å› ç´ æš«åœ</li><li><code>unpostpone</code>ï¼šåœ¨ <code>gh-ost</code> æ¨é² <code>cut-over</code> éšæ®µæ™‚ï¼Œåªæ˜¯ <code>gh-ost</code> åœæ­¢æ¨é²ä¸¦ç«‹åˆ» <code>cut-over</code></li><li><code>panic</code>ï¼šç«‹å³ <code>panic</code> ä¸¦åœæ­¢æ“ä½œ</li></ul><h3 id=querying-for-data>Querying for data</h3><p>å°æ–¼ä¸Šè¿°å‘½ä»¤åœ¨å‚³éåƒæ•¸æ™‚ï¼Œè¨­ç½®ç‚º <code>?</code> æ™‚ï¼Œå¯ä»¥æŸ¥è©¢æ•¸æ“š</p><h3 id=ç¯„ä¾‹>ç¯„ä¾‹</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> status <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=c1># Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst`</span>
</span></span><span class=line><span class=cl><span class=c1># Migration started at Tue Jun 07 11:45:16 +0200 2016</span>
</span></span><span class=line><span class=cl><span class=c1># chunk-size: 200; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20]</span>
</span></span><span class=line><span class=cl><span class=c1># Throttle additional flag file: /tmp/gh-ost.throttle</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on TCP port: 10001</span>
</span></span><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 40s<span class=o>(</span>copy<span class=o>)</span>, 41s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000550:49942<span class=p>;</span> ETA: throttled, flag-file
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;chunk-size=250&#34;</span> <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=c1># Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst`</span>
</span></span><span class=line><span class=cl><span class=c1># Migration started at Tue Jun 07 11:56:03 +0200 2016</span>
</span></span><span class=line><span class=cl><span class=c1># chunk-size: 250; max lag: 1500ms; dml-batch-size: 10; max-load: map[Threads_connected:20]</span>
</span></span><span class=line><span class=cl><span class=c1># Throttle additional flag file: /tmp/gh-ost.throttle</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on TCP port: 10001</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;chunk-size=?&#34;</span> <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=m>250</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> throttle <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> status <span class=p>|</span> nc -U /tmp/gh-ost.test.sample_data_0.sock
</span></span><span class=line><span class=cl><span class=c1># Migrating `test`.`sample_data_0`; Ghost table is `test`.`_sample_data_0_gst`</span>
</span></span><span class=line><span class=cl><span class=c1># Migration started at Tue Jun 07 11:56:03 +0200 2016</span>
</span></span><span class=line><span class=cl><span class=c1># chunk-size: 250; max lag: 1500ms; max-load: map[Threads_connected:20]</span>
</span></span><span class=line><span class=cl><span class=c1># Throttle additional flag file: /tmp/gh-ost.throttle</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on unix socket: /tmp/gh-ost.test.sample_data_0.sock</span>
</span></span><span class=line><span class=cl><span class=c1># Serving on TCP port: 10001</span>
</span></span><span class=line><span class=cl>Copy: 0/2915 0.0%<span class=p>;</span> Applied: 0<span class=p>;</span> Backlog: 0/100<span class=p>;</span> Elapsed: 59s<span class=o>(</span>copy<span class=o>)</span>, 59s<span class=o>(</span>total<span class=o>)</span><span class=p>;</span> streamer: mysql-bin.000551:68067<span class=p>;</span> ETA: throttled, commanded by user
</span></span></code></pre></td></tr></table></div></div><h2 id=cut-over-è§£æ>Cut over è§£æ</h2><h3 id=æƒ…å¢ƒ>æƒ…å¢ƒ</h3><p>å‡è¨­ <code>C10ã€C20</code> ç‚º <code>gh-ost</code> æ‰€ä½¿ç”¨çš„é€£çµï¼Œ <code>C1..C9</code>ã€ <code>C11..C19</code>ã€ <code>C21..C29</code> ç‚ºå…¶ä»–é€£ç·šã€‚</p><ul><li><code>C1..C9</code>ï¼šå° <code>åŸè¡¨(tb1)</code> é€²è¡Œ <code>INSERTã€UPDATEã€DELETE</code> ç­‰DMLæ“ä½œ</li><li><code>C10</code>ï¼š <code>CREATE TABLE tb1_old(id int primary key) COMMENT='magic-be-here'</code></li><li><code>C10</code>ï¼š <code>LOCK TABLES tb1 WRITE, tb1_old WRITE</code></li><li><code>C11..C19</code>ï¼šæ–°çš„é€£ç·šå° <code>tb1</code>é€²è¡ŒDMLæ“ä½œï¼Œä½†ç”±æ–¼ <code>tb1</code>è¢« <code>LOCK</code>ä½è€Œé˜»å¡</li><li><code>C20</code>ï¼š <code>RENAME TABLE tbl TO tbl_old, ghost TO tbl</code>ï¼Œé›–ç„¶å› ç‚º <code>LOCK</code> æ­¤æ“ä½œæœƒè¢«é˜»å¡ï¼Œä½†åœ¨é˜»å¡çš„å°åˆ—ä¸­å„ªå…ˆç´šæœƒé«˜æ–¼ <code>C1..C9</code> å’Œ <code>C11..C19</code></li><li><code>C21..C29</code>ï¼šæ–°çš„é€£ç·šå° <code>tb1</code>é€²è¡ŒDMLæ“ä½œï¼Œä½†ç”±æ–¼ <code>tb1</code>è¢« <code>LOCK</code>ä½è€Œé˜»å¡</li><li><code>C10</code>ï¼šé€é <code>show processlist</code> ç¢ºèªæ˜¯å¦æœ‰ <code>C20çš„RENAME</code> æ“ä½œ</li><li><code>C10</code>ï¼š <code>DROP TABLE tbl_old</code>ï¼Œä»€éº¼äº‹éƒ½æ²’æœ‰ç™¼ç”Ÿ <code>tb1</code> ä»èˆŠè¢« <code>LOCK</code></li><li><code>C10</code>ï¼š <code>UNLOCK TABLES</code></li></ul><p>æœ€å¾Œï¼Œé˜»å¡çš„å°åˆ—ä¸­ <code>RENAME</code> å„ªå…ˆè¢«åŸ·è¡Œï¼Œæ¥ä¸‹ä¾†æ˜¯ <code>C1..C9</code> <code>C11..C19</code> <code>C21..C29</code> éƒ½ç›´æ¥æ‡‰ç”¨åˆ°æ›´æ–°å¾Œçš„ <code>tb1</code>ã€‚</p><h3 id=è§£æ>è§£æ</h3><ul><li>åœ¨ <code>MySQL</code> ä¸­æœ‰å…©ç¨®æ–¹å¼å¯ä»¥ <code>RENAME TABLE</code>ï¼š<ol><li><code>RENAME TABLE</code>ï¼šèƒ½å¤ åŒæ™‚ <code>rename</code>å¤šå¼µè¡¨ï¼Œé€™è¡¨ç¤º <code>rename</code>å¤šå¼µè¡¨æ˜¯åŸå­çš„æ“ä½œã€‚ä½†åœ¨ <code>8.0.13</code> ä¹‹å‰ç„¡æ³•åœ¨åŒä¸€å€‹ session åŒæ™‚ <code>LOCK</code>å’Œ <code>RENAME</code>ã€‚</li><li><code>ALTER TABLE RENAME</code>ï¼šèƒ½å¤ åœ¨ <code>LOCK TABLE</code> çš„ session é€²è¡Œï¼Œä½†å»ç„¡æ³•ä¸€æ¬¡ <code>RENAME</code>å¤šå¼µè¡¨ã€‚</li></ol></li><li><code>tb1_old</code>çš„å­˜åœ¨ï¼Œé¿å… <code>Lock</code>é€£ç·šæ­»æ‰å¾Œçš„å½±éŸ¿ã€‚</li><li><code>Lock Table</code> é¿å… <code>RENAME</code> éæ—©åŸ·è¡Œã€‚</li><li>åœ¨é˜»å¡çš„å°åˆ—ä¸­ï¼Œ <code>RENAME</code>ç¸½æ˜¯å„ªå…ˆæ–¼ <code>INSERTã€UPDATEã€DELETE</code>ã€‚</li></ul><h3 id=å¤±æ•—çš„å½±éŸ¿>å¤±æ•—çš„å½±éŸ¿</h3><ol><li>å¦‚æœåœ¨ <code>C10 Create table æˆ– Lock table</code>å¤±æ•—ï¼Œå‰‡ä¸æœƒç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ­¥é©Ÿã€‚</li><li>å¦‚æœåœ¨ <code>C20 Rename</code>æ™‚ <code>C10 Locké€£ç·šæ­»äº¡</code>ï¼Œå› ç‚º <code>tb1_old</code>çš„å­˜åœ¨ <code>Rename</code>å¤±æ•—ï¼ŒåŒæ™‚ <code>Lock</code> è§£é™¤ï¼Œ <code>C1..C9</code>å’Œ <code>C11..C19</code>æ­£å¸¸åŸ·è¡Œï¼Œå”¯ä¸€çš„å½±éŸ¿åªæœ‰æŸ¥è©¢è¢«é˜»å¡äº†ä¸€æ®µæ™‚é–“ã€‚</li><li>å¦‚æœ <code>C20 Rename</code>åœ¨ <code>C10 Drop æˆ– Unlock</code>ä¹‹å‰æ­»äº¡ï¼Œ <code>gh-ost</code>æœƒæ­£å¸¸åŸ·è¡Œ <code>Dropã€UnLock</code>ï¼Œå› æ­¤å”¯ä¸€çš„å½±éŸ¿ä¸€æ¨£åªæ˜¯æŸ¥è©¢è¢«é˜»å¡ä¸€æ®µæ™‚é–“ã€‚</li></ol><h2 id=hook>hook</h2><h3 id=ç”¨é€”ç¯„ä¾‹>ç”¨é€”ç¯„ä¾‹</h3><ul><li>å¸Œæœ›é·ç§»å®Œæˆ/å¤±æ•—æ™‚ï¼Œèƒ½å¤ æ”¶åˆ°é€šçŸ¥</li><li>å¸Œæœ›ç•¶ <code>gh-ost</code> é–‹å§‹æ¨é² <code>cut-over</code> æ™‚æ”¶åˆ°é€šçŸ¥</li><li>å¸Œæœ› <code>gh-ost</code> å®šæœŸå›å ±é€²åº¦</li></ul><h3 id=ä½¿ç”¨hook>ä½¿ç”¨hook</h3><p>æ‰€æœ‰çš„hookéƒ½æ‡‰è©²æ”¾åœ¨ <code>--hooks-path</code> æŒ‡å®šçš„ç›®éŒ„è£¡ï¼Œå¦‚æœæ²’æœ‰æä¾›å‰‡ä¸åŸ·è¡Œ hookã€‚</p><p>hookçš„å‘½åå¿…é ˆç‚ºä»¥ä¸‹å‰ç¶´ï¼š</p><ul><li><code>gh-ost-on-startup</code></li><li><code>gh-ost-on-validated</code></li><li><code>gh-ost-on-rowcount-complete</code></li><li><code>gh-ost-on-before-row-copy</code></li><li><code>gh-ost-on-status</code></li><li><code>gh-ost-on-interactive-command</code></li><li><code>gh-ost-on-row-copy-complete</code></li><li><code>gh-ost-on-stop-replication</code></li><li><code>gh-ost-on-start-replication</code></li><li><code>gh-ost-on-begin-postponed</code></li><li><code>gh-ost-on-before-cut-over</code></li><li><code>gh-ost-on-success</code></li><li><code>gh-ost-on-failure</code></li></ul><h3 id=ç’°å¢ƒè®Šé‡>ç’°å¢ƒè®Šé‡</h3><ul><li><code>GH_OST_DATABASE_NAME</code></li><li><code>GH_OST_TABLE_NAME</code></li><li><code>GH_OST_GHOST_TABLE_NAME</code></li><li><code>GH_OST_OLD_TABLE_NAME</code>ï¼šåŸå§‹è¡¨åœ¨ cut-over ä¹‹å¾Œçš„åç¨±</li><li><code>GH_OST_DDL</code>ï¼šDDL èªå¥</li><li><code>GH_OST_ELAPSED_SECONDS</code>ï¼šç¸½é‹è¡Œæ™‚é–“</li><li><code>GH_OST_ELAPSED_COPY_SECONDS</code>ï¼šRow copy èŠ±è²»çš„æ™‚é–“</li><li><code>GH_OST_ESTIMATED_ROWS</code>ï¼šä¼°è¨ˆçš„è¡Œæ•¸</li><li><code>GH_OST_COPIED_ROWS</code>ï¼šgh-ost è¤‡è£½çš„è¡Œæ•¸</li><li><code>GH_OST_INSPECTED_LAG</code>ï¼šreplication lag (second)</li><li><code>GH_OST_PROGRESS</code>ï¼šé·ç§»çš„é€²åº¦ [0&mldr;100] %</li><li><code>GH_OST_MIGRATED_HOST</code></li><li><code>GH_OST_INSPECTED_HOST</code></li><li><code>GH_OST_EXECUTING_HOST</code></li><li><code>GH_OST_HOOKS_HINT</code>ï¼š <code>--hooks-hint</code>çš„å€¼</li><li><code>GH_OST_HOOKS_HINT_OWNER</code>ï¼š <code>--hooks-hint-owner</code>çš„å€¼</li><li><code>GH_OST_HOOKS_HINT_TOKEN</code>ï¼š<code>--hooks-hint-token</code>çš„å€¼</li><li><code>GH_OST_DRY_RUN</code>ï¼š <code>gh-ost</code> æ˜¯å¦æ˜¯ <code>dry run</code></li><li><code>GH_OST_COMMAND</code>ï¼šonly available in gh-ost-on-interactive-command</li><li><code>GH_OST_STATUS</code>ï¼šonly available in gh-ost-on-status</li></ul><h3 id=ç¯„ä¾‹-1>ç¯„ä¾‹</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># ç•¶gh-ostå•Ÿå‹•æ™‚æ¨é€åˆ°slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¨é€åˆ°slack</span>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Start] - gh-ost å·²é–‹å§‹ç†±æ›´æ–° :gh-ost:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Start_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39; &#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-status</span>
</span></span><span class=line><span class=cl><span class=c1># gh-ost æ¨é€ç‹€æ…‹åˆ° slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=o>=</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_STATUS</span><span class=o>=</span><span class=nv>$GH_OST_STATUS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_PROGRESS</span><span class=o>=</span><span class=nv>$GH_OST_PROGRESS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¨ˆç®—æ¯åˆ†é˜å¹³å‡é€²åº¦</span>
</span></span><span class=line><span class=cl><span class=nv>cycle_calc</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=p>|</span> awk <span class=s2>&#34;{print </span><span class=nv>$GH_OST_PROGRESS</span><span class=s2>/</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span><span class=s2>*60}&#34;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=c1># è¨ˆç®—ä¸Šä¸€åˆ†é˜çš„é€²åº¦</span>
</span></span><span class=line><span class=cl><span class=nv>last_progress</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=p>|</span> awk <span class=s2>&#34;{print </span><span class=nv>$GH_OST_PROGRESS</span><span class=s2>-</span><span class=nv>$cycle_calc</span><span class=s2>}&#34;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é€²åº¦è¶…é80%ä»¥ä¸Šæ™‚æ¨é€ä¸€æ¬¡å³å¯ã€‚ç•¶æœ¬åˆ†é˜é€²åº¦ &gt; 80 ä¸” ä¸Šä¸€åˆ†é˜é€²åº¦å°æ–¼80æ™‚å°å‡º</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>echo</span> <span class=nv>$GH_OST_PROGRESS</span> <span class=p>|</span> cut -d . -f 1<span class=sb>`</span> -eq <span class=m>100</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>echo</span> <span class=nv>$GH_OST_PROGRESS</span> <span class=p>|</span> cut -d . -f 1<span class=sb>`</span> -ge <span class=m>80</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>echo</span> <span class=nv>$last_progress</span> <span class=p>|</span> cut -d . -f 1<span class=sb>`</span> -lt <span class=m>80</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Report] - gh-ost å›å ±ç›®å‰ç‹€æ…‹ :busy:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Report_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Time elapsed(sec):* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Status:*\n ```&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_STATUS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;```\n*ç•¶å‰é€²åº¦:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_PROGRESS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;%&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-failure</span>
</span></span><span class=line><span class=cl><span class=c1># ç•¶gh-ostå¤±æ•—æ™‚æ¨é€åˆ°slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[`Warning`] - gh-ost ç†±æ›´æ–°å¤±æ•—:alert:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Failed_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-begin-postponed</span>
</span></span><span class=line><span class=cl><span class=c1># ç•¶gh-ost é–‹å§‹æ¨é²cut overæ™‚æ¨é€slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=o>=</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Postpon] - gh-ost is ready to cut-over(rename) :gj:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Postponed_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Time elapsed(sec):* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-status</span>
</span></span><span class=line><span class=cl><span class=c1># gh-ost æ”¶åˆ°äº’å‹•å¼å‘½ä»¤æ™‚æ¨é€åˆ° slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=o>=</span><span class=nv>$GH_OST_ELAPSED_SECONDS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_STATUS</span><span class=o>=</span><span class=nv>$GH_OST_STATUS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_PROGRESS</span><span class=o>=</span><span class=nv>$GH_OST_PROGRESS</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_COMMAND</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$GH_OST_COMMAND</span> <span class=p>|</span> sed <span class=s1>&#39;s/&#39;</span><span class=s2>&#34;&#39;&#34;</span>/<span class=s1>&#39;`&#39;&#39;/g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`unpostpone`&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`throttle`&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAD</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`panic`&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span> <span class=o>=</span> <span class=s1>&#39;`no-throttle`&#39;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[New command] - gh-ost æ”¶åˆ°å‘½ä»¤
</span></span></span><span class=line><span class=cl><span class=s1> :ook:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Report_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Time elapsed(sec):* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_ELAPSED_SECONDS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*ç•¶å‰é€²åº¦:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_PROGRESS</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;%\n*Command:*&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_COMMAND</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Sample hook file for gh-ost-on-success</span>
</span></span><span class=line><span class=cl><span class=c1># ç•¶gh-ost å®Œæˆæ™‚æ¨é€slack</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>slack_hook</span><span class=o>=</span><span class=sb>`</span>cat /var/lib/DBA/gh-ost/gh-ost_hooks/slack-webhook<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>show_time</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;(%:z)%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>show_day</span><span class=o>=</span><span class=k>$(</span>date +<span class=s2>&#34;%b %-d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_MIGRATED_HOST</span><span class=o>=</span><span class=nv>$GH_OST_MIGRATED_HOST</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DATABASE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_DATABASE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_TABLE_NAME</span><span class=o>=</span><span class=nv>$GH_OST_TABLE_NAME</span>
</span></span><span class=line><span class=cl><span class=nv>GH_OST_DDL</span><span class=o>=</span><span class=nv>$GH_OST_DDL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data <span class=s1>&#39;{&#34;blocks&#34;: [{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*&lt;gh-ost.com|[Success] - gh-ost å·²å®Œæˆç†±æ›´æ–°:tada:&gt;*&#34;}},{&#34;type&#34;: &#34;section&#34;,&#34;text&#34;: {&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;*Success_Time:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Host:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_MIGRATED_HOST</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;\n*Table:* `&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DATABASE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`.`&#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_TABLE_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;`\n*DDL:* &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GH_OST_DDL</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}},{&#34;type&#34;: &#34;context&#34;,&#34;elements&#34;: [{&#34;type&#34;: &#34;mrkdwn&#34;,&#34;text&#34;: &#34;:gh-ost: *gh-ost* | &#39;</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>show_day</span><span class=si>}</span><span class=s2>&#34;</span><span class=s1>&#39;&#34;}]}]}&#39;</span> <span class=si>${</span><span class=nv>slack_hook</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=æ–¹æ¡ˆæ¯”è¼ƒèˆ‡é¸æ“‡>æ–¹æ¡ˆæ¯”è¼ƒèˆ‡é¸æ“‡</h2><p><img src=/p/gh-ost/DDL-Plan-Diff.png width=904 height=579 srcset="/p/gh-ost/DDL-Plan-Diff_hu_cade177af89ba4a5.png 480w, /p/gh-ost/DDL-Plan-Diff_hu_7117b4e11486b293.png 1024w" loading=lazy alt="DDL æ–¹æ¡ˆæ¯”è¼ƒ" class=gallery-image data-flex-grow=156 data-flex-basis=374px></p><p><img src=/p/gh-ost/DDL-Choose.png width=1112 height=1111 srcset="/p/gh-ost/DDL-Choose_hu_7d997967438f26bf.png 480w, /p/gh-ost/DDL-Choose_hu_d50012658dbb8670.png 1024w" loading=lazy alt="DDL æ–¹æ¡ˆé¸æ“‡" class=gallery-image data-flex-grow=100 data-flex-basis=240px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E5%B7%A5%E5%85%B7/>å·¥å…·</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸é—œæ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mysql-client-command/><div class=article-details><h2 class=article-title>MySQL Client Command</h2></div></a></article><article><a href=/p/mysql-mts/><div class=article-details><h2 class=article-title>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</h2></div></a></article><article><a href=/p/mysql-implicit-lock/><div class=article-details><h2 class=article-title>éš±å¼é–</h2></div></a></article><article><a href=/p/mysql-gtid/><div class=article-details><h2 class=article-title>GTID</h2></div></a></article><article><a href=/p/mysql-group-commit/><div class=article-details><h2 class=article-title>Group Commit</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//å°å° DBA å€‹äººç­†è¨˜.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>