<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ä»‹ç´¹ MySQL ä¸¦è¡Œè¤‡è£½"><title>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</title>
<link rel=canonical href=https://FuweaY.github.io/p/mysql-mts/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)"><meta property='og:description' content="ä»‹ç´¹ MySQL ä¸¦è¡Œè¤‡è£½"><meta property='og:url' content='https://FuweaY.github.io/p/mysql-mts/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Replication'><meta property='article:published_time' content='2025-04-07T12:00:00+08:00'><meta property='article:modified_time' content='2025-04-07T12:00:00+08:00'><meta name=twitter:title content="ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)"><meta name=twitter:description content="ä»‹ç´¹ MySQL ä¸¦è¡Œè¤‡è£½"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ±</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>ç†±æ„›åˆ†äº«çš„ DBA å°å¤©åœ°</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ä¸¦è¡Œè¤‡è£½-multi-thread-slave-mts>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</a></li><li><a href=#å„å€‹ç‰ˆæœ¬çš„-mts>å„å€‹ç‰ˆæœ¬çš„ MTS</a><ol><li><a href=#åŸºæ–¼-database-ç´šåˆ¥çš„-mts-56>åŸºæ–¼ database ç´šåˆ¥çš„ MTS (5.6)</a></li><li><a href=#åŸºæ–¼-group-commit-çš„-mts-57>åŸºæ–¼ Group Commit çš„ MTS (5.7)</a><ol><li><a href=#group-commit-ç°¡è¿°>Group Commit ç°¡è¿°</a></li><li><a href=#slave_parallel_type>slave_parallel_type</a></li><li><a href=#logical_clock---commit-parent-based-æ¨¡å¼>LOGICAL_CLOCK - Commit Parent Based æ¨¡å¼</a></li><li><a href=#logical_clock----lock-based-æ¨¡å¼>LOGICAL_CLOCK - Lock Based æ¨¡å¼</a></li><li><a href=#commit-parent-based-vs-lock-based--èˆ‰ä¾‹>Commit Parent Based VS Lock Based èˆ‰ä¾‹</a></li><li><a href=#ç¼ºé™·>ç¼ºé™·</a></li></ol></li><li><a href=#åŸºæ–¼-writeset-çš„-mts-572280>åŸºæ–¼ WriteSet çš„ MTS (5.7.22ã€8.0)</a><ol><li><a href=#writeset-ç°¡è¿°>WriteSet ç°¡è¿°</a></li><li><a href=#writeset-æ‡‰ç”¨åˆ°-mts-ç°¡è¿°>WriteSet æ‡‰ç”¨åˆ° MTS ç°¡è¿°</a></li><li><a href=#å¯¦ç¾æ–¹å¼>å¯¦ç¾æ–¹å¼</a></li></ol></li><li><a href=#writeset-æ˜¯ä»€éº¼>WriteSet æ˜¯ä»€éº¼ï¼Ÿ</a></li><li><a href=#åŸºæ–¼-writeset-çš„-mts-æ€éº¼å¯¦ç¾>åŸºæ–¼ WriteSet çš„ MTS æ€éº¼å¯¦ç¾ï¼Ÿ</a><ol><li><a href=#binlog_transaction_dependency_tracking-ä¸åŒå°-last_commit-çš„è™•ç†>binlog_transaction_dependency_tracking ä¸åŒå° last_commit çš„è™•ç†</a></li><li><a href=#writeset-æ­·å²ç´€éŒ„è©³è§£>WriteSet æ­·å²ç´€éŒ„è©³è§£</a></li><li><a href=#writeset-mts-å°-last_commit-çš„è™•ç†æµç¨‹>WriteSet MTS å° last_commit çš„è™•ç†æµç¨‹</a></li><li><a href=#writeset_session-æ€éº¼åš>WRITESET_SESSION æ€éº¼åš?</a></li><li><a href=#é—œæ–¼-binlog_transaction_dependency_history_size-åƒæ•¸èªªæ˜>é—œæ–¼ binlog_transaction_dependency_history_size åƒæ•¸èªªæ˜</a></li><li><a href=#writeset-ä¸é©ç”¨æƒ…å¢ƒ>WriteSet ä¸é©ç”¨æƒ…å¢ƒ</a></li></ol></li></ol></li><li><a href=#slave_><strong>slave_preserve_commit_order ä»‹ç´¹</strong></a><ol><li><a href=#gap>GAP</a></li></ol></li><li><a href=#ç›¸é—œåƒæ•¸>ç›¸é—œåƒæ•¸</a></li><li><a href=#å®˜æ–¹æ¸¬è©¦æ•¸æ“š>å®˜æ–¹æ¸¬è©¦æ•¸æ“š</a></li><li><a href=#è¦ªè‡ªæ¸¬è©¦>è¦ªè‡ªæ¸¬è©¦</a></li><li><a href=#log>LOG</a></li><li><a href=#æ‡¶äººåŒ…>æ‡¶äººåŒ…</a><ol><li><a href=#mysql-575721-åƒæ•¸è¨­å®š>MySQL 5.7~5.7.21 åƒæ•¸è¨­å®š</a></li><li><a href=#mysql-572280xx-åƒæ•¸è¨­å®š>MySQL 5.7.22~8.0.XX åƒæ•¸è¨­å®š</a></li><li><a href=#mts-æ•ˆç‡ç¢ºèª>MTS æ•ˆç‡ç¢ºèª</a></li></ol></li><li><a href=#bug>BUG</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mysql/>MySQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/mysql-mts/>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</a></h2><h3 class=article-subtitle>ä»‹ç´¹ MySQL ä¸¦è¡Œè¤‡è£½</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 07, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 14 åˆ†é˜</time></div></footer></div></header><section class=article-content><h2 id=ä¸¦è¡Œè¤‡è£½-multi-thread-slave-mts>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</h2><p>åœ¨ MySQL 8.0.27 ä¹‹å‰ï¼ŒReplica é è¨­åªæœ‰ä¸€å€‹ IO_THREAD å’Œä¸€å€‹ SQL_THREADï¼š</p><ul><li>IO_THREAD è² è²¬å¾ Source æ¥æ”¶ binlog ä¸¦å¯«å…¥ Replica çš„ relaylog</li><li>SQL_THREAD è² è²¬è§£æå’Œé‡æ”¾ relaylog ä¸­çš„ event</li></ul><p>ç•¶ Source æœ‰ä½µç™¼å¤§é‡å¯«å…¥æ™‚ï¼ŒReplica çš„ IO_THREAD å› ç‚ºæ˜¯é †åºå¯«å…¥ä¸€èˆ¬ä¸æœƒå°è‡´ replication delayï¼Œä½†æ˜¯åªæœ‰å–®ç·šç¨‹ SQL_THREAD å›æ”¾é€Ÿåº¦æ˜¯è·Ÿä¸ä¸Šæœ‰å¤šç·šç¨‹å¯«å…¥çš„ Sourceï¼Œå› æ­¤æœƒé€ æˆ replication delay ä¸æ–·è®Šå¤§ï¼Œç›¸æ‡‰ä¹Ÿå°è‡´ Replica çš„ relaylog å¤§é‡å †ç©å æ»¿ disk ç©ºé–“ã€‚</p><p>å› æ­¤å¾ MySQL 5.6 é–‹å§‹æä¾›äº† Multi-Tread Slave (MTS)ï¼Œé€éå¤šç·šç¨‹çš„ SQL_THREAD ä¾†ç·©è§£é€™ç¨®å•é¡Œï¼Œä¸¦ä¸”åœ¨å¾ŒçºŒçš„å¤§ç‰ˆæœ¬ä¸­ä¸æ–·é€²è¡Œå„ªåŒ–ã€‚</p><h2 id=å„å€‹ç‰ˆæœ¬çš„-mts>å„å€‹ç‰ˆæœ¬çš„ MTS</h2><h3 id=åŸºæ–¼-database-ç´šåˆ¥çš„-mts-56>åŸºæ–¼ database ç´šåˆ¥çš„ MTS (5.6)</h3><p>åœ¨ MySQL 5.6 åªæœ‰åŸºæ–¼ Database ç´šåˆ¥çš„ MTSï¼Œåªæœ‰åœ¨ä¸åŒ Database çš„èªå¥æ‰å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œï¼Œå› æ­¤é€™ç„¡æ³•è§£æ±ºå–®è¡¨é«˜å¯«å…¥æ‰€é€ æˆçš„åŒæ­¥å»¶é²ã€‚</p><p><img src=/p/mysql-mts/MySQL-56-MTS-ByDatabase.png width=808 height=209 srcset="/p/mysql-mts/MySQL-56-MTS-ByDatabase_hu_76640f19593a5e88.png 480w, /p/mysql-mts/MySQL-56-MTS-ByDatabase_hu_1cab929c3ba48.png 1024w" loading=lazy class=gallery-image data-flex-grow=386 data-flex-basis=927px></p><h3 id=åŸºæ–¼-group-commit-çš„-mts-57>åŸºæ–¼ Group Commit çš„ MTS (5.7)</h3><h4 id=group-commit-ç°¡è¿°>Group Commit ç°¡è¿°</h4><p>Group Commit æ˜¯ MySQL 5.6 ç‰ˆæœ¬å¼•å…¥ç”¨ä¾†å„ªåŒ– BinLogã€RedoLog åœ¨ 2PC æ™‚å¯«å…¥çš„ç“¶é ¸ï¼Œç°¡å–®ä¾†èªªåŸæœ¬æ¯å€‹ Transaction éƒ½éœ€è¦ç¨è‡ª <code>fsync</code> æ“ä½œä¾†å¯«å…¥ Disk æŒä¹…åŒ–ï¼Œç¶“é Group Commit çš„å„ªåŒ–å¾Œæœƒå°‡å¤šå€‹ Transaction çµ„æˆä¸€å€‹å°åˆ—ä¸€èµ·é€²è¡Œ <code>fsync</code> æ“ä½œï¼Œå¤§å¹…æ¸›å°‘ <code>fsync</code> æ“ä½œè§£æ±ºåœ¨é›™ 1 æ™‚é€ æˆçš„æ€§èƒ½æ€¥é€Ÿä¸‹é™çš„å•é¡Œã€‚</p><p><img src=/p/mysql-mts/MySQL-5.6-GroupCommit.png width=2000 height=734 srcset="/p/mysql-mts/MySQL-5.6-GroupCommit_hu_68a640d24557e5a3.png 480w, /p/mysql-mts/MySQL-5.6-GroupCommit_hu_a620e3a9d84860da.png 1024w" loading=lazy class=gallery-image data-flex-grow=272 data-flex-basis=653px></p><p>é—œæ–¼ Group Commit çš„å…·é«”æè¿°ï¼Œå¯åƒè€ƒ <a class=link href=https://FuweaY.github.io/p/mysql-group-commit/>MySQL Group Commit æ¼”é€²</a>ã€‚</p><h4 id=slave_parallel_type>slave_parallel_type</h4><p>åœ¨ MySQL 5.7 å¼•å…¥äº† <code>slave_parallel_type</code> é€™å€‹æ–°åƒæ•¸ï¼Œå¯ä½¿ç”¨çš„å€¼æœ‰ä»¥ä¸‹ 2 å€‹ï¼š</p><ul><li>DATABASEï¼šä¹Ÿå°±æ˜¯ 5.6 ç‰ˆæœ¬ï¼Œä¸åŒ DATABASE çš„æ‰èƒ½ä¸¦è¡Œå›æ”¾ã€‚</li><li>LOGICAL_CLOCKï¼š5.7 ç‰ˆæœ¬åŸºæ–¼ Group Commit çš„ä¸¦è¡Œå›æ”¾ã€‚</li></ul><h4 id=logical_clock---commit-parent-based-æ¨¡å¼>LOGICAL_CLOCK - Commit Parent Based æ¨¡å¼</h4><p>åœ¨ Source ä¸­èƒ½å¤ åœ¨åŒä¸€å€‹å°åˆ—ä¸€èµ·é€²è¡Œ Group commitï¼Œè¡¨ç¤ºé€™å€‹å°åˆ—ä¸­çš„æ‰€æœ‰ Transaction éƒ½æ²’æœ‰é–è¡çªï¼Œå› æ­¤ä¹Ÿå¯åœ¨ Replica å…§ä¸¦è¡Œå›æ”¾ã€‚</p><p>ç‚ºäº†è®“ Replica èƒ½åŸºæ–¼ Group Commit å¯¦ç¾ MTSï¼Œåœ¨ Binlog ä¸­ç‚ºæ¯å€‹ Transaction æ·»åŠ äº† LOGICAL CLOCK ä¹Ÿå°±æ˜¯ä»¥ä¸‹ 2 å€‹å€¼ï¼š</p><ul><li>sequence_numberï¼šæ¯å€‹ Transaction çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œå…·é«”åœ¨ Transaction é€²å…¥ flush éšæ®µçš„å°åˆ—ä¹‹å‰åˆ†é…ã€‚</li><li>last_commitedï¼šç´€éŒ„ä¸Šæ¬¡ Group commit æ™‚æœ€å¤§çš„ sequence_numberï¼Œä¹Ÿå°±æ˜¯èªª last_committed ç›¸åŒè¡¨ç¤ºåŒå±¬ä¸€å€‹ Groupã€‚</li></ul><p><img src=/p/mysql-mts/binlog-sequence-last-example.png width=2000 height=503 srcset="/p/mysql-mts/binlog-sequence-last-example_hu_6de35104bba7a66b.png 480w, /p/mysql-mts/binlog-sequence-last-example_hu_de30a8103e12b021.png 1024w" loading=lazy alt="é€é mysqlbinlog å¯ä»¥çœ‹åˆ° binlog ä¸­æ¯å€‹ Transaction éƒ½æœ‰é€™ 2 å€‹è®Šé‡" class=gallery-image data-flex-grow=397 data-flex-basis=954px></p><p>é€é mysqlbinlog å¯ä»¥çœ‹åˆ° binlog ä¸­æ¯å€‹ Transaction éƒ½æœ‰é€™ 2 å€‹è®Šé‡</p><p>å‚™è¨»ï¼šsequence_numberã€last_commited åªåœ¨åŒä¸€å€‹ BinLog æ–‡ä»¶ä¸é‡è¤‡ï¼Œæ¯ç•¶æ›åˆ°æ–°çš„ BinLog æ–‡ä»¶æ™‚æœƒé‡æ–°å¾ 0 é–‹å§‹è¨ˆæ•¸ã€‚</p><hr><p>ä¸é Commit Parent Based æœ‰ä¸€å€‹ç¼ºé™·ï¼Œè®“æˆ‘å€‘çœ‹ä¸€ä¸‹ä¾‹å­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Trx1 ------------P----------C--------------------------------&gt;
</span></span><span class=line><span class=cl>                                |
</span></span><span class=line><span class=cl>Trx2 ----------------P------+---C----------------------------&gt;
</span></span><span class=line><span class=cl>                                |   |
</span></span><span class=line><span class=cl>Trx3 -------------------P---+---+-----C----------------------&gt;
</span></span><span class=line><span class=cl>                                |   |     |
</span></span><span class=line><span class=cl>Trx4 -----------------------+-P-+-----+----C-----------------&gt;
</span></span><span class=line><span class=cl>                                |   |     |    |
</span></span><span class=line><span class=cl>Trx5 -----------------------+---+-P---+----+---C-------------&gt;
</span></span><span class=line><span class=cl>                                |   |     |    |   |
</span></span><span class=line><span class=cl>Trx6 -----------------------+---+---P-+----+---+---C----------&gt;
</span></span></code></pre></td></tr></table></div></div><p>æ¯ä¸€å€‹æ°´å¹³ç·šä»£è¡¨ä¸€å€‹ Transaction ç”±å·¦åˆ°å³çš„æ™‚é–“é»ï¼Œå…¶ä¸­ P è¡¨ç¤º prepare éšæ®µå–å¾—ä¸Šä¸€å€‹ Group æ›´æ–° last_committed çš„æ™‚é–“é»ï¼ŒC è¡¨ç¤º commit å‰æ›´æ–° last_committed çš„æ™‚é–“é»ã€‚</p><p>å…¶ä¸­å¯ä»¥è§€å¯Ÿåˆ°ï¼š</p><ul><li>Trx4 çš„ P æ™‚é–“é»å–å¾—çš„æ˜¯ Trx1 commit ç”¢ç”Ÿçš„ last_committed</li><li>Trx5 å’Œ Trx6 çš„ P æ™‚é–“é»å–å¾—çš„æ˜¯ Trx2 commit ç”¢ç”Ÿçš„ last_committed</li></ul><p>ä¾ç…§ Commit Parent æ¨¡å¼ä¸‹ Trx5ã€Trx6 å¯ä»¥ä¸€èµ·åœ¨ Replica å›æ”¾ï¼Œä½†æ˜¯ Trx4 ä¸å¯ä»¥å’Œ Trx5ã€Trx6 ä¸€èµ·åœ¨ Replica å›æ”¾ã€‚</p><p>ç„¶è€Œï¼Œå¯¦éš›ä¸Šä¾ç…§æ™‚é–“ç·šæˆ‘å€‘å¯ä»¥çœ‹åˆ° Trx4 åœ¨ prepare åˆ° commit çš„éç¨‹ä¸­ï¼ŒTrx5ã€Trx6 æœ‰åœ¨é€™å€‹éç¨‹ä¸­ prepareï¼Œä¹Ÿå°±æ˜¯èªªå¯¦éš›ä¸Šä»–å€‘ä¸¦æ²’æœ‰é–è¡çª (å¦‚æœè¡çª Trx5ã€Trx6 æœƒå¡åœ¨ lock wait)ï¼Œæ‰€ä»¥ç†è«–ä¸Šä»–å€‘åœ¨ Replica æ˜¯å¯ä»¥ä¸¦è¡Œå›æ”¾åˆ°ã€‚</p><h4 id=logical_clock----lock-based-æ¨¡å¼>LOGICAL_CLOCK - Lock Based æ¨¡å¼</h4><p>ç‚ºäº†é€²ä¸€æ­¥å„ªåŒ– Commit Parent Based çš„ç¼ºé™·ï¼ŒMySQL 5.7 é¦¬ä¸Šå¯¦ç¾äº† <a class=link href="https://dev.mysql.com/worklog/task/?id=7165" target=_blank rel=noopener>MySQL :: WL#7165: MTS: Optimizing MTS scheduling by increasing the parallelization window on master</a> çš„å„ªåŒ–ï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ Lock Based æ¨¡å¼çš„ LOGICAL_CLOCKï¼Œåªè¦ Transaction åœ¨å„è‡ªæŒæœ‰çš„é–æ²’æœ‰è¡çªæ™‚å°±å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œã€‚</p><p>åœ¨æ­¤æ¨¡å¼ä¸‹ binlog ä¸­çš„ sequence_numberã€last_commited æ¶µç¾©å¦‚ä¸‹ï¼š</p><ul><li>sequence_numberï¼šæ¯å€‹ Transaction çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œå…·é«”åœ¨ Transaction é€²å…¥ flush éšæ®µçš„å°åˆ—ä¹‹å‰åˆ†é…ï¼Œ</li><li>last_commitedï¼šç•¶ Transaction é–‹å§‹åŠ é–æ™‚ï¼Œå°‡å…¨å±€è®Šé‡ max_committed_transaction ç•¶ä¸‹çš„å€¼ä½œç‚º last_commitedã€‚<ul><li>å…¨å±€è®Šé‡ max_committed_transactionï¼šå·²ç¶“çµæŸ Lock interval çš„æœ€å¤§ sequence_numberï¼Œæ¯å€‹ Transaction åœ¨ InnoDB commit éšæ®µæ™‚ï¼Œå¦‚æœè‡ªå·±çš„ sequence_number > max_committed_transaction æ™‚æœƒå°‡å…¶æ›´æ–°ç‚ºè‡ªå·±çš„ sequence_number ã€‚</li><li>å› ç‚ºç„¡æ³•é å…ˆçŸ¥é“å“ªä¸€å€‹é–æ˜¯æœ€å¾Œä¸€å€‹ï¼Œå› æ­¤ Transaction å…§æ¯ä¸€å€‹ DML éƒ½æœƒä¸æ–·æ›´æ–°è©² Transaction çš„ last_commitedã€‚</li></ul></li></ul><p>åœ¨ Source å¯«å…¥ sequence_numberã€last_commited ä¹‹å¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯çœ‹ Replica å¦‚ä½•ä¾æ“šé€™ 2 å€‹ç›´ä¾†å¯¦ç¾ Lock Based çš„ MTSã€‚</p><p>é¦–å…ˆè¤‡ç¿’ä¸€ä¸‹ï¼Œåªæœ‰ç•¶ Transaction å’Œ Transaction åœ¨ Lock ~ Commit (ä¹Ÿå°±æ˜¯é‡‹æ”¾é–) ä¹‹é–“æœ‰äº¤é›†æ‰èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>- Can execute in parallel:
</span></span><span class=line><span class=cl>    Trx1 -----L---------C------------&gt;
</span></span><span class=line><span class=cl>    Trx2 ----------L---------C-------&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- Can not execute in parallel:
</span></span><span class=line><span class=cl>    Trx1 -----L----C-----------------&gt;
</span></span><span class=line><span class=cl>    Trx2 ---------------L----C-------&gt;
</span></span></code></pre></td></tr></table></div></div><p>è®“æˆ‘å€‘é¦–å…ˆç‚ºä¸Šåœ–ä¸­çš„ L~C çš„æœŸé–“å®šç¾©ä¸€å€‹æ–°çš„åè© <code>Lock interval</code>ï¼š</p><ul><li>Lock interval çš„èµ·å§‹é»(ä¸Šåœ–L)ï¼šåœ¨ Binlog Prepare éšæ®µå–å¾—æœ€å¾Œä¸€æŠŠé–çš„æ™‚é–“é»ã€‚</li><li>Lock interval çš„çµæŸé»(ä¸Šåœ–C)ï¼šåœ¨ InnoDB Commit éšæ®µé‡‹æ”¾ç¬¬ä¸€æŠŠé–çš„æ™‚é–“é»ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯èªªå°æ–¼ Replica åœ¨è®€å– BinLog æ™‚ï¼š</p><ul><li>last_commited ä½œç‚º Lock interval çš„èµ·å§‹é»ï¼šå› ç‚º Transaction é–‹å§‹åŠ é–çš„é‚è¼¯æ™‚é–“æ˜¯ç›®å‰æœ€å¾Œä¸€å€‹å·²çµæŸ lock interval çš„æœ€å¾Œä¸€å€‹ sequence_numberï¼Œå°±æ˜¯å…¨å±€è®Šé‡ max_committed_transactionã€‚</li><li>sequence_number ä½œç‚º Lock interval çš„çµæŸé»ï¼šå› ç‚ºç•¶è©² Transaction çµæŸ lock interval æ™‚æœƒå°‡è‡ªå·±çš„ sequence_number æ›´æ–°åˆ° max_committed_transactionï¼Œä¹Ÿå°±æ˜¯èªªå°æ–¼ä¸‹å€‹ Transaction è€Œè¨€çš„ last_commitedã€‚</li></ul><p>åœ¨ Replica å›æ”¾æ™‚åªæœ‰ Transaction ä¹‹é–“å¦‚æœ last_commited~sequence_number ä¹‹é–“æœ‰é‡ç–Šå°±å¯ä»¥ä¸¦è¡Œå›æ”¾ã€‚</p><p>å¯¦ç¾æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>å®šç¾©ä¸€å€‹è®Šé‡ <code>last_lwm_timestamp</code>ï¼šç‚ºä¸€å€‹å·²ç¶“å®Œæˆå›æ”¾ Transaction çš„ sequence_number ï¼Œè©² Transaction å…¶ sequence_number ä¹‹å‰çš„æ‰€æœ‰ Transaction éƒ½å·²ç¶“ commitã€‚</li><li>ç•¶ coordinator ç·šç¨‹è®€å–ä¸€å€‹ Transaction çš„ last_committedï¼š<ul><li><p>ç•¶ <code>last_committed</code> &lt; <code>last_lwm_timestamp</code> è¡¨ç¤º Lock interval æœ‰äº¤é›†ï¼Œå› æ­¤å¯ä»¥ä¸Ÿçµ¦ work ç·šç¨‹ä¸¦è¡Œå›æ”¾ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    Trx1 -----L---------C------------&gt;
</span></span><span class=line><span class=cl>    Trx2 ----------L---------C-------&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>ç•¶ <code>last_committed</code> = <code>last_lwm_timestamp</code> é›–ç„¶ Lock interval æ²’æœ‰äº¤é›†ï¼Œä½†æ˜¯è©²æƒ…æ³è¡¨ç¤ºå‰ä¸€å€‹ Transaction å®Œæˆï¼Œæ‰€ä»¥ç•¶å‰ Transaction æ‰æœƒæ‹¿åˆ°å‰ä¸€å€‹çš„ sequence_number ä½œç‚ºè‡ªå·±çš„ last_commitedï¼Œè€Œ <code>last_lwm_timestamp</code> æ˜¯å·²ç¶“ commit çš„ Transactionï¼Œå› æ­¤å¯ä»¥ä¸Ÿçµ¦ work ç·šç¨‹å›æ”¾äº†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    Trx1 -----L----C-----------------&gt;
</span></span><span class=line><span class=cl>    Trx2 ----------L---------C-------&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>ç•¶ <code>last_committed</code> > <code>last_lwm_timestamp</code> è¡¨ç¤º Lock interval æ²’æœ‰äº¤é›†ï¼Œå› æ­¤ä¸èƒ½ä¸Ÿçµ¦ work ç·šç¨‹ä¸¦è¡Œå›æ”¾ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    Trx1 -----L----C-----------------&gt;
</span></span><span class=line><span class=cl>    Trx2 ---------------L----C-------&gt;
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h4 id=commit-parent-based-vs-lock-based--èˆ‰ä¾‹>Commit Parent Based VS Lock Based èˆ‰ä¾‹</h4><p>å‡è¨­æœ‰ä»¥ä¸‹ binlogï¼š</p><p><img src=/p/mysql-mts/Commit-vs-Lock-Binlog-example.png width=755 height=282 srcset="/p/mysql-mts/Commit-vs-Lock-Binlog-example_hu_f5f40e55cf9bafe5.png 480w, /p/mysql-mts/Commit-vs-Lock-Binlog-example_hu_3613004070a757c1.png 1024w" loading=lazy class=gallery-image data-flex-grow=267 data-flex-basis=642px></p><p>åœ¨ Commit Parent Based ä¸‹ï¼š</p><ul><li>sequence_number 1~7 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚</li><li>sequence_number 8 çš„ Transaction å…¶ last_committed æ˜¯ 1ï¼Œæ‰€ä»¥ä¸èƒ½å’Œ sequence_number 1~7ä¸€èµ·åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚
*å‚™è¨»ï¼šåœ¨ Commit Parent Based ä¸‹ï¼Œæ­£ç¢ºçš„ last_committed æ‡‰è©²è¦æ˜¯ 7ï¼Œæ­¤è™•åƒ…æ–¹ä¾¿èˆ‰ä¾‹ä½¿ç”¨ Lock Based èˆ‰ä¾‹ã€‚</li><li>sequence_number 9<del>14 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 7ï¼Œä¸èƒ½å’Œ sequence_number 1</del>8 ä¸€èµ·åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚</li></ul><p>åœ¨ Lock Based ä¸‹ï¼š</p><ul><li>sequence_number 1<del>7 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 0 è¡¨ç¤ºç‚ºåŒä¸€å€‹ Groupï¼Œæ‰€ä»¥ 1</del>7 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚</li><li>sequence_number 8 çš„ last_committed = 1ï¼Œè¡¨ç¤º 8 å’Œ 1<del>7 çš„é–ä¸è¡çªï¼Œå› æ­¤ 1</del>8 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚</li><li>sequence_number 9<del>14 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 7 è¡¨ç¤ºç‚ºåŒä¸€å€‹ Groupï¼ŒåŒæ™‚ 8</del>14 çš„é–ä¸è¡çªï¼Œå› æ¬¡ 8~14 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾</li></ul><h4 id=ç¼ºé™·>ç¼ºé™·</h4><p>åŸºæ–¼ Group Commit çš„ MTS ä¸è«–æ˜¯ Commit Parent Based é‚„æ˜¯ Lock Based éƒ½ä¸€æ¨£ï¼Œéƒ½æ˜¯åªæœ‰åœ¨ Source ä¸Šæ¯å€‹ Group çš„ Transaction è¶³å¤ å¤šï¼Œä¹Ÿå°±æ˜¯ä½µç™¼åº¦å¤ é«˜çš„æƒ…æ³ä¸‹æ‰èƒ½åœ¨ Replica ä¸Šæœ‰è¼ƒå¥½çš„ä¸¦è¡Œå›æ”¾æ•ˆç‡ã€‚</p><p>é›–ç„¶åœ¨ 5.7 æ–°å¢ <code>binlog_group_commit_sync_delay</code>ã€<code>binlog_group_commit_sync_no_delay_count</code>é€™ 2 å€‹è¨­å®šï¼Œå¯ä»¥è®“ä¸€å€‹ Group æœ‰æ›´å¤šçš„ Transactionï¼Œç„¶è€Œæ•ˆæœä»ç„¶ååˆ†æœ‰é™ã€‚</p><h3 id=åŸºæ–¼-writeset-çš„-mts-572280>åŸºæ–¼ WriteSet çš„ MTS (5.7.22ã€8.0)</h3><p>MySQL 5.7 é›–ç„¶é€é Group Commit å„ªåŒ–äº† MTSï¼Œä½†é€™ä¸»è¦æ˜¯å„ªåŒ–åœ¨ Master ä¸Šæœ‰é«˜ä¸¦è¡Œåº¦çš„æƒ…æ³ä¸‹ï¼Œå¦‚æœ Master ä¸¦è¡Œåº¦ä¸é«˜å‰‡åŒä¸€å€‹ Group çš„ Event ç›¸å°å°‘ï¼Œå› æ­¤ Slave å›æ”¾é€Ÿåº¦ç„¡æ³•æœ‰æ•ˆåŠ å¿«ã€‚</p><p>åœ¨ 8.0 ç‚ºäº†è§£æ±ºä¸Šè¿°å•é¡Œï¼Œå³ä½¿åœ¨ Source ä¸Šæ˜¯ä¸²è¡Œ commit çš„ Transactionï¼Œåªè¦äº’ç›¸ä¸è¡çªé‚£éº¼åœ¨ Replica ä¸Šå°±èƒ½ä¸¦è¡Œå›æ”¾ã€‚</p><p>åœ¨ 8.0 æ–°å¢äº† <code>binlog_transaction_dependency_tracking</code> é€™å€‹åƒæ•¸ä¾†æ§åˆ¶ binlog å¯«å…¥ç›¸é—œè³‡è¨Šï¼Œè®“ Replica æ“šæ­¤é€²è¡Œä¸¦è¡Œå›æ”¾ï¼Œæœ‰ä»¥ä¸‹ä¸‰å€‹å€¼ï¼š</p><ul><li>COMMIT_ORDERï¼šä½¿ç”¨ 5.7 Group commit çš„æ–¹å¼åˆ¤æ–·ã€‚</li><li>WRITESETï¼šä½¿ç”¨ WriteSet çš„æ–¹å¼åˆ¤æ–· Transaction æ˜¯å¦æœ‰è¡çªã€‚</li><li>WRITESET_SESSIONï¼šWRITESET çš„åŸºç¤ä¸Šä¿è­‰åŒä¸€å€‹ session å…§çš„ Transaction ä¸å¯ä¸¦è¡Œã€‚</li></ul><h4 id=writeset-ç°¡è¿°>WriteSet ç°¡è¿°</h4><p><code>WriteSet</code> åœ¨ MySQL Group Replication(MGR) ä¸­å°±å·²ç¶“å¯¦ç¾äº†ï¼š</p><p><img src=/p/mysql-mts/MySQL-Group-Replication-Protocol.png width=725 height=328 srcset="/p/mysql-mts/MySQL-Group-Replication-Protocol_hu_e322ba252aa71e47.png 480w, /p/mysql-mts/MySQL-Group-Replication-Protocol_hu_21b180ab73ce6bc5.png 1024w" loading=lazy alt="MySQL Group Replication Protocol" class=gallery-image data-flex-grow=221 data-flex-basis=530px></p><p><strong>MySQL Group Replication Protocol</strong></p><p>ä½¿ç”¨çš„åœ°æ–¹æ˜¯ certify éšæ®µç”¨ä¾†åˆ¤æ–· Transaction æ˜¯å¦å…è¨± commitï¼Œé€™å€‹æ™‚å€™å°±æœƒé€é <code>WriteSet</code> ä¾†åˆ¤æ–·æ˜¯å¦å’Œå…¶ä»– member ä¸Šçš„ Transaction æœ‰è¡çªã€‚</p><blockquote><p>ğŸ’¡ å› ç‚º MGR å¯ä»¥åœ¨å¤šå€‹ member ä¸Šå¯«å…¥ï¼Œå› æ­¤ä¸åƒå–®æ©Ÿæ¨¡å¼å¯ä»¥é€é Lock è¡çªä¾†é¿å… Transaction ä¹‹é–“çš„è¡çªï¼ŒåŒæ™‚ç‚ºäº†æé«˜æ•ˆèƒ½ MGR æ¡ç”¨æ¨‚è§€çš„æ–¹å¼ä¸é€éå…¶ä»–æ–¹å¼é¡å¤–åŠ é–ï¼Œåªæœ‰æº–å‚™ commit çš„æ™‚å€™é€é <code>WriteSet</code> åˆ¤æ–· member ä¹‹é–“çš„ Transaction æ˜¯å¦è¡çªã€‚</p></blockquote><h4 id=writeset-æ‡‰ç”¨åˆ°-mts-ç°¡è¿°>WriteSet æ‡‰ç”¨åˆ° MTS ç°¡è¿°</h4><p>å‡è¨­åœ¨ Source ä¸Š Transaction commit æ™‚é–“è»¸å¦‚ä¸‹ï¼ŒåŒä¸€å€‹æ™‚é–“åªæœ‰ 1~2 å€‹ Transactionï¼š</p><p><img src=/p/mysql-mts/WriteSet-Master-Exe.png width=648 height=380 srcset="/p/mysql-mts/WriteSet-Master-Exe_hu_4b68f14e9e9e9c30.png 480w, /p/mysql-mts/WriteSet-Master-Exe_hu_d08660c747a2776c.png 1024w" loading=lazy alt="Source åŸ·è¡Œç‹€æ³" class=gallery-image data-flex-grow=170 data-flex-basis=409px></p><p>ä¸Šé€”ä¸­æ–¹å¡Šå°æ‡‰ Transaction ä¿®æ”¹çš„è³‡æ–™ç¯„åœï¼Œå¦‚æœæ²’æœ‰é‡ç–Šè¡¨ç¤º Transaction ä¹‹é–“ä¿®æ”¹çš„æ•¸æ“šä¸è¡çªï¼Œé‚£éº¼é€é WriteSet åˆ¤æ–· Transaction ä¹‹é–“æ˜¯å¦è¡çªå¾Œï¼Œå°±å¯ä»¥åœ¨ Replicaä¸Šå¦‚ä¸‹ä¸¦è¡Œï¼š</p><p><img src=/p/mysql-mts/WriteSet-MTS.png width=632 height=370 srcset="/p/mysql-mts/WriteSet-MTS_hu_86231a346efed00b.png 480w, /p/mysql-mts/WriteSet-MTS_hu_be99f3b638c3b1d0.png 1024w" loading=lazy alt="åŸºæ–¼ WriteSet çš„ MTS å›æ”¾ç‹€æ³" class=gallery-image data-flex-grow=170 data-flex-basis=409px></p><p>ä¸éä¸Šåœ–æœ‰å€‹å°å•é¡Œæ˜¯å¯èƒ½ç™¼ç”Ÿ T3 æ¯” T2 æ—©åŸ·è¡Œçš„ç‹€æ³ï¼Œå°è‡´ Source å’Œ Replica ä¸­åŒä¸€å€‹ session ç”¢ç”Ÿæœ‰ä¸åŒçš„åŸ·è¡Œç´€éŒ„ï¼Œå¦‚æœè©•ä¼°å¾Œè¦ºå¾—ä¸å¯æ¥å—æœ‰ä»¥ä¸‹ 2 å€‹æ–¹å¼å¯ä»¥è§£æ±ºï¼š</p><ul><li>slave_preserve_commit_order = ON</li><li>binlog_transaction_dependency_tracking = WRITESET_SESSION</li></ul><p><img src=/p/mysql-mts/slave-preserve-commit-order-on.png width=643 height=385 srcset="/p/mysql-mts/slave-preserve-commit-order-on_hu_e87cd167b19860.png 480w, /p/mysql-mts/slave-preserve-commit-order-on_hu_24a9cbd16fb7acf6.png 1024w" loading=lazy alt="åŸºæ–¼ WRITESET_SESSION æˆ– slave_preserve_commit_order = ON è¨­å®šå¾Œ MTS å›æ”¾ç‹€æ³" class=gallery-image data-flex-grow=167 data-flex-basis=400px></p><p>å¦‚ä¸Šåœ–èª¿æ•´å¾Œå¯ä»¥ç™¼ç¾åŒä¸€å€‹ session çš„éƒ½ä¸èƒ½ä¸¦è¡Œå›æ”¾ã€‚</p><h4 id=å¯¦ç¾æ–¹å¼>å¯¦ç¾æ–¹å¼</h4><h3 id=writeset-æ˜¯ä»€éº¼>WriteSet æ˜¯ä»€éº¼ï¼Ÿ</h3><p>WriteSet æ˜¯ä¸€å€‹ hash æ•¸çµ„ï¼Œå¤§å°ç”± <code>binlog_transaction_dependency_history_size</code> ä¾†æ±ºå®šã€‚</p><p>åœ¨ InooDB ä¿®æ”¹æ•¸æ“šå¾Œï¼Œæœƒå°‡ä¿®æ”¹çš„ row æ•¸æ“šä»¥ä¸‹å…§å®¹é€²è¡Œ hash å¾Œå¯«å…¥ <code>WriteSet</code>ï¼š</p><p><img src=/p/mysql-mts/WriteSet-internal-Structure.png width=1080 height=61 srcset="/p/mysql-mts/WriteSet-internal-Structure_hu_4e3a3c9ac483c1d2.png 480w, /p/mysql-mts/WriteSet-internal-Structure_hu_d2aceffb4048a3f4.png 1024w" loading=lazy alt="WriteSet çµæ§‹" class=gallery-image data-flex-grow=1770 data-flex-basis=4249px></p><ul><li><p>WriteSet ç”¢å‡ºç´°ç¯€</p><blockquote><p>ğŸ’¡ ç”¢ç”Ÿçš„ Hash å€¼çš„æ–¹å¼å¯ä»¥åƒè€ƒ sql/rpl_write_set_handler.cc ä¸­çš„ add_pke function
<a class=link href=https://github.com/mysql/mysql-server/blob/8.0/sql/rpl_write_set_handler.cc target=_blank rel=noopener>mysql-server/rpl_write_set_handler.cc at 8.0 Â· mysql/mysql-server Â· GitHub</a></p></blockquote><p>ç¯„ä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>use</span><span class=w> </span><span class=n>db_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Database</span><span class=w> </span><span class=n>changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>Table</span><span class=p>:</span><span class=w> </span><span class=k>table_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Create</span><span class=w> </span><span class=k>Table</span><span class=p>:</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=k>table_name</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>pk_column</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>uk_column</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>idx_column</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>pk_column</span><span class=o>`</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=o>`</span><span class=n>uk_column</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>uk_column</span><span class=o>`</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>KEY</span><span class=w> </span><span class=o>`</span><span class=n>idx_column</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>idx_column</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>CHARSET</span><span class=o>=</span><span class=n>utf8mb4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>db_name</span><span class=p>.</span><span class=k>table_name</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># é€éç·¨è­¯ mysqld debug åŸ·è¡ŒæŸ¥çœ‹</span>
</span></span><span class=line><span class=cl>~ -&gt; tail -f /tmp/mysqld.trace
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &lt;generate_hash_pke <span class=m>441</span>
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &gt;generate_hash_pke
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &gt;Rpl_transaction_write_set_ctx::add_write_set
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &lt;Rpl_transaction_write_set_ctx::add_write_set <span class=m>51</span>
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> info: pke: PRIMARYÂ½db_nameÂ½7table_nameÂ½106Â½1<span class=p>;</span> hash: <span class=m>10113078337023140702</span>
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &lt;generate_hash_pke <span class=m>441</span>
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &gt;generate_hash_pke
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &gt;Rpl_transaction_write_set_ctx::add_write_set
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> &lt;Rpl_transaction_write_set_ctx::add_write_set <span class=m>51</span>
</span></span><span class=line><span class=cl>T@6: <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> info: pke: uk_columnÂ½db_nameÂ½7table_nameÂ½107Â½1<span class=p>;</span> hash: <span class=m>406567197175550244</span>
</span></span></code></pre></td></tr></table></div></div><p>å½ä»£ç¢¼å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=err>å¦‚æœè¡¨ä¸­å­˜åœ¨ç´¢å¼•ï¼š</span>
</span></span><span class=line><span class=cl>   <span class=err>å°†æ•°æ®åº“åï¼Œè¡¨åä¿¡æ¯å†™å…¥ä¸´æ—¶å˜é‡</span>
</span></span><span class=line><span class=cl>   <span class=err>å¾ªç¯æ‰«æè¡¨ä¸­æ¯ä¸ªç´¢å¼•ï¼š</span>
</span></span><span class=line><span class=cl>        <span class=err>å¦‚æœä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼š</span>
</span></span><span class=line><span class=cl>             <span class=err>é€€å‡ºæœ¬æ¬¡å¾ªç¯ç»§ç»­å¾ªç¯ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=err>å¾ªç¯ä¸¤ç§ç”Ÿæˆæ•°æ®çš„æ–¹å¼</span><span class=p>(</span><span class=err>äºŒè¿›åˆ¶æ ¼å¼å’Œå­—ç¬¦ä¸²æ ¼å¼</span><span class=p>)</span><span class=err>ï¼š</span>
</span></span><span class=line><span class=cl>             <span class=err>å°†ç´¢å¼•åå­—å†™å…¥åˆ°</span><span class=n>pkeä¸­</span><span class=err>ã€‚</span>
</span></span><span class=line><span class=cl>             <span class=err>å°†ä¸´æ—¶å˜é‡ä¿¡æ¯å†™å…¥åˆ°</span><span class=n>pkeä¸­</span><span class=err>ã€‚</span>
</span></span><span class=line><span class=cl>             <span class=err>å¾ªç¯æ‰«æç´¢å¼•ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µï¼š</span>
</span></span><span class=line><span class=cl>                <span class=err>å°†æ¯ä¸€ä¸ªå­—æ®µçš„ä¿¡æ¯å†™å…¥åˆ°</span><span class=n>pkeä¸­</span><span class=err>ã€‚</span>
</span></span><span class=line><span class=cl>                <span class=err>å¦‚æœå­—æ®µæ‰«æå®Œæˆï¼š</span>
</span></span><span class=line><span class=cl>                   <span class=err>å°†</span><span class=n>pkeç”Ÿæˆhashå€¼å¹¶ä¸”å†™å…¥åˆ°å†™é›†åˆä¸­</span><span class=err>ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=err>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸»é”®æˆ–è€…å”¯ä¸€é”®è®°å½•ä¸€ä¸ªæ ‡è®°ï¼Œåé¢é€šè¿‡è¿™ä¸ªæ ‡è®°æ¥</span>
</span></span><span class=line><span class=cl>    <span class=err>åˆ¤å®šæ˜¯å¦ä½¿ç”¨</span><span class=n>Writesetçš„å¹¶è¡Œå¤åˆ¶æ–¹å¼</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=åŸºæ–¼-writeset-çš„-mts-æ€éº¼å¯¦ç¾>åŸºæ–¼ WriteSet çš„ MTS æ€éº¼å¯¦ç¾ï¼Ÿ</h3><p>è©²æ¨¡å¼ä¸‹ Replica åŒæ¨£æ˜¯åŸºæ–¼ Source ç”¢ç”Ÿçš„ binlog ä¸­çš„ <code>last_commited</code> å’Œ <code>sequenct_number</code> ä¾†æ±ºå®šæ˜¯å¦å¯ä»¥ä¸¦è¡Œå›æ”¾ï¼Œä¹Ÿå°±æ˜¯èªªå¦‚æœè¦é€²ä¸€æ­¥å¢åŠ ä¸¦è¡Œå›æ”¾çš„æ•ˆç‡ï¼Œå°±éœ€è¦ç›¡å¯èƒ½ç‚ºæ¯å€‹ Transaction æ‰¾å‡ºæ›´å°çš„ <code>last_commited</code>ã€‚</p><p>åŸºæ–¼ WriteSet çš„ MTS èƒ½æ‰¾å‡ºæ›´å°çš„ <code>last_commited</code> çš„æ–¹å¼å°±æ˜¯ç¶­è­·ä¸€å€‹å…ˆå‰ Transaction æ‰€çµ„æˆçš„ WriteSet çš„æ­·å²ç´€éŒ„ï¼Œä¹‹å¾Œæ–°é€²ä¾†çš„ Transaction è¨ˆç®— WriteSet å¾Œå’Œé€™å€‹æ­·å²ç´€éŒ„é€²è¡Œè¡çªæ¯”å°ï¼Œä»¥æ­¤ä¾†å˜—è©¦æ‰¾å‡ºæ›´å°çš„ <code>last_commited</code>ã€‚</p><h4 id=binlog_transaction_dependency_tracking-ä¸åŒå°-last_commit-çš„è™•ç†>binlog_transaction_dependency_tracking ä¸åŒå° last_commit çš„è™•ç†</h4><p>åŸºæ–¼ WriteSet çš„ MTS å¯¦éš›ä¸Šæ˜¯åŸºæ–¼ ORDER_COMMIT (Group Commit) é€²ä¸€æ­¥è™•ç†è€Œå·²ã€‚</p><p>æ ¹æ“š binlog_transaction_dependency_tracking çš„è¨­å®šä¸åŒï¼Œåœ¨ Source code æœ‰å¦‚ä¸‹å…§å®¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>case</span> <span class=nl>DEPENDENCY_TRACKING_COMMIT_ORDER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>m_commit_order</span><span class=p>.</span><span class=n>get_dependency</span><span class=p>(</span><span class=n>thd</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nl>DEPENDENCY_TRACKING_WRITESET</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>m_commit_order</span><span class=p>.</span><span class=n>get_dependency</span><span class=p>(</span><span class=n>thd</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>m_writeset</span><span class=p>.</span><span class=n>get_dependency</span><span class=p>(</span><span class=n>thd</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nl>DEPENDENCY_TRACKING_WRITESET_SESSION</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>m_commit_order</span><span class=p>.</span><span class=n>get_dependency</span><span class=p>(</span><span class=n>thd</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>m_writeset</span><span class=p>.</span><span class=n>get_dependency</span><span class=p>(</span><span class=n>thd</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>m_writeset_session</span><span class=p>.</span><span class=n>get_dependency</span><span class=p>(</span><span class=n>thd</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°å¾ COMMIT_ORDER åˆ° WRITESET å†åˆ° WRITESET_SESSION å…¶å¯¦éƒ½æ˜¯ä»¥ä¸Šä¸€å€‹è¨­å®šçš„ç‚ºåŸºç¤é€²ä¸€æ­¥é€éä¸€å€‹æ–°çš„ function é€²è¡Œä¿®æ”¹è€Œå·²ï¼Œé€™äº› function ä¿®æ”¹çš„æ˜¯ <code>last_commited</code> å€¼ã€‚</p><h4 id=writeset-æ­·å²ç´€éŒ„è©³è§£>WriteSet æ­·å²ç´€éŒ„è©³è§£</h4><p>WriteSet çš„æ­·å²ç´€éŒ„åŒ…å«äº† 2 å€‹å…ƒç´ ï¼š</p><ul><li>WriteSet çš„ Hash å€¼</li><li>æœ€å¾Œä¸€æ¬¡ä¿®æ”¹è©²è¡Œçš„ Transaction å…¶ <code>sequence_number</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    Track the last transaction sequence number that changed each row
</span></span></span><span class=line><span class=cl><span class=cm>    in the database, using row hashes from the writeset as the index.
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>  <span class=k>typedef</span> <span class=n>std</span><span class=o>::</span><span class=n>map</span><span class=o>&lt;</span><span class=n>uint64</span><span class=p>,</span><span class=n>int64</span><span class=o>&gt;</span> <span class=n>Writeset_history</span><span class=p>;</span> <span class=c1>//mapå®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Writeset_history</span> <span class=n>m_writeset_history</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦å¤– <code>binlog_transaction_dependency_history_size</code> æ±ºå®šäº†å¯ä»¥å„²å­˜å¹¾çµ„ç´€éŒ„ï¼Œå…§éƒ¨æœƒä¾ç…§ WriteSet Hash å€¼é€²è¡Œæ’åºã€‚</p><p>å¦‚æœ WriteSet çš„æ­·å²ç´€éŒ„é”åˆ° <code>binlog_transaction_dependency_history_size</code> è¨­å®šçš„å€¼å°±æœƒå°‡æ­·å²ç´€éŒ„æ¸…ç©ºï¼Œä¸¦ä¸”æœ¬æ¬¡çš„ Transaction æœƒæˆç‚ºæ¸…ç©ºå¾Œæ­·å²ç´€éŒ„çš„ç¬¬ä¸€ç­†ç´€éŒ„ã€‚</p><p>å¦å¤–é™¤äº†æ­·å²ç´€éŒ„é‚„æœ‰æœ‰ä¸€å€‹ <code>m_writeset_history_start</code> çš„å€¼ï¼Œç”¨ä¾†å„²å­˜é€™å€‹æ­·å²ç´€éŒ„ä¸­çš„æœ€å° <code>sequence_number</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>exceeds_capacity</span> <span class=o>||</span> <span class=o>!</span><span class=n>can_use_writesets</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//Writesetçš„å†å²MAPå·²æ»¡
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>m_writeset_history_start</span><span class=o>=</span> <span class=n>sequence_number</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=c1>//å¦‚æœè¶…è¿‡æœ€å¤§è®¾ç½®ï¼Œæ¸…ç©ºwriteset historyã€‚ä»å½“å‰seq number é‡æ–°è®°å½•ï¼Œ ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªäº‹åŠ¡seq number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>m_writeset_history</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>//æ¸…ç©ºå†å²MAP
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=writeset-mts-å°-last_commit-çš„è™•ç†æµç¨‹>WriteSet MTS å° last_commit çš„è™•ç†æµç¨‹</h4><p>é€™è£¡é€éä¸€å€‹ä¾‹å­è§£é‡‹ï¼Œå‡è¨­å¦‚ä¸‹ï¼š</p><ul><li>ç•¶å‰çš„ Transaction åŸºæ–¼ ORDER_COMMIT (Group Commit) çš„æ–¹å¼ç”¢ç”Ÿäº†çµæœï¼š<ul><li>last_commit = 125</li><li>sequence_number = 130</li></ul></li><li>è©² Transaction ä¿®æ”¹çš„è¡¨åªæœ‰ PK æ²’æœ‰ UKã€‚</li><li>è©² Transaction ä¿®æ”¹äº† 4 è¡Œè³‡æ–™ï¼Œåˆ†åˆ¥ç‚º ROW1ã€ROW7ã€ROW6ã€ROW10ã€‚</li></ul><p>ä¸‹åœ–å±•ç¤ºäº†è©² Transaction å’Œ WriteSet æ­·å²ç´€éŒ„ï¼š</p><p><img src=/p/mysql-mts/WriteSet-search-lastCommit.png width=1120 height=1069 srcset="/p/mysql-mts/WriteSet-search-lastCommit_hu_615814ac450fa60f.png 480w, /p/mysql-mts/WriteSet-search-lastCommit_hu_d78a2671fa2b38d4.png 1024w" loading=lazy class=gallery-image data-flex-grow=104 data-flex-basis=251px></p><p>æ¥ä¸‹ä¾†å°±æœƒé€é WriteSet æ–¹å¼æ‰¾åˆ°æ›´å°çš„ last_commitï¼š</p><ol><li><p>å°‡ last_commit ç”± 125 èª¿æ•´ç‚º 100 (æ­·å²ç´€éŒ„ä¸­æœ€å°çš„ sequence_number <code>m_writeset_history_start</code>)ã€‚</p><p>å‚™è¨»ï¼šå› ç‚ºè©² Transaction æ¯”æ­·å²ç´€éŒ„ä¸­çš„ Transaction æ™šåŸ·è¡Œï¼Œå› æ­¤ last_commit ä¸€å®šéƒ½æ¯”ä»–å€‘çš„ sequence_number å¤§ã€‚</p></li><li><p>å°‡ ROW1 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š</p><ul><li>å°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 120 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚</li><li>å°‡è©² Transaction çš„ last_commit ç”± 100 èª¿æ•´ç‚º 120ã€‚</li></ul></li><li><p>å°‡ ROW7 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š</p><ul><li>å°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 114 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚</li><li>ç•¶å‰ Transaction ç•¶å‰ last_commit ç‚º 120 æ¯”æ­·å²ç´€éŒ„ä¸­çš„ 114 å¤§ï¼Œå› ç‚ºåœ¨ 120 å°±è¡çªäº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹æˆæ›´å°çš„ 114ï¼Œå› æ­¤ last_commit ä¸è®Šä¾èˆŠæ˜¯ 120ã€‚</li></ul></li><li><p>å°‡ ROW6 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š</p><ul><li>å°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 105 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚</li><li>ç•¶å‰ Transaction ç•¶å‰ last_commit ç‚º 120 æ¯”æ­·å²ç´€éŒ„ä¸­çš„ 105 å¤§ï¼Œå› ç‚ºåœ¨ 120 å°±è¡çªäº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹æˆæ›´å°çš„ 105ï¼Œå› æ­¤ last_commit ä¸è®Šä¾èˆŠæ˜¯ 120ã€‚</li></ul></li><li><p>å°‡ ROW10 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾ä¸¦æ²’æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š</p><ul><li>å› ç‚ºæ²’æœ‰æ‰¾åˆ°ç›¸åŒçš„ WriteSetï¼Œå› æ­¤éœ€è¦æŠŠè©² Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number å¯«å…¥ WriteSet æ­·å²ç´€éŒ„ã€‚<ul><li>å¦‚æœæ­·å²ç´€éŒ„å¤§å°è¶…é <code>binlog_transaction_dependency_history_size</code>ï¼Œå‰‡æ¸…ç©ºç•¶å‰æ­·å²ç´€éŒ„ï¼Œéš¨å¾Œå°‡ Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number(130) å¯«å…¥ WriteSet æ–°çš„æ­·å²ç´€éŒ„ï¼Œä¸¦å°‡ <code>m_writeset_history_start</code> æ”¹ç‚º 130ã€‚</li><li>å¦‚æœæ­·å²ç´€éŒ„å¤§å°æ²’æœ‰è¶…é <code>binlog_transaction_dependency_history_size</code>ï¼Œå°‡ Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number(130) å¯«å…¥ WriteSet ç•¶å‰æ­·å²ç´€éŒ„ã€‚</li></ul></li></ul></li></ol><p>æ•´å€‹éç¨‹çµæŸï¼Œè©² Transaction çš„ last_commit ç”±åŸæœ¬çš„ 125 é™ä½ç‚º 120ï¼Œæœ€å¾Œçµæœå¦‚ä¸‹åœ–ï¼š</p><p><img src=/p/mysql-mts/WriteSet-Change-lastCommit.png width=1117 height=1104 srcset="/p/mysql-mts/WriteSet-Change-lastCommit_hu_5ae3d1b1f4d24fcd.png 480w, /p/mysql-mts/WriteSet-Change-lastCommit_hu_35d7a891f6ed0d5f.png 1024w" loading=lazy class=gallery-image data-flex-grow=101 data-flex-basis=242px></p><ul><li><p>è©²éç¨‹åœ¨ Function <code>Writeset_trx_dependency_tracker::get_dependency</code> ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>can_use_writesets</span><span class=p>)</span> <span class=c1>//å¦‚æœèƒ½å¤Ÿä½¿ç”¨writeset æ–¹å¼
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     Check if adding this transaction exceeds the capacity of the writeset
</span></span></span><span class=line><span class=cl><span class=cm>     history. If that happens, m_writeset_history will be cleared only after  è€Œ add_pke
</span></span></span><span class=line><span class=cl><span class=cm>     using its information for current transaction.
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=n>exceeds_capacity</span><span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>m_writeset_history</span><span class=p>.</span><span class=n>size</span><span class=p>()</span> <span class=o>+</span> <span class=n>writeset</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>m_opt_max_history_size</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=c1>//å¦‚æœå¤§äºå‚æ•°binlog_transaction_dependency_history_sizeè®¾ç½®æ¸…ç†æ ‡è®°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     Compute the greatest sequence_number among all conflicts and add the
</span></span></span><span class=line><span class=cl><span class=cm>     transaction&#39;s row hashes to the history.
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=n>int64</span> <span class=n>last_parent</span><span class=o>=</span> <span class=n>m_writeset_history_start</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//ä¸´æ—¶å˜é‡ï¼Œé¦–å…ˆè®¾ç½®ä¸ºæœ€å°çš„ä¸€ä¸ªseq number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>set</span><span class=o>&lt;</span><span class=n>uint64</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>it</span><span class=o>=</span> <span class=n>writeset</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>();</span> <span class=n>it</span> <span class=o>!=</span> <span class=n>writeset</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>();</span> <span class=o>++</span><span class=n>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//å¾ªç¯æ¯ä¸€ä¸ªWritesetä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Writeset_history</span><span class=o>::</span><span class=n>iterator</span> <span class=n>hst</span><span class=o>=</span> <span class=n>m_writeset_history</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=o>*</span><span class=n>it</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//æ˜¯å¦åœ¨writeset historyä¸­ å·²ç»å­˜åœ¨äº†ã€‚ mapä¸­çš„å…ƒç´ æ˜¯ keyæ˜¯writeset å€¼æ˜¯sequence number
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>hst</span> <span class=o>!=</span> <span class=n>m_writeset_history</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=c1>//å¦‚æœå­˜åœ¨
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>    
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>hst</span><span class=o>-&gt;</span><span class=n>second</span> <span class=o>&gt;</span> <span class=n>last_parent</span> <span class=o>&amp;&amp;</span> <span class=n>hst</span><span class=o>-&gt;</span><span class=n>second</span> <span class=o>&lt;</span> <span class=n>sequence_number</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>          <span class=n>last_parent</span><span class=o>=</span> <span class=n>hst</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//å¦‚æœå·²ç»å¤§äºäº†ä¸éœ€è¦è®¾ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>hst</span><span class=o>-&gt;</span><span class=n>second</span><span class=o>=</span> <span class=n>sequence_number</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=c1>//æ›´æ”¹è¿™è¡Œè®°å½•çš„sequence_number
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>exceeds_capacity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>m_writeset_history</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>pair</span><span class=o>&lt;</span><span class=n>uint64</span><span class=p>,</span> <span class=n>int64</span><span class=o>&gt;</span><span class=p>(</span><span class=o>*</span><span class=n>it</span><span class=p>,</span> <span class=n>sequence_number</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>//æ²¡æœ‰å†²çªåˆ™æ’å…¥ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>......</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>write_set_ctx</span><span class=o>-&gt;</span><span class=n>get_has_missing_keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1>//å¦‚æœæ²¡æœ‰ä¸»é”®å’Œå”¯ä¸€é”®é‚£ä¹ˆä¸æ›´æ”¹last commit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>       The WRITESET commit_parent then becomes the minimum of largest parent
</span></span></span><span class=line><span class=cl><span class=cm>       found using the hashes of the row touched by the transaction and the
</span></span></span><span class=line><span class=cl><span class=cm>       commit parent calculated with COMMIT_ORDER.
</span></span></span><span class=line><span class=cl><span class=cm>      */</span><span class=err>ï¼›</span>
</span></span><span class=line><span class=cl>      <span class=n>commit_parent</span><span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>last_parent</span><span class=p>,</span> <span class=n>commit_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//è¿™é‡Œå¯¹last commitåšæ›´æ”¹äº†ã€‚é™ä½ä»–çš„last commit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>exceeds_capacity</span> <span class=o>||</span> <span class=o>!</span><span class=n>can_use_writesets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>m_writeset_history_start</span><span class=o>=</span> <span class=n>sequence_number</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=c1>//å¦‚æœè¶…è¿‡æœ€å¤§è®¾ç½® æ¸…ç©ºwriteset historyã€‚ä»å½“å‰sequence é‡æ–°è®°å½• ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªäº‹åŠ¡seqnuce number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>m_writeset_history</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=c1>//æ¸…ç©ºçœŸä¸ªMAP
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=writeset_session-æ€éº¼åš>WRITESET_SESSION æ€éº¼åš?</h4><p>å‰é¢æœ‰æåˆ°é WRITESET_SESSION æ˜¯åŸºæ–¼ WRITESET çš„åŸºç¤ä¸Šç¹¼çºŒè™•ç†çš„ï¼ŒWRITESET_SESSION è¦åšåˆ°çš„æ˜¯åŒä¸€å€‹ session çš„ Transaction ä¸èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼Œè¦å¯¦ç¾éå¸¸ç°¡å–®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>int64</span> <span class=n>session_parent</span><span class=o>=</span> <span class=n>thd</span><span class=o>-&gt;</span><span class=n>rpl_thd_ctx</span><span class=p>.</span><span class=n>dependency_tracker_ctx</span><span class=p>().</span>
</span></span><span class=line><span class=cl>                        <span class=n>get_last_session_sequence_number</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>//å–æœ¬sessionçš„ä¸Šä¸€æ¬¡äº‹åŠ¡çš„seq number
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>session_parent</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>session_parent</span> <span class=o>&lt;</span> <span class=n>sequence_number</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=c1>//å¦‚æœæœ¬sessionå·²ç»åšè¿‡äº‹åŠ¡å¹¶ä¸”æœ¬æ¬¡å½“å‰çš„seq numberå¤§äºä¸Šä¸€æ¬¡çš„seq number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>commit_parent</span><span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>commit_parent</span><span class=p>,</span> <span class=n>session_parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//è¯´æ˜è¿™ä¸ªsessionåšè¿‡å¤šæ¬¡äº‹åŠ¡ä¸å…è®¸å¹¶å‘ï¼Œä¿®æ”¹ä¸ºorder_commitç”Ÿæˆçš„last commit
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>thd</span><span class=o>-&gt;</span><span class=n>rpl_thd_ctx</span><span class=p>.</span><span class=n>dependency_tracker_ctx</span><span class=p>().</span>
</span></span><span class=line><span class=cl>    <span class=n>set_last_session_sequence_number</span><span class=p>(</span><span class=n>sequence_number</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//è®¾ç½®session_parentçš„å€¼ä¸ºæœ¬æ¬¡seq numberçš„å€¼
</span></span></span></code></pre></td></tr></table></div></div><h4 id=é—œæ–¼-binlog_transaction_dependency_history_size-åƒæ•¸èªªæ˜>é—œæ–¼ binlog_transaction_dependency_history_size åƒæ•¸èªªæ˜</h4><p>è©²åƒæ•¸é»˜èªå€¼ç‚º 25000ï¼Œä»£è¡¨çš„æ˜¯ WriteSet è£¡å…ƒç´ çš„æ•¸é‡ã€‚</p><p>å¾å‰é¢ WriteSet å¯¦ç¾ç´°ç¯€èªªæ˜ä¸­æˆ‘å€‘å¯ä»¥çŸ¥é“ä¿®æ”¹ä¸€è¡Œæ•¸æ“šå¯èƒ½æœƒç”¢ç”Ÿå¤šå€‹ Hashï¼Œæ‰€ä»¥é€™å€‹å€¼ä¸æœƒç­‰æ–¼ä¿®æ”¹çš„è¡Œæ•¸ï¼Œå¯ä»¥ç†è§£ç‚ºå¦‚ä¸‹ï¼š</p><ul><li>5.7 ç‰ˆæœ¬ï¼šbinlog_transaction_dependency_history_size = ä¿®æ”¹çš„è¡Œæ•¸ * ( 1 + UK æ•¸é‡ ) * 2</li><li>8.0 ç‰ˆæœ¬ï¼šbinlog_transaction_dependency_history_size = ä¿®æ”¹çš„è¡Œæ•¸ * ( 1 + UK æ•¸é‡ )</li></ul><p>å‚™è¨»ï¼šä¸åŒåŸå› åœ¨æ–¼ 5.7 æœƒç”ŸæˆåŒ…å« collation å’Œä¸åŒ…å« collationï¼Œåœ¨ 8.0 ä¸­å‰‡æ²’æœ‰ã€‚</p><p>å¦‚æœå°‡é€™å€‹åƒæ•¸åŠ å¤§ï¼Œé‚£éº¼ Source ä¸Šçš„ WriteSet å°±èƒ½æ”¾è¶Šå¤šçš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯èªª Transaction å¯ä»¥ç”Ÿæˆæ›´å°çš„ last_commitedï¼Œé€™åœ¨ Replica ä¸Šå°±èƒ½æé«˜ä¸¦è¡Œå›æ”¾çš„æ•ˆç‡ï¼Œç•¶ç„¶ç¼ºé»å°±æ˜¯åœ¨ Source æœƒæ¶ˆè€—æ›´å¤šçš„è³‡æºã€‚</p><h4 id=writeset-ä¸é©ç”¨æƒ…å¢ƒ>WriteSet ä¸é©ç”¨æƒ…å¢ƒ</h4><p>ä»¥ä¸‹æƒ…å¢ƒä¸é©ç”¨ WriteSetï¼ŒMySQL æœƒè‡ªå‹•é€€å›ä½¿ç”¨ commit_order (åŸºæ–¼ group commit) æ¨¡å¼</p><ol><li>æ²’æœ‰ PK ä¹Ÿæ²’æœ‰ UK</li><li>DDL</li><li>session çš„ hash ç®—æ³•æ› history ä¸åŒ</li><li>Transaction æ›´æ–°äº†æœ‰ Forign key é—œè¯çš„æ¬„ä½</li></ol><h2 id=slave_><strong>slave_preserve_commit_order ä»‹ç´¹</strong></h2><p>ç•¶é–‹å•Ÿ MTS ä¸” slave_parallel_type = LOGICAL_CLOCK (ä¸è«–å…·é«”æ˜¯åŸºæ–¼ commit_order é‚„æ˜¯ writeset) çš„æ™‚å€™ï¼Œæœ‰å¯èƒ½æœƒç™¼ç”Ÿ Source å’Œ Replica åŸ·è¡Œé †åºä¸åŒçš„æƒ…æ³ï¼Œé›–ç„¶é€™ä¸¦ä¸æœƒå°è‡´è³‡æ–™ä¸ä¸€è‡´çš„ç‹€æ³ï¼Œä½†æ˜¯å¯èƒ½æœƒç™¼ç”Ÿåœ¨ Source ä¸Šå…ˆçœ‹åˆ° T1 æ‰çœ‹åˆ° T2 å»åœ¨ Replica ä¸Šå»æ˜¯å…ˆçœ‹åˆ° T2 æ‰çœ‹åˆ° T1 åŸ·è¡Œï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ Source å’Œ Replica å„è‡ªçš„ binlog æ­·å²ç´€éŒ„é †åºä¹Ÿæœƒä¸ä¸€è‡´ï¼Œæ²’æœ‰ä¿è­‰ <code>Causal Consistency</code>ã€‚</p><blockquote><p>ğŸ’¡ <code>Causal Consistency</code> (å› æœä¸€è‡´æ€§) æ„æ€æ˜¯å¦‚æœå…©å€‹äº‹ä»¶æœ‰å› æœé—œä¿‚ï¼Œé‚£éº¼åœ¨æ‰€æœ‰ç¯€é»éƒ½å¿…é ˆèƒ½è§€æ¸¬åˆ°é€™ç¨®å› æœé—œä¿‚ã€‚</p></blockquote><p>å¦‚æœè©•ä¼°æ¥­å‹™éœ€è¦ä¿è­‰<code>Causal Consistency</code>ï¼Œé™¤äº†ä¸ä½¿ç”¨ MTS ä½¿ç”¨å–®ç·šç¨‹ replication ä¹Ÿå¯ä»¥é€éè¨­ç½® <code>slave_preserve_commit_order=ON</code> ä¾†é¿å…ï¼Œé€™æœƒè®“ Replica ä¸Šå›æ”¾çš„ Transaction åœ¨é€²å…¥ flush éšæ®µä¹‹å‰æœƒå…ˆç­‰å¾… sequence_number ä¹‹å‰çš„ Transaction å…ˆé€²å…¥ flush éšæ®µã€‚</p><h3 id=gap>GAP</h3><p>å¦‚æœ <code>slave_preserve_commit_order = OFF</code> é™¤äº†ä¸Šé¢æåˆ° <code>Causal Consistency</code> é‚„æœ‰ä¸€å€‹å•é¡Œåœ¨å®˜æ–¹æ–‡æª”ä¸­ç¨±ç‚º GAPã€‚</p><p>é–‹å•Ÿ MTS æ™‚é€é show slave status æŸ¥çœ‹ <code>Exec_Source_Log_Pos</code> æŒ‡çš„æ˜¯ <code>low-watermark</code> ä¹Ÿå°±æ˜¯ä¿è­‰é€™å€‹ postition ä¹‹å‰çš„ Transaction éƒ½å·²ç¶“ commitï¼Œä½†æ˜¯è©² postition ä¹‹å¾Œçš„ Transaction æœ‰å¯èƒ½ commit ä¹Ÿå¯èƒ½æ²’æœ‰ commitï¼Œ</p><h2 id=ç›¸é—œåƒæ•¸>ç›¸é—œåƒæ•¸</h2><ul><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_slave_parallel_workers target=_blank rel=noopener>slave_parallel_workers</a> (5.6 ~ 8.0.25)ã€<a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_parallel_workers target=_blank rel=noopener>replica_parallel_workers</a> (8.0.26 ~)</p><p><img src=/p/mysql-mts/slave-parallel-workers.png width=575 height=343 srcset="/p/mysql-mts/slave-parallel-workers_hu_4d041eb8e44d22f6.png 480w, /p/mysql-mts/slave-parallel-workers_hu_ec466e839f6fe4b6.png 1024w" loading=lazy class=gallery-image data-flex-grow=167 data-flex-basis=402px></p><p>è¨­å®šè¦åœ¨ replica ä¸¦è¡Œçš„ thread æ•¸é‡ã€‚</p><p>å¦‚æœ slave æœ‰å¤šå€‹ channelï¼Œå‰‡æ¯å€‹ channel éƒ½æœƒæœ‰æ­¤æ•¸é‡çš„ threadã€‚</p><p>è¨­ç½®æ­¤åƒæ•¸å¾Œå¿…é ˆé‡æ–° START REPLICA æ‰æœƒç”Ÿæ•ˆã€‚</p></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_slave_parallel_type target=_blank rel=noopener>slave_parallel_type</a> (5.7 ~ 8.0.25)ã€<a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_parallel_type target=_blank rel=noopener>replica_parallel_type</a> (8.0.26 ~ 8.0.29)</p><p><img src=/p/mysql-mts/replica-parallel-type.png width=574 height=366 srcset="/p/mysql-mts/replica-parallel-type_hu_3bead051496654f6.png 480w, /p/mysql-mts/replica-parallel-type_hu_1946b811ede79cec.png 1024w" loading=lazy class=gallery-image data-flex-grow=156 data-flex-basis=376px></p><p>è¨­å®šåœ¨ replica ä¸Šå…è¨±å“ªäº› Transaction ä¸¦è¡Œå›æ”¾</p><ul><li>DATABASEï¼šTransaction å¿…é ˆä½œç”¨æ–¼ä¸åŒ Database æ‰èƒ½ä¸¦è¡Œã€‚</li><li>LOGICAL_CLOCKï¼šåŸºæ–¼ Source å¯«å…¥ binlog çš„ timestamp ä¾†æ±ºå®š Transaction çš„ä¸¦è¡Œï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ Group Commitã€‚</li></ul><p>å»ºè­°å°‡ binlog_transaction_dependency_tracking è¨­ç½®ç‚º WRITESET æˆ– WRITESET_SESSION ï¼Œé€™æ¨£åœ¨åˆé©çš„æƒ…æ³ä¸‹æœƒèµ° WriteSet ä¾†æé«˜ä¸¦è¡Œåº¦ã€‚</p><p>é è¨ˆ 8.0.29 ä¹‹å¾Œæ£„ç”¨æ­¤åƒæ•¸ï¼Œç¸½æ˜¯ä»¥ LOGICAL_CLOCK çš„æ–¹å¼é‹è¡Œã€‚</p></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_group_commit_sync_delay target=_blank rel=noopener>binlog_group_commit_sync_delay</a></p><p><img src=/p/mysql-mts/binlog-group-commit-sync-delay.png width=575 height=313 srcset="/p/mysql-mts/binlog-group-commit-sync-delay_hu_ef403cd4f4b0234.png 480w, /p/mysql-mts/binlog-group-commit-sync-delay_hu_d0b4236f64d57c5d.png 1024w" loading=lazy class=gallery-image data-flex-grow=183 data-flex-basis=440px></p><p>æ§åˆ¶ binlog commit ä¹‹å¾Œç­‰å¾… N å¾®ç§’å¾Œæ‰ fsync åˆ° Diskï¼Œè¨­ç½®è¶Šå¤§å–®å€‹ Group å¯ä»¥æœ‰æ›´å¤šæ™‚é–“ç­‰åˆ°æ›´å¤šçš„ Transaction ä¸€èµ· fsync Diskï¼Œæ¸›å°‘ fsync çš„æ¬¡æ•¸åŠæ¸›å°‘æ¯å€‹ Transaction commit çš„å–®ä½æ™‚é–“ã€‚</p><p>æ­¤å¤–é©åº¦çš„å¢åŠ å°æ–¼ä»¥ä¸‹è¨­ç½®çš„ MTS ä¹Ÿèƒ½å¢åŠ åœ¨ Slave çš„ä¸¦è¡Œåº¦ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Master
</span></span><span class=line><span class=cl>binlog_transaction_dependency_tracking = COMMIT_ORDER
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Slave
</span></span><span class=line><span class=cl>slave_parallel_type = LOGICAL_CLOCK
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„ï¼šæœƒå¢åŠ  server ä¸Š transaction çš„å»¶é²ï¼Œä¹Ÿå°±æ˜¯ client ç«¯æ”¶åˆ° transaction commit çš„æ™‚é–“æœƒè®Šæ™šï¼Œå¦å¤–ç›¸æ‡‰çš„æœƒå¢åŠ è³‡æºçš„ç«¶çˆ­ï¼Œå› æ­¤éœ€è©•ä¼°æœ€å¥½çš„è¨­ç½®ã€‚</p><p>è£œå……ï¼šåœ¨æœ‰ Group Commit ä¹‹å¾Œï¼Œsync_binlog çš„å–®ä½æŒ‡çš„æ˜¯ Group è€Œä¸æ˜¯ Transactionï¼Œä¾‹å¦‚ï¼šsync_binlog = 1000ï¼Œè¡¨ç¤ºçš„ä¸æ˜¯æ¯ 1000 å€‹ Transaction å°± sync binlogï¼Œè€Œæ˜¯æ¯ 1000 å€‹ Group æ‰ sync binlogã€‚</p></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_group_commit_sync_no_delay_count target=_blank rel=noopener>binlog_group_commit_sync_no_delay_count</a></p><p><img src=/p/mysql-mts/binlog-group-commit-sync-no-delay-count.png width=575 height=285 srcset="/p/mysql-mts/binlog-group-commit-sync-no-delay-count_hu_31a81363cebe4293.png 480w, /p/mysql-mts/binlog-group-commit-sync-no-delay-count_hu_4454de47c2d58f5c.png 1024w" loading=lazy class=gallery-image data-flex-grow=201 data-flex-basis=484px></p><p>åœ¨ Group commit ä¸­ç­‰å¾…çš„ N å€‹ Transaction å¾Œå°±ä¸ç­‰å¾… binlog_group_commit_sync_delay è¨­ç½®çš„æ™‚é–“ç›´æ¥é–‹å§‹ sync binlogã€‚</p><p>ç•¶ binlog_group_commit_sync_delay = 0 ï¼Œæ­¤åƒæ•¸ç„¡æ•ˆã€‚</p></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_slave_preserve_commit_order target=_blank rel=noopener>slave_preserve_commit_order</a> (5.7 ~ 8.0.25)ã€<a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_preserve_commit_order target=_blank rel=noopener>replica_preserve_commit_order</a> (8.0.26 ~)</p><p><img src=/p/mysql-mts/slave-preserve-commit-order.png width=576 height=281 srcset="/p/mysql-mts/slave-preserve-commit-order_hu_850124080f73874.png 480w, /p/mysql-mts/slave-preserve-commit-order_hu_59b2b2377aa92ade.png 1024w" loading=lazy class=gallery-image data-flex-grow=204 data-flex-basis=491px></p><p>åªæœ‰ç•¶ slave_parallel_type = LOGICAL_CLOCK ä¸” log-slave-updates é–‹å•Ÿæ™‚æ‰èƒ½è¨­ç½®ã€‚</p><p>ç•¶è¨­ç½®ç‚º 0 æˆ– OFF æ™‚ï¼Œåœ¨ Replica ä¸Šçš„è®€å–æ“ä½œç„¡æ³•æ»¿è¶³ <code>Causal Consistency</code> ï¼Œåœ¨ Source å’Œ Replica ä¸Š Transaction åœ¨ binlog ä¸­å¯èƒ½æœ‰ä¸åŒçš„å¯«å…¥é †åºï¼Œå¦å¤–åœ¨æª¢æŸ¥ Replica ä¸Šæœ€è¿‘åŸ·è¡Œçš„ Transaction ç„¡æ³•ä¿è­‰å°æ‡‰åˆ° Source ä¸Šè©² Transaction ä½ç½®ä¹‹å‰çš„ Transaction éƒ½å·²ç¶“åŸ·è¡Œå®Œç•¢ã€‚</p><p>è¨­ç½®ç‚º 1 æˆ– ON ç¢ºä¿ Transaction åœ¨åŸ·è¡Œæ™‚æŒ‰ç…§åœ¨ relay log ä¸­çš„é †åºï¼Œé€™å¯ä»¥è®“ Master å’Œ Replica æœ‰ç›¸åŒçš„ Transaction history logï¼Œä¹Ÿå°±æ˜¯ç¬¦åˆ <code>Causal Consistency</code>ã€‚</p></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_transaction_dependency_tracking target=_blank rel=noopener>binlog_transaction_dependency_tracking</a> (5.7.22 ~)</p><p><img src=/p/mysql-mts/binlog-transaction-dependency-tracking.png width=575 height=298 srcset="/p/mysql-mts/binlog-transaction-dependency-tracking_hu_706dc27ebec643cc.png 480w, /p/mysql-mts/binlog-transaction-dependency-tracking_hu_3fd8ed4baf5eeb2c.png 1024w" loading=lazy class=gallery-image data-flex-grow=192 data-flex-basis=463px></p><p>æŒ‡å®š Source ä¾æ“šä»€éº¼æ–¹å¼ä¾†ç”Ÿæˆ Transaction ä¹‹é–“çš„ä¾è³´é—œä¿‚å¯«å…¥ binlogï¼Œå”åŠ© Replica ç¢ºå®šé‚£äº› Transaction èƒ½å¤ ä¸¦è¡ŒåŸ·è¡Œã€‚</p><p>å¿…é ˆè¨­ç½® replica_parallel_type ç‚º LOGICAL_CLOCKã€‚</p><p>æœ‰ä»¥ä¸‹ä¸‰ç¨®å€¼ï¼š</p><ul><li>COMMIT_ORDERï¼šä½¿ç”¨ 5.7 Group commit çš„æ–¹å¼åˆ¤æ–·ã€‚</li><li>WRITESETï¼šä½¿ç”¨ WriteSet çš„æ–¹å¼åˆ¤æ–· Transaction æ˜¯å¦æœ‰è¡çªã€‚</li><li>WRITESET_SESSIONï¼šWRITESET çš„åŸºç¤ä¸Šä¿è­‰åŒä¸€å€‹ session å…§çš„ Transaction ä¸å¯ä¸¦è¡Œã€‚</li></ul></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_transaction_dependency_history_size target=_blank rel=noopener>binlog_transaction_dependency_history_size</a> (8.0 ~)</p><p><img src=/p/mysql-mts/binlog-transaction-dependency-history.png width=573 height=281 srcset="/p/mysql-mts/binlog-transaction-dependency-history_hu_1415df38253b7d55.png 480w, /p/mysql-mts/binlog-transaction-dependency-history_hu_fdc1f13a3e149985.png 1024w" loading=lazy class=gallery-image data-flex-grow=203 data-flex-basis=489px></p><p>WriteSet æœƒåˆ¤æ–· Transaction ä¹‹é–“æ˜¯å¦è¡çªï¼Œå› æ­¤éœ€è¦å°‡ commit çš„ Transaction ä¿®æ”¹çš„è¡Œ hash å¾Œæš«æ™‚ä¿å­˜åœ¨å…§å­˜ã€‚</p><p>æ­¤åƒæ•¸ç”¨ä¾†è¨­å®šå„²å­˜çš„ hash ä¸Šé™ï¼Œè¶…éæ­¤ä¸Šé™æœƒæ¸…é™¤å…ˆå‰çš„æ­·å²ç´€éŒ„ã€‚</p><p>è‹¥ Source æ€§èƒ½æœ‰é¤˜è£•å¯ä»¥è€ƒæ…®æå‡æ­¤åƒæ•¸ï¼Œé€²ä¸€æ­¥æé«˜ Replica çš„ä¸¦è¡Œåº¦ã€‚</p></li><li><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_transaction_write_set_extraction target=_blank rel=noopener>transaction_write_set_extraction</a></p><p><img src=/p/mysql-mts/transaction-write-set-extraction.png width=573 height=324 srcset="/p/mysql-mts/transaction-write-set-extraction_hu_788d0ffa134a8fe0.png 480w, /p/mysql-mts/transaction-write-set-extraction_hu_ee47aa4a08fca84b.png 1024w" loading=lazy class=gallery-image data-flex-grow=176 data-flex-basis=424px></p><p>è¨­å®š WriteSet ä½¿ç”¨çš„ Hash æ¼”ç®—æ³•ã€‚</p><p>MySQL 5.7 é è¨­ç‚º OFFï¼ŒMySQL 8.0.26 å¾Œæ£„ç”¨ï¼Œä¸€èˆ¬ä¸ç”¨ç‰¹åˆ¥èª¿æ•´ã€‚</p></li></ul><h2 id=å®˜æ–¹æ¸¬è©¦æ•¸æ“š>å®˜æ–¹æ¸¬è©¦æ•¸æ“š</h2><p>ä»¥ä¸‹ç‚ºå®˜æ–¹ä½¿ç”¨SYSBENCHé€²è¡Œå£“æ¸¬çš„åœ–è¡¨ï¼Œå¯ä»¥è§€å¯Ÿåˆ°ï¼š</p><ul><li>åœ¨ Source ä½ä¸¦è¡Œç‡çš„æƒ…æ³ï¼ŒWRITESET çš„æ©Ÿåˆ¶ä¸‹ Replica ä»èˆŠèƒ½å¤ æœ‰è‰¯å¥½çš„ä¸¦è¡Œç‡ã€‚</li><li>ç•¶ Source ä¸¦è¡Œç‡è¶Šé«˜ï¼ŒCOMMIT_ORDER å’Œ WriteSet å·®è·æœƒç¸®å°ã€‚</li></ul><p><img src=/p/mysql-mts/official-1.png width=638 height=369 srcset="/p/mysql-mts/official-1_hu_3b00e87c44e3ed28.png 480w, /p/mysql-mts/official-1_hu_d342e907d68b98f.png 1024w" loading=lazy class=gallery-image data-flex-grow=172 data-flex-basis=414px></p><p><img src=/p/mysql-mts/official-2.png width=634 height=364 srcset="/p/mysql-mts/official-2_hu_197b19f1142a4d1.png 480w, /p/mysql-mts/official-2_hu_e3dc63fec2c378c2.png 1024w" loading=lazy class=gallery-image data-flex-grow=174 data-flex-basis=418px></p><p><img src=/p/mysql-mts/official-3.png width=630 height=339 srcset="/p/mysql-mts/official-3_hu_67c48b3d5247c90e.png 480w, /p/mysql-mts/official-3_hu_44f1e486e24843f1.png 1024w" loading=lazy class=gallery-image data-flex-grow=185 data-flex-basis=446px></p><h2 id=è¦ªè‡ªæ¸¬è©¦>è¦ªè‡ªæ¸¬è©¦</h2><p>ç’°å¢ƒï¼šMysql 8.0.12ï¼Œæ¸¬è©¦å‰stop slaveï¼Œå¾…sysbenchè·‘å®Œå¾Œåœ¨start slave</p><p>ç¢ºèªåœ¨performance_schemaä¸­ï¼ŒMTSç›¸é—œçš„çµ±è¨ˆENABLEDçš†æœ‰é–‹å•Ÿ(YES)</p><p><img src=/p/mysql-mts/setup-instruments.png width=618 height=113 srcset="/p/mysql-mts/setup-instruments_hu_46e9f6547d7d3976.png 480w, /p/mysql-mts/setup-instruments_hu_2e44d025aede9c80.png 1024w" loading=lazy class=gallery-image data-flex-grow=546 data-flex-basis=1312px></p><p>(*å•Ÿç”¨æˆ–ç¦ç”¨transaction eventçš„æ”¶é›†)</p><p><img src=/p/mysql-mts/setup-consumers.png width=604 height=141 srcset="/p/mysql-mts/setup-consumers_hu_9796bfda0a9b4b1.png 480w, /p/mysql-mts/setup-consumers_hu_b014b47d6902f199.png 1024w" loading=lazy class=gallery-image data-flex-grow=428 data-flex-basis=1028px></p><p>(åˆ†åˆ¥ç‚ºç•¶å‰çš„transaction eventï¼Œæ¯å€‹ç·šç¨‹æœ€è¿‘çš„transaction eventï¼Œglobal(è·¨ç·šç¨‹)æœ€è¿‘çš„transaction event)</p><p>æŸ¥è©¢MTSä¸¦è¡Œåº¦çš„èªæ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>select thread_id,count_star
</span></span><span class=line><span class=cl>from events_transactions_summary_by_thread_by_event_name
</span></span><span class=line><span class=cl>where thread_id in (
</span></span><span class=line><span class=cl>select thread_id
</span></span><span class=line><span class=cl>from replication_applier_status_by_worker
</span></span><span class=line><span class=cl>);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USE test;
</span></span><span class=line><span class=cl>CREATE VIEW rep_thread_count AS SELECT a.THREAD_ID AS THREAD_ID,a.COUNT_STAR AS COUNT_STAR
</span></span><span class=line><span class=cl>FROM performance_schema.events_transactions_summary_by_thread_by_event_name a
</span></span><span class=line><span class=cl>WHERE a.THREAD_ID in (SELECT b.THREAD_ID FROM performance_schema.replication_applier_status_by_worker b);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SELECT SUM(COUNT_STAR) FROM rep_thread_count INTO @total;
</span></span><span class=line><span class=cl>SELECT 100*(COUNT_STAR/@total) AS thread_usage FROM rep_thread_count;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#replication_applier_status_by_workerå¯ä»¥æŸ¥çœ‹replicationå„å€‹ç·šç¨‹çš„é‹ä½œç‹€æ³
</span></span><span class=line><span class=cl>#events_transactions_summary_by_thread_by_event_nameå½™ç¸½çš„æ¯å€‹ç·šç¨‹çš„äº‹ä»¶åç¨±ï¼ŒåŒ…å«å·²é—œé–‰ç·šç¨‹
</span></span><span class=line><span class=cl>#é€éreplication...tableæ‰¾å‡ºæ­£åœ¨é‹ä½œçš„ç·šç¨‹å†åˆ°event...tableæ‰¾åˆ°ä»–å€‘çš„count_star(åŸ·è¡Œçš„transactionæ•¸é‡)
</span></span></code></pre></td></tr></table></div></div><p>é¦–æ¬¡å£“æ¸¬ä»¥Threads 1 é€²è¡Œ10åˆ†é˜å£“æ¸¬</p><p><img src=/p/mysql-mts/sysbench-thread-1.png width=735 height=228 srcset="/p/mysql-mts/sysbench-thread-1_hu_bf23ccaac58c4d23.png 480w, /p/mysql-mts/sysbench-thread-1_hu_f1aa00859d09101b.png 1024w" loading=lazy class=gallery-image data-flex-grow=322 data-flex-basis=773px></p><p>åœ¨commit_orderä¸‹æ¸¬è©¦(å³MySQL 5.7ä½¿ç”¨)</p><p><img src=/p/mysql-mts/sysbench-commit-order-57-1.png width=552 height=113 srcset="/p/mysql-mts/sysbench-commit-order-57-1_hu_fed257d9318fbb9a.png 480w, /p/mysql-mts/sysbench-commit-order-57-1_hu_a778a8e65d8111cf.png 1024w" loading=lazy class=gallery-image data-flex-grow=488 data-flex-basis=1172px></p><p><img src=/p/mysql-mts/sysbench-thread-1-result.png width=224 height=135 srcset="/p/mysql-mts/sysbench-thread-1-result_hu_f96a92895ed00c07.png 480w, /p/mysql-mts/sysbench-thread-1-result_hu_d62c32fadcef5314.png 1024w" loading=lazy alt="commit_order ä¸¦è¡Œæ•ˆç‡" class=gallery-image data-flex-grow=165 data-flex-basis=398px></p><p>åœ¨WriteSetä¸‹æ¸¬è©¦(MySQL 8.0æ–°æ–¹æ¡ˆ)</p><p><img src=/p/mysql-mts/sysbench-writeSet-80-1.png width=557 height=114 srcset="/p/mysql-mts/sysbench-writeSet-80-1_hu_56bd1ec0d29b6c37.png 480w, /p/mysql-mts/sysbench-writeSet-80-1_hu_82258c7637565e83.png 1024w" loading=lazy class=gallery-image data-flex-grow=488 data-flex-basis=1172px></p><p><img src=/p/mysql-mts/sysbench-writeSet-thread1-result.png width=231 height=141 srcset="/p/mysql-mts/sysbench-writeSet-thread1-result_hu_301b577cfa94eab4.png 480w, /p/mysql-mts/sysbench-writeSet-thread1-result_hu_67050ade438aac2b.png 1024w" loading=lazy alt="writeSet ä¸¦è¡Œæ•ˆç‡" class=gallery-image data-flex-grow=163 data-flex-basis=393px></p><p>æ¥è‘—è©¦è©¦çœ‹Threads 128é€²è¡Œ10åˆ†é˜å£“æ¸¬</p><p><img src=/p/mysql-mts/sysbench-thread-128.png width=720 height=229 srcset="/p/mysql-mts/sysbench-thread-128_hu_f8f6eac7cf91aa4.png 480w, /p/mysql-mts/sysbench-thread-128_hu_dc7f8ce4a44b7b75.png 1024w" loading=lazy class=gallery-image data-flex-grow=314 data-flex-basis=754px></p><p>åœ¨commit_orderä¸‹æ¸¬è©¦(å³MySQL 5.7ä½¿ç”¨)</p><p><img src=/p/mysql-mts/sysbench-commit-order-57-1.png width=552 height=113 srcset="/p/mysql-mts/sysbench-commit-order-57-1_hu_fed257d9318fbb9a.png 480w, /p/mysql-mts/sysbench-commit-order-57-1_hu_a778a8e65d8111cf.png 1024w" loading=lazy class=gallery-image data-flex-grow=488 data-flex-basis=1172px></p><p><img src=/p/mysql-mts/sysbench-thread-128-commit-order-result.png width=211 height=114 srcset="/p/mysql-mts/sysbench-thread-128-commit-order-result_hu_e0649ddfe29e882f.png 480w, /p/mysql-mts/sysbench-thread-128-commit-order-result_hu_546283d58a856a6e.png 1024w" loading=lazy alt="commit_order ä¸¦è¡Œæ•ˆç‡" class=gallery-image data-flex-grow=185 data-flex-basis=444px></p><p>åœ¨WriteSetä¸‹æ¸¬è©¦(MySQL 8.0æ–°æ–¹æ¡ˆ)</p><p><img src=/p/mysql-mts/sysbench-writeSet-80-1.png width=557 height=114 srcset="/p/mysql-mts/sysbench-writeSet-80-1_hu_56bd1ec0d29b6c37.png 480w, /p/mysql-mts/sysbench-writeSet-80-1_hu_82258c7637565e83.png 1024w" loading=lazy class=gallery-image data-flex-grow=488 data-flex-basis=1172px></p><p><img src=/p/mysql-mts/sysbench-thread-128-writeSet-result.png width=221 height=142 srcset="/p/mysql-mts/sysbench-thread-128-writeSet-result_hu_34e16099ee1d33e6.png 480w, /p/mysql-mts/sysbench-thread-128-writeSet-result_hu_cd73732064be7b1b.png 1024w" loading=lazy alt="writeSet ä¸¦è¡Œæ•ˆç‡" class=gallery-image data-flex-grow=155 data-flex-basis=373px></p><p>æ¸¬è©¦çµæœåŸºæœ¬ä¸Šå’Œå®˜æ–¹æä¾›çš„å·®ä¸å¤šï¼Œä¸»è¦æ˜¯è§£æ±ºåœ¨Masterä½ä¸¦è¡Œåº¦çš„æƒ…æ³ä¸‹ï¼Œæé«˜MTSçš„æ•ˆç‡ã€‚</p><h2 id=log>LOG</h2><p>ç•¶é–‹å•Ÿ MTS ä¸” log_error_verbosity = 3 (NOTE) æ™‚ï¼Œæœƒåœ¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2023-01-30T03:08:36.440821Z 6 [Note] [MY-010559] [Repl] Multi-threaded slave statistics for channel &#39;&#39;: seconds elapsed = 277; events assigned = 20795393; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 0; waited at clock conflicts = 12923330700 waited (count) when Workers occupied = 0 waited when Workers occupied = 0
</span></span></code></pre></td></tr></table></div></div><h2 id=æ‡¶äººåŒ…>æ‡¶äººåŒ…</h2><h3 id=mysql-575721-åƒæ•¸è¨­å®š>MySQL 5.7~5.7.21 åƒæ•¸è¨­å®š</h3><ul><li><p>Source (Master)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># ä»¥ä¸‹éå¿…é ˆï¼Œä¾æ“šå¯¦éš›æƒ…æ³è©•ä¼°èª¿æ•´
</span></span><span class=line><span class=cl>binlog_group_commit_sync_delay = ?
</span></span><span class=line><span class=cl>binlog_group_commit_sync_no_delay_count = ?
</span></span></code></pre></td></tr></table></div></div></li><li><p>Replica (Slave)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># æ¨è–¦èª¿æ•´
</span></span><span class=line><span class=cl>slave_parallel_workers = ?
</span></span><span class=line><span class=cl>slave_parallel_type = LOGICAL_CLOCK
</span></span><span class=line><span class=cl>slave_preserve_commit_order = ON
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=mysql-572280xx-åƒæ•¸è¨­å®š>MySQL 5.7.22~8.0.XX åƒæ•¸è¨­å®š</h3><ul><li><p>Source (Master)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># æ¨è–¦èª¿æ•´
</span></span><span class=line><span class=cl>binlog_transaction_dependency_tracking = WRITESET_SESSION
</span></span><span class=line><span class=cl>transaction_write_set_extraction = XXHASH64
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># ä»¥ä¸‹ä¾æ“šå¯¦éš›æƒ…æ³è©•ä¼°èª¿æ•´
</span></span><span class=line><span class=cl># å„ªå…ˆèª¿æ•´
</span></span><span class=line><span class=cl>binlog_transaction_dependency_history_size = ?
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># èª¿æ•´å„ªå…ˆåº¦ä½ï¼Œå› ç‚ºé€€åŒ–å› commit order æ™‚æ‰æœ‰æ•ˆï¼Œæƒ…å¢ƒç‚ºï¼š
</span></span><span class=line><span class=cl># 1. æ²’æœ‰ pk æˆ– uk
</span></span><span class=line><span class=cl># 2. DDL èªå¥
</span></span><span class=line><span class=cl># 3. Transaction çš„æ›´æ–°åŒ…å« FK
</span></span><span class=line><span class=cl># 4. history å‰›è¢«æ¸…ç©º
</span></span><span class=line><span class=cl># 5. åŒä¸€å€‹ session çš„ Transaction (WRITESET_SESSION)
</span></span><span class=line><span class=cl>binlog_group_commit_sync_delay = ?
</span></span><span class=line><span class=cl>binlog_group_commit_sync_no_delay_count = ?
</span></span></code></pre></td></tr></table></div></div></li><li><p>Replica (Slave)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># æ¨è–¦èª¿æ•´
</span></span><span class=line><span class=cl>slave_parallel_workers = ?
</span></span><span class=line><span class=cl>slave_parallel_type = LOGICAL_CLOCK
</span></span><span class=line><span class=cl>slave_preserve_commit_order = ON
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=mts-æ•ˆç‡ç¢ºèª>MTS æ•ˆç‡ç¢ºèª</h3><p>èª¿æ•´å¾Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹èªæ³•æŸ¥çœ‹èª¿æ•´å¾Œ MTS ä¸¦è¡Œçš„æ•ˆç‡ï¼Œç†æƒ³çš„æƒ…æ³ä¸‹åŒä¸€å€‹ channel çš„æ¯å€‹ sql thread çš„ count_star æ‡‰è©²å·®ä¸å¤šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- mysql 5.7 éœ€å…ˆé–‹å•Ÿä»¥ä¸‹è¨­å®š
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>update</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>setup_consumers</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>enabled</span><span class=o>=</span><span class=w> </span><span class=s1>&#39;yes&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;events_transactions%&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>update</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>setup_instruments</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>enabled</span><span class=o>=</span><span class=w> </span><span class=s1>&#39;yes&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;transaction&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- mysql 5.7 éœ€å…ˆé–‹å•Ÿä»¥ä¸Šè¨­å®š
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>replication_status</span><span class=p>.</span><span class=n>CHANNEL_NAME</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>replication_status</span><span class=p>.</span><span class=n>thread_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>enent_summary</span><span class=p>.</span><span class=n>count_star</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>events_transactions_summary_by_thread_by_event_name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>enent_summary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>replication_applier_status_by_worker</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>replication_status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>USING</span><span class=p>(</span><span class=n>thread_id</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=bug>BUG</h2><ul><li><p><a class=link href="https://bugs.mysql.com/bug.php?id=103636" target=_blank rel=noopener>MySQL Bugs: #103636: Slave hangs with slave_preserve_commit_order On</a></p><p>èªªæ˜ï¼šç•¶ replica è¨­ç½®äº† replica_preserve_commit_order = 1 åœ¨é«˜è² è¼‰ä¸‹é•·æ™‚é–“ä½¿ç”¨æ™‚ï¼Œå¯èƒ½æœƒç”¨å®Œ commit order sequence tickets å°è‡´ applier æ›èµ· (hang) ä¸¦ä¸”ç„¡æœŸé™çš„æŒçºŒç­‰å¾… commit order queueã€‚</p><p>å½±éŸ¿ç‰ˆæœ¬ï¼šMySQL 8.0.28 ä¹‹å‰</p><p>ä¿®å¾©ç‰ˆæœ¬ï¼š MySQL 8.0.28</p><p>github è³‡è¨Šï¼š<a class=link href=https://github.com/mysql/mysql-server/commit/f6bb5e7cc5e57f44c881a3f63ee507102c3e398d target=_blank rel=noopener>BUG#32891221 REPLICA HANGS WITH REPLICA_PRESERVE_COMMIT_ORDER ON Â· mysql/mysql-server@f6bb5e7 Â· GitHub</a></p></li></ul><h1 id=åƒè€ƒ>åƒè€ƒ</h1><p><a class=link href=http://mysql.taobao.org/monthly/2018/06/04/ target=_blank rel=noopener>MySQL Â· ç‰¹æ€§åˆ†æ Â· 8.0 WriteSet å¹¶è¡Œå¤åˆ¶</a></p><p><a class=link href=https://www.cnblogs.com/VicLiu/p/14653400.html target=_blank rel=noopener>é€Ÿåº¦æå‡5~10å€ï¼ŒåŸºäºWRITESETçš„MySQLå¹¶è¡Œå¤åˆ¶ #M1013# - VicLW - åšå®¢å›­ (cnblogs.com)</a></p><p><a class=link href=https://blog.csdn.net/joy0921/article/details/80130768 target=_blank rel=noopener>MySQL 5.7å¹¶è¡Œå¤åˆ¶ä¸­å¹¶è¡Œçš„çœŸæ­£å«ä¹‰_ä»²åŸ¹è‰ºçš„åšå®¢-CSDNåšå®¢</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2017/12/03/ target=_blank rel=noopener>MySQL Â· ç‰¹æ€§åˆ†æ Â· LOGICAL_CLOCK å¹¶è¡Œå¤åˆ¶åŸç†åŠå®ç°åˆ†æ (taobao.org)</a></p><p><a class=link href="https://dev.mysql.com/worklog/task/?id=6314" target=_blank rel=noopener>MySQL :: WL#6314: MTS: Prepared transactions slave parallel applier</a></p><p><a class=link href="https://dev.mysql.com/worklog/task/?id=7165" target=_blank rel=noopener>MySQL :: WL#7165: MTS: Optimizing MTS scheduling by increasing the parallelization window on master</a></p><p><a class=link href=https://juejin.cn/post/6949470247673921567 target=_blank rel=noopener>MySQL-ç»„æäº¤ä¸å¹¶è¡Œå¤åˆ¶ - æ˜é‡‘ (juejin.cn)</a></p><p><a class=link href="https://dev.mysql.com/worklog/task/?id=9556" target=_blank rel=noopener>MySQL :: WL#9556: Writeset-based MTS dependency tracking on master</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2017/08/01/ target=_blank rel=noopener>MySQL Â· å¼•æ“ç‰¹æ€§ Â· Group Replicationå†…æ ¸è§£æ (taobao.org)</a></p><p><a class=link href=https://opensource.actionsky.com/20190902-mysql/ target=_blank rel=noopener>ç¤¾åŒºæŠ•ç¨¿ | åŸºäº WRITESET çš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ (actionsky.com)</a></p><p><a class=link href=https://dev.mysql.com/blog-archive/improving-the-parallel-applier-with-writeset-based-dependency-tracking/ target=_blank rel=noopener>MySQL :: Improving the Parallel Applier with Writeset-based Dependency Tracking</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/61336729 target=_blank rel=noopener>MySQL Group Replicationå†²çªæ£€æµ‹æœºåˆ¶å†å‰–æ - çŸ¥ä¹ (zhihu.com)</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/71913226 target=_blank rel=noopener>æ·±å…¥æµ…æä¸€è‡´æ€§æ¨¡å‹ä¹‹Causal Consistency - çŸ¥ä¹ (zhihu.com)</a></p><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/replication-features-transaction-inconsistencies.html target=_blank rel=noopener>MySQL :: MySQL 8.0 Reference Manual :: 17.5.1.34 Replication and Transaction Inconsistencies</a></p><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/start-replica.html target=_blank rel=noopener>MySQL :: MySQL 8.0 Reference Manual :: 13.4.2.8 START REPLICA Statement</a></p><p><a class=link href=https://dev.mysql.com/doc/refman/8.0/en/show-replica-status.html target=_blank rel=noopener>MySQL :: MySQL 8.0 Reference Manual :: 13.7.7.35 SHOW REPLICA STATUS Statement</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/replication/>Replication</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸é—œæ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mysql-gtid/><div class=article-details><h2 class=article-title>GTID</h2></div></a></article><article><a href=/p/mysql-replication-delay-observation-improve/><div class=article-details><h2 class=article-title>MySQL8.0 å°æ–¼ replication delay è§€æ¸¬æ”¹é€²</h2></div></a></article><article><a href=/p/mysql-implicit-lock/><div class=article-details><h2 class=article-title>éš±å¼é–</h2></div></a></article><article><a href=/p/mysql-group-commit/><div class=article-details><h2 class=article-title>Group Commit</h2></div></a></article><article><a href=/p/mysql-fulltext-index/><div class=article-details><h2 class=article-title>MySQL FullText Index(å…¨æ–‡æª¢ç´¢)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//å°å° DBA å€‹äººç­†è¨˜.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>