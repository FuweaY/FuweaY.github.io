<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ç´€éŒ„å­¸ç¿’çš„ PostgreSQL Replication"><title>PostgreSQL Replication</title>
<link rel=canonical href=https://FuweaY.github.io/p/postgre-replication/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="PostgreSQL Replication"><meta property='og:description' content="ç´€éŒ„å­¸ç¿’çš„ PostgreSQL Replication"><meta property='og:url' content='https://FuweaY.github.io/p/postgre-replication/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2020-02-19T12:00:00+08:00'><meta property='article:modified_time' content='2020-02-19T12:00:00+08:00'><meta name=twitter:title content="PostgreSQL Replication"><meta name=twitter:description content="ç´€éŒ„å­¸ç¿’çš„ PostgreSQL Replication"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ±</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>ç†±æ„›åˆ†äº«çš„ DBA å°å¤©åœ°</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#standby-slave-çš„è¡Œç‚º>Standby (Slave) çš„è¡Œç‚º</a></li><li><a href=#å»ºè­°>å»ºè­°</a></li><li><a href=#è¨­ç½®-standby>è¨­ç½® Standby</a><ol><li><a href=#log-shipping-warm-standby>Log Shipping (warm standby)</a><ol><li><a href=#é…ç½®æ–¹å¼>é…ç½®æ–¹å¼</a></li></ol></li><li><a href=#ç›¸é—œåƒæ•¸>ç›¸é—œåƒæ•¸</a><ol><li><a href=#archiving>Archiving</a></li><li><a href=#archive-recovery>Archive Recovery</a></li></ol></li><li><a href=#å°ç¯€>å°ç¯€</a></li></ol></li><li><a href=#streaming-replication-æµè¤‡è£½-æˆ–ç¨±-ç‰©ç†è¤‡è£½>Streaming Replication (æµè¤‡è£½ æˆ–ç¨± ç‰©ç†è¤‡è£½)</a><ol><li><a href=#åŒæ­¥-or-ç•°æ­¥>åŒæ­¥ OR ç•°æ­¥</a></li><li><a href=#å»ºç½®ç¯„ä¾‹>å»ºç½®ç¯„ä¾‹</a></li><li><a href=#å°ç¯€-1>å°ç¯€</a></li></ol></li><li><a href=#replication-slot>Replication Slot</a><ol><li><a href=#åŠŸç”¨---slave-æ‰€éœ€çš„-wal-åœ¨-master-ä¸Šçš„ä¿ç•™>åŠŸç”¨ - Slave æ‰€éœ€çš„ WAL åœ¨ Master ä¸Šçš„ä¿ç•™</a></li><li><a href=#åŠŸç”¨---æ”¹å–„-master-çš„-vacuum-éæ—©æ¸…é™¤-slave-æ‰€éœ€çš„ç´€éŒ„>åŠŸç”¨ - æ”¹å–„ Master çš„ vacuum éæ—©æ¸…é™¤ Slave æ‰€éœ€çš„ç´€éŒ„</a></li><li><a href=#ä½¿ç”¨-physical-replication-slot>ä½¿ç”¨ Physical Replication slot</a></li><li><a href=#å°ç¯€-2>å°ç¯€</a></li></ol></li><li><a href=#logical-replication-é‚è¼¯è¤‡è£½>Logical Replication (é‚è¼¯è¤‡è£½)</a><ol><li><a href=#pg-1514-é™åˆ¶>PG 15(14) é™åˆ¶</a></li><li><a href=#å»ºç½®ç¯„ä¾‹-1>å»ºç½®ç¯„ä¾‹</a></li></ol></li><li><a href=#åƒè€ƒ>åƒè€ƒ</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/postgresql/>PostgreSQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/postgre-replication/>PostgreSQL Replication</a></h2><h3 class=article-subtitle>ç´€éŒ„å­¸ç¿’çš„ PostgreSQL Replication</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 19, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 10 åˆ†é˜</time></div></footer></div></header><section class=article-content><p>Replication æ˜¯æä¾›é«˜å¯ç”¨åŠ load balance çš„åŸºç¤ï¼Œå› æ­¤ä¸è«–åœ¨å“ªä¸€ç¨® database éƒ½æ˜¯ä¸€é …é‡è¦çš„åŠŸèƒ½ã€‚</p><p>åœ¨ä¸åŒçš„ Database ä¸‹å°æ–¼ä¸»å‚™ Server éƒ½æœ‰ä¸åŒçš„è¡“èªï¼š</p><div class=table-wrapper><table><thead><tr><th></th><th>MySQL &lt; 8.0.26</th><th>MySQL > 8.0.26</th><th>MongoDB</th><th>PostgreSQL</th></tr></thead><tbody><tr><td>ä¸»</td><td>Master</td><td>Source</td><td>Primary</td><td>Primary</td></tr><tr><td>å‚™</td><td>Slave</td><td>Replica</td><td>Secondary</td><td>Standby</td></tr></tbody></table></div><p>åœ¨ MySQL ä¸­é€é Server å±¤çš„ binlog é€é</p><p>åœ¨ PG ä¸­å‰‡æ˜¯ç›´æ¥é€é WAL (ç›¸å°æ–¼ InnoDB redo log)</p><h2 id=standby-slave-çš„è¡Œç‚º>Standby (Slave) çš„è¡Œç‚º</h2><p>ç•¶ server å•Ÿå‹•æ™‚æ•¸æ“šç›®éŒ„ä¸­åŒ…å« <code>standby.signal</code> æ–‡ä»¶æ™‚ï¼Œå‰‡ server æœƒé€²å…¥ standby æ¨¡å¼ã€‚</p><p>åœ¨ standby æ¨¡å¼ä¸‹ï¼Œstandby å¯ä»¥é€éä»¥ä¸‹å…©ç¨®æ–¹å¼ä¾†ç²å–ä¸¦å›æ”¾ Primary ä¸Šçš„ WALï¼š</p><ul><li>WAL Archive</li><li>Streaming Replication</li></ul><p>é™¤æ­¤ä¹‹å¤– Standby é‚„æœƒå˜—è©¦æ¢å¾©åœ¨ pg_wal ç›®éŒ„ä¸­çš„ä»»ä½• WALã€‚</p><p>Standby åœ¨å•Ÿå‹•æ™‚æœƒæœ‰ä»¥ä¸‹è¡Œç‚ºï¼š</p><ol><li>èª¿ç”¨ <code>restore_command</code> é€²è¡Œæ¢å¾©ã€‚</li><li>ç•¶æ­¥é©Ÿ1 é”åˆ° WAL æœ«å°¾ä¸”æ¢å¾©å¤±æ•—ï¼Œå‰‡å°‡å˜—è©¦æ¢å¾© pg_wal ç›®éŒ„ä¸­å¯ç”¨çš„ WALã€‚</li><li>ç•¶æ­¥é©Ÿ2å¤±æ•—ï¼Œä¸”é…ç½®äº† Streaming Replication ï¼Œå‰‡æœƒå˜—è©¦é€£æ¥åˆ° Primary ä¸¦å¾å­˜æª”æˆ– pg_wal ç›®éŒ„ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ç´€éŒ„é–‹å§‹ Streaming WALã€‚</li><li>ç•¶æ­¥é©Ÿ3å¤±æ•—ï¼Œæˆ–æ˜¯æ²’æœ‰é…ç½® Streaming Replication å‰‡å°‡å›åˆ°æ­¥é©Ÿ1é‡æ–°å˜—è©¦</li></ol><p>ä»¥ä¸Šæ­¥é©Ÿçš„ retry å¾ªç’°æˆ–ä¸€ç›´æŒçºŒåˆ° server é—œé–‰æˆ–è€… failoverã€‚</p><p>failover å¯ä»¥é€éé‹è¡Œ <code>pg_ctl promote</code>ã€èª¿ç”¨ <code>pg_promote()</code> æˆ–ç™¼ç¾ trigger file (promote_trigger_file) æ™‚ï¼Œå‰‡æœƒé€€é€€å‡º standby æ¨¡å¼æˆç‚º primary æä¾›æ­£å¸¸æ“ä½œã€‚</p><h2 id=å»ºè­°>å»ºè­°</h2><ul><li>åœ¨ä¸åŒçš„ä¸»è¦ç‰ˆæœ¬è™Ÿä¸­é€šå¸¸æ˜¯ç„¡æ³•é€²è¡Œ log shipping çš„</li><li>é›–ç„¶ PG æ²’æœ‰æ­£å¼æ”¯æŒä¸åŒæ¬¡è¦ç‰ˆæœ¬ä¹‹é–“çš„ log shippingï¼Œä½†åœ¨æ¬¡è¦ç‰ˆæœ¬ä¸­ä¸€èˆ¬ä¸æ›´æ”¹ Disk æ ¼å¼ï¼Œä¸¦ä¸”æ–°çš„æ¬¡è¦ç‰ˆæœ¬æ›´å¯èƒ½å¾èˆŠçš„æ¬¡è¦ç‰ˆæœ¬è®€å– WALï¼Œå› æ­¤å‡ç´šå°ç‰ˆæœ¬è™Ÿæ™‚å»ºè­°å…ˆå‡ç´š standbyã€‚</li><li></li><li>åœ¨ Primary ä¸Šè¨­ç½® Continuous archiving æ™‚ï¼Œæ‡‰è©²è€ƒæ…®å°‡æ­¸æª”ä½ç½®è¨­ç‚º standby æœ¬èº«æˆ–æ˜¯é Primary æ©Ÿå™¨ä¸Šï¼Œé¿å…å› ç‚º Primary æ©Ÿå™¨æœ¬èº«å‡ºå•é¡Œè€Œç„¡æ³•è¨ªå•ã€‚</li><li>ä½¿ç”¨ Streaming Replicaiton éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é …ï¼š<ul><li>å‰µå»º replication roleï¼Œä¸¦åœ¨ ph_hba.conf æœ‰æ­£ç¢ºçš„è¨­ç½®ï¼Œç¢ºä¿ standby èƒ½å¤ é€£ç·š Primaryã€‚</li><li>ç¢ºä¿ Primary ä¸Šçš„ <code>max_wal_senders</code> è¨­ç½®è¶³å¤ å¤§ã€‚</li><li>å¦‚æœä½¿ç”¨ Replication Slot é‚„éœ€è¦ç¢ºä¿ <code>max_replication_slots</code> è¨­ç½®ã€‚</li></ul></li></ul><h2 id=è¨­ç½®-standby>è¨­ç½® Standby</h2><h3 id=log-shipping-warm-standby>Log Shipping (warm standby)</h3><p>åœ¨ PG 9.0 ä¹‹å‰ï¼ŒPostgreSQL åªæä¾›é€™ç¨®ç•°æ­¥ replication æ–¹å¼ï¼Œé€™æ˜¯é€é Primary æ¯æ¬¡å‚³é€ä¸€å€‹ WAL çµ¦ Standby ä¾†å¯¦ç¾ï¼Œç¼ºé™·ä¹Ÿå¾ˆæ˜é¡¯å°±æ˜¯ Standby è‡³å°‘æœƒè½å¾Œ Primary ä¸€å€‹ WALã€‚</p><h4 id=é…ç½®æ–¹å¼>é…ç½®æ–¹å¼</h4><ol><li><p>åœ¨ Primary ä¸­æ–°å¢ä»¥ä¸‹è¨­ç½®</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>archive_mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>archive_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;test ! -f /var/data/xlog_archive/%f &amp;&amp; cp %p /var/data/xlog_archive/%f&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>å° Primary é€²è¡Œ Base backup</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>é‚„åŸåˆ° Standby</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>cp</span><span class=w> </span><span class=o>-</span><span class=n>R</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>pg_back_2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>17</span><span class=n>_07</span><span class=err>\</span><span class=p>:</span><span class=mi>06</span><span class=err>\</span><span class=p>:</span><span class=mi>57</span><span class=cm>/* /var/data/postgres
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>ä¿®æ”¹ Standby è¨­ç½®ï¼Œä¸¦ä»¥ standby æ¨¡å¼é‹è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>restore_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cp /var/data/xlog_archive/%f &#34;%p&#34;&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>touch</span><span class=w> </span><span class=n>standby</span><span class=p>.</span><span class=n>signal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pg_ctl</span><span class=w> </span><span class=o>-</span><span class=n>D</span><span class=w> </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=k>data</span><span class=o>/</span><span class=n>postgres</span><span class=w> </span><span class=o>-</span><span class=n>l</span><span class=w> </span><span class=n>logfile</span><span class=w> </span><span class=k>start</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>é€éåœ¨ Primary æ–°å¢è³‡æ–™ï¼Œä¸¦ä½¿ç”¨ <code>pg_switch_wal()</code> å¼·åˆ¶è§¸ç™¼ WAL çš„åˆ‡æ›ä¾†è§€å¯Ÿ</p><ul><li><p>primary</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- primary
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>07</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=k>c</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>You</span><span class=w> </span><span class=k>are</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=n>connected</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s2>&#34;test&#34;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=s2>&#34;postgres&#34;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>08</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>607</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>13</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;test2&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>594</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>24</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>330</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>25</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>pg_switch_wal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>pg_switch_wal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>30003</span><span class=n>D8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>171</span><span class=p>.</span><span class=mi>419</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>standby</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>41</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=k>c</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>You</span><span class=w> </span><span class=k>are</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=n>connected</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s2>&#34;test&#34;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=s2>&#34;postgres&#34;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>44</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>relations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>Schema</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Type</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=k>Owner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+------+-------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>52</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>660</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>425</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- åœ¨ primeary è§¸ç™¼ WAL åˆ·æ–°å¾Œ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>27</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>334</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li></ol><h3 id=ç›¸é—œåƒæ•¸>ç›¸é—œåƒæ•¸</h3><h4 id=archiving>Archiving</h4><ul><li><p>archive_mode (enum)ï¼šè¨­ç½®æ˜¯å¦é€²è¡Œ archiveï¼Œæœ‰ä»¥ä¸‹ä¸‰ç¨®è¨­ç½®ï¼š</p><ul><li><p>offï¼šé—œé–‰ archiveã€‚</p></li><li><p>onï¼šæ­£å¸¸æ¨¡å¼ä¸‹é–‹å•Ÿ archiveï¼Œä½†æ˜¯åœ¨ recovery æˆ–æ˜¯ standby æ™‚ä¸é€²è¡Œ archvieã€‚\</p><p>ç•¶ standbyæå‡ç‚º primary æ™‚åªæœƒ archive è‡ªå·±ç”¢ç”Ÿçš„ WALï¼Œè€Œä¸æœƒ archive åŸæœ¬å¾å¦ä¸€å€‹ primary å–å¾—çš„ WALã€‚</p></li><li><p>alwaysï¼šä¸è«–ä»€éº¼æ¨¡å¼éƒ½é€²è¡Œ archiveã€‚</p></li></ul></li><li><p>archive_command (string)ï¼šè¨­ç½® archive WAL çš„ shell æŒ‡ä»¤ã€‚</p></li><li><p>archive_library (string)ï¼šè¨­ç½®ç”¨æ–¼ archive WAL çš„ libraryï¼Œè‹¥ç‚ºç©ºè¡¨ç¤ºä½¿ç”¨ <code>archive_command</code>ã€‚</p></li><li><p>archive_timeout (integer)ï¼šæ­¤åƒæ•¸ç‚ºæ™‚é–“è¨­ç½®é è¨­å–®ä½ç‚ºç§’ï¼Œç•¶æ­¤åƒæ•¸å¤§æ–¼ 0 æ™‚ï¼Œæœƒå¼·åˆ¶ server åªè¦è·é›¢ä¸Šæ¬¡åˆ‡æ›åˆ°æ–°çš„ WAL å·²ç¶“éå»é€™æ®µæ™‚é–“ï¼Œä¸”æœ‰æ•¸æ“šåº«æ´»å‹•å°±å¿…é ˆåˆ‡æ›åˆ°æ–°çš„ WALã€‚</p><p>å› ç‚º archive åªæœƒé‡å°å®Œæˆçš„ WAL ä½œç”¨ï¼Œå› æ­¤è¨­ç½®æ­¤åƒæ•¸å¯ä»¥é¿å…ç•¶ WAL è¼ªæ›ä¸é »ç¹æ™‚ï¼Œå°è‡´ Transaction éä¹…æ²’æœ‰è¢«å®‰å…¨çš„æ­¸æª”æˆ–è€…åŒæ­¥åˆ° standbyã€‚</p><p>æ³¨æ„ï¼šå¼·åˆ¶åˆ‡æ› WAL çš„æ–‡ä»¶å¤§å°å’Œå®Œæ•´çš„æ–‡ä»¶å¤§å°ç›¸åŒéƒ½æ˜¯ 16MBï¼Œå› æ­¤è¨­ç½®å¤ªçŸ­çš„ <code>archive_timeout</code> æœƒå°è‡´æ­¸æª”å­˜æª”è†¨è„¹ï¼Œé€šå¸¸ 1 åˆ†é˜å·¦å³çš„è¨­ç½®æ˜¯åˆç†ã€‚å¦‚æœå¸Œæœ› Primary å’Œ Standby ä¹‹é–“çš„å»¶é²æ›´å°æ‡‰è©²è€ƒæ…® streaming replication è€Œä¸æ˜¯èª¿æ•´æ­¤å€¼ã€‚</p></li></ul><h4 id=archive-recovery>Archive Recovery</h4><p>æ­¤è™•ç”¨æ–¼è¨­ç½® recovery æœŸé–“çš„è¨­å®šï¼Œrecovery åŒ…å«ä»¥ä¸‹å…©è€…ï¼š</p><ul><li>recovery modeï¼šé€éåœ¨æ•¸æ“šç›®éŒ„ä¸­å‰µå»º <code>recovery.signal</code> è¨­ç½®</li><li>standby modeï¼šé€éåœ¨æ•¸æ“šç›®éŒ„ä¸­å‰µå»º <code>standby.signal</code> è¨­ç½®ï¼Œé¦–å…ˆé€²å…¥ recovery mode ä¸¦åœ¨æ¢å¾©åˆ°æ­¸æª”çš„ WAL æœ«å°¾æ™‚ä¸æœƒåœæ­¢ï¼Œè€Œæ˜¯æœƒå˜—è©¦é€é <code>primary_conninfo</code> å‘æŒ‡å®šçš„ primary è«‹æ±‚ WAL æˆ– <code>restore_command</code> ä¾†ç¹¼çºŒå›æ”¾ WALã€‚</li></ul><p>å‚™æ³¨ï¼šå¦‚æœ 2 å€‹ signal éƒ½è¢«å»ºç«‹å‰‡æœƒä»¥ standby mode å„ªå…ˆã€‚</p><ul><li><p>restore_command (string)ï¼šç”¨æ–¼è¨­ç½®å¦‚ä½•å°‡æ­¸æª”çš„ WAL ç”¨æ–¼ restore çš„ shell å‘½ä»¤ã€‚</p><p>ç¯„ä¾‹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>restore_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cp /mnt/server/archivedir/%f &#34;%p&#34;&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°è¨­å®šè¡¨ç¤ºå°‡è¤‡è£½ <code>/mnt/server/archivdir</code> åº•ä¸‹çš„ WAL åˆ° pg_wal ä¸­ã€‚</p><ul><li>%fï¼šè¡¨ç¤ºæ­¸æª” WAL æ–‡ä»¶åç¨±ã€‚</li><li>%pï¼šè¡¨ç¤ºæ”¾ç½®ç”¨æ–¼æ¢å¾© WAL çš„ç›®éŒ„ (pg_wal)ã€‚</li></ul></li><li><p>archive_cleanup_cpmmand (string)ï¼šç”¨æ–¼è¨­ç½®æ¸…ç† standby ä¸å†éœ€è¦çš„æ­¸æª” WAL shell å‘½ä»¤ã€‚</p><p>ç¯„ä¾‹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>archive_cleanup_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pg_archivecleanup /mnt/server/archivedir %r&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°è¨­å®šè¡¨ç¤ºé‹è¡Œ <code>pg_archivecleanup</code> å°‡ä¸Šä¸€å€‹ WAL æ–‡ä»¶åˆªé™¤ã€‚</p><ul><li>%rï¼šè¡¨ç¤ºéœ€è¦çš„ WAL æ–‡ä»¶çš„ä¸Šä¸€å€‹ WAL æ–‡ä»¶åç¨±ã€‚</li></ul></li><li><p>recovery_end_command (string)ï¼šç”¨æ–¼è¨­ç½®ç•¶ recovery çµæŸæ™‚åŸ·è¡Œçš„ shell å‘½ä»¤ï¼Œä¾‹å¦‚å¯ä»¥ç”¨æ–¼ç™¼é€ email é€šçŸ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>recovery_end_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;echo &#34;Recovery complete&#34; | mail -s &#34;Recovery complete&#34; admin@example.com&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=å°ç¯€>å°ç¯€</h3><p>Log Shipping æ˜¯ä¸€ç¨®ç•°æ­¥ä¸”å³æ™‚æ€§ä¸é«˜çš„ replication æ–¹å¼ï¼Œä½†æ˜¯ä»–ç›¸æ‡‰çš„å„ªå‹¢å°±æ˜¯å› ç‚ºæ˜¯é€é primary æ­¸æª”å¾Œçš„ WAL é€²è¡Œæ¢å¾©ï¼Œå› æ­¤ä¸æœƒæœ‰ Streaming Replicaion ä¸Ÿå¤± WAL å°è‡´ç„¡æ³•å¾©åŸçš„å•é¡Œã€‚</p><p>é›–ç„¶ä¸æ¨è–¦å°‡ Log Shipping åšç‚ºä¸»åŠ›çš„ replication æ–¹æ¡ˆï¼Œä½†æ˜¯å¯ä»¥å°‡å…¶åŒæ™‚å’Œ Streaming Replication ä¸€èµ·é‹è¡Œä½œç‚ºé™„å±¬æ–¹æ¡ˆï¼Œåªæœ‰ç•¶ Streaming Replication å› ç‚ºæŸäº›åŸå› è·Ÿä¸ä¸Š Primary å°è‡´å°æ‡‰çš„ WAL è¢«åˆªé™¤æ™‚ï¼Œé€éæ­¸æª”çš„ WAL ä¾†é€²è¡Œå¾©åŸã€‚</p><h2 id=streaming-replication-æµè¤‡è£½-æˆ–ç¨±-ç‰©ç†è¤‡è£½>Streaming Replication (æµè¤‡è£½ æˆ–ç¨± ç‰©ç†è¤‡è£½)</h2><p>åœ¨ PG 9.0 é–‹å§‹æä¾›äº† Steaming Replicationï¼Œé›–ç„¶å’Œ Log Shipping ä¸€æ¨£éƒ½æ˜¯é€é WAL æ—¥èªŒçš„å›æ”¾ä¾†é”åˆ° Primary å’Œ Standby çš„åŒæ­¥ï¼Œä½†æ˜¯ Streaming Replication åªè¦åœ¨ WAL ä¸­ä¸€ç”¢ç”Ÿè®ŠåŒ–å°±æœƒç™¼é€çµ¦ Standbyï¼Œè€Œä¸éœ€è¦ç­‰åˆ° WAL åˆ‡æ›æ‰å‚³é€ï¼Œä¹Ÿå°±æ˜¯èªª Streaming Replication æœƒæœ‰æ›´çŸ­çš„ replication delayã€‚</p><p>å…·é«”å¯¦ç¾æ–¹é¢å¤§é«”ä¸Šå…¶å¯¦å’Œ MySQL å·®ä¸å¤šï¼Œåªæ˜¯ MySQL æ˜¯é€é binlog ä¸­çš„é‚è¼¯è¤‡è£½ï¼Œä½† PG çš„ WAL æ¯”è¼ƒæ¥è¿‘ MySQL redo log ä¹Ÿå°±æ˜¯èªªæ˜¯æ ¹æ“šå¯¦éš›ä¿®æ”¹ Disk ç‰©ç†ç©ºé–“çš„ç´€éŒ„ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ PG ä¸­ Master å’Œ Slave çš„åº•å±¤æ•¸æ“šç‹€æ…‹æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p><p>åœ¨ Streaming Replication æœ‰ä»¥ä¸‹è§’è‰²ï¼š</p><ul><li>Master ä¸Šçš„ backend é€²ç¨‹ï¼šåŸ·è¡Œæ”¶åˆ°çš„ Query æŒ‡ä»¤ï¼Œåœ¨ä¿®æ”¹æ•¸æ“šå‰å…ˆå¯«å…¥ WALï¼Œä¸¦åœ¨ commit çš„æ™‚å€™å°‡ WAL fsync åˆ° Diskã€‚</li><li>Master ä¸Šçš„ WAL sender é€²ç¨‹ï¼šå°‡ WAL ç™¼é€çµ¦ Slave çš„ WAL receiver ã€‚</li><li>Slave ä¸Šçš„ WAL receiver é€²ç¨‹ï¼šæ¥æ”¶ä¸¦æŒä¹…åŒ–å„²å­˜ Master WAL sender ç™¼é€çš„ WALã€‚å¯ä»¥é¡æ¯”ç‚º MySQL çš„ IO THREADã€‚</li><li>Slave ä¸Šçš„ startup é€²ç¨‹ï¼šApply WAL receiver æ¥æ”¶åˆ°çš„ WALã€‚å¯ä»¥é¡æ¯”ç‚º MySQL çš„ SQL THREADã€‚</li></ul><h3 id=åŒæ­¥-or-ç•°æ­¥>åŒæ­¥ OR ç•°æ­¥</h3><p>æ­¤å¤–å’Œ MySQL ä¸€æ¨£ä¹Ÿåˆ†ç‚ºç•°æ­¥æˆ–åŒæ­¥ï¼Œä¸»è¦é€éä»¥ä¸‹åƒæ•¸æ§åˆ¶ï¼š</p><ul><li><p>synchronous_commit (enum)ï¼šæŒ‡å®š server åœ¨å®Œæˆå¤šå°‘ WAL è™•ç†å¾Œæ‰è¿”å› Clinet ç«¯æˆåŠŸã€‚</p><p>ç•¶ <code>synchronous_standby_names</code> ç‚ºç©ºæ™‚ï¼Œåˆ†ç‚ºå…©ç¨®è¨­ç½®ï¼š</p><ul><li>onï¼šæ­¤ç‚ºé»˜èªå€¼ä¸” OFF ä»¥å¤–çš„è¨­ç½®éƒ½è¦–ç‚º ONï¼Œç•¶ WAL fsync åˆ° Disk æ‰è¿”å›æˆåŠŸçµ¦ Client ç«¯ã€‚</li><li>offï¼šä¸æœƒç­‰å¾… WAL çš„è™•ç†ï¼Œä¹Ÿå°±æ˜¯èªªå¯èƒ½æœƒä¸Ÿå¤± Transactionï¼Œæœ€å¤šå¯èƒ½æœƒå°è‡´ä¸Ÿå¤± <code>wal_write_delay</code> * 3ã€‚</li></ul><p>ç•¶ <code>synchronous_standby_names</code> ä¸ç‚ºç©ºæ™‚ï¼Œåˆ†ç‚º5ç¨®è¨­ç½®ï¼š</p><p>ç¸½å…±æœ‰ä»¥ä¸‹ 5 å€‹å€¼ï¼š</p><ul><li>remote_applyï¼šä¿è­‰ Slave å·²ç¶“æ”¶åˆ°è©² Transaction çš„ WAL ä¸¦èª¿ç”¨ fsync() diskï¼Œç¢ºä¿äº†è©² Transaction åªæœ‰ Masterã€Slave éƒ½ç™¼ç”Ÿæ•¸æ“šæå£æ‰æœƒä¸Ÿå¤± Transactionï¼Œä¸¦ä¸”é‚„å®Œæˆäº† WAL å›æ”¾ï¼Œå› æ­¤åœ¨ Masterã€Slave ä¸Šæ“æœ‰ä¸€è‡´æ€§è®€å–ã€‚</li><li>onï¼šä¹Ÿå¯ç¨±ç‚º remote_flushï¼Œä¿è­‰ Slave å·²ç¶“æ”¶åˆ°è©² Transaction çš„ WAL ä¸¦èª¿ç”¨ fsync() diskï¼Œç¢ºä¿äº†è©² Transaction åªæœ‰ Masterã€Slave éƒ½ç™¼ç”Ÿæ•¸æ“šæå£æ‰æœƒä¸Ÿå¤± Transactionï¼Œä½†å› ç‚ºé‚„æ²’æœ‰å›æ”¾ WALï¼Œå› æ­¤ Masterã€Slave æ²’æœ‰ä¸€è‡´æ€§è®€å–ã€‚</li><li>remote_writeï¼šä¿è­‰ Slave å·²ç¶“æ”¶åˆ°è©² Transaction çš„ WAL ä¸¦å¯«å…¥ OS ç·©å­˜ï¼Œä½†æœªèª¿ç”¨ fsync() diskï¼Œä¹Ÿå°±æ˜¯èªª PG server crash ä¸¦ä¸æœƒå°è‡´ Transaction ä¸Ÿå¤±ï¼Œä½†æ˜¯æ•´å€‹ OS ç³»çµ± Crash å°‡å¯èƒ½å°è‡´ Transaction ä¸Ÿå¤±ã€‚</li><li>localï¼šç­‰åŒæ–¼ <code>synchronous_standby_names</code> ç‚ºç©ºæ™‚çš„ ON è¨­ç½®ï¼Œä¹Ÿå°±æ˜¯èªªåªè¦ Master çš„ WAL æœ‰ fsync å³å¯ä¸å¿…ç­‰å¾… slaveï¼Œä¹Ÿå°±æ˜¯ç•°æ­¥è¤‡è£½ã€‚</li><li>offï¼šä¸æœƒç­‰å¾… WAL çš„è™•ç†ï¼Œä¹Ÿå°±æ˜¯èªªå¯èƒ½æœƒä¸Ÿå¤± Transactionï¼Œæœ€å¤šå¯èƒ½æœƒå°è‡´ä¸Ÿå¤± <code>wal_write_delay</code> * 3ã€‚</li></ul><p>æ³¨æ„ï¼šç•¶ <code>synchronous_standby_names</code> ç‚ºç©ºæ™‚ï¼Œé™¤äº† OFF ä»¥å¤–çš„è¨­å®šéƒ½æœƒè¢«è¦–ç‚º ONã€‚</p><p><img src=https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b38ca1e7-a55c-4ea4-afb6-a20fc4126332/Untitled.png loading=lazy alt=Untitled></p></li><li><p>synchronous_standby_names (string)ï¼šæŒ‡å®šè¦æ±‚åŒæ­¥ replication çš„ slave åˆ—è¡¨ã€‚</p><p>é€™é‚Šåˆ—å‡º Slave åœ¨ primary_conninfo ä¸­è¨­ç½®çš„ application_name (å¦‚æœæ²’æœ‰å‰‡æ˜¯ cluster_name)ã€‚</p><p>å¯ä»¥è¨­ç½®æˆä»¥ä¸‹æ ¼å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>FIRST<span class=o>]</span> num_sync <span class=o>(</span> standby_name <span class=o>[</span>, ...<span class=o>]</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>ANY num_sync <span class=o>(</span> standby_name <span class=o>[</span>, ...<span class=o>]</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>standby_name <span class=o>[</span>, ...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ num_sync ç‚ºæ•¸å­—ï¼Œè¡¨ç¤ºå¿…é ˆè‡³å°‘æœ‰å¤šå°‘ Slave å›è¦†å·²åŒæ­¥å®Œæˆçš„ Ack è¨Šè™Ÿï¼Œå’Œ FIRSTã€ANY çµ„åˆæœ‰ä»¥ä¸‹æ•ˆæœï¼š</p><ul><li>[FIRST] num_syncï¼šå¿…é ˆæŒ‰ç…§åˆ—è¡¨ä¸­çš„é †åºå‰ num_sync æ•¸é‡çš„ slave å›è¦†å·²åŒæ­¥å®Œæˆçš„ Ack è¨Šè™Ÿæ‰å¯ä»¥ï¼Œä¹‹å¾Œçš„ slave ä½œç‚ºåŒæ­¥ slave çš„å‚™é¸åªæœ‰å„ªå…ˆåºé«˜çš„å‡ºç¾å•é¡Œæ‰æœƒæ›¿è£œã€‚</li><li>ANY num_syncï¼šåªè¦åˆ—è¡¨ä¸­çš„ä»»æ„ num_sync æ•¸é‡çš„ slave å›è¦†å·²åŒæ­¥å®Œæˆçš„ Ack è¨Šè™Ÿå³å¯ã€‚</li></ul></li></ul><h3 id=å»ºç½®ç¯„ä¾‹>å»ºç½®ç¯„ä¾‹</h3><ol><li><p>æª¢æŸ¥ Source çš„è¨­å®š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>listen_addresses</span> <span class=o>=</span> <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä»¥ä¸‹çš†ç‚ºé è¨­å€¼</span>
</span></span><span class=line><span class=cl><span class=nv>hot_standby</span> <span class=o>=</span> ON
</span></span><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> replica
</span></span><span class=line><span class=cl><span class=nv>max_wal_senders</span> <span class=o>=</span> <span class=m>10</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>è¨­ç½® replication ç”¨çš„ User</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>createuser -U postgres --replication repl
</span></span></code></pre></td></tr></table></div></div></li><li><p>ç¢ºèª Source ä¸­çš„ pg_hba.conf æ˜¯å¦èƒ½æ¥å— Replica æ©Ÿå™¨çš„é€£ç·š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
</span></span><span class=line><span class=cl>host    replication     repl            172.17.0.3/16           trust
</span></span></code></pre></td></tr></table></div></div></li><li><p>å° Source é€²è¡Œ Base backup</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span> -R -U repl
</span></span></code></pre></td></tr></table></div></div><p>-R é¸é …æœƒåœ¨å‚™ä»½æª”ä¸­æœ‰ä»¥ä¸‹ä¸åŒ</p><ul><li><p>ç”Ÿæˆ standby.signal</p></li><li><p>åœ¨ postgresql.auto.conf ä¸­å¤šå‡º primary_conninfo çš„è³‡è¨Šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>primary_conninfo</span> <span class=o>=</span> <span class=s1>&#39;user=repl passfile=&#39;&#39;/home/postgres/.pgpass&#39;&#39; channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=disable krbsrvname=postgres target_session_attrs=any&#39;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>å°‡ Source å‰›å‰›çš„ Base backup é‚„åŸåˆ° Replica ä¸Š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /root/pg_data/source/backup/pg_back_2023-04-13_07<span class=se>\:</span>20<span class=se>\:</span>40/* /root/pg_data/replica/postgres
</span></span></code></pre></td></tr></table></div></div></li><li><p>å•Ÿå‹• replica</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_ctl -D /var/data/postgres -l logfile start
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2023-04-13 09:10:54.724 UTC <span class=o>[</span>1136<span class=o>]</span> LOG:  consistent recovery state reached at 0/1A000000
</span></span><span class=line><span class=cl>2023-04-13 09:10:54.725 UTC <span class=o>[</span>1135<span class=o>]</span> LOG:  database system is ready to accept read-only connections
</span></span><span class=line><span class=cl>2023-04-13 09:10:54.733 UTC <span class=o>[</span>1140<span class=o>]</span> LOG:  started streaming WAL from primary at 0/1A000000 on timeline <span class=m>1</span>
</span></span><span class=line><span class=cl> <span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=å°ç¯€-1>å°ç¯€</h3><p>å¯¦å‹™ä¸Šå¯ä»¥çµåˆ log shipping å’Œ streaming replication ä¸€èµ·ä½¿ç”¨ï¼Œç•¶ streaming replicaiton å› ç‚º TCP ç•°å¸¸æˆ–æ˜¯ Primary ä¸Ÿæ£„æ‰€éœ€çš„ WAL æ™‚ï¼ŒPG èƒ½å¤ è‡ªå‹•åˆ‡æ›å›ä½¿ç”¨ log shipping é€é restore_command ç¹¼çºŒè¿½è¶• Pimary çš„é€²åº¦ï¼Œç›´åˆ°è¶•ä¸Š Primary å¾Œ Standby æœƒé‡æ–°å˜—è©¦åˆ‡å› streaming replictionã€‚</p><h2 id=replication-slot>Replication Slot</h2><h3 id=åŠŸç”¨---slave-æ‰€éœ€çš„-wal-åœ¨-master-ä¸Šçš„ä¿ç•™>åŠŸç”¨ - Slave æ‰€éœ€çš„ WAL åœ¨ Master ä¸Šçš„ä¿ç•™</h3><p>åœ¨ PostgreSQL 9.4 ä¹‹å‰æ˜¯æ²’æœ‰ Replication Slot çš„ï¼ŒSlave å› ç‚ºæŸäº›åŸå› æš«åœ replication ä¹‹å¾Œï¼Œå› ç‚ºåœ¨ Master ä¸Šéœ€è¦æ‡‰ç”¨çš„ WAL å·²ç¶“è¢«æ¸…é™¤ï¼Œå°è‡´ Slave æ¢å¾© replication å¾Œç™¼ç”Ÿä»¥ä¸‹ç‹€æ³ï¼š<code>requested WAL segment 0000000100000000000000xxx has already been removed</code>ï¼Œç‚ºäº†é¿å…é€™å€‹ç‹€æ³å¯ä»¥é€éä»¥ä¸‹åƒæ•¸çš„é…ç½®ï¼š</p><ul><li><p>wal_keep_sizeï¼šæŒ‡å®š pg_wal ç›®éŒ„ä¸‹è‡³å°‘éœ€ä¿ç•™çš„ WAL å¤§å°ã€‚</p><p>é»˜èªå€¼ç‚º 0 è¡¨ç¤ºä¸æœƒé¡å¤–ä¿ç•™ WALï¼Œä¹Ÿå°±æ˜¯èªª slave å¯ç”¨çš„ WAL segments æ•¸é‡å–æ±ºæ–¼å‰ä¸€å€‹ checkpoint å’Œ WAL archiving ç‹€æ…‹ã€‚</p><p>å‚™è¨»ï¼šåœ¨ PG 13 ä¹‹å‰æ˜¯ä½¿ç”¨ wal_keep_segments ä¾†æ§åˆ¶ï¼Œä»–å€‘ä¹‹é–“çš„é—œä¿‚æ˜¯ wal_keep_size = wal_keep_segments * wal_segment_size (ä¸€èˆ¬æ˜¯ 16 MB)ã€‚</p></li><li><p>archive_commandï¼šè¨­ç½® WAL archive çš„æŒ‡ä»¤ã€‚</p><p>å°‡ WAL archive åˆ°å…¶ä»–åœ°æ–¹ï¼Œé€™æ¨£ Slave å°±èƒ½å¾å·²ç¶“ archive çš„ WAL ç¹¼çºŒæ¢å¾©ã€‚</p></li></ul><p>ä¸éä»¥ä¸Šæ–¹æ³•æœƒä¿ç•™è¼ƒå¤šçš„ WALï¼Œå› æ­¤æœ‰äº† Replication Slot ç”¨ä¾†ç¢ºä¿ Master åœ¨æ‰€æœ‰ Slave æ”¶åˆ° WAL segments ä¹‹å‰ä¸æœƒåˆªé™¤å°æ‡‰çš„éƒ¨åˆ†ã€‚</p><p>ä½†é€™ä¹Ÿå¸¶ä¾†äº†ç›¸æ‡‰çš„å•é¡Œï¼šç•¶ Slave ç™¼ç”Ÿç•°å¸¸ç„¡æ³•å›è¦† Master ç•¶å‰çš„ lsn ä½ç½®ï¼Œå°±æœƒå°è‡´ Master ä¸æ–·ä¿ç•™ WAL æœ€å¾Œå°è‡´ Disk ç©ºé–“ç”¨ç›¡è€Œç„¡æ³•æä¾›æ­£å¸¸æœå‹™ã€‚</p><p>åœ¨ PostgresSQL 13 ä¹‹å‰ï¼Œåªèƒ½é€éç›£æ§ replication ç‹€æ…‹ä¾†ç›¡æ—©ç™¼ç¾é€²è¡Œè™•ç†ï¼Œä¾‹å¦‚ä»¥ä¸‹èªå¥å¯ä»¥çŸ¥é“ä¿ç•™çš„ lsn åˆ°ç•¶å‰æœ€æ–°çš„ redo_lsn è½å¾Œå¤šå°‘ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># SELECT redo_lsn, slot_name,restart_lsn, round((redo_lsn-restart_lsn)/1024/1024,2) AS  MB_behind  </span>
</span></span><span class=line><span class=cl>FROM pg_control_checkpoint<span class=o>()</span>, pg_replication_slots<span class=p>;</span>
</span></span><span class=line><span class=cl> redo_lsn  <span class=p>|</span> slot_name  <span class=p>|</span> restart_lsn <span class=p>|</span> mb_behind 
</span></span><span class=line><span class=cl>-----------+------------+-------------+-----------
</span></span><span class=line><span class=cl> 0/AAFF2D0 <span class=p>|</span> pgstandby1 <span class=p>|</span> 0/AAFF3B8   <span class=p>|</span>      0.00
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ PostgresSQL 13 æ™‚æ¨å‡ºäº† <code>max_slot_wal_keep_size</code> é€™å€‹è¨­ç½®ï¼š</p><ul><li><p>max_slot_wal_keep_size (integer)ï¼šè¨­ç½® replication slot åœ¨ pg_wal ç›®éŒ„ä¸­ä¿ç•™çš„æœ€å¤§ wal å¤§å°ã€‚</p><p>ç•¶ä¸€å€‹ slot çš„ restart_lsn è½å¾Œæ–¼ current_lsn æœ¬æ•¸å€¼å¾Œæœƒåœæ­¢ stream replicationï¼Œä¸”è©² slot æœƒè¢«æ¨™è¨˜ç‚ºç„¡æ•ˆï¼ŒåŒæ™‚ä¹‹å‰çš„ WAL å°‡è¢«åˆªé™¤ã€‚</p><p>é è¨­å€¼ç‚º -1 è¡¨ç¤ºä¸é™åˆ¶ã€‚</p></li></ul><p>ä»¥ä¸Šåƒæ•¸æ¥µå¤§é¿å…äº†åœ¨ç™¼ç”Ÿ Master è¢« WAL æ’çˆ†çš„å•é¡Œï¼Œä¸¦ä¸”åœ¨ <code>pg_replication_slots</code> ä¹Ÿå¢åŠ äº† <code>wal_status</code> å’Œ <code>safe_wal_size</code> å­—æ®µæ–¹ä¾¿ç›£æ§ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># select wal_status,safe_wal_size  from pg_replication_slots;</span>
</span></span><span class=line><span class=cl> wal_status <span class=p>|</span> safe_wal_size 
</span></span><span class=line><span class=cl>------------+---------------
</span></span><span class=line><span class=cl> reserved   <span class=p>|</span>    <span class=m>1078987728</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>wal_status</code>ï¼šè¡¨ç¤ºè©² Slot æ‰€éœ€çš„ WAL ç‹€æ…‹<ul><li>reservedï¼šåœ¨ max_wal_size ä¹‹å…§ã€‚</li><li>extendedï¼šè¶…å‡ºäº† max_wal_sizeï¼Œä½†ä»åœ¨ <code>wal_keep_size</code> æˆ– <code>max_slot_wal_keep_size</code> çš„ä¿è­·ç¯„åœå…§ã€‚</li><li>unreservedï¼šè¡¨ç¤º WAL å·²ç¶“ä¸åœ¨ä¿è­·ç¯„åœå…§ï¼Œé€™æ˜¯ä¸€å€‹è‡¨æ™‚ç‹€æ…‹ï¼Œéš¨å¾Œå¯èƒ½è®Šæˆ <code>extended</code> æˆ– <code>lost</code>ã€‚</li><li>lostï¼šä»£è¡¨ WAL å·²è¢«åˆªé™¤ã€‚</li></ul></li><li><code>safe_wal_size</code>ï¼šåªæœ‰è¨­ç½® <code>max_slot_wal_keep_size</code> æ‰æœƒå‡ºç¾ï¼Œè¡¨ç¤ºé‚„èƒ½å¯«å…¥å¤šå°‘ WAL å¤§å°æ‰ä¸æœƒè¶…é <code>max_slot_wal_keep_size</code> ã€‚ç•¶æ­¤å€¼ â‰¤ 0 æ™‚ï¼Œä¸€æ—¦è§¸ç™¼ checkpoint å°±æœƒç™¼ç”Ÿ wal_status = lost çš„ç‹€æ³ã€‚</li></ul><h3 id=åŠŸç”¨---æ”¹å–„-master-çš„-vacuum-éæ—©æ¸…é™¤-slave-æ‰€éœ€çš„ç´€éŒ„>åŠŸç”¨ - æ”¹å–„ Master çš„ vacuum éæ—©æ¸…é™¤ Slave æ‰€éœ€çš„ç´€éŒ„</h3><p>ç•¶åœ¨ Master ä½¿ç”¨ vacuum æŒ‡ä»¤æˆ–è€…è§¸ç™¼ auto vacuum æ™‚ï¼Œå¦‚æœæ­¤æ“ä½œåœ¨ Slave å›æ”¾æ™‚æ°å·§æ­£åœ¨é€²è¡Œç›¸é—œè¡¨çš„æŸ¥è©¢æ™‚ï¼Œæœƒæª¢æ¸¬å‡º vacuum è¦æ¸…ç†çš„å…ƒçµ„ (tuple) ä»è¢«ä½¿ç”¨ä¸­ï¼Œå› æ­¤ä¸èƒ½åœ¨ Slave ä¸­ç«‹åˆ»æ¸…é™¤æœƒåœ¨ç­‰å¾… <code>max_standby_streaming_delay</code> (é»˜èªç‚º 30 ç§’) ä¹‹å¾Œçµ‚æ­¢è©²æŸ¥è©¢æ“ä½œï¼Œä¸¦è¿”å›ä»¥ä¸‹éŒ¯èª¤å¾Œé€²è¡Œ vacuumï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ERROR: canceling statement due to conflict with recovery
</span></span><span class=line><span class=cl>Detail: User query might have needed to see row versions that must be removed
</span></span></code></pre></td></tr></table></div></div><p>åœ¨æ²’æœ‰ä½¿ç”¨ Replication Slot æ™‚ï¼Œå¯ä»¥é€éä»¥ä¸‹ 2 å€‹åƒæ•¸èª¿æ•´ï¼š</p><ul><li><p>åœ¨ Master ä¸Šè¨­ç½® vacuum_defer_cleanup_age (integer)ï¼šæŒ‡å®š vacuum å’Œ Hot updates å°‡å»¶é²å¤šå°‘ transaction ä¹‹å‰çš„ dead tuple å°‡ä¸é€²è¡Œåˆªé™¤ã€‚</p><p>é»˜èªå€¼ç‚º 0ï¼Œè¡¨ç¤ºå¯ä»¥ç›¡å¿«åˆªé™¤ dead tupleã€‚</p><p>å•é¡Œï¼šèª¿å¤§æ­¤å€¼é›–ç„¶å¯ä»¥å¤šä¿ç•™ N å€‹ Transaction ä¹‹å‰çš„ dead tupleï¼Œä½†é€™æ˜¯æ ¹æ“š Master ä¸Šçš„ Transaction ç‹€æ³æ±ºå®šï¼Œå¯¦éš›ä¸Šå¾ˆé›£é æ¸¬ sLAVE éœ€è¦å¤šå°‘é¡å¤–çš„å¯¬é™æ™‚é–“ï¼Œå› æ­¤ä¸å¤ªå¯¦ç”¨ã€‚</p></li><li><p>åœ¨ Slave ä¸Šè¨­ç½® hot_standby_feedback (boolean)ï¼šç•¶è¨­ç½®ç‚º ONï¼Œè¡¨ç¤º Slave æœƒé€šçŸ¥ Master è‡ªå·±ç›®å‰çš„æœ€å°æ´»èºäº‹å‹™id (xmin) å€¼ï¼Œé€™æ¨£ Master åœ¨åŸ·è¡Œ vacuum æ“ä½œæ™‚æœƒæš«æ™‚ä¸æ¸…é™¤å¤§æ–¼è©² xmin çš„ dead tupleã€‚</p><p>å•é¡Œï¼šç•¶æ²’æœ‰ Slot æ™‚ï¼Œåœ¨ Slave æœªé€£çµçš„ä»»ä½•æ™‚é–“æ®µéƒ½ä¸æä¾›ä¿è­·ã€‚</p></li></ul><p>ç•¶æœ‰ Replication Slot å’Œ <code>hot_standby_feedback</code> åƒæ•¸é…åˆæ™‚ï¼Œslot æœƒä¿æŒç´€éŒ„æœ€å¾Œå›å‚³çš„ xmin ä¿è­· dead tupleã€‚</p><p>ä¸éç†æ‰€ç•¶ç„¶çš„äº‹æƒ…æœ‰ä¸€é«”å…©é¢ï¼Œå¦‚æœ Slave ä¸Šè©²æŸ¥è©¢é‹è¡Œéä¹…ï¼ŒMaster ä¸Šå¯èƒ½æœƒç™¼ç”Ÿæ›´åš´é‡çš„è¡¨è†¨è„¹å•é¡Œã€‚</p><h3 id=ä½¿ç”¨-physical-replication-slot>ä½¿ç”¨ Physical Replication slot</h3><ol><li><p>æª¢æŸ¥ Source çš„è¨­å®š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>listen_addresses</span> <span class=o>=</span> <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä»¥ä¸‹çš†ç‚ºé è¨­å€¼</span>
</span></span><span class=line><span class=cl><span class=nv>hot_standby</span> <span class=o>=</span> ON
</span></span><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> replica
</span></span><span class=line><span class=cl><span class=nv>max_wal_senders</span> <span class=o>=</span> <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=nv>max_replication_slots</span> <span class=o>=</span> <span class=m>10</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ Sourrce ä¸Šå»ºç«‹ replication slot</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># SELECT * FROM pg_create_physical_replication_slot(&#39;node_a_slot&#39;);</span>
</span></span><span class=line><span class=cl>  slot_name  <span class=p>|</span> lsn
</span></span><span class=line><span class=cl>-------------+-----
</span></span><span class=line><span class=cl> node_a_slot <span class=p>|</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># SELECT slot_name, slot_type, active FROM pg_replication_slots;</span>
</span></span><span class=line><span class=cl>  slot_name  <span class=p>|</span> slot_type <span class=p>|</span> active 
</span></span><span class=line><span class=cl>-------------+-----------+--------
</span></span><span class=line><span class=cl> node_a_slot <span class=p>|</span> physical  <span class=p>|</span> f
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>ä¿®æ”¹ Replica ä¸Šçš„è¨­å®š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>primary_conninfo</span> <span class=o>=</span> <span class=s1>&#39;user=repl port=5432 host=172.17.0.2 application_name=replica&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>primary_slot_name</span> <span class=o>=</span> <span class=s1>&#39;node_a_slot&#39;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=å°ç¯€-2>å°ç¯€</h3><p>æˆ‘èªç‚ºæ‡‰è©²ä½¿ç”¨ replication slot</p><h2 id=logical-replication-é‚è¼¯è¤‡è£½>Logical Replication (é‚è¼¯è¤‡è£½)</h2><h3 id=pg-1514-é™åˆ¶>PG 15(14) é™åˆ¶</h3><ol><li>åƒ…æœƒåŒæ­¥ table (åŒ…å« partitioned table)ï¼Œä¸æ”¯æŒ views, materialized views, or foreign tablesã€‚</li><li>ä¸æœƒè¤‡è£½ schema åŠ DDL å‘½ä»¤ã€‚</li><li>ä¸è¤‡è£½ sequence data</li><li></li><li>ä¸æ”¯æŒ Large objectsã€‚</li><li></li></ol><h3 id=å»ºç½®ç¯„ä¾‹-1>å»ºç½®ç¯„ä¾‹</h3><ol><li><p>èª¿æ•´ Masterã€Slave çš„è¨­å®šï¼Œå…¶ä¸­ <code>wal_level</code> å¿…é ˆèª¿æ•´ç‚º <code>logical</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> logical
</span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ Master å»ºç«‹ä¸€å€‹ç”¨æ–¼ Logical Replication çš„ roleï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=n>logic_repl</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>replication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>é‚„å¿…é ˆæä¾›</span><span class=w> </span><span class=k>usage</span><span class=w> </span><span class=k>schema</span><span class=err>ã€</span><span class=k>select</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=err>çš„æ¬Šé™</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>grant</span><span class=w> </span><span class=k>usage</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=n>test_schema</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>logic_repl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>grant</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>test_schema</span><span class=p>.</span><span class=n>test_table</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>logic_repl</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>è¨­ç½® Master pg_hba.confï¼Œæ³¨æ„é€™é‚Šå’Œç‰©ç†è¤‡è£½ä¸ä¸€æ¨£ï¼Œdatabase å¿…é ˆæä¾›ç›¸æ‡‰çš„ tableï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
</span></span><span class=line><span class=cl>host    <span class=nb>test</span>             logic_repl      172.17.0.3/16           trust
</span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ Master ä¸Šå»ºç«‹ PUBLICATIONï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>57</span><span class=p>:</span><span class=mi>41</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                              </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>publications</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Owner</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>All</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Inserts</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Updates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Deletes</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Truncates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Via</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------+-------+------------+---------+---------+---------+-----------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>57</span><span class=p>:</span><span class=mi>59</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=n>PUBLICATION</span><span class=w> </span><span class=n>repltest</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test_schema</span><span class=p>.</span><span class=n>test_table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>43</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>publications</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Name</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=k>Owner</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=k>All</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Inserts</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Updates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Deletes</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Truncates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Via</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+----------+------------+---------+---------+---------+-----------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>mytest</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>postgres</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ Slave ä¸Šå»ºç«‹ SUBSCRIPTION</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>22</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>subscriptions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Owner</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Enabled</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Publication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------+-------+---------+-------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>02</span><span class=p>:</span><span class=mi>30</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=n>SUBSCRIPTION</span><span class=w> </span><span class=n>mysub</span><span class=w> </span><span class=k>CONNECTION</span><span class=w> </span><span class=s1>&#39;dbname=test host=172.17.0.2 user=logic_repl&#39;</span><span class=w>  </span><span class=n>PUBLICATION</span><span class=w> </span><span class=n>repltest</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=n>copy_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>45</span><span class=p>:</span><span class=mi>07</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>subscriptions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Name</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=k>Owner</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>Enabled</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Publication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------+----------+---------+-------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>mysub</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>postgres</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=n>mytest</span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=åƒè€ƒ>åƒè€ƒ</h2><p><a class=link href=https://www.postgresql.org/docs/15/high-availability.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: ChapterÂ 27.Â High Availability, Load Balancing, and Replication</a></p><p><a class=link href=https://www.postgresql.org/docs/15/logical-replication.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: ChapterÂ 31.Â Logical Replication</a></p><p><a class=link href=https://www.postgresql.org/docs/current/runtime-config-replication.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: 20.6.Â Replication</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2015/10/04/ target=_blank rel=noopener>PgSQL Â· ç‰¹æ€§åˆ†æ Â· PGä¸»å¤‡æµå¤åˆ¶æœºåˆ¶ (taobao.org)</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2018/01/03/ target=_blank rel=noopener>PgSQL Â· å†…æ ¸è§£æ Â· åŒæ­¥æµå¤åˆ¶å®ç°åˆ†æ (taobao.org)</a></p><p><a class=link href=https://github.com/digoal/blog/blob/master/201610/20161006_02.md target=_blank rel=noopener>PostgreSQL 9.6 åŒæ­¥å¤šå‰¯æœ¬ ä¸ remote_applyäº‹åŠ¡åŒæ­¥çº§åˆ«</a></p><p><a class=link href=https://blog.csdn.net/weixin_39540651/article/details/106122610 target=_blank rel=noopener>ä¸€æ–‡å½»åº•å¼„æ‡‚PostgreSQLæµå¤åˆ¶(å…¨ç½‘æœ€è¯¦ç»†)_pgæµå¤åˆ¶_foucusã€çš„åšå®¢-CSDNåšå®¢</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2015/02/03/ target=_blank rel=noopener>PgSQL Â· ç‰¹æ€§åˆ†æÂ· Replication Slot (taobao.org)</a></p><p><a class=link href=https://blog.csdn.net/gaojiebao/article/details/121900737 target=_blank rel=noopener>postgresql-14æµå¤åˆ¶éƒ¨ç½²æ‰‹å†Œ_HistSpeedçš„åšå®¢-CSDNåšå®¢</a></p><p><a class=link href=https://girders.org/postgresql/2021/11/05/setup-postgresql14-replication/ target=_blank rel=noopener>Setup PostgreSQL 14 Streaming Replication | Girders: the blog of Allen Fair</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/311496301 target=_blank rel=noopener>æˆ‘æ˜¯ä¸€ä¸ªæ’æ§½ï¼Œä»Šå¤©æˆ‘åšæ‰äº†æ•°æ®åº“ - çŸ¥ä¹ (zhihu.com)</a></p><p><a class=link href=https://blog.csdn.net/weixin_37692493/article/details/121089674 target=_blank rel=noopener>PGå¤åˆ¶çŠ¶æ€ç›‘æ§_wal_status reserved_ä¸‰æ€å‘ä¸‰æ€çš„åšå®¢-CSDNåšå®¢</a></p><p><a class=link href=https://www.percona.com/blog/replication-lag-in-postgresql/ target=_blank rel=noopener>Itâ€™s All About Replication Lag in PostgreSQL (percona.com)</a></p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸é—œæ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/postgre-vacuum/><div class=article-details><h2 class=article-title>PostgreSQL vacuum</h2></div></a></article><article><a href=/p/postgre-backup-restore/><div class=article-details><h2 class=article-title>PostgreSQL å‚™ä»½é‚„åŸ</h2></div></a></article><article><a href=/p/postgre-file-storage/><div class=article-details><h2 class=article-title>PostgreSQL å¯¦é«”æª”æ¡ˆå„²å­˜</h2></div></a></article><article><a href=/p/postgre-schema/><div class=article-details><h2 class=article-title>PostgreSQL schema</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//å°å° DBA å€‹äººç­†è¨˜.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>