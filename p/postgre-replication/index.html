<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="紀錄學習的 PostgreSQL Replication"><title>PostgreSQL Replication</title>
<link rel=canonical href=https://FuweaY.github.io/p/postgre-replication/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="PostgreSQL Replication"><meta property='og:description' content="紀錄學習的 PostgreSQL Replication"><meta property='og:url' content='https://FuweaY.github.io/p/postgre-replication/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2020-02-19T12:00:00+08:00'><meta property='article:modified_time' content='2020-02-19T12:00:00+08:00'><meta name=twitter:title content="PostgreSQL Replication"><meta name=twitter:description content="紀錄學習的 PostgreSQL Replication"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐱</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>熱愛分享的 DBA 小天地</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>夜晚模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#standby-slave-的行為>Standby (Slave) 的行為</a></li><li><a href=#建議>建議</a></li><li><a href=#設置-standby>設置 Standby</a><ol><li><a href=#log-shipping-warm-standby>Log Shipping (warm standby)</a><ol><li><a href=#配置方式>配置方式</a></li></ol></li><li><a href=#相關參數>相關參數</a><ol><li><a href=#archiving>Archiving</a></li><li><a href=#archive-recovery>Archive Recovery</a></li></ol></li><li><a href=#小節>小節</a></li></ol></li><li><a href=#streaming-replication-流複製-或稱-物理複製>Streaming Replication (流複製 或稱 物理複製)</a><ol><li><a href=#同步-or-異步>同步 OR 異步</a></li><li><a href=#建置範例>建置範例</a></li><li><a href=#小節-1>小節</a></li></ol></li><li><a href=#replication-slot>Replication Slot</a><ol><li><a href=#功用---slave-所需的-wal-在-master-上的保留>功用 - Slave 所需的 WAL 在 Master 上的保留</a></li><li><a href=#功用---改善-master-的-vacuum-過早清除-slave-所需的紀錄>功用 - 改善 Master 的 vacuum 過早清除 Slave 所需的紀錄</a></li><li><a href=#使用-physical-replication-slot>使用 Physical Replication slot</a></li><li><a href=#小節-2>小節</a></li></ol></li><li><a href=#logical-replication-邏輯複製>Logical Replication (邏輯複製)</a><ol><li><a href=#pg-1514-限制>PG 15(14) 限制</a></li><li><a href=#建置範例-1>建置範例</a></li></ol></li><li><a href=#參考>參考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/postgresql/>PostgreSQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/postgre-replication/>PostgreSQL Replication</a></h2><h3 class=article-subtitle>紀錄學習的 PostgreSQL Replication</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 19, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>閱讀時間: 10 分鐘</time></div></footer></div></header><section class=article-content><p>Replication 是提供高可用及 load balance 的基礎，因此不論在哪一種 database 都是一項重要的功能。</p><p>在不同的 Database 下對於主備 Server 都有不同的術語：</p><div class=table-wrapper><table><thead><tr><th></th><th>MySQL &lt; 8.0.26</th><th>MySQL > 8.0.26</th><th>MongoDB</th><th>PostgreSQL</th></tr></thead><tbody><tr><td>主</td><td>Master</td><td>Source</td><td>Primary</td><td>Primary</td></tr><tr><td>備</td><td>Slave</td><td>Replica</td><td>Secondary</td><td>Standby</td></tr></tbody></table></div><p>在 MySQL 中透過 Server 層的 binlog 透過</p><p>在 PG 中則是直接透過 WAL (相對於 InnoDB redo log)</p><h2 id=standby-slave-的行為>Standby (Slave) 的行為</h2><p>當 server 啟動時數據目錄中包含 <code>standby.signal</code> 文件時，則 server 會進入 standby 模式。</p><p>在 standby 模式下，standby 可以透過以下兩種方式來獲取並回放 Primary 上的 WAL：</p><ul><li>WAL Archive</li><li>Streaming Replication</li></ul><p>除此之外 Standby 還會嘗試恢復在 pg_wal 目錄中的任何 WAL。</p><p>Standby 在啟動時會有以下行為：</p><ol><li>調用 <code>restore_command</code> 進行恢復。</li><li>當步驟1 達到 WAL 末尾且恢復失敗，則將嘗試恢復 pg_wal 目錄中可用的 WAL。</li><li>當步驟2失敗，且配置了 Streaming Replication ，則會嘗試連接到 Primary 並從存檔或 pg_wal 目錄中找到有效的紀錄開始 Streaming WAL。</li><li>當步驟3失敗，或是沒有配置 Streaming Replication 則將回到步驟1重新嘗試</li></ol><p>以上步驟的 retry 循環或一直持續到 server 關閉或者 failover。</p><p>failover 可以透過運行 <code>pg_ctl promote</code>、調用 <code>pg_promote()</code> 或發現 trigger file (promote_trigger_file) 時，則會退退出 standby 模式成為 primary 提供正常操作。</p><h2 id=建議>建議</h2><ul><li>在不同的主要版本號中通常是無法進行 log shipping 的</li><li>雖然 PG 沒有正式支持不同次要版本之間的 log shipping，但在次要版本中一般不更改 Disk 格式，並且新的次要版本更可能從舊的次要版本讀取 WAL，因此升級小版本號時建議先升級 standby。</li><li></li><li>在 Primary 上設置 Continuous archiving 時，應該考慮將歸檔位置設為 standby 本身或是非 Primary 機器上，避免因為 Primary 機器本身出問題而無法訪問。</li><li>使用 Streaming Replicaiton 需要注意以下事項：<ul><li>創建 replication role，並在 ph_hba.conf 有正確的設置，確保 standby 能夠連線 Primary。</li><li>確保 Primary 上的 <code>max_wal_senders</code> 設置足夠大。</li><li>如果使用 Replication Slot 還需要確保 <code>max_replication_slots</code> 設置。</li></ul></li></ul><h2 id=設置-standby>設置 Standby</h2><h3 id=log-shipping-warm-standby>Log Shipping (warm standby)</h3><p>在 PG 9.0 之前，PostgreSQL 只提供這種異步 replication 方式，這是透過 Primary 每次傳送一個 WAL 給 Standby 來實現，缺陷也很明顯就是 Standby 至少會落後 Primary 一個 WAL。</p><h4 id=配置方式>配置方式</h4><ol><li><p>在 Primary 中新增以下設置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>archive_mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>archive_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;test ! -f /var/data/xlog_archive/%f &amp;&amp; cp %p /var/data/xlog_archive/%f&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>對 Primary 進行 Base backup</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>還原到 Standby</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>cp</span><span class=w> </span><span class=o>-</span><span class=n>R</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>pg_back_2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>17</span><span class=n>_07</span><span class=err>\</span><span class=p>:</span><span class=mi>06</span><span class=err>\</span><span class=p>:</span><span class=mi>57</span><span class=cm>/* /var/data/postgres
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>修改 Standby 設置，並以 standby 模式運行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>restore_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cp /var/data/xlog_archive/%f &#34;%p&#34;&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>touch</span><span class=w> </span><span class=n>standby</span><span class=p>.</span><span class=n>signal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pg_ctl</span><span class=w> </span><span class=o>-</span><span class=n>D</span><span class=w> </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=k>data</span><span class=o>/</span><span class=n>postgres</span><span class=w> </span><span class=o>-</span><span class=n>l</span><span class=w> </span><span class=n>logfile</span><span class=w> </span><span class=k>start</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>透過在 Primary 新增資料，並使用 <code>pg_switch_wal()</code> 強制觸發 WAL 的切換來觀察</p><ul><li><p>primary</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- primary
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>07</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=k>c</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>You</span><span class=w> </span><span class=k>are</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=n>connected</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s2>&#34;test&#34;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=s2>&#34;postgres&#34;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>08</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>607</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>13</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;test2&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>594</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>24</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>330</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>25</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>pg_switch_wal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>pg_switch_wal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>30003</span><span class=n>D8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>171</span><span class=p>.</span><span class=mi>419</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>standby</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>41</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=k>c</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>You</span><span class=w> </span><span class=k>are</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=n>connected</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s2>&#34;test&#34;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=s2>&#34;postgres&#34;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>44</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>relations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>Schema</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Type</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=k>Owner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+------+-------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>52</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>660</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>425</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 在 primeary 觸發 WAL 刷新後
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>27</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>334</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li></ol><h3 id=相關參數>相關參數</h3><h4 id=archiving>Archiving</h4><ul><li><p>archive_mode (enum)：設置是否進行 archive，有以下三種設置：</p><ul><li><p>off：關閉 archive。</p></li><li><p>on：正常模式下開啟 archive，但是在 recovery 或是 standby 時不進行 archvie。\</p><p>當 standby提升為 primary 時只會 archive 自己產生的 WAL，而不會 archive 原本從另一個 primary 取得的 WAL。</p></li><li><p>always：不論什麼模式都進行 archive。</p></li></ul></li><li><p>archive_command (string)：設置 archive WAL 的 shell 指令。</p></li><li><p>archive_library (string)：設置用於 archive WAL 的 library，若為空表示使用 <code>archive_command</code>。</p></li><li><p>archive_timeout (integer)：此參數為時間設置預設單位為秒，當此參數大於 0 時，會強制 server 只要距離上次切換到新的 WAL 已經過去這段時間，且有數據庫活動就必須切換到新的 WAL。</p><p>因為 archive 只會針對完成的 WAL 作用，因此設置此參數可以避免當 WAL 輪換不頻繁時，導致 Transaction 過久沒有被安全的歸檔或者同步到 standby。</p><p>注意：強制切換 WAL 的文件大小和完整的文件大小相同都是 16MB，因此設置太短的 <code>archive_timeout</code> 會導致歸檔存檔膨脹，通常 1 分鐘左右的設置是合理。如果希望 Primary 和 Standby 之間的延遲更小應該考慮 streaming replication 而不是調整此值。</p></li></ul><h4 id=archive-recovery>Archive Recovery</h4><p>此處用於設置 recovery 期間的設定，recovery 包含以下兩者：</p><ul><li>recovery mode：透過在數據目錄中創建 <code>recovery.signal</code> 設置</li><li>standby mode：透過在數據目錄中創建 <code>standby.signal</code> 設置，首先進入 recovery mode 並在恢復到歸檔的 WAL 末尾時不會停止，而是會嘗試透過 <code>primary_conninfo</code> 向指定的 primary 請求 WAL 或 <code>restore_command</code> 來繼續回放 WAL。</li></ul><p>備注：如果 2 個 signal 都被建立則會以 standby mode 優先。</p><ul><li><p>restore_command (string)：用於設置如何將歸檔的 WAL 用於 restore 的 shell 命令。</p><p>範例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>restore_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cp /mnt/server/archivedir/%f &#34;%p&#34;&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>上述設定表示將複製 <code>/mnt/server/archivdir</code> 底下的 WAL 到 pg_wal 中。</p><ul><li>%f：表示歸檔 WAL 文件名稱。</li><li>%p：表示放置用於恢復 WAL 的目錄 (pg_wal)。</li></ul></li><li><p>archive_cleanup_cpmmand (string)：用於設置清理 standby 不再需要的歸檔 WAL shell 命令。</p><p>範例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>archive_cleanup_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;pg_archivecleanup /mnt/server/archivedir %r&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>上述設定表示運行 <code>pg_archivecleanup</code> 將上一個 WAL 文件刪除。</p><ul><li>%r：表示需要的 WAL 文件的上一個 WAL 文件名稱。</li></ul></li><li><p>recovery_end_command (string)：用於設置當 recovery 結束時執行的 shell 命令，例如可以用於發送 email 通知：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>recovery_end_command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;echo &#34;Recovery complete&#34; | mail -s &#34;Recovery complete&#34; admin@example.com&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=小節>小節</h3><p>Log Shipping 是一種異步且即時性不高的 replication 方式，但是他相應的優勢就是因為是透過 primary 歸檔後的 WAL 進行恢復，因此不會有 Streaming Replicaion 丟失 WAL 導致無法復原的問題。</p><p>雖然不推薦將 Log Shipping 做為主力的 replication 方案，但是可以將其同時和 Streaming Replication 一起運行作為附屬方案，只有當 Streaming Replication 因為某些原因跟不上 Primary 導致對應的 WAL 被刪除時，透過歸檔的 WAL 來進行復原。</p><h2 id=streaming-replication-流複製-或稱-物理複製>Streaming Replication (流複製 或稱 物理複製)</h2><p>在 PG 9.0 開始提供了 Steaming Replication，雖然和 Log Shipping 一樣都是透過 WAL 日誌的回放來達到 Primary 和 Standby 的同步，但是 Streaming Replication 只要在 WAL 中一產生變化就會發送給 Standby，而不需要等到 WAL 切換才傳送，也就是說 Streaming Replication 會有更短的 replication delay。</p><p>具體實現方面大體上其實和 MySQL 差不多，只是 MySQL 是透過 binlog 中的邏輯複製，但 PG 的 WAL 比較接近 MySQL redo log 也就是說是根據實際修改 Disk 物理空間的紀錄，也就是說在 PG 中 Master 和 Slave 的底層數據狀態是完全一致的。</p><p>在 Streaming Replication 有以下角色：</p><ul><li>Master 上的 backend 進程：執行收到的 Query 指令，在修改數據前先寫入 WAL，並在 commit 的時候將 WAL fsync 到 Disk。</li><li>Master 上的 WAL sender 進程：將 WAL 發送給 Slave 的 WAL receiver 。</li><li>Slave 上的 WAL receiver 進程：接收並持久化儲存 Master WAL sender 發送的 WAL。可以類比為 MySQL 的 IO THREAD。</li><li>Slave 上的 startup 進程：Apply WAL receiver 接收到的 WAL。可以類比為 MySQL 的 SQL THREAD。</li></ul><h3 id=同步-or-異步>同步 OR 異步</h3><p>此外和 MySQL 一樣也分為異步或同步，主要透過以下參數控制：</p><ul><li><p>synchronous_commit (enum)：指定 server 在完成多少 WAL 處理後才返回 Clinet 端成功。</p><p>當 <code>synchronous_standby_names</code> 為空時，分為兩種設置：</p><ul><li>on：此為默認值且 OFF 以外的設置都視為 ON，當 WAL fsync 到 Disk 才返回成功給 Client 端。</li><li>off：不會等待 WAL 的處理，也就是說可能會丟失 Transaction，最多可能會導致丟失 <code>wal_write_delay</code> * 3。</li></ul><p>當 <code>synchronous_standby_names</code> 不為空時，分為5種設置：</p><p>總共有以下 5 個值：</p><ul><li>remote_apply：保證 Slave 已經收到該 Transaction 的 WAL 並調用 fsync() disk，確保了該 Transaction 只有 Master、Slave 都發生數據損壞才會丟失 Transaction，並且還完成了 WAL 回放，因此在 Master、Slave 上擁有一致性讀取。</li><li>on：也可稱為 remote_flush，保證 Slave 已經收到該 Transaction 的 WAL 並調用 fsync() disk，確保了該 Transaction 只有 Master、Slave 都發生數據損壞才會丟失 Transaction，但因為還沒有回放 WAL，因此 Master、Slave 沒有一致性讀取。</li><li>remote_write：保證 Slave 已經收到該 Transaction 的 WAL 並寫入 OS 緩存，但未調用 fsync() disk，也就是說 PG server crash 並不會導致 Transaction 丟失，但是整個 OS 系統 Crash 將可能導致 Transaction 丟失。</li><li>local：等同於 <code>synchronous_standby_names</code> 為空時的 ON 設置，也就是說只要 Master 的 WAL 有 fsync 即可不必等待 slave，也就是異步複製。</li><li>off：不會等待 WAL 的處理，也就是說可能會丟失 Transaction，最多可能會導致丟失 <code>wal_write_delay</code> * 3。</li></ul><p>注意：當 <code>synchronous_standby_names</code> 為空時，除了 OFF 以外的設定都會被視為 ON。</p><p><img src=https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b38ca1e7-a55c-4ea4-afb6-a20fc4126332/Untitled.png loading=lazy alt=Untitled></p></li><li><p>synchronous_standby_names (string)：指定要求同步 replication 的 slave 列表。</p><p>這邊列出 Slave 在 primary_conninfo 中設置的 application_name (如果沒有則是 cluster_name)。</p><p>可以設置成以下格式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>FIRST<span class=o>]</span> num_sync <span class=o>(</span> standby_name <span class=o>[</span>, ...<span class=o>]</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>ANY num_sync <span class=o>(</span> standby_name <span class=o>[</span>, ...<span class=o>]</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>standby_name <span class=o>[</span>, ...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 num_sync 為數字，表示必須至少有多少 Slave 回覆已同步完成的 Ack 訊號，和 FIRST、ANY 組合有以下效果：</p><ul><li>[FIRST] num_sync：必須按照列表中的順序前 num_sync 數量的 slave 回覆已同步完成的 Ack 訊號才可以，之後的 slave 作為同步 slave 的備選只有優先序高的出現問題才會替補。</li><li>ANY num_sync：只要列表中的任意 num_sync 數量的 slave 回覆已同步完成的 Ack 訊號即可。</li></ul></li></ul><h3 id=建置範例>建置範例</h3><ol><li><p>檢查 Source 的設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>listen_addresses</span> <span class=o>=</span> <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以下皆為預設值</span>
</span></span><span class=line><span class=cl><span class=nv>hot_standby</span> <span class=o>=</span> ON
</span></span><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> replica
</span></span><span class=line><span class=cl><span class=nv>max_wal_senders</span> <span class=o>=</span> <span class=m>10</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>設置 replication 用的 User</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>createuser -U postgres --replication repl
</span></span></code></pre></td></tr></table></div></div></li><li><p>確認 Source 中的 pg_hba.conf 是否能接受 Replica 機器的連線</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
</span></span><span class=line><span class=cl>host    replication     repl            172.17.0.3/16           trust
</span></span></code></pre></td></tr></table></div></div></li><li><p>對 Source 進行 Base backup</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span> -R -U repl
</span></span></code></pre></td></tr></table></div></div><p>-R 選項會在備份檔中有以下不同</p><ul><li><p>生成 standby.signal</p></li><li><p>在 postgresql.auto.conf 中多出 primary_conninfo 的資訊：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>primary_conninfo</span> <span class=o>=</span> <span class=s1>&#39;user=repl passfile=&#39;&#39;/home/postgres/.pgpass&#39;&#39; channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=disable krbsrvname=postgres target_session_attrs=any&#39;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>將 Source 剛剛的 Base backup 還原到 Replica 上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /root/pg_data/source/backup/pg_back_2023-04-13_07<span class=se>\:</span>20<span class=se>\:</span>40/* /root/pg_data/replica/postgres
</span></span></code></pre></td></tr></table></div></div></li><li><p>啟動 replica</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_ctl -D /var/data/postgres -l logfile start
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2023-04-13 09:10:54.724 UTC <span class=o>[</span>1136<span class=o>]</span> LOG:  consistent recovery state reached at 0/1A000000
</span></span><span class=line><span class=cl>2023-04-13 09:10:54.725 UTC <span class=o>[</span>1135<span class=o>]</span> LOG:  database system is ready to accept read-only connections
</span></span><span class=line><span class=cl>2023-04-13 09:10:54.733 UTC <span class=o>[</span>1140<span class=o>]</span> LOG:  started streaming WAL from primary at 0/1A000000 on timeline <span class=m>1</span>
</span></span><span class=line><span class=cl> <span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=小節-1>小節</h3><p>實務上可以結合 log shipping 和 streaming replication 一起使用，當 streaming replicaiton 因為 TCP 異常或是 Primary 丟棄所需的 WAL 時，PG 能夠自動切換回使用 log shipping 透過 restore_command 繼續追趕 Pimary 的進度，直到趕上 Primary 後 Standby 會重新嘗試切回 streaming repliction。</p><h2 id=replication-slot>Replication Slot</h2><h3 id=功用---slave-所需的-wal-在-master-上的保留>功用 - Slave 所需的 WAL 在 Master 上的保留</h3><p>在 PostgreSQL 9.4 之前是沒有 Replication Slot 的，Slave 因為某些原因暫停 replication 之後，因為在 Master 上需要應用的 WAL 已經被清除，導致 Slave 恢復 replication 後發生以下狀況：<code>requested WAL segment 0000000100000000000000xxx has already been removed</code>，為了避免這個狀況可以透過以下參數的配置：</p><ul><li><p>wal_keep_size：指定 pg_wal 目錄下至少需保留的 WAL 大小。</p><p>默認值為 0 表示不會額外保留 WAL，也就是說 slave 可用的 WAL segments 數量取決於前一個 checkpoint 和 WAL archiving 狀態。</p><p>備註：在 PG 13 之前是使用 wal_keep_segments 來控制，他們之間的關係是 wal_keep_size = wal_keep_segments * wal_segment_size (一般是 16 MB)。</p></li><li><p>archive_command：設置 WAL archive 的指令。</p><p>將 WAL archive 到其他地方，這樣 Slave 就能從已經 archive 的 WAL 繼續恢復。</p></li></ul><p>不過以上方法會保留較多的 WAL，因此有了 Replication Slot 用來確保 Master 在所有 Slave 收到 WAL segments 之前不會刪除對應的部分。</p><p>但這也帶來了相應的問題：當 Slave 發生異常無法回覆 Master 當前的 lsn 位置，就會導致 Master 不斷保留 WAL 最後導致 Disk 空間用盡而無法提供正常服務。</p><p>在 PostgresSQL 13 之前，只能透過監控 replication 狀態來盡早發現進行處理，例如以下語句可以知道保留的 lsn 到當前最新的 redo_lsn 落後多少：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># SELECT redo_lsn, slot_name,restart_lsn, round((redo_lsn-restart_lsn)/1024/1024,2) AS  MB_behind  </span>
</span></span><span class=line><span class=cl>FROM pg_control_checkpoint<span class=o>()</span>, pg_replication_slots<span class=p>;</span>
</span></span><span class=line><span class=cl> redo_lsn  <span class=p>|</span> slot_name  <span class=p>|</span> restart_lsn <span class=p>|</span> mb_behind 
</span></span><span class=line><span class=cl>-----------+------------+-------------+-----------
</span></span><span class=line><span class=cl> 0/AAFF2D0 <span class=p>|</span> pgstandby1 <span class=p>|</span> 0/AAFF3B8   <span class=p>|</span>      0.00
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在 PostgresSQL 13 時推出了 <code>max_slot_wal_keep_size</code> 這個設置：</p><ul><li><p>max_slot_wal_keep_size (integer)：設置 replication slot 在 pg_wal 目錄中保留的最大 wal 大小。</p><p>當一個 slot 的 restart_lsn 落後於 current_lsn 本數值後會停止 stream replication，且該 slot 會被標記為無效，同時之前的 WAL 將被刪除。</p><p>預設值為 -1 表示不限制。</p></li></ul><p>以上參數極大避免了在發生 Master 被 WAL 撐爆的問題，並且在 <code>pg_replication_slots</code> 也增加了 <code>wal_status</code> 和 <code>safe_wal_size</code> 字段方便監控：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># select wal_status,safe_wal_size  from pg_replication_slots;</span>
</span></span><span class=line><span class=cl> wal_status <span class=p>|</span> safe_wal_size 
</span></span><span class=line><span class=cl>------------+---------------
</span></span><span class=line><span class=cl> reserved   <span class=p>|</span>    <span class=m>1078987728</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>wal_status</code>：表示該 Slot 所需的 WAL 狀態<ul><li>reserved：在 max_wal_size 之內。</li><li>extended：超出了 max_wal_size，但仍在 <code>wal_keep_size</code> 或 <code>max_slot_wal_keep_size</code> 的保護範圍內。</li><li>unreserved：表示 WAL 已經不在保護範圍內，這是一個臨時狀態，隨後可能變成 <code>extended</code> 或 <code>lost</code>。</li><li>lost：代表 WAL 已被刪除。</li></ul></li><li><code>safe_wal_size</code>：只有設置 <code>max_slot_wal_keep_size</code> 才會出現，表示還能寫入多少 WAL 大小才不會超過 <code>max_slot_wal_keep_size</code> 。當此值 ≤ 0 時，一旦觸發 checkpoint 就會發生 wal_status = lost 的狀況。</li></ul><h3 id=功用---改善-master-的-vacuum-過早清除-slave-所需的紀錄>功用 - 改善 Master 的 vacuum 過早清除 Slave 所需的紀錄</h3><p>當在 Master 使用 vacuum 指令或者觸發 auto vacuum 時，如果此操作在 Slave 回放時恰巧正在進行相關表的查詢時，會檢測出 vacuum 要清理的元組 (tuple) 仍被使用中，因此不能在 Slave 中立刻清除會在等待 <code>max_standby_streaming_delay</code> (默認為 30 秒) 之後終止該查詢操作，並返回以下錯誤後進行 vacuum：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ERROR: canceling statement due to conflict with recovery
</span></span><span class=line><span class=cl>Detail: User query might have needed to see row versions that must be removed
</span></span></code></pre></td></tr></table></div></div><p>在沒有使用 Replication Slot 時，可以透過以下 2 個參數調整：</p><ul><li><p>在 Master 上設置 vacuum_defer_cleanup_age (integer)：指定 vacuum 和 Hot updates 將延遲多少 transaction 之前的 dead tuple 將不進行刪除。</p><p>默認值為 0，表示可以盡快刪除 dead tuple。</p><p>問題：調大此值雖然可以多保留 N 個 Transaction 之前的 dead tuple，但這是根據 Master 上的 Transaction 狀況決定，實際上很難預測 sLAVE 需要多少額外的寬限時間，因此不太實用。</p></li><li><p>在 Slave 上設置 hot_standby_feedback (boolean)：當設置為 ON，表示 Slave 會通知 Master 自己目前的最小活躍事務id (xmin) 值，這樣 Master 在執行 vacuum 操作時會暫時不清除大於該 xmin 的 dead tuple。</p><p>問題：當沒有 Slot 時，在 Slave 未連結的任何時間段都不提供保護。</p></li></ul><p>當有 Replication Slot 和 <code>hot_standby_feedback</code> 參數配合時，slot 會保持紀錄最後回傳的 xmin 保護 dead tuple。</p><p>不過理所當然的事情有一體兩面，如果 Slave 上該查詢運行過久，Master 上可能會發生更嚴重的表膨脹問題。</p><h3 id=使用-physical-replication-slot>使用 Physical Replication slot</h3><ol><li><p>檢查 Source 的設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>listen_addresses</span> <span class=o>=</span> <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以下皆為預設值</span>
</span></span><span class=line><span class=cl><span class=nv>hot_standby</span> <span class=o>=</span> ON
</span></span><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> replica
</span></span><span class=line><span class=cl><span class=nv>max_wal_senders</span> <span class=o>=</span> <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=nv>max_replication_slots</span> <span class=o>=</span> <span class=m>10</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>在 Sourrce 上建立 replication slot</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># SELECT * FROM pg_create_physical_replication_slot(&#39;node_a_slot&#39;);</span>
</span></span><span class=line><span class=cl>  slot_name  <span class=p>|</span> lsn
</span></span><span class=line><span class=cl>-------------+-----
</span></span><span class=line><span class=cl> node_a_slot <span class=p>|</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>postgres</span><span class=o>=</span><span class=c1># SELECT slot_name, slot_type, active FROM pg_replication_slots;</span>
</span></span><span class=line><span class=cl>  slot_name  <span class=p>|</span> slot_type <span class=p>|</span> active 
</span></span><span class=line><span class=cl>-------------+-----------+--------
</span></span><span class=line><span class=cl> node_a_slot <span class=p>|</span> physical  <span class=p>|</span> f
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>修改 Replica 上的設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>primary_conninfo</span> <span class=o>=</span> <span class=s1>&#39;user=repl port=5432 host=172.17.0.2 application_name=replica&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>primary_slot_name</span> <span class=o>=</span> <span class=s1>&#39;node_a_slot&#39;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=小節-2>小節</h3><p>我認為應該使用 replication slot</p><h2 id=logical-replication-邏輯複製>Logical Replication (邏輯複製)</h2><h3 id=pg-1514-限制>PG 15(14) 限制</h3><ol><li>僅會同步 table (包含 partitioned table)，不支持 views, materialized views, or foreign tables。</li><li>不會複製 schema 及 DDL 命令。</li><li>不複製 sequence data</li><li></li><li>不支持 Large objects。</li><li></li></ol><h3 id=建置範例-1>建置範例</h3><ol><li><p>調整 Master、Slave 的設定，其中 <code>wal_level</code> 必須調整為 <code>logical</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> logical
</span></span></code></pre></td></tr></table></div></div></li><li><p>在 Master 建立一個用於 Logical Replication 的 role：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=n>logic_repl</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>replication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>還必須提供</span><span class=w> </span><span class=k>usage</span><span class=w> </span><span class=k>schema</span><span class=err>、</span><span class=k>select</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=err>的權限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>grant</span><span class=w> </span><span class=k>usage</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=n>test_schema</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>logic_repl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>grant</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>test_schema</span><span class=p>.</span><span class=n>test_table</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>logic_repl</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>設置 Master pg_hba.conf，注意這邊和物理複製不一樣，database 必須提供相應的 table：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
</span></span><span class=line><span class=cl>host    <span class=nb>test</span>             logic_repl      172.17.0.3/16           trust
</span></span></code></pre></td></tr></table></div></div></li><li><p>在 Master 上建立 PUBLICATION：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>57</span><span class=p>:</span><span class=mi>41</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                              </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>publications</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Owner</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>All</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Inserts</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Updates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Deletes</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Truncates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Via</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------+-------+------------+---------+---------+---------+-----------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>57</span><span class=p>:</span><span class=mi>59</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=n>PUBLICATION</span><span class=w> </span><span class=n>repltest</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test_schema</span><span class=p>.</span><span class=n>test_table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>43</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>publications</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Name</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=k>Owner</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=k>All</span><span class=w> </span><span class=n>tables</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Inserts</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Updates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Deletes</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Truncates</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Via</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+----------+------------+---------+---------+---------+-----------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>mytest</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>postgres</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>在 Slave 上建立 SUBSCRIPTION</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>22</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>subscriptions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Owner</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Enabled</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Publication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------+-------+---------+-------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>02</span><span class=p>:</span><span class=mi>30</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=n>SUBSCRIPTION</span><span class=w> </span><span class=n>mysub</span><span class=w> </span><span class=k>CONNECTION</span><span class=w> </span><span class=s1>&#39;dbname=test host=172.17.0.2 user=logic_repl&#39;</span><span class=w>  </span><span class=n>PUBLICATION</span><span class=w> </span><span class=n>repltest</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=n>copy_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>08</span><span class=p>:</span><span class=mi>45</span><span class=p>:</span><span class=mi>07</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=err>\</span><span class=n>dRs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>List</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>subscriptions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Name</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=k>Owner</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>Enabled</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Publication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------+----------+---------+-------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>mysub</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>postgres</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=n>mytest</span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=參考>參考</h2><p><a class=link href=https://www.postgresql.org/docs/15/high-availability.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: Chapter 27. High Availability, Load Balancing, and Replication</a></p><p><a class=link href=https://www.postgresql.org/docs/15/logical-replication.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: Chapter 31. Logical Replication</a></p><p><a class=link href=https://www.postgresql.org/docs/current/runtime-config-replication.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: 20.6. Replication</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2015/10/04/ target=_blank rel=noopener>PgSQL · 特性分析 · PG主备流复制机制 (taobao.org)</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2018/01/03/ target=_blank rel=noopener>PgSQL · 内核解析 · 同步流复制实现分析 (taobao.org)</a></p><p><a class=link href=https://github.com/digoal/blog/blob/master/201610/20161006_02.md target=_blank rel=noopener>PostgreSQL 9.6 同步多副本 与 remote_apply事务同步级别</a></p><p><a class=link href=https://blog.csdn.net/weixin_39540651/article/details/106122610 target=_blank rel=noopener>一文彻底弄懂PostgreSQL流复制(全网最详细)_pg流复制_foucus、的博客-CSDN博客</a></p><p><a class=link href=http://mysql.taobao.org/monthly/2015/02/03/ target=_blank rel=noopener>PgSQL · 特性分析· Replication Slot (taobao.org)</a></p><p><a class=link href=https://blog.csdn.net/gaojiebao/article/details/121900737 target=_blank rel=noopener>postgresql-14流复制部署手册_HistSpeed的博客-CSDN博客</a></p><p><a class=link href=https://girders.org/postgresql/2021/11/05/setup-postgresql14-replication/ target=_blank rel=noopener>Setup PostgreSQL 14 Streaming Replication | Girders: the blog of Allen Fair</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/311496301 target=_blank rel=noopener>我是一个插槽，今天我做掉了数据库 - 知乎 (zhihu.com)</a></p><p><a class=link href=https://blog.csdn.net/weixin_37692493/article/details/121089674 target=_blank rel=noopener>PG复制状态监控_wal_status reserved_三思呐三思的博客-CSDN博客</a></p><p><a class=link href=https://www.percona.com/blog/replication-lag-in-postgresql/ target=_blank rel=noopener>It’s All About Replication Lag in PostgreSQL (percona.com)</a></p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/postgre-vacuum/><div class=article-details><h2 class=article-title>PostgreSQL vacuum</h2></div></a></article><article><a href=/p/postgre-backup-restore/><div class=article-details><h2 class=article-title>PostgreSQL 備份還原</h2></div></a></article><article><a href=/p/postgre-file-storage/><div class=article-details><h2 class=article-title>PostgreSQL 實體檔案儲存</h2></div></a></article><article><a href=/p/postgre-schema/><div class=article-details><h2 class=article-title>PostgreSQL schema</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//小小 DBA 個人筆記.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 建立<br>主題 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 設計</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>