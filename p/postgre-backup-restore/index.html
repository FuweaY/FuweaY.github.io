<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ç´€éŒ„å­¸ç¿’çš„ PostgreSQL å‚™ä»½é‚„åŸ"><title>PostgreSQL å‚™ä»½é‚„åŸ</title>
<link rel=canonical href=https://FuweaY.github.io/p/postgre-backup-restore/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="PostgreSQL å‚™ä»½é‚„åŸ"><meta property='og:description' content="ç´€éŒ„å­¸ç¿’çš„ PostgreSQL å‚™ä»½é‚„åŸ"><meta property='og:url' content='https://FuweaY.github.io/p/postgre-backup-restore/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2020-02-26T12:00:00+08:00'><meta property='article:modified_time' content='2020-02-26T12:00:00+08:00'><meta name=twitter:title content="PostgreSQL å‚™ä»½é‚„åŸ"><meta name=twitter:description content="ç´€éŒ„å­¸ç¿’çš„ PostgreSQL å‚™ä»½é‚„åŸ"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ±</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>ç†±æ„›åˆ†äº«çš„ DBA å°å¤©åœ°</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#pg_dump>pg_dump</a><ol><li><a href=#å‚™ä»½>å‚™ä»½</a></li><li><a href=#é‚„åŸ>é‚„åŸ</a></li><li><a href=#å…¶ä»–äº‹é …>å…¶ä»–äº‹é …</a></li></ol></li><li><a href=#pg_basebackup>pg_basebackup</a><ol><li><a href=#ç¯„ä¾‹>ç¯„ä¾‹</a></li><li><a href=#é¸é …>é¸é …</a></li><li><a href=#å…¶ä»–äº‹é …-1>å…¶ä»–äº‹é …</a></li></ol></li><li><a href=#continuous-archiving-èˆ‡-pitr>Continuous archiving èˆ‡ PITR</a><ol><li><a href=#è¨­ç½®-wal-archining>è¨­ç½® WAL Archining</a></li><li><a href=#ç¯„ä¾‹-1>ç¯„ä¾‹</a></li><li><a href=#å¯¦ä¾‹>å¯¦ä¾‹</a></li><li><a href=#point-in-time-recovery>Point-in-time recovery</a></li></ol></li><li><a href=#timeline>timeline</a><ol><li><a href=#æ–°çš„-timeline-ç”¢ç”Ÿæ™‚æ©Ÿ>æ–°çš„ timeline ç”¢ç”Ÿæ™‚æ©Ÿ</a></li><li><a href=#timeline-å¯¦é«”æª”æ¡ˆ>timeline å¯¦é«”æª”æ¡ˆ</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/postgresql/>PostgreSQL</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/postgre-backup-restore/>PostgreSQL å‚™ä»½é‚„åŸ</a></h2><h3 class=article-subtitle>ç´€éŒ„å­¸ç¿’çš„ PostgreSQL å‚™ä»½é‚„åŸ</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 26, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 12 åˆ†é˜</time></div></footer></div></header><section class=article-content><h2 id=pg_dump>pg_dump</h2><p>å°±åƒ mysqldump ä¸€æ¨£çš„æ•ˆæœï¼Œå°‡æ•¸æ“š dump æˆ SQL èªå¥ã€‚</p><h3 id=å‚™ä»½>å‚™ä»½</h3><p>ä½¿ç”¨ pg_dump ä¾†å‚™ä»½å–®å€‹ databaseï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/usr/bin/pg_dump <span class=nb>test</span> &gt; test.dump
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>âœ  ~ cat test.dump
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>CREATE TABLE public.test <span class=o>(</span>
</span></span><span class=line><span class=cl>    id integer
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ALTER TABLE public.test OWNER TO postgres<span class=p>;</span>
</span></span><span class=line><span class=cl>COPY public.test <span class=o>(</span>id<span class=o>)</span> FROM stdin<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=m>3</span>
</span></span><span class=line><span class=cl><span class=m>4</span>
</span></span><span class=line><span class=cl><span class=se>\.</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>é è¨­æƒ…æ³ä¸‹ dump å‡ºä¾†çš„å‚™ä»½æª”æ˜¯ä»¥ COPY èªå¥ä¾†é‚„åŸæ•¸æ“šï¼Œå¦‚æœéœ€è¦å°‡ copy èªæ³•è®Šç‚º insert å¯ä»¥ä½¿ç”¨ <code>column-inserts</code> ä¸¦é€é <code>rows-per-insert</code> æŒ‡å®šä¸€å€‹ insert èªå¥åŒ…å«çš„è¡Œæ•¸ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/usr/bin/pg_dump --column-inserts --rows-per-insert <span class=m>2</span> <span class=nb>test</span> &gt; test.dump
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># test.dump ä¸­çš„éƒ¨åˆ†å…§å®¹</span>
</span></span><span class=line><span class=cl>INSERT INTO public.test <span class=o>(</span>id<span class=o>)</span> VALUES
</span></span><span class=line><span class=cl>        <span class=o>(</span>1<span class=o>)</span>,
</span></span><span class=line><span class=cl>        <span class=o>(</span>2<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>INSERT INTO public.test <span class=o>(</span>id<span class=o>)</span> VALUES
</span></span><span class=line><span class=cl>        <span class=o>(</span>3<span class=o>)</span>,
</span></span><span class=line><span class=cl>        <span class=o>(</span>4<span class=o>)</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=é‚„åŸ>é‚„åŸ</h3><p>ä½¿ç”¨ psql ä¾†é‚„åŸï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å»ºç«‹è¦é‚„åŸçš„ç›®æ¨™ database</span>
</span></span><span class=line><span class=cl>psql --command <span class=s2>&#34;create database test_restore&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># é‚„åŸ</span>
</span></span><span class=line><span class=cl>psql test_restore &lt; test.dump
</span></span></code></pre></td></tr></table></div></div><p>é è¨­æƒ…æ³ä¸‹é‚„åŸé‡åˆ°éŒ¯èª¤ç¹¼çºŒåŸ·è¡Œï¼Œå¦‚æœå¸Œæœ›å¯ä»¥ç™¼ç”Ÿ SQL éŒ¯èª¤æ™‚é€€å‡ºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql --set <span class=nv>ON_ERROR_STOP</span><span class=o>=</span>on dbname &lt; dumpfile
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœé‚„éœ€è¦æ›´é€²ä¸€æ­¥å°‡æ•´å€‹é‚„åŸéç¨‹è¦–ç‚ºä¸€å€‹ Transactionï¼Œå¯ä»¥é€éæ·»åŠ  &ndash;single-transactionï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql --set <span class=nv>ON_ERROR_STOP</span><span class=o>=</span>on --single-transaction dbname &lt; dumpfile
</span></span></code></pre></td></tr></table></div></div><p>æ­¤å¤–é‚„å¯ä»¥é€é pipeline çš„æ–¹å¼åœ¨ pg_dump çš„åŒæ™‚ç›´æ¥é‚„åŸï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_dump -h host1 dbname <span class=p>|</span> psql -h host2 dbname
</span></span></code></pre></td></tr></table></div></div><h3 id=å…¶ä»–äº‹é …>å…¶ä»–äº‹é …</h3><ol><li><p>pg_dump çš„ User éœ€è¦å°è©² Table æœ‰è®€å–æ¬Šé™ã€‚</p></li><li><p>pg_dump ä¸€æ¬¡åªèƒ½å‚™ä»½ä¸€å€‹ databaseï¼Œä¸¦ä¸”ä¸åŒ…å« roleã€tablespace (å› ç‚ºä»–å€‘å±¬æ–¼ cluster ç¯„åœï¼Œè€Œä¸æ˜¯ database)ã€‚</p></li><li><p>pg_dump é‹è¡Œæ™‚æœƒåŸ·è¡Œ database snapshot ä¾†é”åˆ°å…§éƒ¨ä¸€è‡´æ€§ã€‚</p></li><li><p>pg_dump æœƒå’Œ ALTER é˜»å¡ã€‚</p></li><li><p>è¦ä¸€æ¬¡å‚™ä»½æ•´å€‹ cluster è«‹ä½¿ç”¨ pg_dumpallï¼Œé€™æœƒ dump æ‰€æœ‰çš„ database å’Œ cluster ç¯„åœçš„æ•¸æ“šï¼Œä¾‹å¦‚ roleã€tablespaceã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å‚™ä»½</span>
</span></span><span class=line><span class=cl>pg_dumpall &gt; dumpfile
</span></span><span class=line><span class=cl><span class=c1># é‚„åŸ</span>
</span></span><span class=line><span class=cl>psql -f dumpfile postgres
</span></span></code></pre></td></tr></table></div></div><p>ä½†æ˜¯éœ€è¦æ³¨æ„å› ç‚ºåŒ…å« cluster ç¯„åœçš„æ•¸æ“šï¼Œå› æ­¤å¿…é ˆä½¿ç”¨ super user çš„æ¬Šé™ã€‚</p><p>æ³¨æ„ï¼špg_dumpall å¯¦éš›ä¸Šæœƒç‚ºæ¯å€‹ database èª¿ç”¨ pg_dumpï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è­‰æ‰€æœ‰ database snapshot æ˜¯åŒæ­¥çš„ã€‚</p><p>æ­¤å¤–å¯ä»¥é€é <code>--globals-only</code> é¸é …ä¾†åªæœ‰å‚™ä»½ cluster ç¯„åœçš„æ•¸æ“šã€‚</p></li><li><p>å¦‚æœåœ¨ pg_dump æ™‚ä½¿ç”¨éç´”æ–‡æœ¬çš„æ ¼å¼(-Fc) æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ pg_restore ä¾†é‚„åŸã€‚</p></li></ol><p>å„ªé»ï¼š</p><ol><li>å¯ä»¥é‚„åŸåˆ°ä¸åŒçš„ RDBMSã€‚</li><li>å¯ä»¥é‚„åŸåˆ°ä¸åŒç‰ˆæœ¬çš„ PostgreSQLã€‚</li></ol><p>ç¼ºé»ï¼š</p><ol><li>å› ç‚ºç­‰æ–¼éœ€è¦é‹è¡Œæ¯ä¸€å€‹ SQL å‘½ä»¤ä¾†é‚„åŸï¼Œå› æ­¤é‚„åŸé€Ÿåº¦è¼ƒæ…¢ã€‚</li></ol><h2 id=pg_basebackup>pg_basebackup</h2><p>ç‚º PostgreSQL å…§å»ºçš„ç‰©ç†å‚™ä»½å·¥å…·ï¼Œç”¨æ–¼å° PostgreSQL é€²è¡Œå…¨é‡ç‰©ç†ç†±å‚™ä»½ã€‚</p><p>pg_basebackup æœƒåœ¨å‚™ä»½æœŸé–“å‰µå»ºä¸€å€‹å‚™ä»½æ­·å²æ–‡ä»¶ï¼Œè©²æ–‡ä»¶æœƒä»¥å‚™ä»½æ™‚çš„ç¬¬ä¸€å€‹ WAL æ–‡ä»¶ç‚ºå‘½åï¼Œä¾‹å¦‚ <code>000000010000000000000002.00000028.backup</code> è¡¨ç¤ºå‚™ä»½æ™‚ç¬¬ä¸€å€‹ WAL åç¨±æ˜¯ <code>000000010000000000000002</code> å¦å¤–çš„ <code>00000028</code> è¡¨ç¤ºå…¶ä¸­çš„ç¢ºåˆ‡ä½ç½® (ä¸€èˆ¬ä¾†èªªå¯ä»¥å¿½ç•¥)ï¼Œä»¥ä¸‹æ˜¯è©²æª”æ¡ˆåŒ…å«çš„è³‡è¨Šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=o>@</span><span class=n>ed875d053382</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=o>#</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=mi>000000010000000000000002</span><span class=p>.</span><span class=mi>00000028</span><span class=p>.</span><span class=n>backup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>START</span><span class=w> </span><span class=n>WAL</span><span class=w> </span><span class=k>LOCATION</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>2000028</span><span class=w> </span><span class=p>(</span><span class=n>file</span><span class=w> </span><span class=mi>000000010000000000000002</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>STOP</span><span class=w> </span><span class=n>WAL</span><span class=w> </span><span class=k>LOCATION</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>2000100</span><span class=w> </span><span class=p>(</span><span class=n>file</span><span class=w> </span><span class=mi>000000010000000000000002</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CHECKPOINT</span><span class=w> </span><span class=k>LOCATION</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>2000060</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>BACKUP</span><span class=w> </span><span class=k>METHOD</span><span class=p>:</span><span class=w> </span><span class=n>streamed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>BACKUP</span><span class=w> </span><span class=k>FROM</span><span class=p>:</span><span class=w> </span><span class=k>primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>START</span><span class=w> </span><span class=n>TIME</span><span class=p>:</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>17</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>07</span><span class=p>:</span><span class=mi>01</span><span class=w> </span><span class=n>UTC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LABEL</span><span class=p>:</span><span class=w> </span><span class=n>pg_basebackup</span><span class=w> </span><span class=n>base</span><span class=w> </span><span class=n>backup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>START</span><span class=w> </span><span class=n>TIMELINE</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>STOP</span><span class=w> </span><span class=n>TIME</span><span class=p>:</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>17</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>07</span><span class=p>:</span><span class=mi>02</span><span class=w> </span><span class=n>UTC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>STOP</span><span class=w> </span><span class=n>TIMELINE</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå°±æ˜¯èªªåªéœ€è¦ä¿å­˜åŒ…å« <code>000000010000000000000002</code> ä¹‹å¾Œçš„ WAL å°±å¯ä»¥å®Œæ•´çš„å¾©åŸã€‚</p><h3 id=ç¯„ä¾‹>ç¯„ä¾‹</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=é¸é …>é¸é …</h3><ul><li>-Dï¼šæŒ‡å®šå‚™ä»½çš„ç›®çš„åœ°</li><li>-Fã€ï¼šæŒ‡å®šè¼¸å‡ºçš„æ ¼å¼<ul><li>pã€plainï¼šé è¨­å€¼ï¼Œè¼¸å‡ºæˆæ™®é€šæ–‡ä»¶ã€‚</li><li>tã€tarï¼šè¼¸å‡ºç‚º tar æ–‡ä»¶ã€‚</li></ul></li><li>-Rï¼šå‰µå»º standy.signal æ–‡ä»¶ï¼Œä¸¦å°‡ç›¸é—œçš„é€£æ¥è¨­ç½®é™„åŠ åˆ° <code>postgresql.auto.conf</code> ä¸­ï¼Œç”¨æ–¼ä¾¿æ–¼å°‡å‚™ä»½æª”ç”¨æ–¼å»ºç½® replicaã€‚</li><li>-Xï¼šæŒ‡å®šå‚™ä»½åœ¨å‚™ä»½æœŸé–“ä¸­ç”¢ç”Ÿçš„ WALã€‚<ul><li>nã€noneï¼šä¸å‚™ä»½ WALã€‚</li><li>fã€fetchï¼šå°‡åœ¨å‚™ä»½çµæŸå¾Œæ”¶é›† WALï¼Œå› æ­¤éœ€è¦æœ‰è¶³å¤ é«˜çš„ <code>wal_keep_size</code>ï¼Œå¦å‰‡å¯èƒ½ç™¼ç”Ÿæ‰€éœ€çš„ wal è¢«å›æ”¶å°è‡´å‚™ä»½ç„¡æ³•ä½¿ç”¨ã€‚</li><li>sã€streamï¼šé»˜èªå€¼ï¼Œåœ¨å‚™ä»½çš„åŒæ™‚é€é streaming replication æŒçºŒå‚³è¼¸ WALï¼Œé€™å°‡é¡å¤–é–‹ä¸€å€‹é€£çµä¾†é€²è¡Œ WAL çš„å‚™ä»½ï¼Œ</li></ul></li><li>-Pï¼šé¡¯ç¤ºé€²åº¦ã€‚</li></ul><h3 id=å…¶ä»–äº‹é …-1>å…¶ä»–äº‹é …</h3><p>å„ªé»ï¼š</p><p>ç¼ºé»ï¼šåªèƒ½å‚™ä»½æ•´å€‹ Instance ç„¡æ³•æŒ‡å®šå–®è¡¨ã€‚</p><h2 id=continuous-archiving-èˆ‡-pitr>Continuous archiving èˆ‡ PITR</h2><p>åªè¦æ˜¯æ•¸æ“šåº«éƒ½æœ‰æœ€åŸºæœ¬çš„ Durability(æŒä¹…æ€§) éœ€è¦ä¿è­‰ï¼Œé€™å¤§éƒ¨åˆ†éƒ½æ˜¯é€é WAL æŠ€è¡“ä¹Ÿå°±æ˜¯æ—¥èªŒå…ˆè¡Œä¾†é”åˆ°ï¼Œåœ¨ MySQL ä¸­æ˜¯ REDO LOG è€Œåœ¨ PostgreSQL ä¸­å‰‡æ˜¯ WAL (åœ¨ PG 10 ä¹‹å‰ç¨±ç‚º xlog)ã€‚</p><p>å› æ­¤å°±åƒ MySQL å¯ä»¥é€é xtrabackup çš„ç‰©ç†å‚™ä»½åŠ ä¸Š binlog åšå¾ŒçºŒçš„å¢é‡æ¢å¾©ï¼ŒPostgreSQL åŒæ¨£å¯ä»¥é€é pg_basebackup ç”¢ç”Ÿçš„å…¨é‡å‚™ä»½åŠ ä¸Šå¾ŒçºŒçš„ WAL é”åˆ°å¢é‡æ¢å¾©ï¼Œé€™æ¨£é‚„æœ‰ <em>point-in-time recovery</em> çš„å„ªå‹¢ã€‚</p><h3 id=è¨­ç½®-wal-archining>è¨­ç½® WAL Archining</h3><p>PostgreSQL æ¯ 16 MB (é è¨­å€¼)å°±æœƒè¼ªæ›ä¸€å€‹æ–°çš„ WAL æ–‡ä»¶ï¼Œè€Œç•¶æ‰€æœ‰çš„ WAL è¶…é max_wal_size èˆŠçš„ WAL æœƒè¢«ä¸€ä¸€åˆªé™¤ (ä¾ç…§ checkpoint åˆ¤æ–·æ˜¯å¦ä¸å†éœ€è¦å°æ‡‰çš„ WAL)ï¼Œç‚ºäº†é¿å…å…¨é‡å‚™ä»½å¾Œæ‰€éœ€çš„ WAL åœ¨ç¶“éä¸€é™£å­å¾Œè¢«åˆªé™¤å°è‡´æ•´å€‹å…¨é‡å‚™ä»½ä¸å¯ç”¨ï¼Œæˆ‘å€‘éœ€è¦ç‚º WAL è¨­ç½® Archining çš„æ–¹å¼ï¼Œç¢ºä¿åœ¨åˆªé™¤ WAL ä¹‹å‰æœ‰é€²è¡Œæ­¸æª”ã€‚</p><p>è¦é…ç½® WAL Archining éœ€è¦ä»¥ä¸‹è¨­å®šï¼š</p><ul><li>wal_level = replica | logical</li><li>archive_mode = ON</li><li>arvhive_command = â€˜test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%fâ€™<ul><li>%f æœƒè¢«æ›¿æ›æˆæ­¸æª”çš„ wal æ–‡ä»¶åç¨±ã€‚</li><li>%p æœƒè¢«æ›¿æ›æˆæ­¸æª”çš„ wal è·¯å¾‘ã€‚</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>wal_level</span> <span class=o>=</span> replica
</span></span><span class=line><span class=cl><span class=nv>archive_mode</span> <span class=o>=</span> ON
</span></span><span class=line><span class=cl><span class=nv>arvhive_command</span> <span class=o>=</span> <span class=s1>&#39;test ! -f /var/data/xlog_archive/%f &amp;&amp; cp %p /var/data/xlog_archive/%f&#39;</span> 
</span></span></code></pre></td></tr></table></div></div><h3 id=ç¯„ä¾‹-1>ç¯„ä¾‹</h3><ol><li><p>é€é pg_basebackup ç²å–å…¨é‡å‚™ä»½</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>é—œé–‰ serverï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_ctl stop
</span></span></code></pre></td></tr></table></div></div></li><li><p>å°ç•¶å‰çš„å¯¦é«”æª”æ¡ˆæš«å­˜ï¼Œä»¥å‚™ä¸æ™‚ä¹‹éœ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /var/data/postgres/ /var/data/postgres_backup/ 
</span></span></code></pre></td></tr></table></div></div><p>å‚™è¨»ï¼šå¦‚æœæ²’æœ‰è¶³å¤ çš„ç©ºé–“æ‡‰è‡³å°‘ä¿ç•™ pg_wal å­ç›®éŒ„ï¼Œå› ç‚ºå¯èƒ½åŒ…å«å°šæœª archive çš„ wal éœ€ç”¨æ–¼ç¨å¾Œæ¢å¾©ã€‚</p></li><li><p>æ¸…é™¤ç•¶å‰çš„å¯¦é«”æª”æ¡ˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rm -rf /var/data/postgres/*
</span></span></code></pre></td></tr></table></div></div></li><li><p>å¾ Base Backup é€²è¡Œæ¢å¾©ï¼Œæ³¨æ„è«‹ä½¿ç”¨ DBç³»çµ±ç”¨æˆ¶ (postgre) é€²è¡ŒåŒ…å«æ­£ç¢ºæ¬Šé™çš„æ¢å¾©ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /var/data/backup/pg_back_2023-04-13_02<span class=se>\:</span>55<span class=se>\:</span>49/* /var/data/postgres/
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæœ‰ä½¿ç”¨ tablespace æ‡‰è©²æª¢æŸ¥ pg_tblspc ä¸­çš„ symbolic link æ˜¯å¦æ­£ç¢ºæ¢å¾©ã€‚</p></li><li><p>ç§»é™¤ Base Backup ä¸­çš„ <code>pg_wal/</code> ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå› ç‚ºé€™äº›æ˜¯ç•¶åˆ Base Backup çš„ wal æ–‡ä»¶å¯èƒ½å·²ç¶“éæ™‚äº†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rm -rf /var/data/postgres/pg_wal/*
</span></span></code></pre></td></tr></table></div></div></li><li><p>å°‡æ­¥é©Ÿ 2 ä¸­ä¿å­˜çš„æœªæ­¸æª” wal æ–‡ä»¶è¤‡è£½åˆ° pg_wal</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /var/data/postgres_backup/pg_wal/* /var/data/postgres/pg_wal/
</span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ <code>postgresql.conf</code> ä¸­è¨­ç½®æ¢å¾©ç›¸é—œçš„é…ç½®</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>restore_command</span> <span class=o>=</span> <span class=s1>&#39;cp /var/data/xlog_archive/%f %p&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># recovery_target_time å¯ä»¥é…ç½®æ¢å¾©åˆ°çš„æ™‚é–“é»</span>
</span></span><span class=line><span class=cl><span class=c1># recovery_target_timeline </span>
</span></span></code></pre></td></tr></table></div></div><p>å»ºç«‹ <code>recovery.signal</code> æ–‡ä»¶ä¾†è§¸ç™¼ restore</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>touch recovery.signal
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„ï¼šæ­¤æ™‚é‚„å¯ä»¥èª¿æ•´ pg_hba.conf ä¾†é˜²æ­¢å…¶ä»– role ä¾†é€£ç·šå‰›æ¢å¾©çš„ clusterã€‚</p></li><li><p>å•Ÿå‹• server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_ctl -D /var/data/postgres -l logfile start
</span></span></code></pre></td></tr></table></div></div><p>æ¢å¾©æˆåŠŸå¾Œ <code>recovery.signal</code> æœƒè¢«åˆªé™¤ï¼Œé¿å…ç¨å¾Œæ„å¤–é‡æ–°é€²å…¥æ¢å¾©æ¨¡å¼ã€‚</p></li><li><p>æª¢æŸ¥æ•¸æ“šåº«æ˜¯å¦æ¢å¾©å®Œæˆï¼Œå¦‚æœå®Œæˆè¨˜å¾—é‡æ–°èª¿æ•´ pg_hba.conf æ¢å¾©å…¶ä»–ä½¿ç”¨è€…çš„å­˜å–ã€‚</p></li></ol><h3 id=å¯¦ä¾‹>å¯¦ä¾‹</h3><ol><li><p>æ–°å¢ä¸€äº›æ¸¬è©¦è³‡æ–™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=k>c</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>test_table</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>10</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>02</span><span class=p>:</span><span class=mi>53</span><span class=p>:</span><span class=mi>21</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test_table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>é€²è¡Œ Base backupï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pg_basebackup -P -D /var/data/backup/pg_back_<span class=k>$(</span>date +<span class=s2>&#34;%F_%T&#34;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>æ–°å¢å¢é‡æ¸¬è©¦è³‡æ–™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>test_table2</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>10</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test_table</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=s1>&#39;test3&#39;</span><span class=p>),(</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;test4&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test_table2</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=s1>&#39;test5&#39;</span><span class=p>),(</span><span class=mi>6</span><span class=p>,</span><span class=s1>&#39;test6&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>02</span><span class=p>:</span><span class=mi>57</span><span class=p>:</span><span class=mi>25</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test_table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>381</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>02</span><span class=p>:</span><span class=mi>57</span><span class=p>:</span><span class=mi>29</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test_table2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>5</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>å¼·åˆ¶é—œé–‰ pg æœå‹™</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>postgres@3f5b5718e08f postgres<span class=o>]</span>$ ps aux<span class=p>|</span> grep postgre
</span></span><span class=line><span class=cl>root        <span class=m>801</span>  0.0  0.1  <span class=m>83584</span>  <span class=m>2196</span> pts/0    S    02:14   0:00 su postgres
</span></span><span class=line><span class=cl>postgres    <span class=m>802</span>  0.0  0.1  <span class=m>14096</span>  <span class=m>2888</span> pts/0    S    02:14   0:00 bash
</span></span><span class=line><span class=cl>postgres   <span class=m>1148</span>  0.0  1.0 <span class=m>216872</span> <span class=m>19112</span> ?        Ss   02:56   0:00 /usr/local/postgres/bin/postgres
</span></span><span class=line><span class=cl>postgres   <span class=m>1150</span>  0.0  0.0 <span class=m>216872</span>  <span class=m>1568</span> ?        Ss   02:56   0:00 postgres: checkpointer
</span></span><span class=line><span class=cl>postgres   <span class=m>1151</span>  0.0  0.1 <span class=m>217008</span>  <span class=m>2596</span> ?        Ss   02:56   0:00 postgres: background writer
</span></span><span class=line><span class=cl>postgres   <span class=m>1152</span>  0.0  0.5 <span class=m>216872</span>  <span class=m>9720</span> ?        Ss   02:56   0:00 postgres: walwriter
</span></span><span class=line><span class=cl>postgres   <span class=m>1153</span>  0.0  0.1 <span class=m>217428</span>  <span class=m>2776</span> ?        Ss   02:56   0:00 postgres: autovacuum launcher
</span></span><span class=line><span class=cl>postgres   <span class=m>1154</span>  0.0  0.0 <span class=m>216872</span>  <span class=m>1580</span> ?        Ss   02:56   0:00 postgres: archiver
</span></span><span class=line><span class=cl>postgres   <span class=m>1155</span>  0.0  0.0  <span class=m>67512</span>  <span class=m>1756</span> ?        Ss   02:56   0:00 postgres: stats collector
</span></span><span class=line><span class=cl>postgres   <span class=m>1156</span>  0.0  0.1 <span class=m>217428</span>  <span class=m>2316</span> ?        Ss   02:56   0:00 postgres: logical replication launcher
</span></span><span class=line><span class=cl>postgres   <span class=m>1173</span>  0.0  0.1  <span class=m>53332</span>  <span class=m>1876</span> pts/0    R+   02:57   0:00 ps aux
</span></span><span class=line><span class=cl>postgres   <span class=m>1174</span>  0.0  0.0  <span class=m>10696</span>   <span class=m>984</span> pts/0    S+   02:57   0:00 grep --color<span class=o>=</span>auto postgre
</span></span><span class=line><span class=cl><span class=o>[</span>postgres@3f5b5718e08f postgres<span class=o>]</span>$ <span class=nb>kill</span> -9 postgres
</span></span></code></pre></td></tr></table></div></div></li><li><p>å‚™ä»½ç•¶å‰å¯¦é«”æª”æ¡ˆä¸¦æ¸…é™¤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /var/data/postgres/ /var/data/postgres_backup/ 
</span></span><span class=line><span class=cl>rm -rf /var/data/postgres/*
</span></span></code></pre></td></tr></table></div></div></li><li><p>å¾ Base Backup é€²è¡Œæ¢å¾©ï¼Œä¸¦æ¸…ç©ºå‚™ä»½ä¸­çš„ walï¼Œå†å°‡åŸæœ¬çš„ wal æª”æ¡ˆè¤‡è£½éä¾†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp -R /var/data/backup/pg_back_2023-04-13_02<span class=se>\:</span>55<span class=se>\:</span>49/* /var/data/postgres/
</span></span><span class=line><span class=cl>rm -rf /var/data/postgres/pg_wal/*
</span></span><span class=line><span class=cl>cp -R /var/data/postgres_backup/pg_wal/* /var/data/postgres/pg_wal/
</span></span></code></pre></td></tr></table></div></div></li><li><p>é…ç½® restore_command</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>restore_command</span> <span class=o>=</span> <span class=s1>&#39;cp /var/data/xlog_archive/%f %p&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>å»ºç«‹ <code>recovery.signal</code> æ–‡ä»¶ä¾†è§¸ç™¼ restore</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>touch recovery.signal
</span></span></code></pre></td></tr></table></div></div></li><li><p>å•Ÿå‹•ä¸¦æª¢æŸ¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>postgres@3f5b5718e08f postgres<span class=o>]</span>$ pg_ctl -D /var/data/postgres -l logfile start
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>postgres@3f5b5718e08f postgres<span class=o>]</span>$ psql <span class=nb>test</span>
</span></span><span class=line><span class=cl>Timing is on.
</span></span><span class=line><span class=cl>psql <span class=o>(</span>14.7<span class=o>)</span>
</span></span><span class=line><span class=cl>Type <span class=s2>&#34;help&#34;</span> <span class=k>for</span> help.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>postgres @ test<span class=o>]</span> <span class=o>[</span>local<span class=o>]</span>:5432<span class=o>]</span> 03:00:30 &gt; <span class=se>\d</span>t
</span></span><span class=line><span class=cl>            List of relations
</span></span><span class=line><span class=cl> Schema <span class=p>|</span>    Name     <span class=p>|</span> Type  <span class=p>|</span>  Owner
</span></span><span class=line><span class=cl>--------+-------------+-------+----------
</span></span><span class=line><span class=cl> public <span class=p>|</span> test_table  <span class=p>|</span> table <span class=p>|</span> postgres
</span></span><span class=line><span class=cl> public <span class=p>|</span> test_table2 <span class=p>|</span> table <span class=p>|</span> postgres
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>2</span> rows<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>postgres @ test<span class=o>]</span> <span class=o>[</span>local<span class=o>]</span>:5432<span class=o>]</span> 03:00:32 &gt; <span class=k>select</span> * from test_table<span class=p>;</span>
</span></span><span class=line><span class=cl> id <span class=p>|</span> name
</span></span><span class=line><span class=cl>----+-------
</span></span><span class=line><span class=cl>  <span class=m>1</span> <span class=p>|</span> <span class=nb>test</span>
</span></span><span class=line><span class=cl>  <span class=m>2</span> <span class=p>|</span> test2
</span></span><span class=line><span class=cl>  <span class=m>3</span> <span class=p>|</span> test3
</span></span><span class=line><span class=cl>  <span class=m>4</span> <span class=p>|</span> test4
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>4</span> rows<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Time: 0.620 ms
</span></span><span class=line><span class=cl><span class=o>[</span>postgres @ test<span class=o>]</span> <span class=o>[</span>local<span class=o>]</span>:5432<span class=o>]</span> 03:00:37 &gt; <span class=k>select</span> * from test_table2<span class=p>;</span>
</span></span><span class=line><span class=cl> id <span class=p>|</span> name
</span></span><span class=line><span class=cl>----+-------
</span></span><span class=line><span class=cl>  <span class=m>5</span> <span class=p>|</span> test5
</span></span><span class=line><span class=cl>  <span class=m>6</span> <span class=p>|</span> test6
</span></span><span class=line><span class=cl><span class=o>(</span><span class=m>2</span> rows<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Time: 0.715 ms
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=point-in-time-recovery>Point-in-time recovery</h3><p>é è¨­æƒ…æ³ä¸‹æœƒç›´æ¥æ¢å¾©åˆ° WAL çš„æœ«å°¾ï¼Œå¯ä»¥é€éè¨­ç½® recovery_target ç›¸é—œåƒæ•¸ä¾†æŒ‡å®šä¸€å€‹æ›´æ—©çš„åœæ­¢é»ï¼Œé”åˆ° Point-in-time recoveryã€‚</p><p>ç›¸é—œåƒæ•¸å¦‚ä¸‹ï¼š</p><ul><li><p>recovery_target = â€™immediateâ€™ï¼šç›®å‰åªæœ‰ <code>immediate</code> æ­¤è¨­å®šï¼Œè¡¨ç¤ºç›¡æ—©çµæŸä¹Ÿå°±æ˜¯è©²å‚™ä»½çµæŸçš„æ™‚é–“é»ã€‚</p></li><li><p>recovery_target_name (string)ï¼šæŒ‡å®šé€é <code>pg_create_restore_point()</code> æ‰€å‰µå»ºçš„ restore pointï¼ŒæŒ‡ç¤ºæ¢å¾©åˆ°æ­¤ä½ç½®ã€‚</p></li><li><p>recovery_target_time (timestamp)ï¼šæŒ‡å®šæ¢å¾©åˆ°æŒ‡å®šçš„æ™‚é–“æˆ³ã€‚</p><p>æº–ç¢ºä¾†èªªæ˜¯æŒ‡ WAL ä¸­è¨˜éŒ„</p></li><li><p>recovery_target_xid (string)ï¼šæŒ‡å®šæ¢å¾©åˆ°æŒ‡å®šçš„ Tranasction IDï¼Œæ³¨æ„é›–ç„¶ Transaction ID æ˜¯é †åºåˆ†é…çš„ï¼Œä½†æ˜¯å¯èƒ½ä¾ç…§ä¸åŒé †åº commitï¼Œæ­¤è¨­ç½®åŒæ™‚ä¹Ÿæœƒæ¢å¾©è©² Transaction ID ä¹‹å‰ commit ä½†å…·æœ‰æ›´å¤§çš„ Transaction ID çš„äº‹å‹™ã€‚</p></li><li><p>recovery_target_lsn (string)ï¼šæŒ‡å®šæ¢å¾©åˆ°æŒ‡å®šçš„ LSN ä½ç½®ã€‚</p></li><li><p>recovery_target_inclusive (boolean)ï¼šå½±éŸ¿ç•¶è¨­ç½® <code>recovery_target_time</code>ã€ <code>recovery_target_xid</code> å’Œ <code>recovery_target_lsn</code>ï¼Œé»˜èªå€¼ ON è¡¨ç¤ºæ¢å¾©å®Œé€™äº›ç›®æ¨™æ‰åœæ­¢ï¼Œå¦‚æœæ˜¯ OFF å‰‡è¡¨ç¤ºæ¢å¾©åˆ°é€™äº›è¨­ç½®ä¹‹å‰å°±åœæ­¢ã€‚</p></li><li><p>recovery_target_timeline (string)ï¼šæŒ‡å®šæ¢å¾©åˆ°ä¸€å€‹ timeline ä¸­ï¼Œè©²å€¼å¯ä»¥ timeline id æˆ–ä»¥ä¸‹ç‰¹å®šå€¼ï¼š</p><ul><li>currentï¼šæ²¿è‘— base backup çš„ timeline é€²è¡Œæ¢å¾©ã€‚</li><li>latestï¼šé»˜èªå€¼ï¼Œæ¢å¾©åˆ°æœ€æ–°çš„ timelineã€‚</li></ul></li><li><p>recovery_target_action (enum)ï¼šæŒ‡å®šç•¶é”åˆ° recovery target å¾Œçš„å‹•ä½œï¼š</p><ul><li><p>pauseï¼šé»˜èªå€¼ï¼Œè¡¨ç¤ºåœæ­¢ recovery ä¸¦å…è¨±æŸ¥è©¢ã€‚</p><p>å¦‚æœ hot_standby = offï¼Œå‰‡æ­¤å€¼è¡Œç‚ºå’Œ shutdown ç­‰åŒã€‚</p><p>å¦‚æœåœ¨ promote ä¸­é”åˆ° recovery targetï¼Œå‰‡æ­¤å€¼è¡Œç‚ºå’Œ promote ç­‰åŒã€‚</p></li><li><p>promoteï¼šè¡¨ç¤ºæ¢å¾©çµæŸå¾Œ sever å°‡å…è¨±é€£æ¥ã€‚</p></li><li><p>shutdownï¼šè¡¨ç¤ºæ¢å¾©çµæŸå¾Œåœæ­¢ serverï¼Œè¨­ç½®æ­¤å€¼æ™‚ recovery.singal å°‡ä¸æœƒè¢«ç§»é™¤ã€‚</p></li></ul><p>å‚™è¨»ï¼šå¦‚æœæ²’æœ‰è¨­ç½® recovery target ç›¸é—œåƒæ•¸ï¼Œå‰‡æ­¤åƒæ•¸ç„¡æ•ˆã€‚</p></li></ul><blockquote><p>ğŸ’¡ æ³¨æ„ï¼šrecovery_targetã€recovery_target_nameã€recovery_target_timeã€recovery_target_xid ã€recovery_target_lsn åªèƒ½å¤ è¨­ç½®å…¶ä¸­ä¸€å€‹ï¼Œè¨­ç½®å¤šå€‹å°‡å¼•ç™¼éŒ¯èª¤ã€‚</p></blockquote><ul><li>å¯¦åš<ol><li><p>ç•¶å‰è³‡æ–™åº«çš„è³‡æ–™å…§å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>24</span><span class=p>:</span><span class=mi>20</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>timeline</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=n>create_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+----------+----------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>07</span><span class=p>:</span><span class=mi>52</span><span class=p>.</span><span class=mi>695513</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>08</span><span class=p>:</span><span class=mi>06</span><span class=p>.</span><span class=mi>031361</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>08</span><span class=p>:</span><span class=mi>14</span><span class=p>.</span><span class=mi>686946</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>46</span><span class=p>.</span><span class=mi>191272</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>5</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>20</span><span class=p>:</span><span class=mi>29</span><span class=p>.</span><span class=mi>690359</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>24</span><span class=p>:</span><span class=mi>08</span><span class=p>.</span><span class=mi>854501</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>6</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>ä½¿ç”¨ base backup å¾©åŸå¾Œèª¿æ•´è¨­å®šæª”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=k>data</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>cp</span><span class=w> </span><span class=o>-</span><span class=n>r</span><span class=w> </span><span class=n>backup</span><span class=o>/</span><span class=n>pg_back_2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=n>_03</span><span class=err>\</span><span class=p>:</span><span class=mi>08</span><span class=err>\</span><span class=p>:</span><span class=mi>41</span><span class=cm>/* postgres/
</span></span></span><span class=line><span class=cl><span class=cm>[postgres@31650d651e1c postgres]$ vim postgresql.conf
</span></span></span><span class=line><span class=cl><span class=cm>recovery_target_time = &#39;2023-04-19 03:20:00&#39;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>[postgres@31650d651e1c postgres]$ touch recovery.signal
</span></span></span></code></pre></td></tr></table></div></div><p>å‚™è¨»ï¼šå¯ä»¥é€é pg_waldump ç¢ºèª wal log ä¾†ç¢ºèªè¦æ¢å¾©åˆ°çš„ä½ç½®ï¼Œä¾‹å¦‚æˆ‘å¸Œæœ›æ¢å¾©åˆ° id = 5 è¢« insert ä¹‹å‰çš„ç‹€æ³ï¼Œé€é waldump ç¢ºèªè©² transaction åœ¨ <code>2023-04-19 03:20:29.690738 UTC</code> commitï¼Œå› æ­¤åªè¦å°‡ recovery_target_time è¨­ç½®çš„æ¯”å…¶å°å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>xlog_archive</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>pg_waldump</span><span class=w> </span><span class=mi>00000001000000000000000</span><span class=n>D</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=n>Standby</span><span class=w>     </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>     </span><span class=mi>50</span><span class=o>/</span><span class=w>    </span><span class=mi>50</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>          </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000028</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>C000358</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=n>RUNNING_XACTS</span><span class=w> </span><span class=n>nextXid</span><span class=w> </span><span class=mi>748</span><span class=w> </span><span class=n>latestCompletedXid</span><span class=w> </span><span class=mi>747</span><span class=w> </span><span class=n>oldestRunningXid</span><span class=w> </span><span class=mi>748</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=n>Standby</span><span class=w>     </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>     </span><span class=mi>50</span><span class=o>/</span><span class=w>    </span><span class=mi>50</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>          </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000060</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000028</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=n>RUNNING_XACTS</span><span class=w> </span><span class=n>nextXid</span><span class=w> </span><span class=mi>748</span><span class=w> </span><span class=n>latestCompletedXid</span><span class=w> </span><span class=mi>747</span><span class=w> </span><span class=n>oldestRunningXid</span><span class=w> </span><span class=mi>748</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=n>XLOG</span><span class=w>        </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>    </span><span class=mi>114</span><span class=o>/</span><span class=w>   </span><span class=mi>114</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>          </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000098</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000060</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=n>CHECKPOINT_ONLINE</span><span class=w> </span><span class=n>redo</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=n>D000060</span><span class=p>;</span><span class=w> </span><span class=n>tli</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=n>tli</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>fpw</span><span class=w> </span><span class=k>true</span><span class=p>;</span><span class=w> </span><span class=n>xid</span><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=mi>748</span><span class=p>;</span><span class=w> </span><span class=n>oid</span><span class=w> </span><span class=mi>24582</span><span class=p>;</span><span class=w> </span><span class=n>multi</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=k>offset</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>oldest</span><span class=w> </span><span class=n>xid</span><span class=w> </span><span class=mi>726</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>DB</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>oldest</span><span class=w> </span><span class=n>multi</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>DB</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>oldest</span><span class=o>/</span><span class=n>newest</span><span class=w> </span><span class=k>commit</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=n>xid</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>oldest</span><span class=w> </span><span class=n>running</span><span class=w> </span><span class=n>xid</span><span class=w> </span><span class=mi>748</span><span class=p>;</span><span class=w> </span><span class=n>online</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=n>Standby</span><span class=w>     </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>     </span><span class=mi>50</span><span class=o>/</span><span class=w>    </span><span class=mi>50</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>          </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000110</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000098</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=n>RUNNING_XACTS</span><span class=w> </span><span class=n>nextXid</span><span class=w> </span><span class=mi>748</span><span class=w> </span><span class=n>latestCompletedXid</span><span class=w> </span><span class=mi>747</span><span class=w> </span><span class=n>oldestRunningXid</span><span class=w> </span><span class=mi>748</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=n>Heap</span><span class=w>        </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>     </span><span class=mi>54</span><span class=o>/</span><span class=w>   </span><span class=mi>298</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>        </span><span class=mi>748</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000148</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000110</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>off</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>flags</span><span class=w> </span><span class=mi>0</span><span class=n>x00</span><span class=p>,</span><span class=w> </span><span class=n>blkref</span><span class=w> </span><span class=o>#</span><span class=mi>0</span><span class=p>:</span><span class=w> </span><span class=n>rel</span><span class=w> </span><span class=mi>1663</span><span class=o>/</span><span class=mi>16384</span><span class=o>/</span><span class=mi>16391</span><span class=w> </span><span class=n>blk</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>FPW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=n>Btree</span><span class=w>       </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>     </span><span class=mi>53</span><span class=o>/</span><span class=w>   </span><span class=mi>193</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>        </span><span class=mi>748</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000278</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000148</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=n>INSERT_LEAF</span><span class=w> </span><span class=k>off</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=n>blkref</span><span class=w> </span><span class=o>#</span><span class=mi>0</span><span class=p>:</span><span class=w> </span><span class=n>rel</span><span class=w> </span><span class=mi>1663</span><span class=o>/</span><span class=mi>16384</span><span class=o>/</span><span class=mi>16394</span><span class=w> </span><span class=n>blk</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>FPW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rmgr</span><span class=p>:</span><span class=w> </span><span class=k>Transaction</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=p>(</span><span class=n>rec</span><span class=o>/</span><span class=n>tot</span><span class=p>):</span><span class=w>     </span><span class=mi>34</span><span class=o>/</span><span class=w>    </span><span class=mi>34</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>:</span><span class=w>        </span><span class=mi>748</span><span class=p>,</span><span class=w> </span><span class=n>lsn</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000340</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>0</span><span class=n>D000278</span><span class=p>,</span><span class=w> </span><span class=k>desc</span><span class=p>:</span><span class=w> </span><span class=k>COMMIT</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>20</span><span class=p>:</span><span class=mi>29</span><span class=p>.</span><span class=mi>690738</span><span class=w> </span><span class=n>UTC</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>å•Ÿå‹• server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>945</span><span class=n>f297dce73</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>pg_ctl</span><span class=w> </span><span class=k>start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>25</span><span class=p>.</span><span class=mi>775</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>starting</span><span class=w> </span><span class=n>point</span><span class=o>-</span><span class=k>in</span><span class=o>-</span><span class=n>time</span><span class=w> </span><span class=n>recovery</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>20</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>25</span><span class=p>.</span><span class=mi>817</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>restored</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=s2>&#34;00000001000000000000000B&#34;</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>archive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>25</span><span class=p>.</span><span class=mi>975</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>redo</span><span class=w> </span><span class=n>starts</span><span class=w> </span><span class=k>at</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=n>B000028</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>25</span><span class=p>.</span><span class=mi>977</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>consistent</span><span class=w> </span><span class=n>recovery</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=n>reached</span><span class=w> </span><span class=k>at</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=n>B000100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>25</span><span class=p>.</span><span class=mi>977</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1827</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=k>database</span><span class=w> </span><span class=k>system</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>accept</span><span class=w> </span><span class=k>read</span><span class=o>-</span><span class=k>only</span><span class=w> </span><span class=n>connections</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>26</span><span class=p>.</span><span class=mi>008</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>restored</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=s2>&#34;00000001000000000000000C&#34;</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>archive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>26</span><span class=p>.</span><span class=mi>198</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>restored</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=s2>&#34;00000001000000000000000D&#34;</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>archive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>26</span><span class=p>.</span><span class=mi>351</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>recovery</span><span class=w> </span><span class=n>stopping</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=k>commit</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>transaction</span><span class=w> </span><span class=mi>748</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>20</span><span class=p>:</span><span class=mi>29</span><span class=p>.</span><span class=mi>690738</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>26</span><span class=p>.</span><span class=mi>351</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>LOG</span><span class=p>:</span><span class=w>  </span><span class=n>pausing</span><span class=w> </span><span class=k>at</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>recovery</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>26</span><span class=p>.</span><span class=mi>351</span><span class=w> </span><span class=n>UTC</span><span class=w> </span><span class=p>[</span><span class=mi>1828</span><span class=p>]</span><span class=w> </span><span class=n>HINT</span><span class=p>:</span><span class=w>  </span><span class=k>Execute</span><span class=w> </span><span class=n>pg_wal_replay_resume</span><span class=p>()</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>promote</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>psql</span><span class=w> </span><span class=n>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Timing</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>on</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>psql</span><span class=w> </span><span class=p>(</span><span class=mi>14</span><span class=p>.</span><span class=mi>7</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Type</span><span class=w> </span><span class=s2>&#34;help&#34;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>help</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=n>test</span><span class=p>]</span><span class=w> </span><span class=p>[</span><span class=k>local</span><span class=p>]:</span><span class=mi>5432</span><span class=p>]</span><span class=w> </span><span class=mi>05</span><span class=p>:</span><span class=mi>13</span><span class=p>:</span><span class=mi>41</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>test</span><span class=o>-#</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>timeline</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=n>create_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----+----------+----------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>07</span><span class=p>:</span><span class=mi>52</span><span class=p>.</span><span class=mi>695513</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>08</span><span class=p>:</span><span class=mi>06</span><span class=p>.</span><span class=mi>031361</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>08</span><span class=p>:</span><span class=mi>14</span><span class=p>.</span><span class=mi>686946</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>46</span><span class=p>.</span><span class=mi>191272</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol></li></ul><h2 id=timeline>timeline</h2><p>æƒ³åƒæ™‚é–“æ—…è¡Œçš„ç§‘å¹»ä½œå“ï¼Œå¦‚æœå¾ç¾åœ¨å›åˆ°éå»ä¸¦æ”¹è®Šéå»ç™¼ç”Ÿçš„äº‹ä»¶æœƒå°è‡´æœªä¾†ç™¼ç”Ÿæ”¹è®Šï¼Œä¹Ÿå°±æ˜¯å‡ºç¾äº†ä¸åŒçš„æ™‚é–“ç·šã€‚</p><p>åœ¨ PG ä¸­ä¹Ÿæœ‰é¡ä¼¼çš„ç‹€æ³ï¼Œå‡è¨­åœ¨ 12:00 èª¤åˆªé™¤äº†è³‡æ–™è¡¨ï¼Œä¸¦åœ¨ 13:00 å°‡ PG æ¢å¾©åˆ° 11:00 çš„æ™‚é–“é»ä¸¦æ­£å¸¸å•Ÿå‹•å’Œé‹ä½œï¼Œæ­¤æ™‚æœƒå‡ºç¾ 2 å€‹æ™‚é–“ç·šï¼š</p><ol><li>éå» 11:00~13:00 ç”¢ç”Ÿçš„ WAL</li><li>æ¢å¾©å¾Œå¾ 13:00 é–‹å§‹ç”¢ç”Ÿçš„ WAL</li></ol><p>å¦‚æœæ²’æœ‰ timeline çš„è¨­è¨ˆï¼Œæ¢å¾©å¾Œç”¢ç”Ÿçš„ WAL è¦†è“‹äº†éå»ç”¢ç”Ÿçš„ WALï¼Œæ­¤æ™‚å¦‚æœç™¼ç¾æ±ºç­–éŒ¯èª¤å¸Œæœ›å›åˆ°éå»çš„ 12:00 æ•¸æ“šåº«ç‹€æ…‹å°‡ç„¡æ³•åšåˆ°ã€‚</p><p>å› æ­¤ PG æœ‰äº† timeline çš„è¨­è¨ˆï¼Œé€éä¿å­˜ä¸åŒ timeline çš„ WAL ä¾†è®“ä½¿ç”¨è€…èƒ½å¤ è‡ªç”±çš„æ¢å¾©åˆ°ä¸åŒçš„æ™‚é–“ç·šã€‚</p><h3 id=æ–°çš„-timeline-ç”¢ç”Ÿæ™‚æ©Ÿ>æ–°çš„ timeline ç”¢ç”Ÿæ™‚æ©Ÿ</h3><ol><li><p>PITRï¼šè¨­ç½® recovery_target ç›¸é—œåƒæ•¸é€²è¡Œæ¢å¾©å¾Œæœƒå‡ºç¾æ–°çš„ timelineã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ll</span><span class=w> </span><span class=n>pg_wal</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>total</span><span class=w> </span><span class=mi>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>drwx</span><span class=c1>------. 2 postgres postgres       80 Apr 19 03:27 archive_status
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>é…ç½®</span><span class=w> </span><span class=n>recovery_target</span><span class=w> </span><span class=err>åƒæ•¸ä¸¦é€²è¡Œ</span><span class=w> </span><span class=n>PITR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>vim</span><span class=w> </span><span class=n>postgresql</span><span class=p>.</span><span class=n>conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>recovery_target_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2023-04-19 03:15:46&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>recovery_target_action</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;promote&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>touch</span><span class=w> </span><span class=n>recovery</span><span class=p>.</span><span class=n>singal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>pg_ctl</span><span class=w> </span><span class=o>-</span><span class=n>l</span><span class=w> </span><span class=n>logfile</span><span class=w> </span><span class=k>restart</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>shut</span><span class=w> </span><span class=n>down</span><span class=p>....</span><span class=w> </span><span class=n>done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>server</span><span class=w> </span><span class=n>stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>start</span><span class=p>....</span><span class=w> </span><span class=n>done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>server</span><span class=w> </span><span class=n>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>total</span><span class=w> </span><span class=mi>49156</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:30 00000001000000000000000C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:30 00000002000000000000000C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:27 00000002000000000000000D
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres       50 Apr 19 03:30 00000002.history
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>drwx</span><span class=c1>------. 2 postgres postgres       73 Apr 19 03:30 archive_status
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=mi>00000002</span><span class=p>.</span><span class=n>history</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w>       </span><span class=mi>0</span><span class=o>/</span><span class=n>C0002F8</span><span class=w>       </span><span class=k>before</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>46</span><span class=p>.</span><span class=mi>192096</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>standby promoteï¼šç•¶ standby è¢« promote æˆ primary æ™‚æœƒå‡ºç¾æ–°çš„ timelineã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>total</span><span class=w> </span><span class=mi>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 02:00 000000010000000000000006
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 02:00 000000010000000000000007
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>drwx</span><span class=c1>------. 2 postgres postgres        6 Apr 19 02:00 archive_status
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>pg_ctl</span><span class=w> </span><span class=n>promote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>promote</span><span class=p>....</span><span class=w> </span><span class=n>done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>server</span><span class=w> </span><span class=n>promoted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>total</span><span class=w> </span><span class=mi>49160</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 02:03 000000010000000000000006.partial
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 02:03 000000020000000000000006
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 02:00 000000020000000000000007
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres       41 Apr 19 02:03 00000002.history
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>drwx</span><span class=c1>------. 2 postgres postgres       80 Apr 19 02:03 archive_status
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=mi>00000002</span><span class=p>.</span><span class=n>history</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w>	  </span><span class=mi>0</span><span class=o>/</span><span class=n>A000198</span><span class=w>	  </span><span class=k>no</span><span class=w> </span><span class=n>recovery</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=n>specified</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=timeline-å¯¦é«”æª”æ¡ˆ>timeline å¯¦é«”æª”æ¡ˆ</h3><p>å¾ä¸Šä¸€ç¯€ä¸­å¯ä»¥çœ‹åˆ°ç”¢ç”Ÿæ–°çš„ timeline æ™‚æœƒå‡ºç¾å¾Œç¶´ç›¸åŒçš„ wal åŠ history æª”æ¡ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ll</span><span class=w> </span><span class=n>pg_wal</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>total</span><span class=w> </span><span class=mi>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>drwx</span><span class=c1>------. 2 postgres postgres       80 Apr 19 03:27 archive_status
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>é…ç½®</span><span class=w> </span><span class=n>recovery_target</span><span class=w> </span><span class=err>åƒæ•¸ä¸¦é€²è¡Œ</span><span class=w> </span><span class=n>PITR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>vim</span><span class=w> </span><span class=n>postgresql</span><span class=p>.</span><span class=n>conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>recovery_target_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2023-04-19 03:15:46&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>recovery_target_action</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;promote&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>touch</span><span class=w> </span><span class=n>recovery</span><span class=p>.</span><span class=n>singal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>postgres</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>pg_ctl</span><span class=w> </span><span class=o>-</span><span class=n>l</span><span class=w> </span><span class=n>logfile</span><span class=w> </span><span class=k>restart</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>shut</span><span class=w> </span><span class=n>down</span><span class=p>....</span><span class=w> </span><span class=n>done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>server</span><span class=w> </span><span class=n>stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>start</span><span class=p>....</span><span class=w> </span><span class=n>done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>server</span><span class=w> </span><span class=n>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>total</span><span class=w> </span><span class=mi>49156</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:30 00000001000000000000000C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:30 00000002000000000000000C
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres 16777216 Apr 19 03:27 00000002000000000000000D
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=n>rw</span><span class=c1>-------. 1 postgres postgres       50 Apr 19 03:30 00000002.history
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>drwx</span><span class=c1>------. 2 postgres postgres       73 Apr 19 03:30 archive_status
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=mi>00000002</span><span class=p>.</span><span class=n>history</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w>       </span><span class=mi>0</span><span class=o>/</span><span class=n>C0002F8</span><span class=w>       </span><span class=k>before</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>46</span><span class=p>.</span><span class=mi>192096</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥è§€å¯Ÿåˆ°æœ‰ä¸€å€‹ <code>00000002.history</code> çš„ timeline ç›¸é—œæª”æ¡ˆï¼Œé€™å€‹ä»¶ç´€éŒ„äº†é€™å€‹ timeline å¾å“ªæ¢ timeline åˆ†æ”¯å‡ºä¾†åŠä»€éº¼æ™‚å€™ï¼Œé€™åŒ…å«äº†ä»¥ä¸‹ 3 å€‹å­—æ®µï¼š</p><ul><li>parentTLIï¼šparent timeline çš„ IDã€‚</li><li>LSNï¼šç™¼ç”Ÿ timline åˆ‡æ›çš„ WAL ä½ç½®ã€‚</li><li>reasonï¼štimeline ç”¢ç”Ÿçš„åŸå› ã€‚</li></ul><p>ä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>[</span><span class=n>postgres</span><span class=o>@</span><span class=mi>31650</span><span class=n>d651e1c</span><span class=w> </span><span class=n>pg_wal</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>cat</span><span class=w> </span><span class=mi>00000002</span><span class=p>.</span><span class=n>history</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w>	  </span><span class=mi>0</span><span class=o>/</span><span class=n>A000198</span><span class=w>	</span><span class=k>before</span><span class=w> </span><span class=mi>2023</span><span class=o>-</span><span class=mi>4</span><span class=o>-</span><span class=mi>19</span><span class=w> </span><span class=mi>12</span><span class=p>:</span><span class=mi>05</span><span class=p>:</span><span class=mi>00</span><span class=p>.</span><span class=mi>861324</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä»¥ä¸Šè¡¨ç¤ºäº† timeline 2 æ˜¯åŸºæ–¼ timeline 1 çš„ basebackup é€é WAL æ¢å¾©åˆ° 0/A000198 å°æ‡‰ <code>2023-4-19 12:05:00.861324+00</code> ä¹‹å‰çš„ä½ç½®ã€‚</p><p>å¦å¤–é‚„å¯ä»¥æ³¨æ„åˆ°å‡ºç¾æ–°çš„ timeline çš„æ™‚å€™ WAL æª”åä¹Ÿæœ‰äº†è®ŠåŒ–ï¼š<code>00000001000000000000000C</code> â†’ <code>00000002000000000000000C</code>ï¼Œå¯ä»¥è§€å¯Ÿåˆ°å‰ 8 ç¢¼ç”± <code>00000001</code> è®Šæˆ <code>00000002</code>ï¼Œäº‹å¯¦ä¸Š WAL æª”åçš„å‰ 8 ç¢¼å°±æ˜¯ç”¨ä¾†æ¨™ç¤ºå…¶æ‰€å±¬çš„ timeline idã€‚</p><h1 id=åƒè€ƒ>åƒè€ƒ</h1><p><a class=link href=https://www.postgresql.org/docs/current/backup.html target=_blank rel=noopener>PostgreSQL: Documentation: 15: ChapterÂ 26.Â Backup and Restore</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/410766742 target=_blank rel=noopener>PostgreSQLå¤‡ä»½æ¢å¤å®ç° - çŸ¥ä¹ (zhihu.com)</a></p><p><a class=link href=https://www.cnblogs.com/cqdba/p/15920508.html target=_blank rel=noopener>1.pg_basebackup ä»‹ç»åŠä½¿ç”¨ - www.cqdba.cn - åšå®¢å›­ (cnblogs.com)</a></p><p><a class=link href=https://www.twblogs.net/a/5c9e6330bd9eee73ef4b6004 target=_blank rel=noopener>PostgreSQL å¾å…¥é–€åˆ°å‡ºé–€ ç¬¬ 8 ç¯‡ å‚™ä»½èˆ‡æ¢å¾© - å°éƒ¨è½ (twblogs.net)</a></p><p><a class=link href=https://blog.csdn.net/weixin_39540651/article/details/111239341 target=_blank rel=noopener>PostgreSQLæ—¶é—´çº¿(timeline)å’ŒHistory File_pg history_foucusã€çš„åšå®¢-CSDNåšå®¢</a></p><p><a class=link href=https://www.interdb.jp/pg/pgsql10.html#_10.3.1. target=_blank rel=noopener>The Internals of PostgreSQL : Chapter 10 Base Backup & Point-in-Time Recovery (interdb.jp)</a></p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸é—œæ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/postgre-vacuum/><div class=article-details><h2 class=article-title>PostgreSQL vacuum</h2></div></a></article><article><a href=/p/postgre-replication/><div class=article-details><h2 class=article-title>PostgreSQL Replication</h2></div></a></article><article><a href=/p/postgre-file-storage/><div class=article-details><h2 class=article-title>PostgreSQL å¯¦é«”æª”æ¡ˆå„²å­˜</h2></div></a></article><article><a href=/p/postgre-schema/><div class=article-details><h2 class=article-title>PostgreSQL schema</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//å°å° DBA å€‹äººç­†è¨˜.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>