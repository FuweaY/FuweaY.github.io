<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ä»‹ç´¹ ClickHouse çš„ç´¢å¼•çµæ§‹"><title>ClickHouse ç´¢å¼•</title>
<link rel=canonical href=https://FuweaY.github.io/p/clickhouse-index/><link rel=stylesheet href=/scss/style.min.f28263e5961b456312e0eedc7ff92ffd1c19229bede3556136a281ca9ab8bf59.css><meta property='og:title' content="ClickHouse ç´¢å¼•"><meta property='og:description' content="ä»‹ç´¹ ClickHouse çš„ç´¢å¼•çµæ§‹"><meta property='og:url' content='https://FuweaY.github.io/p/clickhouse-index/'><meta property='og:site_name' content='FuweaY'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-10-12T12:00:00+08:00'><meta property='article:modified_time' content='2024-10-12T12:00:00+08:00'><meta name=twitter:title content="ClickHouse ç´¢å¼•"><meta name=twitter:description content="ä»‹ç´¹ ClickHouse çš„ç´¢å¼•çµæ§‹"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_da86993f15b2a166.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ±</span></figure><div class=site-meta><h1 class=site-name><a href=/>FuweaY</a></h1><h2 class=site-description>ç†±æ„›åˆ†äº«çš„ DBA å°å¤©åœ°</h2></div></header><ol class=menu-social><li><a href=https://github.com/FuweaY target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#sparse-primary-indexes>Sparse Primary Indexes</a><ol><li><a href=#èªªæ˜>èªªæ˜</a></li><li><a href=#äº‹ä¾‹>äº‹ä¾‹</a><ol><li><a href=#schema>schema</a></li><li><a href=#æŸ¥è©¢>æŸ¥è©¢</a></li></ol></li><li><a href=#éæœ€å·¦å‰ç¶´æ¬„ä½çš„æŸ¥è©¢>éæœ€å·¦å‰ç¶´æ¬„ä½çš„æŸ¥è©¢</a></li><li><a href=#generic-exclusion-search-algorithm><strong>Generic exclusion search algorithm</strong></a></li><li><a href=#ä½¿ç”¨å¤šå€‹-primary-index-é€²è¡Œå„ªåŒ–>ä½¿ç”¨å¤šå€‹ primary index é€²è¡Œå„ªåŒ–</a></li></ol></li><li><a href=#skipping-indexes>Skipping Indexes</a><ol><li><a href=#skipping-index-type>Skipping index Type</a></li><li><a href=#skipping-index-æ”¯æŒçš„-function>Skipping index æ”¯æŒçš„ function</a></li><li><a href=#skipping-index-çš„é…ç½®>Skipping index çš„é…ç½®</a></li><li><a href=#æœ€ä½³å¯¦è¸>æœ€ä½³å¯¦è¸</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/clickhouse/>ClickHouse</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/clickhouse-index/>ClickHouse ç´¢å¼•</a></h2><h3 class=article-subtitle>ä»‹ç´¹ ClickHouse çš„ç´¢å¼•çµæ§‹</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 12, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 8 åˆ†é˜</time></div></footer></div></header><section class=article-content><h2 id=sparse-primary-indexes>Sparse Primary Indexes</h2><h3 id=èªªæ˜>èªªæ˜</h3><p>å‚³çµ±çš„ RDBMS è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•¸æ“šéƒ½æœ‰ä¸€å€‹ primary key ä¸¦ä¸”å„²å­˜ç‚º B+ Tree çš„è³‡æ–™çµæ§‹ï¼Œé€™æ¨£çš„è¨­è¨ˆä¸‹å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°ç‰¹å®š row çš„è³‡æ–™ï¼Œä½†ç›¸æ‡‰çš„éœ€è¦é¡å¤–çš„ diskã€memory é–‹éŠ·ã€‚</p><p>ClickHouse çš„ <code>MergeTree</code> å¼•æ“ç”¨ä¾†å„ªåŒ–è™•ç†å¤§é‡æ•¸æ“šï¼Œä¸¦ä¸”æ•¸æ“šæ˜¯è¢«ä¸€æ‰¹ä¸€æ‰¹çš„å¯«å…¥è¡¨ä¸­ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ diskã€memory æ•ˆç‡å¾ˆé‡è¦ï¼Œå› æ­¤ä¸æ˜¯ç‚ºæ¯ä¸€è¡Œæ•¸æ“šå»ºç«‹ primary keyï¼Œè€Œæ˜¯è¦ç‚ºä¸€çµ„æ•¸æ“š (ç¨±ç‚º <code>granule</code>) å»ºç«‹ä¸€å€‹ index entry (ç¨±ç‚º <code>mark</code>)ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ ClickHouse ä¸­ primary index æ˜¯å°æ‡‰å¤šç­†è³‡æ–™è€Œä¸æ˜¯å”¯ä¸€çš„è³‡æ–™ã€‚</p><p>sparse primery index ä¸åƒåŸºæ–¼ B+ Tree çš„ç´¢å¼•å¯ä»¥ç›´æ¥å®šä½åˆ°ç‰¹å®šè¡Œï¼Œè€Œæ˜¯å¯ä»¥é€é binary search çš„æ–¹å¼å¿«é€Ÿæ‰¾åˆ°å¯èƒ½åŒ¹é…æŸ¥è©¢çš„ granule ä¸¦å‚³è¼¸åˆ° ClickHouse engine ä¾†æ‰¾åˆ°åŒ¹é…çš„çµæœã€‚</p><p>é€™ç¨® sparse primery index çš„è¨­è¨ˆï¼Œè®“ primary index è¶³å¤ å°å¯ä»¥æ”¾åˆ° memory ä¸­ï¼Œä¸¦ä¸”å°æ–¼ OLAP çš„ç¯„åœæŸ¥è©¢èƒ½æœ‰æ•ˆåŠ å¿«ã€‚</p><h3 id=äº‹ä¾‹>äº‹ä¾‹</h3><h4 id=schema>schema</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>UserID</span><span class=o>`</span><span class=w> </span><span class=n>UInt32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>URL</span><span class=o>`</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>EventTime</span><span class=o>`</span><span class=w> </span><span class=n>DateTime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ENGINE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MergeTree</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=n>URL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=n>EventTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SETTINGS</span><span class=w> </span><span class=n>index_granularity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8192</span><span class=p>,</span><span class=w> </span><span class=n>index_granularity_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>schema èªªæ˜ï¼š</p><ul><li>ORDER BY æ˜¯æ’åºéµ(sorting key)ï¼Œæ±ºå®š .bin ä¸­çš„æ–‡ä»¶å¦‚ä½•æ’åº</li><li>PRIMARY KEY ç‚ºé¸å¡«çš„è¨­å®šï¼Œç”¨ä¾†ç”Ÿæˆ primary.idx çš„æª”æ¡ˆï¼Œå¿…é ˆæ˜¯ ORDER BY çš„å‰ç¶´ï¼Œå¦‚æœæ²’æœ‰è¨­å®šæœƒå°‡ PRIMARY KEY å®šç¾©ç‚ºæ’åºéµã€‚</li><li>é»˜èªæƒ…æ³ä¸‹ sorting key å’Œ primary key ç›¸åŒï¼Œä»¥ sorting key ç‚ºä¸»ï¼Œå› æ­¤å¤§å¤šæƒ…æ³ä¸‹ä¸éœ€è¦æŒ‡å®š primary keyï¼Œé€šå¸¸åªæœ‰ SummingMergeTree å’Œ AggregatingMergeTree å¼•æ“æ™‚</li><li>é¡¯å¼çš„è¨­ç½® PRIMARY KEY å’Œ ORDER BY ä¸åŒæ˜¯ç‚ºäº†é€²ä¸€æ­¥å„ªåŒ–ï¼Œä¾‹å¦‚ï¼šé‡å° WHERE A GROUP BY A, B, C çš„æŸ¥è©¢ä¸‹ï¼Œå¯ä»¥å»ºç«‹ä¸€å€‹è¡¨ PRIMARY KEY A ORDER BY A, B , Cã€‚</li><li>index_granularity é»˜èªå€¼ç‚º 8192ï¼Œæ„æ€æ˜¯æ¯ 8192 è¡Œè³‡æ–™ç‚ºä¸€çµ„æœƒæœ‰ä¸€å€‹ primary index entry</li><li>index_granularity_bytesï¼š0 è¡¨ç¤ºç¦æ­¢ adaptive index granularityï¼Œå¦‚æœé–‹å•Ÿæ­¤è¨­å®šç•¶ç¬¦åˆä»¥ä¸‹æ¢ä»¶æ™‚æœƒè‡ªå‹•æœ€ä¸€çµ„ n è¡Œè³‡æ–™å‰µå»ºä¸€å€‹ primary index entryã€‚<ul><li>n &lt; 8192 (index_granularity)ï¼Œä½† n è¡Œæ•¸æ“šå¤§å° &lt;= index_granularity_bytes(é è¨­å€¼ç‚º 10 MB)</li><li>n é”åˆ° 8192 (index_granularity)</li></ul></li></ul><p>æ’å…¥çš„è¡ŒæœƒæŒ‰ç…§ PRIMARY KEY æŒ‰é †åº (ascending å‡åº) å„²å­˜åœ¨ disk ä¸Šï¼ŒåŒæ™‚ ClickHouse å…è¨±æ’å…¥å…·æœ‰ç›¸åŒ PK çš„å¤šç­†è³‡æ–™ï¼Œç•¶ PK ç›¸åŒæ™‚å‰‡æœƒä¾ç…§æ’åºéµä¸­çš„ EventTime æ’åºï¼š</p><p><img src=/p/clickhouse-index/Untitled.png width=889 height=468 srcset="/p/clickhouse-index/Untitled_hu_8655788d9641e049.png 480w, /p/clickhouse-index/Untitled_hu_fba2ad3e6111a3a2.png 1024w" loading=lazy class=gallery-image data-flex-grow=189 data-flex-basis=455px></p><p>ClickHouse å°‡è¡¨ä¸­çš„è³‡æ–™åŠƒåˆ†ç‚ºå¤šå€‹ <code>granule</code>ï¼Œ<code>granule</code> æ˜¯ ClickHouse é€²è¡Œæ•¸æ“šè™•ç†çš„æœ€å°å–®ä½ï¼Œä¹Ÿå°±æ˜¯èªª ClickHouse ä¸æ˜¯è®€å–å–®ç¨è¡Œï¼Œè€Œæ˜¯ç¸½æ˜¯è®€å–æ•´å€‹ <code>granule</code> ã€‚æ­¤ä¾‹ä¸­ index_granularity = 8192ï¼Œå› æ­¤æ¯ 8192 è¡Œç‚ºä¸€å€‹ <code>granule</code>ï¼š</p><p><img src=/p/clickhouse-index/Untitled1.png width=921 height=370 srcset="/p/clickhouse-index/Untitled1_hu_1235ce1b8ff93269.png 480w, /p/clickhouse-index/Untitled1_hu_3ce7f26770fd70fe.png 1024w" loading=lazy class=gallery-image data-flex-grow=248 data-flex-basis=597px></p><p>å¦å¤–å¯ä»¥çœ‹åˆ°ä¸Šåœ–ä¸­æœ‰æ©˜è‰²çš„å­—ï¼Œé€™äº›è¡¨ç¤ºè©² column åœ¨è©² granule ä¸­çš„æœ€å°å€¼ï¼Œä¸éæœ€å¾Œä¸€å€‹ granule ä¸­å‰‡æ˜¯æœƒæœ€å¤§å€¼ï¼š</p><ul><li>ç¬¬ä¸€å€‹ index entry (ä¸‹åœ–ä¸­çš„ <code>mark 0</code>) å„²å­˜ <code>granule 0</code> ä¸­çš„æœ€å°å€¼</li><li>ç¬¬äºŒå€‹ index entry (ä¸‹åœ–ä¸­çš„ <code>mark 1</code>) å„²å­˜ <code>granule 1</code> ä¸­çš„æœ€å°å€¼</li><li>ä»¥æ­¤é¡æ¨â€¦â€¦</li><li>æœ€å¾Œä¸€å€‹ index entry (ä¸‹åœ–ä¸­çš„ <code>mark 1082</code>) å„²å­˜ <code>granule 1082</code> ä¸­çš„æœ€å¤§å€¼</li></ul><p>é€™äº›æ¯å€‹ column åœ¨æ¯å€‹ granule ä¸­çš„æœ€å°å€¼(æœ€å¾Œä¸€å€‹ç‚ºæœ€å¤§å€¼) æœƒè¢«å¯«å…¥åˆ° <code>primary.idx</code> æª”æ¡ˆä¸­ï¼š</p><p><img src=/p/clickhouse-index/Untitled2.png width=919 height=389 srcset="/p/clickhouse-index/Untitled2_hu_77ffc098931d82fd.png 480w, /p/clickhouse-index/Untitled2_hu_5eeed99d78597e1e.png 1024w" loading=lazy class=gallery-image data-flex-grow=236 data-flex-basis=566px></p><p>æ³¨æ„å› ç‚ºæ˜¯å°‡æ¯å€‹ column åœ¨æ¯å€‹ granule ä¸­çš„æ¥µå€¼æŒ‘å‡ºä¾†ï¼Œæ‰€ä»¥ä¸Šä¾‹ä¸­çš„ mark 0 çš„ UserIDã€URL çš„å€¼æ˜¯ä¾†è‡ªåŒä¸€å€‹ granule ä¸­çš„ä¸åŒè¡Œã€‚</p><blockquote><p>ğŸ’¡ primary.idx æ­¤æ–‡ä»¶æœƒè¢«å®Œå…¨è¢« loading åˆ°å…§å­˜ä¸­ï¼Œå¦‚æœæ–‡ä»¶å¤§æ–¼å¯ç”¨çš„å…§å­˜ç©ºé–“ï¼Œå‰‡ ClickHouse å°‡å¼•ç™¼éŒ¯èª¤ã€‚</p></blockquote><h4 id=æŸ¥è©¢>æŸ¥è©¢</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>Count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>UserID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>749927693</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>Count</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=p>.</span><span class=w> </span><span class=n>Elapsed</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>005</span><span class=w> </span><span class=n>sec</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Processed</span><span class=w> </span><span class=mi>8</span><span class=p>.</span><span class=mi>19</span><span class=w> </span><span class=n>thousand</span><span class=w> </span><span class=k>rows</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>740</span><span class=p>.</span><span class=mi>18</span><span class=w> </span><span class=n>KB</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>.</span><span class=mi>53</span><span class=w> </span><span class=n>million</span><span class=w> </span><span class=k>rows</span><span class=o>/</span><span class=n>s</span><span class=p>.,</span><span class=w> </span><span class=mi>138</span><span class=p>.</span><span class=mi>59</span><span class=w> </span><span class=n>MB</span><span class=o>/</span><span class=n>s</span><span class=p>.)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šä¾‹æŸ¥è©¢ä¸­æˆ‘å€‘éœ€è¦æ‰¾åˆ° <code>UserID = 749927693</code> çš„è³‡æ–™ï¼Œé¦–å…ˆæˆ‘å€‘é€é primary.idx æ‰¾åˆ° <code>UserID = 749927693</code> çš„å€¼ä»‹æ–¼ index mark 176 çš„ 747148242 ä¹‹å¾Œ mark 177 çš„ 751802947 ä¹‹å‰ï¼Œå› æ­¤åªéœ€è¦å–å‡º mark 176 å°æ‡‰çš„ granuleï¼š</p><p><img src=/p/clickhouse-index/Untitled3.png width=919 height=453 srcset="/p/clickhouse-index/Untitled3_hu_f70ca174c1def51c.png 480w, /p/clickhouse-index/Untitled3_hu_cfc4a17d75265bc3.png 1024w" loading=lazy class=gallery-image data-flex-grow=202 data-flex-basis=486px></p><p>æ¥è‘—éœ€è¦ mark 176 ä¸­å°æ‡‰çš„ granule ä¸­çš„ 8192 è¡Œè³‡æ–™è®€å–åˆ° ClickHouseï¼Œå› æ­¤éœ€è¦çŸ¥é“ granule 176 ç‰©ç†ä½ç½®ï¼Œæ¯å€‹ granule çš„ç‰©ç†ä½ç½®è¢«å„²å­˜åœ¨ <code>æ¬„ä½.mrk</code> çš„æ–‡ä»¶ä¸­ï¼š</p><p><img src=/p/clickhouse-index/Untitled4.png width=917 height=444 srcset="/p/clickhouse-index/Untitled4_hu_9c83286e0cc94a80.png 480w, /p/clickhouse-index/Untitled4_hu_84a77278a6149a00.png 1024w" loading=lazy class=gallery-image data-flex-grow=206 data-flex-basis=495px></p><p>å¦‚ä¸Šåœ–æ‰€ç¤º <code>æ¬„ä½.mrk</code> æ–‡ä»¶ä¸­æœƒè¨˜éŒ„æ¯å€‹ granule æ‰€åœ¨çš„ç‰©ç†ä½ç½®ï¼Œä¹Ÿå°±æ˜¯åœ¨ <code>æ¬„ä½.bin</code> æ•¸æ“šæ–‡ä»¶ä¸­çš„ä½ç½®ï¼Œå…¶ä¸­æœ‰ 2 å€‹å…§å®¹ï¼š</p><ul><li><p>block_offsetï¼šè¨˜éŒ„äº†æ‰€é¸ granule å£“ç¸®ç‰ˆæœ¬æ‰€åœ¨çš„å£“ç¸®æ•¸æ“šå¡Šã€‚</p><p>æ¯å€‹å£“ç¸®å¡Šå¯èƒ½åŒ…å«å¤šå€‹ granule (å£“ç¸®éçš„)ï¼Œè©²å£“ç¸®æ•¸æ“šå¡Šåœ¨è®€å–æ™‚è¢«è§£å£“ç¸®åˆ°å…§å­˜ä¸­ã€‚</p></li><li><p>granule_offsetï¼šè¨˜éŒ„äº† granule åœ¨è§£å£“ç¸®å¾Œæ•¸æ“šå¡Šçš„ä½ç½®ã€‚</p></li></ul><p><img src=/p/clickhouse-index/Untitled5.png width=925 height=472 srcset="/p/clickhouse-index/Untitled5_hu_d3b2c3ed8026358a.png 480w, /p/clickhouse-index/Untitled5_hu_800d2f9f6481aeaf.png 1024w" loading=lazy class=gallery-image data-flex-grow=195 data-flex-basis=470px></p><p>ä¸Šåœ–é¡¯ç¤ºäº† ClickHouse é€é UserID.mrk å®šä½åˆ° UserID.bin æ•¸æ“šæ–‡ä»¶ä¸­åŒ…å«ç¬¦åˆæŸ¥è©¢æ¢ä»¶ granule çš„éç¨‹ï¼ŒåŒæ™‚ ClickHouse ä¹Ÿæœƒå° URL æ¬„ä½åŸ·è¡Œç›¸åŒçš„å‹•ä½œï¼Œéš¨å¾Œé€™ 2 å€‹ä¸åŒçš„ granule æœƒè¢«å°é½Šå€åŠ è¼‰åˆ° ClickHouse å¼•æ“é€²è¡Œé€²ä¸€æ­¥è™•ç†ï¼Œä¹Ÿå°±æ˜¯ Aggrigation æ“ä½œã€‚</p><h3 id=éæœ€å·¦å‰ç¶´æ¬„ä½çš„æŸ¥è©¢>éæœ€å·¦å‰ç¶´æ¬„ä½çš„æŸ¥è©¢</h3><p>ä¸Šé¢æˆ‘å€‘çœ‹åˆ°æ˜¯ç”¨è¤‡åˆä¸»éµçš„ç¬¬ä¸€å€‹æ¬„ä½ UserID é€²è¡Œéæ¿¾ï¼Œä½†æ˜¯å°±åƒ MySQL ç´¢å¼•æœ‰æœ€å·¦å‰ç¶´åŸå‰‡ä¸€æ¨£ï¼ŒPK(UserID, URL) å¯ä»¥æ˜é¡¯åŠ å¿«ä»¥ UserID ç‚ºæ¢ä»¶çš„éæ¿¾ï¼Œä½†æ˜¯å–®ç´”ä»¥ URL ç‚ºæ¢ä»¶çš„æŸ¥è©¢å»ä¸¦æ²’æœ‰ä»€éº¼å¹«åŠ©ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯å…ˆ UserID æ’åºå†ä»¥ URL æ’åºï¼Œä¹Ÿå°±æ˜¯èªªé›–ç„¶ UserID æ˜¯æ‰€æœ‰ granule ä»¥å°æ’åˆ°å¤§ï¼Œä½†æ˜¯ URL å»åªæœ‰åœ¨å…¶ granule å…§ä¸­æ’åºã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>UserID</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>Count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;http://public_search&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>UserID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>Count</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>10</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=p>.</span><span class=w> </span><span class=n>Elapsed</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>086</span><span class=w> </span><span class=n>sec</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Processed</span><span class=w> </span><span class=mi>8</span><span class=p>.</span><span class=mi>81</span><span class=w> </span><span class=n>million</span><span class=w> </span><span class=k>rows</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>799</span><span class=p>.</span><span class=mi>69</span><span class=w> </span><span class=n>MB</span><span class=w> </span><span class=p>(</span><span class=mi>102</span><span class=p>.</span><span class=mi>11</span><span class=w> </span><span class=n>million</span><span class=w> </span><span class=k>rows</span><span class=o>/</span><span class=n>s</span><span class=p>.,</span><span class=w> </span><span class=mi>9</span><span class=p>.</span><span class=mi>27</span><span class=w> </span><span class=n>GB</span><span class=o>/</span><span class=n>s</span><span class=p>.)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- trace log
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span><span class=n>Executor</span><span class=p>):</span><span class=w> </span><span class=k>Key</span><span class=w> </span><span class=n>condition</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=k>column</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;http://public_search&#39;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                           </span><span class=s1>&#39;http://public_search&#39;</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=n>Executor</span><span class=p>):</span><span class=w> </span><span class=n>Used</span><span class=w> </span><span class=n>generic</span><span class=w> </span><span class=n>exclusion</span><span class=w> </span><span class=k>search</span><span class=w> </span><span class=n>over</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>part</span><span class=w> </span><span class=n>all_1_9_2</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=k>with</span><span class=w> </span><span class=mi>1537</span><span class=w> </span><span class=n>steps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=n>Executor</span><span class=p>):</span><span class=w> </span><span class=n>Selected</span><span class=w> </span><span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=w> </span><span class=n>parts</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>partition</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>parts</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=mi>1076</span><span class=o>/</span><span class=mi>1083</span><span class=w> </span><span class=n>marks</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w> </span><span class=mi>1076</span><span class=w> </span><span class=n>marks</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>read</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>ranges</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=n>Executor</span><span class=p>):</span><span class=w> </span><span class=n>Reading</span><span class=w> </span><span class=n>approx</span><span class=p>.</span><span class=w> </span><span class=mi>8814592</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=n>streams</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚ä¸Šæ‰€ç¤ºå¯ä»¥çœ‹åˆ°è©²æŸ¥è©¢åŸ·è¡Œæ™‚ 1083 å€‹ granule å…¶ä¸­æœ‰ 1076 å€‹ granule è¢«é¸ä¸­</p><h3 id=generic-exclusion-search-algorithm><strong>Generic exclusion search algorithm</strong></h3><p>ç•¶æŸ¥è©¢è¤‡åˆä¸»éµçš„ä¸€éƒ¨åˆ†çš„ column (ä½†ä¸æ˜¯ç¬¬ä¸€å€‹ column)ï¼ŒClickHouse æœƒä½¿ç”¨ <strong>G</strong>eneric exclusion search æ¼”ç®—æ³•è€Œä¸æ˜¯ç”¨ binary search æ¼”ç®—æ³•ï¼Œä½†æ˜¯æ­¤ç®—æ³•åƒ…åœ¨å‰ç¶´ç´¢å¼• cardinality è¼ƒä½æ™‚æ‰è¼ƒæœ‰æ•ˆæœï¼Œè®“æˆ‘å€‘ä¾†çœ‹çœ‹ä¸åŒ cardiality çš„å‰ç¶´ç´¢å¼•çš„æƒ…å¢ƒï¼š</p><ul><li><p>å‰ç¶´ä¸»éµä½ cardinality</p><p>å‡è¨­ UserID çš„ cardinality è¼ƒä½æ™‚ï¼Œç›¸åŒçš„ UserID å€¼å¯èƒ½åˆ†å¸ƒåœ¨å¤šå€‹ granule ä¸­ï¼Œç›¸æ‡‰çš„ primary.idx å…§å¤šå€‹ index mark æœƒæœ‰å¤šå€‹ç›¸åŒçš„ UserID å€¼ï¼Œé€™åŒæ™‚ä¹Ÿæ„å‘³è‘—é€™äº› index mark ä¸­çš„ URL ä¹ŸæœƒæŒ‰é †åºæ’åºï¼š</p><p><img src=/p/clickhouse-index/Untitled6.png width=885 height=405 srcset="/p/clickhouse-index/Untitled6_hu_d2298aabc29471fb.png 480w, /p/clickhouse-index/Untitled6_hu_6f4d74a87778ad30.png 1024w" loading=lazy class=gallery-image data-flex-grow=218 data-flex-basis=524px></p><ul><li>mark 0 çš„ URL æœ€å°å€¼ç‚º W1 å°æ–¼ç›®æ¨™ W3ï¼Œæ¥è‘— mark 1ã€2 çš„ UserID éƒ½å’Œ mark 0 ä¸€æ¨£æ˜¯ U1ï¼Œä¸” mark 1 çš„ URL æœ€å°å€¼ç‚º W2 å°æ–¼ç›®æ¨™ W3ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ’é™¤ mark 0 çš„ granuleã€‚</li><li>mark 1 çš„ URL å€¼ W2 â‰¤ W3ï¼Œä¸” mark 2 çš„ URL å€¼ W4 â‰¥ W3ï¼Œå› æ­¤é¸æ“‡ mark 1 çš„ granuleã€‚</li><li>mark 2ã€3 çš„ UserId ä¹Ÿæ˜¯ U1ï¼Œä¸” URL å€¼ W4ã€W5 > W3ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ’é™¤ mark 2ã€3 çš„ granuleã€‚</li></ul></li><li><p>å‰ç¶´ä¸»éµé«˜ cardinality</p><p>å‡è¨­ UserID çš„ cardinality è¼ƒé«˜æ™‚ï¼Œç›¸åŒçš„ UserID å€¼ä¸å¤ªå¯èƒ½åˆ†å¸ƒåœ¨å¤šå€‹ granule ä¸­ï¼Œé€™åŒæ™‚æ„å‘³è‘— primary.idx å…§çš„ URL ä¸æœƒå–®ç´”æŒ‰é †åºæ’åºï¼š</p><p><img src=/p/clickhouse-index/Untitled7.png width=887 height=418 srcset="/p/clickhouse-index/Untitled7_hu_77a2fe033c568a6.png 480w, /p/clickhouse-index/Untitled7_hu_22b66df32e1ff24e.png 1024w" loading=lazy class=gallery-image data-flex-grow=212 data-flex-basis=509px></p><p>mark 0 çš„ URL æœ€å°å€¼ç‚º W1 å°æ–¼ç›®æ¨™ W3ï¼Œé›–ç„¶ mark 1 çš„ UserID å’Œ mark 0 ä¸€æ¨£ï¼Œä½†æ˜¯å› ç‚º mark 2 çš„ UserID ä¸ä¸€æ¨£ï¼Œå› æ­¤ç„¡æ³•ä¿è­‰ granule 1 åªåŒ…å« U1 çš„æ•¸æ“šï¼Œå°æ‡‰çš„ä¹Ÿä¸èƒ½ä¿è­‰ mark 1 çš„ W2 æ˜¯è·Ÿ U1 åŒä¸€è¡Œçš„è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯å°ç„¡æ³•æ’é™¤ granule 0 çš„æ•¸æ“šæ²’æœ‰åŒ…å« W3 çš„è³‡æ–™ï¼Œå› æ­¤å¿…é ˆé¸æ“‡ mark 0 å°æ‡‰çš„ granule 0 ã€‚</p><p>å…¶ä¸­ granule 1ã€2ã€3 ä¹Ÿå› ç‚ºä»¥ä¸Šçš„åŸå› ç„¡æ³•è¢«æ’é™¤ï¼Œéƒ½éœ€è¦è¢«æŒ‘é¸ä¸¦ loading åˆ° ClickHouse ä¸­ï¼Œå› æ­¤éæ¿¾çš„æ•ˆç‡éå¸¸å·®ã€‚</p></li></ul><h3 id=ä½¿ç”¨å¤šå€‹-primary-index-é€²è¡Œå„ªåŒ–>ä½¿ç”¨å¤šå€‹ primary index é€²è¡Œå„ªåŒ–</h3><p>å¦‚æœæˆ‘å€‘æƒ³åŒæ™‚åŠ å¿«ä¸‹è¿°å…©å¥èªæ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>URL</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>Count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>UserID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>749927693</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>Count</span><span class=w> </span><span class=k>DESC</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>UserID</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>Count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;http://public_search&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>UserID</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>Count</span><span class=w> </span><span class=k>DESC</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åˆ†åˆ¥é‡å° UserIDã€URL é€²è¡Œéæ¿¾ï¼Œå°±éœ€è¦ç”¨å¤šå€‹ primary index ä¾†é€²è¡Œå„ªåŒ–ï¼Œæˆ‘å€‘æœ‰ä»¥ä¸‹ä¸‰ç¨®æ–¹å¼ï¼š</p><ul><li><p>æ–°å»ºä¸€å€‹æœ‰ä¸åŒä¸»éµçš„æ–°è¡¨</p><p>æ–°å¢ä¸€å€‹å…·æœ‰ä¸åŒ <code>PRIMARY KEY</code>ã€<code>ORDER BY</code> ç›¸åŒæ¬„ä½çš„ tableï¼Œä¹‹å¾Œéœ€è¦è‡ªè¡ŒåŒæ­¥å…©å¼µè¡¨çš„è³‡æ–™ï¼Œä¸¦æ ¹æ“šæŸ¥è©¢æ¢ä»¶è‡ªè¡Œé¸æ“‡é©åˆçš„ tableï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=/p/clickhouse-index/Untitled8.png width=919 height=889 srcset="/p/clickhouse-index/Untitled8_hu_be2c2a08fada043b.png 480w, /p/clickhouse-index/Untitled8_hu_b35adbc79b726a09.png 1024w" loading=lazy class=gallery-image data-flex-grow=103 data-flex-basis=248px></p><p>å¦‚ä¸‹ç¤ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>hits_URL_UserID</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>UserID</span><span class=o>`</span><span class=w> </span><span class=n>UInt32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>URL</span><span class=o>`</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>EventTime</span><span class=o>`</span><span class=w> </span><span class=n>DateTime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MergeTree</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=n>UserID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=n>EventTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SETTINGS</span><span class=w> </span><span class=n>index_granularity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8192</span><span class=p>,</span><span class=w> </span><span class=n>index_granularity_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>hits_URL_UserID</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>OPTIMIZE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>hits_URL_UserID</span><span class=w> </span><span class=k>FINAL</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>å‰µå»ºä¸€å€‹ materialized view</p><p>åœ¨åŸè¡¨ä¸Šå‰µå»º materialized viewï¼Œé€™å€‹é¡å¤–çš„è¡¨æœƒè¢«éš±è—èµ·ä¾†ï¼Œæ•¸æ“šæœƒè‡ªå‹•åœ¨è¡¨ä¹‹é–“ä¿æŒåŒæ­¥ï¼Œä¹Ÿå°±æ˜¯èªªä»åªéœ€åœ¨åŸè¡¨å¯«å…¥è³‡æ–™ï¼Œä¸éœ€è¦åƒä¸Šä¸€å€‹æ–¹æ¡ˆè‡ªè¡Œå¯«å…¥æ–°çš„è¡¨ï¼Œä½†æŸ¥è©¢æ™‚éœ€è¦è‡ªè¡Œé¸æ“‡åˆé©çš„è¡¨ï¼Œä¸¦ä¸”ä¸æä¾›æ•¸æ“šä¸€è‡´æ€§ä¿è­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=/p/clickhouse-index/Untitled9.png width=915 height=865 srcset="/p/clickhouse-index/Untitled9_hu_8e7f697a46d0cc36.png 480w, /p/clickhouse-index/Untitled9_hu_d0b775d1cff5f072.png 1024w" loading=lazy class=gallery-image data-flex-grow=105 data-flex-basis=253px></p><p>å¦‚ä¸‹ç¤ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>MATERIALIZED</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>mv_hits_URL_UserID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ENGINE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MergeTree</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=n>UserID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=n>EventTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- POPULATE ç”¨ä¾†è¡¨ç¤ºå»ºç«‹ view å¾Œå°‡åŸè¡¨çš„è³‡æ–™åŒ¯å…¥ (è‹¥æœªæ·»åŠ å‰‡åªæœƒåŒæ­¥å»ºç«‹ view ä¹‹å¾Œæ’å…¥çš„è³‡æ–™)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>POPULATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>UserID</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>UserID</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>Count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>mv_hits_URL_UserID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;http://public_search&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>UserID</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>Count</span><span class=w> </span><span class=k>DESC</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å»ºç«‹ä¹‹å¾Œçœ‹åˆ° view çš„æ•¸æ“šæ–‡ä»¶å¦‚ä¸‹ï¼š</p><p><img src=/p/clickhouse-index/Untitled10.png width=859 height=675 srcset="/p/clickhouse-index/Untitled10_hu_9f42fcf67b893cb0.png 480w, /p/clickhouse-index/Untitled10_hu_ca836d55f02f674f.png 1024w" loading=lazy class=gallery-image data-flex-grow=127 data-flex-basis=305px></p></li><li><p>å°è©²è¡¨æ–°å¢ projection</p><p>projection æ˜¯æœ€é€æ˜çš„æ–¹æ¡ˆï¼Œå› ç‚ºé™¤äº†æœƒéš±è—é™„åŠ çš„è¡¨ï¼ŒClickHouse é‚„æœƒè‡ªå‹•é¸æ“‡æœ€æœ‰æ•ˆçš„è¡¨ç‰ˆæœ¬ä¾†æŸ¥è©¢ï¼Œä¸¦ä¸”é‚„ä¿è­‰æ•¸æ“šä¸€è‡´æ€§ï¼š</p><p><img src=/p/clickhouse-index/Untitled11.png width=916 height=892 srcset="/p/clickhouse-index/Untitled11_hu_9f1d33b3fb9c3293.png 480w, /p/clickhouse-index/Untitled11_hu_55784e9293bfe0d6.png 1024w" loading=lazy class=gallery-image data-flex-grow=102 data-flex-basis=246px></p><p>äº‹ä¾‹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- åœ¨åŸè¡¨ä¸Šå‰µå»º projection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>ADD</span><span class=w> </span><span class=n>PROJECTION</span><span class=w> </span><span class=n>prj_url_userid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=p>,</span><span class=w> </span><span class=n>UserID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- materialize projectionï¼Œç«‹å³å°‡æºè¡¨è³‡æ–™å°å…¥éš±è—è¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>hits_UserID_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MATERIALIZE</span><span class=w> </span><span class=n>PROJECTION</span><span class=w> </span><span class=n>prj_url_userid</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å»ºç«‹ä¹‹å¾Œæœƒçœ‹åˆ°åœ¨è©² table ä¸‹å¤šäº†ä¸€å€‹ç›®éŒ„ç´€éŒ„ prjection çš„ç›¸æ‡‰è³‡è¨Šï¼š</p><p><img src=/p/clickhouse-index/Untitled12.png width=551 height=781 srcset="/p/clickhouse-index/Untitled12_hu_71141121ab602579.png 480w, /p/clickhouse-index/Untitled12_hu_878599541f4341b3.png 1024w" loading=lazy class=gallery-image data-flex-grow=70 data-flex-basis=169px></p></li></ul><p>é€™ 3 å€‹æ–¹æ³•éƒ½æ˜¯æœƒæœ‰æ•ˆçš„æ•¸æ“šè¤‡è£½åˆ°å¦ä¸€å€‹è¡¨ä¸­ï¼Œä»¥ä¾¿é‡æ–°çµ„ç¹” table çš„ primary index å’Œæ’åºï¼Œå€åˆ¥åœ¨æ–¼å°æŸ¥è©¢å’Œä½¿ç”¨è€…çš„é€æ˜ç¨‹åº¦</p><h2 id=skipping-indexes>Skipping Indexes</h2><p>åœ¨å¤§å¤šæ•¸æƒ…å¢ƒä¸­å½±éŸ¿ ClickHouse æ•ˆèƒ½æœ€é—œéµçš„å› ç´ æ˜¯ WHERE å­å¥çš„æ¢ä»¶æ˜¯å¦å¯ä»¥ä½¿ç”¨ primary indexï¼Œä½†ä¸ç®¡æ€éº¼èª¿å„ª primary index é‚„æ˜¯ä¸å¯é¿å…çš„æœƒå‡ºç¾ä¸èƒ½æœ‰æ•ˆä½¿ç”¨çš„æ¡ˆä¾‹ã€‚</p><p>åœ¨å¦‚ MySQL ç­‰å‚³çµ±æ•¸æ“šåº«ï¼Œè§£æ±ºæ–¹æ¡ˆæ˜¯æ·»åŠ å°æ‡‰çš„ secondary indexï¼Œä¸€å€‹ B+Tree çµæ§‹è®“æ™‚é–“è¤‡é›œåº¦ç”±å…¨è¡¨æƒæçš„ O(n) è®Šæˆ O(logn) çš„ç´¢å¼•æƒæã€‚</p><p>é€™ç¨®é¡å‹çš„ secondary index ä¸é©åˆ ClickHouse (æˆ–å…¶ä»– column-oriented æ•¸æ“šåº«)ï¼Œå› ç‚º disk ä¸Šæ•¸æ“šçš„ç´€éŒ„æ˜¯ä»¥ granule ç‚ºå–®ä½ï¼Œæ‰€ä»¥æ²’æœ‰å–®ç¨çš„è¡Œå¯ä»¥ç‚ºå…¶æ·»åŠ å–®ç¨çš„ indexã€‚ ç›¸æ‡‰çš„ ClickHouse æä¾›äº†ç¨±ç‚º skipping index ä¾†å¹«åŠ©è·³éæ²’æœ‰åŒ¹é…å€¼çš„ granuleã€‚</p><p>skipping index æœ‰ä»¥ä¸‹ 4 å€‹åƒæ•¸ï¼š</p><ul><li><code>index name</code>ï¼šindex åç¨±ã€‚</li><li><code>index expression</code>ï¼šè¨ˆç®—è¡¨é”æ˜¯</li><li><code>TYPE</code>ï¼šskipping index çš„é¡å‹ã€‚</li><li><code>GRANULARITY</code>ï¼šæ¯å€‹ index block åŒ…å«äº† N å€‹ granularityã€‚ä¾‹å¦‚ï¼š index_granularity ç‚º 8192ï¼ŒGRANULARITY ç‚º 4ï¼Œå‰‡æ¯å€‹ indexed block åŒ…å«äº† 8192*4 = 32768 è¡Œè³‡æ–™ã€‚</li></ul><p>ç•¶å‰µå»º Skipping indexï¼Œè©²è¡¨çš„æ•¸æ“šç›®éŒ„ä¸­æœƒç”¢ç”Ÿä»¥ä¸‹ 2 å€‹æª”æ¡ˆï¼š</p><ul><li><code>skp*idx*{index_name}.idx</code>ï¼šå°‡ index expression çš„ values æ’åºå¾Œè¨˜éŒ„ä¸‹ä¾†ã€‚</li><li><code>skp*idx*{index_name}.mrk2</code>ï¼šå°‡ index é—œé€£åˆ°çš„ column æ•¸æ“šæ–‡ä»¶æ‰€åœ¨çš„åç§»é‡ã€‚</li></ul><h3 id=skipping-index-type>Skipping index Type</h3><p>æ¯éš” <code>index_granularity</code> * <code>GRANULARITY</code> æ˜¯ä¸€å€‹ blockï¼Œskipping index æœƒä¾ç…§æ¯å€‹ block å…§ <code>index expression</code> ç”¢ç”Ÿçš„çµæœä¾†ç”Ÿæˆ indexã€‚</p><p>Skipping index çš„ Type å…±åˆ†ç‚ºä»¥ä¸‹ 3 ç¨®ï¼š</p><ul><li><p><code>minmax</code>ï¼šå„²å­˜æ¯å€‹ block ä¸­ <code>index expression</code> çš„ min/max å€¼ã€‚</p></li><li><p><code>set(max_size)</code>ï¼š å„²å­˜æ¯å€‹ block ä¸­ <code>index expression</code> çš„ä¸é‡è¤‡å€¼ã€‚</p><p>å¦‚æœä¸é‡è¤‡å€¼çš„æ•¸é‡ > max_size æ™‚å‰‡ç‚ºç©ºï¼Œå¦‚æœ max_size = 0 å‰‡è¡¨ç¤ºä¸é™åˆ¶ã€‚</p><p>æ­¤é¡å‹é©åˆç”¨æ–¼æ¯å€‹ block ä¸­çš„ cardinality ä½ï¼Œä½†æ•´å€‹ column çš„ cardinality é«˜çš„æƒ…å¢ƒï¼Œè©²ç´¢å¼•æˆæœ¬å’Œæ€§èƒ½å–æ±ºæ–¼å–®å€‹ block çš„ cardinalityã€‚å¦‚æœæ¯å€‹ block åŒ…å«å¤§é‡å”¯ä¸€å€¼å‰‡æˆæœ¬å°‡ç›¸å°é«˜ï¼Œæˆ–è€…æ˜¯è¶…é max_size è€Œç‚ºç©ºå°è‡´ä¸ä½¿ç”¨æ­¤ index ã€‚</p></li><li><p><code>Bloom Filter Types</code>ï¼šæ˜¯ä¸€ç¨®æ•¸æ“šçµæ§‹ï¼Œä»¥å°‘é‡çš„å½é™½æ€§ ( false positive) ç‚ºä»£åƒ¹èƒ½å¤ å° block é€²è¡Œé«˜æ•ˆçš„ space-efficient æ¸¬è©¦ã€‚</p><ul><li><p>åŸç†ç´°ç¯€</p><p>é€™é‚Šå…ˆé™„ä¸Šä¸€å€‹å¯ä»¥ç·šä¸Šæ¼”ç¤ºçš„ç¶²ç«™ï¼š<a class=link href=https://llimllib.github.io/bloomfilter-tutorial/zh_CN/ target=_blank rel=noopener>Bloom Filters by Example (llimllib.github.io)</a></p><p>ä¸€å€‹ç©ºçš„ bloom filter æ˜¯ä¸€å€‹ m bits çš„ bit arrayã€‚</p><p>ä¸‹åœ–æ˜¯ä¸€å€‹ 14 bits çš„ bloom filterï¼Œä¸‹é¢çš„æ•¸å­—è¡¨ç¤ºç´¢å¼•ï¼Œä¸Šé¢çš„ç™½è‰²å€å¡Šè¡¨ç¤ºå°šæœªæœ‰è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯ falseã€0ï¼š</p><p><img src=/p/clickhouse-index/Untitled13.png width=365 height=62 srcset="/p/clickhouse-index/Untitled13_hu_9a9cef09934549c4.png 480w, /p/clickhouse-index/Untitled13_hu_28a4a58089a9efa6.png 1024w" loading=lazy class=gallery-image data-flex-grow=588 data-flex-basis=1412px></p><p>ç•¶è¼¸å…¥ä¸€å€‹æ•¸æ“šæ™‚ï¼Œæœƒç¶“é k å€‹ hash functionï¼Œç”¢ç”Ÿ k å€‹çµæœä¸¦åœ¨å°æ‡‰çš„ index ä¸Šæ¨™ä¸Š trueã€1ã€‚</p><p>ä¸‹åœ–ä¸­ input äº† <code>ee</code> é€™å€‹å€¼ï¼Œç¶“é 2 å€‹ hash functionï¼šfnvã€murmurï¼Œå¾—å‡ºäº† 0ã€4 çš„çµæœï¼Œå› æ­¤åœ¨ 0ã€4 çš„ index æ¨™ä¸Šç¶ è‰²ï¼Œä¹Ÿå°±æ˜¯ trueã€1ï¼š</p><p><img src=/p/clickhouse-index/Untitled14.png width=316 height=153 srcset="/p/clickhouse-index/Untitled14_hu_dfcb99cba00dc6f6.png 480w, /p/clickhouse-index/Untitled14_hu_7d0ce47e9f0060a9.png 1024w" loading=lazy class=gallery-image data-flex-grow=206 data-flex-basis=495px></p><p><img src=/p/clickhouse-index/Untitled15.png width=362 height=61 srcset="/p/clickhouse-index/Untitled15_hu_af3e3866372c626d.png 480w, /p/clickhouse-index/Untitled15_hu_b9da51e4bbb859c7.png 1024w" loading=lazy class=gallery-image data-flex-grow=593 data-flex-basis=1424px></p><p>é€™æ™‚å€™ç•¶å†è¼¸å…¥ <code>eee</code> æ™‚ï¼Œ2 å€‹ hash function æœƒå¾—å‡º 7ã€11 å’ŒåŸæœ¬çš„ 0ã€4 æ²’æœ‰ä»»ä½•äº¤é›†ï¼Œå› æ­¤å¯ä»¥åˆ¤æ–· <code>eee</code> é‚„ä¸åœ¨é€™å€‹çµæœé›†å…§ï¼š</p><p><img src=/p/clickhouse-index/Untitled16.png width=235 height=132 srcset="/p/clickhouse-index/Untitled16_hu_4ab566119a3a7aa1.png 480w, /p/clickhouse-index/Untitled16_hu_d8682e7c7e11f86d.png 1024w" loading=lazy class=gallery-image data-flex-grow=178 data-flex-basis=427px></p><p>ä½†å¦‚æœé€™æ™‚å€™è¼¸å…¥ <code>eeee</code> æ™‚ï¼Œ2 å€‹ hash function æœƒå¾—å‡º 0ã€4 å’ŒåŸæœ¬çš„ 0ã€4 ä¸€æ¨£ï¼Œå› æ­¤æˆ‘å€‘æœƒå¾—å‡º <code>eeee</code> å¯èƒ½æœ‰åœ¨çµæœé›†å…§ï¼Œä½†æ˜¯å¯¦éš›ä¸Šå»æ²’æœ‰ï¼Œé€™å°±æ˜¯ bloom filter çš„å½é™½æ€§ï¼š</p><p><img src=/p/clickhouse-index/Untitled17.png width=243 height=165 srcset="/p/clickhouse-index/Untitled17_hu_37a8ecd5d12d02f.png 480w, /p/clickhouse-index/Untitled17_hu_d3dafa95cecc9596.png 1024w" loading=lazy class=gallery-image data-flex-grow=147 data-flex-basis=353px></p></li></ul><p>åœ¨ skipping index çš„ä½¿ç”¨å ´æ™¯å½é™½æ€§ ( false positive) ä¸æ˜¯ä»€éº¼å•é¡Œï¼Œå› ç‚ºå”¯ä¸€çš„ç¼ºé»æ˜¯å¤šè®€å–äº†ä¸€äº›ä¸å¿…è¦çš„ granuleï¼Œè€Œä¸”ä¹Ÿç¸½æ¯”è·³éæœ‰æ•ˆçš„ granule å¥½ã€‚</p><p>å› ç‚º Bloom Filter å¯ä»¥æœ‰æ•ˆçš„è™•ç†å¤§é‡é›¢æ•£å€¼çš„æ¸¬è©¦ï¼Œæ‰€ä»¥ä»–å€‘æ›´é©åˆç”¨æ–¼å¯ä»¥ç”¢ç”Ÿå¤šå€‹æ¸¬è©¦å€¼çš„ index expressionï¼Œç‰¹åˆ¥æ˜¯é€é <code>mapKeys</code> æˆ– <code>mapValues</code> function ä¾†ç”¢ç”Ÿ arrayã€map ä¾†é€²è¡Œå¤šå€¼çš„ space-efficient æ¸¬è©¦ã€‚</p><ul><li>åŸºæ–¼ Bloom Filter çš„ skipping index åˆç´°åˆ†ç‚º 3 ç¨®ï¼š<ul><li><p>åŸºæœ¬çš„bloom_filter</p><p>æ”¯æŒçš„æ•¸æ“šå‹æ…‹ï¼šInt*, UInt*, Float*, Enum, Date, DateTime, String, FixedString, Array, LowCardinality, Nullableã€‚</p><p>æœƒä½¿ç”¨åˆ°è©²ç´¢å¼•çš„ Functionï¼šequals, notEquals, in, notin, hasã€‚</p><p>æœ‰ä¸€å€‹å¯é¸çš„åƒæ•¸ false_positiveï¼šè©²åƒæ•¸è¡¨ç¤º 0~1 ä¹‹é–“å…è¨±çš„å‡é™½æ€§ç‡ï¼Œé è¨­ç‚º .025ã€‚</p></li><li><p>tokenbf_v1ï¼šå°å­—ç¬¦ä¸²åš tokenization å¾Œå„²å­˜ï¼Œé©åˆç”¨æ–¼ LIKEã€EQUALSã€inã€hasToke() ç­‰ç­‰é•·å­—ç¬¦ä¸²çš„æœç´¢ï¼Œæ¥å— Stringã€FixedStringã€Map å‹æ…‹çš„æ•¸æ“šã€‚æœƒå°‡<code>index expression</code> ä¾ç…§éå­—æ¯æ•¸å­—çš„å­—ç¬¦é€²è¡Œåˆ‡å‰²ï¼Œä¾‹å¦‚ï¼šThis is a full text searchï¼Œæœƒè¢«åˆ†å‰²ç‚º <code>This</code> <code>is</code> <code>a</code> <code>full</code> <code>text</code> <code>search</code> ã€‚</p><p>éœ€è¦ä»¥ä¸‹ 3 å€‹åƒæ•¸ï¼š</p><ul><li>size_of_bloom_filter_in_bytesï¼šbloom filter çš„å¤§å°ï¼Œä»¥ byte ç‚ºå–®ä½ï¼Œä½¿ç”¨çš„è¶Šå¤§å¯ä»¥æ¸›å°‘å‡é™½æ€§ï¼Œä½†æœ‰æ›´é«˜çš„å­˜å„²æˆæœ¬ã€‚</li><li>number_of_hash_functionsï¼šä½¿ç”¨çš„ hash function çš„å€‹æ•¸ï¼Œä½¿ç”¨çš„è¶Šå¤šå¯ä»¥æ¸›å°‘å‡é™½æ€§ã€‚</li><li>random_seedï¼šhash function çš„éš¨æ©Ÿç¨®å­</li></ul></li><li><p>ngrambf_v1**ï¼š**å’Œ tokenbf_v1 é¡ä¼¼ï¼Œä½†æ˜¯æ˜¯ç”¨ ngram ä¾†åˆ‡å‰²è€Œä¸æ˜¯éå­—æ¯æ•¸å­—çš„å­—ç¬¦ä¾†åˆ‡å‰²ï¼Œé©åˆç”¨æ–¼ä¸­æ–‡é€™é¡æ²’æœ‰ç”¨ç©ºæ ¼åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ n = 2ï¼Œæœƒå°‡ <code>é€™æ˜¯æ¸¬è©¦</code> åˆ†å‰²ç‚º <code>é€™æ˜¯</code> <code>æ˜¯æ¸¬</code> <code>æ¸¬è©¦</code>ã€‚</p><p>æ¯” tokenbf_v1 å¤šä¸€å€‹åƒæ•¸ï¼Œéœ€è¦ä»¥ä¸‹ 4 å€‹åƒæ•¸ï¼š</p><ul><li>nï¼šngram çš„çŸ­èªé•·åº¦ã€‚</li><li>size_of_bloom_filter_in_bytes</li><li>number_of_hash_functions</li><li>random_seed</li></ul></li></ul></li></ul></li></ul><h3 id=skipping-index-æ”¯æŒçš„-function>Skipping index æ”¯æŒçš„ function</h3><p>Where å­å¥ä¸­çš„æ¢ä»¶å¯ä»¥åŒ…å«å°æŸå€‹ column é€²è¡Œé‹ç®—çš„å‡½æ•¸è¡¨é”å¼ï¼Œå‡å¦‚ column æ˜¯ index çš„ä¸€éƒ¨åˆ†ï¼ŒClickHouse æœƒåœ¨åŸ·è¡Œ function æ™‚å˜—è©¦ä½¿ç”¨ indexã€‚</p><p><code>set</code> type çš„ skipping index æ”¯æŒæ‰€æœ‰çš„ functionï¼Œå…¶ä»– index æ”¯æŒçš„ function å¦‚ä¸‹è¡¨æ‰€åˆ—ï¼š</p><p><img src=/p/clickhouse-index/Untitled18.png width=789 height=887 srcset="/p/clickhouse-index/Untitled18_hu_d4dbdeba1e471bac.png 480w, /p/clickhouse-index/Untitled18_hu_815669df50e5826f.png 1024w" loading=lazy class=gallery-image data-flex-grow=88 data-flex-basis=213px></p><p>å¦‚æœ function çš„å¸¸é‡åƒæ•¸å°æ–¼ ngram å¤§å°å‰‡ä¸èƒ½ä½¿ç”¨ <code>ngrambf_v1</code> é€²è¡ŒæŸ¥è©¢å„ªåŒ–ã€‚</p><blockquote><p>ğŸ’¡ å› ç‚º bloom filter æœ‰å½é™½æ€§çš„ç‹€æ³ï¼Œå› æ­¤ bloom filter çš„ skipping index ä¸èƒ½ç”¨æ–¼çµæœè¿”å›ç‚º false çš„ functionï¼Œä¾‹å¦‚ï¼š
èƒ½å„ªåŒ–çš„å ´æ™¯ï¼š
s LIKE &lsquo;%test%â€™
NOT s NOT LIKE &lsquo;%test%â€™
s = 1
NOT s != 1
startsWith(s, â€˜testâ€™)
ä¸èƒ½å„ªåŒ–çš„å ´æ™¯ï¼š
NOT s LIKE &lsquo;%test%â€™
s NOT LIKE &lsquo;%test%â€™
NOT s = 1
S != 1
NOT startsWith(s, â€˜testâ€™)</p></blockquote><h3 id=skipping-index-çš„é…ç½®>Skipping index çš„é…ç½®</h3><ul><li>use_skip_indexes ( 0 | 1 )ï¼šé è¨­å€¼ç‚º 1ï¼Œå°æ–¼ä¸å¤ªå¯èƒ½å¾ Skipping index ç²ç›Šçš„æŸ¥è©¢å»ºè­°å¯ä»¥è¨­ç½®ç‚º 0 æ¸›å°‘ä¸å¿…è¦çš„æˆæœ¬ã€‚</li><li>force_data_skipping_indexes (ä»¥é€—è™Ÿåˆ†éš” skipping index çš„åç¨±)ï¼šå¼·è¿«æŸ¥è©¢ä½¿ç”¨æŒ‡å®šçš„ skipping indexï¼Œè‹¥æŒ‡å®šå¾Œä¸æœƒç”¨åˆ°åŠå€‹ skipping index å‰‡æœƒè¿”å›ç•°å¸¸ï¼Œé¿å…ç³Ÿç³•çš„æŸ¥è©¢è€—è²»æ©Ÿå™¨æ•ˆèƒ½ã€‚</li></ul><h3 id=æœ€ä½³å¯¦è¸>æœ€ä½³å¯¦è¸</h3><p>å‡è¨­æœ‰ä¸€å¼µè¡¨çš„ primary index æ˜¯ timestampï¼Œä¸¦ä¸”åœ¨ visitor_id æœ‰ä¸€å€‹ indexï¼Œä¸¦æœ‰ä»¥æŸ¥è©¢ï¼š</p><p>SELECT timestamp, url FROM table WHERE visitor_id = 1001</p><p><img src=/p/clickhouse-index/Untitled19.png width=719 height=511 srcset="/p/clickhouse-index/Untitled19_hu_33384569b315b935.png 480w, /p/clickhouse-index/Untitled19_hu_e72d4a608c892f34.png 1024w" loading=lazy class=gallery-image data-flex-grow=140 data-flex-basis=337px></p><p>å°æ–¼é€™ç¨®æ•¸æ“šåˆ†å¸ƒèˆ‡ç›¸æ‡‰çš„æŸ¥è©¢ï¼Œå‚³çµ± RDBMS çš„ secondary index éå¸¸æœ‰æ•ˆï¼Œé€é secondary index èƒ½å¤ ç›´æ¥è®€å–é€™ 5 è¡Œæ•¸æ“šã€‚</p><p>å°æ–¼ ClickHouse çš„ Skipping index æƒ…æ³å»ä¸åŒï¼Œç„¡æ³•æ˜¯å“ªä¸€ç¨® Type çš„ Skipping index éƒ½éœ€è¦å¾ 8192*4=32678 çš„å€¼éƒ½éœ€è¦æ¸¬è©¦ã€‚</p><p>å¯ä»¥çœ‹åˆ°åœ¨ä»¥ä¸Šä¾‹å­ä¸­ Skipping index ä¸¦æ²’æœ‰æœ‰æ•ˆçš„æ•ˆæœï¼Œè¦æœ‰æ•ˆçš„ä½¿ç”¨ Skipping index æœ‰ä»¥ä¸‹æƒ…å¢ƒï¼š</p><ul><li>æ¯å€‹ granule å¤šæ•¸çš„è³‡æ–™ç¬¦åˆæ¢ä»¶ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨è©² granule æœ‰ä½ cardinalityã€‚<ul><li>ç¯„ä¾‹ï¼šå¦‚æœ primary key æ˜¯ä¸€å¤©ä¸­çš„æ™‚é–“ï¼Œå¦å¤–æœ‰ä¸€å€‹ column æ˜¯é›»è¦–è§€çœ¾å¹´é½¡ï¼Œå¾ˆæ˜é¡¯å…©è€…æ˜¯æœ‰ç›¸é—œæ€§çš„ï¼Œæ­¤æ™‚ <code>minmax</code> type çš„ Skipping index å¯èƒ½å°±å¾ˆæœ‰æ•ˆï¼Œå› ç‚ºåªæœ‰å°‘æ•¸çš„ granule æœƒè¢«é¸ä¸­ã€‚</li><li>åœ¨æ’å…¥æ•¸æ“šæ™‚å¯ä»¥å¢åŠ é€™ç¨®ç›¸é—œæ€§ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š<ul><li>åœ¨æ’åºéµ (order by) ä¸­æ·»åŠ æ­¤åˆ—</li><li>Insert æ™‚å…ˆå°‡ Primary key èˆ‡è©²åˆ—åˆ†çµ„å¾Œåœ¨æ‰¹æ¬¡æ’å…¥</li></ul></li></ul></li><li>ç›¡å¯èƒ½æ¸›å°‘ granule è¢«é¸åˆ°ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨æ•´å€‹ table æœ‰é«˜ cardinalityã€‚<ul><li>ç¯„ä¾‹ï¼šä¸€å€‹ API ä¸­å¾ˆå°‘è¦‹çš„ error codeï¼Œä½†å»ç‰¹åˆ¥é‡è¦éœ€è¦ç¶“å¸¸æœå°‹ï¼Œæ­¤æ™‚ <code>set(max_size)</code> type çš„ Skipping index å°±å¾ˆæœ‰æ•ˆï¼Œå› ç‚ºå¤§å¤š granule æœƒè¢«è·³éã€‚</li></ul></li></ul><p>å› æ­¤æ„åœ–é€éç°¡å–®æ·»åŠ  Skipping index ä¾†åŠ é€ŸæŸ¥è©¢çš„æ•ˆèƒ½æ˜¯ä¸æ­£ç¢ºçš„ï¼Œå»ºè­°å…ˆç ”ç©¶å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ï¼šä¿®æ”¹ primary indexã€ä½¿ç”¨ projectionsã€ä½¿ç”¨ materialized viewsï¼Œç ”ç©¶é€™äº›æ–¹æ³•ä¹‹å¾Œæ‰è€ƒæ…® Skipping indexï¼Œè€Œä¸”å’Œ secondary index ä¸åŒï¼ŒSkipping index çš„è¡Œç‚ºæ˜¯ä¸å®¹æ˜“é æ¸¬ï¼Œå› ç‚ºå’Œæ•¸æ“šçš„çœŸå¯¦åˆ†å¸ƒæƒ…æ³æ¯æ¯ç›¸é—œï¼Œä¸¦ä¸”å°‡ä»–å€‘æ·»åŠ åˆ°è¡¨ä¸­å°æ–¼ç„¡æ³•ä½¿ç”¨ç´¢å¼•çš„æŸ¥è©¢æœƒç”¢ç”Ÿå¾ˆå¤§çš„æˆæœ¬ï¼Œå› æ­¤å»ºè­°åœ¨çœŸå¯¦æ•¸æ“šä¸Šé€²è¡Œæ¸¬è©¦ã€‚</p><h1 id=åƒè€ƒ>åƒè€ƒ</h1><p><a class=link href=https://clickhouse.com/docs/zh/guides/improving-query-performance/sparse-primary-indexes target=_blank rel=noopener>ClickHouseä¸»é”®ç´¢å¼•æœ€ä½³å®è·µ | ClickHouse Docs</a></p><p><a class=link href=https://clickhouse.com/docs/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design/ target=_blank rel=noopener>ClickHouse Index Design | ClickHouse Docs</a></p><p><a class=link href=https://www.jianshu.com/p/91f6e9738f0c target=_blank rel=noopener>ã€ClickHouse æç®€æ•™ç¨‹-å›¾æ–‡è¯¦è§£åŸç†ç³»åˆ—ã€‘ClickHouse ä¸»é”®ç´¢å¼•çš„å­˜å‚¨ç»“æ„ä¸æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ– - ç®€ä¹¦ (jianshu.com)</a></p><p><a class=link href=https://github.com/ClickHouse/ClickHouse/issues/5125 target=_blank rel=noopener>https://github.com/ClickHouse/ClickHouse/issues/5125</a></p><p><img src=/p/clickhouse-index/Untitled20.png width=921 height=370 srcset="/p/clickhouse-index/Untitled20_hu_1235ce1b8ff93269.png 480w, /p/clickhouse-index/Untitled20_hu_3ce7f26770fd70fe.png 1024w" loading=lazy class=gallery-image data-flex-grow=248 data-flex-basis=597px></p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸é—œæ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/clickhouse-materialized-mysql/><div class=article-details><h2 class=article-title>ClickHouse Materialized MySQL</h2></div></a></article><article><a href=/p/clickhouse-tpch-test/><div class=article-details><h2 class=article-title>ClickHouse TPC-H Test</h2></div></a></article><article><a href=/p/clickhouse-partition/><div class=article-details><h2 class=article-title>ClickHouse Partition</h2></div></a></article><article><a href=/p/clickhouse-storage-file/><div class=article-details><h2 class=article-title>ClickHouse å„²å­˜çµæ§‹</h2></div></a></article><article><a href=/p/clickhouse-mergetree/><div class=article-details><h2 class=article-title>ClickHouse MergeTree å¼•æ“</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//å°å° DBA å€‹äººç­†è¨˜.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 FuweaY</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>