<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Replication on FuweaY</title><link>https://FuweaY.github.io/tags/replication/</link><description>Recent content in Replication on FuweaY</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Mon, 07 Apr 2025 12:00:00 +0800</lastBuildDate><atom:link href="https://FuweaY.github.io/tags/replication/index.xml" rel="self" type="application/rss+xml"/><item><title>ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)</title><link>https://FuweaY.github.io/p/mysql-mts/</link><pubDate>Mon, 07 Apr 2025 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/mysql-mts/</guid><description>&lt;h2 id="ä¸¦è¡Œè¤‡è£½-multi-thread-slave-mts">ä¸¦è¡Œè¤‡è£½ (Multi-Thread Slave, MTS)
&lt;/h2>&lt;p>åœ¨ MySQL 8.0.27 ä¹‹å‰ï¼ŒReplica é è¨­åªæœ‰ä¸€å€‹ IO_THREAD å’Œä¸€å€‹ SQL_THREADï¼š&lt;/p>
&lt;ul>
&lt;li>IO_THREAD è² è²¬å¾ Source æ¥æ”¶ binlog ä¸¦å¯«å…¥ Replica çš„ relaylog&lt;/li>
&lt;li>SQL_THREAD è² è²¬è§£æå’Œé‡æ”¾ relaylog ä¸­çš„ event&lt;/li>
&lt;/ul>
&lt;p>ç•¶ Source æœ‰ä½µç™¼å¤§é‡å¯«å…¥æ™‚ï¼ŒReplica çš„ IO_THREAD å› ç‚ºæ˜¯é †åºå¯«å…¥ä¸€èˆ¬ä¸æœƒå°è‡´ replication delayï¼Œä½†æ˜¯åªæœ‰å–®ç·šç¨‹ SQL_THREAD å›æ”¾é€Ÿåº¦æ˜¯è·Ÿä¸ä¸Šæœ‰å¤šç·šç¨‹å¯«å…¥çš„ Sourceï¼Œå› æ­¤æœƒé€ æˆ replication delay ä¸æ–·è®Šå¤§ï¼Œç›¸æ‡‰ä¹Ÿå°è‡´ Replica çš„ relaylog å¤§é‡å †ç©å æ»¿ disk ç©ºé–“ã€‚&lt;/p>
&lt;p>å› æ­¤å¾ MySQL 5.6 é–‹å§‹æä¾›äº† Multi-Tread Slave (MTS)ï¼Œé€éå¤šç·šç¨‹çš„ SQL_THREAD ä¾†ç·©è§£é€™ç¨®å•é¡Œï¼Œä¸¦ä¸”åœ¨å¾ŒçºŒçš„å¤§ç‰ˆæœ¬ä¸­ä¸æ–·é€²è¡Œå„ªåŒ–ã€‚&lt;/p>
&lt;h2 id="å„å€‹ç‰ˆæœ¬çš„-mts">å„å€‹ç‰ˆæœ¬çš„ MTS
&lt;/h2>&lt;h3 id="åŸºæ–¼-database-ç´šåˆ¥çš„-mts-56">åŸºæ–¼ database ç´šåˆ¥çš„ MTS (5.6)
&lt;/h3>&lt;p>åœ¨ MySQL 5.6 åªæœ‰åŸºæ–¼ Database ç´šåˆ¥çš„ MTSï¼Œåªæœ‰åœ¨ä¸åŒ Database çš„èªå¥æ‰å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œï¼Œå› æ­¤é€™ç„¡æ³•è§£æ±ºå–®è¡¨é«˜å¯«å…¥æ‰€é€ æˆçš„åŒæ­¥å»¶é²ã€‚&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/MySQL-56-MTS-ByDatabase.png"
width="808"
height="209"
srcset="https://FuweaY.github.io/p/mysql-mts/MySQL-56-MTS-ByDatabase_hu_76640f19593a5e88.png 480w, https://FuweaY.github.io/p/mysql-mts/MySQL-56-MTS-ByDatabase_hu_1cab929c3ba48.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="386"
data-flex-basis="927px"
>&lt;/p>
&lt;h3 id="åŸºæ–¼-group-commit-çš„-mts-57">åŸºæ–¼ Group Commit çš„ MTS (5.7)
&lt;/h3>&lt;h4 id="group-commit-ç°¡è¿°">Group Commit ç°¡è¿°
&lt;/h4>&lt;p>Group Commit æ˜¯ MySQL 5.6 ç‰ˆæœ¬å¼•å…¥ç”¨ä¾†å„ªåŒ– BinLogã€RedoLog åœ¨ 2PC æ™‚å¯«å…¥çš„ç“¶é ¸ï¼Œç°¡å–®ä¾†èªªåŸæœ¬æ¯å€‹ Transaction éƒ½éœ€è¦ç¨è‡ª &lt;code>fsync&lt;/code> æ“ä½œä¾†å¯«å…¥ Disk æŒä¹…åŒ–ï¼Œç¶“é Group Commit çš„å„ªåŒ–å¾Œæœƒå°‡å¤šå€‹ Transaction çµ„æˆä¸€å€‹å°åˆ—ä¸€èµ·é€²è¡Œ &lt;code>fsync&lt;/code> æ“ä½œï¼Œå¤§å¹…æ¸›å°‘ &lt;code>fsync&lt;/code> æ“ä½œè§£æ±ºåœ¨é›™ 1 æ™‚é€ æˆçš„æ€§èƒ½æ€¥é€Ÿä¸‹é™çš„å•é¡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/MySQL-5.6-GroupCommit.png"
width="2000"
height="734"
srcset="https://FuweaY.github.io/p/mysql-mts/MySQL-5.6-GroupCommit_hu_68a640d24557e5a3.png 480w, https://FuweaY.github.io/p/mysql-mts/MySQL-5.6-GroupCommit_hu_a620e3a9d84860da.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="272"
data-flex-basis="653px"
>&lt;/p>
&lt;p>é—œæ–¼ Group Commit çš„å…·é«”æè¿°ï¼Œå¯åƒè€ƒ &lt;a class="link" href="https://FuweaY.github.io/p/mysql-group-commit/" >MySQL Group Commit æ¼”é€²&lt;/a>ã€‚&lt;/p>
&lt;h4 id="slave_parallel_type">slave_parallel_type
&lt;/h4>&lt;p>åœ¨ MySQL 5.7 å¼•å…¥äº† &lt;code>slave_parallel_type&lt;/code> é€™å€‹æ–°åƒæ•¸ï¼Œå¯ä½¿ç”¨çš„å€¼æœ‰ä»¥ä¸‹ 2 å€‹ï¼š&lt;/p>
&lt;ul>
&lt;li>DATABASEï¼šä¹Ÿå°±æ˜¯ 5.6 ç‰ˆæœ¬ï¼Œä¸åŒ DATABASE çš„æ‰èƒ½ä¸¦è¡Œå›æ”¾ã€‚&lt;/li>
&lt;li>LOGICAL_CLOCKï¼š5.7 ç‰ˆæœ¬åŸºæ–¼ Group Commit çš„ä¸¦è¡Œå›æ”¾ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="logical_clock---commit-parent-based-æ¨¡å¼">LOGICAL_CLOCK - Commit Parent Based æ¨¡å¼
&lt;/h4>&lt;p>åœ¨ Source ä¸­èƒ½å¤ åœ¨åŒä¸€å€‹å°åˆ—ä¸€èµ·é€²è¡Œ Group commitï¼Œè¡¨ç¤ºé€™å€‹å°åˆ—ä¸­çš„æ‰€æœ‰ Transaction éƒ½æ²’æœ‰é–è¡çªï¼Œå› æ­¤ä¹Ÿå¯åœ¨ Replica å…§ä¸¦è¡Œå›æ”¾ã€‚&lt;/p>
&lt;p>ç‚ºäº†è®“ Replica èƒ½åŸºæ–¼ Group Commit å¯¦ç¾ MTSï¼Œåœ¨ Binlog ä¸­ç‚ºæ¯å€‹ Transaction æ·»åŠ äº† LOGICAL CLOCK ä¹Ÿå°±æ˜¯ä»¥ä¸‹ 2 å€‹å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>sequence_numberï¼šæ¯å€‹ Transaction çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œå…·é«”åœ¨ Transaction é€²å…¥ flush éšæ®µçš„å°åˆ—ä¹‹å‰åˆ†é…ã€‚&lt;/li>
&lt;li>last_commitedï¼šç´€éŒ„ä¸Šæ¬¡ Group commit æ™‚æœ€å¤§çš„ sequence_numberï¼Œä¹Ÿå°±æ˜¯èªª last_committed ç›¸åŒè¡¨ç¤ºåŒå±¬ä¸€å€‹ Groupã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/binlog-sequence-last-example.png"
width="2000"
height="503"
srcset="https://FuweaY.github.io/p/mysql-mts/binlog-sequence-last-example_hu_6de35104bba7a66b.png 480w, https://FuweaY.github.io/p/mysql-mts/binlog-sequence-last-example_hu_de30a8103e12b021.png 1024w"
loading="lazy"
alt="é€é mysqlbinlog å¯ä»¥çœ‹åˆ° binlog ä¸­æ¯å€‹ Transaction éƒ½æœ‰é€™ 2 å€‹è®Šé‡"
class="gallery-image"
data-flex-grow="397"
data-flex-basis="954px"
>&lt;/p>
&lt;p>é€é mysqlbinlog å¯ä»¥çœ‹åˆ° binlog ä¸­æ¯å€‹ Transaction éƒ½æœ‰é€™ 2 å€‹è®Šé‡&lt;/p>
&lt;p>å‚™è¨»ï¼šsequence_numberã€last_commited åªåœ¨åŒä¸€å€‹ BinLog æ–‡ä»¶ä¸é‡è¤‡ï¼Œæ¯ç•¶æ›åˆ°æ–°çš„ BinLog æ–‡ä»¶æ™‚æœƒé‡æ–°å¾ 0 é–‹å§‹è¨ˆæ•¸ã€‚&lt;/p>
&lt;hr>
&lt;p>ä¸é Commit Parent Based æœ‰ä¸€å€‹ç¼ºé™·ï¼Œè®“æˆ‘å€‘çœ‹ä¸€ä¸‹ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Trx1 ------------P----------C--------------------------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trx2 ----------------P------+---C----------------------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trx3 -------------------P---+---+-----C----------------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | | |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trx4 -----------------------+-P-+-----+----C-----------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | | | |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trx5 -----------------------+---+-P---+----+---C-------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | | | | |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trx6 -----------------------+---+---P-+----+---+---C----------&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯ä¸€å€‹æ°´å¹³ç·šä»£è¡¨ä¸€å€‹ Transaction ç”±å·¦åˆ°å³çš„æ™‚é–“é»ï¼Œå…¶ä¸­ P è¡¨ç¤º prepare éšæ®µå–å¾—ä¸Šä¸€å€‹ Group æ›´æ–° last_committed çš„æ™‚é–“é»ï¼ŒC è¡¨ç¤º commit å‰æ›´æ–° last_committed çš„æ™‚é–“é»ã€‚&lt;/p>
&lt;p>å…¶ä¸­å¯ä»¥è§€å¯Ÿåˆ°ï¼š&lt;/p>
&lt;ul>
&lt;li>Trx4 çš„ P æ™‚é–“é»å–å¾—çš„æ˜¯ Trx1 commit ç”¢ç”Ÿçš„ last_committed&lt;/li>
&lt;li>Trx5 å’Œ Trx6 çš„ P æ™‚é–“é»å–å¾—çš„æ˜¯ Trx2 commit ç”¢ç”Ÿçš„ last_committed&lt;/li>
&lt;/ul>
&lt;p>ä¾ç…§ Commit Parent æ¨¡å¼ä¸‹ Trx5ã€Trx6 å¯ä»¥ä¸€èµ·åœ¨ Replica å›æ”¾ï¼Œä½†æ˜¯ Trx4 ä¸å¯ä»¥å’Œ Trx5ã€Trx6 ä¸€èµ·åœ¨ Replica å›æ”¾ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œå¯¦éš›ä¸Šä¾ç…§æ™‚é–“ç·šæˆ‘å€‘å¯ä»¥çœ‹åˆ° Trx4 åœ¨ prepare åˆ° commit çš„éç¨‹ä¸­ï¼ŒTrx5ã€Trx6 æœ‰åœ¨é€™å€‹éç¨‹ä¸­ prepareï¼Œä¹Ÿå°±æ˜¯èªªå¯¦éš›ä¸Šä»–å€‘ä¸¦æ²’æœ‰é–è¡çª (å¦‚æœè¡çª Trx5ã€Trx6 æœƒå¡åœ¨ lock wait)ï¼Œæ‰€ä»¥ç†è«–ä¸Šä»–å€‘åœ¨ Replica æ˜¯å¯ä»¥ä¸¦è¡Œå›æ”¾åˆ°ã€‚&lt;/p>
&lt;h4 id="logical_clock----lock-based-æ¨¡å¼">LOGICAL_CLOCK - Lock Based æ¨¡å¼
&lt;/h4>&lt;p>ç‚ºäº†é€²ä¸€æ­¥å„ªåŒ– Commit Parent Based çš„ç¼ºé™·ï¼ŒMySQL 5.7 é¦¬ä¸Šå¯¦ç¾äº† &lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=7165" target="_blank" rel="noopener"
>MySQL :: WL#7165: MTS: Optimizing MTS scheduling by increasing the parallelization window on master&lt;/a> çš„å„ªåŒ–ï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ Lock Based æ¨¡å¼çš„ LOGICAL_CLOCKï¼Œåªè¦ Transaction åœ¨å„è‡ªæŒæœ‰çš„é–æ²’æœ‰è¡çªæ™‚å°±å¯ä»¥ä¸¦è¡ŒåŸ·è¡Œã€‚&lt;/p>
&lt;p>åœ¨æ­¤æ¨¡å¼ä¸‹ binlog ä¸­çš„ sequence_numberã€last_commited æ¶µç¾©å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>sequence_numberï¼šæ¯å€‹ Transaction çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œå…·é«”åœ¨ Transaction é€²å…¥ flush éšæ®µçš„å°åˆ—ä¹‹å‰åˆ†é…ï¼Œ&lt;/li>
&lt;li>last_commitedï¼šç•¶ Transaction é–‹å§‹åŠ é–æ™‚ï¼Œå°‡å…¨å±€è®Šé‡ max_committed_transaction ç•¶ä¸‹çš„å€¼ä½œç‚º last_commitedã€‚
&lt;ul>
&lt;li>å…¨å±€è®Šé‡ max_committed_transactionï¼šå·²ç¶“çµæŸ Lock interval çš„æœ€å¤§ sequence_numberï¼Œæ¯å€‹ Transaction åœ¨ InnoDB commit éšæ®µæ™‚ï¼Œå¦‚æœè‡ªå·±çš„ sequence_number &amp;gt; max_committed_transaction æ™‚æœƒå°‡å…¶æ›´æ–°ç‚ºè‡ªå·±çš„ sequence_number ã€‚&lt;/li>
&lt;li>å› ç‚ºç„¡æ³•é å…ˆçŸ¥é“å“ªä¸€å€‹é–æ˜¯æœ€å¾Œä¸€å€‹ï¼Œå› æ­¤ Transaction å…§æ¯ä¸€å€‹ DML éƒ½æœƒä¸æ–·æ›´æ–°è©² Transaction çš„ last_commitedã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>åœ¨ Source å¯«å…¥ sequence_numberã€last_commited ä¹‹å¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯çœ‹ Replica å¦‚ä½•ä¾æ“šé€™ 2 å€‹ç›´ä¾†å¯¦ç¾ Lock Based çš„ MTSã€‚&lt;/p>
&lt;p>é¦–å…ˆè¤‡ç¿’ä¸€ä¸‹ï¼Œåªæœ‰ç•¶ Transaction å’Œ Transaction åœ¨ Lock ~ Commit (ä¹Ÿå°±æ˜¯é‡‹æ”¾é–) ä¹‹é–“æœ‰äº¤é›†æ‰èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">- Can execute in parallel:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx1 -----L---------C------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx2 ----------L---------C-------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Can not execute in parallel:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx1 -----L----C-----------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx2 ---------------L----C-------&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è®“æˆ‘å€‘é¦–å…ˆç‚ºä¸Šåœ–ä¸­çš„ L~C çš„æœŸé–“å®šç¾©ä¸€å€‹æ–°çš„åè© &lt;code>Lock interval&lt;/code>ï¼š&lt;/p>
&lt;ul>
&lt;li>Lock interval çš„èµ·å§‹é»(ä¸Šåœ–L)ï¼šåœ¨ Binlog Prepare éšæ®µå–å¾—æœ€å¾Œä¸€æŠŠé–çš„æ™‚é–“é»ã€‚&lt;/li>
&lt;li>Lock interval çš„çµæŸé»(ä¸Šåœ–C)ï¼šåœ¨ InnoDB Commit éšæ®µé‡‹æ”¾ç¬¬ä¸€æŠŠé–çš„æ™‚é–“é»ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¹Ÿå°±æ˜¯èªªå°æ–¼ Replica åœ¨è®€å– BinLog æ™‚ï¼š&lt;/p>
&lt;ul>
&lt;li>last_commited ä½œç‚º Lock interval çš„èµ·å§‹é»ï¼šå› ç‚º Transaction é–‹å§‹åŠ é–çš„é‚è¼¯æ™‚é–“æ˜¯ç›®å‰æœ€å¾Œä¸€å€‹å·²çµæŸ lock interval çš„æœ€å¾Œä¸€å€‹ sequence_numberï¼Œå°±æ˜¯å…¨å±€è®Šé‡ max_committed_transactionã€‚&lt;/li>
&lt;li>sequence_number ä½œç‚º Lock interval çš„çµæŸé»ï¼šå› ç‚ºç•¶è©² Transaction çµæŸ lock interval æ™‚æœƒå°‡è‡ªå·±çš„ sequence_number æ›´æ–°åˆ° max_committed_transactionï¼Œä¹Ÿå°±æ˜¯èªªå°æ–¼ä¸‹å€‹ Transaction è€Œè¨€çš„ last_commitedã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨ Replica å›æ”¾æ™‚åªæœ‰ Transaction ä¹‹é–“å¦‚æœ last_commited~sequence_number ä¹‹é–“æœ‰é‡ç–Šå°±å¯ä»¥ä¸¦è¡Œå›æ”¾ã€‚&lt;/p>
&lt;p>å¯¦ç¾æ–¹å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å®šç¾©ä¸€å€‹è®Šé‡ &lt;code>last_lwm_timestamp&lt;/code>ï¼šç‚ºä¸€å€‹å·²ç¶“å®Œæˆå›æ”¾ Transaction çš„ sequence_number ï¼Œè©² Transaction å…¶ sequence_number ä¹‹å‰çš„æ‰€æœ‰ Transaction éƒ½å·²ç¶“ commitã€‚&lt;/li>
&lt;li>ç•¶ coordinator ç·šç¨‹è®€å–ä¸€å€‹ Transaction çš„ last_committedï¼š
&lt;ul>
&lt;li>
&lt;p>ç•¶ &lt;code>last_committed&lt;/code> &amp;lt; &lt;code>last_lwm_timestamp&lt;/code> è¡¨ç¤º Lock interval æœ‰äº¤é›†ï¼Œå› æ­¤å¯ä»¥ä¸Ÿçµ¦ work ç·šç¨‹ä¸¦è¡Œå›æ”¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> Trx1 -----L---------C------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx2 ----------L---------C-------&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç•¶ &lt;code>last_committed&lt;/code> = &lt;code>last_lwm_timestamp&lt;/code> é›–ç„¶ Lock interval æ²’æœ‰äº¤é›†ï¼Œä½†æ˜¯è©²æƒ…æ³è¡¨ç¤ºå‰ä¸€å€‹ Transaction å®Œæˆï¼Œæ‰€ä»¥ç•¶å‰ Transaction æ‰æœƒæ‹¿åˆ°å‰ä¸€å€‹çš„ sequence_number ä½œç‚ºè‡ªå·±çš„ last_commitedï¼Œè€Œ &lt;code>last_lwm_timestamp&lt;/code> æ˜¯å·²ç¶“ commit çš„ Transactionï¼Œå› æ­¤å¯ä»¥ä¸Ÿçµ¦ work ç·šç¨‹å›æ”¾äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> Trx1 -----L----C-----------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx2 ----------L---------C-------&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç•¶ &lt;code>last_committed&lt;/code> &amp;gt; &lt;code>last_lwm_timestamp&lt;/code> è¡¨ç¤º Lock interval æ²’æœ‰äº¤é›†ï¼Œå› æ­¤ä¸èƒ½ä¸Ÿçµ¦ work ç·šç¨‹ä¸¦è¡Œå›æ”¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> Trx1 -----L----C-----------------&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Trx2 ---------------L----C-------&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="commit-parent-based-vs-lock-based--èˆ‰ä¾‹">Commit Parent Based VS Lock Based èˆ‰ä¾‹
&lt;/h4>&lt;p>å‡è¨­æœ‰ä»¥ä¸‹ binlogï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/Commit-vs-Lock-Binlog-example.png"
width="755"
height="282"
srcset="https://FuweaY.github.io/p/mysql-mts/Commit-vs-Lock-Binlog-example_hu_f5f40e55cf9bafe5.png 480w, https://FuweaY.github.io/p/mysql-mts/Commit-vs-Lock-Binlog-example_hu_3613004070a757c1.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="267"
data-flex-basis="642px"
>&lt;/p>
&lt;p>åœ¨ Commit Parent Based ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>sequence_number 1~7 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚&lt;/li>
&lt;li>sequence_number 8 çš„ Transaction å…¶ last_committed æ˜¯ 1ï¼Œæ‰€ä»¥ä¸èƒ½å’Œ sequence_number 1~7ä¸€èµ·åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚
*å‚™è¨»ï¼šåœ¨ Commit Parent Based ä¸‹ï¼Œæ­£ç¢ºçš„ last_committed æ‡‰è©²è¦æ˜¯ 7ï¼Œæ­¤è™•åƒ…æ–¹ä¾¿èˆ‰ä¾‹ä½¿ç”¨ Lock Based èˆ‰ä¾‹ã€‚&lt;/li>
&lt;li>sequence_number 9&lt;del>14 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 7ï¼Œä¸èƒ½å’Œ sequence_number 1&lt;/del>8 ä¸€èµ·åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨ Lock Based ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>sequence_number 1&lt;del>7 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 0 è¡¨ç¤ºç‚ºåŒä¸€å€‹ Groupï¼Œæ‰€ä»¥ 1&lt;/del>7 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚&lt;/li>
&lt;li>sequence_number 8 çš„ last_committed = 1ï¼Œè¡¨ç¤º 8 å’Œ 1&lt;del>7 çš„é–ä¸è¡çªï¼Œå› æ­¤ 1&lt;/del>8 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾ã€‚&lt;/li>
&lt;li>sequence_number 9&lt;del>14 çš„ Transaction å…¶ last_committed éƒ½æ˜¯ 7 è¡¨ç¤ºç‚ºåŒä¸€å€‹ Groupï¼ŒåŒæ™‚ 8&lt;/del>14 çš„é–ä¸è¡çªï¼Œå› æ¬¡ 8~14 å¯åœ¨ replica ä¸¦è¡Œå›æ”¾&lt;/li>
&lt;/ul>
&lt;h4 id="ç¼ºé™·">ç¼ºé™·
&lt;/h4>&lt;p>åŸºæ–¼ Group Commit çš„ MTS ä¸è«–æ˜¯ Commit Parent Based é‚„æ˜¯ Lock Based éƒ½ä¸€æ¨£ï¼Œéƒ½æ˜¯åªæœ‰åœ¨ Source ä¸Šæ¯å€‹ Group çš„ Transaction è¶³å¤ å¤šï¼Œä¹Ÿå°±æ˜¯ä½µç™¼åº¦å¤ é«˜çš„æƒ…æ³ä¸‹æ‰èƒ½åœ¨ Replica ä¸Šæœ‰è¼ƒå¥½çš„ä¸¦è¡Œå›æ”¾æ•ˆç‡ã€‚&lt;/p>
&lt;p>é›–ç„¶åœ¨ 5.7 æ–°å¢ &lt;code>binlog_group_commit_sync_delay&lt;/code>ã€&lt;code>binlog_group_commit_sync_no_delay_count&lt;/code>é€™ 2 å€‹è¨­å®šï¼Œå¯ä»¥è®“ä¸€å€‹ Group æœ‰æ›´å¤šçš„ Transactionï¼Œç„¶è€Œæ•ˆæœä»ç„¶ååˆ†æœ‰é™ã€‚&lt;/p>
&lt;h3 id="åŸºæ–¼-writeset-çš„-mts-572280">åŸºæ–¼ WriteSet çš„ MTS (5.7.22ã€8.0)
&lt;/h3>&lt;p>MySQL 5.7 é›–ç„¶é€é Group Commit å„ªåŒ–äº† MTSï¼Œä½†é€™ä¸»è¦æ˜¯å„ªåŒ–åœ¨ Master ä¸Šæœ‰é«˜ä¸¦è¡Œåº¦çš„æƒ…æ³ä¸‹ï¼Œå¦‚æœ Master ä¸¦è¡Œåº¦ä¸é«˜å‰‡åŒä¸€å€‹ Group çš„ Event ç›¸å°å°‘ï¼Œå› æ­¤ Slave å›æ”¾é€Ÿåº¦ç„¡æ³•æœ‰æ•ˆåŠ å¿«ã€‚&lt;/p>
&lt;p>åœ¨ 8.0 ç‚ºäº†è§£æ±ºä¸Šè¿°å•é¡Œï¼Œå³ä½¿åœ¨ Source ä¸Šæ˜¯ä¸²è¡Œ commit çš„ Transactionï¼Œåªè¦äº’ç›¸ä¸è¡çªé‚£éº¼åœ¨ Replica ä¸Šå°±èƒ½ä¸¦è¡Œå›æ”¾ã€‚&lt;/p>
&lt;p>åœ¨ 8.0 æ–°å¢äº† &lt;code>binlog_transaction_dependency_tracking&lt;/code> é€™å€‹åƒæ•¸ä¾†æ§åˆ¶ binlog å¯«å…¥ç›¸é—œè³‡è¨Šï¼Œè®“ Replica æ“šæ­¤é€²è¡Œä¸¦è¡Œå›æ”¾ï¼Œæœ‰ä»¥ä¸‹ä¸‰å€‹å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>COMMIT_ORDERï¼šä½¿ç”¨ 5.7 Group commit çš„æ–¹å¼åˆ¤æ–·ã€‚&lt;/li>
&lt;li>WRITESETï¼šä½¿ç”¨ WriteSet çš„æ–¹å¼åˆ¤æ–· Transaction æ˜¯å¦æœ‰è¡çªã€‚&lt;/li>
&lt;li>WRITESET_SESSIONï¼šWRITESET çš„åŸºç¤ä¸Šä¿è­‰åŒä¸€å€‹ session å…§çš„ Transaction ä¸å¯ä¸¦è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="writeset-ç°¡è¿°">WriteSet ç°¡è¿°
&lt;/h4>&lt;p>&lt;code>WriteSet&lt;/code> åœ¨ MySQL Group Replication(MGR) ä¸­å°±å·²ç¶“å¯¦ç¾äº†ï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/MySQL-Group-Replication-Protocol.png"
width="725"
height="328"
srcset="https://FuweaY.github.io/p/mysql-mts/MySQL-Group-Replication-Protocol_hu_e322ba252aa71e47.png 480w, https://FuweaY.github.io/p/mysql-mts/MySQL-Group-Replication-Protocol_hu_21b180ab73ce6bc5.png 1024w"
loading="lazy"
alt="MySQL Group Replication Protocol"
class="gallery-image"
data-flex-grow="221"
data-flex-basis="530px"
>&lt;/p>
&lt;p>&lt;strong>MySQL Group Replication Protocol&lt;/strong>&lt;/p>
&lt;p>ä½¿ç”¨çš„åœ°æ–¹æ˜¯ certify éšæ®µç”¨ä¾†åˆ¤æ–· Transaction æ˜¯å¦å…è¨± commitï¼Œé€™å€‹æ™‚å€™å°±æœƒé€é &lt;code>WriteSet&lt;/code> ä¾†åˆ¤æ–·æ˜¯å¦å’Œå…¶ä»– member ä¸Šçš„ Transaction æœ‰è¡çªã€‚&lt;/p>
&lt;blockquote>
&lt;p>ğŸ’¡ å› ç‚º MGR å¯ä»¥åœ¨å¤šå€‹ member ä¸Šå¯«å…¥ï¼Œå› æ­¤ä¸åƒå–®æ©Ÿæ¨¡å¼å¯ä»¥é€é Lock è¡çªä¾†é¿å… Transaction ä¹‹é–“çš„è¡çªï¼ŒåŒæ™‚ç‚ºäº†æé«˜æ•ˆèƒ½ MGR æ¡ç”¨æ¨‚è§€çš„æ–¹å¼ä¸é€éå…¶ä»–æ–¹å¼é¡å¤–åŠ é–ï¼Œåªæœ‰æº–å‚™ commit çš„æ™‚å€™é€é &lt;code>WriteSet&lt;/code> åˆ¤æ–· member ä¹‹é–“çš„ Transaction æ˜¯å¦è¡çªã€‚&lt;/p>&lt;/blockquote>
&lt;h4 id="writeset-æ‡‰ç”¨åˆ°-mts-ç°¡è¿°">WriteSet æ‡‰ç”¨åˆ° MTS ç°¡è¿°
&lt;/h4>&lt;p>å‡è¨­åœ¨ Source ä¸Š Transaction commit æ™‚é–“è»¸å¦‚ä¸‹ï¼ŒåŒä¸€å€‹æ™‚é–“åªæœ‰ 1~2 å€‹ Transactionï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/WriteSet-Master-Exe.png"
width="648"
height="380"
srcset="https://FuweaY.github.io/p/mysql-mts/WriteSet-Master-Exe_hu_4b68f14e9e9e9c30.png 480w, https://FuweaY.github.io/p/mysql-mts/WriteSet-Master-Exe_hu_d08660c747a2776c.png 1024w"
loading="lazy"
alt="Source åŸ·è¡Œç‹€æ³"
class="gallery-image"
data-flex-grow="170"
data-flex-basis="409px"
>&lt;/p>
&lt;p>ä¸Šé€”ä¸­æ–¹å¡Šå°æ‡‰ Transaction ä¿®æ”¹çš„è³‡æ–™ç¯„åœï¼Œå¦‚æœæ²’æœ‰é‡ç–Šè¡¨ç¤º Transaction ä¹‹é–“ä¿®æ”¹çš„æ•¸æ“šä¸è¡çªï¼Œé‚£éº¼é€é WriteSet åˆ¤æ–· Transaction ä¹‹é–“æ˜¯å¦è¡çªå¾Œï¼Œå°±å¯ä»¥åœ¨ Replicaä¸Šå¦‚ä¸‹ä¸¦è¡Œï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/WriteSet-MTS.png"
width="632"
height="370"
srcset="https://FuweaY.github.io/p/mysql-mts/WriteSet-MTS_hu_86231a346efed00b.png 480w, https://FuweaY.github.io/p/mysql-mts/WriteSet-MTS_hu_be99f3b638c3b1d0.png 1024w"
loading="lazy"
alt="åŸºæ–¼ WriteSet çš„ MTS å›æ”¾ç‹€æ³"
class="gallery-image"
data-flex-grow="170"
data-flex-basis="409px"
>&lt;/p>
&lt;p>ä¸éä¸Šåœ–æœ‰å€‹å°å•é¡Œæ˜¯å¯èƒ½ç™¼ç”Ÿ T3 æ¯” T2 æ—©åŸ·è¡Œçš„ç‹€æ³ï¼Œå°è‡´ Source å’Œ Replica ä¸­åŒä¸€å€‹ session ç”¢ç”Ÿæœ‰ä¸åŒçš„åŸ·è¡Œç´€éŒ„ï¼Œå¦‚æœè©•ä¼°å¾Œè¦ºå¾—ä¸å¯æ¥å—æœ‰ä»¥ä¸‹ 2 å€‹æ–¹å¼å¯ä»¥è§£æ±ºï¼š&lt;/p>
&lt;ul>
&lt;li>slave_preserve_commit_order = ON&lt;/li>
&lt;li>binlog_transaction_dependency_tracking = WRITESET_SESSION&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/slave-preserve-commit-order-on.png"
width="643"
height="385"
srcset="https://FuweaY.github.io/p/mysql-mts/slave-preserve-commit-order-on_hu_e87cd167b19860.png 480w, https://FuweaY.github.io/p/mysql-mts/slave-preserve-commit-order-on_hu_24a9cbd16fb7acf6.png 1024w"
loading="lazy"
alt="åŸºæ–¼ WRITESET_SESSION æˆ– slave_preserve_commit_order = ON è¨­å®šå¾Œ MTS å›æ”¾ç‹€æ³"
class="gallery-image"
data-flex-grow="167"
data-flex-basis="400px"
>&lt;/p>
&lt;p>å¦‚ä¸Šåœ–èª¿æ•´å¾Œå¯ä»¥ç™¼ç¾åŒä¸€å€‹ session çš„éƒ½ä¸èƒ½ä¸¦è¡Œå›æ”¾ã€‚&lt;/p>
&lt;h4 id="å¯¦ç¾æ–¹å¼">å¯¦ç¾æ–¹å¼
&lt;/h4>&lt;h3 id="writeset-æ˜¯ä»€éº¼">WriteSet æ˜¯ä»€éº¼ï¼Ÿ
&lt;/h3>&lt;p>WriteSet æ˜¯ä¸€å€‹ hash æ•¸çµ„ï¼Œå¤§å°ç”± &lt;code>binlog_transaction_dependency_history_size&lt;/code> ä¾†æ±ºå®šã€‚&lt;/p>
&lt;p>åœ¨ InooDB ä¿®æ”¹æ•¸æ“šå¾Œï¼Œæœƒå°‡ä¿®æ”¹çš„ row æ•¸æ“šä»¥ä¸‹å…§å®¹é€²è¡Œ hash å¾Œå¯«å…¥ &lt;code>WriteSet&lt;/code>ï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/WriteSet-internal-Structure.png"
width="1080"
height="61"
srcset="https://FuweaY.github.io/p/mysql-mts/WriteSet-internal-Structure_hu_4e3a3c9ac483c1d2.png 480w, https://FuweaY.github.io/p/mysql-mts/WriteSet-internal-Structure_hu_d2aceffb4048a3f4.png 1024w"
loading="lazy"
alt="WriteSet çµæ§‹"
class="gallery-image"
data-flex-grow="1770"
data-flex-basis="4249px"
>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>WriteSet ç”¢å‡ºç´°ç¯€&lt;/p>
&lt;blockquote>
&lt;p>ğŸ’¡ ç”¢ç”Ÿçš„ Hash å€¼çš„æ–¹å¼å¯ä»¥åƒè€ƒ sql/rpl_write_set_handler.cc ä¸­çš„ add_pke function
&lt;a class="link" href="https://github.com/mysql/mysql-server/blob/8.0/sql/rpl_write_set_handler.cc" target="_blank" rel="noopener"
>mysql-server/rpl_write_set_handler.cc at 8.0 Â· mysql/mysql-server Â· GitHub&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>ç¯„ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">use&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db_name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">Database&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">changed&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">show&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="k">G&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">Table&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">Create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Table&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">pk_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">pk_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_column&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db_name&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># é€éç·¨è­¯ mysqld debug åŸ·è¡ŒæŸ¥çœ‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~ -&amp;gt; tail -f /tmp/mysqld.trace
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;lt;generate_hash_pke &lt;span class="m">441&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;gt;generate_hash_pke
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;gt;Rpl_transaction_write_set_ctx::add_write_set
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;lt;Rpl_transaction_write_set_ctx::add_write_set &lt;span class="m">51&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> info: pke: PRIMARYÂ½db_nameÂ½7table_nameÂ½106Â½1&lt;span class="p">;&lt;/span> hash: &lt;span class="m">10113078337023140702&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;lt;generate_hash_pke &lt;span class="m">441&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;gt;generate_hash_pke
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;gt;Rpl_transaction_write_set_ctx::add_write_set
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &amp;lt;Rpl_transaction_write_set_ctx::add_write_set &lt;span class="m">51&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">T@6: &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> info: pke: uk_columnÂ½db_nameÂ½7table_nameÂ½107Â½1&lt;span class="p">;&lt;/span> hash: &lt;span class="m">406567197175550244&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½ä»£ç¢¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="err">å¦‚æœè¡¨ä¸­å­˜åœ¨ç´¢å¼•ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å°†æ•°æ®åº“åï¼Œè¡¨åä¿¡æ¯å†™å…¥ä¸´æ—¶å˜é‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å¾ªç¯æ‰«æè¡¨ä¸­æ¯ä¸ªç´¢å¼•ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å¦‚æœä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">é€€å‡ºæœ¬æ¬¡å¾ªç¯ç»§ç»­å¾ªç¯ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å¾ªç¯ä¸¤ç§ç”Ÿæˆæ•°æ®çš„æ–¹å¼&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">äºŒè¿›åˆ¶æ ¼å¼å’Œå­—ç¬¦ä¸²æ ¼å¼&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å°†ç´¢å¼•åå­—å†™å…¥åˆ°&lt;/span>&lt;span class="n">pkeä¸­&lt;/span>&lt;span class="err">ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å°†ä¸´æ—¶å˜é‡ä¿¡æ¯å†™å…¥åˆ°&lt;/span>&lt;span class="n">pkeä¸­&lt;/span>&lt;span class="err">ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å¾ªç¯æ‰«æç´¢å¼•ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å°†æ¯ä¸€ä¸ªå­—æ®µçš„ä¿¡æ¯å†™å…¥åˆ°&lt;/span>&lt;span class="n">pkeä¸­&lt;/span>&lt;span class="err">ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å¦‚æœå­—æ®µæ‰«æå®Œæˆï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å°†&lt;/span>&lt;span class="n">pkeç”Ÿæˆhashå€¼å¹¶ä¸”å†™å…¥åˆ°å†™é›†åˆä¸­&lt;/span>&lt;span class="err">ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸»é”®æˆ–è€…å”¯ä¸€é”®è®°å½•ä¸€ä¸ªæ ‡è®°ï¼Œåé¢é€šè¿‡è¿™ä¸ªæ ‡è®°æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">åˆ¤å®šæ˜¯å¦ä½¿ç”¨&lt;/span>&lt;span class="n">Writesetçš„å¹¶è¡Œå¤åˆ¶æ–¹å¼&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="åŸºæ–¼-writeset-çš„-mts-æ€éº¼å¯¦ç¾">åŸºæ–¼ WriteSet çš„ MTS æ€éº¼å¯¦ç¾ï¼Ÿ
&lt;/h3>&lt;p>è©²æ¨¡å¼ä¸‹ Replica åŒæ¨£æ˜¯åŸºæ–¼ Source ç”¢ç”Ÿçš„ binlog ä¸­çš„ &lt;code>last_commited&lt;/code> å’Œ &lt;code>sequenct_number&lt;/code> ä¾†æ±ºå®šæ˜¯å¦å¯ä»¥ä¸¦è¡Œå›æ”¾ï¼Œä¹Ÿå°±æ˜¯èªªå¦‚æœè¦é€²ä¸€æ­¥å¢åŠ ä¸¦è¡Œå›æ”¾çš„æ•ˆç‡ï¼Œå°±éœ€è¦ç›¡å¯èƒ½ç‚ºæ¯å€‹ Transaction æ‰¾å‡ºæ›´å°çš„ &lt;code>last_commited&lt;/code>ã€‚&lt;/p>
&lt;p>åŸºæ–¼ WriteSet çš„ MTS èƒ½æ‰¾å‡ºæ›´å°çš„ &lt;code>last_commited&lt;/code> çš„æ–¹å¼å°±æ˜¯ç¶­è­·ä¸€å€‹å…ˆå‰ Transaction æ‰€çµ„æˆçš„ WriteSet çš„æ­·å²ç´€éŒ„ï¼Œä¹‹å¾Œæ–°é€²ä¾†çš„ Transaction è¨ˆç®— WriteSet å¾Œå’Œé€™å€‹æ­·å²ç´€éŒ„é€²è¡Œè¡çªæ¯”å°ï¼Œä»¥æ­¤ä¾†å˜—è©¦æ‰¾å‡ºæ›´å°çš„ &lt;code>last_commited&lt;/code>ã€‚&lt;/p>
&lt;h4 id="binlog_transaction_dependency_tracking-ä¸åŒå°-last_commit-çš„è™•ç†">binlog_transaction_dependency_tracking ä¸åŒå° last_commit çš„è™•ç†
&lt;/h4>&lt;p>åŸºæ–¼ WriteSet çš„ MTS å¯¦éš›ä¸Šæ˜¯åŸºæ–¼ ORDER_COMMIT (Group Commit) é€²ä¸€æ­¥è™•ç†è€Œå·²ã€‚&lt;/p>
&lt;p>æ ¹æ“š binlog_transaction_dependency_tracking çš„è¨­å®šä¸åŒï¼Œåœ¨ Source code æœ‰å¦‚ä¸‹å…§å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span> &lt;span class="nl">DEPENDENCY_TRACKING_COMMIT_ORDER&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_commit_order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_dependency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span> &lt;span class="nl">DEPENDENCY_TRACKING_WRITESET&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_commit_order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_dependency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_dependency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span> &lt;span class="nl">DEPENDENCY_TRACKING_WRITESET_SESSION&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_commit_order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_dependency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_dependency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset_session&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_dependency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°å¾ COMMIT_ORDER åˆ° WRITESET å†åˆ° WRITESET_SESSION å…¶å¯¦éƒ½æ˜¯ä»¥ä¸Šä¸€å€‹è¨­å®šçš„ç‚ºåŸºç¤é€²ä¸€æ­¥é€éä¸€å€‹æ–°çš„ function é€²è¡Œä¿®æ”¹è€Œå·²ï¼Œé€™äº› function ä¿®æ”¹çš„æ˜¯ &lt;code>last_commited&lt;/code> å€¼ã€‚&lt;/p>
&lt;h4 id="writeset-æ­·å²ç´€éŒ„è©³è§£">WriteSet æ­·å²ç´€éŒ„è©³è§£
&lt;/h4>&lt;p>WriteSet çš„æ­·å²ç´€éŒ„åŒ…å«äº† 2 å€‹å…ƒç´ ï¼š&lt;/p>
&lt;ul>
&lt;li>WriteSet çš„ Hash å€¼&lt;/li>
&lt;li>æœ€å¾Œä¸€æ¬¡ä¿®æ”¹è©²è¡Œçš„ Transaction å…¶ &lt;code>sequence_number&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> Track the last transaction sequence number that changed each row
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> in the database, using row hashes from the writeset as the index.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">typedef&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">uint64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">int64&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">Writeset_history&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//mapå®ç°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">Writeset_history&lt;/span> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦å¤– &lt;code>binlog_transaction_dependency_history_size&lt;/code> æ±ºå®šäº†å¯ä»¥å„²å­˜å¹¾çµ„ç´€éŒ„ï¼Œå…§éƒ¨æœƒä¾ç…§ WriteSet Hash å€¼é€²è¡Œæ’åºã€‚&lt;/p>
&lt;p>å¦‚æœ WriteSet çš„æ­·å²ç´€éŒ„é”åˆ° &lt;code>binlog_transaction_dependency_history_size&lt;/code> è¨­å®šçš„å€¼å°±æœƒå°‡æ­·å²ç´€éŒ„æ¸…ç©ºï¼Œä¸¦ä¸”æœ¬æ¬¡çš„ Transaction æœƒæˆç‚ºæ¸…ç©ºå¾Œæ­·å²ç´€éŒ„çš„ç¬¬ä¸€ç­†ç´€éŒ„ã€‚&lt;/p>
&lt;p>å¦å¤–é™¤äº†æ­·å²ç´€éŒ„é‚„æœ‰æœ‰ä¸€å€‹ &lt;code>m_writeset_history_start&lt;/code> çš„å€¼ï¼Œç”¨ä¾†å„²å­˜é€™å€‹æ­·å²ç´€éŒ„ä¸­çš„æœ€å° &lt;code>sequence_number&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">exceeds_capacity&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">can_use_writesets&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//Writesetçš„å†å²MAPå·²æ»¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset_history_start&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¦‚æœè¶…è¿‡æœ€å¤§è®¾ç½®ï¼Œæ¸…ç©ºwriteset historyã€‚ä»å½“å‰seq number é‡æ–°è®°å½•ï¼Œ ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªäº‹åŠ¡seq number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clear&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ¸…ç©ºå†å²MAP
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="writeset-mts-å°-last_commit-çš„è™•ç†æµç¨‹">WriteSet MTS å° last_commit çš„è™•ç†æµç¨‹
&lt;/h4>&lt;p>é€™è£¡é€éä¸€å€‹ä¾‹å­è§£é‡‹ï¼Œå‡è¨­å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç•¶å‰çš„ Transaction åŸºæ–¼ ORDER_COMMIT (Group Commit) çš„æ–¹å¼ç”¢ç”Ÿäº†çµæœï¼š
&lt;ul>
&lt;li>last_commit = 125&lt;/li>
&lt;li>sequence_number = 130&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è©² Transaction ä¿®æ”¹çš„è¡¨åªæœ‰ PK æ²’æœ‰ UKã€‚&lt;/li>
&lt;li>è©² Transaction ä¿®æ”¹äº† 4 è¡Œè³‡æ–™ï¼Œåˆ†åˆ¥ç‚º ROW1ã€ROW7ã€ROW6ã€ROW10ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸‹åœ–å±•ç¤ºäº†è©² Transaction å’Œ WriteSet æ­·å²ç´€éŒ„ï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/WriteSet-search-lastCommit.png"
width="1120"
height="1069"
srcset="https://FuweaY.github.io/p/mysql-mts/WriteSet-search-lastCommit_hu_615814ac450fa60f.png 480w, https://FuweaY.github.io/p/mysql-mts/WriteSet-search-lastCommit_hu_d78a2671fa2b38d4.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="104"
data-flex-basis="251px"
>&lt;/p>
&lt;p>æ¥ä¸‹ä¾†å°±æœƒé€é WriteSet æ–¹å¼æ‰¾åˆ°æ›´å°çš„ last_commitï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å°‡ last_commit ç”± 125 èª¿æ•´ç‚º 100 (æ­·å²ç´€éŒ„ä¸­æœ€å°çš„ sequence_number &lt;code>m_writeset_history_start&lt;/code>)ã€‚&lt;/p>
&lt;p>å‚™è¨»ï¼šå› ç‚ºè©² Transaction æ¯”æ­·å²ç´€éŒ„ä¸­çš„ Transaction æ™šåŸ·è¡Œï¼Œå› æ­¤ last_commit ä¸€å®šéƒ½æ¯”ä»–å€‘çš„ sequence_number å¤§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°‡ ROW1 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š&lt;/p>
&lt;ul>
&lt;li>å°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 120 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚&lt;/li>
&lt;li>å°‡è©² Transaction çš„ last_commit ç”± 100 èª¿æ•´ç‚º 120ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å°‡ ROW7 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š&lt;/p>
&lt;ul>
&lt;li>å°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 114 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚&lt;/li>
&lt;li>ç•¶å‰ Transaction ç•¶å‰ last_commit ç‚º 120 æ¯”æ­·å²ç´€éŒ„ä¸­çš„ 114 å¤§ï¼Œå› ç‚ºåœ¨ 120 å°±è¡çªäº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹æˆæ›´å°çš„ 114ï¼Œå› æ­¤ last_commit ä¸è®Šä¾èˆŠæ˜¯ 120ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å°‡ ROW6 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š&lt;/p>
&lt;ul>
&lt;li>å°‡æ­·å²ç´€éŒ„ä¸­è©²è¡Œçš„ sequence_number ç”± 105 (æ­·å²ç´€éŒ„å€¼) èª¿æ•´ç‚º 130(è©² Transaction)ã€‚&lt;/li>
&lt;li>ç•¶å‰ Transaction ç•¶å‰ last_commit ç‚º 120 æ¯”æ­·å²ç´€éŒ„ä¸­çš„ 105 å¤§ï¼Œå› ç‚ºåœ¨ 120 å°±è¡çªäº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹æˆæ›´å°çš„ 105ï¼Œå› æ­¤ last_commit ä¸è®Šä¾èˆŠæ˜¯ 120ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å°‡ ROW10 çš„ Hash å€¼åœ¨ WriteSet æ­·å²ç´€éŒ„ä¸­ç¢ºèªï¼Œç™¼ç¾ä¸¦æ²’æœ‰ä¿®æ”¹ç›¸åŒç´€éŒ„çš„ Transactionï¼š&lt;/p>
&lt;ul>
&lt;li>å› ç‚ºæ²’æœ‰æ‰¾åˆ°ç›¸åŒçš„ WriteSetï¼Œå› æ­¤éœ€è¦æŠŠè©² Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number å¯«å…¥ WriteSet æ­·å²ç´€éŒ„ã€‚
&lt;ul>
&lt;li>å¦‚æœæ­·å²ç´€éŒ„å¤§å°è¶…é &lt;code>binlog_transaction_dependency_history_size&lt;/code>ï¼Œå‰‡æ¸…ç©ºç•¶å‰æ­·å²ç´€éŒ„ï¼Œéš¨å¾Œå°‡ Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number(130) å¯«å…¥ WriteSet æ–°çš„æ­·å²ç´€éŒ„ï¼Œä¸¦å°‡ &lt;code>m_writeset_history_start&lt;/code> æ”¹ç‚º 130ã€‚&lt;/li>
&lt;li>å¦‚æœæ­·å²ç´€éŒ„å¤§å°æ²’æœ‰è¶…é &lt;code>binlog_transaction_dependency_history_size&lt;/code>ï¼Œå°‡ Transaction ROW10 çš„ Hast å€¼å’Œ sequence_number(130) å¯«å…¥ WriteSet ç•¶å‰æ­·å²ç´€éŒ„ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>æ•´å€‹éç¨‹çµæŸï¼Œè©² Transaction çš„ last_commit ç”±åŸæœ¬çš„ 125 é™ä½ç‚º 120ï¼Œæœ€å¾Œçµæœå¦‚ä¸‹åœ–ï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/WriteSet-Change-lastCommit.png"
width="1117"
height="1104"
srcset="https://FuweaY.github.io/p/mysql-mts/WriteSet-Change-lastCommit_hu_5ae3d1b1f4d24fcd.png 480w, https://FuweaY.github.io/p/mysql-mts/WriteSet-Change-lastCommit_hu_35d7a891f6ed0d5f.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="101"
data-flex-basis="242px"
>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è©²éç¨‹åœ¨ Function &lt;code>Writeset_trx_dependency_tracker::get_dependency&lt;/code> ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">can_use_writesets&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//å¦‚æœèƒ½å¤Ÿä½¿ç”¨writeset æ–¹å¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> Check if adding this transaction exceeds the capacity of the writeset
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> history. If that happens, m_writeset_history will be cleared only after è€Œ add_pke
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> using its information for current transaction.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">exceeds_capacity&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">writeset&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">m_opt_max_history_size&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¦‚æœå¤§äºå‚æ•°binlog_transaction_dependency_history_sizeè®¾ç½®æ¸…ç†æ ‡è®°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> Compute the greatest sequence_number among all conflicts and add the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> transaction&amp;#39;s row hashes to the history.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">int64&lt;/span> &lt;span class="n">last_parent&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">m_writeset_history_start&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//ä¸´æ—¶å˜é‡ï¼Œé¦–å…ˆè®¾ç½®ä¸ºæœ€å°çš„ä¸€ä¸ªseq number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">uint64&lt;/span>&lt;span class="o">&amp;gt;::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">it&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">writeset&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">it&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">writeset&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¾ªç¯æ¯ä¸€ä¸ªWritesetä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Writeset_history&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">hst&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ˜¯å¦åœ¨writeset historyä¸­ å·²ç»å­˜åœ¨äº†ã€‚ mapä¸­çš„å…ƒç´ æ˜¯ keyæ˜¯writeset å€¼æ˜¯sequence number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hst&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="c1">//å¦‚æœå­˜åœ¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hst&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">last_parent&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">hst&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">last_parent&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">hst&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">second&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¦‚æœå·²ç»å¤§äºäº†ä¸éœ€è¦è®¾ç½®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">hst&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">second&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ›´æ”¹è¿™è¡Œè®°å½•çš„sequence_number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">exceeds_capacity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">uint64&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">int64&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ²¡æœ‰å†²çªåˆ™æ’å…¥ã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">write_set_ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_has_missing_keys&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¦‚æœæ²¡æœ‰ä¸»é”®å’Œå”¯ä¸€é”®é‚£ä¹ˆä¸æ›´æ”¹last commit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> The WRITESET commit_parent then becomes the minimum of largest parent
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> found using the hashes of the row touched by the transaction and the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> commit parent calculated with COMMIT_ORDER.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="err">ï¼›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">commit_parent&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">last_parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è¿™é‡Œå¯¹last commitåšæ›´æ”¹äº†ã€‚é™ä½ä»–çš„last commit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">exceeds_capacity&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">can_use_writesets&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_writeset_history_start&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¦‚æœè¶…è¿‡æœ€å¤§è®¾ç½® æ¸…ç©ºwriteset historyã€‚ä»å½“å‰sequence é‡æ–°è®°å½• ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªäº‹åŠ¡seqnuce number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">m_writeset_history&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clear&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="c1">//æ¸…ç©ºçœŸä¸ªMAP
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="writeset_session-æ€éº¼åš">WRITESET_SESSION æ€éº¼åš?
&lt;/h4>&lt;p>å‰é¢æœ‰æåˆ°é WRITESET_SESSION æ˜¯åŸºæ–¼ WRITESET çš„åŸºç¤ä¸Šç¹¼çºŒè™•ç†çš„ï¼ŒWRITESET_SESSION è¦åšåˆ°çš„æ˜¯åŒä¸€å€‹ session çš„ Transaction ä¸èƒ½åœ¨ Replica ä¸¦è¡Œå›æ”¾ï¼Œè¦å¯¦ç¾éå¸¸ç°¡å–®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="n">int64&lt;/span> &lt;span class="n">session_parent&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">thd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">rpl_thd_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">dependency_tracker_ctx&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">get_last_session_sequence_number&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å–æœ¬sessionçš„ä¸Šä¸€æ¬¡äº‹åŠ¡çš„seq number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">session_parent&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">session_parent&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">sequence_number&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å¦‚æœæœ¬sessionå·²ç»åšè¿‡äº‹åŠ¡å¹¶ä¸”æœ¬æ¬¡å½“å‰çš„seq numberå¤§äºä¸Šä¸€æ¬¡çš„seq number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">commit_parent&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">commit_parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">session_parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è¯´æ˜è¿™ä¸ªsessionåšè¿‡å¤šæ¬¡äº‹åŠ¡ä¸å…è®¸å¹¶å‘ï¼Œä¿®æ”¹ä¸ºorder_commitç”Ÿæˆçš„last commit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">thd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">rpl_thd_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">dependency_tracker_ctx&lt;/span>&lt;span class="p">().&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_last_session_sequence_number&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sequence_number&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è®¾ç½®session_parentçš„å€¼ä¸ºæœ¬æ¬¡seq numberçš„å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="é—œæ–¼-binlog_transaction_dependency_history_size-åƒæ•¸èªªæ˜">é—œæ–¼ binlog_transaction_dependency_history_size åƒæ•¸èªªæ˜
&lt;/h4>&lt;p>è©²åƒæ•¸é»˜èªå€¼ç‚º 25000ï¼Œä»£è¡¨çš„æ˜¯ WriteSet è£¡å…ƒç´ çš„æ•¸é‡ã€‚&lt;/p>
&lt;p>å¾å‰é¢ WriteSet å¯¦ç¾ç´°ç¯€èªªæ˜ä¸­æˆ‘å€‘å¯ä»¥çŸ¥é“ä¿®æ”¹ä¸€è¡Œæ•¸æ“šå¯èƒ½æœƒç”¢ç”Ÿå¤šå€‹ Hashï¼Œæ‰€ä»¥é€™å€‹å€¼ä¸æœƒç­‰æ–¼ä¿®æ”¹çš„è¡Œæ•¸ï¼Œå¯ä»¥ç†è§£ç‚ºå¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>5.7 ç‰ˆæœ¬ï¼šbinlog_transaction_dependency_history_size = ä¿®æ”¹çš„è¡Œæ•¸ * ( 1 + UK æ•¸é‡ ) * 2&lt;/li>
&lt;li>8.0 ç‰ˆæœ¬ï¼šbinlog_transaction_dependency_history_size = ä¿®æ”¹çš„è¡Œæ•¸ * ( 1 + UK æ•¸é‡ )&lt;/li>
&lt;/ul>
&lt;p>å‚™è¨»ï¼šä¸åŒåŸå› åœ¨æ–¼ 5.7 æœƒç”ŸæˆåŒ…å« collation å’Œä¸åŒ…å« collationï¼Œåœ¨ 8.0 ä¸­å‰‡æ²’æœ‰ã€‚&lt;/p>
&lt;p>å¦‚æœå°‡é€™å€‹åƒæ•¸åŠ å¤§ï¼Œé‚£éº¼ Source ä¸Šçš„ WriteSet å°±èƒ½æ”¾è¶Šå¤šçš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯èªª Transaction å¯ä»¥ç”Ÿæˆæ›´å°çš„ last_commitedï¼Œé€™åœ¨ Replica ä¸Šå°±èƒ½æé«˜ä¸¦è¡Œå›æ”¾çš„æ•ˆç‡ï¼Œç•¶ç„¶ç¼ºé»å°±æ˜¯åœ¨ Source æœƒæ¶ˆè€—æ›´å¤šçš„è³‡æºã€‚&lt;/p>
&lt;h4 id="writeset-ä¸é©ç”¨æƒ…å¢ƒ">WriteSet ä¸é©ç”¨æƒ…å¢ƒ
&lt;/h4>&lt;p>ä»¥ä¸‹æƒ…å¢ƒä¸é©ç”¨ WriteSetï¼ŒMySQL æœƒè‡ªå‹•é€€å›ä½¿ç”¨ commit_order (åŸºæ–¼ group commit) æ¨¡å¼&lt;/p>
&lt;ol>
&lt;li>æ²’æœ‰ PK ä¹Ÿæ²’æœ‰ UK&lt;/li>
&lt;li>DDL&lt;/li>
&lt;li>session çš„ hash ç®—æ³•æ› history ä¸åŒ&lt;/li>
&lt;li>Transaction æ›´æ–°äº†æœ‰ Forign key é—œè¯çš„æ¬„ä½&lt;/li>
&lt;/ol>
&lt;h2 id="slave_">&lt;strong>slave_preserve_commit_order ä»‹ç´¹&lt;/strong>
&lt;/h2>&lt;p>ç•¶é–‹å•Ÿ MTS ä¸” slave_parallel_type = LOGICAL_CLOCK (ä¸è«–å…·é«”æ˜¯åŸºæ–¼ commit_order é‚„æ˜¯ writeset) çš„æ™‚å€™ï¼Œæœ‰å¯èƒ½æœƒç™¼ç”Ÿ Source å’Œ Replica åŸ·è¡Œé †åºä¸åŒçš„æƒ…æ³ï¼Œé›–ç„¶é€™ä¸¦ä¸æœƒå°è‡´è³‡æ–™ä¸ä¸€è‡´çš„ç‹€æ³ï¼Œä½†æ˜¯å¯èƒ½æœƒç™¼ç”Ÿåœ¨ Source ä¸Šå…ˆçœ‹åˆ° T1 æ‰çœ‹åˆ° T2 å»åœ¨ Replica ä¸Šå»æ˜¯å…ˆçœ‹åˆ° T2 æ‰çœ‹åˆ° T1 åŸ·è¡Œï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ Source å’Œ Replica å„è‡ªçš„ binlog æ­·å²ç´€éŒ„é †åºä¹Ÿæœƒä¸ä¸€è‡´ï¼Œæ²’æœ‰ä¿è­‰ &lt;code>Causal Consistency&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ğŸ’¡ &lt;code>Causal Consistency&lt;/code> (å› æœä¸€è‡´æ€§) æ„æ€æ˜¯å¦‚æœå…©å€‹äº‹ä»¶æœ‰å› æœé—œä¿‚ï¼Œé‚£éº¼åœ¨æ‰€æœ‰ç¯€é»éƒ½å¿…é ˆèƒ½è§€æ¸¬åˆ°é€™ç¨®å› æœé—œä¿‚ã€‚&lt;/p>&lt;/blockquote>
&lt;p>å¦‚æœè©•ä¼°æ¥­å‹™éœ€è¦ä¿è­‰&lt;code>Causal Consistency&lt;/code>ï¼Œé™¤äº†ä¸ä½¿ç”¨ MTS ä½¿ç”¨å–®ç·šç¨‹ replication ä¹Ÿå¯ä»¥é€éè¨­ç½® &lt;code>slave_preserve_commit_order=ON&lt;/code> ä¾†é¿å…ï¼Œé€™æœƒè®“ Replica ä¸Šå›æ”¾çš„ Transaction åœ¨é€²å…¥ flush éšæ®µä¹‹å‰æœƒå…ˆç­‰å¾… sequence_number ä¹‹å‰çš„ Transaction å…ˆé€²å…¥ flush éšæ®µã€‚&lt;/p>
&lt;h3 id="gap">GAP
&lt;/h3>&lt;p>å¦‚æœ &lt;code>slave_preserve_commit_order = OFF&lt;/code> é™¤äº†ä¸Šé¢æåˆ° &lt;code>Causal Consistency&lt;/code> é‚„æœ‰ä¸€å€‹å•é¡Œåœ¨å®˜æ–¹æ–‡æª”ä¸­ç¨±ç‚º GAPã€‚&lt;/p>
&lt;p>é–‹å•Ÿ MTS æ™‚é€é show slave status æŸ¥çœ‹ &lt;code>Exec_Source_Log_Pos&lt;/code> æŒ‡çš„æ˜¯ &lt;code>low-watermark&lt;/code> ä¹Ÿå°±æ˜¯ä¿è­‰é€™å€‹ postition ä¹‹å‰çš„ Transaction éƒ½å·²ç¶“ commitï¼Œä½†æ˜¯è©² postition ä¹‹å¾Œçš„ Transaction æœ‰å¯èƒ½ commit ä¹Ÿå¯èƒ½æ²’æœ‰ commitï¼Œ&lt;/p>
&lt;h2 id="ç›¸é—œåƒæ•¸">ç›¸é—œåƒæ•¸
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_slave_parallel_workers" target="_blank" rel="noopener"
>slave_parallel_workers&lt;/a> (5.6 ~ 8.0.25)ã€&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_parallel_workers" target="_blank" rel="noopener"
>replica_parallel_workers&lt;/a> (8.0.26 ~)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/slave-parallel-workers.png"
width="575"
height="343"
srcset="https://FuweaY.github.io/p/mysql-mts/slave-parallel-workers_hu_4d041eb8e44d22f6.png 480w, https://FuweaY.github.io/p/mysql-mts/slave-parallel-workers_hu_ec466e839f6fe4b6.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="167"
data-flex-basis="402px"
>&lt;/p>
&lt;p>è¨­å®šè¦åœ¨ replica ä¸¦è¡Œçš„ thread æ•¸é‡ã€‚&lt;/p>
&lt;p>å¦‚æœ slave æœ‰å¤šå€‹ channelï¼Œå‰‡æ¯å€‹ channel éƒ½æœƒæœ‰æ­¤æ•¸é‡çš„ threadã€‚&lt;/p>
&lt;p>è¨­ç½®æ­¤åƒæ•¸å¾Œå¿…é ˆé‡æ–° START REPLICA æ‰æœƒç”Ÿæ•ˆã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_slave_parallel_type" target="_blank" rel="noopener"
>slave_parallel_type&lt;/a> (5.7 ~ 8.0.25)ã€&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_parallel_type" target="_blank" rel="noopener"
>replica_parallel_type&lt;/a> (8.0.26 ~ 8.0.29)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/replica-parallel-type.png"
width="574"
height="366"
srcset="https://FuweaY.github.io/p/mysql-mts/replica-parallel-type_hu_3bead051496654f6.png 480w, https://FuweaY.github.io/p/mysql-mts/replica-parallel-type_hu_1946b811ede79cec.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="156"
data-flex-basis="376px"
>&lt;/p>
&lt;p>è¨­å®šåœ¨ replica ä¸Šå…è¨±å“ªäº› Transaction ä¸¦è¡Œå›æ”¾&lt;/p>
&lt;ul>
&lt;li>DATABASEï¼šTransaction å¿…é ˆä½œç”¨æ–¼ä¸åŒ Database æ‰èƒ½ä¸¦è¡Œã€‚&lt;/li>
&lt;li>LOGICAL_CLOCKï¼šåŸºæ–¼ Source å¯«å…¥ binlog çš„ timestamp ä¾†æ±ºå®š Transaction çš„ä¸¦è¡Œï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ Group Commitã€‚&lt;/li>
&lt;/ul>
&lt;p>å»ºè­°å°‡ binlog_transaction_dependency_tracking è¨­ç½®ç‚º WRITESET æˆ– WRITESET_SESSION ï¼Œé€™æ¨£åœ¨åˆé©çš„æƒ…æ³ä¸‹æœƒèµ° WriteSet ä¾†æé«˜ä¸¦è¡Œåº¦ã€‚&lt;/p>
&lt;p>é è¨ˆ 8.0.29 ä¹‹å¾Œæ£„ç”¨æ­¤åƒæ•¸ï¼Œç¸½æ˜¯ä»¥ LOGICAL_CLOCK çš„æ–¹å¼é‹è¡Œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_group_commit_sync_delay" target="_blank" rel="noopener"
>binlog_group_commit_sync_delay&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/binlog-group-commit-sync-delay.png"
width="575"
height="313"
srcset="https://FuweaY.github.io/p/mysql-mts/binlog-group-commit-sync-delay_hu_ef403cd4f4b0234.png 480w, https://FuweaY.github.io/p/mysql-mts/binlog-group-commit-sync-delay_hu_d0b4236f64d57c5d.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="183"
data-flex-basis="440px"
>&lt;/p>
&lt;p>æ§åˆ¶ binlog commit ä¹‹å¾Œç­‰å¾… N å¾®ç§’å¾Œæ‰ fsync åˆ° Diskï¼Œè¨­ç½®è¶Šå¤§å–®å€‹ Group å¯ä»¥æœ‰æ›´å¤šæ™‚é–“ç­‰åˆ°æ›´å¤šçš„ Transaction ä¸€èµ· fsync Diskï¼Œæ¸›å°‘ fsync çš„æ¬¡æ•¸åŠæ¸›å°‘æ¯å€‹ Transaction commit çš„å–®ä½æ™‚é–“ã€‚&lt;/p>
&lt;p>æ­¤å¤–é©åº¦çš„å¢åŠ å°æ–¼ä»¥ä¸‹è¨­ç½®çš„ MTS ä¹Ÿèƒ½å¢åŠ åœ¨ Slave çš„ä¸¦è¡Œåº¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_transaction_dependency_tracking = COMMIT_ORDER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># Slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_parallel_type = LOGICAL_CLOCK
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„ï¼šæœƒå¢åŠ  server ä¸Š transaction çš„å»¶é²ï¼Œä¹Ÿå°±æ˜¯ client ç«¯æ”¶åˆ° transaction commit çš„æ™‚é–“æœƒè®Šæ™šï¼Œå¦å¤–ç›¸æ‡‰çš„æœƒå¢åŠ è³‡æºçš„ç«¶çˆ­ï¼Œå› æ­¤éœ€è©•ä¼°æœ€å¥½çš„è¨­ç½®ã€‚&lt;/p>
&lt;p>è£œå……ï¼šåœ¨æœ‰ Group Commit ä¹‹å¾Œï¼Œsync_binlog çš„å–®ä½æŒ‡çš„æ˜¯ Group è€Œä¸æ˜¯ Transactionï¼Œä¾‹å¦‚ï¼šsync_binlog = 1000ï¼Œè¡¨ç¤ºçš„ä¸æ˜¯æ¯ 1000 å€‹ Transaction å°± sync binlogï¼Œè€Œæ˜¯æ¯ 1000 å€‹ Group æ‰ sync binlogã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_group_commit_sync_no_delay_count" target="_blank" rel="noopener"
>binlog_group_commit_sync_no_delay_count&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/binlog-group-commit-sync-no-delay-count.png"
width="575"
height="285"
srcset="https://FuweaY.github.io/p/mysql-mts/binlog-group-commit-sync-no-delay-count_hu_31a81363cebe4293.png 480w, https://FuweaY.github.io/p/mysql-mts/binlog-group-commit-sync-no-delay-count_hu_4454de47c2d58f5c.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="201"
data-flex-basis="484px"
>&lt;/p>
&lt;p>åœ¨ Group commit ä¸­ç­‰å¾…çš„ N å€‹ Transaction å¾Œå°±ä¸ç­‰å¾… binlog_group_commit_sync_delay è¨­ç½®çš„æ™‚é–“ç›´æ¥é–‹å§‹ sync binlogã€‚&lt;/p>
&lt;p>ç•¶ binlog_group_commit_sync_delay = 0 ï¼Œæ­¤åƒæ•¸ç„¡æ•ˆã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_slave_preserve_commit_order" target="_blank" rel="noopener"
>slave_preserve_commit_order&lt;/a> (5.7 ~ 8.0.25)ã€&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_preserve_commit_order" target="_blank" rel="noopener"
>replica_preserve_commit_order&lt;/a> (8.0.26 ~)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/slave-preserve-commit-order.png"
width="576"
height="281"
srcset="https://FuweaY.github.io/p/mysql-mts/slave-preserve-commit-order_hu_850124080f73874.png 480w, https://FuweaY.github.io/p/mysql-mts/slave-preserve-commit-order_hu_59b2b2377aa92ade.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="204"
data-flex-basis="491px"
>&lt;/p>
&lt;p>åªæœ‰ç•¶ slave_parallel_type = LOGICAL_CLOCK ä¸” log-slave-updates é–‹å•Ÿæ™‚æ‰èƒ½è¨­ç½®ã€‚&lt;/p>
&lt;p>ç•¶è¨­ç½®ç‚º 0 æˆ– OFF æ™‚ï¼Œåœ¨ Replica ä¸Šçš„è®€å–æ“ä½œç„¡æ³•æ»¿è¶³ &lt;code>Causal Consistency&lt;/code> ï¼Œåœ¨ Source å’Œ Replica ä¸Š Transaction åœ¨ binlog ä¸­å¯èƒ½æœ‰ä¸åŒçš„å¯«å…¥é †åºï¼Œå¦å¤–åœ¨æª¢æŸ¥ Replica ä¸Šæœ€è¿‘åŸ·è¡Œçš„ Transaction ç„¡æ³•ä¿è­‰å°æ‡‰åˆ° Source ä¸Šè©² Transaction ä½ç½®ä¹‹å‰çš„ Transaction éƒ½å·²ç¶“åŸ·è¡Œå®Œç•¢ã€‚&lt;/p>
&lt;p>è¨­ç½®ç‚º 1 æˆ– ON ç¢ºä¿ Transaction åœ¨åŸ·è¡Œæ™‚æŒ‰ç…§åœ¨ relay log ä¸­çš„é †åºï¼Œé€™å¯ä»¥è®“ Master å’Œ Replica æœ‰ç›¸åŒçš„ Transaction history logï¼Œä¹Ÿå°±æ˜¯ç¬¦åˆ &lt;code>Causal Consistency&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_transaction_dependency_tracking" target="_blank" rel="noopener"
>binlog_transaction_dependency_tracking&lt;/a> (5.7.22 ~)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/binlog-transaction-dependency-tracking.png"
width="575"
height="298"
srcset="https://FuweaY.github.io/p/mysql-mts/binlog-transaction-dependency-tracking_hu_706dc27ebec643cc.png 480w, https://FuweaY.github.io/p/mysql-mts/binlog-transaction-dependency-tracking_hu_3fd8ed4baf5eeb2c.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="192"
data-flex-basis="463px"
>&lt;/p>
&lt;p>æŒ‡å®š Source ä¾æ“šä»€éº¼æ–¹å¼ä¾†ç”Ÿæˆ Transaction ä¹‹é–“çš„ä¾è³´é—œä¿‚å¯«å…¥ binlogï¼Œå”åŠ© Replica ç¢ºå®šé‚£äº› Transaction èƒ½å¤ ä¸¦è¡ŒåŸ·è¡Œã€‚&lt;/p>
&lt;p>å¿…é ˆè¨­ç½® replica_parallel_type ç‚º LOGICAL_CLOCKã€‚&lt;/p>
&lt;p>æœ‰ä»¥ä¸‹ä¸‰ç¨®å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>COMMIT_ORDERï¼šä½¿ç”¨ 5.7 Group commit çš„æ–¹å¼åˆ¤æ–·ã€‚&lt;/li>
&lt;li>WRITESETï¼šä½¿ç”¨ WriteSet çš„æ–¹å¼åˆ¤æ–· Transaction æ˜¯å¦æœ‰è¡çªã€‚&lt;/li>
&lt;li>WRITESET_SESSIONï¼šWRITESET çš„åŸºç¤ä¸Šä¿è­‰åŒä¸€å€‹ session å…§çš„ Transaction ä¸å¯ä¸¦è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_binlog_transaction_dependency_history_size" target="_blank" rel="noopener"
>binlog_transaction_dependency_history_size&lt;/a> (8.0 ~)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/binlog-transaction-dependency-history.png"
width="573"
height="281"
srcset="https://FuweaY.github.io/p/mysql-mts/binlog-transaction-dependency-history_hu_1415df38253b7d55.png 480w, https://FuweaY.github.io/p/mysql-mts/binlog-transaction-dependency-history_hu_fdc1f13a3e149985.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="203"
data-flex-basis="489px"
>&lt;/p>
&lt;p>WriteSet æœƒåˆ¤æ–· Transaction ä¹‹é–“æ˜¯å¦è¡çªï¼Œå› æ­¤éœ€è¦å°‡ commit çš„ Transaction ä¿®æ”¹çš„è¡Œ hash å¾Œæš«æ™‚ä¿å­˜åœ¨å…§å­˜ã€‚&lt;/p>
&lt;p>æ­¤åƒæ•¸ç”¨ä¾†è¨­å®šå„²å­˜çš„ hash ä¸Šé™ï¼Œè¶…éæ­¤ä¸Šé™æœƒæ¸…é™¤å…ˆå‰çš„æ­·å²ç´€éŒ„ã€‚&lt;/p>
&lt;p>è‹¥ Source æ€§èƒ½æœ‰é¤˜è£•å¯ä»¥è€ƒæ…®æå‡æ­¤åƒæ•¸ï¼Œé€²ä¸€æ­¥æé«˜ Replica çš„ä¸¦è¡Œåº¦ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_transaction_write_set_extraction" target="_blank" rel="noopener"
>transaction_write_set_extraction&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/transaction-write-set-extraction.png"
width="573"
height="324"
srcset="https://FuweaY.github.io/p/mysql-mts/transaction-write-set-extraction_hu_788d0ffa134a8fe0.png 480w, https://FuweaY.github.io/p/mysql-mts/transaction-write-set-extraction_hu_ee47aa4a08fca84b.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="176"
data-flex-basis="424px"
>&lt;/p>
&lt;p>è¨­å®š WriteSet ä½¿ç”¨çš„ Hash æ¼”ç®—æ³•ã€‚&lt;/p>
&lt;p>MySQL 5.7 é è¨­ç‚º OFFï¼ŒMySQL 8.0.26 å¾Œæ£„ç”¨ï¼Œä¸€èˆ¬ä¸ç”¨ç‰¹åˆ¥èª¿æ•´ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="å®˜æ–¹æ¸¬è©¦æ•¸æ“š">å®˜æ–¹æ¸¬è©¦æ•¸æ“š
&lt;/h2>&lt;p>ä»¥ä¸‹ç‚ºå®˜æ–¹ä½¿ç”¨SYSBENCHé€²è¡Œå£“æ¸¬çš„åœ–è¡¨ï¼Œå¯ä»¥è§€å¯Ÿåˆ°ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ Source ä½ä¸¦è¡Œç‡çš„æƒ…æ³ï¼ŒWRITESET çš„æ©Ÿåˆ¶ä¸‹ Replica ä»èˆŠèƒ½å¤ æœ‰è‰¯å¥½çš„ä¸¦è¡Œç‡ã€‚&lt;/li>
&lt;li>ç•¶ Source ä¸¦è¡Œç‡è¶Šé«˜ï¼ŒCOMMIT_ORDER å’Œ WriteSet å·®è·æœƒç¸®å°ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/official-1.png"
width="638"
height="369"
srcset="https://FuweaY.github.io/p/mysql-mts/official-1_hu_3b00e87c44e3ed28.png 480w, https://FuweaY.github.io/p/mysql-mts/official-1_hu_d342e907d68b98f.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="172"
data-flex-basis="414px"
>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/official-2.png"
width="634"
height="364"
srcset="https://FuweaY.github.io/p/mysql-mts/official-2_hu_197b19f1142a4d1.png 480w, https://FuweaY.github.io/p/mysql-mts/official-2_hu_e3dc63fec2c378c2.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="174"
data-flex-basis="418px"
>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/official-3.png"
width="630"
height="339"
srcset="https://FuweaY.github.io/p/mysql-mts/official-3_hu_67c48b3d5247c90e.png 480w, https://FuweaY.github.io/p/mysql-mts/official-3_hu_44f1e486e24843f1.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="185"
data-flex-basis="446px"
>&lt;/p>
&lt;h2 id="è¦ªè‡ªæ¸¬è©¦">è¦ªè‡ªæ¸¬è©¦
&lt;/h2>&lt;p>ç’°å¢ƒï¼šMysql 8.0.12ï¼Œæ¸¬è©¦å‰stop slaveï¼Œå¾…sysbenchè·‘å®Œå¾Œåœ¨start slave&lt;/p>
&lt;p>ç¢ºèªåœ¨performance_schemaä¸­ï¼ŒMTSç›¸é—œçš„çµ±è¨ˆENABLEDçš†æœ‰é–‹å•Ÿ(YES)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/setup-instruments.png"
width="618"
height="113"
srcset="https://FuweaY.github.io/p/mysql-mts/setup-instruments_hu_46e9f6547d7d3976.png 480w, https://FuweaY.github.io/p/mysql-mts/setup-instruments_hu_2e44d025aede9c80.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="546"
data-flex-basis="1312px"
>&lt;/p>
&lt;p>(*å•Ÿç”¨æˆ–ç¦ç”¨transaction eventçš„æ”¶é›†)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/setup-consumers.png"
width="604"
height="141"
srcset="https://FuweaY.github.io/p/mysql-mts/setup-consumers_hu_9796bfda0a9b4b1.png 480w, https://FuweaY.github.io/p/mysql-mts/setup-consumers_hu_b014b47d6902f199.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="428"
data-flex-basis="1028px"
>&lt;/p>
&lt;p>(åˆ†åˆ¥ç‚ºç•¶å‰çš„transaction eventï¼Œæ¯å€‹ç·šç¨‹æœ€è¿‘çš„transaction eventï¼Œglobal(è·¨ç·šç¨‹)æœ€è¿‘çš„transaction event)&lt;/p>
&lt;p>æŸ¥è©¢MTSä¸¦è¡Œåº¦çš„èªæ³•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">select thread_id,count_star
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from events_transactions_summary_by_thread_by_event_name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">where thread_id in (
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">select thread_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from replication_applier_status_by_worker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">USE test;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CREATE VIEW rep_thread_count AS SELECT a.THREAD_ID AS THREAD_ID,a.COUNT_STAR AS COUNT_STAR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FROM performance_schema.events_transactions_summary_by_thread_by_event_name a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WHERE a.THREAD_ID in (SELECT b.THREAD_ID FROM performance_schema.replication_applier_status_by_worker b);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT SUM(COUNT_STAR) FROM rep_thread_count INTO @total;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELECT 100*(COUNT_STAR/@total) AS thread_usage FROM rep_thread_count;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#replication_applier_status_by_workerå¯ä»¥æŸ¥çœ‹replicationå„å€‹ç·šç¨‹çš„é‹ä½œç‹€æ³
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#events_transactions_summary_by_thread_by_event_nameå½™ç¸½çš„æ¯å€‹ç·šç¨‹çš„äº‹ä»¶åç¨±ï¼ŒåŒ…å«å·²é—œé–‰ç·šç¨‹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#é€éreplication...tableæ‰¾å‡ºæ­£åœ¨é‹ä½œçš„ç·šç¨‹å†åˆ°event...tableæ‰¾åˆ°ä»–å€‘çš„count_star(åŸ·è¡Œçš„transactionæ•¸é‡)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¦–æ¬¡å£“æ¸¬ä»¥Threads 1 é€²è¡Œ10åˆ†é˜å£“æ¸¬&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-1.png"
width="735"
height="228"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-1_hu_bf23ccaac58c4d23.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-thread-1_hu_f1aa00859d09101b.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="322"
data-flex-basis="773px"
>&lt;/p>
&lt;p>åœ¨commit_orderä¸‹æ¸¬è©¦(å³MySQL 5.7ä½¿ç”¨)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-commit-order-57-1.png"
width="552"
height="113"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-commit-order-57-1_hu_fed257d9318fbb9a.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-commit-order-57-1_hu_a778a8e65d8111cf.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="488"
data-flex-basis="1172px"
>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-1-result.png"
width="224"
height="135"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-1-result_hu_f96a92895ed00c07.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-thread-1-result_hu_d62c32fadcef5314.png 1024w"
loading="lazy"
alt="commit_order ä¸¦è¡Œæ•ˆç‡"
class="gallery-image"
data-flex-grow="165"
data-flex-basis="398px"
>&lt;/p>
&lt;p>åœ¨WriteSetä¸‹æ¸¬è©¦(MySQL 8.0æ–°æ–¹æ¡ˆ)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-80-1.png"
width="557"
height="114"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-80-1_hu_56bd1ec0d29b6c37.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-80-1_hu_82258c7637565e83.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="488"
data-flex-basis="1172px"
>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-thread1-result.png"
width="231"
height="141"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-thread1-result_hu_301b577cfa94eab4.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-thread1-result_hu_67050ade438aac2b.png 1024w"
loading="lazy"
alt="writeSet ä¸¦è¡Œæ•ˆç‡"
class="gallery-image"
data-flex-grow="163"
data-flex-basis="393px"
>&lt;/p>
&lt;p>æ¥è‘—è©¦è©¦çœ‹Threads 128é€²è¡Œ10åˆ†é˜å£“æ¸¬&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128.png"
width="720"
height="229"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128_hu_f8f6eac7cf91aa4.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128_hu_dc7f8ce4a44b7b75.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="314"
data-flex-basis="754px"
>&lt;/p>
&lt;p>åœ¨commit_orderä¸‹æ¸¬è©¦(å³MySQL 5.7ä½¿ç”¨)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-commit-order-57-1.png"
width="552"
height="113"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-commit-order-57-1_hu_fed257d9318fbb9a.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-commit-order-57-1_hu_a778a8e65d8111cf.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="488"
data-flex-basis="1172px"
>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128-commit-order-result.png"
width="211"
height="114"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128-commit-order-result_hu_e0649ddfe29e882f.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128-commit-order-result_hu_546283d58a856a6e.png 1024w"
loading="lazy"
alt="commit_order ä¸¦è¡Œæ•ˆç‡"
class="gallery-image"
data-flex-grow="185"
data-flex-basis="444px"
>&lt;/p>
&lt;p>åœ¨WriteSetä¸‹æ¸¬è©¦(MySQL 8.0æ–°æ–¹æ¡ˆ)&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-80-1.png"
width="557"
height="114"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-80-1_hu_56bd1ec0d29b6c37.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-writeSet-80-1_hu_82258c7637565e83.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="488"
data-flex-basis="1172px"
>&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128-writeSet-result.png"
width="221"
height="142"
srcset="https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128-writeSet-result_hu_34e16099ee1d33e6.png 480w, https://FuweaY.github.io/p/mysql-mts/sysbench-thread-128-writeSet-result_hu_cd73732064be7b1b.png 1024w"
loading="lazy"
alt="writeSet ä¸¦è¡Œæ•ˆç‡"
class="gallery-image"
data-flex-grow="155"
data-flex-basis="373px"
>&lt;/p>
&lt;p>æ¸¬è©¦çµæœåŸºæœ¬ä¸Šå’Œå®˜æ–¹æä¾›çš„å·®ä¸å¤šï¼Œä¸»è¦æ˜¯è§£æ±ºåœ¨Masterä½ä¸¦è¡Œåº¦çš„æƒ…æ³ä¸‹ï¼Œæé«˜MTSçš„æ•ˆç‡ã€‚&lt;/p>
&lt;h2 id="log">LOG
&lt;/h2>&lt;p>ç•¶é–‹å•Ÿ MTS ä¸” log_error_verbosity = 3 (NOTE) æ™‚ï¼Œæœƒåœ¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">2023-01-30T03:08:36.440821Z 6 [Note] [MY-010559] [Repl] Multi-threaded slave statistics for channel &amp;#39;&amp;#39;: seconds elapsed = 277; events assigned = 20795393; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 0; waited at clock conflicts = 12923330700 waited (count) when Workers occupied = 0 waited when Workers occupied = 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ‡¶äººåŒ…">æ‡¶äººåŒ…
&lt;/h2>&lt;h3 id="mysql-575721-åƒæ•¸è¨­å®š">MySQL 5.7~5.7.21 åƒæ•¸è¨­å®š
&lt;/h3>&lt;ul>
&lt;li>
&lt;p>Source (Master)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># ä»¥ä¸‹éå¿…é ˆï¼Œä¾æ“šå¯¦éš›æƒ…æ³è©•ä¼°èª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_group_commit_sync_delay = ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_group_commit_sync_no_delay_count = ?
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>Replica (Slave)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># æ¨è–¦èª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_parallel_workers = ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_parallel_type = LOGICAL_CLOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_preserve_commit_order = ON
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="mysql-572280xx-åƒæ•¸è¨­å®š">MySQL 5.7.22~8.0.XX åƒæ•¸è¨­å®š
&lt;/h3>&lt;ul>
&lt;li>
&lt;p>Source (Master)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># æ¨è–¦èª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_transaction_dependency_tracking = WRITESET_SESSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">transaction_write_set_extraction = XXHASH64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># ä»¥ä¸‹ä¾æ“šå¯¦éš›æƒ…æ³è©•ä¼°èª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># å„ªå…ˆèª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_transaction_dependency_history_size = ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># èª¿æ•´å„ªå…ˆåº¦ä½ï¼Œå› ç‚ºé€€åŒ–å› commit order æ™‚æ‰æœ‰æ•ˆï¼Œæƒ…å¢ƒç‚ºï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 1. æ²’æœ‰ pk æˆ– uk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 2. DDL èªå¥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 3. Transaction çš„æ›´æ–°åŒ…å« FK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 4. history å‰›è¢«æ¸…ç©º
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 5. åŒä¸€å€‹ session çš„ Transaction (WRITESET_SESSION)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_group_commit_sync_delay = ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">binlog_group_commit_sync_no_delay_count = ?
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>Replica (Slave)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># æ¨è–¦èª¿æ•´
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_parallel_workers = ?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_parallel_type = LOGICAL_CLOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slave_preserve_commit_order = ON
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="mts-æ•ˆç‡ç¢ºèª">MTS æ•ˆç‡ç¢ºèª
&lt;/h3>&lt;p>èª¿æ•´å¾Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹èªæ³•æŸ¥çœ‹èª¿æ•´å¾Œ MTS ä¸¦è¡Œçš„æ•ˆç‡ï¼Œç†æƒ³çš„æƒ…æ³ä¸‹åŒä¸€å€‹ channel çš„æ¯å€‹ sql thread çš„ count_star æ‡‰è©²å·®ä¸å¤šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- mysql 5.7 éœ€å…ˆé–‹å•Ÿä»¥ä¸‹è¨­å®š
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">update&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">setup_consumers&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;yes&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">like&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;events_transactions%&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">update&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">setup_instruments&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;yes&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">like&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;transaction&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- mysql 5.7 éœ€å…ˆé–‹å•Ÿä»¥ä¸Šè¨­å®š
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">replication_status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">CHANNEL_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">replication_status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">thread_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">enent_summary&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count_star&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">events_transactions_summary_by_thread_by_event_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">enent_summary&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INNER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_applier_status_by_worker&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">replication_status&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thread_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="bug">BUG
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://bugs.mysql.com/bug.php?id=103636" target="_blank" rel="noopener"
>MySQL Bugs: #103636: Slave hangs with slave_preserve_commit_order On&lt;/a>&lt;/p>
&lt;p>èªªæ˜ï¼šç•¶ replica è¨­ç½®äº† replica_preserve_commit_order = 1 åœ¨é«˜è² è¼‰ä¸‹é•·æ™‚é–“ä½¿ç”¨æ™‚ï¼Œå¯èƒ½æœƒç”¨å®Œ commit order sequence tickets å°è‡´ applier æ›èµ· (hang) ä¸¦ä¸”ç„¡æœŸé™çš„æŒçºŒç­‰å¾… commit order queueã€‚&lt;/p>
&lt;p>å½±éŸ¿ç‰ˆæœ¬ï¼šMySQL 8.0.28 ä¹‹å‰&lt;/p>
&lt;p>ä¿®å¾©ç‰ˆæœ¬ï¼š MySQL 8.0.28&lt;/p>
&lt;p>github è³‡è¨Šï¼š&lt;a class="link" href="https://github.com/mysql/mysql-server/commit/f6bb5e7cc5e57f44c881a3f63ee507102c3e398d" target="_blank" rel="noopener"
>BUG#32891221 REPLICA HANGS WITH REPLICA_PRESERVE_COMMIT_ORDER ON Â· mysql/mysql-server@f6bb5e7 Â· GitHub&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="åƒè€ƒ">åƒè€ƒ
&lt;/h1>&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2018/06/04/" target="_blank" rel="noopener"
>MySQL Â· ç‰¹æ€§åˆ†æ Â· 8.0 WriteSet å¹¶è¡Œå¤åˆ¶&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/VicLiu/p/14653400.html" target="_blank" rel="noopener"
>é€Ÿåº¦æå‡5~10å€ï¼ŒåŸºäºWRITESETçš„MySQLå¹¶è¡Œå¤åˆ¶ #M1013# - VicLW - åšå®¢å›­ (cnblogs.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/joy0921/article/details/80130768" target="_blank" rel="noopener"
>MySQL 5.7å¹¶è¡Œå¤åˆ¶ä¸­å¹¶è¡Œçš„çœŸæ­£å«ä¹‰_ä»²åŸ¹è‰ºçš„åšå®¢-CSDNåšå®¢&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2017/12/03/" target="_blank" rel="noopener"
>MySQL Â· ç‰¹æ€§åˆ†æ Â· LOGICAL_CLOCK å¹¶è¡Œå¤åˆ¶åŸç†åŠå®ç°åˆ†æ (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=6314" target="_blank" rel="noopener"
>MySQL :: WL#6314: MTS: Prepared transactions slave parallel applier&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=7165" target="_blank" rel="noopener"
>MySQL :: WL#7165: MTS: Optimizing MTS scheduling by increasing the parallelization window on master&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://juejin.cn/post/6949470247673921567" target="_blank" rel="noopener"
>MySQL-ç»„æäº¤ä¸å¹¶è¡Œå¤åˆ¶ - æ˜é‡‘ (juejin.cn)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=9556" target="_blank" rel="noopener"
>MySQL :: WL#9556: Writeset-based MTS dependency tracking on master&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2017/08/01/" target="_blank" rel="noopener"
>MySQL Â· å¼•æ“ç‰¹æ€§ Â· Group Replicationå†…æ ¸è§£æ (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://opensource.actionsky.com/20190902-mysql/" target="_blank" rel="noopener"
>ç¤¾åŒºæŠ•ç¨¿ | åŸºäº WRITESET çš„å¹¶è¡Œå¤åˆ¶æ–¹å¼ (actionsky.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/blog-archive/improving-the-parallel-applier-with-writeset-based-dependency-tracking/" target="_blank" rel="noopener"
>MySQL :: Improving the Parallel Applier with Writeset-based Dependency Tracking&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/61336729" target="_blank" rel="noopener"
>MySQL Group Replicationå†²çªæ£€æµ‹æœºåˆ¶å†å‰–æ - çŸ¥ä¹ (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/71913226" target="_blank" rel="noopener"
>æ·±å…¥æµ…æä¸€è‡´æ€§æ¨¡å‹ä¹‹Causal Consistency - çŸ¥ä¹ (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-features-transaction-inconsistencies.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 17.5.1.34 Replication and Transaction Inconsistencies&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/start-replica.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 13.4.2.8 START REPLICA Statement&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/show-replica-status.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 13.7.7.35 SHOW REPLICA STATUS Statement&lt;/a>&lt;/p></description></item><item><title>GTID</title><link>https://FuweaY.github.io/p/mysql-gtid/</link><pubDate>Thu, 27 Mar 2025 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/mysql-gtid/</guid><description>&lt;p>GTID çš„å…¨åæ˜¯ Global Transaction identifier, MySQL æœƒç‚ºæ¯ä¸€å€‹ DML/DDL æ“ä½œéƒ½åˆ†é…ä¸€å€‹åœ¨æ•´å€‹ replicaion topology éƒ½å”¯ä¸€çš„ GTIDã€‚&lt;/p>
&lt;p>åœ¨ replication ç’°å¢ƒä¸­ï¼Œmaster å¯ä»¥ç›´æ¥é€é GTID å®šä½ç™¼é€ binlog çµ¦ slave ä¸å†éœ€è¦æŒ‡å®š binlog åç¨±å’Œ postition åœ¨åŒæ­¥ä¸Šæ›´ç‚ºæ–¹ä¾¿ã€‚æ­¤å¤– Slave é‚„æœƒä¿ç•™å¾ Master åŒæ­¥éä¾†çš„ Transaction ç›¸åŒçš„ GTIDï¼Œä¸¦æŒä¹…åŒ–åˆ° mysql.gtid_executedï¼Œæ­é…ä¸Š GTID çš„è‡ªå‹•è·³éåŠŸèƒ½ï¼Œä¿è­‰äº†ç›¸åŒ GTID çš„ Transaction åœ¨åŒä¸€å€‹ instance ä¸­åªæœƒåŸ·è¡Œä¸€æ¬¡ï¼Œæ›´åŠ æœ‰åŠ©æ–¼ Replication çš„ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;h2 id="gtid-çµ„æˆ">GTID çµ„æˆ
&lt;/h2>&lt;p>GTID çš„çµ„æˆç‚º source_id:transaction_idï¼Œç¯„ä¾‹ &lt;code>3E11FA47-71CA-11E1-9E33-C80AA9429562:23&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>source_idï¼šè©² DML/DDL æœ€åŸå§‹åŸ·è¡Œçš„ server å…¶ UUIDã€‚&lt;/p>
&lt;p>åœ¨æºç¢¼ä¸­ç¨±ç‚º sidï¼Œæœƒåœ¨ MySQL å•Ÿå‹•æ™‚å¾ auto.cnf å–å¾—ï¼Œå¦‚æœæ²’æœ‰å‰‡æ ¹æ“šå•Ÿå‹•æ™‚é–“ã€ç·šç¨‹çš„ LWP ID åŠéš¨æ©Ÿå…§å­˜åœ°å€ç”Ÿæˆå¾Œä¸¦è¨˜éŒ„åœ¨ auto.cnf ä¸­ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šä¹Ÿå°±æ˜¯èªªå¦‚æœåˆªé™¤ç¾æœ‰çš„ auto.cnf æœƒåœ¨ä¸‹æ¬¡å•Ÿå‹•æ™‚ç”¢ç”Ÿä¸€å€‹ä¸åŒçš„ server uuidã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>transaction_idï¼šåŸå§‹ server ç‚ºè©² DML/DDL æ“ä½œåˆ†é…çš„å”¯ä¸€åºåˆ—è™Ÿï¼Œè©²åºåˆ—è™Ÿæ˜¯é †åºéå¢çš„ã€‚&lt;/p>
&lt;p>åœ¨æºç¢¼ä¸­ç¨±ç‚º gno æœƒåœ¨ Transaction é€²å…¥ Flush éšæ®µä¸­ç”Ÿæˆï¼ŒMySQL å…§éƒ¨ç¶­è­·äº†ä¸€å€‹å…¨å±€è®Šé‡ next_free_gno çš„è¨ˆæ•¸ä¾†ç”Ÿæˆ gnoã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="gtid-life-cycle">GTID Life cycle
&lt;/h2>&lt;p>ä»¥ä¸‹ä»¥ MySQL 8.0.17 ä»¥ä¸Šä¾†èªªæ˜&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ç•¶ Transaction åœ¨ Master ä¸ŠåŸ·è¡Œæ™‚ï¼Œæœƒåœ¨ commit éç¨‹ä¸­çš„ Flush éšæ®µç”Ÿæˆ GTID ã€‚&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-step.jpg"
width="2000"
height="734"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-step_hu_314c6c6b0a235188.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-step_hu_cd0c8151a222e9ad.jpg 1024w"
loading="lazy"
alt="gtid-step"
class="gallery-image"
data-flex-grow="272"
data-flex-basis="653px"
>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶åˆ†é… GTID ä¹‹å¾Œæœƒå°‡ Transaction å’Œå…¶å°æ‡‰çš„ GTID ä¸€èµ·å¯«å…¥ binlog (å°šæœªé€²å…¥ sync éšæ®µé€²è¡Œ fsync å› æ­¤åªæ˜¯å¯«å…¥ OS cache) åŒæ™‚æ›´æ–° mysql.gtid_executed è¡¨åŠ @@GLOBAL.gtid_executed è®Šé‡ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶ sync_binlog â‰  1 æ™‚ï¼Œå°±åœ¨ Flush éšæ®µå°‡ binlog å¯«å…¥ OS cache å¾Œç™¼é€ binlog event çµ¦ slaveã€‚&lt;/p>
&lt;p>ç•¶ sync_binlog = 1 æ™‚ï¼Œåœ¨ sync éšæ®µ fsycn åˆ° disk å¾Œæ‰ç™¼é€ binlog event çµ¦ slaveã€‚&lt;/p>
&lt;p>å› æ­¤ç•¶ sync_binlog â‰  1 æ™‚ï¼Œç•¶ Master crash æ™‚å¯èƒ½å°è‡´ Slave é€²åº¦å¤§æ–¼ Masterã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Master çš„ dump ç·šç¨‹å°‡ binlog event å‚³é€çµ¦ Slave ä¿å­˜è‡³ relay logã€‚&lt;/p>
&lt;ul>
&lt;li>è©³ç´°éç¨‹
&lt;ol>
&lt;li>åœ¨ Slave çš„ IO_Thread å»ºç«‹é€£ç·šæ™‚ï¼Œæœƒå°‡ &lt;code>Retrieved_Gtid_Set&lt;/code> å’Œ &lt;code>Executed_Gtid_Set&lt;/code>çš„ä¸¦é›† (UNION) åŠè‡ªå·±çš„ server_id ç™¼é€çµ¦ Masterã€‚&lt;/li>
&lt;li>Master ç¢ºèªè‡ªå·±çš„ &lt;code>gtid_purged&lt;/code> æ˜¯å¦ç‚º Slave ç™¼é€çš„å­é›†ï¼Œä»¥æ­¤ä¾†æª¢æŸ¥ master çš„ binlog å°šæœª purgeã€‚&lt;/li>
&lt;li>Master åˆ¤æ–· Slave æœ‰å“ªäº› GTID é‚„æ²’åŸ·è¡Œï¼Œä¸¦ç™¼é€å°æ‡‰çš„ binlog çµ¦ Slaveã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Slave å¾ relay log è®€å– GTIDï¼Œä¸¦å°‡ gtid_next è¨­ç‚ºè©² GTIDï¼Œä¸¦åˆ¤æ–·ä»¥ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¾ &lt;code>@@GLOBAL.gtid_owned&lt;/code> ä¸­ç¢ºèªæ²’æœ‰å…¶ä»–ç·šç¨‹æ­£åœ¨ä½¿ç”¨è©² GTIDï¼Œä¿è­‰ä¸€æ¬¡åªæœ‰ä¸€å€‹ç·šç¨‹åœ¨è™•ç†è©² GTIDã€‚&lt;/li>
&lt;li>å¾ &lt;code>@@GLOBAL.gtid_executed&lt;/code> ä¸­ç¢ºèªè©² GTID æ˜¯å¦å·²ç¶“æ‡‰ç”¨éã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœè©² GTID å°šæœªè¢«è¢«æ‡‰ç”¨ï¼Œå‰‡åœ¨ Slave æ‡‰ç”¨è©² Event ä¸¦ç¶­æŒè©² Event åœ¨ Master ä¸Šçš„ GTIDï¼ŒåŒæ™‚æ›´æ–° mysql.gtid_executed è¡¨åŠ @@GLOBAL.gtid_executed è®Šé‡ã€‚è‹¥æœ‰é–‹å•Ÿ log_slave_update å‰‡ä¹Ÿå¯«å…¥ binlogã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>åœ¨ 8.0.17 (å« 5.7 æ‰€æœ‰ç‰ˆæœ¬) ä¹‹å‰ mysql.gtid_executed ä¸¦ä¸ç¸½æ˜¯åŠæ™‚æ›´æ–°ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ç•¶ &lt;code>log_bin = OFF&lt;/code> æˆ–è€… &lt;code>log_slave_update = OFF&lt;/code> æ™‚ï¼Œå‰‡ transaction å’Œ mysql.gtid_executed æœƒä¸€èµ· commit æˆ– rollbackã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶ slave &lt;code>log_bin = ON&lt;/code> ä¸” &lt;code>log_slave_update = ON&lt;/code> æ™‚ (æ³¨æ„ï¼šå¦‚æœæ˜¯ master &lt;code>log_bin = ON&lt;/code> ä¹Ÿé©ç”¨)ï¼Œ æ¯ç•¶ binlog rotate æˆ–è€… server é—œé–‰æ™‚ï¼Œæ‰æœƒå°‡å…ˆå‰ binlog çš„æ‰€æœ‰ transaction gtid å¯«å…¥ mysql.gtid_executed è¡¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶ server crash æ™‚ï¼Œæœƒåœ¨ crash recovery æ™‚å°‡ binlog ä¸­çš„ GTID æ·»åŠ åˆ° mysql.gtid_executed è¡¨ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šç•¶é–‹å•Ÿæ™‚ log_bin = OFF æ™‚ï¼Œæœƒç„¡æ³•æ¢å¾© GTID å°è‡´ç„¡æ³•å•Ÿå‹• replicationã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœƒä½¿ç”¨æ¯æ¬¡ Transaction commit æ™‚æ›´æ–°çš„ @@GLOBAL.gtid_executed ä¾†è¡¨ç¤º server çš„ GTID ç‹€æ…‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ mysql.gtid_executed è¡¨(å› ç‚ºä¸æœƒå³æ™‚æ›´æ–°)ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å› ç‚ºä»¥ä¸Šè¡Œç‚ºç•¶é–‹å•Ÿ gtid æ¨¡å¼ä¸” log_slave_update = ON æ™‚ï¼Œå¿…é ˆè¦åŒæ™‚è¨­ç½® sync_binlog = 1 &amp;amp; innodb_flush_log_at_trx_commit = 1ï¼Œå¦å‰‡æœƒå°è‡´ relication åœ¨ OS crash æ™‚ç™¼ç”Ÿå•é¡Œã€‚&lt;/p>
&lt;p>å¾ 8.0.17 é–‹å§‹ç‚ºäº†å¯¦ç¾ clone åŠŸèƒ½ (&lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=9211" target="_blank" rel="noopener"
>WL#9211&lt;/a>) æ›´æ”¹äº†æ­¤è¡Œç‚ºï¼Œä¸è«–å¦‚ä½•è¨­ç½® mysql.gtid_executed è¡¨ç¸½æ˜¯å’Œå°æ‡‰çš„ Event ä¸€èµ· commit (rollback) ã€‚&lt;/p>
&lt;h2 id="mysqlgtid_execute-è¡¨">mysql.gtid_execute è¡¨
&lt;/h2>&lt;p>è¨­è¨ˆçš„åˆè¡·æ˜¯ç”¨æ–¼ç•¶ slave æœªé–‹å•Ÿ binlog æˆ–è€…æ˜¯ &lt;code>log_slave_update = OFF&lt;/code> æ™‚ï¼Œæˆ–è€…æ˜¯ç•¶ binlog ä¸Ÿå¤±æ™‚èƒ½å¤ ä¿ç•™ GTID çš„ç‹€æ…‹ï¼Œå› æ­¤æœƒåœ¨é€™å¼µè¡¨ä¸­æŒä¹…åŒ–å·²ç¶“åŸ·è¡Œçš„ GTID SETã€‚&lt;/p>
&lt;aside>
ğŸ’¡ RESET MASTER æœƒæ¸…ç©ºæ­¤è¡¨
&lt;/aside>
&lt;h3 id="å£“ç¸®">å£“ç¸®
&lt;/h3>&lt;p>éš¨è‘—æ™‚é–“æ¨ç§» mysql.gtid_executed è¡¨æœƒæœ‰è¨±å¤šç­†è³‡æ–™ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">+--------------------------------------+----------------+--------------+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| source_uuid | interval_start | interval_end |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">|--------------------------------------+----------------+--------------|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 37 | 37 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 38 | 38 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 39 | 39 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 40 | 40 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 41 | 41 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 42 | 42 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 43 | 43 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+--------------------------------------+----------------+--------------+
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç‚ºäº†ç¯€çœç©ºé–“ï¼ŒMySQL æœƒå®šæœŸå£“ç¸® mysql.gtid_executed è¡¨ï¼Œå£“ç¸®çš„æ–¹å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">+--------------------------------------+----------------+--------------+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| source_uuid | interval_start | interval_end |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">|--------------------------------------+----------------+--------------|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">| 3E11FA47-71CA-11E1-9E33-C80AA9429562 | 37 | 43 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+--------------------------------------+----------------+--------------+
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å•Ÿç”¨ binlog æ™‚ï¼Œç•¶ç™¼ç”Ÿ binlog rotation æ™‚æœƒå£“ç¸® mysql.gtid_executed è¡¨ã€‚&lt;/p>
&lt;p>ç•¶ç¦ç”¨ binlog æ™‚æœƒä¾æ“š &lt;a class="link" href="GTID%20903c4e34f0cc474ea92f3368b7d552de.md" >gtid_executed_compression_period&lt;/a> çš„å€¼æ±ºå®šå£“ç¸®çš„æ™‚æ©Ÿé»ï¼Œæ¯ç•¶è™•ç† N å€‹ Transaction å¾Œæœƒå–šé†’å£“ç¸®ç·šç¨‹ (thread/sql/compress_gtid_table) å£“ç¸® mysql.gtid_executed è¡¨ã€‚&lt;/p>
&lt;p>åœ¨ 8.0.17 ä¹‹å‰é è¨­å€¼ç‚º 1000ï¼Œè¡¨ç¤ºæ¯ 1000 å€‹ Transaction é€²è¡Œå£“ç¸®ï¼Œåœ¨è©²ç‰ˆæœ¬ä¹‹å‰ä¸å»ºè­°åœ¨é—œé–‰ binlog æ™‚è¨­å®šç‚º 0ï¼Œé€™å°‡æœƒå¢åŠ æ‰€éœ€çš„ disk ç©ºé–“ã€‚&lt;/p>
&lt;p>å¾ 8.0.17 é–‹å§‹å»ºè­°è¨­ç½®ç‚º 0 (8.0.23 é è¨­å€¼)ï¼Œé€™æ˜¯å› ç‚ºå¾è©²ç‰ˆæœ¬é–‹å§‹ InnoDB çš„ Transaction å¯«å…¥æœƒç”±å¦ä¸€å€‹ innodb/clone_gtid_thread ç·šç¨‹ä¾†æ§åˆ¶å¯«å…¥å’Œå£“ç¸®ï¼Œ compress_gtid_table ç·šç¨‹æœƒå¹²æ“¾å…¶ä½œæ¥­ä¸¦é™ä½é€Ÿåº¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">threads&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NAME&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;%gtid%&amp;#39;&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="k">G&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">THREAD_ID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">thread&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">sql&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">compress_gtid_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">TYPE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FOREGROUND&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_ID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_USER&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_HOST&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_DB&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">PROCESSLIST_COMMAND&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Daemon&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_TIME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1509&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_STATE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Suspending&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSLIST_INFO&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PARENT_THREAD_ID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ROLE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">INSTRUMENTED&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HISTORY&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">CONNECTION_TYPE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">THREAD_OS_ID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">18677&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç³»çµ±è®Šé‡-gtid_executed-å’Œ-gtid_purged-çš„åˆå§‹åŒ–èˆ‡æ›´æ–°">ç³»çµ±è®Šé‡ gtid_executed å’Œ gtid_purged çš„åˆå§‹åŒ–èˆ‡æ›´æ–°
&lt;/h2>&lt;h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–
&lt;/h3>&lt;p>æ¯å€‹ binlog çš„é–‹é ­éƒ½æœ‰ &lt;code>Previous-GTIDs&lt;/code>ï¼šé€™æ˜¯ç”±ä¸Šä¸€å€‹ binlog æ–‡ä»¶çš„ &lt;code>Previous-GTIDs&lt;/code> å’Œä¸Šä¸€å€‹ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTID çµ„æˆã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">~ -&amp;gt; mysqlbinlog --no-defaults --base64-output=DECODE-ROWS -vvv mysql-bin.000004
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#230217 8:17:55 server id 1 end_log_pos 125 CRC32 0xa9000aca Start: binlog v 4, server v 8.0.21 created 230217 8:17:55 at startup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ROLLBACK/*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># at 125
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#230217 8:17:55 server id 1 end_log_pos 196 CRC32 0xf3d86d46 Previous-GTIDs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:1-3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SET @@SESSION.GTID_NEXT= &amp;#39;6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:4&amp;#39;/*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SET @@SESSION.GTID_NEXT= &amp;#39;6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:5&amp;#39;/*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># End of log file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~ -&amp;gt; mysql-docker $ mysqlbinlog --no-defaults --base64-output=DECODE-ROWS -vvv mysql-bin.000005
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#230217 8:19:12 server id 1 end_log_pos 125 CRC32 0xd5587e96 Start: binlog v 4, server v 8.0.21 created 230217 8:19:12 at startup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># Warning: this binlog is either in use or was not closed properly.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ROLLBACK/*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># at 125
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#230217 8:19:12 server id 1 end_log_pos 196 CRC32 0x2416aa2b Previous-GTIDs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 6c3c06b0-ae9b-11ed-a26c-0242ac1d0002:1-5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>gtid_executed å’Œ gtid_purged é€™ 2 å€‹ç³»çµ±è®Šé‡åœ¨ MySQL å•Ÿå‹•æ™‚æœƒé€é binlog è¨ˆç®—é€²è¡Œåˆå§‹åŒ–ï¼š&lt;/p>
&lt;ul>
&lt;li>gtid_executedï¼šç”±æœ€æ–°çš„ binlog æ–‡ä»¶çš„ &lt;code>Previous-GTIDs&lt;/code>ã€æœ€æ–°çš„ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTIDã€mysql.gtid_excuted ä¸¦é›† (UNION) è¨ˆç®—å¾—å‡ºã€‚&lt;/li>
&lt;li>gtid_purgedï¼š
&lt;ol>
&lt;li>
&lt;p>å°‡æœ€æ–°çš„ binlog æ–‡ä»¶çš„ &lt;code>Previous-GTIDs&lt;/code>ã€æœ€æ–°çš„ binlog æ–‡ä»¶æ‰€æœ‰çš„ Transaction GTID ç›¸åŠ ï¼Œè¨ˆç®—å‡º gtids_in_binlog (è¡¨ç¤ºæ›¾å‡ºç¾åœ¨ binlog çš„æ‰€æœ‰ gtid)ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°‡ gtids_in_binlog æ¸›å»æœ€èˆŠçš„ binlog æ–‡ä»¶çš„ &lt;code>Previous-GTIDs&lt;/code>ï¼Œè¨ˆç®—å‡º gtids_in_binlog_not_purged (è¡¨ç¤ºæ‰€åœ¨çš„ binlog å°šæœªè¢«æ¸…é™¤çš„ gtid)ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°‡ gtid_executed æ¸›å» gtids_in_binlog_not_purgedï¼Œå¾—å‡ºåœ¨ server ä¸ŠåŸ·è¡Œéä½† binlog å·²è¢«æ¸…æ¥šçš„ GTID SETã€‚&lt;/p>
&lt;p>ç”±ä¸Šè¨ˆç®—å¾—çŸ¥å¦‚æœ binlog æœªé–‹å•Ÿæ™‚ï¼Œgtid_purged = gtid_executed ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ›´æ–°">æ›´æ–°
&lt;/h3>&lt;ul>
&lt;li>gtid_executedï¼š
&lt;ul>
&lt;li>æœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚&lt;/li>
&lt;li>set global gtid_purgedï¼Œè¨­ç‚ºåŸå…ˆ gtid_execute å’Œæ–°è¨­ç½® gtid_purged çš„ä¸¦é›† (UNION)ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>gtid_purgedï¼š
&lt;ul>
&lt;li>ç•¶ log_slave_updates = OFF æ™‚ï¼Œæœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚&lt;/li>
&lt;li>ç•¶ Master é–‹å•Ÿ binlog æ™‚ï¼Œç•¶åŸ·è¡Œ purge binary logs æˆ– binlog è¶…é expire_logs_days (binlog_expire_logs_seconds) çš„è¨­ç½®æ™‚ï¼Œè§¸ç™¼æ¸…é™¤ binlog çš„å‹•ä½œæ›´æ–°ã€‚&lt;/li>
&lt;li>ç•¶ Slave é–‹å•Ÿ log_slave_updatesï¼Œç•¶åŸ·è¡Œ purge binary logs æˆ– binlog è¶…é expire_logs_days (binlog_expire_logs_seconds) çš„è¨­ç½®æ™‚ï¼Œè§¸ç™¼æ¸…é™¤ binlog çš„å‹•ä½œæ›´æ–°ã€‚&lt;/li>
&lt;li>ç•¶ Slave é—œé–‰ log_slave_updates ï¼Œæœƒåœ¨ Transaction commit çš„æ™‚å€™åŒæ­¥æ›´æ–°ã€‚&lt;/li>
&lt;li>set global gtid_purgedï¼Œè¢«è¨­å®šæˆ–å¢åŠ æŒ‡å®š gtid setã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å…±åŒï¼š
&lt;ul>
&lt;li>RESET MASTER æ™‚è¨­ç‚ºç©ºå€¼ã€‚&lt;/li>
&lt;li>åœ¨ MySQL å•Ÿå‹•æ™‚åˆå§‹åŒ–ã€‚&lt;/li>
&lt;li>Master æœªé–‹å•Ÿ binlog æ™‚ï¼Œå› ç‚ºä¸æœƒç”¢ç”Ÿ GTIDï¼Œå› æ­¤ä¸æœƒæœ‰ä»»ä½•æ›´æ–°ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="gtid-ç›¸é—œè®Šé‡">GTID ç›¸é—œè®Šé‡
&lt;/h2>&lt;h3 id="gtid_mode">gtid_mode
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-mode.jpg"
width="572"
height="315"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-mode_hu_5b6a4a39e8b81977.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-mode_hu_cbc4da12f86538a1.jpg 1024w"
loading="lazy"
alt="gtid_mode"
class="gallery-image"
data-flex-grow="181"
data-flex-basis="435px"
>&lt;/p>
&lt;p>æ§åˆ¶æ˜¯å¦é–‹å•Ÿ GTID åŠŸèƒ½ã€‚&lt;/p>
&lt;p>å¯ä»¥è¨­ç½®ç‚ºä»¥ä¸‹å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>OFFï¼šæ‰€æœ‰æ–°çš„æˆ–å›æ”¾çš„ Transaction éƒ½æ˜¯ anonymousã€‚&lt;/li>
&lt;li>OFF_PERMISSIVEï¼šæ‰€æœ‰æ–°çš„ Transaction éƒ½æ˜¯ anonymousï¼Œä½†å›æ”¾çš„ Transaction å¯ä»¥æ˜¯ anonymous ä¹Ÿå¯ä»¥åŒ…å« GTIDã€‚&lt;/li>
&lt;li>ON_PERMISSIVEï¼šæ‰€æœ‰æ–°çš„ Transaction éƒ½åŒ…å« GTIDï¼Œä½†å›æ”¾çš„ Transaction å¯ä»¥æ˜¯ anonymous ä¹Ÿå¯ä»¥åŒ…å« GTIDã€‚&lt;/li>
&lt;li>ONï¼šå¿…é ˆåŒæ™‚è¨­ç½® enforce_gtid_consistency = ONã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨ä¿®æ”¹ gtid_mode æ™‚ä¸€æ¬¡åªèƒ½è®Šæ›´ç‚ºä¸Šä¸€å€‹æˆ–ä¸‹ä¸€å€‹å€¼ï¼Œä¾‹å¦‚ï¼šåŸå…ˆè¨­ç½®ç‚º OFF_PERMISSIVE å‰‡åªèƒ½è¨­ç½®ç‚º OFF æˆ– ON_PERMISSIVEã€‚&lt;/p>
&lt;h3 id="enforce_gtid_consistency">enforce_gtid_consistency
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/enforce-gtid-consistency.jpg"
width="576"
height="296"
srcset="https://FuweaY.github.io/p/mysql-gtid/enforce-gtid-consistency_hu_70752c55119992ca.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/enforce-gtid-consistency_hu_4a8af9082bbea885.jpg 1024w"
loading="lazy"
alt="enforce_gtid_consistency"
class="gallery-image"
data-flex-grow="194"
data-flex-basis="467px"
>&lt;/p>
&lt;p>æ§åˆ¶æ˜¯å¦å…è¨±é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œï¼Œå¿…é ˆè¨­ç½®ç‚º ON æ‰èƒ½è¨­ç½® gtid_mode = ONã€‚&lt;/p>
&lt;p>å¯ä»¥è¨­ç½®ç‚ºä»¥ä¸‹å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>OFF (0)ï¼šå…è¨±æ‰€æœ‰é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œã€‚&lt;/li>
&lt;li>ON (1)ï¼šä¸å…è¨±ä»»ä½•é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œã€‚&lt;/li>
&lt;li>WARN (2)ï¼šå…è¨±æ‰€æœ‰é•å GTID ä¸€è‡´æ€§çš„èªå¥åŸ·è¡Œï¼Œä½†æœƒç”¢ç”Ÿ warningã€‚&lt;/li>
&lt;/ul>
&lt;p>åªæœ‰åœ¨èªå¥å¯«å…¥ binlog æ™‚æ‰æœƒæª¢æŸ¥ï¼Œä¹Ÿå°±æ˜¯æœªé–‹å•Ÿ binlog æˆ–ç•¶èªå¥è¢« filter éæ¿¾æ™‚ä¸æœƒæª¢æŸ¥ã€‚&lt;/p>
&lt;p>é•å GTID ä¸€è‡´æ€§çš„èªå¥å¯ä»¥åƒè€ƒ &lt;a class="link" href="GTID%20903c4e34f0cc474ea92f3368b7d552de.md" >GTID é™åˆ¶&lt;/a> ç« ç¯€ã€‚&lt;/p>
&lt;h3 id="gtid_next">gtid_next
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-next.jpg"
width="518"
height="262"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-next_hu_7927395141f577f7.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-next_hu_8dbd23ef2d81faf4.jpg 1024w"
loading="lazy"
alt="gtid-next"
class="gallery-image"
data-flex-grow="197"
data-flex-basis="474px"
>&lt;/p>
&lt;p>gtid_next ç”¨æ–¼æŒ‡å®šå¦‚ä½•ç²å–ä¸‹ä¸€å€‹ GTIDã€‚&lt;/p>
&lt;p>gtid_next å¯ä»¥è¨­ç‚ºä»¥ä¸‹å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>AUTOMATICï¼šä½¿ç”¨ä¸‹ä¸€å€‹è‡ªå‹•ç”Ÿæˆçš„ GTIDã€‚&lt;/li>
&lt;li>ANONYMOUSï¼šTransaction æ²’æœ‰ GTIDï¼Œåªæœ‰ gtid_mode = OFF æ™‚æ‰èƒ½è¨­ç½®çš„å€¼ã€‚&lt;/li>
&lt;li>æŒ‡å®š GTID&lt;/li>
&lt;/ul>
&lt;p>å°‡ gtid_next è¨­ç½®ç‚ºæŒ‡å®š GTID å¾Œï¼Œéœ€è¦åœ¨ Transaction commit æˆ– rollback å¾Œï¼Œå¿…é ˆåœ¨åŸ·è¡Œå…¶ä»–èªå¥ä¹‹å‰å†æ¬¡é¡¯å¼çš„ SET GTID_NEXTï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">gtid_next&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;08d3c091-addb-11ed-8959-0242ac1c0002:5&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">begin&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rollback&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">01&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">ERROR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1837&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HY000&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">When&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">SESSION&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GTID_NEXT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">you&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">must&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">explicitly&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">different&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">after&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">or&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ROLLBACK&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Please&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">check&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID_NEXT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">variable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">manual&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">detailed&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">explanation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Current&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">SESSION&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GTID_NEXT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;08d3c091-addb-11ed-8959-0242ac1c0002:5&amp;#39;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="gtid_owned">gtid_owned
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-owned.jpg"
width="518"
height="182"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-owned_hu_787a44bbcfe7e1dd.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-owned_hu_1154763dda1a99ae.jpg 1024w"
loading="lazy"
alt="gtid_owned"
class="gallery-image"
data-flex-grow="284"
data-flex-basis="683px"
>&lt;/p>
&lt;p>æ­¤ç‚º read-only çš„è®Šé‡ï¼Œæ ¹æ“š Scope çš„ä¸åŒæœ‰ä¸åŒæ„æ€ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Globalï¼šåˆ—å‡º server æ­£åœ¨ä½¿ç”¨çš„æ‰€æœ‰ GTID ä»¥åŠæ“æœ‰è©² GTID çš„ç·šç¨‹ IDã€‚&lt;/p>
&lt;p>ä¸»è¦ç”¨æ–¼é–‹å•Ÿ MTS æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»– applier å·²ç¶“åœ¨æ‡‰ç”¨è©² GTIDï¼Œé¿å…åŒä¸€å€‹ GTID åœ¨åŒæ™‚è¢«å¤šå€‹ç·šç¨‹åŒæ™‚è™•ç†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Sessionï¼šåˆ—å‡ºè©² session ä½¿ç”¨ä¸­çš„ GTIDã€‚&lt;/p>
&lt;p>ç•¶æ‰‹å‹•è¨­ç½® gtid_next ç‚ºæŒ‡å®š GTID æ™‚ï¼Œå¯ä»¥åœ¨ Transaction åœ¨ commit (rollback) ä¹‹å‰é€é gtid_owned è§€å¯Ÿåˆ°æ­¤è¨­ç½®ã€‚&lt;/p>
&lt;p>ç•¶ gtid_next = AUTOMATIC æ™‚ï¼Œåªæœ‰åœ¨ Trasnsaction commit æ™‚èƒ½å¾ gtid_next ä¸­çŸ­æš«è§€å¯Ÿåˆ°ï¼Œå…¶é¤˜æ™‚å€™æœƒæ˜¯ç©ºå€¼ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="gtid_executed">gtid_executed
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-executed.jpg"
width="517"
height="185"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-executed_hu_f490155faa0e6442.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-executed_hu_8a3533392ba7cd36.jpg 1024w"
loading="lazy"
alt="gtid_executed"
class="gallery-image"
data-flex-grow="279"
data-flex-basis="670px"
>&lt;/p>
&lt;p>æ­¤ç‚º read-only çš„è®Šé‡ï¼ŒæŒ‡çš„æ˜¯æ‰€æœ‰è©² server å·²ç¶“åŸ·è¡Œçš„ GTIDï¼Œä¹Ÿæœƒç­‰åŒæ–¼ SHOW MASTER ( | SLAVE ) STATUS ä¸­çš„ Executed_Gtid_Set å€¼ã€‚&lt;/p>
&lt;p>&lt;strong>ç•¶åŸ·è¡Œ RESET MASTER æ™‚æœƒå°‡ gtid_executed è¨­ç½®ç‚ºç©ºå€¼ã€‚&lt;/strong>&lt;/p>
&lt;p>gtid_executed çš„ Gtid_Set æœƒåŒ…å« gtid_purged çš„ Gtid_Set ï¼Œå› æ­¤åœ¨ä»»ä½•æ™‚å€™åŸ·è¡Œ GTID_SUBTRACT(@@GLOBAL.gtid_executed, @@GLOBAL.gtid_purged) å¯ä»¥å¾—åˆ°æœªæ¸…é™¤çš„ binlog ä¸­æ‰€æœ‰çš„ GTIDã€‚&lt;/p>
&lt;h3 id="gtid_purged">gtid_purged
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-purged.jpg"
width="518"
height="184"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-purged_hu_e55e1429d397617b.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-purged_hu_4fd9f914a82e8f0d.jpg 1024w"
loading="lazy"
alt="gtid_purged"
class="gallery-image"
data-flex-grow="281"
data-flex-basis="675px"
>&lt;/p>
&lt;p>æ­¤è®Šé‡è¡¨ç¤ºåœ¨ server ä¸Šå·²ç¶“åŸ·è¡Œï¼Œä½†æ˜¯å°æ‡‰çš„ binlog å·²ç¶“è¢«æ¸…é™¤çš„ GTID SETï¼Œå› æ­¤ gtid_purged ç‚º gtid_executed çš„å­é›†ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æƒ…æ³çš„ GTID æœƒåŒ…å«åœ¨ gtid_purgedï¼š&lt;/p>
&lt;ul>
&lt;li>ç•¶ slave æœªé–‹å•Ÿ log_slave_updates æ™‚ï¼Œå·²ç¶“å›æ”¾çš„ Transaction çš„ GTIDã€‚&lt;/li>
&lt;li>åŒ…å«è©² GTID çš„ binlog å·²ç¶“è¢«æ¸…é™¤ã€‚&lt;/li>
&lt;li>é€é SET @@GLOBAL.gtid_purged ä¾†é¡¯ç¤ºè¨­ç½®ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç•¶åŸ·è¡Œ RESET MASTER æ™‚æœƒå°‡ gtid_purged è¨­ç½®ç‚ºç©ºå€¼ã€‚&lt;/strong>&lt;/p>
&lt;p>å¯ä»¥é€é SET @@GLOBAL.gtid_purged ä¾†é¡¯ç¤ºè¨­å®šï¼Œæœ‰ä»¥ä¸‹å…©ç¨®æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å°‡ gtid_purged è®Šæ›´ç‚ºæŒ‡å®šçš„ GTID SETï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">gtid_purged&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;gtid_set&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¶“éæ­¤è¨­ç½®å¾Œ gtid_purged ç­‰æ–¼ gtid_setï¼Œä¸” gtid_executed å€¼ (mysql.gtid_executed) ç­‰æ–¼ gtid_executed åŸæœ¬çš„å€¼å’Œ gtid_set çš„ä¸¦é›† (UNION)ã€‚&lt;/p>
&lt;p>gtid_set é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‡å®šçš„ gtid_set å¿…é ˆæ˜¯ gtid_purged ç•¶å‰å€¼çš„è¶…é›† (superset)ï¼Œä¹Ÿå°±æ˜¯æ–°è¨­ç½®çš„ GTID SET å¿…é ˆåŒ…å«åŸæœ¬çš„ gtid_purgedã€‚&lt;/li>
&lt;li>æŒ‡å®šçš„ gtid_setä¸å¾—å’Œ gtid_subtract(gtid_executed,gtid_purged) ç›¸äº¤ï¼Œä¹Ÿå°±æ˜¯æ–°è¨­ç½®çš„ GTID SET ä¸èƒ½åŒ…å«åœ¨ gtid_executed ä¸­å°šæœªè¢«æ¸…é™¤çš„å€¼ã€‚&lt;/li>
&lt;li>æŒ‡å®šçš„ gtid_set ä¸èƒ½åŒ…å« @@global.gtid_owned ä¸­çš„ä»»ä½• GTIDï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åŒ…å«ç•¶å‰ server æ­£åœ¨åŸ·è¡Œçš„ gtidã€‚&lt;/li>
&lt;/ul>
&lt;p>ç”¨é€”ç¯„ä¾‹ï¼šä½¿ç”¨ mysqldump é‚„åŸ slave ä¸Šæå£çš„è¡¨ï¼Œå› ç‚ºå‚™ä»½æª”å’ŒåŸå…ˆ slave çš„ gtid æœ‰é‡ç–Šï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä½¿æ–¹å¼é€²è¡Œ gtid_purged çš„è¨­ç½®ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç‚º gtid_purged append (æ–°å¢) æŒ‡å®šçš„ GTID SET&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">gtid_purged&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;+gtid_set&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¶“éæ­¤è¨­ç½®å¾Œ gtid_executed (åŒ…å« mysql.gtid_executed)ã€gtid_purged æœƒæ–°å¢ gtid_setã€‚&lt;/p>
&lt;p>gtid_set é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>gtid_set ä¸å¾—èˆ‡ gtid_executed çš„ç•¶å‰å€¼ç›¸äº¤ï¼Œä¹Ÿå°±æ˜¯æ–°é™„åŠ ä¸Šå»çš„ GTID SET ä¸èƒ½åŒ…å«åœ¨ gtid_executed å’Œ gtid_purged ä¸­çš„ GTIDã€‚&lt;/li>
&lt;li>æŒ‡å®šçš„ gtid_set ä¸èƒ½åŒ…å« @@global.gtid_owned ä¸­çš„ä»»ä½• GTIDï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åŒ…å«ç•¶å‰ server æ­£åœ¨åŸ·è¡Œçš„ gtidã€‚&lt;/li>
&lt;/ul>
&lt;p>ç”¨é€”ç¯„ä¾‹ï¼šç‚ºäº†é…ç½®å¤šå€‹ channel çš„ salveï¼Œå°‡ä¾†è‡ªä¸åŒ master çš„å‚™ä»½é‚„åŸåˆ°åŒä¸€å€‹ serverï¼Œå› ç‚ºå…©è€…çš„ Transaction ä¸ç›¸äº¤ï¼Œå› æ­¤ä½¿ç”¨ append çš„æ–¹å¼æ›´æ–° gtid_purgedã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„ï¼šåœ¨ MySQL 5.7 ä¸­åªèƒ½ç›´æ¥è®Šæ›´æˆæŒ‡å®šçš„ GTID SETï¼Œç„¡æ³•ä½¿ç”¨ append çš„æ–¹å¼ï¼Œä¸”åªæœ‰ç•¶ gtid_executed ç‚ºç©º (ä¹Ÿå°±æ˜¯ gtid_purged å€¼ä¹Ÿç‚ºç©º) æ™‚æ‰å¯ä»¥æ›´æ–° gtid_purged çš„å€¼&lt;/p>
&lt;h3 id="gtid_executed_compression_period">gtid_executed_compression_period
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/gtid-executed-compression-period.jpg"
width="575"
height="309"
srcset="https://FuweaY.github.io/p/mysql-gtid/gtid-executed-compression-period_hu_44a296a498aac305.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/gtid-executed-compression-period_hu_689a93edd88a4b11.jpg 1024w"
loading="lazy"
alt="gtid_executed_compression_period"
class="gallery-image"
data-flex-grow="186"
data-flex-basis="446px"
>&lt;/p>
&lt;p>æ­¤è¨­ç½®åªæœ‰ç¦ç”¨ binlog æ‰æœ‰æ•ˆï¼Œæ¯ç•¶è™•ç† N å€‹ Transaction å¾Œæœƒå–šé†’ç·šç¨‹å£“ç¸® mysql.gtid_executed è¡¨ï¼Œç•¶è¨­ç½®ç‚º 0 æ™‚è¡¨ç¤ºå£“ç¸®ä¸å›ºå®šåŸ·è¡Œï¼Œè€Œæ˜¯æ ¹æ“šéœ€è¦é€²è¡Œå£“ç¸®ã€‚&lt;/p>
&lt;p>ç•¶å•Ÿç”¨ binlog æ™‚ï¼Œä¸æœƒä½¿ç”¨æ­¤è¨­ç½®ï¼Œè€Œæ˜¯ç•¶ binlog rotation æ™‚æ‰æœƒå£“ç¸® mysql.gtid_executed è¡¨ã€‚&lt;/p>
&lt;h3 id="binlog_gtid_simple_recovery">binlog_gtid_simple_recovery
&lt;/h3>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-gtid/binlog-gtid-simple-recovery.jpg"
width="573"
height="217"
srcset="https://FuweaY.github.io/p/mysql-gtid/binlog-gtid-simple-recovery_hu_79291e933c1334db.jpg 480w, https://FuweaY.github.io/p/mysql-gtid/binlog-gtid-simple-recovery_hu_e2c5b3fbe2aaea57.jpg 1024w"
loading="lazy"
alt="binlog_gtid_simple_recovery"
class="gallery-image"
data-flex-grow="264"
data-flex-basis="633px"
>&lt;/p>
&lt;p>æ§åˆ¶ MySQL å•Ÿå‹•æ™‚å¾ binlog å°‹æ‰¾ GTID çš„è¡Œç‚ºã€‚&lt;/p>
&lt;h2 id="gtid-é™åˆ¶">GTID é™åˆ¶
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>ä¸èƒ½åœ¨ä¸€å€‹ Transaction ä¸­åŒæ™‚æ¶‰åŠ nontransactional å„²å­˜å¼•æ“ (ä¾‹å¦‚ï¼šMyISAM) å’Œ transactionalå„²å­˜å¼•æ“ (ä¾‹å¦‚ï¼šInnoDB) çš„è¡¨é€²è¡Œæ›´æ–°ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸æ”¯æŒ sql_slave_skip_counterï¼Œé™¤é slave åœ¨ CHANGE MASTER æ™‚åŒ…å«äº† ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS æ‰èƒ½ä½¿ç”¨ sql_slave_skip_counterã€‚&lt;/p>
&lt;p>å‚™è¨»ï¼šASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS è©²åŠŸèƒ½ç”¨ä¾†åœ¨æœªé–‹å•Ÿ GTID çš„ Master å’Œé–‹å•Ÿ GTID çš„ Slave é€²è¡Œ Replicationï¼Œä¸”æœƒç‚º Slave åŸ·è¡Œçš„ Transaction ç”Ÿæˆ GTIDã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸æ”¯æŒ CHANGE MASTER æ™‚ä½¿ç”¨ IGNORE_SERVER_IDS é¸é …ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ MySQL 8.0.21 ä¹‹å‰ï¼Œä¸æ”¯æ´ &lt;strong>CREATE TABLE &amp;hellip; SELECT&lt;/strong> èªå¥ï¼Œå› ç‚ºè©²èªå¥åŸºæ–¼ STATEMENT æœƒç”¢ç”Ÿä¸€å€‹ GTIDï¼Œä½†ROW æ ¼å¼ç´€éŒ„æœƒç”¢ç”Ÿ 2 å€‹ GTIDï¼Œé€™æœƒå°è‡´ç„¡æ³•æ­£ç¢ºè™•ç† Transactionã€‚&lt;/p>
&lt;p>åœ¨ MySQL 8.0.21 ä¹‹å¾Œï¼Œå› ç‚ºæ”¯æŒ atomic (åŸå­) DDL æ“ä½œï¼Œå› æ­¤ä¸å†æœ‰è©²é™åˆ¶ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ MySQL 8.0.13 ä¹‹å‰ä¸èƒ½åœ¨ Transactionã€Proceduresã€Functions å’Œ Triggers å…§éƒ½ä¸èƒ½ä½¿ç”¨ CREATE/DROP TEMPORARY TABLEï¼Œåªèƒ½åœ¨é Transaction å…§ä¸” autocommit = 1 æ™‚æ‰èƒ½ä½¿ç”¨ã€‚&lt;/p>
&lt;p>å¾ MySQL 8.0.13 é–‹å§‹ï¼Œç•¶ binlog_format è¨­ç½®ç‚º ROW æˆ– MIXED æ™‚ï¼Œåœ¨ä½¿ç”¨ GTID æ™‚å…è¨±ä½¿ç”¨ CREATE/DROP TEMPORARY TABLEï¼Œå› ç‚ºé€™äº›èªå¥å°‡ä¸æœƒå¯«å…¥ binlogã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ MySQL 8.0.16 ä¹‹å‰ï¼Œä¸èƒ½åœ¨ mysql_upgrade ä¸­åŠ ä¸Š &lt;code>--write-binlog&lt;/code> é¸é …ã€‚&lt;/p>
&lt;p>å¾ MySQL 8.0.16 é–‹å§‹ï¼ŒåŸ·è¡Œ mysql_upgrade æœŸé–“ç¸½æ˜¯æœƒè‡ªå‹•ç¦ç”¨ binlogï¼Œå› æ­¤æ²’æœ‰å•é¡Œã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="åœ¨ç·šé–‹å•Ÿ-gtid">åœ¨ç·šé–‹å•Ÿ GTID
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ENFORCE_GTID_CONSISTENCY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WARN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¨­ç½®å¾Œè®“ MySQL æ¥å—æ­£å¸¸çš„æ“ä½œï¼Œä¸¦åœ¨æœŸé–“å¾ Error Log ç¢ºèªæ˜¯å¦æœ‰å‡ºç¾ GTID ä¸æ”¯æŒçš„ Queryï¼Œä¸¦å°å…¶é€²è¡Œä¿®æ­£ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ENFORCE_GTID_CONSISTENCY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¨­ç½®å¾Œæ‰€æœ‰ GTID ä¸æ”¯æŒçš„æ“ä½œéƒ½å°‡è¢«æ‹’çµ•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GTID_MODE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OFF_PERMISSIVE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¡¨ç¤º Master ç”Ÿæˆçš„æ˜¯ ANONYMOUS Transactionï¼ŒSlave å¯ä»¥æ‡‰ç”¨ ANONYMOUS ã€GTID Transactionã€‚&lt;/p>
&lt;p>æ³¨æ„å‹™å¿…åœ¨æ‰€æœ‰ server éƒ½è¨­ç½®æ­¤æ­¥é©Ÿå¾Œï¼Œæ‰åŸ·è¡Œä¸‹ä¸€æ­¥é©Ÿã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GTID_MODE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ON_PERMISSIVE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¡¨ç¤º Master ç”Ÿæˆçš„æ˜¯ GTID Transactionï¼ŒSlave å¯ä»¥æ‡‰ç”¨ ANONYMOUS ã€GTID Transactionã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server ä¸­ç¢ºå®šä»¥ä¸‹è®Šé‡ç‚º 0ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SHOW&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">STATUS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ONGOING_ANONYMOUS_TRANSACTION_COUNT&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è©²å€¼å°±æ˜¯å°šæœª commit ANONYMOUS Transaction æ•¸é‡ï¼Œå› æ­¤å¿…é ˆç¢ºèªè©²å€¼ç‚º 0 è¡¨ç¤ºæ²’æœ‰ ANONYMOUS Transaction éƒ½æ˜¯ GTID Transaction ã€‚&lt;/p>
&lt;ul>
&lt;li>ONGOING_ANONYMOUS_TRANSACTION_COUNT å¢æ¸›çš„æ™‚æ©Ÿ
&lt;ul>
&lt;li>åœ¨ Master ä¸Š
&lt;ul>
&lt;li>å¢åŠ ï¼šç•¶ FLUSH éšæ®µåˆ†é… GTID æ™‚ï¼Œå¦‚æœç‚º ANONYMOUS Transaction å‰‡å¢åŠ è©²è¨ˆæ•¸ã€‚&lt;/li>
&lt;li>æ¸›å°‘ï¼šåœ¨ COMMIT éšæ®µ InnoDB COMMIT ä¹‹å¾Œæœƒæ¸›å°‘è©²è¨ˆæ•¸ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>åœ¨ Slave ä¸Š
&lt;ul>
&lt;li>å¢åŠ ï¼šç•¶ SQL Tread æ‡‰ç”¨åˆ° ANONYMOUS Transaction å‰‡å¢åŠ è©²è¨ˆæ•¸ã€‚&lt;/li>
&lt;li>æ¸›å°‘ï¼šç•¶ SQL Tread åŸ·è¡Œ InnoDB COMMIT ä¹‹å¾Œæœƒæ¸›å°‘è©²è¨ˆæ•¸ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>ç•¶ ONGOING_ANONYMOUS_TRANSACTION_COUNT éƒ½ç‚º 0 çš„æ™‚å€™ï¼Œç¢ºèªæ‰€æœ‰ slave éƒ½æœ‰åŸ·è¡Œéå°æ‡‰ master binlog çš„ positionï¼Œä¸¦éæŒ‡ä¸èƒ½æœ‰å»¶é²åªæ˜¯è¦ç¢ºä¿æ‰€æœ‰çš„ ANONYMOUS Transaction éƒ½å·²ç¶“è¢«åŸ·è¡Œã€‚&lt;/p>
&lt;p>åœ¨ Master ä»¥ä¸‹æŒ‡ä»¤ï¼Œ ç²å– Master binlogã€Master position&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">ç²å–&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Master&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">binlog&lt;/span>&lt;span class="err">ã€&lt;/span>&lt;span class="n">Master&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">position&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SHOW&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MASTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">STATUS&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="k">G&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ Slave åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œç¢ºèª slave æ˜¯å¦å·²åŸ·è¡Œ master å°æ‡‰çš„ binlog åŠ position&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">ç¢ºèª&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">slave&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">æ˜¯å¦å·²åŸ·è¡Œ&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å°æ‡‰çš„&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">binlog&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">åŠ&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">position&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MASTER_POS_WAIT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">position&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¦‚æœ binlog æœ‰ç”¨æ–¼ replication ä»¥å¤–çš„ç”¨é€” (ä¾‹å¦‚ï¼šåŸºæ–¼æ™‚é–“é»çš„å‚™ä»½å’Œæ¢å¾©)ï¼Œè«‹åœ¨æ­¤æ™‚ç¢ºä¿åŒ…å« ANONYMOUS Transaction çš„ Binlog å·²ä¸å†éœ€è¦ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼šåœ¨ç¬¬ 6 æ­¥å®Œæˆå¾Œï¼Œåœ¨å‚™ä»½æ©Ÿä¸ŠåŸ·è¡Œ flush logs å¾Œé€²è¡Œå‚™ä»½ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server è¨­ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">GLOBAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GTID_MODE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰€æœ‰çš„ MySQL server çš„ my.cnf ä¸­æ·»åŠ &lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">gtid_mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">enforce_gtid_consistency&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨ slave åŸ·è¡Œ change master&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">STOP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SLAVE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHANNEL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;channel&amp;#39;&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">CHANGE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MASTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MASTER_AUTO_POSITION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHANNEL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;channel&amp;#39;&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SLAVE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHANNEL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;channel&amp;#39;&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="gtid-ä¸­çš„ç¶­é‹">GTID ä¸­çš„ç¶­é‹
&lt;/h2>&lt;h3 id="show-slave-status">SHOW SLAVE STATUS
&lt;/h3>&lt;p>åœ¨é–‹å•Ÿ GTID å¾Œï¼Œé€é SHOW SLAVE STATUS æœƒå¢åŠ ä»¥ä¸‹è³‡è¨Šï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Retrieved_Gtid_Setï¼šSlave å¾ Master æ”¶åˆ°çš„ GTID SETï¼Œä¹Ÿå°±æ˜¯ IO_Thread å·²ç¶“æ¥æ”¶åˆ°çš„ GTIDã€‚&lt;/p>
&lt;p>ç•¶ relay-log-recovery = 1 æˆ– RESET SLAVE æˆ– CHANGE MASTER æ™‚æœƒè¢«æ¸…ç©ºã€‚&lt;/p>
&lt;p>ç•¶ relay-log-recovery = 0 æ™‚ï¼Œåœ¨ MySQL é‡å•Ÿæ™‚æœƒå¾ relay log ä¸­æƒæç¢ºèªã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Executed_Gtid_Setï¼šSlave å·²ç¶“åŸ·è¡Œçš„ GTID SET (åŒ…å«ç›´æ¥åœ¨ slave ä¸ŠåŸ·è¡Œçš„èªå¥)ï¼Œç­‰åŒæ–¼ gtid_executedã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ¸…é™¤-gtid-æ­·å²ç´€éŒ„">æ¸…é™¤ GTID æ­·å²ç´€éŒ„
&lt;/h3>&lt;p>å¦‚æœè¦å®Œå…¨æ¸…æ¥š GTID æ­·å²ç´€éŒ„å¯ä»¥ä½¿ç”¨ RESET MASTER æŒ‡ä»¤ã€‚&lt;/p>
&lt;p>åŸ·è¡Œå‰å‹™å¿…å‚™ä»½ binlogã€binlog index æ–‡ä»¶ï¼Œç²å–ä¸¦ä¸”ä¿å­˜ gtid_executed è®Šé‡ã€‚&lt;/p>
&lt;p>RESET MASTER åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>gtid_purged è¢«è¨­ç‚ºç©ºå­—ä¸²ã€‚&lt;/li>
&lt;li>gtid_executed è¢«è¨­ç‚ºç©ºå­—ä¸²ã€‚&lt;/li>
&lt;li>mysql.gtid_executed è¡¨è¢«æ¸…ç©ºã€‚&lt;/li>
&lt;li>åˆªé™¤ç¾æœ‰ binlogï¼Œä¸¦æ¸…é™¤ binlog index æ–‡ä»¶ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„åªæœ‰ RESET MSTER æœƒé‡ç½® GTID çš„æ­·å²ç´€éŒ„ï¼ŒRESET SLAVE æ²’æœ‰ä»»ä½•å½±éŸ¿ã€‚&lt;/p>
&lt;h3 id="è·³éä¸€å€‹-transaction">è·³éä¸€å€‹ Transaction
&lt;/h3>&lt;p>ç•¶æœ‰ Transaction åœ¨ SQL_Thread ä¸­ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå¯ä»¥é€é performance_schema ä¸­çš„&lt;code>replication_applier_status_by_worker&lt;/code> è©²è¡¨ä¸­çš„ APPLYING_TRANSACTION æ¬„ä½ç²å–è©² Transaction çš„ GTIDã€‚&lt;/p>
&lt;p>ç•¶ç¢ºèªè¦è·³éè©²å¤±æ•—çš„ Transaction æ™‚ï¼Œåœ¨ GTID æ¨¡å¼ä¸‹å‚³çµ±çš„ sql_slave_skip_counter ä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ˜¯è¦ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">STOP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SLAVE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å°‡&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID_NEXT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">è¨­ç‚ºè¦è·³éçš„&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Transaction&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID_NEXT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;aaa-bbb-ccc-ddd:N&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å°‡è©²&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Transaction&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">è¨­ç‚ºä¸€å€‹ç©º&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Transaction&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GTID_NEXT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;AUTOMATIC&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SLAVE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä¸Šè¿°æ­¥é©Ÿå¾Œæœƒå°‡è¦è·³éçš„ GTID è¨­ç‚ºä¸€å€‹ç©ºçš„ Transaction ä¸¦å°‡å…¶æ‡‰ç”¨ï¼Œæ­¤æ™‚ slave æœƒèªç‚ºè‡ªå·±å·²åŸ·è¡Œå®Œç•¢è©² GTIDï¼Œå› æ­¤å¯ä»¥å°‡ GTID_NEXT è¨­å› &lt;code>AUTOMATIC&lt;/code> è®“ slave è‡ªè¡Œæ‰¾åˆ°ä¸‹ä¸€å€‹è¦åŸ·è¡Œçš„ GTIDã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯æœ‰å¤šå€‹ channel çš„ slaveï¼Œcommit ä¸€å€‹ç©ºçš„ Transaction æ™‚ä¸éœ€è¦æŒ‡å®š channelï¼Œåªæœ‰åœ¨ START SLAVE æ‰éœ€è¦æŒ‡å®š channel åç¨±ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸é©ç”¨ ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS&lt;/p>
&lt;p>åƒè€ƒ&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-administration-skip.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 17.1.7.3 Skipping Transactions&lt;/a>&lt;/p>
&lt;h3 id="mysqldump-è¡Œç‚ºçš„è®ŠåŒ–">mysqldump è¡Œç‚ºçš„è®ŠåŒ–
&lt;/h3>&lt;p>mysqldump åœ¨é–‹å•Ÿ gtid å¾Œé è¨­çš„ dump è¡Œç‚ºæœƒæœ‰æ‰€æ”¹è®Šï¼Œé€™æ˜¯å› ç‚º &lt;code>--set-gtid-purged&lt;/code> è©²é¸é …é è¨­å€¼çš„å½±éŸ¿ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>AUTO (é è¨­å€¼)ï¼šåœ¨é–‹å•Ÿ GTID (gtid_mode = ON) æ™‚è‡ªå‹•è¨­ç‚º ONï¼Œåœ¨æœªé–‹å•Ÿ GTID (gtid_mode = OFF) æ™‚è‡ªå‹•è¨­ç‚º OFFã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ONï¼šå‚™ä»½æª”ä¸­æœƒåŒ…å« &lt;code>gtid_purgrd&lt;/code> ä¸”æœƒæ·»åŠ  &lt;code>sql_log_bin = 0&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">SET @MYSQLDUMP_TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SET @@SESSION.SQL_LOG_BIN= 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-- GTID state at the beginning of the backup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SET @@GLOBAL.GTID_PURGED=&amp;#39;42fe5059-32a7-11e6-9d29-000c29fcecda:1&amp;#39;;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£çš„è¨­ç½®ä¸‹æœƒæœ‰ä»¥ä¸‹çµæœï¼š&lt;/p>
&lt;ul>
&lt;li>è¨­ç½® &lt;code>sql_log_bin = 0&lt;/code>ï¼šé—œé–‰äº† binlog ç´€éŒ„ï¼Œå› æ­¤é‚„åŸçš„æ©Ÿå™¨ä¸æœƒç”Ÿæˆæ–°çš„ GTIDã€‚&lt;/li>
&lt;li>è¨­ç½® &lt;code>gtid_purgrd&lt;/code> ï¼šåŒæ™‚ä¹ŸæœƒåŒæ™‚ä¿®æ”¹ &lt;code>gtid_executed&lt;/code> å€¼åŠ &lt;code>mysql.gtid_executed&lt;/code> è¡¨ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ­¤è¨­ç½®é©åˆç”¨æ–¼é‚„åŸä¸€å€‹ slave æ¥ä¸Šå‚™ä»½æª”ä¾†æºçš„ replication topologyã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>OFFï¼šå‚™ä»½æª”ä¸­ä¸æœƒåŒ…å« &lt;code>gtid_purgrd&lt;/code> ä¸”ä¸æœƒæ·»åŠ  &lt;code>sql_log_bin = 0&lt;/code>ï¼Œæ­¤è¨­ç½®ç”¨æ–¼æœªé–‹å•Ÿ GTID çš„ MySQL æˆ–æ˜¯é©åˆæ–¼é‚„åŸä¸€å€‹å’ŒåŸæœ¬ replication topology ç„¡é—œçš„æ–° masterã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>COMMENTEDï¼šå¾ 8.0.17 é–‹å§‹å¯ç”¨ï¼Œå‚™ä»½æª”ä¸­æœƒæ·»åŠ  &lt;code>sql_log_bin = 0&lt;/code>ï¼Œä¸¦åœ¨å‚™ä»½ä¸­ç”¨è¨»è§£çš„æ–¹å¼è¨˜éŒ„ &lt;code>gtid_purgrd&lt;/code>ã€‚æ­¤æ–¹å¼è¼ƒç‚ºå½ˆæ€§é©åˆï¼Œç”¨æ–¼ä¸éœ€ç”Ÿæˆæ–°çš„ gtid (åŸºæœ¬ä¸Šè¡¨ç¤ºæœƒåœ¨åŒä¸€å€‹ replication topology) ä½†æƒ…å¢ƒè¼ƒç‚ºè¤‡é›œçš„éœ€è¦è‡ªè¡Œèª¿æ•´ &lt;code>gtid_purgrd&lt;/code> æ™‚ï¼Œä¾‹å¦‚ï¼šé‚„åŸå¾Œçš„æ©Ÿå™¨æœƒæœ‰å¤šå€‹ channelã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å› æ­¤ç•¶é–‹å•Ÿ gtid å¾Œåœ¨ä½¿ç”¨ mysqldump æ™‚éœ€è¦æ³¨æ„ &lt;code>--set-gtid-purged&lt;/code> çš„è¨­ç½®ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ç•¶ &lt;code>gtid_mode = OFF&lt;/code> æœªé–‹å•Ÿ GTID æ™‚ï¼Œå¯ä»¥ä¸éœ€è¦èª¿æ•´è©²åƒæ•¸æˆ–é¡¯å¼æŒ‡å®šç‚º OFFã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶ &lt;code>gtid_mode = ON&lt;/code> é–‹å•Ÿ GTID æ™‚ï¼Œè‹¥ç”¨æ–¼é‚„åŸåˆ°åŒä¸€å€‹ replication topology çš„æ©Ÿå™¨ï¼Œä¾‹å¦‚ï¼šæ–°å¢ä¸€å€‹ slaveã€ç‚º slave è£œä¸Šåœ¨ master binlog ä¸Šå·²ç¶“ purge çš„è³‡æ–™â€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥ä¿ç•™é è¨­å€¼æˆ–é¡¯å¼æŒ‡å®šç‚º &lt;code>ON&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶ &lt;code>gtid_mode = ON&lt;/code> é–‹å•Ÿ GTID æ™‚ï¼Œä½†é‚„åŸåˆ°ä¸åŒ replication topology çš„æ©Ÿå™¨æˆ–éœ€è¦ç”Ÿæˆæ–°çš„ GTIDï¼Œä¾‹å¦‚ï¼šé‚„åŸæˆä¸€å€‹æ–°çš„ masterâ€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥è¨­ç½®ç‚º &lt;code>OFF&lt;/code>ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šå¦‚æœåœ¨åŒä¸€å€‹ replication topology ä¸­è¨­ç½® OFFï¼Œé™¤äº†å¯èƒ½ MS ç„¡æ³•é †åˆ©å»ºç½®ï¼Œä¹Ÿå¯èƒ½å°è‡´åœ¨ MS åˆ‡æ›æ™‚ æ–° Slave (åŸæœ¬çš„ Master) æœƒæ”¶åˆ° æ–° Master (åŸæœ¬çš„ Slave) é€éå‚™ä»½æª”é‚„åŸçš„è³‡æ–™å°è‡´é‡è¤‡åŸ·è¡Œçš„å•é¡Œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç•¶ &lt;code>gtid_mode = ON&lt;/code> é–‹å•Ÿ GTID æ™‚ï¼Œé›–ç„¶ä¸éœ€è¦ç”Ÿæˆæ–°çš„ GTID ä½†æƒ…æ³ç‰¹æ®Šéœ€è¦æ‰‹å‹•è¨­ç½® &lt;code>gtid_purged&lt;/code> æ™‚ï¼Œä¾‹å¦‚ï¼šé‚„åŸçš„ Slave ä¸Šæœ‰å¤šå€‹ channel â€¦â€¦ç­‰ï¼Œé€™æ™‚å€™å°±å¯ä»¥è¨­ç½®ç‚º &lt;code>COMMENTED&lt;/code> å¾Œï¼Œæ ¹æ“šå¯¦éš›éœ€è¦æ‰‹å‹•èª¿æ•´è©²æ©Ÿå™¨çš„ &lt;code>gtid_purgrd&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="replication-filter">Replication filter
&lt;/h3>&lt;p>æ›¾ç¶“ç·šä¸Šç’°å¢ƒå¾å‚³çµ± Position é»ä½çš„ Replication åˆ‡æ›åˆ° GTID æ™‚ç™¼ç”Ÿäº†å•é¡Œ&lt;/p>
&lt;p>Replication æ‹“æ¨¸çµæ§‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>A Instance çš„ test database åŒæ™‚åŒæ­¥ B, C Instance&lt;/li>
&lt;li>B Instance Replication çµ¦ Cï¼ŒåŒæ™‚è¨­ç½® Replicat_Do_DB ä¸åŒ…å« test database&lt;/li>
&lt;/ul>
&lt;p>ç•¶åˆ‡æ›åˆ° GTID æ™‚ï¼Œæœƒå› ç‚ºä»¥ä¸‹æƒ…æ³ä¸Ÿå¤±è³‡æ–™ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>A åŸ·è¡Œå° test database çš„ç•°å‹• Query åŒæ­¥çµ¦ B, C&lt;/p>
&lt;/li>
&lt;li>
&lt;p>B æ”¶åˆ°ä¸¦åŸ·è¡Œ A å° test database çš„ç•°å‹• Query çµ¦ C&lt;/p>
&lt;/li>
&lt;li>
&lt;p>C æ”¶åˆ° B åŒæ­¥éä¾†çš„ Queryï¼Œä½†å› ç‚º Replicat_Do_DB çš„è¨­ç½®ï¼ŒC ä¸¦ä¸æœƒåŸ·è¡Œ B åŒæ­¥éä¾† test database ç•°å‹•èªæ³•ã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨æ„ï¼š å„˜ç®¡æ²’æœ‰çœŸçš„åŸ·è¡Œï¼Œä½†æ­¤æ™‚è©² GTID æœƒè¢«åŠ å…¥åˆ° C çš„ gtid_executed ä¸­&lt;/strong>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>C éš¨å¾Œæ”¶åˆ° A åŒæ­¥éä¾†çš„ test database ç•°å‹• Queryï¼Œä½†å› ç‚ºè©² GTID åœ¨æ­¥é©Ÿ 3 å·²ç¶“åŸ·è¡Œéï¼Œæ‰€ä»¥ç›´æ¥è·³éã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>è§£æ±ºæ–¹æ¡ˆä¹Ÿå¾ˆç°¡å–®ï¼šç›´æ¥ç§»é™¤ B, C ä¹‹é–“çš„ replication filterï¼Œå› ç‚º GTID ä¸æœƒé‡è¤‡åŸ·è¡Œä¸ç”¨åƒå‚³çµ± Position ä¸€æ¨£éœ€è¦ filter é¿å…é‡è¤‡åŸ·è¡Œã€‚&lt;/p>
&lt;p>æˆªè‡ªå®˜æ–¹æ–‡æª”èªªæ˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Important:&lt;/strong>
For a multi-source replica in a diamond topology (where the replica replicates from two or more sources, which in turn replicate from a common source), when GTID-based replication is in use, ensure that any replication filters or other channel configuration are identical on all channels on the multi-source replica. With GTID-based replication, filters are applied only to the transaction data, and GTIDs are not filtered out. This happens so that a replicaâ€™s GTID set stays consistent with the sourceâ€™s, meaning GTID auto-positioning can be used without re-acquiring filtered out transactions each time. In the case where the downstream replica is multi-source and receives the same transaction from multiple sources in a diamond topology, the downstream replica now has multiple versions of the transaction, and the result depends on which channel applies the transaction first. The second channel to attempt it skips the transaction using GTID auto-skip, because the transactionâ€™s GTID was added to theÂ &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-gtids.html#sysvar_gtid_executed" target="_blank" rel="noopener"
>&lt;code>gtid_executed&lt;/code>&lt;/a>Â set by the first channel. With identical filtering on the channels, there is no problem because all versions of the transaction contain the same data, so the results are the same. However, with different filtering on the channels, the database can become inconsistent and replication can hang.&lt;/p>&lt;/blockquote>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-rules-channel-based-filters.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 17.2.5.4 Replication Channel Based Filters&lt;/a>&lt;/p></description></item><item><title>MySQL8.0 å°æ–¼ replication delay è§€æ¸¬æ”¹é€²</title><link>https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/</link><pubDate>Fri, 23 Dec 2022 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/</guid><description>&lt;p>åœ¨ MySQL 8.0 ä¹‹å‰åªèƒ½å¾ SHOW SLAVE STATUS ä¸­çš„ Second_Behind_Master ä¾†ç¢ºèª replication delayï¼Œä½†æ˜¯é€™å°æ–¼è¤‡é›œçš„ replication topologies (æ‹“æ’²) ä¸é©ç”¨ï¼Œä¾‹å¦‚ï¼š&lt;/p>
&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/replication-topologies.png"
width="541"
height="199"
srcset="https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/replication-topologies_hu_dcadaa07f61f2deb.png 480w, https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/replication-topologies_hu_d274762f2eeb78e.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="271"
data-flex-basis="652px"
>&lt;/p>
&lt;p>å¦‚ä¸Šåœ–ï¼Œåœ¨ 8.0 ä¹‹å‰æˆ‘å€‘åœ¨ C çš„æ©Ÿå™¨åªèƒ½çŸ¥é“ Bã€C ä¹‹é–“çš„ replication delayï¼Œç„¡æ³•çŸ¥é“ Aã€C ä¹‹é–“çš„ replication delayï¼Œè€Œ MySQL 8.0 é€²è¡Œäº†ä¸€äº›æ”¹å–„ã€‚&lt;/p>
&lt;h2 id="replication-delay-timestamps">&lt;strong>Replication Delay Timestamps&lt;/strong>
&lt;/h2>&lt;p>MySQL 8.0 é–‹å§‹æä¾›äº†æ–°çš„æ–¹å¼ä¾†æ¸¬é‡ replication delayï¼Œæ–¹æ³•æ˜¯åœ¨ binlog ä¸­ç‚º Transaction æ·»åŠ ä»¥ä¸‹å…©å€‹æ™‚é–“æˆ³ï¼š&lt;/p>
&lt;ul>
&lt;li>original_commit_timestampï¼šç´€éŒ„ Transaction åœ¨æœ€åŸæœ¬çš„ Master commit çš„æ™‚é–“æˆ³&lt;/li>
&lt;li>immediate_commit_timestampï¼šç´€éŒ„ Transaction åœ¨ Slave é€£ç·šçš„ Master ä¸Š commit çš„æ™‚é–“æˆ³&lt;/li>
&lt;/ul>
&lt;p>é€é mysqlbinlog æŒ‡ä»¤æŸ¥çœ‹ MySQL 8.0 ä¹‹å¾Œçš„ binlogï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#221202 18:02:25 server id 1 end_log_pos 707 CRC32 0xf8ff712d Anonymous_GTID last_committed=2 sequence_number=3 rbr_only=yes original_committed_timestamp=1669975345432917 immediate_commit_timestamp=1669975527438008 transaction_length=357
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># original_commit_timestamp=1669975345432917 (2022-12-02 18:02:25.432917 CST)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># immediate_commit_timestamp=1669975527438008 (2022-12-02 18:05:27.438008 CST)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!80001 SET @@session.original_commit_timestamp=1669975345432917*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!80014 SET @@session.original_server_version=80031*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!80014 SET @@session.immediate_server_version=80031*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SET @@SESSION.GTID_NEXT= &amp;#39;ANONYMOUS&amp;#39;/*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># at 707
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>åœ¨æ‰€æœ‰çš„ Replica ä¸­ï¼Œæ‰€æœ‰è¢«å›æ”¾çš„ Transaction å…¶ original_commit_timestamp å§‹çµ‚ç›¸åŒï¼Œéƒ½æ˜¯æœ€æºé ­çš„ Source åŸ·è¡Œè©² Query æ™‚ commit çš„æ™‚é–“ã€‚&lt;/li>
&lt;li>åœ¨æºé ­çš„ Source binlog ä¸­ original_commit_timestamp ç­‰æ–¼ immediate_commit_timestampã€‚&lt;/li>
&lt;li>åœ¨ Replica çš„ relay log ä¸­å…¶ original_commit_timestamp ã€immediate_commit_timestamp æœƒç­‰æ–¼å…¶é€£ç·š Source ä¸Šçš„ binlog ç´€éŒ„ã€‚&lt;/li>
&lt;li>åœ¨ Replica çš„ binlog ä¸­ï¼Œimmediate_commit_timestamp æ˜¯è‡ªå·± commit çš„æ™‚é–“æˆ³ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="monitoring-replication-delay">&lt;strong>Monitoring Replication Delay&lt;/strong>
&lt;/h2>&lt;p>é™¤äº†æ·»åŠ äº†æ–°çš„ replication delay timestampï¼Œ8.0 ä¹Ÿåœ¨ performance_schema ä¸­æ–°å¢ä»¥ä¸‹ä¸‰å¼µè¡¨æ–¹ä¾¿è§€å¯Ÿ replication delayï¼š&lt;/p>
&lt;ul>
&lt;li>replication_connection_statusï¼šç´€éŒ„ IO_THREAD åœ¨å¯«å…¥ relay log çš„å·¥ä½œç‹€æ…‹ã€‚
&lt;ul>
&lt;li>
&lt;p>LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP&lt;/p>
&lt;p>æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction å…¶ original_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LAST_QUEUED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction å…¶ immediate_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LAST_QUEUED_TRANSACTION_START_QUEUE_TIMESTAMP
æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction çš„é–‹å§‹æ™‚é–“ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP
æœ€å¾Œä¸€å€‹å·²å¯«å…¥ relay log çš„ Transaction çš„çµæŸæ™‚é–“ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>QUEUEING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
æ­£åœ¨å¯«å…¥ relay log çš„ Transaction å…¶ original_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>QUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
æ­£åœ¨å¯«å…¥ relay log çš„ Transaction å…¶ immediate_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>QUEUEING_TRANSACTION_START_QUEUE_TIMESTAMP
æ­£åœ¨å¯«å…¥ relay log çš„ Transaction å…¶é–‹å§‹å¯«å…¥çš„æ™‚é–“ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>replication_applier_status_by_workerï¼šè¨˜éŒ„æ¯ä¸€æ¢ SQL_THREAD çš„å·¥ä½œç‹€æ…‹ã€‚
&lt;ul>
&lt;li>LAST_APPLIED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶ original_commit_timestampã€‚&lt;/li>
&lt;li>LAST_APPLIED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶ immediate_commit_timestampã€‚&lt;/li>
&lt;li>LAST_APPLIED_TRANSACTION_START_APPLY_TIMESTAMP
æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶å›æ”¾çš„é–‹å§‹æ™‚é–“ã€‚&lt;/li>
&lt;li>LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP
æœ€å¾Œä¸€å€‹è¢«å›æ”¾çš„ Transaction å…¶å›æ”¾çš„çµæŸæ™‚é–“ã€‚&lt;/li>
&lt;li>APPLYING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
æ­£åœ¨è¢«å›æ”¾çš„ Transaction å…¶ original_commit_timestampã€‚&lt;/li>
&lt;li>APPLYING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
æ­£åœ¨è¢«å›æ”¾çš„ Transaction å…¶ immediate_commit_timestampã€‚&lt;/li>
&lt;li>APPLYING_TRANSACTION_START_APPLY_TIMESTAMP
æ­£åœ¨è¢«å›æ”¾çš„ Transaction å…¶å›æ”¾çš„é–‹å§‹æ™‚é–“ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>replication_applier_status_by_coordinatorï¼šç´€éŒ„ MTS ä¸­çš„ Coordinator ç·šç¨‹çš„å·¥ä½œç‹€æ…‹ï¼Œç•¶æœªé–‹å•Ÿ MTS æ­¤è¡¨ç‚ºç©ºã€‚
&lt;ul>
&lt;li>
&lt;p>LAST_PROCESSED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
æœ€å¾Œä¸€å€‹è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ original_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LAST_PROCESSED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
æœ€å¾Œä¸€å€‹è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ immediate_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LAST_PROCESSED_TRANSACTION_START_BUFFER_TIMESTAMP
æœ€å¾Œä¸€å€‹ Transaction ä»€éº¼æ™‚å€™é–‹å§‹è¢« Coordinator å¯«å…¥ Worker ç·šç¨‹çš„ bufferã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LAST_PROCESSED_TRANSACTION_END_BUFFER_TIMESTAMP&lt;/p>
&lt;p>æœ€å¾Œä¸€å€‹ Transaction ä»€éº¼æ™‚å€™è¢« Coordinator å¯«å…¥ Worker ç·šç¨‹çš„ bufferã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PROCESSING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP&lt;/p>
&lt;p>æ­£åœ¨è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ original_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PROCESSING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
æ­£åœ¨è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶ immediate_commit_timestampã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PROCESSING_TRANSACTION_START_BUFFER_TIMESTAMP&lt;/p>
&lt;p>æ­£åœ¨è¢« Coordinator ç·šç¨‹è™•ç†çš„ Transaction å…¶é–‹å§‹å¯«å…¥ Worker ç·šç¨‹çš„ buffer çš„æ™‚é–“ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„ï¼šé€™äº› Table ä¸­çš„ immediate_commit_timestamp éƒ½æ˜¯å¾ &lt;code>relay log&lt;/code> ä¸­å–å¾—ã€‚&lt;/p>
&lt;h2 id="ç¯„ä¾‹">ç¯„ä¾‹
&lt;/h2>&lt;p>&lt;img src="https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/replication-topologies.png"
width="541"
height="199"
srcset="https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/replication-topologies_hu_dcadaa07f61f2deb.png 480w, https://FuweaY.github.io/p/mysql-replication-delay-observation-improve/replication-topologies_hu_d274762f2eeb78e.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="271"
data-flex-basis="652px"
>&lt;/p>
&lt;ol>
&lt;li>
&lt;p>è§€å¯Ÿ A â†’ C ä¹‹é–“å®Œæ•´çš„å»¶é²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMEDIFF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LAST_APPLIED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_applier_status_by_worker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è§€å¯Ÿ B â†’ C ä¹‹é–“å®Œæ•´çš„å»¶é²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMEDIFF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LAST_APPLIED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_applier_status_by_worker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>C æ­£åœ¨å›æ”¾çš„ Transaction å’Œ B çš„å»¶é²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMEDIFF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">APPLYING_TRANSACTION_START_APPLY_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">APPLYING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_applier_status_by_worker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é–‹å•Ÿ MTS æ™‚ï¼ŒCoordinator æ­£åœ¨è™•ç†çš„ Transaction å’Œ B çš„å»¶é²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIME_DIFF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSING_TRANSACTION_START_BUFFER_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PROCESSING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_applier_status_by_coordinator&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è§€å¯Ÿ C relaylog ä¸­æœ€å¾Œå¯«å…¥çš„ Transaction åœ¨ A commit çš„å»¶é²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMEDIFF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_connection_status&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è§€å¯Ÿ B â†’ C ä¹‹é–“ relaylog çš„å¯«å…¥å»¶é²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMEDIFF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">QUEUEING_TRANSACTION_START_QUEUE_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">QUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">performance_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">replication_connection_status&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="å…¶ä»–ç”¨é€”">å…¶ä»–ç”¨é€”
&lt;/h2>&lt;p>åœ¨ binlog ä¸­æˆ‘å€‘çŸ¥é“æœ‰ exec_time é€™å€‹å€¼ï¼Œä½†é€™å€‹å€¼ä¸¦ä¸èƒ½è®“æˆ‘å€‘æº–ç¢ºçš„çŸ¥é“ Transaction commit çš„ç¢ºåˆ‡æ™‚é–“ï¼Œä½†åœ¨ MySQL 8.0 ä¹‹å¾Œæˆ‘å€‘å¯ä»¥é€éè§€æ¸¬ original_commit_timestamp ä¾†ç¢ºèªï¼Œåƒè€ƒä»¥ä¸‹ä¾‹å­ï¼šåœ¨ä¸€å¼µè¡¨ä¸ŠåŸ·è¡Œäº† 458752 ç­†è³‡æ–™çš„ updateï¼Œç¸½è¨ˆèŠ±è²»æ™‚é–“ 13.62 sec&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">update&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2000&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="c1">---------------------+
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="c1">---------------------+
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2022&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">06&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">55&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">06&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="c1">---------------------+
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">458752&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">13&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">62&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">Rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">matched&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">524288&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Changed&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">458752&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è®“æˆ‘å€‘çœ‹ä¸€ä¸‹ binlogï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#221206 16:55:06 server id 1 end_log_pos 241 CRC32 0x4cc632cf Anonymous_GTID last_committed=0 sequence_number=1 rbr_only=yes original_committed_timestamp=1670316919294397 immediate_commit_timestamp=1670316919294397 transaction_length=190792863
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># original_commit_timestamp=1670316919294397 (2022-12-06 16:55:19.294397 CST)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># immediate_commit_timestamp=1670316919294397 (2022-12-06 16:55:19.294397 CST)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!80001 SET @@session.original_commit_timestamp=1670316919294397*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!80014 SET @@session.original_server_version=80021*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/*!80014 SET @@session.immediate_server_version=80021*//*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SET @@SESSION.GTID_NEXT= &amp;#39;ANONYMOUS&amp;#39;/*!*/;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># at 241
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#221206 16:55:06 server id 1 end_log_pos 325 CRC32 0x3035566a Query thread_id=2244 exec_time=1 error_code=0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#221206 16:55:06 server id 1 end_log_pos 384 CRC32 0xeed08d18 Rows_query
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># update t1 set name=repeat(&amp;#39;c&amp;#39;,2000)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° exec_time é¡¯ç¤ºçš„æ˜¯ 1ï¼Œè€Œä¸æ˜¯æ­£ç¢ºçš„åŸ·è¡Œæ™‚é–“ï¼Œé€™æ˜¯å› ç‚º exec_time æŒ‡çš„æ˜¯ update ç¬¬ä¸€ç­†è³‡æ–™èŠ±è²»çš„æ™‚é–“ï¼Œè€Œä¸æ˜¯æ•´å€‹ update èªå¥åŸ·è¡Œçš„æ™‚é–“ã€‚&lt;/p>
&lt;p>ä¸éå¾ MySQL 8.0 é–‹å§‹æˆ‘å€‘å°±å¯ä»¥é€é transaction é–‹å§‹æ™‚é–“ (ä¹Ÿå°±æ˜¯ 16:55:06) å’Œ transaction commit çš„æ™‚é–“ - immediate_commit_timestamp (ä¹Ÿå°±æ˜¯ 16:55:19) åˆ¤æ–·å‡ºé€™å€‹ transaction åŸ·è¡Œäº† 13 secã€‚&lt;/p>
&lt;h2 id="åƒè€ƒ">åƒè€ƒ
&lt;/h2>&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-delayed.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 17.4.11 Delayed Replication&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=7319" target="_blank" rel="noopener"
>MySQL :: WL#7319: Infrastructure for GTID based delayed replication and replication lag monitoring&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/worklog/task/?id=7374" target="_blank" rel="noopener"
>MySQL :: WL#7374: Performance schema tables to monitor replication lags and queue&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/110874581" target="_blank" rel="noopener"
>æ–°ç‰¹æ€§è§£è¯» | MySQL 8 å¤åˆ¶å»¶è¿Ÿè§‚æµ‹æ–°æ–¹å¼ï¼Œæ›´å…¨é¢æ›´ç²¾å‡† - çŸ¥ä¹ (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/nanxiang/p/13062989.html" target="_blank" rel="noopener"
>binlogè®°å½•SQLæ‰§è¡Œæ—¶é—´å—ï¼Œå‡†ä¸å‡†ï¼Œæ—¶é—´æ˜¯å¦åŒ…å«é”ç­‰å¾…æ—¶é—´ - æŸ´ç±³æ²¹ç›é…±é†‹ - åšå®¢å›­ (cnblogs.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2016/03/09/" target="_blank" rel="noopener"
>MySQL Â· ç­”ç–‘è§£æƒ‘ Â· å¤‡åº“Seconds_Behind_Masterè®¡ç®— (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/zhenxing/p/15102590.html" target="_blank" rel="noopener"
>MySQL å¤åˆ¶å»¶è¿Ÿè®¡ç®—çš„é—®é¢˜åˆ†æ - ZhenXing_Yu - åšå®¢å›­ (cnblogs.com)&lt;/a>&lt;/p></description></item></channel></rss>