<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PostgreSQL on FuweaY</title><link>https://FuweaY.github.io/categories/postgresql/</link><description>Recent content in PostgreSQL on FuweaY</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Fri, 28 Feb 2020 12:00:00 +0800</lastBuildDate><atom:link href="https://FuweaY.github.io/categories/postgresql/index.xml" rel="self" type="application/rss+xml"/><item><title>PostgreSQL vacuum</title><link>https://FuweaY.github.io/p/postgre-vacuum/</link><pubDate>Fri, 28 Feb 2020 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/postgre-vacuum/</guid><description>&lt;p>在 MySQL 中透過 undo log 來實現 MVCC 的機制，但在 PG 中是將新舊數據都存放在表中，由此產生了表膨脹及 vacuum 的機制。&lt;/p>
&lt;h2 id="mvcc-常用實現方式">MVCC 常用實現方式
&lt;/h2>&lt;p>一般MVCC有2种实现方法：&lt;/p>
&lt;ul>
&lt;li>写新数据时，把旧数据转移到一个单独的地方，如回滚段中，其他人读数据时，从回滚段中把旧的数据读出来，如Oracle数据库和MySQL中的innodb引擎。&lt;/li>
&lt;li>写新数据时，旧数据不删除，而是把新数据插入。PostgreSQL就是使用的这种实现方法。&lt;/li>
&lt;/ul>
&lt;p>两种方法各有利弊，相对于第一种来说，PostgreSQL的MVCC实现方式优缺点如下：&lt;/p>
&lt;ul>
&lt;li>优点
&lt;ul>
&lt;li>无论事务进行了多少操作，事务回滚可以立即完成&lt;/li>
&lt;li>数据可以进行很多更新，不必像Oracle和MySQL的Innodb引擎那样需要经常保证回滚段不会被用完，也不会像oracle数据库那样经常遇到“ORA-1555”错误的困扰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>缺点
&lt;ul>
&lt;li>旧版本的数据需要清理。当然，PostgreSQL 9.x版本中已经增加了自动清理的辅助进程来定期清理&lt;/li>
&lt;li>旧版本的数据可能会导致查询需要扫描的数据块增多，从而导致查询变慢&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>也就是說 PostgresSQL 的 MVCC 實現方式會導致表中堆積無用的舊數據導致表空間的膨脹問題，也因此需要透過定期的 vacuum 或者 auto vacuum 來釋放這些無用的舊數據占用的空間。&lt;/p>
&lt;h2 id="vacuum-指令">vacuum 指令
&lt;/h2>&lt;p>支持以下選項&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>FULL [ ***boolean*** ]&lt;/code>：將表的全部內容重寫到新的 Disk 文件，也就是說能夠確實釋放所有 dead tuple 占用的空間給 OS，但是在完成操作之前不會釋放舊副本的Disk 空間，並且在這期間該表會被加上 &lt;code>ACCESS EXCLUSIVE&lt;/code> LOCK 阻塞所有對該表的操作。&lt;/p>
&lt;p>備註：沒有 FULL 選項的 vacuum 只是回收空間供該表能夠重複使用，並不會將空間釋放給 OS。&lt;/p>
&lt;p>備註：類似於 MySQL OPTIMIZE TABLE。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>FREEZE [ ***boolean*** ]&lt;/code>：選擇積極的 freezing，等同於在 &lt;code>vacuum_freeze_min_age&lt;/code>&lt;strong>、&lt;/strong>&lt;code>vacuum_freeze_table_age&lt;/code> 設置為 0 時運行 vacuum。&lt;/p>
&lt;p>備註：選項 &lt;code>FULL&lt;/code> 總是會積極的 freezing，因此指定 &lt;code>FULL&lt;/code> 選項時無需附帶 &lt;code>FREEZE&lt;/code> 選項。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>VERBOSE [ ***boolean*** ]&lt;/code>：打印 VACUUM 期間的詳細資訊。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ANALYZE [ ***boolean*** ]&lt;/code>：執行 cacuum 後執行 ANALYZE，也就是會更新 planner 使用的統計資訊，確保生成高效的執行計畫。類似於 MySQL 的 ANALYZE TABLE。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>DISABLE_PAGE_SKIPPING [ ***boolean*** ]&lt;/code> ：此選項禁用 page_skpping 行為，通常只有在導致數據庫損壞的軟硬件問題時才需要使用。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>SKIP_LOCKED [ ***boolean*** ]&lt;/code> ：指定 VACUUM 在開始處理 relation 時不等待其他衝突鎖的釋放直接跳過。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>INDEX_CLEANUP { AUTO | ON | OFF }&lt;/code> ：默認值為 AUTO，允許 VACUUM 在適當的情況下跳過 index cleanup 階段。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>PROCESS_TOAST [ ***boolean*** ]&lt;/code> ：此為默認行為，指定 Vacuum 應該嘗試處理對應的 TOAST 表。&lt;/p>
&lt;p>備註：使用選項 &lt;code>FULL&lt;/code> 時，還需要包含此選項。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>TRUNCATE [ ***boolean*** ]&lt;/code> ：指定 VACUUM 應該截斷表末位的空頁，並將其 Disk 空間返回給 OS。&lt;/p>
&lt;p>此為默認行為，除非 vacuum_truncate = false。&lt;/p>
&lt;p>備註：包含選項 &lt;code>FULL&lt;/code> 時，此選項無效。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>PARALLEL ***integer***&lt;/code>：指定 index vacuum、index cleanup 階段時並行縣程數量。&lt;/p>
&lt;p>此選項還受 &lt;code>max_parallel_maintenance_workers&lt;/code> 限制上限，並且只有當 INDEX 大小 &amp;gt; &lt;code>min_parallel_index_scan_size&lt;/code> 時，該 INDEX 才能 parallel vacuum。&lt;/p>
&lt;p>備註：不能與 &lt;code>FULL&lt;/code> 選項一起指定。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>帶有 full 選項的 vacuum 可以在 &lt;code>pg_stat_progress_cluster&lt;/code> 觀察進度，如果不帶有 full 選項的 vacuum 則是在 &lt;code>pg_stat_progress_vacuum&lt;/code> 中觀察進度。&lt;/p>
&lt;h2 id="autovacuum">AutoVacuum
&lt;/h2>&lt;h3 id="簡述">簡述
&lt;/h3>&lt;p>PostgreSQL中的MVCC机制同时存储新旧版本的元组，对于经常更新的表来说，会造成表膨胀的情况。为了解决这个问题，PostgreSQL 引入了 &lt;a class="link" href="https://www.postgresql.org/docs/current/static/sql-vacuum.html" target="_blank" rel="noopener"
>VACUUM&lt;/a> 和 &lt;a class="link" href="https://www.postgresql.org/docs/10/static/sql-analyze.html" target="_blank" rel="noopener"
>ANALYZE&lt;/a> 命令，并且引入了AutoVacuum自动清理。&lt;/p>
&lt;p>在PostgreSQL中，AutoVacuum自动清理操作包括：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>删除或重用无效元组的磁盘空间&lt;/p>
&lt;/li>
&lt;li>
&lt;p>更新数据统计信息，保证执行计划更优&lt;/p>
&lt;/li>
&lt;li>
&lt;p>更新visibility map，加速index-only scans&lt;/p>
&lt;/li>
&lt;li>
&lt;p>避免XID 回卷(wraparound)造成的数据丢失&lt;/p>
&lt;p>在 PG 中 XID 是用32位无符号数来表示的，也就是说如果不引入特殊的处理，当PostgreSQL的XID 到达40亿，会造成溢出，从而新的XID 为0。而按照PostgreSQL的MVCC 机制实现，之前的事务就可以看到这个新事务创建的元组，而新事务不能看到之前事务创建的元组，这违反了事务的可见性。本文将这种现象称为XID 的回卷问题。&lt;/p>
&lt;p>備註：MySQL 為 48 位約 281 兆的量，雖然理論上會發生同樣的狀況，但實務上非常困難。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>为了实现自动清理，PostgreSQL引入了两种类型的辅助进程：&lt;/p>
&lt;ul>
&lt;li>autovacuum launcher：AutoVacuum机制的守护进程，周期性地调度autovacuum worker进程。&lt;/li>
&lt;li>autovacuum worker：进行具体的自动清理工作。&lt;/li>
&lt;/ul>
&lt;h3 id="相關參數">相關參數
&lt;/h3>&lt;h4 id="automatic-vacuuming">&lt;strong>Automatic Vacuuming&lt;/strong>
&lt;/h4>&lt;ul>
&lt;li>
&lt;p>autovacuum (boolean)：是否啟用 auto vacuum 功能，需要啟用 track_counts (默認)，默認是開啟的，另外此參數可以 BY Table 單獨設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_max_workers (integer)：指定 auto vacuum 進程數 (不包含 launcher) 默認值為 3。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_naptime (integer)：設置兩次 auto vacuum 之間的間隔時間，默認值為 1min。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_vacuum_threshold (integer)：與 &lt;code>autovacuum_vacuum_scale_factor&lt;/code> 搭配使用，默認值為 50。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_vacuum_scale_factor (floating point)：當一張表的 update 或 delete 的元組 (tuples) 數超過 &lt;code>autovacuum_vacuum_threshold&lt;/code> + &lt;code>autovacuum_vacuum_scale_factor&lt;/code> * &lt;code>table size&lt;/code> 會觸發 vacuum。預設值為 0.2 (表大小的 20%)，另外此參數可以 BY Table 單獨設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_analyze_threshold (integer)：與 &lt;code>autovacuum_analyze_scale_factor&lt;/code> 搭配使用，默認值為 50。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_analyze_scale_factor (floating point)：當一張表的 update 或 delete 的元組 (tuples) 數超過 &lt;code>autovacuum_analyze_threshold&lt;/code> + &lt;code>autovacuum_analyze_scale_factor&lt;/code> * &lt;code>table size&lt;/code> 會觸發 ANALYZE。預設值為 0.1 (表大小的 10%)，另外此參數可以 BY Table 單獨設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_vacuum_insert_threshold (integer)：與 &lt;code>autovacuum_vacuum_insert_scale_factor&lt;/code> 搭配使用，默認值為 1000。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_vacuum_insert_scale_factor (floating point)：當一張表 insert 指定的元組 (tuples) 數達到 &lt;code>autovacuum_vacuum_insert_threshold&lt;/code> + &lt;code>autovacuum_vacuum_insert_scale_factor&lt;/code> * &lt;code>table size&lt;/code> 會觸發 vacuum。預設值為 0.2 (表大小的 20%)，另外此參數可以 BY Table 單獨設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_freeze_max_age (integer)：設置當 XID (&lt;code>pg_class&lt;/code>
.&lt;code>relminmxid&lt;/code>)達到此上限值時，必須強制 vacuum 避免 XID 的 wraparound。默認值為 2 億。&lt;/p>
&lt;p>注意：即使 autovacuum 沒有開啟仍舊會觸發強制 vacuum 。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_multixact_freeze_max_age (integer)：設置當 multi XID (&lt;code>pg_class&lt;/code>
.&lt;code>relminmxid&lt;/code>)上限值達到此上限值時，必須強制 vacuum 避免 XID 的 wraparound。默認值為 4 億。&lt;/p>
&lt;p>注意：即使 autovacuum 沒有開啟仍舊會觸發強制 vacuum 。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_vacuum_cost_limit (integer)：設置 auto vacuum 的開銷限制，默認值為 -1 表示使用 &lt;code>vacuum_cost_limit&lt;/code> 的設定。開銷的計算依據 &lt;code>vacuum_cost_page_hit&lt;/code>, &lt;code>vacuum_cost_page_miss&lt;/code>, &lt;code>vacuum_cost_page_dirty&lt;/code> 的設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>autovacuum_vacuum_cost_delay (floating point)：設置如過超過 &lt;code>autovacuum_vacuum_cost_limit&lt;/code> 上的開銷限制，則需要延遲多少時間清理，默認值為 2 (ms)，當此設定設置為 -1 時表示依照 &lt;code>vacuum_cost_delay&lt;/code> 的設定。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="resource-usage">RESOURCE USAGE
&lt;/h4>&lt;ul>
&lt;li>
&lt;p>autovacuum_work_mem (integer)：指定每個 autovacuum worker 進程使用的最大 memory 量，默認值為 -1 表示使用 &lt;code>maintenance_work_mem&lt;/code>。&lt;/p>
&lt;p>建議單獨設置，因為實際最多可能會消耗 &lt;code>autovacuum_max_workers&lt;/code> * &lt;code>autovacuum_work_mem&lt;/code> 量的 memory，這部分和 &lt;code>maintenance_work_mem&lt;/code> * &lt;code>max_connections&lt;/code> 不同，因此為了更加安全的限制資源使用量應該分開設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>vacuum_cost_page_hit (integer)：清理一个在共享缓存中找到的缓冲区的估计代价。它表示锁住缓冲池、查找共享哈希表和扫描页内容的代价。默认值为1。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>vacuum_cost_page_miss (integer)：清理一个必须从磁盘上读取的缓冲区的代价。它表示锁住缓冲池、查找共享哈希表、从磁盘读取需要的块以及扫描其内容的代价。默认值为10。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>vacuum_cost_page_dirty (integer)：当清理修改一个之前干净的块时需要花费的估计代价。它表示再次把脏块刷出到磁盘所需要的额外I/O。默认值为20。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>vacuum_cost_limit (integer)：設置 vacuum 的開銷限制達到此設置時休眠 &lt;code>vacuum_cost_delay&lt;/code> 的設置，默認值為 200。開銷的計算依據 &lt;code>vacuum_cost_page_hit&lt;/code>, &lt;code>vacuum_cost_page_miss&lt;/code>, &lt;code>vacuum_cost_page_dirty&lt;/code> 的設置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>vacuum_cost_delay (floating point)：如過超過 vacuum 開銷成本達到 &lt;code>vacuum_cost_limit&lt;/code> 限制時需要休眠多久，默認值為 0 表示禁用基於成本計算的 delay 功能。&amp;gt; 0 表示開啟，但一般也不建議設置超過 &amp;gt; 1ms，建議可以保持默認值關閉就好。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="其他">其他
&lt;/h4>&lt;ul>
&lt;li>track_counts (boolean)：是否啟用統計信息收集功能，默認是開啟的，因為 autovacuum 的 launcher 進程需要這些統計資訊。&lt;/li>
&lt;li>log_autovacuum_min_duration (integer)：當 auto vacuum 運行超過該時間或因鎖衝突而退出則會記錄到 log 中，預設值為 10 (min)，若設為 -1 表示禁用。&lt;/li>
&lt;/ul>
&lt;h2 id="設置建議">設置建議
&lt;/h2>&lt;p>固定&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_cost_delay&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以下無用 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_cost_page_hit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_cost_page_miss&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_cost_page_dirty&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_cost_limit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以上無用 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">autovacuum&lt;/span> &lt;span class="o">=&lt;/span> on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">log_autovacuum_min_duration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">autovacuum_analyze_scale_factor&lt;/span> &lt;span class="o">=&lt;/span> 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">autovacuum_freeze_max_age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1200000000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">autovacuum_multixact_freeze_max_age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1400000000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">autovacuum_vacuum_cost_delay&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">autovacuum_vacuum_scale_factor&lt;/span> &lt;span class="o">=&lt;/span> 0.02 &lt;span class="c1"># 0.005~ 0.15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_freeze_table_age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">200000000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vacuum_multixact_freeze_table_age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">200000000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>變動&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">autovacuum_work_mem &lt;span class="c1"># min( 8G, (规格内存*1/8)/autovacuum_max_workers )&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">autovacuum_max_workers &lt;span class="c1"># max(min( 8 , CPU核数/2 ) , 5)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="後記">後記
&lt;/h2>&lt;p>在 PostgreSQL 中因為透過保存舊的 tuples (元組) 來實現 MVCC 機制，容易造成數據的膨脹進而導致儲存空間的消耗也可能降低查詢的效能。&lt;/p>
&lt;p>在開源社區也有持續進行討論，目前內部比較認可的方式是構建一種新的儲存格式，也就是由 *EnterpriseDB 公司主導的 zheap。&lt;/p>
&lt;p>*EnterpriseDB 公司提供基於 PostgreSQL 的企業級產品與服務廠商。&lt;/p>
&lt;h2 id="參考">參考
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.postgresql.org/docs/current/sql-vacuum.html" target="_blank" rel="noopener"
>PostgreSQL: Documentation: 15: VACUUM&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.postgresql.org/docs/current/routine-vacuuming.html" target="_blank" rel="noopener"
>PostgreSQL: Documentation: 15: 25.1. Routine Vacuuming&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2017/10/01/" target="_blank" rel="noopener"
>PgSQL · 特性分析 · MVCC机制浅析 (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2015/12/07/" target="_blank" rel="noopener"
>PgSQL · 答疑解惑 · 表膨胀 (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2017/12/04/" target="_blank" rel="noopener"
>PgSQL · 源码分析 · AutoVacuum机制之autovacuum launcher (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2018/02/04/" target="_blank" rel="noopener"
>PgSQL · 源码分析 · AutoVacuum机制之autovacuum worker (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2019/07/02/" target="_blank" rel="noopener"
>PgSQL · 新特性解读 · undo log 存储接口（上） (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2018/03/08/" target="_blank" rel="noopener"
>PgSQL · 特性分析 · 事务ID回卷问题 (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/digoal/blog/blob/master/201812/20181203_01.md" target="_blank" rel="noopener"
>blog/20181203_01.md at master · digoal/blog · GitHub&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/585906727" target="_blank" rel="noopener"
>【Postgresql】VACUUM 垃圾回收 - 知乎 (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/dbadaily/p/vacuum1.html" target="_blank" rel="noopener"
>PostgreSQL VACUUM 之深入浅出 (一) - DBADaily - 博客园 (cnblogs.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/obvious__/article/details/120710977?spm=1001.2014.3001.5502" target="_blank" rel="noopener"
>PostgreSQL 事务—MVCC_postgresql mvcc_obvious__的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/obvious__/article/details/121318928?spm=1001.2014.3001.5502" target="_blank" rel="noopener"
>PostgreSQL Vacuum&amp;mdash;元组删除_heap_page_obvious__的博客-CSDN博客&lt;/a>&lt;/p></description></item><item><title>PostgreSQL 備份還原</title><link>https://FuweaY.github.io/p/postgre-backup-restore/</link><pubDate>Wed, 26 Feb 2020 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/postgre-backup-restore/</guid><description>&lt;h2 id="pg_dump">pg_dump
&lt;/h2>&lt;p>就像 mysqldump 一樣的效果，將數據 dump 成 SQL 語句。&lt;/p>
&lt;h3 id="備份">備份
&lt;/h3>&lt;p>使用 pg_dump 來備份單個 database：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">/usr/bin/pg_dump &lt;span class="nb">test&lt;/span> &amp;gt; test.dump
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">➜ ~ cat test.dump
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CREATE TABLE public.test &lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id integer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ALTER TABLE public.test OWNER TO postgres&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">COPY public.test &lt;span class="o">(&lt;/span>id&lt;span class="o">)&lt;/span> FROM stdin&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">\.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>預設情況下 dump 出來的備份檔是以 COPY 語句來還原數據，如果需要將 copy 語法變為 insert 可以使用 &lt;code>column-inserts&lt;/code> 並透過 &lt;code>rows-per-insert&lt;/code> 指定一個 insert 語句包含的行數：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">/usr/bin/pg_dump --column-inserts --rows-per-insert &lt;span class="m">2&lt;/span> &lt;span class="nb">test&lt;/span> &amp;gt; test.dump
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># test.dump 中的部分內容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INSERT INTO public.test &lt;span class="o">(&lt;/span>id&lt;span class="o">)&lt;/span> VALUES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INSERT INTO public.test &lt;span class="o">(&lt;/span>id&lt;span class="o">)&lt;/span> VALUES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>3&lt;span class="o">)&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>4&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="還原">還原
&lt;/h3>&lt;p>使用 psql 來還原：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 建立要還原的目標 database&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql --command &lt;span class="s2">&amp;#34;create database test_restore&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 還原&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql test_restore &amp;lt; test.dump
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>預設情況下還原遇到錯誤繼續執行，如果希望可以發生 SQL 錯誤時退出，可以使用以下方式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">psql --set &lt;span class="nv">ON_ERROR_STOP&lt;/span>&lt;span class="o">=&lt;/span>on dbname &amp;lt; dumpfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果還需要更進一步將整個還原過程視為一個 Transaction，可以透過添加 &amp;ndash;single-transaction：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">psql --set &lt;span class="nv">ON_ERROR_STOP&lt;/span>&lt;span class="o">=&lt;/span>on --single-transaction dbname &amp;lt; dumpfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>此外還可以透過 pipeline 的方式在 pg_dump 的同時直接還原：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_dump -h host1 dbname &lt;span class="p">|&lt;/span> psql -h host2 dbname
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="其他事項">其他事項
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>pg_dump 的 User 需要對該 Table 有讀取權限。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>pg_dump 一次只能備份一個 database，並且不包含 role、tablespace (因為他們屬於 cluster 範圍，而不是 database)。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>pg_dump 運行時會執行 database snapshot 來達到內部一致性。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>pg_dump 會和 ALTER 阻塞。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>要一次備份整個 cluster 請使用 pg_dumpall，這會 dump 所有的 database 和 cluster 範圍的數據，例如 role、tablespace。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 備份&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_dumpall &amp;gt; dumpfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 還原&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -f dumpfile postgres
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>但是需要注意因為包含 cluster 範圍的數據，因此必須使用 super user 的權限。&lt;/p>
&lt;p>注意：pg_dumpall 實際上會為每個 database 調用 pg_dump，也就是不保證所有 database snapshot 是同步的。&lt;/p>
&lt;p>此外可以透過 &lt;code>--globals-only&lt;/code> 選項來只有備份 cluster 範圍的數據。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如果在 pg_dump 時使用非純文本的格式(-Fc) 時，可以使用 pg_restore 來還原。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>優點：&lt;/p>
&lt;ol>
&lt;li>可以還原到不同的 RDBMS。&lt;/li>
&lt;li>可以還原到不同版本的 PostgreSQL。&lt;/li>
&lt;/ol>
&lt;p>缺點：&lt;/p>
&lt;ol>
&lt;li>因為等於需要運行每一個 SQL 命令來還原，因此還原速度較慢。&lt;/li>
&lt;/ol>
&lt;h2 id="pg_basebackup">pg_basebackup
&lt;/h2>&lt;p>為 PostgreSQL 內建的物理備份工具，用於對 PostgreSQL 進行全量物理熱備份。&lt;/p>
&lt;p>pg_basebackup 會在備份期間創建一個備份歷史文件，該文件會以備份時的第一個 WAL 文件為命名，例如 &lt;code>000000010000000000000002.00000028.backup&lt;/code> 表示備份時第一個 WAL 名稱是 &lt;code>000000010000000000000002&lt;/code> 另外的 &lt;code>00000028&lt;/code> 表示其中的確切位置 (一般來說可以忽略)，以下是該檔案包含的資訊：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">ed875d053382&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">000000010000000000000002&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00000028&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">backup&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LOCATION&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2000028&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">000000010000000000000002&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">STOP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LOCATION&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2000100&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">000000010000000000000002&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CHECKPOINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LOCATION&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2000060&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">BACKUP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">METHOD&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">streamed&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">BACKUP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">primary&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">01&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">LABEL&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_basebackup&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">backup&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMELINE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">STOP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">02&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">STOP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TIMELINE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>也就是說只需要保存包含 &lt;code>000000010000000000000002&lt;/code> 之後的 WAL 就可以完整的復原。&lt;/p>
&lt;h3 id="範例">範例
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_basebackup -P -D /var/data/backup/pg_back_&lt;span class="k">$(&lt;/span>date +&lt;span class="s2">&amp;#34;%F_%T&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="選項">選項
&lt;/h3>&lt;ul>
&lt;li>-D：指定備份的目的地&lt;/li>
&lt;li>-F、：指定輸出的格式
&lt;ul>
&lt;li>p、plain：預設值，輸出成普通文件。&lt;/li>
&lt;li>t、tar：輸出為 tar 文件。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>-R：創建 standy.signal 文件，並將相關的連接設置附加到 &lt;code>postgresql.auto.conf&lt;/code> 中，用於便於將備份檔用於建置 replica。&lt;/li>
&lt;li>-X：指定備份在備份期間中產生的 WAL。
&lt;ul>
&lt;li>n、none：不備份 WAL。&lt;/li>
&lt;li>f、fetch：將在備份結束後收集 WAL，因此需要有足夠高的 &lt;code>wal_keep_size&lt;/code>，否則可能發生所需的 wal 被回收導致備份無法使用。&lt;/li>
&lt;li>s、stream：默認值，在備份的同時透過 streaming replication 持續傳輸 WAL，這將額外開一個連結來進行 WAL 的備份，&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>-P：顯示進度。&lt;/li>
&lt;/ul>
&lt;h3 id="其他事項-1">其他事項
&lt;/h3>&lt;p>優點：&lt;/p>
&lt;p>缺點：只能備份整個 Instance 無法指定單表。&lt;/p>
&lt;h2 id="continuous-archiving-與-pitr">Continuous archiving 與 PITR
&lt;/h2>&lt;p>只要是數據庫都有最基本的 Durability(持久性) 需要保證，這大部分都是透過 WAL 技術也就是日誌先行來達到，在 MySQL 中是 REDO LOG 而在 PostgreSQL 中則是 WAL (在 PG 10 之前稱為 xlog)。&lt;/p>
&lt;p>因此就像 MySQL 可以透過 xtrabackup 的物理備份加上 binlog 做後續的增量恢復，PostgreSQL 同樣可以透過 pg_basebackup 產生的全量備份加上後續的 WAL 達到增量恢復，這樣還有 &lt;em>point-in-time recovery&lt;/em> 的優勢。&lt;/p>
&lt;h3 id="設置-wal-archining">設置 WAL Archining
&lt;/h3>&lt;p>PostgreSQL 每 16 MB (預設值)就會輪換一個新的 WAL 文件，而當所有的 WAL 超過 max_wal_size 舊的 WAL 會被一一刪除 (依照 checkpoint 判斷是否不再需要對應的 WAL)，為了避免全量備份後所需的 WAL 在經過一陣子後被刪除導致整個全量備份不可用，我們需要為 WAL 設置 Archining 的方式，確保在刪除 WAL 之前有進行歸檔。&lt;/p>
&lt;p>要配置 WAL Archining 需要以下設定：&lt;/p>
&lt;ul>
&lt;li>wal_level = replica | logical&lt;/li>
&lt;li>archive_mode = ON&lt;/li>
&lt;li>arvhive_command = ‘test ! -f /mnt/server/archivedir/%f &amp;amp;&amp;amp; cp %p /mnt/server/archivedir/%f’
&lt;ul>
&lt;li>%f 會被替換成歸檔的 wal 文件名稱。&lt;/li>
&lt;li>%p 會被替換成歸檔的 wal 路徑。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">wal_level&lt;/span> &lt;span class="o">=&lt;/span> replica
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">archive_mode&lt;/span> &lt;span class="o">=&lt;/span> ON
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">arvhive_command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;test ! -f /var/data/xlog_archive/%f &amp;amp;&amp;amp; cp %p /var/data/xlog_archive/%f&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="範例-1">範例
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>透過 pg_basebackup 獲取全量備份&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_basebackup -P -D /var/data/backup/pg_back_&lt;span class="k">$(&lt;/span>date +&lt;span class="s2">&amp;#34;%F_%T&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>關閉 server：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_ctl stop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>對當前的實體檔案暫存，以備不時之需：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -R /var/data/postgres/ /var/data/postgres_backup/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>備註：如果沒有足夠的空間應至少保留 pg_wal 子目錄，因為可能包含尚未 archive 的 wal 需用於稍後恢復。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>清除當前的實體檔案&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">rm -rf /var/data/postgres/*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>從 Base Backup 進行恢復，注意請使用 DB系統用戶 (postgre) 進行包含正確權限的恢復。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -R /var/data/backup/pg_back_2023-04-13_02&lt;span class="se">\:&lt;/span>55&lt;span class="se">\:&lt;/span>49/* /var/data/postgres/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果有使用 tablespace 應該檢查 pg_tblspc 中的 symbolic link 是否正確恢復。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>移除 Base Backup 中的 &lt;code>pg_wal/&lt;/code> 下的所有文件，因為這些是當初 Base Backup 的 wal 文件可能已經過時了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">rm -rf /var/data/postgres/pg_wal/*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>將步驟 2 中保存的未歸檔 wal 文件複製到 pg_wal&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -R /var/data/postgres_backup/pg_wal/* /var/data/postgres/pg_wal/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>在 &lt;code>postgresql.conf&lt;/code> 中設置恢復相關的配置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">restore_command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;cp /var/data/xlog_archive/%f %p&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># recovery_target_time 可以配置恢復到的時間點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># recovery_target_timeline &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>建立 &lt;code>recovery.signal&lt;/code> 文件來觸發 restore&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">touch recovery.signal
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>注意：此時還可以調整 pg_hba.conf 來防止其他 role 來連線剛恢復的 cluster。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>啟動 server&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_ctl -D /var/data/postgres -l logfile start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>恢復成功後 &lt;code>recovery.signal&lt;/code> 會被刪除，避免稍後意外重新進入恢復模式。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>檢查數據庫是否恢復完成，如果完成記得重新調整 pg_hba.conf 恢復其他使用者的存取。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="實例">實例
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>新增一些測試資料：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">primary&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">02&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">53&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>進行 Base backup：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_basebackup -P -D /var/data/backup/pg_back_&lt;span class="k">$(&lt;/span>date +&lt;span class="s2">&amp;#34;%F_%T&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>新增增量測試資料：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">primary&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;test3&amp;#39;&lt;/span>&lt;span class="p">),(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;test4&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;test5&amp;#39;&lt;/span>&lt;span class="p">),(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;test6&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">02&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">57&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test4&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">381&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">02&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">57&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_table2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test5&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test6&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>強制關閉 pg 服務&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres@3f5b5718e08f postgres&lt;span class="o">]&lt;/span>$ ps aux&lt;span class="p">|&lt;/span> grep postgre
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">801&lt;/span> 0.0 0.1 &lt;span class="m">83584&lt;/span> &lt;span class="m">2196&lt;/span> pts/0 S 02:14 0:00 su postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">802&lt;/span> 0.0 0.1 &lt;span class="m">14096&lt;/span> &lt;span class="m">2888&lt;/span> pts/0 S 02:14 0:00 bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1148&lt;/span> 0.0 1.0 &lt;span class="m">216872&lt;/span> &lt;span class="m">19112&lt;/span> ? Ss 02:56 0:00 /usr/local/postgres/bin/postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1150&lt;/span> 0.0 0.0 &lt;span class="m">216872&lt;/span> &lt;span class="m">1568&lt;/span> ? Ss 02:56 0:00 postgres: checkpointer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1151&lt;/span> 0.0 0.1 &lt;span class="m">217008&lt;/span> &lt;span class="m">2596&lt;/span> ? Ss 02:56 0:00 postgres: background writer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1152&lt;/span> 0.0 0.5 &lt;span class="m">216872&lt;/span> &lt;span class="m">9720&lt;/span> ? Ss 02:56 0:00 postgres: walwriter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1153&lt;/span> 0.0 0.1 &lt;span class="m">217428&lt;/span> &lt;span class="m">2776&lt;/span> ? Ss 02:56 0:00 postgres: autovacuum launcher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1154&lt;/span> 0.0 0.0 &lt;span class="m">216872&lt;/span> &lt;span class="m">1580&lt;/span> ? Ss 02:56 0:00 postgres: archiver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1155&lt;/span> 0.0 0.0 &lt;span class="m">67512&lt;/span> &lt;span class="m">1756&lt;/span> ? Ss 02:56 0:00 postgres: stats collector
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1156&lt;/span> 0.0 0.1 &lt;span class="m">217428&lt;/span> &lt;span class="m">2316&lt;/span> ? Ss 02:56 0:00 postgres: logical replication launcher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1173&lt;/span> 0.0 0.1 &lt;span class="m">53332&lt;/span> &lt;span class="m">1876&lt;/span> pts/0 R+ 02:57 0:00 ps aux
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres &lt;span class="m">1174&lt;/span> 0.0 0.0 &lt;span class="m">10696&lt;/span> &lt;span class="m">984&lt;/span> pts/0 S+ 02:57 0:00 grep --color&lt;span class="o">=&lt;/span>auto postgre
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres@3f5b5718e08f postgres&lt;span class="o">]&lt;/span>$ &lt;span class="nb">kill&lt;/span> -9 postgres
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>備份當前實體檔案並清除&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -R /var/data/postgres/ /var/data/postgres_backup/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/data/postgres/*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>從 Base Backup 進行恢復，並清空備份中的 wal，再將原本的 wal 檔案複製過來&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -R /var/data/backup/pg_back_2023-04-13_02&lt;span class="se">\:&lt;/span>55&lt;span class="se">\:&lt;/span>49/* /var/data/postgres/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/data/postgres/pg_wal/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp -R /var/data/postgres_backup/pg_wal/* /var/data/postgres/pg_wal/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>配置 restore_command&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">restore_command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;cp /var/data/xlog_archive/%f %p&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>建立 &lt;code>recovery.signal&lt;/code> 文件來觸發 restore&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">touch recovery.signal
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>啟動並檢查&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres@3f5b5718e08f postgres&lt;span class="o">]&lt;/span>$ pg_ctl -D /var/data/postgres -l logfile start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres@3f5b5718e08f postgres&lt;span class="o">]&lt;/span>$ psql &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Timing is on.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql &lt;span class="o">(&lt;/span>14.7&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type &lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> help.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres @ test&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>local&lt;span class="o">]&lt;/span>:5432&lt;span class="o">]&lt;/span> 03:00:30 &amp;gt; &lt;span class="se">\d&lt;/span>t
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> List of relations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Schema &lt;span class="p">|&lt;/span> Name &lt;span class="p">|&lt;/span> Type &lt;span class="p">|&lt;/span> Owner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------+-------------+-------+----------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public &lt;span class="p">|&lt;/span> test_table &lt;span class="p">|&lt;/span> table &lt;span class="p">|&lt;/span> postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public &lt;span class="p">|&lt;/span> test_table2 &lt;span class="p">|&lt;/span> table &lt;span class="p">|&lt;/span> postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">2&lt;/span> rows&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres @ test&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>local&lt;span class="o">]&lt;/span>:5432&lt;span class="o">]&lt;/span> 03:00:32 &amp;gt; &lt;span class="k">select&lt;/span> * from test_table&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id &lt;span class="p">|&lt;/span> name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----+-------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span> &lt;span class="p">|&lt;/span> test2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> &lt;span class="p">|&lt;/span> test3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4&lt;/span> &lt;span class="p">|&lt;/span> test4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">4&lt;/span> rows&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Time: 0.620 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>postgres @ test&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>local&lt;span class="o">]&lt;/span>:5432&lt;span class="o">]&lt;/span> 03:00:37 &amp;gt; &lt;span class="k">select&lt;/span> * from test_table2&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id &lt;span class="p">|&lt;/span> name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----+-------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">5&lt;/span> &lt;span class="p">|&lt;/span> test5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">6&lt;/span> &lt;span class="p">|&lt;/span> test6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">2&lt;/span> rows&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Time: 0.715 ms
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="point-in-time-recovery">Point-in-time recovery
&lt;/h3>&lt;p>預設情況下會直接恢復到 WAL 的末尾，可以透過設置 recovery_target 相關參數來指定一個更早的停止點，達到 Point-in-time recovery。&lt;/p>
&lt;p>相關參數如下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>recovery_target = ’immediate’：目前只有 &lt;code>immediate&lt;/code> 此設定，表示盡早結束也就是該備份結束的時間點。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>recovery_target_name (string)：指定透過 &lt;code>pg_create_restore_point()&lt;/code> 所創建的 restore point，指示恢復到此位置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>recovery_target_time (timestamp)：指定恢復到指定的時間戳。&lt;/p>
&lt;p>準確來說是指 WAL 中記錄&lt;/p>
&lt;/li>
&lt;li>
&lt;p>recovery_target_xid (string)：指定恢復到指定的 Tranasction ID，注意雖然 Transaction ID 是順序分配的，但是可能依照不同順序 commit，此設置同時也會恢復該 Transaction ID 之前 commit 但具有更大的 Transaction ID 的事務。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>recovery_target_lsn (string)：指定恢復到指定的 LSN 位置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>recovery_target_inclusive (boolean)：影響當設置 &lt;code>recovery_target_time&lt;/code>、 &lt;code>recovery_target_xid&lt;/code> 和 &lt;code>recovery_target_lsn&lt;/code>，默認值 ON 表示恢復完這些目標才停止，如果是 OFF 則表示恢復到這些設置之前就停止。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>recovery_target_timeline (string)：指定恢復到一個 timeline 中，該值可以 timeline id 或以下特定值：&lt;/p>
&lt;ul>
&lt;li>current：沿著 base backup 的 timeline 進行恢復。&lt;/li>
&lt;li>latest：默認值，恢復到最新的 timeline。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>recovery_target_action (enum)：指定當達到 recovery target 後的動作：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>pause：默認值，表示停止 recovery 並允許查詢。&lt;/p>
&lt;p>如果 hot_standby = off，則此值行為和 shutdown 等同。&lt;/p>
&lt;p>如果在 promote 中達到 recovery target，則此值行為和 promote 等同。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>promote：表示恢復結束後 sever 將允許連接。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>shutdown：表示恢復結束後停止 server，設置此值時 recovery.singal 將不會被移除。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>備註：如果沒有設置 recovery target 相關參數，則此參數無效。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>💡 注意：recovery_target、recovery_target_name、recovery_target_time、recovery_target_xid 、recovery_target_lsn 只能夠設置其中一個，設置多個將引發錯誤。&lt;/p>&lt;/blockquote>
&lt;ul>
&lt;li>實做
&lt;ol>
&lt;li>
&lt;p>當前資料庫的資料內容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">timeline&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">create_time&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+----------+----------------------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">52&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">695513&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">06&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">031361&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">686946&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">46&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">191272&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">690359&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">854501&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>使用 base backup 復原後調整設定檔&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">data&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">backup&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pg_back_2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="n">_03&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="cm">/* postgres/
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">[postgres@31650d651e1c postgres]$ vim postgresql.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">recovery_target_time = &amp;#39;2023-04-19 03:20:00&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">[postgres@31650d651e1c postgres]$ touch recovery.signal
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>備註：可以透過 pg_waldump 確認 wal log 來確認要恢復到的位置，例如我希望恢復到 id = 5 被 insert 之前的狀況，透過 waldump 確認該 transaction 在 &lt;code>2023-04-19 03:20:29.690738 UTC&lt;/code> commit，因此只要將 recovery_target_time 設置的比其小即可。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xlog_archive&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_waldump&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">00000001000000000000000&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Standby&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000028&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">C000358&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RUNNING_XACTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latestCompletedXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">747&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldestRunningXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Standby&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000060&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000028&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RUNNING_XACTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latestCompletedXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">747&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldestRunningXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XLOG&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">114&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">114&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000098&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000060&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHECKPOINT_ONLINE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">redo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">D000060&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tli&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tli&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fpw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">24582&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">multi&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">offset&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">726&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">multi&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldest&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">newest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">commit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">timestamp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">running&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">online&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Standby&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000110&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000098&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RUNNING_XACTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latestCompletedXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">747&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldestRunningXid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Heap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">298&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000148&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000110&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">off&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">blkref&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1663&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16384&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16391&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">blk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FPW&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Btree&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">53&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">193&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000278&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000148&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">INSERT_LEAF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">off&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">blkref&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1663&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16384&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16394&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">blk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FPW&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">rmgr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Transaction&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rec&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tot&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">34&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">34&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lsn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000340&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">D000278&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">690738&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>啟動 server&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">945&lt;/span>&lt;span class="n">f297dce73&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_ctl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">start&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">775&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">817&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">restored&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;00000001000000000000000B&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">archive&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">975&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">redo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starts&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">at&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">B000028&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">977&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">consistent&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">state&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">reached&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">at&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">B000100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">977&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1827&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">system&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ready&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accept&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">read&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">only&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connections&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">008&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">restored&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;00000001000000000000000C&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">archive&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">198&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">restored&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;00000001000000000000000D&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">archive&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">351&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stopping&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">before&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">commit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">transaction&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">748&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">690738&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">351&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pausing&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">at&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">the&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">end&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">351&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1828&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HINT&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Execute&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal_replay_resume&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">promote&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">psql&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Timing&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">is&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">psql&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">Type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">help&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">05&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">13&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">-#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">timeline&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">create_time&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+----------+----------------------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">52&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">695513&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">06&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">031361&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">686946&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">46&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">191272&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;h2 id="timeline">timeline
&lt;/h2>&lt;p>想像時間旅行的科幻作品，如果從現在回到過去並改變過去發生的事件會導致未來發生改變，也就是出現了不同的時間線。&lt;/p>
&lt;p>在 PG 中也有類似的狀況，假設在 12:00 誤刪除了資料表，並在 13:00 將 PG 恢復到 11:00 的時間點並正常啟動和運作，此時會出現 2 個時間線：&lt;/p>
&lt;ol>
&lt;li>過去 11:00~13:00 產生的 WAL&lt;/li>
&lt;li>恢復後從 13:00 開始產生的 WAL&lt;/li>
&lt;/ol>
&lt;p>如果沒有 timeline 的設計，恢復後產生的 WAL 覆蓋了過去產生的 WAL，此時如果發現決策錯誤希望回到過去的 12:00 數據庫狀態將無法做到。&lt;/p>
&lt;p>因此 PG 有了 timeline 的設計，透過保存不同 timeline 的 WAL 來讓使用者能夠自由的恢復到不同的時間線。&lt;/p>
&lt;h3 id="新的-timeline-產生時機">新的 timeline 產生時機
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>PITR：設置 recovery_target 相關參數進行恢復後會出現新的 timeline。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ll&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">32768&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000B
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">drwx&lt;/span>&lt;span class="c1">------. 2 postgres postgres 80 Apr 19 03:27 archive_status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">配置&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery_target&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">參數並進行&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PITR&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">vim&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgresql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">recovery_target_time&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;2023-04-19 03:15:46&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">recovery_target_action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;promote&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">touch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">singal&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_ctl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">logfile&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">restart&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">waiting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">shut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">down&lt;/span>&lt;span class="p">....&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">done&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stopped&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">waiting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">start&lt;/span>&lt;span class="p">....&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">done&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">started&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ll&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">49156&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:30 00000001000000000000000C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:30 00000002000000000000000C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:27 00000002000000000000000D
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 50 Apr 19 03:30 00000002.history
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">drwx&lt;/span>&lt;span class="c1">------. 2 postgres postgres 73 Apr 19 03:30 archive_status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">00000002&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">history&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">C0002F8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">before&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">46&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">192096&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>standby promote：當 standby 被 promote 成 primary 時會出現新的 timeline。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ll&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">32768&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 02:00 000000010000000000000006
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 02:00 000000010000000000000007
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">drwx&lt;/span>&lt;span class="c1">------. 2 postgres postgres 6 Apr 19 02:00 archive_status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_ctl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">promote&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">waiting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">promote&lt;/span>&lt;span class="p">....&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">done&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">promoted&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ll&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">49160&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 02:03 000000010000000000000006.partial
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 02:03 000000020000000000000006
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 02:00 000000020000000000000007
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 41 Apr 19 02:03 00000002.history
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">drwx&lt;/span>&lt;span class="c1">------. 2 postgres postgres 80 Apr 19 02:03 archive_status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">00000002&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">history&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">A000198&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">no&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">specified&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="timeline-實體檔案">timeline 實體檔案
&lt;/h3>&lt;p>從上一節中可以看到產生新的 timeline 時會出現後綴相同的 wal 及 history 檔案：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ll&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">32768&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000B
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:27 00000001000000000000000C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">drwx&lt;/span>&lt;span class="c1">------. 2 postgres postgres 80 Apr 19 03:27 archive_status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">配置&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery_target&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">參數並進行&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PITR&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">vim&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgresql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">recovery_target_time&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;2023-04-19 03:15:46&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">recovery_target_action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;promote&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">touch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recovery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">singal&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_ctl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">logfile&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">restart&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">waiting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">shut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">down&lt;/span>&lt;span class="p">....&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">done&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stopped&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">waiting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">start&lt;/span>&lt;span class="p">....&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">done&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">started&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ll&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">49156&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:30 00000001000000000000000C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:30 00000002000000000000000C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 16777216 Apr 19 03:27 00000002000000000000000D
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">rw&lt;/span>&lt;span class="c1">-------. 1 postgres postgres 50 Apr 19 03:30 00000002.history
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">drwx&lt;/span>&lt;span class="c1">------. 2 postgres postgres 73 Apr 19 03:30 archive_status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">00000002&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">history&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">C0002F8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">before&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">46&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">192096&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以觀察到有一個 &lt;code>00000002.history&lt;/code> 的 timeline 相關檔案，這個件紀錄了這個 timeline 從哪條 timeline 分支出來及什麼時候，這包含了以下 3 個字段：&lt;/p>
&lt;ul>
&lt;li>parentTLI：parent timeline 的 ID。&lt;/li>
&lt;li>LSN：發生 timline 切換的 WAL 位置。&lt;/li>
&lt;li>reason：timeline 產生的原因。&lt;/li>
&lt;/ul>
&lt;p>例如：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="mi">31650&lt;/span>&lt;span class="n">d651e1c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_wal&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">00000002&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">history&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">A000198&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">before&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">19&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">05&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">861324&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>以上表示了 timeline 2 是基於 timeline 1 的 basebackup 透過 WAL 恢復到 0/A000198 對應 &lt;code>2023-4-19 12:05:00.861324+00&lt;/code> 之前的位置。&lt;/p>
&lt;p>另外還可以注意到出現新的 timeline 的時候 WAL 檔名也有了變化：&lt;code>00000001000000000000000C&lt;/code> → &lt;code>00000002000000000000000C&lt;/code>，可以觀察到前 8 碼由 &lt;code>00000001&lt;/code> 變成 &lt;code>00000002&lt;/code>，事實上 WAL 檔名的前 8 碼就是用來標示其所屬的 timeline id。&lt;/p>
&lt;h1 id="參考">參考
&lt;/h1>&lt;p>&lt;a class="link" href="https://www.postgresql.org/docs/current/backup.html" target="_blank" rel="noopener"
>PostgreSQL: Documentation: 15: Chapter 26. Backup and Restore&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/410766742" target="_blank" rel="noopener"
>PostgreSQL备份恢复实现 - 知乎 (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/cqdba/p/15920508.html" target="_blank" rel="noopener"
>1.pg_basebackup 介绍及使用 - www.cqdba.cn - 博客园 (cnblogs.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.twblogs.net/a/5c9e6330bd9eee73ef4b6004" target="_blank" rel="noopener"
>PostgreSQL 從入門到出門 第 8 篇 備份與恢復 - 台部落 (twblogs.net)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/weixin_39540651/article/details/111239341" target="_blank" rel="noopener"
>PostgreSQL时间线(timeline)和History File_pg history_foucus、的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.interdb.jp/pg/pgsql10.html#_10.3.1." target="_blank" rel="noopener"
>The Internals of PostgreSQL : Chapter 10 Base Backup &amp;amp; Point-in-Time Recovery (interdb.jp)&lt;/a>&lt;/p></description></item><item><title>PostgreSQL Replication</title><link>https://FuweaY.github.io/p/postgre-replication/</link><pubDate>Wed, 19 Feb 2020 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/postgre-replication/</guid><description>&lt;p>Replication 是提供高可用及 load balance 的基礎，因此不論在哪一種 database 都是一項重要的功能。&lt;/p>
&lt;p>在不同的 Database 下對於主備 Server 都有不同的術語：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>MySQL &amp;lt; 8.0.26&lt;/th>
&lt;th>MySQL &amp;gt; 8.0.26&lt;/th>
&lt;th>MongoDB&lt;/th>
&lt;th>PostgreSQL&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>主&lt;/td>
&lt;td>Master&lt;/td>
&lt;td>Source&lt;/td>
&lt;td>Primary&lt;/td>
&lt;td>Primary&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>備&lt;/td>
&lt;td>Slave&lt;/td>
&lt;td>Replica&lt;/td>
&lt;td>Secondary&lt;/td>
&lt;td>Standby&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>在 MySQL 中透過 Server 層的 binlog 透過&lt;/p>
&lt;p>在 PG 中則是直接透過 WAL (相對於 InnoDB redo log)&lt;/p>
&lt;h2 id="standby-slave-的行為">Standby (Slave) 的行為
&lt;/h2>&lt;p>當 server 啟動時數據目錄中包含 &lt;code>standby.signal&lt;/code> 文件時，則 server 會進入 standby 模式。&lt;/p>
&lt;p>在 standby 模式下，standby 可以透過以下兩種方式來獲取並回放 Primary 上的 WAL：&lt;/p>
&lt;ul>
&lt;li>WAL Archive&lt;/li>
&lt;li>Streaming Replication&lt;/li>
&lt;/ul>
&lt;p>除此之外 Standby 還會嘗試恢復在 pg_wal 目錄中的任何 WAL。&lt;/p>
&lt;p>Standby 在啟動時會有以下行為：&lt;/p>
&lt;ol>
&lt;li>調用 &lt;code>restore_command&lt;/code> 進行恢復。&lt;/li>
&lt;li>當步驟1 達到 WAL 末尾且恢復失敗，則將嘗試恢復 pg_wal 目錄中可用的 WAL。&lt;/li>
&lt;li>當步驟2失敗，且配置了 Streaming Replication ，則會嘗試連接到 Primary 並從存檔或 pg_wal 目錄中找到有效的紀錄開始 Streaming WAL。&lt;/li>
&lt;li>當步驟3失敗，或是沒有配置 Streaming Replication 則將回到步驟1重新嘗試&lt;/li>
&lt;/ol>
&lt;p>以上步驟的 retry 循環或一直持續到 server 關閉或者 failover。&lt;/p>
&lt;p>failover 可以透過運行 &lt;code>pg_ctl promote&lt;/code>、調用 &lt;code>pg_promote()&lt;/code> 或發現 trigger file (promote_trigger_file) 時，則會退退出 standby 模式成為 primary 提供正常操作。&lt;/p>
&lt;h2 id="建議">建議
&lt;/h2>&lt;ul>
&lt;li>在不同的主要版本號中通常是無法進行 log shipping 的&lt;/li>
&lt;li>雖然 PG 沒有正式支持不同次要版本之間的 log shipping，但在次要版本中一般不更改 Disk 格式，並且新的次要版本更可能從舊的次要版本讀取 WAL，因此升級小版本號時建議先升級 standby。&lt;/li>
&lt;li>&lt;/li>
&lt;li>在 Primary 上設置 Continuous archiving 時，應該考慮將歸檔位置設為 standby 本身或是非 Primary 機器上，避免因為 Primary 機器本身出問題而無法訪問。&lt;/li>
&lt;li>使用 Streaming Replicaiton 需要注意以下事項：
&lt;ul>
&lt;li>創建 replication role，並在 ph_hba.conf 有正確的設置，確保 standby 能夠連線 Primary。&lt;/li>
&lt;li>確保 Primary 上的 &lt;code>max_wal_senders&lt;/code> 設置足夠大。&lt;/li>
&lt;li>如果使用 Replication Slot 還需要確保 &lt;code>max_replication_slots&lt;/code> 設置。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="設置-standby">設置 Standby
&lt;/h2>&lt;h3 id="log-shipping-warm-standby">Log Shipping (warm standby)
&lt;/h3>&lt;p>在 PG 9.0 之前，PostgreSQL 只提供這種異步 replication 方式，這是透過 Primary 每次傳送一個 WAL 給 Standby 來實現，缺陷也很明顯就是 Standby 至少會落後 Primary 一個 WAL。&lt;/p>
&lt;h4 id="配置方式">配置方式
&lt;/h4>&lt;ol>
&lt;li>
&lt;p>在 Primary 中新增以下設置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">archive_mode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">archive_command&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;test ! -f /var/data/xlog_archive/%f &amp;amp;&amp;amp; cp %p /var/data/xlog_archive/%f&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>對 Primary 進行 Base backup&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_basebackup -P -D /var/data/backup/pg_back_&lt;span class="k">$(&lt;/span>date +&lt;span class="s2">&amp;#34;%F_%T&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>還原到 Standby&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">cp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">backup&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">pg_back_2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="n">_07&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">06&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">57&lt;/span>&lt;span class="cm">/* /var/data/postgres
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>修改 Standby 設置，並以 standby 模式運行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">restore_command&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;cp /var/data/xlog_archive/%f &amp;#34;%p&amp;#34;&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">touch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">standby&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">signal&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">pg_ctl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">data&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">logfile&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">start&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>透過在 Primary 新增資料，並使用 &lt;code>pg_switch_wal()&lt;/code> 強制觸發 WAL 的切換來觀察&lt;/p>
&lt;ul>
&lt;li>
&lt;p>primary&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- primary
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">You&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">are&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;postgres&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">607&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">13&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;test2&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">594&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">330&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_switch_wal&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">pg_switch_wal&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">---------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">30003&lt;/span>&lt;span class="n">D8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">171&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">419&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>standby&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">You&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">are&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;postgres&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">44&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">dt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">relations&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">Schema&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Owner&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">--------+------+-------+----------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">52&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">660&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">425&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- 在 primeary 觸發 WAL 刷新後
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">27&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">----+-------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">334&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="相關參數">相關參數
&lt;/h3>&lt;h4 id="archiving">Archiving
&lt;/h4>&lt;ul>
&lt;li>
&lt;p>archive_mode (enum)：設置是否進行 archive，有以下三種設置：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>off：關閉 archive。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>on：正常模式下開啟 archive，但是在 recovery 或是 standby 時不進行 archvie。\&lt;/p>
&lt;p>當 standby提升為 primary 時只會 archive 自己產生的 WAL，而不會 archive 原本從另一個 primary 取得的 WAL。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>always：不論什麼模式都進行 archive。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>archive_command (string)：設置 archive WAL 的 shell 指令。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>archive_library (string)：設置用於 archive WAL 的 library，若為空表示使用 &lt;code>archive_command&lt;/code>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>archive_timeout (integer)：此參數為時間設置預設單位為秒，當此參數大於 0 時，會強制 server 只要距離上次切換到新的 WAL 已經過去這段時間，且有數據庫活動就必須切換到新的 WAL。&lt;/p>
&lt;p>因為 archive 只會針對完成的 WAL 作用，因此設置此參數可以避免當 WAL 輪換不頻繁時，導致 Transaction 過久沒有被安全的歸檔或者同步到 standby。&lt;/p>
&lt;p>注意：強制切換 WAL 的文件大小和完整的文件大小相同都是 16MB，因此設置太短的 &lt;code>archive_timeout&lt;/code> 會導致歸檔存檔膨脹，通常 1 分鐘左右的設置是合理。如果希望 Primary 和 Standby 之間的延遲更小應該考慮 streaming replication 而不是調整此值。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="archive-recovery">Archive Recovery
&lt;/h4>&lt;p>此處用於設置 recovery 期間的設定，recovery 包含以下兩者：&lt;/p>
&lt;ul>
&lt;li>recovery mode：透過在數據目錄中創建 &lt;code>recovery.signal&lt;/code> 設置&lt;/li>
&lt;li>standby mode：透過在數據目錄中創建 &lt;code>standby.signal&lt;/code> 設置，首先進入 recovery mode 並在恢復到歸檔的 WAL 末尾時不會停止，而是會嘗試透過 &lt;code>primary_conninfo&lt;/code> 向指定的 primary 請求 WAL 或 &lt;code>restore_command&lt;/code> 來繼續回放 WAL。&lt;/li>
&lt;/ul>
&lt;p>備注：如果 2 個 signal 都被建立則會以 standby mode 優先。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>restore_command (string)：用於設置如何將歸檔的 WAL 用於 restore 的 shell 命令。&lt;/p>
&lt;p>範例如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">restore_command&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;cp /mnt/server/archivedir/%f &amp;#34;%p&amp;#34;&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>上述設定表示將複製 &lt;code>/mnt/server/archivdir&lt;/code> 底下的 WAL 到 pg_wal 中。&lt;/p>
&lt;ul>
&lt;li>%f：表示歸檔 WAL 文件名稱。&lt;/li>
&lt;li>%p：表示放置用於恢復 WAL 的目錄 (pg_wal)。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>archive_cleanup_cpmmand (string)：用於設置清理 standby 不再需要的歸檔 WAL shell 命令。&lt;/p>
&lt;p>範例如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">archive_cleanup_command&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;pg_archivecleanup /mnt/server/archivedir %r&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>上述設定表示運行 &lt;code>pg_archivecleanup&lt;/code> 將上一個 WAL 文件刪除。&lt;/p>
&lt;ul>
&lt;li>%r：表示需要的 WAL 文件的上一個 WAL 文件名稱。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>recovery_end_command (string)：用於設置當 recovery 結束時執行的 shell 命令，例如可以用於發送 email 通知：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">recovery_end_command&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;echo &amp;#34;Recovery complete&amp;#34; | mail -s &amp;#34;Recovery complete&amp;#34; admin@example.com&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="小節">小節
&lt;/h3>&lt;p>Log Shipping 是一種異步且即時性不高的 replication 方式，但是他相應的優勢就是因為是透過 primary 歸檔後的 WAL 進行恢復，因此不會有 Streaming Replicaion 丟失 WAL 導致無法復原的問題。&lt;/p>
&lt;p>雖然不推薦將 Log Shipping 做為主力的 replication 方案，但是可以將其同時和 Streaming Replication 一起運行作為附屬方案，只有當 Streaming Replication 因為某些原因跟不上 Primary 導致對應的 WAL 被刪除時，透過歸檔的 WAL 來進行復原。&lt;/p>
&lt;h2 id="streaming-replication-流複製-或稱-物理複製">Streaming Replication (流複製 或稱 物理複製)
&lt;/h2>&lt;p>在 PG 9.0 開始提供了 Steaming Replication，雖然和 Log Shipping 一樣都是透過 WAL 日誌的回放來達到 Primary 和 Standby 的同步，但是 Streaming Replication 只要在 WAL 中一產生變化就會發送給 Standby，而不需要等到 WAL 切換才傳送，也就是說 Streaming Replication 會有更短的 replication delay。&lt;/p>
&lt;p>具體實現方面大體上其實和 MySQL 差不多，只是 MySQL 是透過 binlog 中的邏輯複製，但 PG 的 WAL 比較接近 MySQL redo log 也就是說是根據實際修改 Disk 物理空間的紀錄，也就是說在 PG 中 Master 和 Slave 的底層數據狀態是完全一致的。&lt;/p>
&lt;p>在 Streaming Replication 有以下角色：&lt;/p>
&lt;ul>
&lt;li>Master 上的 backend 進程：執行收到的 Query 指令，在修改數據前先寫入 WAL，並在 commit 的時候將 WAL fsync 到 Disk。&lt;/li>
&lt;li>Master 上的 WAL sender 進程：將 WAL 發送給 Slave 的 WAL receiver 。&lt;/li>
&lt;li>Slave 上的 WAL receiver 進程：接收並持久化儲存 Master WAL sender 發送的 WAL。可以類比為 MySQL 的 IO THREAD。&lt;/li>
&lt;li>Slave 上的 startup 進程：Apply WAL receiver 接收到的 WAL。可以類比為 MySQL 的 SQL THREAD。&lt;/li>
&lt;/ul>
&lt;h3 id="同步-or-異步">同步 OR 異步
&lt;/h3>&lt;p>此外和 MySQL 一樣也分為異步或同步，主要透過以下參數控制：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>synchronous_commit (enum)：指定 server 在完成多少 WAL 處理後才返回 Clinet 端成功。&lt;/p>
&lt;p>當 &lt;code>synchronous_standby_names&lt;/code> 為空時，分為兩種設置：&lt;/p>
&lt;ul>
&lt;li>on：此為默認值且 OFF 以外的設置都視為 ON，當 WAL fsync 到 Disk 才返回成功給 Client 端。&lt;/li>
&lt;li>off：不會等待 WAL 的處理，也就是說可能會丟失 Transaction，最多可能會導致丟失 &lt;code>wal_write_delay&lt;/code> * 3。&lt;/li>
&lt;/ul>
&lt;p>當 &lt;code>synchronous_standby_names&lt;/code> 不為空時，分為5種設置：&lt;/p>
&lt;p>總共有以下 5 個值：&lt;/p>
&lt;ul>
&lt;li>remote_apply：保證 Slave 已經收到該 Transaction 的 WAL 並調用 fsync() disk，確保了該 Transaction 只有 Master、Slave 都發生數據損壞才會丟失 Transaction，並且還完成了 WAL 回放，因此在 Master、Slave 上擁有一致性讀取。&lt;/li>
&lt;li>on：也可稱為 remote_flush，保證 Slave 已經收到該 Transaction 的 WAL 並調用 fsync() disk，確保了該 Transaction 只有 Master、Slave 都發生數據損壞才會丟失 Transaction，但因為還沒有回放 WAL，因此 Master、Slave 沒有一致性讀取。&lt;/li>
&lt;li>remote_write：保證 Slave 已經收到該 Transaction 的 WAL 並寫入 OS 緩存，但未調用 fsync() disk，也就是說 PG server crash 並不會導致 Transaction 丟失，但是整個 OS 系統 Crash 將可能導致 Transaction 丟失。&lt;/li>
&lt;li>local：等同於 &lt;code>synchronous_standby_names&lt;/code> 為空時的 ON 設置，也就是說只要 Master 的 WAL 有 fsync 即可不必等待 slave，也就是異步複製。&lt;/li>
&lt;li>off：不會等待 WAL 的處理，也就是說可能會丟失 Transaction，最多可能會導致丟失 &lt;code>wal_write_delay&lt;/code> * 3。&lt;/li>
&lt;/ul>
&lt;p>注意：當 &lt;code>synchronous_standby_names&lt;/code> 為空時，除了 OFF 以外的設定都會被視為 ON。&lt;/p>
&lt;p>&lt;img src="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b38ca1e7-a55c-4ea4-afb6-a20fc4126332/Untitled.png"
loading="lazy"
alt="Untitled"
>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>synchronous_standby_names (string)：指定要求同步 replication 的 slave 列表。&lt;/p>
&lt;p>這邊列出 Slave 在 primary_conninfo 中設置的 application_name (如果沒有則是 cluster_name)。&lt;/p>
&lt;p>可以設置成以下格式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>FIRST&lt;span class="o">]&lt;/span> num_sync &lt;span class="o">(&lt;/span> standby_name &lt;span class="o">[&lt;/span>, ...&lt;span class="o">]&lt;/span> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ANY num_sync &lt;span class="o">(&lt;/span> standby_name &lt;span class="o">[&lt;/span>, ...&lt;span class="o">]&lt;/span> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">standby_name &lt;span class="o">[&lt;/span>, ...&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中 num_sync 為數字，表示必須至少有多少 Slave 回覆已同步完成的 Ack 訊號，和 FIRST、ANY 組合有以下效果：&lt;/p>
&lt;ul>
&lt;li>[FIRST] num_sync：必須按照列表中的順序前 num_sync 數量的 slave 回覆已同步完成的 Ack 訊號才可以，之後的 slave 作為同步 slave 的備選只有優先序高的出現問題才會替補。&lt;/li>
&lt;li>ANY num_sync：只要列表中的任意 num_sync 數量的 slave 回覆已同步完成的 Ack 訊號即可。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="建置範例">建置範例
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>檢查 Source 的設定&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">listen_addresses&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以下皆為預設值&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">hot_standby&lt;/span> &lt;span class="o">=&lt;/span> ON
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">wal_level&lt;/span> &lt;span class="o">=&lt;/span> replica
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">max_wal_senders&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>設置 replication 用的 User&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">createuser -U postgres --replication repl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>確認 Source 中的 pg_hba.conf 是否能接受 Replica 機器的連線&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TYPE DATABASE USER ADDRESS METHOD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">host replication repl 172.17.0.3/16 trust
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>對 Source 進行 Base backup&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_basebackup -P -D /var/data/backup/pg_back_&lt;span class="k">$(&lt;/span>date +&lt;span class="s2">&amp;#34;%F_%T&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span> -R -U repl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>-R 選項會在備份檔中有以下不同&lt;/p>
&lt;ul>
&lt;li>
&lt;p>生成 standby.signal&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在 postgresql.auto.conf 中多出 primary_conninfo 的資訊：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">primary_conninfo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;user=repl passfile=&amp;#39;&amp;#39;/home/postgres/.pgpass&amp;#39;&amp;#39; channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=disable krbsrvname=postgres target_session_attrs=any&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>將 Source 剛剛的 Base backup 還原到 Replica 上&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -R /root/pg_data/source/backup/pg_back_2023-04-13_07&lt;span class="se">\:&lt;/span>20&lt;span class="se">\:&lt;/span>40/* /root/pg_data/replica/postgres
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>啟動 replica&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pg_ctl -D /var/data/postgres -l logfile start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2023-04-13 09:10:54.724 UTC &lt;span class="o">[&lt;/span>1136&lt;span class="o">]&lt;/span> LOG: consistent recovery state reached at 0/1A000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2023-04-13 09:10:54.725 UTC &lt;span class="o">[&lt;/span>1135&lt;span class="o">]&lt;/span> LOG: database system is ready to accept read-only connections
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2023-04-13 09:10:54.733 UTC &lt;span class="o">[&lt;/span>1140&lt;span class="o">]&lt;/span> LOG: started streaming WAL from primary at 0/1A000000 on timeline &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="小節-1">小節
&lt;/h3>&lt;p>實務上可以結合 log shipping 和 streaming replication 一起使用，當 streaming replicaiton 因為 TCP 異常或是 Primary 丟棄所需的 WAL 時，PG 能夠自動切換回使用 log shipping 透過 restore_command 繼續追趕 Pimary 的進度，直到趕上 Primary 後 Standby 會重新嘗試切回 streaming repliction。&lt;/p>
&lt;h2 id="replication-slot">Replication Slot
&lt;/h2>&lt;h3 id="功用---slave-所需的-wal-在-master-上的保留">功用 - Slave 所需的 WAL 在 Master 上的保留
&lt;/h3>&lt;p>在 PostgreSQL 9.4 之前是沒有 Replication Slot 的，Slave 因為某些原因暫停 replication 之後，因為在 Master 上需要應用的 WAL 已經被清除，導致 Slave 恢復 replication 後發生以下狀況：&lt;code>requested WAL segment 0000000100000000000000xxx has already been removed&lt;/code>，為了避免這個狀況可以透過以下參數的配置：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>wal_keep_size：指定 pg_wal 目錄下至少需保留的 WAL 大小。&lt;/p>
&lt;p>默認值為 0 表示不會額外保留 WAL，也就是說 slave 可用的 WAL segments 數量取決於前一個 checkpoint 和 WAL archiving 狀態。&lt;/p>
&lt;p>備註：在 PG 13 之前是使用 wal_keep_segments 來控制，他們之間的關係是 wal_keep_size = wal_keep_segments * wal_segment_size (一般是 16 MB)。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>archive_command：設置 WAL archive 的指令。&lt;/p>
&lt;p>將 WAL archive 到其他地方，這樣 Slave 就能從已經 archive 的 WAL 繼續恢復。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>不過以上方法會保留較多的 WAL，因此有了 Replication Slot 用來確保 Master 在所有 Slave 收到 WAL segments 之前不會刪除對應的部分。&lt;/p>
&lt;p>但這也帶來了相應的問題：當 Slave 發生異常無法回覆 Master 當前的 lsn 位置，就會導致 Master 不斷保留 WAL 最後導致 Disk 空間用盡而無法提供正常服務。&lt;/p>
&lt;p>在 PostgresSQL 13 之前，只能透過監控 replication 狀態來盡早發現進行處理，例如以下語句可以知道保留的 lsn 到當前最新的 redo_lsn 落後多少：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># SELECT redo_lsn, slot_name,restart_lsn, round((redo_lsn-restart_lsn)/1024/1024,2) AS MB_behind &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FROM pg_control_checkpoint&lt;span class="o">()&lt;/span>, pg_replication_slots&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redo_lsn &lt;span class="p">|&lt;/span> slot_name &lt;span class="p">|&lt;/span> restart_lsn &lt;span class="p">|&lt;/span> mb_behind
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----------+------------+-------------+-----------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0/AAFF2D0 &lt;span class="p">|&lt;/span> pgstandby1 &lt;span class="p">|&lt;/span> 0/AAFF3B8 &lt;span class="p">|&lt;/span> 0.00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在 PostgresSQL 13 時推出了 &lt;code>max_slot_wal_keep_size&lt;/code> 這個設置：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>max_slot_wal_keep_size (integer)：設置 replication slot 在 pg_wal 目錄中保留的最大 wal 大小。&lt;/p>
&lt;p>當一個 slot 的 restart_lsn 落後於 current_lsn 本數值後會停止 stream replication，且該 slot 會被標記為無效，同時之前的 WAL 將被刪除。&lt;/p>
&lt;p>預設值為 -1 表示不限制。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>以上參數極大避免了在發生 Master 被 WAL 撐爆的問題，並且在 &lt;code>pg_replication_slots&lt;/code> 也增加了 &lt;code>wal_status&lt;/code> 和 &lt;code>safe_wal_size&lt;/code> 字段方便監控：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># select wal_status,safe_wal_size from pg_replication_slots;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> wal_status &lt;span class="p">|&lt;/span> safe_wal_size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------+---------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reserved &lt;span class="p">|&lt;/span> &lt;span class="m">1078987728&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>wal_status&lt;/code>：表示該 Slot 所需的 WAL 狀態
&lt;ul>
&lt;li>reserved：在 max_wal_size 之內。&lt;/li>
&lt;li>extended：超出了 max_wal_size，但仍在 &lt;code>wal_keep_size&lt;/code> 或 &lt;code>max_slot_wal_keep_size&lt;/code> 的保護範圍內。&lt;/li>
&lt;li>unreserved：表示 WAL 已經不在保護範圍內，這是一個臨時狀態，隨後可能變成 &lt;code>extended&lt;/code> 或 &lt;code>lost&lt;/code>。&lt;/li>
&lt;li>lost：代表 WAL 已被刪除。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>safe_wal_size&lt;/code>：只有設置 &lt;code>max_slot_wal_keep_size&lt;/code> 才會出現，表示還能寫入多少 WAL 大小才不會超過 &lt;code>max_slot_wal_keep_size&lt;/code> 。當此值 ≤ 0 時，一旦觸發 checkpoint 就會發生 wal_status = lost 的狀況。&lt;/li>
&lt;/ul>
&lt;h3 id="功用---改善-master-的-vacuum-過早清除-slave-所需的紀錄">功用 - 改善 Master 的 vacuum 過早清除 Slave 所需的紀錄
&lt;/h3>&lt;p>當在 Master 使用 vacuum 指令或者觸發 auto vacuum 時，如果此操作在 Slave 回放時恰巧正在進行相關表的查詢時，會檢測出 vacuum 要清理的元組 (tuple) 仍被使用中，因此不能在 Slave 中立刻清除會在等待 &lt;code>max_standby_streaming_delay&lt;/code> (默認為 30 秒) 之後終止該查詢操作，並返回以下錯誤後進行 vacuum：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ERROR: canceling statement due to conflict with recovery
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Detail: User query might have needed to see row versions that must be removed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在沒有使用 Replication Slot 時，可以透過以下 2 個參數調整：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在 Master 上設置 vacuum_defer_cleanup_age (integer)：指定 vacuum 和 Hot updates 將延遲多少 transaction 之前的 dead tuple 將不進行刪除。&lt;/p>
&lt;p>默認值為 0，表示可以盡快刪除 dead tuple。&lt;/p>
&lt;p>問題：調大此值雖然可以多保留 N 個 Transaction 之前的 dead tuple，但這是根據 Master 上的 Transaction 狀況決定，實際上很難預測 sLAVE 需要多少額外的寬限時間，因此不太實用。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在 Slave 上設置 hot_standby_feedback (boolean)：當設置為 ON，表示 Slave 會通知 Master 自己目前的最小活躍事務id (xmin) 值，這樣 Master 在執行 vacuum 操作時會暫時不清除大於該 xmin 的 dead tuple。&lt;/p>
&lt;p>問題：當沒有 Slot 時，在 Slave 未連結的任何時間段都不提供保護。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>當有 Replication Slot 和 &lt;code>hot_standby_feedback&lt;/code> 參數配合時，slot 會保持紀錄最後回傳的 xmin 保護 dead tuple。&lt;/p>
&lt;p>不過理所當然的事情有一體兩面，如果 Slave 上該查詢運行過久，Master 上可能會發生更嚴重的表膨脹問題。&lt;/p>
&lt;h3 id="使用-physical-replication-slot">使用 Physical Replication slot
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>檢查 Source 的設定&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">listen_addresses&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以下皆為預設值&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">hot_standby&lt;/span> &lt;span class="o">=&lt;/span> ON
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">wal_level&lt;/span> &lt;span class="o">=&lt;/span> replica
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">max_wal_senders&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">max_replication_slots&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>在 Sourrce 上建立 replication slot&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># SELECT * FROM pg_create_physical_replication_slot(&amp;#39;node_a_slot&amp;#39;);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> slot_name &lt;span class="p">|&lt;/span> lsn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------+-----
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> node_a_slot &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># SELECT slot_name, slot_type, active FROM pg_replication_slots;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> slot_name &lt;span class="p">|&lt;/span> slot_type &lt;span class="p">|&lt;/span> active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------+-----------+--------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> node_a_slot &lt;span class="p">|&lt;/span> physical &lt;span class="p">|&lt;/span> f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>修改 Replica 上的設定&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">primary_conninfo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;user=repl port=5432 host=172.17.0.2 application_name=replica&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">primary_slot_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;node_a_slot&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="小節-2">小節
&lt;/h3>&lt;p>我認為應該使用 replication slot&lt;/p>
&lt;h2 id="logical-replication-邏輯複製">Logical Replication (邏輯複製)
&lt;/h2>&lt;h3 id="pg-1514-限制">PG 15(14) 限制
&lt;/h3>&lt;ol>
&lt;li>僅會同步 table (包含 partitioned table)，不支持 views, materialized views, or foreign tables。&lt;/li>
&lt;li>不會複製 schema 及 DDL 命令。&lt;/li>
&lt;li>不複製 sequence data&lt;/li>
&lt;li>&lt;/li>
&lt;li>不支持 Large objects。&lt;/li>
&lt;li>&lt;/li>
&lt;/ol>
&lt;h3 id="建置範例-1">建置範例
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>調整 Master、Slave 的設定，其中 &lt;code>wal_level&lt;/code> 必須調整為 &lt;code>logical&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">wal_level&lt;/span> &lt;span class="o">=&lt;/span> logical
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>在 Master 建立一個用於 Logical Replication 的 role：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">logic_repl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">with&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">replication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">還必須提供&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">usage&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">schema&lt;/span>&lt;span class="err">、&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">的權限&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">grant&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">usage&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SCHEMA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_schema&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">logic_repl&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">grant&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">test_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">to&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">logic_repl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>設置 Master pg_hba.conf，注意這邊和物理複製不一樣，database 必須提供相應的 table：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TYPE DATABASE USER ADDRESS METHOD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">host &lt;span class="nb">test&lt;/span> logic_repl 172.17.0.3/16 trust
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>在 Master 上建立 PUBLICATION：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">57&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">dRp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">publications&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Owner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">All&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tables&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Inserts&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Updates&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Deletes&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Truncates&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Via&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">------+-------+------------+---------+---------+---------+-----------+----------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">57&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">59&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PUBLICATION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">repltest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">test_table&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">43&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">dRp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">publications&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Owner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">All&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tables&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Inserts&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Updates&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Deletes&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Truncates&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Via&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">--------+----------+------------+---------+---------+---------+-----------+----------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">mytest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">row&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>在 Slave 上建立 SUBSCRIPTION&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">22&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">dRs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">subscriptions&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Owner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Enabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Publication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">------+-------+---------+-------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">rows&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">02&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SUBSCRIPTION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">mysub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONNECTION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;dbname=test host=172.17.0.2 user=logic_repl&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PUBLICATION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">repltest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">copy_data&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">local&lt;/span>&lt;span class="p">]:&lt;/span>&lt;span class="mi">5432&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">45&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">dRs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">of&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">subscriptions&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">Owner&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Enabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Publication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-------+----------+---------+-------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">mysub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">mytest&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="參考">參考
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.postgresql.org/docs/15/high-availability.html" target="_blank" rel="noopener"
>PostgreSQL: Documentation: 15: Chapter 27. High Availability, Load Balancing, and Replication&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.postgresql.org/docs/15/logical-replication.html" target="_blank" rel="noopener"
>PostgreSQL: Documentation: 15: Chapter 31. Logical Replication&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.postgresql.org/docs/current/runtime-config-replication.html" target="_blank" rel="noopener"
>PostgreSQL: Documentation: 15: 20.6. Replication&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2015/10/04/" target="_blank" rel="noopener"
>PgSQL · 特性分析 · PG主备流复制机制 (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2018/01/03/" target="_blank" rel="noopener"
>PgSQL · 内核解析 · 同步流复制实现分析 (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/digoal/blog/blob/master/201610/20161006_02.md" target="_blank" rel="noopener"
>PostgreSQL 9.6 同步多副本 与 remote_apply事务同步级别&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/weixin_39540651/article/details/106122610" target="_blank" rel="noopener"
>一文彻底弄懂PostgreSQL流复制(全网最详细)_pg流复制_foucus、的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://mysql.taobao.org/monthly/2015/02/03/" target="_blank" rel="noopener"
>PgSQL · 特性分析· Replication Slot (taobao.org)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/gaojiebao/article/details/121900737" target="_blank" rel="noopener"
>postgresql-14流复制部署手册_HistSpeed的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://girders.org/postgresql/2021/11/05/setup-postgresql14-replication/" target="_blank" rel="noopener"
>Setup PostgreSQL 14 Streaming Replication | Girders: the blog of Allen Fair&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/311496301" target="_blank" rel="noopener"
>我是一个插槽，今天我做掉了数据库 - 知乎 (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/weixin_37692493/article/details/121089674" target="_blank" rel="noopener"
>PG复制状态监控_wal_status reserved_三思呐三思的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.percona.com/blog/replication-lag-in-postgresql/" target="_blank" rel="noopener"
>It’s All About Replication Lag in PostgreSQL (percona.com)&lt;/a>&lt;/p></description></item><item><title>PostgreSQL 實體檔案儲存</title><link>https://FuweaY.github.io/p/postgre-file-storage/</link><pubDate>Mon, 17 Feb 2020 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/postgre-file-storage/</guid><description>&lt;h2 id="pg_hbaconf">pg_hba.conf
&lt;/h2>&lt;p>hba 表示 host-based authentication，該設定檔用來&lt;/p>
&lt;ul>
&lt;li>TYPE：連線方式
&lt;ul>
&lt;li>local：使用 unix domain socket 連線。&lt;/li>
&lt;li>host：使用 TCP/IP 連線，不論是否有 SSL 加密。&lt;/li>
&lt;li>hostssl：僅限於使用 SSL 加密的 TCP/IP 連線。&lt;/li>
&lt;li>hostnossl：僅限於不使用 SSL 加密的 TCP/IP 連線。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>DATABASE：指定連線的 DATABASE 名稱，多個名稱可用 &lt;code>,&lt;/code> 分隔。
&lt;ul>
&lt;li>all：表示所有 database。&lt;/li>
&lt;li>sameuser：表示 database 名稱和 user 名稱相同。&lt;/li>
&lt;li>samerole：表示 database 名稱和 user 所在的 role 相同。&lt;/li>
&lt;li>replication：表示為請求 physical replication。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>USER：表示此設定針對的 USER 名稱，多個名稱可用 &lt;code>,&lt;/code> 分隔。
&lt;ul>
&lt;li>all：表示所有 user 都適用。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ADDRESS：表示 client 端機器 address。&lt;/li>
&lt;li>METHOD：表示驗證方式。
&lt;ul>
&lt;li>trust：無條件允許，不需要任何驗證。&lt;/li>
&lt;li>reject：無條件拒絕。&lt;/li>
&lt;li>scram-sha-256：使用 scram-sha-256 身分驗證，此為目前提供最安全的密碼驗證方法。&lt;/li>
&lt;li>md5：使用 scram-sha-256 或 MD5 身分驗證，MD5 並不安全。&lt;/li>
&lt;li>password：要求 client 端提供未加密的密碼進行身分驗證，除非使用 SSL 加密連線否則這樣是不安全的。&lt;/li>
&lt;li>gss：使用 GSSAPI 來身分驗證，僅支援 TCP/IP 連線方式。&lt;/li>
&lt;li>sspi：使用 SSPI 來身分驗證，僅支援 windows。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TYPE DATABASE USER ADDRESS METHOD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">local&lt;/span> database user auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">host database user address auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostssl database user address auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostnossl database user address auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">host database user IP-address IP-mask auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostssl database user IP-address IP-mask auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostnossl database user IP-address IP-mask auth-method &lt;span class="o">[&lt;/span>auth-options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="參考">參考
&lt;/h1>&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/407794713" target="_blank" rel="noopener"
>【赵渝强老师】史上最详细的PostgreSQL体系架构介绍 - 知乎 (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.jianshu.com/p/cd8c5b988e52" target="_blank" rel="noopener"
>PostgreSQL数据目录结构 - 简书 (jianshu.com)&lt;/a>&lt;/p></description></item><item><title>PostgreSQL schema</title><link>https://FuweaY.github.io/p/postgre-schema/</link><pubDate>Thu, 13 Feb 2020 12:00:00 +0800</pubDate><guid>https://FuweaY.github.io/p/postgre-schema/</guid><description>&lt;p>發現 PG 中有一個 SCHEMA 的層級這在 MySQL 中是沒有的。&lt;/p>
&lt;h2 id="與-mysql-類比">與 MySQL 類比
&lt;/h2>&lt;p>在 MySQL 中分為三個層級 &lt;code>Instance&lt;/code> → &lt;code>DATABASE&lt;/code> → &lt;code>TABLE&lt;/code>，在 MySQL 中同一個 Instance 底下的任意 Database 可以存取其他 database 的 table。&lt;/p>
&lt;p>在 PG 中分為四個層級 &lt;code>Instance&lt;/code> → &lt;code>DATABASE&lt;/code> → &lt;code>SCHEMA&lt;/code> → &lt;code>TABLE&lt;/code>，在 PG 中不同 Database 之間是不能存取對方 Table 的，也就是說是獨立的。&lt;/p>
&lt;p>以此類比的情況下，PG 的 SCHEMA 會比較接近 MySQL 的 Database，而 PG 的 Database 會比較接近 Instance 的隔離層級。&lt;/p>
&lt;h2 id="細說">細說
&lt;/h2>&lt;p>每一個 Database 建立後會有以下 3 個 schema：&lt;/p>
&lt;ul>
&lt;li>pg_catalog：用於儲存 pg 系統自帶的各種 metadata。&lt;/li>
&lt;li>information_schema：用於儲存提供查詢 metadata 的查詢 view，主要是為了符合 SQL 標準。此 schema 可以單獨刪除 (但不建議)。&lt;/li>
&lt;li>public：用於儲存使用者創建的 table，但一般基於安全性、管理性不建議使用。&lt;/li>
&lt;/ul>
&lt;h2 id="參考">參考
&lt;/h2>&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/51784903/cross-database-references-are-not-implemented" target="_blank" rel="noopener"
>postgresql - cross-database references are not implemented: - Stack Overflow&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/1925818/what-is-the-mysql-equivalent-of-a-postgresql-schema" target="_blank" rel="noopener"
>database - What is the MySQL equivalent of a PostgreSQL &amp;lsquo;schema&amp;rsquo;? - Stack Overflow&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.zhihu.com/question/20355738" target="_blank" rel="noopener"
>在数据库中，schema、catalog分别指的是什么？ - 知乎 (zhihu.com)&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/weixin_44375561/article/details/119355144" target="_blank" rel="noopener"
>postgresql的database和schema的理解_Chsavvy的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/penriver/article/details/119680114" target="_blank" rel="noopener"
>PostgreSQL教程&amp;ndash;逻辑结构：实例、数据库、schema、表之间的关系_postgre逻辑结构_java编程艺术的博客-CSDN博客&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/58431104/difference-between-information-schema-tables-and-pg-tables" target="_blank" rel="noopener"
>postgresql - Difference between information_schema.tables and pg_tables - Stack Overflow&lt;/a>&lt;/p></description></item></channel></rss>